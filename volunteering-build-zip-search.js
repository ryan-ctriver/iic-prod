<<<<<<< HEAD
(()=>{var eC=Object.create;var P_=Object.defineProperty;var tC=Object.getOwnPropertyDescriptor;var iC=Object.getOwnPropertyNames;var rC=Object.getPrototypeOf,nC=Object.prototype.hasOwnProperty;var Sw=(S,m)=>()=>(S&&(m=S(S=0)),m);var cr=(S,m)=>()=>(m||S((m={exports:{}}).exports,m),m.exports),oC=(S,m)=>{for(var v in m)P_(S,v,{get:m[v],enumerable:!0})},Ew=(S,m,v,w)=>{if(m&&typeof m=="object"||typeof m=="function")for(let I of iC(m))!nC.call(S,I)&&I!==v&&P_(S,I,{get:()=>m[I],enumerable:!(w=tC(m,I))||w.enumerable});return S};var a0=(S,m,v)=>(v=S!=null?eC(rC(S)):{},Ew(m||!S||!S.__esModule?P_(v,"default",{value:S,enumerable:!0}):v,S)),sC=S=>Ew(P_({},"__esModule",{value:!0}),S);var $T=cr((nx,ox)=>{(function(S,m){typeof nx=="object"&&typeof ox<"u"?ox.exports=m():typeof define=="function"&&define.amd?define(m):(S=S||self,S.TinyQueue=m())})(nx,function(){"use strict";var S=function(w,I){if(w===void 0&&(w=[]),I===void 0&&(I=m),this.data=w,this.length=this.data.length,this.compare=I,this.length>0)for(var n=(this.length>>1)-1;n>=0;n--)this._down(n)};S.prototype.push=function(w){this.data.push(w),this.length++,this._up(this.length-1)},S.prototype.pop=function(){if(this.length!==0){var w=this.data[0],I=this.data.pop();return this.length--,this.length>0&&(this.data[0]=I,this._down(0)),w}},S.prototype.peek=function(){return this.data[0]},S.prototype._up=function(w){for(var I=this,n=I.data,O=I.compare,V=n[w];w>0;){var H=w-1>>1,J=n[H];if(O(V,J)>=0)break;n[w]=J,w=H}n[w]=V},S.prototype._down=function(w){for(var I=this,n=I.data,O=I.compare,V=this.length>>1,H=n[w];w<V;){var J=(w<<1)+1,ae=n[J],we=J+1;if(we<this.length&&O(n[we],ae)<0&&(J=we,ae=n[we]),O(ae,H)>=0)break;n[w]=ae,w=J}n[w]=H};function m(v,w){return v<w?-1:v>w?1:0}return S})});var t2=cr((hx,ux)=>{(function(S,m){typeof hx=="object"&&typeof ux<"u"?ux.exports=m():typeof define=="function"&&define.amd?define(m):(S=typeof globalThis<"u"?globalThis:S||self,S.mapboxgl=m())})(hx,function(){"use strict";var S,m,v;function w(n,O){if(!S)S=O;else if(!m)m=O;else{var V="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+S+")(sharedChunk); ("+m+")(sharedChunk); self.onerror = null;",H={};S(H),v=O(H),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(v.workerUrl=window.URL.createObjectURL(new Blob([V],{type:"text/javascript"})))}}w(["exports"],function(n){var O=1e-6,V=typeof Float32Array<"u"?Float32Array:Array;function H(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=i*h-a*s;return u?(r[0]=h*(u=1/u),r[1]=-s*u,r[2]=-a*u,r[3]=i*u,r):null}function J(){var r=new V(9);return V!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function ae(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=e[4],f=e[5],g=e[6],y=e[7],T=e[8];return r[0]=u*T-f*y,r[1]=a*y-s*T,r[2]=s*f-a*u,r[3]=f*g-h*T,r[4]=i*T-a*g,r[5]=a*h-i*f,r[6]=h*y-u*g,r[7]=s*g-i*y,r[8]=i*u-s*h,r}function we(r,e,i){var s=e[0],a=e[1],h=e[2],u=e[3],f=e[4],g=e[5],y=e[6],T=e[7],E=e[8],A=i[0],R=i[1],L=i[2],k=i[3],B=i[4],G=i[5],X=i[6],W=i[7],K=i[8];return r[0]=A*s+R*u+L*y,r[1]=A*a+R*f+L*T,r[2]=A*h+R*g+L*E,r[3]=k*s+B*u+G*y,r[4]=k*a+B*f+G*T,r[5]=k*h+B*g+G*E,r[6]=X*s+W*u+K*y,r[7]=X*a+W*f+K*T,r[8]=X*h+W*g+K*E,r}function Ae(){var r=new V(16);return V!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function xe(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Ge(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=e[4],f=e[5],g=e[6],y=e[7],T=e[8],E=e[9],A=e[10],R=e[11],L=e[12],k=e[13],B=e[14],G=e[15],X=i*f-s*u,W=i*g-a*u,K=i*y-h*u,pe=s*g-a*f,ce=s*y-h*f,ue=a*y-h*g,ge=T*k-E*L,ve=T*B-A*L,Ne=T*G-R*L,Ee=E*B-A*k,Ue=E*G-R*k,nt=A*G-R*B,qe=X*nt-W*Ue+K*Ee+pe*Ne-ce*ve+ue*ge;return qe?(r[0]=(f*nt-g*Ue+y*Ee)*(qe=1/qe),r[1]=(a*Ue-s*nt-h*Ee)*qe,r[2]=(k*ue-B*ce+G*pe)*qe,r[3]=(A*ce-E*ue-R*pe)*qe,r[4]=(g*Ne-u*nt-y*ve)*qe,r[5]=(i*nt-a*Ne+h*ve)*qe,r[6]=(B*K-L*ue-G*W)*qe,r[7]=(T*ue-A*K+R*W)*qe,r[8]=(u*Ue-f*Ne+y*ge)*qe,r[9]=(s*Ne-i*Ue-h*ge)*qe,r[10]=(L*ce-k*K+G*X)*qe,r[11]=(E*K-T*ce-R*X)*qe,r[12]=(f*ve-u*Ee-g*ge)*qe,r[13]=(i*Ee-s*ve+a*ge)*qe,r[14]=(k*W-L*pe-B*X)*qe,r[15]=(T*pe-E*W+A*X)*qe,r):null}function Te(r,e,i){var s=e[0],a=e[1],h=e[2],u=e[3],f=e[4],g=e[5],y=e[6],T=e[7],E=e[8],A=e[9],R=e[10],L=e[11],k=e[12],B=e[13],G=e[14],X=e[15],W=i[0],K=i[1],pe=i[2],ce=i[3];return r[0]=W*s+K*f+pe*E+ce*k,r[1]=W*a+K*g+pe*A+ce*B,r[2]=W*h+K*y+pe*R+ce*G,r[3]=W*u+K*T+pe*L+ce*X,r[4]=(W=i[4])*s+(K=i[5])*f+(pe=i[6])*E+(ce=i[7])*k,r[5]=W*a+K*g+pe*A+ce*B,r[6]=W*h+K*y+pe*R+ce*G,r[7]=W*u+K*T+pe*L+ce*X,r[8]=(W=i[8])*s+(K=i[9])*f+(pe=i[10])*E+(ce=i[11])*k,r[9]=W*a+K*g+pe*A+ce*B,r[10]=W*h+K*y+pe*R+ce*G,r[11]=W*u+K*T+pe*L+ce*X,r[12]=(W=i[12])*s+(K=i[13])*f+(pe=i[14])*E+(ce=i[15])*k,r[13]=W*a+K*g+pe*A+ce*B,r[14]=W*h+K*y+pe*R+ce*G,r[15]=W*u+K*T+pe*L+ce*X,r}function We(r,e,i){var s,a,h,u,f,g,y,T,E,A,R,L,k=i[0],B=i[1],G=i[2];return e===r?(r[12]=e[0]*k+e[4]*B+e[8]*G+e[12],r[13]=e[1]*k+e[5]*B+e[9]*G+e[13],r[14]=e[2]*k+e[6]*B+e[10]*G+e[14],r[15]=e[3]*k+e[7]*B+e[11]*G+e[15]):(a=e[1],h=e[2],u=e[3],f=e[4],g=e[5],y=e[6],T=e[7],E=e[8],A=e[9],R=e[10],L=e[11],r[0]=s=e[0],r[1]=a,r[2]=h,r[3]=u,r[4]=f,r[5]=g,r[6]=y,r[7]=T,r[8]=E,r[9]=A,r[10]=R,r[11]=L,r[12]=s*k+f*B+E*G+e[12],r[13]=a*k+g*B+A*G+e[13],r[14]=h*k+y*B+R*G+e[14],r[15]=u*k+T*B+L*G+e[15]),r}function ft(r,e,i){var s=i[0],a=i[1],h=i[2];return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=e[3]*s,r[4]=e[4]*a,r[5]=e[5]*a,r[6]=e[6]*a,r[7]=e[7]*a,r[8]=e[8]*h,r[9]=e[9]*h,r[10]=e[10]*h,r[11]=e[11]*h,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function _t(r,e,i){var s=Math.sin(i),a=Math.cos(i),h=e[4],u=e[5],f=e[6],g=e[7],y=e[8],T=e[9],E=e[10],A=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=h*a+y*s,r[5]=u*a+T*s,r[6]=f*a+E*s,r[7]=g*a+A*s,r[8]=y*a-h*s,r[9]=T*a-u*s,r[10]=E*a-f*s,r[11]=A*a-g*s,r}function Pt(r,e,i){var s=Math.sin(i),a=Math.cos(i),h=e[0],u=e[1],f=e[2],g=e[3],y=e[8],T=e[9],E=e[10],A=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=h*a-y*s,r[1]=u*a-T*s,r[2]=f*a-E*s,r[3]=g*a-A*s,r[8]=h*s+y*a,r[9]=u*s+T*a,r[10]=f*s+E*a,r[11]=g*s+A*a,r}function At(r,e,i){var s=Math.sin(i),a=Math.cos(i),h=e[0],u=e[1],f=e[2],g=e[3],y=e[4],T=e[5],E=e[6],A=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=h*a+y*s,r[1]=u*a+T*s,r[2]=f*a+E*s,r[3]=g*a+A*s,r[4]=y*a-h*s,r[5]=T*a-u*s,r[6]=E*a-f*s,r[7]=A*a-g*s,r}function wt(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Ct(r,e,i){var s,a,h,u=i[0],f=i[1],g=i[2],y=Math.hypot(u,f,g);return y<O?null:(u*=y=1/y,f*=y,g*=y,s=Math.sin(e),a=Math.cos(e),r[0]=u*u*(h=1-a)+a,r[1]=f*u*h+g*s,r[2]=g*u*h-f*s,r[3]=0,r[4]=u*f*h-g*s,r[5]=f*f*h+a,r[6]=g*f*h+u*s,r[7]=0,r[8]=u*g*h+f*s,r[9]=f*g*h-u*s,r[10]=g*g*h+a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function Ft(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=i+i,f=s+s,g=a+a,y=i*u,T=s*u,E=s*f,A=a*u,R=a*f,L=a*g,k=h*u,B=h*f,G=h*g;return r[0]=1-E-L,r[1]=T+G,r[2]=A-B,r[3]=0,r[4]=T-G,r[5]=1-y-L,r[6]=R+k,r[7]=0,r[8]=A+B,r[9]=R-k,r[10]=1-y-E,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)});var Wt=Te;function mt(){var r=new V(3);return V!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function er(r){var e=new V(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function Ni(r){return Math.hypot(r[0],r[1],r[2])}function yi(r,e,i){var s=new V(3);return s[0]=r,s[1]=e,s[2]=i,s}function mi(r,e,i,s){return r[0]=e,r[1]=i,r[2]=s,r}function vi(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r[2]=e[2]+i[2],r}function mr(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],r}function Fr(r,e,i){return r[0]=e[0]*i[0],r[1]=e[1]*i[1],r[2]=e[2]*i[2],r}function Rr(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r}function Hr(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r}function Xi(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r}function tn(r,e,i,s){return r[0]=e[0]+i[0]*s,r[1]=e[1]+i[1]*s,r[2]=e[2]+i[2]*s,r}function Po(r,e){var i=e[0]-r[0],s=e[1]-r[1],a=e[2]-r[2];return i*i+s*s+a*a}function Ro(r){var e=r[0],i=r[1],s=r[2];return e*e+i*i+s*s}function Zo(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function Oi(r,e){var i=e[0],s=e[1],a=e[2],h=i*i+s*s+a*a;return h>0&&(h=1/Math.sqrt(h)),r[0]=e[0]*h,r[1]=e[1]*h,r[2]=e[2]*h,r}function or(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function Vr(r,e,i){var s=e[0],a=e[1],h=e[2],u=i[0],f=i[1],g=i[2];return r[0]=a*g-h*f,r[1]=h*u-s*g,r[2]=s*f-a*u,r}function Nn(r,e,i,s){var a=e[0],h=e[1],u=e[2];return r[0]=a+s*(i[0]-a),r[1]=h+s*(i[1]-h),r[2]=u+s*(i[2]-u),r}function Lr(r,e,i){var s=e[0],a=e[1],h=e[2],u=i[3]*s+i[7]*a+i[11]*h+i[15];return r[0]=(i[0]*s+i[4]*a+i[8]*h+i[12])/(u=u||1),r[1]=(i[1]*s+i[5]*a+i[9]*h+i[13])/u,r[2]=(i[2]*s+i[6]*a+i[10]*h+i[14])/u,r}function Fs(r,e,i){var s=e[0],a=e[1],h=e[2];return r[0]=s*i[0]+a*i[3]+h*i[6],r[1]=s*i[1]+a*i[4]+h*i[7],r[2]=s*i[2]+a*i[5]+h*i[8],r}function Bs(r,e,i){var s=i[0],a=i[1],h=i[2],u=e[0],f=e[1],g=e[2],y=a*g-h*f,T=h*u-s*g,E=s*f-a*u,A=a*E-h*T,R=h*y-s*E,L=s*T-a*y,k=2*i[3];return T*=k,E*=k,R*=2,L*=2,r[0]=u+(y*=k)+(A*=2),r[1]=f+T+R,r[2]=g+E+L,r}function oc(r){return r[0]=0,r[1]=0,r[2]=0,r}function Lo(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}var zr=mr,Vn=Fr,Ns=Ni;function sc(){var r=new V(4);return V!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function vs(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r}function co(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=i*i+s*s+a*a+h*h;return u>0&&(u=1/Math.sqrt(u)),r[0]=i*u,r[1]=s*u,r[2]=a*u,r[3]=h*u,r}function Kn(r,e,i){var s=e[0],a=e[1],h=e[2],u=e[3];return r[0]=i[0]*s+i[4]*a+i[8]*h+i[12]*u,r[1]=i[1]*s+i[5]*a+i[9]*h+i[13]*u,r[2]=i[2]*s+i[6]*a+i[10]*h+i[14]*u,r[3]=i[3]*s+i[7]*a+i[11]*h+i[15]*u,r}function bs(){var r=new V(4);return V!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function ws(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function va(r,e,i){i*=.5;var s=e[0],a=e[1],h=e[2],u=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+u*f,r[1]=a*g+h*f,r[2]=h*g-a*f,r[3]=u*g-s*f,r}function Ka(r,e,i){i*=.5;var s=e[0],a=e[1],h=e[2],u=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g-h*f,r[1]=a*g+u*f,r[2]=h*g+s*f,r[3]=u*g-a*f,r}mt(),sc();var Un,ho,ac,Ts=co,Ja=(Un=mt(),ho=yi(1,0,0),ac=yi(0,1,0),function(r,e,i){var s=or(e,i);return s<-.999999?(Vr(Un,ho,e),Ns(Un)<1e-6&&Vr(Un,ac,e),Oi(Un,Un),function(a,h,u){u*=.5;var f=Math.sin(u);a[0]=f*h[0],a[1]=f*h[1],a[2]=f*h[2],a[3]=Math.cos(u)}(r,Un,Math.PI),r):s>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Vr(Un,e,i),r[0]=Un[0],r[1]=Un[1],r[2]=Un[2],r[3]=1+s,Ts(r,r))});function Sn(){var r=new V(2);return V!=Float32Array&&(r[0]=0,r[1]=0),r}function uo(r,e){var i=new V(2);return i[0]=r,i[1]=e,i}function Vs(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r}function Ss(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r}function Us(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r}function js(r){return Math.hypot(r[0],r[1])}function Qa(r,e){var i=e[0],s=e[1],a=i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),r[0]=e[0]*a,r[1]=e[1]*a,r}function hr(r,e){return r[0]*e[0]+r[1]*e[1]}bs(),bs(),J();var lc,cc,po=Ss;function hc(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}Sn();var ld=function(){if(cc)return lc;function r(e,i,s,a){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(a-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=s,this.p2y=a}return cc=1,lc=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,a=0;a<8;a++){var h=this.sampleCurveX(s)-e;if(Math.abs(h)<i)return s;var u=this.sampleCurveDerivativeX(s);if(Math.abs(u)<1e-6)break;s-=h/u}var f=0,g=1;for(s=e,a=0;a<20&&(h=this.sampleCurveX(s),!(Math.abs(h-e)<i));a++)e>h?f=s:g=s,s=.5*(g-f)+f;return s},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},lc}(),el=hc(ld);function Qe(r,e){this.x=r,this.y=e}function Es(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(!Es(r[i],e[i]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(let i in r)if(!Es(r[i],e[i]))return!1;return!0}return r===e}Qe.prototype={clone(){return new Qe(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,e){return this.clone()._rotateAround(r,e)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){let e=r.x-this.x,i=r.y-this.y;return e*e+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,e){return Math.atan2(this.x*e-this.y*r,this.x*r+this.y*e)},_matMult(r){let e=r[2]*this.x+r[3]*this.y;return this.x=r[0]*this.x+r[1]*this.y,this.y=e,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){let r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){let e=Math.cos(r),i=Math.sin(r),s=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=s,this},_rotateAround(r,e){let i=Math.cos(r),s=Math.sin(r),a=e.y+s*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-s*(this.y-e.y),this.y=a,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Qe},Qe.convert=function(r){if(r instanceof Qe)return r;if(Array.isArray(r))return new Qe(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new Qe(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};let cd=Math.PI/180,uc=180/Math.PI;function Ai(r){return r*cd}function Re(r){return r*uc}let q=[[0,0],[1,0],[1,1],[0,1]];function $(r){if(r<=0)return 0;if(r>=1)return 1;let e=r*r,i=e*r;return 4*(r<.5?i:3*(r-e)+i-.75)}function ie(r,e,i,s){let a=new el(r,e,i,s);return function(h){return a.solve(h)}}let fe=ie(.25,.1,.25,1);function re(r,e,i){return Math.min(i,Math.max(e,r))}function ye(r,e,i){return(i=re((i-r)/(e-r),0,1))*i*(3-2*i)}function De(r,e,i){let s=i-e,a=((r-e)%s+s)%s+e;return a===e?i:a}function be(r,e,i){if(!r.length)return i(null,[]);let s=r.length,a=new Array(r.length),h=null;r.forEach((u,f)=>{e(u,(g,y)=>{g&&(h=g),a[f]=y,--s==0&&i(h,a)})})}function Le(r,...e){for(let i of e)for(let s in i)r[s]=i[s];return r}let st=1;function He(){return st++}function kt(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}function Ht(r,e){r.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function Xt(r,e,i){let s={};for(let a in r)s[a]=e.call(this,r[a],a,r);return s}function ui(r,e,i){let s={};for(let a in r)e.call(this,r[a],a,r)&&(s[a]=r[a]);return s}function si(r){return Array.isArray(r)?r.map(si):typeof r=="object"&&r?Xt(r,si):r}function di(r,e){for(let i=0;i<r.length;i++)if(e.indexOf(r[i])>=0)return!0;return!1}let Yi={};function pi(r){Yi[r]||(typeof console<"u"&&console.warn(r),Yi[r]=!0)}function Mr(r,e,i){return(i.y-r.y)*(e.x-r.x)>(e.y-r.y)*(i.x-r.x)}function Qr(r){let e=0;for(let i,s,a=0,h=r.length,u=h-1;a<h;u=a++)i=r[a],s=r[u],e+=(s.x-i.x)*(i.y+s.y);return e}function $r([r,e,i]){let s=Ai(e+90),a=Ai(i);return{x:r*Math.cos(s)*Math.sin(a),y:r*Math.sin(s)*Math.sin(a),z:r*Math.cos(a),azimuthal:e,polar:i}}function Hi(r){return(typeof self<"u"||r!==void 0)&&typeof WorkerGlobalScope<"u"&&(r!==void 0?r:self)instanceof WorkerGlobalScope}function Pi(r){let e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,s,a,h)=>{let u=a||h;return e[s]=!u||u.toLowerCase(),""}),e["max-age"]){let i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Ir=null;function wr(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function _r(r,e,i,s){for(;e<i;){let a=e+i>>1;r[a]<s?e=a+1:i=a}return e}function ln(r,e,i,s){for(;e<i;){let a=e+i>>1;r[a]<=s?e=a+1:i=a}return e}function jn(r){return r>0?1/(1.001-r):1+r}function En(r){return r>0?1-1/(1.001-r):-r}function dc(r,e,i){return(r-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}let mn={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!mn.API_URL)return null;try{let r=new URL(mn.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.1.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Gs(r){return mn.API_URL_REGEX.test(r)}function Eh(r){return mn.API_SPRITE_REGEX.test(r)}let pc,fc,Ih,Ah,ba,mc;function Mh(){return pc==null&&(pc=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),pc}let Wo={now:()=>Ah!==void 0?Ah:performance.now(),setNow(r){Ah=r},restoreNow(){Ah=void 0},frame(r){let e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){let{width:i,height:s}=r;ba||(ba=document.createElement("canvas"));let a=ba.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("failed to create canvas 2d context");return(i>ba.width||s>ba.height)&&(ba.width=i,ba.height=s),a.clearRect(-e,-e,i+2*e,s+2*e),a.drawImage(r,0,0,i,s),a.getImageData(-e,-e,i+2*e,s+2*e)},resolveURL:r=>(fc||(fc=document.createElement("a")),fc.href=r,fc.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Ih==null&&(Ih=window.matchMedia("(prefers-reduced-motion: reduce)")),Ih.matches)},hasCanvasFingerprintNoise(){if(mc!==void 0)return mc;if(!Mh())return mc=!1,!1;let r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0}),i=0;for(let a=0;a<r.width;++a)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(a,0,1,1);let s=e.getImageData(0,0,r.width,r.height);i=0;for(let a=0;a<s.data.length;++a)if(a%4!=3&&i++!==s.data[a])return mc=!0,!0;return mc=!1,!1}};function fo(r,e){let i=r.indexOf("?");if(i<0)return`${r}?${new URLSearchParams(e).toString()}`;let s=new URLSearchParams(r.slice(i));for(let a in e)s.set(a,e[a]);return`${r.slice(0,i)}?${s.toString()}`}function zo(r,e={persistentParams:[]}){let i=r.indexOf("?");if(i<0)return r;let s=new URLSearchParams,a=new URLSearchParams(r.slice(i));for(let u of e.persistentParams){let f=a.get(u);f&&s.set(u,f)}let h=s.toString();return`${r.slice(0,i)}${h.length>0?`?${h}`:""}`}let Is="mapbox-tiles",Xo=500,As=50,_c=["language","worldview","jobid"],os,gc;function wa(){try{return caches}catch{}}function tl(){let r=wa();r&&os==null&&(os=r.open(Is))}let hd=1/0,ud={supported:!1,testSupport:function(r){!yc&&Ta&&(il?Lf(r):Gn=r)}},Gn,Ta,yc=!1,il=!1,Rf=typeof self<"u"?self:{};function Lf(r){let e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Ta),r.isContextLost())return;ud.supported=!0}catch{}r.deleteTexture(e),yc=!0}Rf.document&&(Ta=Rf.document.createElement("img"),Ta.onload=function(){Gn&&Lf(Gn),Gn=null,il=!0},Ta.onerror=function(){yc=!0,Gn=null},Ta.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let xc={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(xc);class wi extends Error{constructor(e,i,s){i===401&&Gs(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}let Ch=Hi()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,rl=function(r,e){if(!(/^file:/.test(i=r.url)||/^file:/.test(Ch())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(s,a){let h=new AbortController,u=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:Ch(),referrerPolicy:s.referrerPolicy,signal:h.signal}),f=!1,g=!1,y=(T=u.url).indexOf("sku=")>0&&Gs(T);var T;s.type==="json"&&u.headers.set("Accept","application/json");let E=(R,L,k)=>{if(g)return;if(R&&R.message!=="SecurityError"&&pi(R.toString()),L&&k)return A(L);let B=Date.now();fetch(u).then(G=>{if(G.ok){let X=y?G.clone():null;return A(G,X,B)}return a(new wi(G.statusText,G.status,s.url))}).catch(G=>{G.name!=="AbortError"&&a(new Error(`${G.message} ${s.url}`))})},A=(R,L,k)=>{(s.type==="arrayBuffer"?R.arrayBuffer():s.type==="json"?R.json():R.text()).then(B=>{g||(L&&k&&function(G,X,W){if(tl(),os==null)return;let K=Pi(X.headers.get("Cache-Control")||"");if(K["no-store"])return;let pe={status:X.status,statusText:X.statusText,headers:new Headers};X.headers.forEach((ge,ve)=>pe.headers.set(ve,ge)),K["max-age"]&&pe.headers.set("Expires",new Date(W+1e3*K["max-age"]).toUTCString());let ce=pe.headers.get("Expires");if(!ce||new Date(ce).getTime()-W<42e4)return;let ue=zo(G.url,{persistentParams:_c});if(X.status===206){let ge=G.headers.get("Range");if(!ge)return;pe.status=200,ue=fo(ue,{range:ge})}(function(ge,ve){if(gc===void 0)try{new Response(new ReadableStream),gc=!0}catch{gc=!1}gc?ve(ge.body):ge.blob().then(ve).catch(Ne=>pi(Ne.message))})(X,ge=>{let ve=new Response((Ne=X.status)!==200&&Ne!==404&&[101,103,204,205,304].includes(Ne)?null:ge,pe);var Ne;tl(),os?.then(Ee=>Ee.put(ue,ve)).catch(Ee=>pi(Ee.message))})}(u,L,k),f=!0,a(null,B,R.headers.get("Cache-Control"),R.headers.get("Expires")))}).catch(B=>{g||a(new Error(B.message))})};return y?function(R,L){if(tl(),os==null)return L(null);os.then(k=>{let B=zo(R.url,{persistentParams:_c}),G=R.headers.get("Range");G&&(B=fo(B,{range:G})),k.match(B).then(X=>{let W=function(K){if(!K)return!1;let pe=new Date(K.headers.get("Expires")||0),ce=Pi(K.headers.get("Cache-Control")||"");return Number(pe)>Date.now()&&!ce["no-cache"]}(X);k.delete(B).catch(L),W&&k.put(B,X.clone()).catch(L),L(null,X,W)}).catch(L)}).catch(L)}(u,E):E(null,null),{cancel:()=>{g=!0,f||h.abort()}}}(r,e);if(Hi(self)&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var i;return function(s,a){let h=new XMLHttpRequest;h.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(h.responseType="arraybuffer");for(let u in s.headers)h.setRequestHeader(u,s.headers[u]);return s.type==="json"&&(h.responseType="text",h.setRequestHeader("Accept","application/json")),h.withCredentials=s.credentials==="include",h.onerror=()=>{a(new Error(h.statusText))},h.onload=()=>{if((h.status>=200&&h.status<300||h.status===0)&&h.response!==null){let u=h.response;if(s.type==="json")try{u=JSON.parse(h.response)}catch(f){return a(f)}a(null,u,h.getResponseHeader("Cache-Control"),h.getResponseHeader("Expires"))}else a(new wi(h.statusText,h.status,s.url))},h.send(s.body),{cancel:()=>h.abort()}}(r,e)},vc=function(r,e){return rl(Le(r,{type:"arrayBuffer"}),e)};function dg(r){let e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}let bc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",Sa,qs;Sa=[],qs=0;let wc=function(r,e){if(ud.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),qs>=mn.MAX_PARALLEL_IMAGE_REQUESTS){let h={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Sa.push(h),h}qs++;let i=!1,s=()=>{if(!i)for(i=!0,qs--;Sa.length&&qs<mn.MAX_PARALLEL_IMAGE_REQUESTS;){let h=Sa.shift(),{requestParameters:u,callback:f,cancelled:g}=h;g||(h.cancel=wc(u,f).cancel)}},a=vc(r,(h,u,f,g)=>{s(),h?e(h):u&&(self.createImageBitmap?function(y,T){let E=new Blob([new Uint8Array(y)],{type:"image/png"});createImageBitmap(E).then(A=>{T(null,A)}).catch(A=>{T(new Error(`Could not load image because of ${A.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(u,(y,T)=>e(y,T,f,g)):function(y,T){let E=new Image;E.onload=()=>{T(null,E),URL.revokeObjectURL(E.src),E.onload=null,requestAnimationFrame(()=>{E.src=bc})},E.onerror=()=>T(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let A=new Blob([new Uint8Array(y)],{type:"image/png"});E.src=y.byteLength?URL.createObjectURL(A):bc}(u,(y,T)=>e(y,T,f,g)))});return{cancel:()=>{a.cancel(),s()}}};var zf,Ph,Df,nl={exports:{}},Ea={exports:{}},Of={exports:{}},Tc=function(){if(Df)return nl.exports;Df=1;var r=(zf||(zf=1,Ea.exports=function(i,s){var a,h,u,f,g,y,T,E;for(h=i.length-(a=3&i.length),u=s,g=3432918353,y=461845907,E=0;E<h;)T=255&i.charCodeAt(E)|(255&i.charCodeAt(++E))<<8|(255&i.charCodeAt(++E))<<16|(255&i.charCodeAt(++E))<<24,++E,u=27492+(65535&(f=5*(65535&(u=(u^=T=(65535&(T=(T=(65535&T)*g+(((T>>>16)*g&65535)<<16)&4294967295)<<15|T>>>17))*y+(((T>>>16)*y&65535)<<16)&4294967295)<<13|u>>>19))+((5*(u>>>16)&65535)<<16)&4294967295))+((58964+(f>>>16)&65535)<<16);switch(T=0,a){case 3:T^=(255&i.charCodeAt(E+2))<<16;case 2:T^=(255&i.charCodeAt(E+1))<<8;case 1:u^=T=(65535&(T=(T=(65535&(T^=255&i.charCodeAt(E)))*g+(((T>>>16)*g&65535)<<16)&4294967295)<<15|T>>>17))*y+(((T>>>16)*y&65535)<<16)&4294967295}return u^=i.length,u=2246822507*(65535&(u^=u>>>16))+((2246822507*(u>>>16)&65535)<<16)&4294967295,u=3266489909*(65535&(u^=u>>>13))+((3266489909*(u>>>16)&65535)<<16)&4294967295,(u^=u>>>16)>>>0}),Ea.exports),e=(Ph||(Ph=1,Of.exports=function(i,s){for(var a,h=i.length,u=s^h,f=0;h>=4;)a=1540483477*(65535&(a=255&i.charCodeAt(f)|(255&i.charCodeAt(++f))<<8|(255&i.charCodeAt(++f))<<16|(255&i.charCodeAt(++f))<<24))+((1540483477*(a>>>16)&65535)<<16),u=1540483477*(65535&u)+((1540483477*(u>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),h-=4,++f;switch(h){case 3:u^=(255&i.charCodeAt(f+2))<<16;case 2:u^=(255&i.charCodeAt(f+1))<<8;case 1:u=1540483477*(65535&(u^=255&i.charCodeAt(f)))+((1540483477*(u>>>16)&65535)<<16)}return u=1540483477*(65535&(u^=u>>>13))+((1540483477*(u>>>16)&65535)<<16),(u^=u>>>15)>>>0}),Of.exports);return nl.exports=r,nl.exports.murmur3=r,nl.exports.murmur2=e,nl.exports}(),ol=hc(Tc);class Ms{constructor(e,...i){Le(this,i[0]||{}),this.type=e}}class mo extends Ms{constructor(e,i={}){super("error",Le({error:e},i))}}function dd(r,e,i){i[r]&&i[r].indexOf(e)!==-1||(i[r]=i[r]||[],i[r].push(e))}function pd(r,e,i){if(i&&i[r]){let s=i[r].indexOf(e);s!==-1&&i[r].splice(s,1)}}class Ia{on(e,i){return this._listeners=this._listeners||{},dd(e,i,this._listeners),this}off(e,i){return pd(e,i,this._listeners),pd(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},dd(e,i,this._oneTimeListeners),this):new Promise(s=>{this.once(e,s)})}fire(e,i){let s=typeof e=="string"?new Ms(e,i):e,a=s.type;if(this.listens(a)){s.target=this;let h=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(let g of h)g.call(this,s);let u=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(let g of u)pd(a,g,this._oneTimeListeners),g.call(this,s);let f=this._eventedParent;f&&(Le(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),f.fire(s))}else s instanceof mo&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class Jn{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new Jn(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){let[i,s]=e.split("");return new Jn({name:i,iconsetId:s})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return Jn.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var fd,Rh={},md=function(){if(fd)return Rh;fd=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(h){return(h=Math.round(h))<0?0:h>255?255:h}function i(h){return e(h[h.length-1]==="%"?parseFloat(h)/100*255:parseInt(h))}function s(h){return(u=h[h.length-1]==="%"?parseFloat(h)/100:parseFloat(h))<0?0:u>1?1:u;var u}function a(h,u,f){return f<0?f+=1:f>1&&(f-=1),6*f<1?h+(u-h)*f*6:2*f<1?u:3*f<2?h+(u-h)*(2/3-f)*6:h}try{Rh.parseCSSColor=function(h){var u,f=h.replace(/ /g,"").toLowerCase();if(f in r)return r[f].slice();if(f[0]==="#")return f.length===4?(u=parseInt(f.substr(1),16))>=0&&u<=4095?[(3840&u)>>4|(3840&u)>>8,240&u|(240&u)>>4,15&u|(15&u)<<4,1]:null:f.length===7&&(u=parseInt(f.substr(1),16))>=0&&u<=16777215?[(16711680&u)>>16,(65280&u)>>8,255&u,1]:null;var g=f.indexOf("("),y=f.indexOf(")");if(g!==-1&&y+1===f.length){var T=f.substr(0,g),E=f.substr(g+1,y-(g+1)).split(","),A=1;switch(T){case"rgba":if(E.length!==4)return null;A=s(E.pop());case"rgb":return E.length!==3?null:[i(E[0]),i(E[1]),i(E[2]),A];case"hsla":if(E.length!==4)return null;A=s(E.pop());case"hsl":if(E.length!==3)return null;var R=(parseFloat(E[0])%360+360)%360/360,L=s(E[1]),k=s(E[2]),B=k<=.5?k*(L+1):k+L-k*L,G=2*k-B;return[e(255*a(G,B,R+1/3)),e(255*a(G,B,R)),e(255*a(G,B,R-1/3)),A];default:return null}}return null}}catch{}return Rh}();class ki{constructor(e,i,s,a=1){this.r=e,this.g=i,this.b=s,this.a=a}static parse(e){if(!e)return;if(e instanceof ki)return e;if(typeof e!="string")return;let i=md.parseCSSColor(e);return i?new ki(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){let[e,i,s,a]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*s)},${a})`}toNonPremultipliedRenderColor(e){let{r:i,g:s,b:a,a:h}=this;return new sl(e,i,s,a,h)}toPremultipliedRenderColor(e){let{r:i,g:s,b:a,a:h}=this;return new kf(e,i*h,s*h,a*h,h)}clone(){return new ki(this.r,this.g,this.b,this.a)}}class Sc{constructor(e,i,s,a,h,u=!1){if(this.premultiplied=!1,this.premultiplied=u,e){let f=e.image.height,g=f*f;this.premultiplied?(i=h===0?0:i/h*(f-1),s=h===0?0:s/h*(f-1),a=h===0?0:a/h*(f-1)):(i*=f-1,s*=f-1,a*=f-1);let y=Math.floor(i),T=Math.floor(s),E=Math.floor(a),A=Math.ceil(i),R=Math.ceil(s),L=Math.ceil(a),k=i-y,B=s-T,G=a-E,X=e.image.data,W=4*(y+T*g+E*f),K=4*(y+T*g+L*f),pe=4*(y+R*g+E*f),ce=4*(y+R*g+L*f),ue=4*(A+T*g+E*f),ge=4*(A+T*g+L*f),ve=4*(A+R*g+E*f),Ne=4*(A+R*g+L*f);if(W<0||Ne>=X.length)throw new Error("out of range");this.r=Bt(Bt(Bt(X[W],X[K],G),Bt(X[pe],X[ce],G),B),Bt(Bt(X[ue],X[ge],G),Bt(X[ve],X[Ne],G),B),k)/255*(this.premultiplied?h:1),this.g=Bt(Bt(Bt(X[W+1],X[K+1],G),Bt(X[pe+1],X[ce+1],G),B),Bt(Bt(X[ue+1],X[ge+1],G),Bt(X[ve+1],X[Ne+1],G),B),k)/255*(this.premultiplied?h:1),this.b=Bt(Bt(Bt(X[W+2],X[K+2],G),Bt(X[pe+2],X[ce+2],G),B),Bt(Bt(X[ue+2],X[ge+2],G),Bt(X[ve+2],X[Ne+2],G),B),k)/255*(this.premultiplied?h:1),this.a=h}else this.r=i,this.g=s,this.b=a,this.a=h}toArray(){let{r:e,g:i,b:s,a}=this;return[255*e,255*i,255*s,a]}toHslaArray(){let{r:e,g:i,b:s,a}=this;if(this.premultiplied){if(a===0)return[0,0,0,0];e/=a,i/=a,s/=a}let h=Math.min(Math.max(e,0),1),u=Math.min(Math.max(i,0),1),f=Math.min(Math.max(s,0),1),g=Math.min(h,u,f),y=Math.max(h,u,f),T=(g+y)/2;if(g===y)return[0,0,100*T,a];let E=y-g,A=T>.5?E/(2-y-g):E/(y+g),R=0;return y===h?R=(u-f)/E+(u<f?6:0):y===u?R=(f-h)/E+2:y===f&&(R=(h-u)/E+4),R*=60,[Math.min(Math.max(R,0),360),Math.min(Math.max(100*A,0),100),Math.min(Math.max(100*T,0),100),a]}toArray01(){let{r:e,g:i,b:s,a}=this;return[e,i,s,a]}toArray01Scaled(e){let{r:i,g:s,b:a}=this;return[i*e,s*e,a*e]}toArray01Linear(){let{r:e,g:i,b:s,a}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(s,2.2),a]}}class sl extends Sc{constructor(e,i,s,a,h){super(e,i,s,a,h,!1)}}class kf extends Sc{constructor(e,i,s,a,h){super(e,i,s,a,h,!0)}}function Bt(r,e,i){return r*(1-i)+e*i}function Ff(r,e,i){return r.map((s,a)=>Bt(s,e[a],i))}ki.black=new ki(0,0,0,1),ki.white=new ki(1,1,1,1),ki.transparent=new ki(0,0,0,0),ki.red=new ki(1,0,0,1),ki.blue=new ki(0,0,1,1);var Ec=Object.freeze({__proto__:null,array:Ff,color:function(r,e,i){return new ki(Bt(r.r,e.r,i),Bt(r.g,e.g,i),Bt(r.b,e.b,i),Bt(r.a,e.a,i))},number:Bt});function Aa(r,...e){for(let i of e)for(let s in i)r[s]=i[s];return r}class _o extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class _d{constructor(e,i=[]){this.parent=e,this.bindings={};for(let[s,a]of i)this.bindings[s]=a}concat(e){return new _d(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}let al={kind:"null"},Dt={kind:"number"},zi={kind:"string"},Di={kind:"boolean"},Qn={kind:"color"},Cs={kind:"object"},Fi={kind:"value"},Lh={kind:"collator"},Ic={kind:"formatted"},Ac={kind:"resolvedImage"};function In(r,e){return{kind:"array",itemType:r,N:e}}function Zr(r){if(r.kind==="array"){let e=Zr(r.itemType);return typeof r.N=="number"?`array<${e}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${e}>`}return r.kind}let pg=[al,Dt,zi,Di,Qn,Ic,Cs,In(Fi),Ac];function ll(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!ll(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(let i of pg)if(!ll(i,e))return null}}return`Expected ${Zr(r)} but found ${Zr(e)} instead.`}function Hs(r,e){return e.some(i=>i.kind===r.kind)}function Mc(r,e){return e.some(i=>i==="null"?r===null:i==="array"?Array.isArray(r):i==="object"?r&&!Array.isArray(r)&&typeof r=="object":i===typeof r)}function zh(r,e){return r.kind==="array"&&e.kind==="array"?r.N===e.N&&zh(r.itemType,e.itemType):r.kind===e.kind}class Cc{constructor(e,i,s){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Dh{constructor(e,i,s,a,h){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=s,this.fontStack=a,this.textColor=h}}class Ln{constructor(e){this.sections=e}static fromString(e){return new Ln([new Dh(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Ln?e:Ln.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){let e=["format"];for(let i of this.sections){if(i.image){let a=i.image.getPrimary().id.toString();e.push(["image",a]);continue}e.push(i.text);let s={};i.fontStack&&(s["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(s["font-scale"]=i.scale),i.textColor&&(s["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(s)}return e}}class Ps{constructor(e,i={}){if(this.id=Jn.from(e),this.options=Object.assign({},i),i.transform){let{a:s,b:a,c:h,d:u,e:f,f:g}=i.transform;this.options.transform=new DOMMatrix([s,a,h,u,f,g])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){let{a:e,b:i,c:s,d:a,e:h,f:u}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:s,d:a,e:h,f:u}})}static parse(e){let i,s,a,h;try{({name:i,iconsetId:s,params:a,transform:h}=JSON.parse(e)||{})}catch{return null}if(!i)return null;let{a:u,b:f,c:g,d:y,e:T,f:E}=h||{};return new Ps({name:i,iconsetId:s},{params:a,transform:new DOMMatrix([u,f,g,y,T,E])})}scaleSelf(e,i){return this.options.transform.scaleSelf(e,i),this}}class qn{constructor(e,i,s,a,h=!1){this.primaryId=Jn.from(e),this.primaryOptions=i,s&&(this.secondaryId=Jn.from(s)),this.secondaryOptions=a,this.available=h}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Ps(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Ps(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?qn.build({name:e}):e}static build(e,i,s,a){return!e||typeof e=="object"&&!("name"in e)?null:new qn(e,s,i,a)}}function Ma(r,e,i,s){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[r,e,i,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[r,e,i,s]:[r,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ti(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof ki||r instanceof Cc||r instanceof Ln||r instanceof qn)return!0;if(Array.isArray(r)){for(let e of r)if(!ti(e))return!1;return!0}if(typeof r=="object"){for(let e in r)if(!ti(r[e]))return!1;return!0}return!1}function bt(r){if(r===null)return al;if(typeof r=="string")return zi;if(typeof r=="boolean")return Di;if(typeof r=="number")return Dt;if(r instanceof ki)return Qn;if(r instanceof Cc)return Lh;if(r instanceof Ln)return Ic;if(r instanceof qn)return Ac;if(Array.isArray(r)){let e=r.length,i;for(let s of r){let a=bt(s);if(i){if(i===a)continue;i=Fi;break}i=a}return In(i||Fi,e)}return Cs}function Do(r){let e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof Ln||r instanceof qn||r instanceof ki?r.toString():JSON.stringify(r)}class Gt{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!ti(e[1]))return i.error("invalid value");let s=e[1],a=bt(s),h=i.expectedType;return a.kind!=="array"||a.N!==0||!h||h.kind!=="array"||typeof h.N=="number"&&h.N!==0||(a=h),new Gt(a,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof ki?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Ln?this.value.serialize():this.value}}class Ur{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}let Pc={string:zi,number:Dt,boolean:Di,object:Cs};class Nt{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s,a=1,h=e[0];if(h==="array"){let f,g;if(e.length>2){let y=e[1];if(typeof y!="string"||!(y in Pc)||y==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);f=Pc[y],a++}else f=Fi;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);g=e[2],a++}s=In(f,g)}else s=Pc[h];let u=[];for(;a<e.length;a++){let f=i.parse(e[a],a,Fi);if(!f)return null;u.push(f)}return new Nt(s,u)}evaluate(e){for(let i=0;i<this.args.length;i++){let s=this.args[i].evaluate(e);if(!ll(this.type,bt(s)))return s;if(i===this.args.length-1)throw new Ur(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${Zr(bt(s))} but was expected to be of type ${Zr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=this.type,i=[e.kind];if(e.kind==="array"){let s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){i.push(s.kind);let a=e.N;(typeof a=="number"||this.args.length>1)&&i.push(a)}}return i.concat(this.args.map(s=>s.serialize()))}}class cl{constructor(e){this.type=Ic,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s=e[1];if(!Array.isArray(s)&&typeof s=="object")return i.error("First argument must be an image or text section.");let a=[],h=!1;for(let u=1;u<=e.length-1;++u){let f=e[u];if(h&&typeof f=="object"&&!Array.isArray(f)){h=!1;let g=null;if(f["font-scale"]&&(g=i.parseObjectValue(f["font-scale"],u,"font-scale",Dt),!g))return null;let y=null;if(f["text-font"]&&(y=i.parseObjectValue(f["text-font"],u,"text-font",In(zi)),!y))return null;let T=null;if(f["text-color"]&&(T=i.parseObjectValue(f["text-color"],u,"text-color",Qn),!T))return null;let E=a[a.length-1];E.scale=g,E.font=y,E.textColor=T}else{let g=i.parse(e[u],u,Fi);if(!g)return null;let y=g.type.kind;if(y!=="string"&&y!=="value"&&y!=="null"&&y!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");h=!0,a.push({content:g,scale:null,font:null,textColor:null})}}return new cl(a)}evaluate(e){return new Ln(this.sections.map(i=>{let s=i.content.evaluate(e);return zh(bt(s),Ac)?new Dh("",s,null,null,null):new Dh(Do(s),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(let i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){let e=["format"];for(let i of this.sections){e.push(i.content.serialize());let s={};i.scale&&(s["font-scale"]=i.scale.serialize()),i.font&&(s["text-font"]=i.font.serialize()),i.textColor&&(s["text-color"]=i.textColor.serialize()),e.push(s)}return e}}class hl{constructor(e,i,s,a){this._imageWarnHistory={},this.type=Ac,this.namePrimary=e,this.nameSecondary=i,s&&(this.paramsPrimary=s.params,this.iconsetIdPrimary=s.iconset?s.iconset.id:void 0),a&&(this.paramsSecondary=a.params,this.iconsetIdSecondary=a.iconset?a.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let s=1,a=[];function h(){if(s<e.length){let f=i.parse(e[s],s++,zi);return f?(a.push({image:f,options:{}}),!0):(i.error(a.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function u(){if(s<e.length){let g=e[s];if((f=g)===null||typeof f!="object"||Array.isArray(f))return!0;let y=g.params,T=g.iconset,E=i.concat(s);if(!y&&!T)return s++,!0;if(y){if(typeof y!="object"||y.constructor!==Object)return E.error('Image options "params" should be an object'),!1;let A={},R=E.concat(void 0,"params");for(let L in y){if(!L)return R.error("Image parameter name should be non-empty"),!1;let k=R.concat(void 0,L).parse(y[L],void 0,Qn,void 0,{typeAnnotation:"coerce"});if(!k)return!1;A[L]=k}a[a.length-1].options.params=A}if(T){if(typeof T!="object"||T.constructor!==Object)return E.error('Image options "iconset" should be an object'),!1;if(!T.id)return E.error('Image options "iconset" should have an "id" property'),!1;a[a.length-1].options.iconset=T}return s++,!0}var f;return!0}for(let f=0;f<2;f++)if(!h()||!u())return;return new hl(a[0].image,a[1]?a[1].image:void 0,a[0].options,a[1]?a[1].options:void 0)}evaluateParams(e,i){let s={};if(i){for(let a in i)if(i[a])try{s[a]=i[a].evaluate(e)}catch{continue}if(Object.keys(s).length!==0)return{params:s}}}evaluate(e){let i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},s=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,a=qn.build(i,s,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(a&&e.availableImages){let h=a.getPrimary().id;if(a.available=e.availableImages.some(u=>Jn.isEqual(u,h)),a.available){let u=a.getSecondary()?a.getSecondary().id:null;u&&(a.available=e.availableImages.some(f=>Jn.isEqual(f,u)))}}return a}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(let i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(let i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){let s={};if(i&&(s.iconset={id:i}),e){s.params={};for(let a in e)e[a]&&(s.params[a]=e[a].serialize())}return Object.keys(s).length>0?s:void 0}serialize(){let e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){let i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){let i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function $s(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":r===null?"null":typeof r}let Bf={"to-boolean":Di,"to-color":Qn,"to-number":Dt,"to-string":zi};class Oo{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s=e[0],a=[],h=al;if(s==="to-array"){if(!Array.isArray(e[1]))return null;let u=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);h=In(i.expectedType.itemType,u)}else{if(!(u>0&&ti(e[1][0])))return null;h=In(bt(e[1][0]),u)}for(let f=0;f<u;f++){let g=e[1][f],y;if($s(g)==="array")y=i.parse(g,void 0,h.itemType);else{let T=$s(g);if(T!==h.itemType.kind)return i.error(`Expected ${h.itemType.kind} but found ${T}.`);y=i.registry.literal.parse(["literal",g===void 0?null:g],i)}if(!y)return null;a.push(y)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return i.error("Expected one argument.");h=Bf[s];for(let u=1;u<e.length;u++){let f=i.parse(e[u],u,Fi);if(!f)return null;a.push(f)}}return new Oo(h,a)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,s;for(let a of this.args){if(i=a.evaluate(e),s=null,i instanceof ki)return i;if(typeof i=="string"){let h=e.parseColor(i);if(h)return h}else if(Array.isArray(i)&&(s=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:Ma(i[0],i[1],i[2],i[3]),!s))return new ki(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Ur(s||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(let s of this.args){if(i=s.evaluate(e),i===null)return 0;let a=Number(i);if(!isNaN(a))return a}throw new Ur(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?Ln.fromString(Do(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?qn.build(Do(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):Do(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new cl([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new hl(this.args[0]).serialize();let e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}let zn=["Unknown","Point","LineString","Polygon"];class Rc{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?zn[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:s,y:a}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*i-e[0])+this.featureDistanceData.bearing[1]*(a*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=ki.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class cn{constructor(e,i,s,a,h){this.name=e,this.type=i,this._evaluate=s,this.args=a,this._overloadIndex=h}evaluate(e){if(!this._evaluate){let i=cn.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){let s=e[0],a=cn.definitions[s];if(!a)return i.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);let h=Array.isArray(a)?a[0]:a.type,u=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,f=[],g=null,y=-1;for(let[T,E]of u){if(Array.isArray(T)&&T.length!==e.length-1)continue;f.push(T),y++,g=new Zh(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);let A=[],R=!1;for(let L=1;L<e.length;L++){let k=e[L],B=Array.isArray(T)?T[L-1]:T.type,G=g.parse(k,1+A.length,B);if(!G){R=!0;break}A.push(G)}if(!R)if(Array.isArray(T)&&T.length!==A.length)g.error(`Expected ${T.length} arguments, but found ${A.length} instead.`);else{for(let L=0;L<A.length;L++){let k=Array.isArray(T)?T[L]:T.type,B=A[L];g.concat(L+1).checkSubtype(k,B.type)}if(g.errors.length===0)return new cn(s,h,E,A,y)}}if(f.length===1)i.errors.push(...g.errors);else{let T=(f.length?f:u.map(([A])=>A)).map(gd).join(" | "),E=[];for(let A=1;A<e.length;A++){let R=i.parse(e[A],1+E.length);if(!R)return null;E.push(Zr(R.type))}i.error(`Expected arguments of type ${T}, but found (${E.join(", ")}) instead.`)}return null}static register(e,i){cn.definitions=i;for(let s in i)e[s]=cn}}function gd(r){return Array.isArray(r)?`(${r.map(Zr).join(", ")})`:`(${Zr(r.type)}...)`}class ss{constructor(e,i,s){this.type=Lh,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");let s=e[1];if(typeof s!="object"||Array.isArray(s))return i.error("Collator options argument must be an object.");let a=s["case-sensitive"]===void 0?i.parse(!1,1,Di):i.parseObjectValue(s["case-sensitive"],1,"case-sensitive",Di);if(!a)return null;let h=s["diacritic-sensitive"]===void 0?i.parse(!1,1,Di):i.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",Di);if(!h)return null;let u=null;return s.locale&&(u=i.parseObjectValue(s.locale,1,"locale",zi),!u)?null:new ss(a,h,u)}evaluate(e){return new Cc(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){let e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function An(r,e,i=0,s=r.length-1,a=fg){for(;s>i;){if(s-i>600){let g=s-i+1,y=e-i+1,T=Math.log(g),E=.5*Math.exp(2*T/3),A=.5*Math.sqrt(T*E*(g-E)/g)*(y-g/2<0?-1:1);An(r,e,Math.max(i,Math.floor(e-y*E/g+A)),Math.min(s,Math.floor(e+(g-y)*E/g+A)),a)}let h=r[e],u=i,f=s;for(Lc(r,i,e),a(r[s],h)>0&&Lc(r,i,s);u<f;){for(Lc(r,u,f),u++,f--;a(r[u],h)<0;)u++;for(;a(r[f],h)>0;)f--}a(r[i],h)===0?Lc(r,i,f):(f++,Lc(r,f,s)),f<=e&&(i=f+1),e<=f&&(s=f-1)}}function Lc(r,e,i){let s=r[e];r[e]=r[i],r[i]=s}function fg(r,e){return r<e?-1:r>e?1:0}function mg(r){let e=0;for(let i,s,a=0,h=r.length,u=h-1;a<h;u=a++)i=r[a],s=r[u],e+=(s.x-i.x)*(i.y+s.y);return e}function Zs(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function ul(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function Ca(r,e,i){let s=r[0]-e[0],a=r[1]-e[1],h=r[0]-i[0],u=r[1]-i[1];return s*u-h*a==0&&s*h<=0&&a*u<=0}function dl(r,e,i=!1){let s=!1;for(let f=0,g=e.length;f<g;f++){let y=e[f];for(let T=0,E=y.length,A=E-1;T<E;A=T++){let R=y[A],L=y[T];if(Ca(r,R,L))return i;(h=R)[1]>(a=r)[1]!=(u=L)[1]>a[1]&&a[0]<(u[0]-h[0])*(a[1]-h[1])/(u[1]-h[1])+h[0]&&(s=!s)}}var a,h,u;return s}function Nf(r,e,i,s){let a=s[0]-i[0],h=s[1]-i[1],u=(r[0]-i[0])*h-a*(r[1]-i[1]),f=(e[0]-i[0])*h-a*(e[1]-i[1]);return u>0&&f<0||u<0&&f>0}function Oh(r,e,i,s){return(a=[s[0]-i[0],s[1]-i[1]])[0]*(h=[e[0]-r[0],e[1]-r[1]])[1]-a[1]*h[0]!=0&&!(!Nf(r,e,i,s)||!Nf(i,s,r,e));var a,h}function yd(r){let e=new Qe(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new Qe(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let s of r[0])e.x>s.x&&(e.x=s.x),e.y>s.y&&(e.y=s.y),i.x<s.x&&(i.x=s.x),i.y<s.y&&(i.y=s.y);return{min:e,max:i}}let Ws=8192;function _g(r,e){let i=(180+r[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(i*a*Ws),Math.round(s*a*Ws)]}function Vf(r,e){for(let i=0;i<e.length;i++)if(dl(r,e[i]))return!0;return!1}function gg(r,e,i){for(let s of i)for(let a=0,h=s.length,u=h-1;a<h;u=a++)if(Oh(r,e,s[u],s[a]))return!0;return!1}function Uf(r,e){for(let i=0;i<r.length;++i)if(!dl(r[i],e))return!1;for(let i=0;i<r.length-1;++i)if(gg(r[i],r[i+1],e))return!1;return!0}function jf(r,e){for(let i=0;i<e.length;i++)if(Uf(r,e[i]))return!0;return!1}function xd(r,e,i){let s=[];for(let a=0;a<r.length;a++){let h=[];for(let u=0;u<r[a].length;u++){let f=_g(r[a][u],i);Zs(e,f),h.push(f)}s.push(h)}return s}function Xs(r,e,i){let s=[];for(let a=0;a<r.length;a++){let h=xd(r[a],e,i);s.push(h)}return s}function Gf(r,e,i,s){if(r[0]<i[0]||r[0]>i[2]){let a=.5*s,h=r[0]-i[0]>a?-s:i[0]-r[0]>a?s:0;h===0&&(h=r[0]-i[2]>a?-s:i[2]-r[0]>a?s:0),r[0]+=h}Zs(e,r)}function qf(r,e,i,s){let a=Math.pow(2,s.z)*Ws,h=[s.x*Ws,s.y*Ws],u=[];if(!r)return u;for(let f of r)for(let g of f){let y=[g.x+h[0],g.y+h[1]];Gf(y,e,i,a),u.push(y)}return u}function kh(r,e,i,s){let a=Math.pow(2,s.z)*Ws,h=[s.x*Ws,s.y*Ws],u=[];if(!r)return u;for(let g of r){let y=[];for(let T of g){let E=[T.x+h[0],T.y+h[1]];Zs(e,E),y.push(E)}u.push(y)}if(e[2]-e[0]<=a/2){(f=e)[0]=f[1]=1/0,f[2]=f[3]=-1/0;for(let g of u)for(let y of g)Gf(y,e,i,a)}var f;return u}class Ys{constructor(e,i){this.type=Di,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(ti(e[1])){let s=e[1];if(s.type==="FeatureCollection")for(let a=0;a<s.features.length;++a){let h=s.features[a].geometry.type;if(h==="Polygon"||h==="MultiPolygon")return new Ys(s,s.features[a].geometry)}else if(s.type==="Feature"){let a=s.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new Ys(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new Ys(s,s)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,s){let a=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],u=i.canonicalID();if(!u)return!1;if(s.type==="Polygon"){let f=xd(s.coordinates,h,u),g=qf(i.geometry(),a,h,u);if(!ul(a,h))return!1;for(let y of g)if(!dl(y,f))return!1}if(s.type==="MultiPolygon"){let f=Xs(s.coordinates,h,u),g=qf(i.geometry(),a,h,u);if(!ul(a,h))return!1;for(let y of g)if(!Vf(y,f))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,s){let a=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],u=i.canonicalID();if(!u)return!1;if(s.type==="Polygon"){let f=xd(s.coordinates,h,u),g=kh(i.geometry(),a,h,u);if(!ul(a,h))return!1;for(let y of g)if(!Uf(y,f))return!1}if(s.type==="MultiPolygon"){let f=Xs(s.coordinates,h,u),g=kh(i.geometry(),a,h,u);if(!ul(a,h))return!1;for(let y of g)if(!jf(y,f))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}let zc={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},ko=1/298.257223563,vd=ko*(2-ko),pl=Math.PI/180;class fl{static fromTile(e,i,s){let a=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),h=Math.atan(.5*(Math.exp(a)-Math.exp(-a)))/pl;return new fl(h,s)}static get units(){return zc}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!zc[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(zc).join(", ")}`);let s=6378.137*pl*(i?zc[i]:1),a=Math.cos(e*pl),h=1/(1-vd*(1-a*a)),u=Math.sqrt(h);this.kx=s*u*a,this.ky=s*u*h*(1-vd)}distance(e,i){let s=go(e[0]-i[0])*this.kx,a=(e[1]-i[1])*this.ky;return Math.sqrt(s*s+a*a)}bearing(e,i){let s=go(i[0]-e[0])*this.kx;return Math.atan2(s,(i[1]-e[1])*this.ky)/pl}destination(e,i,s){let a=s*pl;return this.offset(e,Math.sin(a)*i,Math.cos(a)*i)}offset(e,i,s){return[e[0]+i/this.kx,e[1]+s/this.ky]}lineDistance(e){let i=0;for(let s=0;s<e.length-1;s++)i+=this.distance(e[s],e[s+1]);return i}area(e){let i=0;for(let s=0;s<e.length;s++){let a=e[s];for(let h=0,u=a.length,f=u-1;h<u;f=h++)i+=go(a[h][0]-a[f][0])*(a[h][1]+a[f][1])*(s?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let s=0;if(i<=0)return e[0];for(let a=0;a<e.length-1;a++){let h=e[a],u=e[a+1],f=this.distance(h,u);if(s+=f,s>i)return Fh(h,u,(i-(s-f))/f)}return e[e.length-1]}pointToSegmentDistance(e,i,s){let[a,h]=i,u=go(s[0]-a)*this.kx,f=(s[1]-h)*this.ky;if(u!==0||f!==0){let g=(go(e[0]-a)*this.kx*u+(e[1]-h)*this.ky*f)/(u*u+f*f);g>1?(a=s[0],h=s[1]):g>0&&(a+=u/this.kx*g,h+=f/this.ky*g)}return u=go(e[0]-a)*this.kx,f=(e[1]-h)*this.ky,Math.sqrt(u*u+f*f)}pointOnLine(e,i){let s=1/0,a=e[0][0],h=e[0][1],u=0,f=0;for(let g=0;g<e.length-1;g++){let y=e[g][0],T=e[g][1],E=go(e[g+1][0]-y)*this.kx,A=(e[g+1][1]-T)*this.ky,R=0;E===0&&A===0||(R=(go(i[0]-y)*this.kx*E+(i[1]-T)*this.ky*A)/(E*E+A*A),R>1?(y=e[g+1][0],T=e[g+1][1]):R>0&&(y+=E/this.kx*R,T+=A/this.ky*R)),E=go(i[0]-y)*this.kx,A=(i[1]-T)*this.ky;let L=E*E+A*A;L<s&&(s=L,a=y,h=T,u=g,f=R)}return{point:[a,h],index:u,t:Math.max(0,Math.min(1,f))}}lineSlice(e,i,s){let a=this.pointOnLine(s,e),h=this.pointOnLine(s,i);if(a.index>h.index||a.index===h.index&&a.t>h.t){let y=a;a=h,h=y}let u=[a.point],f=a.index+1,g=h.index;!bd(s[f],u[0])&&f<=g&&u.push(s[f]);for(let y=f+1;y<=g;y++)u.push(s[y]);return bd(s[g],h.point)||u.push(h.point),u}lineSliceAlong(e,i,s){let a=0,h=[];for(let u=0;u<s.length-1;u++){let f=s[u],g=s[u+1],y=this.distance(f,g);if(a+=y,a>e&&h.length===0&&h.push(Fh(f,g,(e-(a-y))/y)),a>=i)return h.push(Fh(f,g,(i-(a-y))/y)),h;a>e&&h.push(g)}return h}bufferPoint(e,i){let s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[0]+a,e[1]+s]}bufferBBox(e,i){let s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[2]+a,e[3]+s]}insideBBox(e,i){return go(e[0]-i[0])>=0&&go(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function bd(r,e){return r[0]===e[0]&&r[1]===e[1]}function Fh(r,e,i){let s=go(e[0]-r[0]);return[r[0]+s*i,r[1]+(e[1]-r[1])*i]}function go(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class Bh{constructor(e=[],i=(s,a)=>s<a?-1:s>a?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;let e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){let{data:i,compare:s}=this,a=i[e];for(;e>0;){let h=e-1>>1,u=i[h];if(s(a,u)>=0)break;i[e]=u,e=h}i[e]=a}_down(e){let{data:i,compare:s}=this,a=this.length>>1,h=i[e];for(;e<a;){let u=1+(e<<1),f=u+1;if(f<this.length&&s(i[f],i[u])<0&&(u=f),s(i[u],h)>=0)break;i[e]=i[u],e=u}i[e]=h}}var ht=8192;function wd(r,e){return e.dist-r.dist}let Nh=100,Vh=50;function Dc(r){let e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==r[i])return!1;return!0}function Pa(r){return r[1]-r[0]+1}function Fo(r,e){let i=r[1]>=r[0]&&r[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function Uh(r,e){if(r[0]>r[1])return[null,null];let i=Pa(r);if(e){if(i===2)return[r,null];let s=Math.floor(i/2);return[[r[0],r[0]+s],[r[0]+s,r[1]]]}{if(i===1)return[r,null];let s=Math.floor(i/2)-1;return[[r[0],r[0]+s],[r[0]+s+1,r[1]]]}}function Ks(r,e){let i=[1/0,1/0,-1/0,-1/0];if(!Fo(e,r.length))return i;for(let s=e[0];s<=e[1];++s)Zs(i,r[s]);return i}function Oc(r){let e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<r.length;++i)for(let s=0;s<r[i].length;++s)Zs(e,r[i][s]);return e}function Yo(r,e,i){if(Dc(r)||Dc(e))return NaN;let s=0,a=0;return r[2]<e[0]&&(s=e[0]-r[2]),r[0]>e[2]&&(s=r[0]-e[2]),r[1]>e[3]&&(a=r[1]-e[3]),r[3]<e[1]&&(a=e[1]-r[3]),i.distance([0,0],[s,a])}function _i(r){return 360*r-180}function yg(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Td(r,e){let i=Math.pow(2,e.z),s=(r.y/ht+e.y)/i;return[_i((r.x/ht+e.x)/i),yg(s)]}function xg(r,e){let i=[];for(let s=0;s<r.length;++s)i.push(Td(r[s],e));return i}function Sd(r,e,i){let s=i.pointOnLine(e,r).point;return i.distance(r,s)}function Hf(r,e,i,s,a){let h=i.slice(s[0],s[1]+1),u=1/0;for(let f=e[0];f<=e[1];++f)if((u=Math.min(u,Sd(r[f],h,a)))===0)return 0;return u}function pr(r,e,i,s,a){let h=Math.min(a.pointToSegmentDistance(r,i,s),a.pointToSegmentDistance(e,i,s)),u=Math.min(a.pointToSegmentDistance(i,r,e),a.pointToSegmentDistance(s,r,e));return Math.min(h,u)}function vg(r,e,i,s,a){if(!Fo(e,r.length)||!Fo(s,i.length))return NaN;let h=1/0;for(let u=e[0];u<e[1];++u)for(let f=s[0];f<s[1];++f){if(Oh(r[u],r[u+1],i[f],i[f+1]))return 0;h=Math.min(h,pr(r[u],r[u+1],i[f],i[f+1],a))}return h}function bg(r,e,i,s,a){if(!Fo(e,r.length)||!Fo(s,i.length))return NaN;let h=1/0;for(let u=e[0];u<=e[1];++u)for(let f=s[0];f<=s[1];++f)if((h=Math.min(h,a.distance(r[u],i[f])))===0)return h;return h}function wg(r,e,i){if(dl(r,e,!0))return 0;let s=1/0;for(let a of e){let h=a.length;if(h<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(a[0]!==a[h-1]&&(s=Math.min(s,i.pointToSegmentDistance(r,a[h-1],a[0])))===0||(s=Math.min(s,Sd(r,a,i)))===0)return s}return s}function Tg(r,e,i,s){if(!Fo(e,r.length))return NaN;for(let h=e[0];h<=e[1];++h)if(dl(r[h],i,!0))return 0;let a=1/0;for(let h=e[0];h<e[1];++h)for(let u of i)for(let f=0,g=u.length,y=g-1;f<g;y=f++){if(Oh(r[h],r[h+1],u[y],u[f]))return 0;a=Math.min(a,pr(r[h],r[h+1],u[y],u[f],s))}return a}function $f(r,e){for(let i of r)for(let s=0;s<=i.length-1;++s)if(dl(i[s],e,!0))return!0;return!1}function Sg(r,e,i,s=1/0){let a=Oc(r),h=Oc(e);if(s!==1/0&&Yo(a,h,i)>=s)return s;if(ul(a,h)){if($f(r,e))return 0}else if($f(e,r))return 0;let u=s;for(let f of r)for(let g=0,y=f.length,T=y-1;g<y;T=g++)for(let E of e)for(let A=0,R=E.length,L=R-1;A<R;L=A++){if(Oh(f[T],f[g],E[L],E[A]))return 0;u=Math.min(u,pr(f[T],f[g],E[L],E[A],i))}return u}function jh(r,e,i,s,a,h,u){if(h===null||u===null)return;let f=Yo(Ks(s,h),Ks(a,u),i);f<e&&r.push({dist:f,range1:h,range2:u})}function Eg(r,e,i,s,a=1/0){let h=Math.min(s.distance(r[0],i[0][0]),a);if(h===0)return h;let u=new Bh([{dist:0,range1:[0,r.length-1],range2:[0,0]}],wd),f=e?Vh:Nh,g=Oc(i);for(;u.length;){let y=u.pop();if(y.dist>=h)continue;let T=y.range1;if(Pa(T)<=f){if(!Fo(T,r.length))return NaN;if(e){let E=Tg(r,T,i,s);if((h=Math.min(h,E))===0)return h}else for(let E=T[0];E<=T[1];++E){let A=wg(r[E],i,s);if((h=Math.min(h,A))===0)return h}}else{let E=Uh(T,e);if(E[0]!==null){let A=Yo(Ks(r,E[0]),g,s);A<h&&u.push({dist:A,range1:E[0],range2:[0,0]})}if(E[1]!==null){let A=Yo(Ks(r,E[1]),g,s);A<h&&u.push({dist:A,range1:E[1],range2:[0,0]})}}}return h}function Zf(r,e,i,s,a,h=1/0){let u=Math.min(h,a.distance(r[0],i[0]));if(u===0)return u;let f=new Bh([{dist:0,range1:[0,r.length-1],range2:[0,i.length-1]}],wd),g=e?Vh:Nh,y=s?Vh:Nh;for(;f.length;){let T=f.pop();if(T.dist>=u)continue;let E=T.range1,A=T.range2;if(Pa(E)<=g&&Pa(A)<=y){if(!Fo(E,r.length)||!Fo(A,i.length))return NaN;if(e&&s?u=Math.min(u,vg(r,E,i,A,a)):e||s?e&&!s?u=Math.min(u,Hf(i,A,r,E,a)):!e&&s&&(u=Math.min(u,Hf(r,E,i,A,a))):u=Math.min(u,bg(r,E,i,A,a)),u===0)return u}else{let R=Uh(E,e),L=Uh(A,s);jh(f,u,a,r,i,R[0],L[0]),jh(f,u,a,r,i,R[0],L[1]),jh(f,u,a,r,i,R[1],L[0]),jh(f,u,a,r,i,R[1],L[1])}}return u}function Ed(r,e,i,s,a=1/0){let h=a,u=Ks(r,[0,r.length-1]);for(let f of i)if(!(h!==1/0&&Yo(u,Ks(f,[0,f.length-1]),s)>=h)&&(h=Math.min(h,Zf(r,e,f,!0,s,h)),h===0))return h;return h}function Gh(r,e,i,s,a=1/0){let h=a,u=Ks(r,[0,r.length-1]);for(let f of i){if(h!==1/0&&Yo(u,Oc(f),s)>=h)continue;let g=Eg(r,e,f,s,h);if(isNaN(g))return g;if((h=Math.min(h,g))===0)return h}return h}function Id(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class Ra{constructor(e,i){this.type=Dt,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(ti(e[1])){let s=e[1];if(s.type==="FeatureCollection"){for(let a=0;a<s.features.length;++a)if(Id(s.features[a].geometry.type))return new Ra(s,s.features[a].geometry)}else if(s.type==="Feature"){if(Id(s.geometry.type))return new Ra(s,s.geometry)}else if(Id(s.type))return new Ra(s,s)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){let i=e.geometry(),s=e.canonicalID();if(i!=null&&s!=null){if(e.geometryType()==="Point")return function(a,h,u){let f=[];for(let y of a)for(let T of y)f.push(Td(T,h));let g=new fl(f[0][1],"meters");return u.type==="Point"||u.type==="MultiPoint"||u.type==="LineString"?Zf(f,!1,u.type==="Point"?[u.coordinates]:u.coordinates,u.type==="LineString",g):u.type==="MultiLineString"?Ed(f,!1,u.coordinates,g):u.type==="Polygon"||u.type==="MultiPolygon"?Gh(f,!1,u.type==="Polygon"?[u.coordinates]:u.coordinates,g):null}(i,s,this.geometries);if(e.geometryType()==="LineString")return function(a,h,u){let f=[];for(let y of a){let T=[];for(let E of y)T.push(Td(E,h));f.push(T)}let g=new fl(f[0][0][1],"meters");if(u.type==="Point"||u.type==="MultiPoint"||u.type==="LineString")return Ed(u.type==="Point"?[u.coordinates]:u.coordinates,u.type==="LineString",f,g);if(u.type==="MultiLineString"){let y=1/0;for(let T=0;T<u.coordinates.length;T++){let E=Ed(u.coordinates[T],!0,f,g,y);if(isNaN(E))return E;if((y=Math.min(y,E))===0)return y}return y}if(u.type==="Polygon"||u.type==="MultiPolygon"){let y=1/0;for(let T=0;T<f.length;T++){let E=Gh(f[T],!0,u.type==="Polygon"?[u.coordinates]:u.coordinates,g,y);if(isNaN(E))return E;if((y=Math.min(y,E))===0)return y}return y}return null}(i,s,this.geometries);if(e.geometryType()==="Polygon")return function(a,h,u){let f=[];for(let y of function(T,E){let A=T.length;if(A<=1)return[T];let R=[],L,k;for(let B=0;B<A;B++){let G=mg(T[B]);G!==0&&(T[B].area=Math.abs(G),k===void 0&&(k=G<0),k===G<0?(L&&R.push(L),L=[T[B]]):L.push(T[B]))}return L&&R.push(L),R}(a)){let T=[];for(let E=0;E<y.length;++E)T.push(xg(y[E],h));f.push(T)}let g=new fl(f[0][0][0][1],"meters");if(u.type==="Point"||u.type==="MultiPoint"||u.type==="LineString")return Gh(u.type==="Point"?[u.coordinates]:u.coordinates,u.type==="LineString",f,g);if(u.type==="MultiLineString"){let y=1/0;for(let T=0;T<u.coordinates.length;T++){let E=Gh(u.coordinates[T],!0,f,g,y);if(isNaN(E))return E;if((y=Math.min(y,E))===0)return y}return y}return u.type==="Polygon"||u.type==="MultiPolygon"?function(y,T,E){let A=1/0;for(let R of y)for(let L of T){let k=Sg(R,L,E,A);if(isNaN(k))return k;if((A=Math.min(A,k))===0)return A}return A}(u.type==="Polygon"?[u.coordinates]:u.coordinates,f,g):null}(i,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function ml(r){if(r instanceof cn&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof Ys||r instanceof Ra)return!1;if(r instanceof gl)return r.featureConstant;let e=!0;return r.eachChild(i=>{e&&!ml(i)&&(e=!1)}),e}function qh(r){if(r instanceof cn&&r.name==="feature-state")return!1;let e=!0;return r.eachChild(i=>{e&&!qh(i)&&(e=!1)}),e}function Hh(r){if(r instanceof gl)return new Set([r.key]);let e=new Set;return r.eachChild(i=>{e=new Set([...e,...Hh(i)])}),e}function _l(r,e){if(r instanceof cn&&e.indexOf(r.name)>=0)return!1;let i=!0;return r.eachChild(s=>{i&&!_l(s,e)&&(i=!1)}),i}function Wf(r,e,i){return[r,e,i].filter(Boolean).join("")}function Ad(r,e){switch(r){case"string":return Do(e);case"number":return+e;case"boolean":return!!e;case"color":return ki.parse(e);case"formatted":return Ln.fromString(Do(e));case"resolvedImage":return qn.build(Do(e))}return e}function Xf(r,e,i,s){return s!==void 0&&(r=s*Math.round(r/s)),e!==void 0&&r<e&&(r=e),i!==void 0&&r>i&&(r=i),r}class gl{constructor(e,i,s,a=!1){this.type=e,this.key=i,this.scope=s,this.featureConstant=a}static parse(e,i){let s=i.expectedType;if(s==null&&(s=Fi),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");let a=i.parse(e[1],1);if(!(a instanceof Gt))return i.error("Key name of 'config' expression must be a string literal.");let h,u=!0,f=Do(a.value);if(e.length>=3){let g=i.parse(e[2],2);if(!(g instanceof Gt))return i.error("Scope of 'config' expression must be a string literal.");h=Do(g.value)}if(i.options){let g=Wf(f,h,i._scope),y=i.options.get(g);y&&(u=ml(y.value||y.default))}return new gl(s,f,h,u)}evaluate(e){let i=Wf(this.key,this.scope,e.scope),s=e.getConfig(i);if(!s)return null;let{type:a,value:h,values:u,minValue:f,maxValue:g,stepValue:y}=s,T=s.default.evaluate(e),E=T;if(h){let A=e.scope;e.scope=(A||"").split("").slice(1).join(""),E=h.evaluate(e),e.scope=A}return a&&(E=Ad(a,E)),E===void 0||f===void 0&&g===void 0&&y===void 0||(typeof E=="number"?E=Xf(E,f,g,y):Array.isArray(E)&&(E=E.map(A=>typeof A=="number"?Xf(A,f,g,y):A))),h!==void 0&&E!==void 0&&u&&!u.includes(E)&&(E=T,a&&(E=Ad(a,E))),(a&&a!==this.type||E!==void 0&&!zh(bt(E),this.type))&&(E=Ad(this.type.kind,E)),E}eachChild(){}outputDefined(){return!1}serialize(){let e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class $h{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");let s=e[1];return i.scope.has(s)?new $h(s,i.scope.get(s)):i.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Zh{constructor(e,i=[],s,a=new _d,h=[],u,f){this.registry=e,this.path=i,this.key=i.map(g=>typeof g=="string"?`['${g}']`:`[${g}]`).join(""),this.scope=a,this.errors=h,this.expectedType=s,this._scope=u,this.options=f}parse(e,i,s,a,h={}){return i||s?this.concat(i,null,s,a)._parse(e,h):this._parse(e,h)}parseObjectValue(e,i,s,a,h,u={}){return this.concat(i,s,a,h)._parse(e,u)}_parse(e,i){function s(a,h,u){return u==="assert"?new Nt(h,[a]):u==="coerce"?new Oo(h,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let a=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(a){let h=a.parse(e,this);if(!h)return null;if(this.expectedType){let u=this.expectedType,f=h.type;if(u.kind!=="string"&&u.kind!=="number"&&u.kind!=="boolean"&&u.kind!=="object"&&u.kind!=="array"||f.kind!=="value")if(u.kind!=="color"&&u.kind!=="formatted"&&u.kind!=="resolvedImage"||f.kind!=="value"&&f.kind!=="string"){if(this.checkSubtype(u,f))return null}else h=s(h,u,i.typeAnnotation||"coerce");else h=s(h,u,i.typeAnnotation||"assert")}if(!(h instanceof Gt)&&h.type.kind!=="resolvedImage"&&Md(h)){let u=new Rc(this._scope,this.options);try{h=new Gt(h.type,h.evaluate(u))}catch(f){return this.error(f.message),null}}return h}return Oo.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,s,a){let h=typeof e=="number"?this.path.concat(e):this.path;h=typeof i=="string"?h.concat(i):h;let u=a?this.scope.concat(a):this.scope;return new Zh(this.registry,h,s||null,u,this.errors,this._scope,this.options)}error(e,...i){let s=`${this.key}${i.map(a=>`[${a}]`).join("")}`;this.errors.push(new _o(s,e))}checkSubtype(e,i){let s=ll(e,i);return s&&this.error(s),s}}function Md(r){if(r instanceof $h)return Md(r.boundExpression);if(r instanceof cn&&r.name==="error"||r instanceof ss||r instanceof Ys||r instanceof Ra||r instanceof gl)return!1;let e=r instanceof Oo||r instanceof Nt,i=!0;return r.eachChild(s=>{i=e?i&&Md(s):i&&s instanceof Gt}),!!i&&ml(r)&&_l(r,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Wh(r,e){let i=r.length-1,s,a,h=0,u=i,f=0;for(;h<=u;)if(f=Math.floor((h+u)/2),s=r[f],a=r[f+1],s<=e){if(f===i||e<a)return f;h=f+1}else{if(!(s>e))throw new Ur("Input is not a number.");u=f-1}return 0}class kc{constructor(e,i,s){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(let[a,h]of s)this.labels.push(a),this.outputs.push(h)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");let s=i.parse(e[1],1,Dt);if(!s)return null;let a=[],h=null;i.expectedType&&i.expectedType.kind!=="value"&&(h=i.expectedType);for(let u=1;u<e.length;u+=2){let f=u===1?-1/0:e[u],g=e[u+1],y=u,T=u+1;if(typeof f!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',y);if(a.length&&a[a.length-1][0]>=f)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',y);let E=i.parse(g,T,h);if(!E)return null;h=h||E.type,a.push([f,E])}return new kc(h,s,a)}evaluate(e){let i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);let a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);let h=i.length;return a>=i[h-1]?s[h-1].evaluate(e):s[Wh(i,a)].evaluate(e)}eachChild(e){e(this.input);for(let i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}let Yf=.95047,Kf=1.08883,Jf=4/29,yl=6/29,Qf=3*yl*yl,Cd=yl*yl*yl,Ig=Math.PI/180,em=180/Math.PI;function Pd(r){return r>Cd?Math.pow(r,1/3):r/Qf+Jf}function Rd(r){return r>yl?r*r*r:Qf*(r-Jf)}function Ld(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function Xh(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function zd(r){let e=Xh(r.r),i=Xh(r.g),s=Xh(r.b),a=Pd((.4124564*e+.3575761*i+.1804375*s)/Yf),h=Pd((.2126729*e+.7151522*i+.072175*s)/1);return{l:116*h-16,a:500*(a-h),b:200*(h-Pd((.0193339*e+.119192*i+.9503041*s)/Kf)),alpha:r.a}}function La(r){let e=(r.l+16)/116,i=isNaN(r.a)?e:e+r.a/500,s=isNaN(r.b)?e:e-r.b/200;return e=1*Rd(e),i=Yf*Rd(i),s=Kf*Rd(s),new ki(Ld(3.2404542*i-1.5371385*e-.4985314*s),Ld(-.969266*i+1.8760108*e+.041556*s),Ld(.0556434*i-.2040259*e+1.0572252*s),r.alpha)}function tm(r,e,i){let s=e-r;return r+i*(s>180||s<-180?s-360*Math.round(s/360):s)}let xl={forward:zd,reverse:La,interpolate:function(r,e,i){return{l:Bt(r.l,e.l,i),a:Bt(r.a,e.a,i),b:Bt(r.b,e.b,i),alpha:Bt(r.alpha,e.alpha,i)}}},Fc={forward:function(r){let{l:e,a:i,b:s}=zd(r),a=Math.atan2(s,i)*em;return{h:a<0?a+360:a,c:Math.sqrt(i*i+s*s),l:e,alpha:r.a}},reverse:function(r){let e=r.h*Ig,i=r.c;return La({l:r.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:r.alpha})},interpolate:function(r,e,i){return{h:tm(r.h,e.h,i),c:Bt(r.c,e.c,i),l:Bt(r.l,e.l,i),alpha:Bt(r.alpha,e.alpha,i)}}};var Yh=Object.freeze({__proto__:null,hcl:Fc,lab:xl});class Hn{constructor(e,i,s,a,h){this.type=e,this.operator=i,this.interpolation=s,this.input=a,this.labels=[],this.outputs=[];for(let[u,f]of h)this.labels.push(u),this.outputs.push(f)}static interpolationFactor(e,i,s,a){let h=0;if(e.name==="exponential")h=Dd(i,e.base,s,a);else if(e.name==="linear")h=Dd(i,1,s,a);else if(e.name==="cubic-bezier"){let u=e.controlPoints;h=new el(u[0],u[1],u[2],u[3]).solve(Dd(i,1,s,a))}return h}static parse(e,i){let[s,a,h,...u]=e;if(!Array.isArray(a)||a.length===0)return i.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){let y=a[1];if(typeof y!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:y}}else{if(a[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(a[0])}`,1,0);{let y=a.slice(1);if(y.length!==4||y.some(T=>typeof T!="number"||T<0||T>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:y}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(h=i.parse(h,2,Dt),!h)return null;let f=[],g=null;s==="interpolate-hcl"||s==="interpolate-lab"?g=Qn:i.expectedType&&i.expectedType.kind!=="value"&&(g=i.expectedType);for(let y=0;y<u.length;y+=2){let T=u[y],E=u[y+1],A=y+3,R=y+4;if(typeof T!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',A);if(f.length&&f[f.length-1][0]>=T)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',A);let L=i.parse(E,R,g);if(!L)return null;g=g||L.type,f.push([T,L])}return g.kind==="number"||g.kind==="color"||g.kind==="array"&&g.itemType.kind==="number"&&typeof g.N=="number"?new Hn(g,s,a,h,f):i.error(`Type ${Zr(g)} is not interpolatable.`)}evaluate(e){let i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);let a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);let h=i.length;if(a>=i[h-1])return s[h-1].evaluate(e);let u=Wh(i,a),f=Hn.interpolationFactor(this.interpolation,a,i[u],i[u+1]),g=s[u].evaluate(e),y=s[u+1].evaluate(e);return this.operator==="interpolate"?Ec[this.type.kind.toLowerCase()](g,y,f):this.operator==="interpolate-hcl"?Fc.reverse(Fc.interpolate(Fc.forward(g),Fc.forward(y),f)):xl.reverse(xl.interpolate(xl.forward(g),xl.forward(y),f))}eachChild(e){e(this.input);for(let i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];let i=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)i.push(this.labels[s],this.outputs[s].serialize());return i}}function Dd(r,e,i,s){let a=s-i,h=r-i;return a===0?0:e===1?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1)}class Kh{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let s=null,a=i.expectedType;a&&a.kind!=="value"&&(s=a);let h=[];for(let f of e.slice(1)){let g=i.parse(f,1+h.length,s,void 0,{typeAnnotation:"omit"});if(!g)return null;s=s||g.type,h.push(g)}let u=a&&h.some(f=>ll(a,f.type));return new Kh(u?Fi:s,h)}evaluate(e){let i,s=null,a=0;for(let h of this.args){if(a++,s=h.evaluate(e),s&&s instanceof qn&&!s.available&&(i||(i=s),s=null,a===this.args.length))return i;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Bc{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(let i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);let s=[];for(let h=1;h<e.length-1;h+=2){let u=e[h];if(typeof u!="string")return i.error(`Expected string, but found ${typeof u} instead.`,h);if(/[^a-zA-Z0-9_]/.test(u))return i.error("Variable names must contain only alphanumeric characters or '_'.",h);let f=i.parse(e[h+1],h+1);if(!f)return null;s.push([u,f])}let a=i.parse(e[e.length-1],e.length-1,i.expectedType,s);return a?new Bc(s,a):null}outputDefined(){return this.result.outputDefined()}serialize(){let e=["let"];for(let[i,s]of this.bindings)e.push(i,s.serialize());return e.push(this.result.serialize()),e}}class Jh{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Dt),a=i.parse(e[2],2,In(i.expectedType||Fi));return s&&a?new Jh(a.type.itemType,s,a):null}evaluate(e){let i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Ur(`Array index out of bounds: ${i} < 0.`);if(i>=s.length)throw new Ur(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i!==Math.floor(i))throw new Ur(`Array index must be an integer, but found ${i} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return s[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Od{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Dt),a=i.parse(e[2],2,In(i.expectedType||Fi));return s&&a?new Od(a.type.itemType,s,a):null}evaluate(e){let i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Ur(`Array index out of bounds: ${i} < 0.`);if(i>s.length-1)throw new Ur(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i===Math.floor(i))return s[i];let a=Math.floor(i),h=Math.ceil(i),u=s[a],f=s[h];if(typeof u!="number"||typeof f!="number")throw new Ur(`Cannot interpolate between non-number values at index ${i}.`);let g=i-a;return u*(1-g)+f*g}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class kd{constructor(e,i){this.type=Di,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Fi),a=i.parse(e[2],2,Fi);return s&&a?Hs(s.type,[Di,zi,Dt,al,Fi])?new kd(s,a):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${Zr(s.type)} instead`):null}evaluate(e){let i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!Mc(i,["boolean","string","number","null"]))throw new Ur(`Expected first argument to be of type boolean, string, number or null, but found ${Zr(bt(i))} instead.`);if(!Mc(s,["string","array"]))throw new Ur(`Expected second argument to be of type array or string, but found ${Zr(bt(s))} instead.`);return s.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Qh{constructor(e,i,s){this.type=Dt,this.needle=e,this.haystack=i,this.fromIndex=s}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Fi),a=i.parse(e[2],2,Fi);if(!s||!a)return null;if(!Hs(s.type,[Di,zi,Dt,al,Fi]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${Zr(s.type)} instead`);if(e.length===4){let h=i.parse(e[3],3,Dt);return h?new Qh(s,a,h):null}return new Qh(s,a)}evaluate(e){let i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Mc(i,["boolean","string","number","null"]))throw new Ur(`Expected first argument to be of type boolean, string, number or null, but found ${Zr(bt(i))} instead.`);if(!Mc(s,["string","array"]))throw new Ur(`Expected second argument to be of type array or string, but found ${Zr(bt(s))} instead.`);if(this.fromIndex){let a=this.fromIndex.evaluate(e);return s.indexOf(i,a)}return s.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){let e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class eu{constructor(e,i,s,a,h,u){this.inputType=e,this.type=i,this.input=s,this.cases=a,this.outputs=h,this.otherwise=u}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let s,a;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);let h={},u=[];for(let y=2;y<e.length-1;y+=2){let T=e[y],E=e[y+1];Array.isArray(T)||(T=[T]);let A=i.concat(y);if(T.length===0)return A.error("Expected at least one branch label.");for(let L of T){if(typeof L!="number"&&typeof L!="string")return A.error("Branch labels must be numbers or strings.");if(typeof L=="number"&&Math.abs(L)>Number.MAX_SAFE_INTEGER)return A.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof L=="number"&&Math.floor(L)!==L)return A.error("Numeric branch labels must be integer values.");if(s){if(A.checkSubtype(s,bt(L)))return null}else s=bt(L);if(h[String(L)]!==void 0)return A.error("Branch labels must be unique.");h[String(L)]=u.length}let R=i.parse(E,y,a);if(!R)return null;a=a||R.type,u.push(R)}let f=i.parse(e[1],1,Fi);if(!f)return null;let g=i.parse(e[e.length-1],e.length-1,a);return g?f.type.kind!=="value"&&i.concat(1).checkSubtype(s,f.type)?null:new eu(s,a,f,h,u,g):null}evaluate(e){let i=this.input.evaluate(e);return(zh(bt(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),s=[],a={};for(let u of i){let f=a[this.cases[u]];f===void 0?(a[this.cases[u]]=s.length,s.push([this.cases[u],[u]])):s[f][1].push(u)}let h=u=>this.inputType.kind==="number"?Number(u):u;for(let[u,f]of s)e.push(f.length===1?h(f[0]):f.map(h)),e.push(this.outputs[u].serialize());return e.push(this.otherwise.serialize()),e}}class tu{constructor(e,i,s){this.type=e,this.branches=i,this.otherwise=s}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let s;i.expectedType&&i.expectedType.kind!=="value"&&(s=i.expectedType);let a=[];for(let u=1;u<e.length-1;u+=2){let f=i.parse(e[u],u,Di);if(!f)return null;let g=i.parse(e[u+1],u+1,s);if(!g)return null;a.push([f,g]),s=s||g.type}let h=i.parse(e[e.length-1],e.length-1,s);return h?new tu(s,a,h):null}evaluate(e){for(let[i,s]of this.branches)if(i.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(let[i,s]of this.branches)e(i),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class za{constructor(e,i,s,a){this.type=e,this.input=i,this.beginIndex=s,this.endIndex=a}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Fi),a=i.parse(e[2],2,Dt);if(!s||!a)return null;if(!Hs(s.type,[In(Fi),zi,Fi]))return i.error(`Expected first argument to be of type array or string, but found ${Zr(s.type)} instead`);if(e.length===4){let h=i.parse(e[3],3,Dt);return h?new za(s.type,s,a,h):null}return new za(s.type,s,a)}evaluate(e){let i=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Mc(i,["string","array"]))throw new Ur(`Expected first argument to be of type array or string, but found ${Zr(bt(i))} instead.`);if(this.endIndex){let a=this.endIndex.evaluate(e);return i.slice(s,a)}return i.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){let e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class Fd{constructor(e,i){this.type=In(zi),this.str=e,this.delimiter=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,zi),a=i.parse(e[2],2,zi);return s&&a?new Fd(s,a):void 0}evaluate(e){let i=this.str.evaluate(e),s=this.delimiter.evaluate(e);return i.split(s)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Bd(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function im(r,e,i,s){return s.compare(e,i)===0}function vl(r,e,i){let s=r!=="=="&&r!=="!=";return class e2{constructor(h,u,f){this.type=Di,this.lhs=h,this.rhs=u,this.collator=f,this.hasUntypedArgument=h.type.kind==="value"||u.type.kind==="value"}static parse(h,u){if(h.length!==3&&h.length!==4)return u.error("Expected two or three arguments.");let f=h[0],g=u.parse(h[1],1,Fi);if(!g)return null;if(!Bd(f,g.type))return u.concat(1).error(`"${f}" comparisons are not supported for type '${Zr(g.type)}'.`);let y=u.parse(h[2],2,Fi);if(!y)return null;if(!Bd(f,y.type))return u.concat(2).error(`"${f}" comparisons are not supported for type '${Zr(y.type)}'.`);if(g.type.kind!==y.type.kind&&g.type.kind!=="value"&&y.type.kind!=="value")return u.error(`Cannot compare types '${Zr(g.type)}' and '${Zr(y.type)}'.`);s&&(g.type.kind==="value"&&y.type.kind!=="value"?g=new Nt(y.type,[g]):g.type.kind!=="value"&&y.type.kind==="value"&&(y=new Nt(g.type,[y])));let T=null;if(h.length===4){if(g.type.kind!=="string"&&y.type.kind!=="string"&&g.type.kind!=="value"&&y.type.kind!=="value")return u.error("Cannot use collator to compare non-string types.");if(T=u.parse(h[3],3,Lh),!T)return null}return new e2(g,y,T)}evaluate(h){let u=this.lhs.evaluate(h),f=this.rhs.evaluate(h);if(s&&this.hasUntypedArgument){let g=bt(u),y=bt(f);if(g.kind!==y.kind||g.kind!=="string"&&g.kind!=="number")throw new Ur(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${g.kind}, ${y.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){let g=bt(u),y=bt(f);if(g.kind!=="string"||y.kind!=="string")return e(h,u,f)}return this.collator?i(h,u,f,this.collator.evaluate(h)):e(h,u,f)}eachChild(h){h(this.lhs),h(this.rhs),this.collator&&h(this.collator)}outputDefined(){return!0}serialize(){let h=[r];return this.eachChild(u=>{h.push(u.serialize())}),h}}}let rm=vl("==",function(r,e,i){return e===i},im),nm=vl("!=",function(r,e,i){return e!==i},function(r,e,i,s){return!im(0,e,i,s)}),Ag=vl("<",function(r,e,i){return e<i},function(r,e,i,s){return s.compare(e,i)<0}),Mg=vl(">",function(r,e,i){return e>i},function(r,e,i,s){return s.compare(e,i)>0}),Cg=vl("<=",function(r,e,i){return e<=i},function(r,e,i,s){return s.compare(e,i)<=0}),iu=vl(">=",function(r,e,i){return e>=i},function(r,e,i,s){return s.compare(e,i)>=0});class Nd{constructor(e,i,s,a,h,u){this.type=zi,this.number=e,this.locale=i,this.currency=s,this.unit=a,this.minFractionDigits=h,this.maxFractionDigits=u}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");let s=i.parse(e[1],1,Dt);if(!s)return null;let a=e[2];if(typeof a!="object"||Array.isArray(a))return i.error("NumberFormat options argument must be an object.");let h=null;if(a.locale&&(h=i.parseObjectValue(a.locale,2,"locale",zi),!h))return null;let u=null;if(a.currency&&(u=i.parseObjectValue(a.currency,2,"currency",zi),!u))return null;let f=null;if(a.unit&&(f=i.parseObjectValue(a.unit,2,"unit",zi),!f))return null;let g=null;if(a["min-fraction-digits"]&&(g=i.parseObjectValue(a["min-fraction-digits"],2,"min-fraction-digits",Dt),!g))return null;let y=null;return a["max-fraction-digits"]&&(y=i.parseObjectValue(a["max-fraction-digits"],2,"max-fraction-digits",Dt),!y)?null:new Nd(s,h,u,f,g,y)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Vd{constructor(e){this.type=Dt,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);let s=i.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${Zr(s.type)} instead.`):new Vd(s):null}evaluate(e){let i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new Ur(`Expected value to be of type string or array, but found ${Zr(bt(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){let e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function om(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let bl={"==":rm,"!=":nm,">":Mg,"<":Ag,">=":iu,"<=":Cg,array:Nt,at:Jh,"at-interpolated":Od,boolean:Nt,case:tu,coalesce:Kh,collator:ss,format:cl,image:hl,in:kd,"index-of":Qh,interpolate:Hn,"interpolate-hcl":Hn,"interpolate-lab":Hn,length:Vd,let:Bc,literal:Gt,match:eu,number:Nt,"number-format":Nd,object:Nt,slice:za,step:kc,string:Nt,"to-boolean":Oo,"to-color":Oo,"to-number":Oo,"to-string":Oo,var:$h,within:Ys,distance:Ra,config:gl,split:Fd};function Ud(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);let h=a?a.evaluate(r):1,u=Ma(e,i,s,h);if(u)throw new Ur(u);return new ki(e/255,i/255,s/255,h)}function sm(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);let h=a?a.evaluate(r):1,u=function(y,T,E,A){return typeof y=="number"&&y>=0&&y<=360?typeof T=="number"&&T>=0&&T<=100&&typeof E=="number"&&E>=0&&E<=100?A===void 0||typeof A=="number"&&A>=0&&A<=1?null:`Invalid hsla value [${[y,T,E,A].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof A=="number"?[y,T,E,A]:[y,T,E]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof A=="number"?[y,T,E,A]:[y,T,E]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,s,h);if(u)throw new Ur(u);let f=`hsla(${e}, ${i}%, ${s}%, ${h})`,g=ki.parse(f);if(!g)throw new Ur(`Failed to parse HSLA color: ${f}`);return g}function am(r,e){return r in e}function ru(r,e){let i=e[r];return i===void 0?null:i}function Js(r){return{type:r}}function jd(r){return{result:"success",value:r}}function Qs(r){return{result:"error",value:r}}function ea(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function nu(r){return r["property-type"]==="data-driven"}function lm(r){return ea(r.expression,"measure-light")}function cm(r){return ea(r.expression,"zoom")}function ou(r){return!!r.expression&&r.expression.interpolated}function su(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function hm(r){return r}function Gd(r,e){let i=e.type==="color",s=r.stops&&typeof r.stops[0][0]=="object",a=s||!(s||r.property!==void 0),h=r.type||(ou(e)?"exponential":"interval");if(i&&((r=Aa({},r)).stops&&(r.stops=r.stops.map(y=>[y[0],ki.parse(y[1])])),r.default=ki.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!Yh[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let u,f,g;if(h==="exponential")u=dm;else if(h==="interval")u=um;else if(h==="categorical"){u=qd,f=Object.create(null);for(let y of r.stops)f[y[0]]=y[1];g=typeof r.stops[0][0]}else{if(h!=="identity")throw new Error(`Unknown function type "${h}"`);u=ta}if(s){let y={},T=[];for(let R=0;R<r.stops.length;R++){let L=r.stops[R],k=L[0].zoom;y[k]===void 0&&(y[k]={zoom:k,type:r.type,property:r.property,default:r.default,stops:[]},T.push(k)),y[k].stops.push([L[0].value,L[1]])}let E=[];for(let R of T)E.push([y[R].zoom,Gd(y[R],e)]);let A={name:"linear"};return{kind:"composite",interpolationType:A,interpolationFactor:Hn.interpolationFactor.bind(void 0,A),zoomStops:E.map(R=>R[0]),evaluate:({zoom:R},L)=>dm({stops:E,base:r.base},e,R).evaluate(R,L)}}if(a){let y=h==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:y,interpolationFactor:Hn.interpolationFactor.bind(void 0,y),zoomStops:r.stops.map(T=>T[0]),evaluate:({zoom:T})=>u(r,e,T,f,g)}}return{kind:"source",evaluate(y,T){let E=T&&T.properties?T.properties[r.property]:void 0;return E===void 0?Da(r.default,e.default):u(r,e,E,f,g)}}}function Da(r,e,i){return r!==void 0?r:e!==void 0?e:i!==void 0?i:void 0}function qd(r,e,i,s,a){return Da(typeof i===a?s[i]:void 0,r.default,e.default)}function um(r,e,i){if($s(i)!=="number")return Da(r.default,e.default);let s=r.stops.length;if(s===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[s-1][0])return r.stops[s-1][1];let a=Wh(r.stops.map(h=>h[0]),i);return r.stops[a][1]}function dm(r,e,i){let s=r.base!==void 0?r.base:1;if($s(i)!=="number")return Da(r.default,e.default);let a=r.stops.length;if(a===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[a-1][0])return r.stops[a-1][1];let h=Wh(r.stops.map(T=>T[0]),i),u=function(T,E,A,R){let L=R-A,k=T-A;return L===0?0:E===1?k/L:(Math.pow(E,k)-1)/(Math.pow(E,L)-1)}(i,s,r.stops[h][0],r.stops[h+1][0]),f=r.stops[h][1],g=r.stops[h+1][1],y=Ec[e.type]||hm;if(r.colorSpace&&r.colorSpace!=="rgb"){let T=Yh[r.colorSpace];y=(E,A)=>T.reverse(T.interpolate(T.forward(E),T.forward(A),u))}return typeof f.evaluate=="function"?{evaluate(...T){let E=f.evaluate.apply(void 0,T),A=g.evaluate.apply(void 0,T);if(E!==void 0&&A!==void 0)return y(E,A,u)}}:y(f,g,u)}function ta(r,e,i){return e.type==="color"?i=ki.parse(i):e.type==="formatted"?i=Ln.fromString(i.toString()):e.type==="resolvedImage"?i=qn.build(i.toString()):$s(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),Da(i,r.default,e.default)}cn.register(bl,{error:[{kind:"error"},[zi],(r,[e])=>{throw new Ur(e.evaluate(r))}],typeof:[zi,[Fi],(r,[e])=>Zr(bt(e.evaluate(r)))],"to-rgba":[In(Dt,4),[Qn],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[In(Dt,4),[Qn],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Qn,[Dt,Dt,Dt],Ud],rgba:[Qn,[Dt,Dt,Dt,Dt],Ud],hsl:[Qn,[Dt,Dt,Dt],sm],hsla:[Qn,[Dt,Dt,Dt,Dt],sm],has:{type:Di,overloads:[[[zi],(r,[e])=>am(e.evaluate(r),r.properties())],[[zi,Cs],(r,[e,i])=>am(e.evaluate(r),i.evaluate(r))]]},get:{type:Fi,overloads:[[[zi],(r,[e])=>ru(e.evaluate(r),r.properties())],[[zi,Cs],(r,[e,i])=>ru(e.evaluate(r),i.evaluate(r))]]},"feature-state":[Fi,[zi],(r,[e])=>ru(e.evaluate(r),r.featureState||{})],properties:[Cs,[],r=>r.properties()],"geometry-type":[zi,[],r=>r.geometryType()],worldview:[zi,[],r=>r.globals.worldview||""],id:[Fi,[],r=>r.id()],zoom:[Dt,[],r=>r.globals.zoom],pitch:[Dt,[],r=>r.globals.pitch||0],"distance-from-center":[Dt,[],r=>r.distanceFromCenter()],"measure-light":[Dt,[zi],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[Dt,[],r=>r.globals.heatmapDensity||0],"line-progress":[Dt,[],r=>r.globals.lineProgress||0],"raster-value":[Dt,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[Dt,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[Dt,[],r=>r.globals.skyRadialProgress||0],accumulated:[Fi,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[Dt,Js(Dt),(r,e)=>{let i=0;for(let s of e)i+=s.evaluate(r);return i}],"*":[Dt,Js(Dt),(r,e)=>{let i=1;for(let s of e)i*=s.evaluate(r);return i}],"-":{type:Dt,overloads:[[[Dt,Dt],(r,[e,i])=>e.evaluate(r)-i.evaluate(r)],[[Dt],(r,[e])=>-e.evaluate(r)]]},"/":[Dt,[Dt,Dt],(r,[e,i])=>e.evaluate(r)/i.evaluate(r)],"%":[Dt,[Dt,Dt],(r,[e,i])=>e.evaluate(r)%i.evaluate(r)],ln2:[Dt,[],()=>Math.LN2],pi:[Dt,[],()=>Math.PI],e:[Dt,[],()=>Math.E],"^":[Dt,[Dt,Dt],(r,[e,i])=>Math.pow(e.evaluate(r),i.evaluate(r))],sqrt:[Dt,[Dt],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[Dt,[Dt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[Dt,[Dt],(r,[e])=>Math.log(e.evaluate(r))],log2:[Dt,[Dt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN2],sin:[Dt,[Dt],(r,[e])=>Math.sin(e.evaluate(r))],cos:[Dt,[Dt],(r,[e])=>Math.cos(e.evaluate(r))],tan:[Dt,[Dt],(r,[e])=>Math.tan(e.evaluate(r))],asin:[Dt,[Dt],(r,[e])=>Math.asin(e.evaluate(r))],acos:[Dt,[Dt],(r,[e])=>Math.acos(e.evaluate(r))],atan:[Dt,[Dt],(r,[e])=>Math.atan(e.evaluate(r))],min:[Dt,Js(Dt),(r,e)=>Math.min(...e.map(i=>i.evaluate(r)))],max:[Dt,Js(Dt),(r,e)=>Math.max(...e.map(i=>i.evaluate(r)))],abs:[Dt,[Dt],(r,[e])=>Math.abs(e.evaluate(r))],round:[Dt,[Dt],(r,[e])=>{let i=e.evaluate(r);return i<0?-Math.round(-i):Math.round(i)}],floor:[Dt,[Dt],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[Dt,[Dt],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[Di,[zi,Fi],(r,[e,i])=>r.properties()[e.value]===i.value],"filter-id-==":[Di,[Fi],(r,[e])=>r.id()===e.value],"filter-type-==":[Di,[zi],(r,[e])=>r.geometryType()===e.value],"filter-<":[Di,[zi,Fi],(r,[e,i])=>{let s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<a}],"filter-id-<":[Di,[Fi],(r,[e])=>{let i=r.id(),s=e.value;return typeof i==typeof s&&i<s}],"filter->":[Di,[zi,Fi],(r,[e,i])=>{let s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>a}],"filter-id->":[Di,[Fi],(r,[e])=>{let i=r.id(),s=e.value;return typeof i==typeof s&&i>s}],"filter-<=":[Di,[zi,Fi],(r,[e,i])=>{let s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<=a}],"filter-id-<=":[Di,[Fi],(r,[e])=>{let i=r.id(),s=e.value;return typeof i==typeof s&&i<=s}],"filter->=":[Di,[zi,Fi],(r,[e,i])=>{let s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>=a}],"filter-id->=":[Di,[Fi],(r,[e])=>{let i=r.id(),s=e.value;return typeof i==typeof s&&i>=s}],"filter-has":[Di,[Fi],(r,[e])=>e.value in r.properties()],"filter-has-id":[Di,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[Di,[In(zi)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[Di,[In(Fi)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[Di,[zi,In(Fi)],(r,[e,i])=>i.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[Di,[zi,In(Fi)],(r,[e,i])=>function(s,a,h,u){for(;h<=u;){let f=h+u>>1;if(a[f]===s)return!0;a[f]>s?u=f-1:h=f+1}return!1}(r.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Di,overloads:[[[Di,Di],(r,[e,i])=>e.evaluate(r)&&i.evaluate(r)],[Js(Di),(r,e)=>{for(let i of e)if(!i.evaluate(r))return!1;return!0}]]},any:{type:Di,overloads:[[[Di,Di],(r,[e,i])=>e.evaluate(r)||i.evaluate(r)],[Js(Di),(r,e)=>{for(let i of e)if(i.evaluate(r))return!0;return!1}]]},"!":[Di,[Di],(r,[e])=>!e.evaluate(r)],"is-supported-script":[Di,[zi],(r,[e])=>{let i=r.globals&&r.globals.isSupportedScript;return!i||i(e.evaluate(r))}],upcase:[zi,[zi],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[zi,[zi],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[zi,Js(Fi),(r,e)=>e.map(i=>Do(i.evaluate(r))).join("")],"resolved-locale":[zi,[Lh],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[Dt,[Dt,Dt,Fi],(r,e)=>{let[i,s,a]=e.map(u=>u.evaluate(r));if(i>s||i===s)return i;let h;if(typeof a=="string")h=function(u){let f=0;if(u.length===0)return f;for(let g=0;g<u.length;g++)f=(f<<5)-f+u.charCodeAt(g),f|=0;return f}(a);else{if(typeof a!="number")throw new Ur(`Invalid seed input: ${a}`);h=a}return i+om(h)()*(s-i)}]});class Hd{constructor(e,i,s,a){this.expression=e,this._warningHistory={},this._evaluator=new Rc(s,a),this._defaultValue=i?function(h){return h.type==="color"&&(su(h.default)||Array.isArray(h.default))?new ki(0,0,0,0):h.type==="color"?ki.parse(h.default)||null:h.default===void 0?null:h.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=Hh(e)}evaluateWithoutErrorHandling(e,i,s,a,h,u,f,g){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=s,this._evaluator.canonical=a||null,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=u,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=g||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,s,a,h,u,f,g){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=s||null,this._evaluator.canonical=a||null,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=u||null,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=g||null;try{let y=this.expression.evaluate(this._evaluator);if(y==null||typeof y=="number"&&y!=y)return this._defaultValue;if(this._enumValues&&!(y in this._enumValues))throw new Ur(`Expected value to be one of ${Object.keys(this._enumValues).map(T=>JSON.stringify(T)).join(", ")}, but found ${JSON.stringify(y)} instead.`);return y}catch(y){return this._warningHistory[y.message]||(this._warningHistory[y.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${y.message}`)),this._defaultValue}}}function $d(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in bl}function Oa(r,e,i,s){let a=new Zh(bl,[],e?function(u){let f={color:Qn,string:zi,number:Dt,enum:zi,boolean:Di,formatted:Ic,resolvedImage:Ac};return u.type==="array"?In(f[u.value]||Fi,u.length):f[u.type]}(e):void 0,void 0,void 0,i,s),h=a.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return h?jd(new Hd(h,e,i,s)):Qs(a.errors)}class au{constructor(e,i,s,a){this.kind=e,this._styleExpression=i,this.isLightConstant=s,this.isLineProgressConstant=a,this.isStateDependent=e!=="constant"&&!qh(i.expression),this.configDependencies=Hh(i.expression)}evaluateWithoutErrorHandling(e,i,s,a,h,u){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,h,u)}evaluate(e,i,s,a,h,u){return this._styleExpression.evaluate(e,i,s,a,h,u)}}class ia{constructor(e,i,s,a,h,u){this.kind=e,this.zoomStops=s,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!qh(i.expression),this.isLightConstant=h,this.isLineProgressConstant=u,this.configDependencies=Hh(i.expression),this.interpolationType=a}evaluateWithoutErrorHandling(e,i,s,a,h,u){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,h,u)}evaluate(e,i,s,a,h,u){return this._styleExpression.evaluate(e,i,s,a,h,u)}interpolationFactor(e,i,s){return this.interpolationType?Hn.interpolationFactor(this.interpolationType,e,i,s):0}}function Zd(r,e,i,s){if((r=Oa(r,e,i,s)).result==="error")return r;let a=r.value.expression,h=ml(a);if(!h&&!nu(e))return Qs([new _o("","data expressions not supported")]);let u=_l(a,["zoom","pitch","distance-from-center"]);if(!u&&!cm(e))return Qs([new _o("","zoom expressions not supported")]);let f=_l(a,["measure-light"]);if(!f&&!lm(e))return Qs([new _o("","measure-light expression not supported")]);let g=_l(a,["line-progress"]);if(!g&&!function(E){return ea(E.expression,"line-progress")}(e))return Qs([new _o("","line-progress expression not supported")]);let y=e.expression&&e.expression.relaxZoomRestriction,T=Nc(a);return T||u||y?T instanceof _o?Qs([T]):T instanceof Hn&&!ou(e)?Qs([new _o("",'"interpolate" expressions cannot be used with this property')]):jd(T?new ia(h&&g?"camera":"composite",r.value,T.labels,T instanceof Hn?T.interpolation:void 0,f,g):new au(h&&g?"constant":"source",r.value,f,g)):Qs([new _o("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class ka{constructor(e,i){this._parameters=e,this._specification=i,Aa(this,Gd(this._parameters,this._specification))}static deserialize(e){return new ka(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Nc(r){let e=null;if(r instanceof Bc)e=Nc(r.result);else if(r instanceof Kh){for(let i of r.args)if(e=Nc(i),e)break}else(r instanceof kc||r instanceof Hn)&&r.input instanceof cn&&r.input.name==="zoom"&&(e=r);return e instanceof _o||r.eachChild(i=>{let s=Nc(i);s instanceof _o?e=s:e&&s&&e!==s&&(e=new _o("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Wd,pm,Xd=function(){if(pm)return Wd;pm=1,Wd=e;var r=3;function e(i,s,a){var h=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var u=new Int32Array(this.arrayBuffer);i=u[0],this.d=(s=u[1])+2*(a=u[2]);for(var f=0;f<this.d*this.d;f++){var g=u[r+f],y=u[r+f+1];h.push(g===y?null:u.subarray(g,y))}var T=u[r+h.length+1];this.keys=u.subarray(u[r+h.length],T),this.bboxes=u.subarray(T),this.insert=this._insertReadonly}else{this.d=s+2*a;for(var E=0;E<this.d*this.d;E++)h.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=i,this.padding=a,this.scale=s/i,this.uid=0;var A=a/s*i;this.min=-A,this.max=i+A}return e.prototype.insert=function(i,s,a,h,u){this._forEachCell(s,a,h,u,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(s),this.bboxes.push(a),this.bboxes.push(h),this.bboxes.push(u)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,s,a,h,u,f){this.cells[u].push(f)},e.prototype.query=function(i,s,a,h,u){var f=this.min,g=this.max;if(i<=f&&s<=f&&g<=a&&g<=h&&!u)return Array.prototype.slice.call(this.keys);var y=[];return this._forEachCell(i,s,a,h,this._queryCell,y,{},u),y},e.prototype._queryCell=function(i,s,a,h,u,f,g,y){var T=this.cells[u];if(T!==null)for(var E=this.keys,A=this.bboxes,R=0;R<T.length;R++){var L=T[R];if(g[L]===void 0){var k=4*L;(y?y(A[k+0],A[k+1],A[k+2],A[k+3]):i<=A[k+2]&&s<=A[k+3]&&a>=A[k+0]&&h>=A[k+1])?(g[L]=!0,f.push(E[L])):g[L]=!1}}},e.prototype._forEachCell=function(i,s,a,h,u,f,g,y){for(var T=this._convertToCellCoord(i),E=this._convertToCellCoord(s),A=this._convertToCellCoord(a),R=this._convertToCellCoord(h),L=T;L<=A;L++)for(var k=E;k<=R;k++){var B=this.d*k+L;if((!y||y(this._convertFromCellCoord(L),this._convertFromCellCoord(k),this._convertFromCellCoord(L+1),this._convertFromCellCoord(k+1)))&&u.call(this,i,s,a,h,B,f,g,y))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,s=r+this.cells.length+1+1,a=0,h=0;h<this.cells.length;h++)a+=this.cells[h].length;var u=new Int32Array(s+a+this.keys.length+this.bboxes.length);u[0]=this.extent,u[1]=this.n,u[2]=this.padding;for(var f=s,g=0;g<i.length;g++){var y=i[g];u[r+g]=f,u.set(y,f),f+=y.length}return u[r+i.length]=f,u.set(this.keys,f),u[r+i.length+1]=f+=this.keys.length,u.set(this.bboxes,f),f+=this.bboxes.length,u.buffer},Wd}(),ra=hc(Xd);let Vc={};function Tt(r,e,i={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),Vc[e]={klass:r,omit:i.omit||[]}}Tt(Object,"Object"),ra.serialize=function(r,e){let i=r.toArrayBuffer();return e&&e.add(i),{buffer:i}},ra.deserialize=function(r){return new ra(r.buffer)},Object.defineProperty(ra,"name",{value:"Grid"}),Tt(ra,"Grid"),delete Qe.prototype.constructor,typeof DOMMatrix<"u"&&Tt(DOMMatrix,"DOMMatrix"),Tt(ki,"Color"),Tt(Error,"Error"),Tt(Ln,"Formatted"),Tt(Dh,"FormattedSection"),Tt(wi,"AJAXError"),Tt(qn,"ResolvedImage"),Tt(ka,"StylePropertyFunction"),Tt(Hd,"StyleExpression",{omit:["_evaluator"]}),Tt(Jn,"ImageId"),Tt(Ps,"ImageVariant"),Tt(ia,"ZoomDependentExpression"),Tt(au,"ZoomConstantExpression"),Tt(cn,"CompoundExpression",{omit:["_evaluate"]});for(let r in bl)Vc[bl[r]._classRegistryKey]||Tt(bl[r],`Expression${r}`);function lu(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function Uc(r){return self.ImageBitmap&&r instanceof ImageBitmap}function Rs(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(lu(r)||Uc(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){let i=[];for(let s of r)i.push(Rs(s,e));return i}if(r instanceof Map){let i={$name:"Map",entries:[]};for(let[s,a]of r.entries())i.entries.push(Rs(s),Rs(a,e));return i}if(r instanceof Set){let i={$name:"Set"},s=0;for(let a of r.values())i[++s]=Rs(a);return i}if(r instanceof DOMMatrix){let i={$name:"DOMMatrix"},s=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(let a of s)i[a]=r[a];return i}if(typeof r=="bigint")return{$name:"BigInt",value:r.toString()};if(typeof r=="object"){let i=r.constructor,s=i._classRegistryKey;if(!s)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);let a=i.serialize?i.serialize(r,e):{};if(!i.serialize){for(let h in r)r.hasOwnProperty(h)&&(Vc[s].omit.indexOf(h)>=0||(a[h]=Rs(r[h],e)));r instanceof Error&&(a.message=r.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(a.$name=s),a}throw new Error("can't serialize object of type "+typeof r)}function $n(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||lu(r)||Uc(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map($n);if(typeof r=="object"){let e=r.$name||"Object";if(e==="Map"){let a=r.entries||[],h=new Map;for(let u=0;u<a.length;u+=2)h.set($n(a[u]),$n(a[u+1]));return h}if(e==="Set"){let a=new Set;for(let h of Object.keys(r))h!=="$name"&&a.add($n(r[h]));return a}if(e==="DOMMatrix"){let a;return a=r.is2D?[r.a,r.b,r.c,r.d,r.e,r.f]:[r.m11,r.m12,r.m13,r.m14,r.m21,r.m22,r.m23,r.m24,r.m31,r.m32,r.m33,r.m34,r.m41,r.m42,r.m43,r.m44],new DOMMatrix(a)}if(e==="BigInt")return BigInt(r.value);let{klass:i}=Vc[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(r);let s=Object.create(i.prototype);for(let a of Object.keys(r))a!=="$name"&&(s[a]=$n(r[a]));return s}throw new Error("can't deserialize object of type "+typeof r)}let Ut={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function Yd(r){for(let e of r)if(cu(e.charCodeAt(0)))return!0;return!1}function Pg(r){for(let e of r)if(!Rg(e.charCodeAt(0)))return!1;return!0}function Rg(r){return!(Ut.Arabic(r)||Ut["Arabic Supplement"](r)||Ut["Arabic Extended-A"](r)||Ut["Arabic Presentation Forms-A"](r)||Ut["Arabic Presentation Forms-B"](r))}function cu(r){return!(r!==746&&r!==747&&(r<4352||!(Ut["Bopomofo Extended"](r)||Ut.Bopomofo(r)||Ut["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Ut["CJK Compatibility Ideographs"](r)||Ut["CJK Compatibility"](r)||Ut["CJK Radicals Supplement"](r)||Ut["CJK Strokes"](r)||!(!Ut["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Ut["CJK Unified Ideographs Extension A"](r)||Ut["CJK Unified Ideographs"](r)||Ut["Enclosed CJK Letters and Months"](r)||Ut["Hangul Compatibility Jamo"](r)||Ut["Hangul Jamo Extended-A"](r)||Ut["Hangul Jamo Extended-B"](r)||Ut["Hangul Jamo"](r)||Ut["Hangul Syllables"](r)||Ut.Hiragana(r)||Ut["Ideographic Description Characters"](r)||Ut.Kanbun(r)||Ut["Kangxi Radicals"](r)||Ut["Katakana Phonetic Extensions"](r)||Ut.Katakana(r)&&r!==12540||!(!Ut["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Ut["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Ut["Unified Canadian Aboriginal Syllabics"](r)||Ut["Unified Canadian Aboriginal Syllabics Extended"](r)||Ut["Vertical Forms"](r)||Ut["Yijing Hexagram Symbols"](r)||Ut["Yi Syllables"](r)||Ut["Yi Radicals"](r))))}function hu(r){return!(cu(r)||function(e){return!!(Ut["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Ut["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Ut["Letterlike Symbols"](e)||Ut["Number Forms"](e)||Ut["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Ut["Control Pictures"](e)&&e!==9251||Ut["Optical Character Recognition"](e)||Ut["Enclosed Alphanumerics"](e)||Ut["Geometric Shapes"](e)||Ut["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Ut["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Ut["CJK Symbols and Punctuation"](e)||Ut.Katakana(e)||Ut["Private Use Area"](e)||Ut["CJK Compatibility Forms"](e)||Ut["Small Form Variants"](e)||Ut["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(r))}function fm(r){return Ut.Arabic(r)||Ut["Arabic Supplement"](r)||Ut["Arabic Extended-A"](r)||Ut["Arabic Presentation Forms-A"](r)||Ut["Arabic Presentation Forms-B"](r)}function uu(r){return r>=1424&&r<=2303||Ut["Arabic Presentation Forms-A"](r)||Ut["Arabic Presentation Forms-B"](r)}function Lg(r,e){return!(!e&&uu(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Ut.Khmer(r))}function zg(r){for(let e of r)if(uu(e.charCodeAt(0)))return!0;return!1}let eo={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"},Kd=null,Dn=eo.unavailable,na=null,mm=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(Dn=eo.error),Kd&&Kd(r)};function Jd(){Qd.fire(new Ms("pluginStateChange",{pluginStatus:Dn,pluginURL:na}))}let Qd=new Ia,ep=function(){return Dn},_m=function(){if(Dn!==eo.deferred||!na)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Dn=eo.loading,Jd(),na&&vc({url:na},r=>{r?mm(r):(Dn=eo.loaded,Jd())})},as={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Dn===eo.loaded||as.applyArabicShaping!=null,isLoading:()=>Dn===eo.loading,setState(r){Dn=r.pluginStatus,na=r.pluginURL},isParsing:()=>Dn===eo.parsing,isParsed:()=>Dn===eo.parsed,getPluginURL:()=>na};class ji{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,s){for(let a of i)if(!Lg(a.charCodeAt(0),s))return!1;return!0}(e,as.isLoaded())}}class jc{constructor(e,i,s,a){this.property=e,this.value=i,this.expression=function(h,u,f,g){if(su(h))return new ka(h,u);if($d(h)||Array.isArray(h)&&h.length>0){let y=Zd(h,u,f,g);if(y.result==="error")throw new Error(y.value.map(T=>`${T.key}: ${T.message}`).join(", "));return y.value}{let y=h;return typeof h=="string"&&u.type==="color"&&(y=ki.parse(h)),{kind:"constant",configDependencies:new Set,evaluate:()=>y}}}(i===void 0?e.specification.default:i,e.specification,s,a)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,s){return this.property.possiblyEvaluate(this,e,i,s)}}class du{constructor(e,i,s){this.property=e,this.value=new jc(e,void 0,i,s)}transitioned(e,i){return new gm(this.property,this.value,i,Le({},e.transition,this.transition),e.now)}untransitioned(){return new gm(this.property,this.value,null,{},0)}}class Gc{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=s,this.configDependencies=new Set}getValue(e){return si(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new du(this._values[e].property,this._scope,this._options)),this._values[e].value=new jc(this._values[e].property,i===null?void 0:si(i),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);let s=this._properties.properties;if(e)for(let a in e){let h=e[a];if(a.endsWith("-transition")){let u=a.slice(0,-11);s[u]&&this.setTransition(u,h)}else s.hasOwnProperty(a)&&this.setValue(a,h)}}getTransition(e){return si(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new du(this._values[e].property)),this._values[e].transition=si(i)||void 0}serialize(){let e={};for(let i of Object.keys(this._values)){let s=this.getValue(i);s!==void 0&&(e[i]=s);let a=this.getTransition(i);a!==void 0&&(e[`${i}-transition`]=a)}return e}transitioned(e,i){let s=new ym(this._properties);for(let a of Object.keys(this._values))s._values[a]=this._values[a].transitioned(e,i._values[a]);return s}untransitioned(){let e=new ym(this._properties);for(let i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class gm{constructor(e,i,s,a,h){let u=a.delay||0,f=a.duration||0;h=h||0,this.property=e,this.value=i,this.begin=h+u,this.end=this.begin+f,e.specification.transition&&(a.delay||a.duration)&&(this.prior=s)}possiblyEvaluate(e,i,s){let a=e.now||0,h=this.value.possiblyEvaluate(e,i,s),u=this.prior;if(u){if(a>this.end)return this.prior=null,h;if(this.value.isDataDriven())return this.prior=null,h;if(a<this.begin)return u.possiblyEvaluate(e,i,s);{let f=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(u.possiblyEvaluate(e,i,s),h,$(f))}}return h}}class ym{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,s){let a=new Ko(this._properties);for(let h of Object.keys(this._values))a._values[h]=this._values[h].possiblyEvaluate(e,i,s);return a}hasTransition(){for(let e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class oa{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=s,this.configDependencies=new Set}getValue(e){return si(this._values[e].value)}setValue(e,i){this._values[e]=new jc(this._values[e].property,i===null?void 0:si(i),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){let e={};for(let i of Object.keys(this._values)){let s=this.getValue(i);s!==void 0&&(e[i]=s)}return e}possiblyEvaluate(e,i,s){let a=new Ko(this._properties);for(let h of Object.keys(this._values))a._values[h]=this._values[h].possiblyEvaluate(e,i,s);return a}}class Fa{constructor(e,i,s){this.property=e,this.value=i,this.parameters=s}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,s,a){return this.property.evaluate(this.value,this.parameters,e,i,s,a)}}class Ko{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ot{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,s){let a=Ec[this.specification.type];return a?a(e,i,s):e}}class gt{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,s,a){return new Fa(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(i,null,{},s,a)}:e.expression,i)}interpolate(e,i,s){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new Fa(this,{kind:"constant",value:void 0},e.parameters);let a=Ec[this.specification.type];return a?new Fa(this,{kind:"constant",value:a(e.value.value,i.value.value,s)},e.parameters):e}evaluate(e,i,s,a,h,u){return e.kind==="constant"?e.value:e.evaluate(i,s,a,h,u)}}class wl{constructor(e){this.specification=e}possiblyEvaluate(e,i,s,a){return!!e.expression.evaluate(i,null,{},s,a)}interpolate(){return!1}}class Ar{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let i=new ji(0,{});for(let s in e){let a=e[s];a.specification.overridable&&this.overridableProperties.push(s);let h=this.defaultPropertyValues[s]=new jc(a,void 0),u=this.defaultTransitionablePropertyValues[s]=new du(a);this.defaultTransitioningPropertyValues[s]=u.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=h.possiblyEvaluate(i)}}}Tt(gt,"DataDrivenProperty"),Tt(ot,"DataConstantProperty"),Tt(wl,"ColorRampProperty");var Se=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"expression"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function xm(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function qc(r){if(Array.isArray(r))return r.map(qc);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){let e={};for(let i in r)e[i]=qc(r[i]);return e}return xm(r)}function Hc(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(let e of r.slice(1))if(!Hc(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Tl(r,e="",i=null,s="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Hc(r)||(r=fu(r));let a=r,h=!0;try{h=function(T){if(!Sl(T))return T;let E=qc(T);return pu(E),E=tp(E),E}(a)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
=======
(()=>{var QM=Object.create;var C_=Object.defineProperty;var eC=Object.getOwnPropertyDescriptor;var tC=Object.getOwnPropertyNames;var iC=Object.getPrototypeOf,rC=Object.prototype.hasOwnProperty;var Tw=(S,m)=>()=>(S&&(m=S(S=0)),m);var cr=(S,m)=>()=>(m||S((m={exports:{}}).exports,m),m.exports),nC=(S,m)=>{for(var v in m)C_(S,v,{get:m[v],enumerable:!0})},Sw=(S,m,v,T)=>{if(m&&typeof m=="object"||typeof m=="function")for(let A of tC(m))!rC.call(S,A)&&A!==v&&C_(S,A,{get:()=>m[A],enumerable:!(T=eC(m,A))||T.enumerable});return S};var s0=(S,m,v)=>(v=S!=null?QM(iC(S)):{},Sw(m||!S||!S.__esModule?C_(v,"default",{value:S,enumerable:!0}):v,S)),oC=S=>Sw(C_({},"__esModule",{value:!0}),S);var HT=cr((rx,nx)=>{(function(S,m){typeof rx=="object"&&typeof nx<"u"?nx.exports=m():typeof define=="function"&&define.amd?define(m):(S=S||self,S.TinyQueue=m())})(rx,function(){"use strict";var S=function(T,A){if(T===void 0&&(T=[]),A===void 0&&(A=m),this.data=T,this.length=this.data.length,this.compare=A,this.length>0)for(var n=(this.length>>1)-1;n>=0;n--)this._down(n)};S.prototype.push=function(T){this.data.push(T),this.length++,this._up(this.length-1)},S.prototype.pop=function(){if(this.length!==0){var T=this.data[0],A=this.data.pop();return this.length--,this.length>0&&(this.data[0]=A,this._down(0)),T}},S.prototype.peek=function(){return this.data[0]},S.prototype._up=function(T){for(var A=this,n=A.data,O=A.compare,V=n[T];T>0;){var H=T-1>>1,J=n[H];if(O(V,J)>=0)break;n[T]=J,T=H}n[T]=V},S.prototype._down=function(T){for(var A=this,n=A.data,O=A.compare,V=this.length>>1,H=n[T];T<V;){var J=(T<<1)+1,ae=n[J],we=J+1;if(we<this.length&&O(n[we],ae)<0&&(J=we,ae=n[we]),O(ae,H)>=0)break;n[T]=ae,T=J}n[T]=H};function m(v,T){return v<T?-1:v>T?1:0}return S})});var e2=cr((cx,hx)=>{(function(S,m){typeof cx=="object"&&typeof hx<"u"?hx.exports=m():typeof define=="function"&&define.amd?define(m):(S=typeof globalThis<"u"?globalThis:S||self,S.mapboxgl=m())})(cx,function(){"use strict";var S,m,v;function T(n,O){if(!S)S=O;else if(!m)m=O;else{var V="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+S+")(sharedChunk); ("+m+")(sharedChunk); self.onerror = null;",H={};S(H),v=O(H),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(v.workerUrl=window.URL.createObjectURL(new Blob([V],{type:"text/javascript"})))}}T(["exports"],function(n){var O=1e-6,V=typeof Float32Array<"u"?Float32Array:Array;function H(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=i*h-a*s;return u?(r[0]=h*(u=1/u),r[1]=-s*u,r[2]=-a*u,r[3]=i*u,r):null}function J(){var r=new V(9);return V!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function ae(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=e[4],f=e[5],g=e[6],y=e[7],w=e[8];return r[0]=u*w-f*y,r[1]=a*y-s*w,r[2]=s*f-a*u,r[3]=f*g-h*w,r[4]=i*w-a*g,r[5]=a*h-i*f,r[6]=h*y-u*g,r[7]=s*g-i*y,r[8]=i*u-s*h,r}function we(r,e,i){var s=e[0],a=e[1],h=e[2],u=e[3],f=e[4],g=e[5],y=e[6],w=e[7],E=e[8],I=i[0],R=i[1],L=i[2],k=i[3],B=i[4],G=i[5],X=i[6],W=i[7],K=i[8];return r[0]=I*s+R*u+L*y,r[1]=I*a+R*f+L*w,r[2]=I*h+R*g+L*E,r[3]=k*s+B*u+G*y,r[4]=k*a+B*f+G*w,r[5]=k*h+B*g+G*E,r[6]=X*s+W*u+K*y,r[7]=X*a+W*f+K*w,r[8]=X*h+W*g+K*E,r}function Ae(){var r=new V(16);return V!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function xe(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Ge(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=e[4],f=e[5],g=e[6],y=e[7],w=e[8],E=e[9],I=e[10],R=e[11],L=e[12],k=e[13],B=e[14],G=e[15],X=i*f-s*u,W=i*g-a*u,K=i*y-h*u,pe=s*g-a*f,ce=s*y-h*f,ue=a*y-h*g,ge=w*k-E*L,ve=w*B-I*L,Ne=w*G-R*L,Ee=E*B-I*k,Ue=E*G-R*k,nt=I*G-R*B,qe=X*nt-W*Ue+K*Ee+pe*Ne-ce*ve+ue*ge;return qe?(r[0]=(f*nt-g*Ue+y*Ee)*(qe=1/qe),r[1]=(a*Ue-s*nt-h*Ee)*qe,r[2]=(k*ue-B*ce+G*pe)*qe,r[3]=(I*ce-E*ue-R*pe)*qe,r[4]=(g*Ne-u*nt-y*ve)*qe,r[5]=(i*nt-a*Ne+h*ve)*qe,r[6]=(B*K-L*ue-G*W)*qe,r[7]=(w*ue-I*K+R*W)*qe,r[8]=(u*Ue-f*Ne+y*ge)*qe,r[9]=(s*Ne-i*Ue-h*ge)*qe,r[10]=(L*ce-k*K+G*X)*qe,r[11]=(E*K-w*ce-R*X)*qe,r[12]=(f*ve-u*Ee-g*ge)*qe,r[13]=(i*Ee-s*ve+a*ge)*qe,r[14]=(k*W-L*pe-B*X)*qe,r[15]=(w*pe-E*W+I*X)*qe,r):null}function Te(r,e,i){var s=e[0],a=e[1],h=e[2],u=e[3],f=e[4],g=e[5],y=e[6],w=e[7],E=e[8],I=e[9],R=e[10],L=e[11],k=e[12],B=e[13],G=e[14],X=e[15],W=i[0],K=i[1],pe=i[2],ce=i[3];return r[0]=W*s+K*f+pe*E+ce*k,r[1]=W*a+K*g+pe*I+ce*B,r[2]=W*h+K*y+pe*R+ce*G,r[3]=W*u+K*w+pe*L+ce*X,r[4]=(W=i[4])*s+(K=i[5])*f+(pe=i[6])*E+(ce=i[7])*k,r[5]=W*a+K*g+pe*I+ce*B,r[6]=W*h+K*y+pe*R+ce*G,r[7]=W*u+K*w+pe*L+ce*X,r[8]=(W=i[8])*s+(K=i[9])*f+(pe=i[10])*E+(ce=i[11])*k,r[9]=W*a+K*g+pe*I+ce*B,r[10]=W*h+K*y+pe*R+ce*G,r[11]=W*u+K*w+pe*L+ce*X,r[12]=(W=i[12])*s+(K=i[13])*f+(pe=i[14])*E+(ce=i[15])*k,r[13]=W*a+K*g+pe*I+ce*B,r[14]=W*h+K*y+pe*R+ce*G,r[15]=W*u+K*w+pe*L+ce*X,r}function We(r,e,i){var s,a,h,u,f,g,y,w,E,I,R,L,k=i[0],B=i[1],G=i[2];return e===r?(r[12]=e[0]*k+e[4]*B+e[8]*G+e[12],r[13]=e[1]*k+e[5]*B+e[9]*G+e[13],r[14]=e[2]*k+e[6]*B+e[10]*G+e[14],r[15]=e[3]*k+e[7]*B+e[11]*G+e[15]):(a=e[1],h=e[2],u=e[3],f=e[4],g=e[5],y=e[6],w=e[7],E=e[8],I=e[9],R=e[10],L=e[11],r[0]=s=e[0],r[1]=a,r[2]=h,r[3]=u,r[4]=f,r[5]=g,r[6]=y,r[7]=w,r[8]=E,r[9]=I,r[10]=R,r[11]=L,r[12]=s*k+f*B+E*G+e[12],r[13]=a*k+g*B+I*G+e[13],r[14]=h*k+y*B+R*G+e[14],r[15]=u*k+w*B+L*G+e[15]),r}function ft(r,e,i){var s=i[0],a=i[1],h=i[2];return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=e[3]*s,r[4]=e[4]*a,r[5]=e[5]*a,r[6]=e[6]*a,r[7]=e[7]*a,r[8]=e[8]*h,r[9]=e[9]*h,r[10]=e[10]*h,r[11]=e[11]*h,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function _t(r,e,i){var s=Math.sin(i),a=Math.cos(i),h=e[4],u=e[5],f=e[6],g=e[7],y=e[8],w=e[9],E=e[10],I=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=h*a+y*s,r[5]=u*a+w*s,r[6]=f*a+E*s,r[7]=g*a+I*s,r[8]=y*a-h*s,r[9]=w*a-u*s,r[10]=E*a-f*s,r[11]=I*a-g*s,r}function Pt(r,e,i){var s=Math.sin(i),a=Math.cos(i),h=e[0],u=e[1],f=e[2],g=e[3],y=e[8],w=e[9],E=e[10],I=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=h*a-y*s,r[1]=u*a-w*s,r[2]=f*a-E*s,r[3]=g*a-I*s,r[8]=h*s+y*a,r[9]=u*s+w*a,r[10]=f*s+E*a,r[11]=g*s+I*a,r}function At(r,e,i){var s=Math.sin(i),a=Math.cos(i),h=e[0],u=e[1],f=e[2],g=e[3],y=e[4],w=e[5],E=e[6],I=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=h*a+y*s,r[1]=u*a+w*s,r[2]=f*a+E*s,r[3]=g*a+I*s,r[4]=y*a-h*s,r[5]=w*a-u*s,r[6]=E*a-f*s,r[7]=I*a-g*s,r}function wt(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Ct(r,e,i){var s,a,h,u=i[0],f=i[1],g=i[2],y=Math.hypot(u,f,g);return y<O?null:(u*=y=1/y,f*=y,g*=y,s=Math.sin(e),a=Math.cos(e),r[0]=u*u*(h=1-a)+a,r[1]=f*u*h+g*s,r[2]=g*u*h-f*s,r[3]=0,r[4]=u*f*h-g*s,r[5]=f*f*h+a,r[6]=g*f*h+u*s,r[7]=0,r[8]=u*g*h+f*s,r[9]=f*g*h-u*s,r[10]=g*g*h+a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function Ft(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=i+i,f=s+s,g=a+a,y=i*u,w=s*u,E=s*f,I=a*u,R=a*f,L=a*g,k=h*u,B=h*f,G=h*g;return r[0]=1-E-L,r[1]=w+G,r[2]=I-B,r[3]=0,r[4]=w-G,r[5]=1-y-L,r[6]=R+k,r[7]=0,r[8]=I+B,r[9]=R-k,r[10]=1-y-E,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}Math.hypot||(Math.hypot=function(){for(var r=0,e=arguments.length;e--;)r+=arguments[e]*arguments[e];return Math.sqrt(r)});var Wt=Te;function mt(){var r=new V(3);return V!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function er(r){var e=new V(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function Ni(r){return Math.hypot(r[0],r[1],r[2])}function yi(r,e,i){var s=new V(3);return s[0]=r,s[1]=e,s[2]=i,s}function mi(r,e,i,s){return r[0]=e,r[1]=i,r[2]=s,r}function vi(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r[2]=e[2]+i[2],r}function mr(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],r}function Fr(r,e,i){return r[0]=e[0]*i[0],r[1]=e[1]*i[1],r[2]=e[2]*i[2],r}function Rr(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r}function Hr(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r}function Xi(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r}function tn(r,e,i,s){return r[0]=e[0]+i[0]*s,r[1]=e[1]+i[1]*s,r[2]=e[2]+i[2]*s,r}function Po(r,e){var i=e[0]-r[0],s=e[1]-r[1],a=e[2]-r[2];return i*i+s*s+a*a}function Ro(r){var e=r[0],i=r[1],s=r[2];return e*e+i*i+s*s}function Zo(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function Oi(r,e){var i=e[0],s=e[1],a=e[2],h=i*i+s*s+a*a;return h>0&&(h=1/Math.sqrt(h)),r[0]=e[0]*h,r[1]=e[1]*h,r[2]=e[2]*h,r}function or(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function Vr(r,e,i){var s=e[0],a=e[1],h=e[2],u=i[0],f=i[1],g=i[2];return r[0]=a*g-h*f,r[1]=h*u-s*g,r[2]=s*f-a*u,r}function Bn(r,e,i,s){var a=e[0],h=e[1],u=e[2];return r[0]=a+s*(i[0]-a),r[1]=h+s*(i[1]-h),r[2]=u+s*(i[2]-u),r}function Lr(r,e,i){var s=e[0],a=e[1],h=e[2],u=i[3]*s+i[7]*a+i[11]*h+i[15];return r[0]=(i[0]*s+i[4]*a+i[8]*h+i[12])/(u=u||1),r[1]=(i[1]*s+i[5]*a+i[9]*h+i[13])/u,r[2]=(i[2]*s+i[6]*a+i[10]*h+i[14])/u,r}function ks(r,e,i){var s=e[0],a=e[1],h=e[2];return r[0]=s*i[0]+a*i[3]+h*i[6],r[1]=s*i[1]+a*i[4]+h*i[7],r[2]=s*i[2]+a*i[5]+h*i[8],r}function Fs(r,e,i){var s=i[0],a=i[1],h=i[2],u=e[0],f=e[1],g=e[2],y=a*g-h*f,w=h*u-s*g,E=s*f-a*u,I=a*E-h*w,R=h*y-s*E,L=s*w-a*y,k=2*i[3];return w*=k,E*=k,R*=2,L*=2,r[0]=u+(y*=k)+(I*=2),r[1]=f+w+R,r[2]=g+E+L,r}function nc(r){return r[0]=0,r[1]=0,r[2]=0,r}function Lo(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}var zr=mr,Nn=Fr,Bs=Ni;function oc(){var r=new V(4);return V!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function xs(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r}function co(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=i*i+s*s+a*a+h*h;return u>0&&(u=1/Math.sqrt(u)),r[0]=i*u,r[1]=s*u,r[2]=a*u,r[3]=h*u,r}function Yn(r,e,i){var s=e[0],a=e[1],h=e[2],u=e[3];return r[0]=i[0]*s+i[4]*a+i[8]*h+i[12]*u,r[1]=i[1]*s+i[5]*a+i[9]*h+i[13]*u,r[2]=i[2]*s+i[6]*a+i[10]*h+i[14]*u,r[3]=i[3]*s+i[7]*a+i[11]*h+i[15]*u,r}function vs(){var r=new V(4);return V!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function bs(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function xa(r,e,i){i*=.5;var s=e[0],a=e[1],h=e[2],u=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+u*f,r[1]=a*g+h*f,r[2]=h*g-a*f,r[3]=u*g-s*f,r}function Ya(r,e,i){i*=.5;var s=e[0],a=e[1],h=e[2],u=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g-h*f,r[1]=a*g+u*f,r[2]=h*g+s*f,r[3]=u*g-a*f,r}mt(),oc();var Vn,ho,sc,ws=co,Ka=(Vn=mt(),ho=yi(1,0,0),sc=yi(0,1,0),function(r,e,i){var s=or(e,i);return s<-.999999?(Vr(Vn,ho,e),Bs(Vn)<1e-6&&Vr(Vn,sc,e),Oi(Vn,Vn),function(a,h,u){u*=.5;var f=Math.sin(u);a[0]=f*h[0],a[1]=f*h[1],a[2]=f*h[2],a[3]=Math.cos(u)}(r,Vn,Math.PI),r):s>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Vr(Vn,e,i),r[0]=Vn[0],r[1]=Vn[1],r[2]=Vn[2],r[3]=1+s,ws(r,r))});function Sn(){var r=new V(2);return V!=Float32Array&&(r[0]=0,r[1]=0),r}function uo(r,e){var i=new V(2);return i[0]=r,i[1]=e,i}function Ns(r,e,i){return r[0]=e[0]+i[0],r[1]=e[1]+i[1],r}function Ts(r,e,i){return r[0]=e[0]-i[0],r[1]=e[1]-i[1],r}function Vs(r,e,i){return r[0]=e[0]*i,r[1]=e[1]*i,r}function Us(r){return Math.hypot(r[0],r[1])}function Ja(r,e){var i=e[0],s=e[1],a=i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),r[0]=e[0]*a,r[1]=e[1]*a,r}function hr(r,e){return r[0]*e[0]+r[1]*e[1]}vs(),vs(),J();var ac,lc,po=Ts;function cc(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}Sn();var ad=function(){if(lc)return ac;function r(e,i,s,a){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(a-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=s,this.p2y=a}return lc=1,ac=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,a=0;a<8;a++){var h=this.sampleCurveX(s)-e;if(Math.abs(h)<i)return s;var u=this.sampleCurveDerivativeX(s);if(Math.abs(u)<1e-6)break;s-=h/u}var f=0,g=1;for(s=e,a=0;a<20&&(h=this.sampleCurveX(s),!(Math.abs(h-e)<i));a++)e>h?f=s:g=s,s=.5*(g-f)+f;return s},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},ac}(),Qa=cc(ad);function Qe(r,e){this.x=r,this.y=e}function Ss(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(!Ss(r[i],e[i]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(let i in r)if(!Ss(r[i],e[i]))return!1;return!0}return r===e}Qe.prototype={clone(){return new Qe(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,e){return this.clone()._rotateAround(r,e)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){let e=r.x-this.x,i=r.y-this.y;return e*e+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,e){return Math.atan2(this.x*e-this.y*r,this.x*r+this.y*e)},_matMult(r){let e=r[2]*this.x+r[3]*this.y;return this.x=r[0]*this.x+r[1]*this.y,this.y=e,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){let r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){let e=Math.cos(r),i=Math.sin(r),s=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=s,this},_rotateAround(r,e){let i=Math.cos(r),s=Math.sin(r),a=e.y+s*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-s*(this.y-e.y),this.y=a,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Qe},Qe.convert=function(r){if(r instanceof Qe)return r;if(Array.isArray(r))return new Qe(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new Qe(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};let ld=Math.PI/180,hc=180/Math.PI;function Ai(r){return r*ld}function Re(r){return r*hc}let q=[[0,0],[1,0],[1,1],[0,1]];function $(r){if(r<=0)return 0;if(r>=1)return 1;let e=r*r,i=e*r;return 4*(r<.5?i:3*(r-e)+i-.75)}function ie(r,e,i,s){let a=new Qa(r,e,i,s);return function(h){return a.solve(h)}}let fe=ie(.25,.1,.25,1);function re(r,e,i){return Math.min(i,Math.max(e,r))}function ye(r,e,i){return(i=re((i-r)/(e-r),0,1))*i*(3-2*i)}function De(r,e,i){let s=i-e,a=((r-e)%s+s)%s+e;return a===e?i:a}function be(r,e,i){if(!r.length)return i(null,[]);let s=r.length,a=new Array(r.length),h=null;r.forEach((u,f)=>{e(u,(g,y)=>{g&&(h=g),a[f]=y,--s==0&&i(h,a)})})}function Le(r,...e){for(let i of e)for(let s in i)r[s]=i[s];return r}let st=1;function He(){return st++}function kt(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}function Ht(r,e){r.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function Xt(r,e,i){let s={};for(let a in r)s[a]=e.call(this,r[a],a,r);return s}function ui(r,e,i){let s={};for(let a in r)e.call(this,r[a],a,r)&&(s[a]=r[a]);return s}function si(r){return Array.isArray(r)?r.map(si):typeof r=="object"&&r?Xt(r,si):r}function di(r,e){for(let i=0;i<r.length;i++)if(e.indexOf(r[i])>=0)return!0;return!1}let Yi={};function pi(r){Yi[r]||(typeof console<"u"&&console.warn(r),Yi[r]=!0)}function Mr(r,e,i){return(i.y-r.y)*(e.x-r.x)>(e.y-r.y)*(i.x-r.x)}function Qr(r){let e=0;for(let i,s,a=0,h=r.length,u=h-1;a<h;u=a++)i=r[a],s=r[u],e+=(s.x-i.x)*(i.y+s.y);return e}function $r([r,e,i]){let s=Ai(e+90),a=Ai(i);return{x:r*Math.cos(s)*Math.sin(a),y:r*Math.sin(s)*Math.sin(a),z:r*Math.cos(a),azimuthal:e,polar:i}}function Hi(r){return(typeof self<"u"||r!==void 0)&&typeof WorkerGlobalScope<"u"&&(r!==void 0?r:self)instanceof WorkerGlobalScope}function Pi(r){let e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,s,a,h)=>{let u=a||h;return e[s]=!u||u.toLowerCase(),""}),e["max-age"]){let i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Ir=null;function wr(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function _r(r,e,i,s){for(;e<i;){let a=e+i>>1;r[a]<s?e=a+1:i=a}return e}function ln(r,e,i,s){for(;e<i;){let a=e+i>>1;r[a]<=s?e=a+1:i=a}return e}function Un(r){return r>0?1/(1.001-r):1+r}function En(r){return r>0?1-1/(1.001-r):-r}function uc(r,e,i){return(r-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}let mn={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!mn.API_URL)return null;try{let r=new URL(mn.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.1.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function js(r){return mn.API_URL_REGEX.test(r)}function Sh(r){return mn.API_SPRITE_REGEX.test(r)}let dc,pc,Eh,Ih,va,fc;function Ah(){return dc==null&&(dc=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),dc}let Wo={now:()=>Ih!==void 0?Ih:performance.now(),setNow(r){Ih=r},restoreNow(){Ih=void 0},frame(r){let e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){let{width:i,height:s}=r;va||(va=document.createElement("canvas"));let a=va.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("failed to create canvas 2d context");return(i>va.width||s>va.height)&&(va.width=i,va.height=s),a.clearRect(-e,-e,i+2*e,s+2*e),a.drawImage(r,0,0,i,s),a.getImageData(-e,-e,i+2*e,s+2*e)},resolveURL:r=>(pc||(pc=document.createElement("a")),pc.href=r,pc.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Eh==null&&(Eh=window.matchMedia("(prefers-reduced-motion: reduce)")),Eh.matches)},hasCanvasFingerprintNoise(){if(fc!==void 0)return fc;if(!Ah())return fc=!1,!1;let r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0}),i=0;for(let a=0;a<r.width;++a)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(a,0,1,1);let s=e.getImageData(0,0,r.width,r.height);i=0;for(let a=0;a<s.data.length;++a)if(a%4!=3&&i++!==s.data[a])return fc=!0,!0;return fc=!1,!1}};function fo(r,e){let i=r.indexOf("?");if(i<0)return`${r}?${new URLSearchParams(e).toString()}`;let s=new URLSearchParams(r.slice(i));for(let a in e)s.set(a,e[a]);return`${r.slice(0,i)}?${s.toString()}`}function zo(r,e={persistentParams:[]}){let i=r.indexOf("?");if(i<0)return r;let s=new URLSearchParams,a=new URLSearchParams(r.slice(i));for(let u of e.persistentParams){let f=a.get(u);f&&s.set(u,f)}let h=s.toString();return`${r.slice(0,i)}${h.length>0?`?${h}`:""}`}let Es="mapbox-tiles",Xo=500,Is=50,mc=["language","worldview","jobid"],os,_c;function ba(){try{return caches}catch{}}function el(){let r=ba();r&&os==null&&(os=r.open(Es))}let cd=1/0,hd={supported:!1,testSupport:function(r){!gc&&wa&&(tl?Rf(r):jn=r)}},jn,wa,gc=!1,tl=!1,Pf=typeof self<"u"?self:{};function Rf(r){let e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,wa),r.isContextLost())return;hd.supported=!0}catch{}r.deleteTexture(e),gc=!0}Pf.document&&(wa=Pf.document.createElement("img"),wa.onload=function(){jn&&Rf(jn),jn=null,tl=!0},wa.onerror=function(){gc=!0,jn=null},wa.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let yc={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(yc);class wi extends Error{constructor(e,i,s){i===401&&js(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}let Mh=Hi()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,il=function(r,e){if(!(/^file:/.test(i=r.url)||/^file:/.test(Mh())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(s,a){let h=new AbortController,u=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:Mh(),referrerPolicy:s.referrerPolicy,signal:h.signal}),f=!1,g=!1,y=(w=u.url).indexOf("sku=")>0&&js(w);var w;s.type==="json"&&u.headers.set("Accept","application/json");let E=(R,L,k)=>{if(g)return;if(R&&R.message!=="SecurityError"&&pi(R.toString()),L&&k)return I(L);let B=Date.now();fetch(u).then(G=>{if(G.ok){let X=y?G.clone():null;return I(G,X,B)}return a(new wi(G.statusText,G.status,s.url))}).catch(G=>{G.name!=="AbortError"&&a(new Error(`${G.message} ${s.url}`))})},I=(R,L,k)=>{(s.type==="arrayBuffer"?R.arrayBuffer():s.type==="json"?R.json():R.text()).then(B=>{g||(L&&k&&function(G,X,W){if(el(),os==null)return;let K=Pi(X.headers.get("Cache-Control")||"");if(K["no-store"])return;let pe={status:X.status,statusText:X.statusText,headers:new Headers};X.headers.forEach((ge,ve)=>pe.headers.set(ve,ge)),K["max-age"]&&pe.headers.set("Expires",new Date(W+1e3*K["max-age"]).toUTCString());let ce=pe.headers.get("Expires");if(!ce||new Date(ce).getTime()-W<42e4)return;let ue=zo(G.url,{persistentParams:mc});if(X.status===206){let ge=G.headers.get("Range");if(!ge)return;pe.status=200,ue=fo(ue,{range:ge})}(function(ge,ve){if(_c===void 0)try{new Response(new ReadableStream),_c=!0}catch{_c=!1}_c?ve(ge.body):ge.blob().then(ve).catch(Ne=>pi(Ne.message))})(X,ge=>{let ve=new Response((Ne=X.status)!==200&&Ne!==404&&[101,103,204,205,304].includes(Ne)?null:ge,pe);var Ne;el(),os?.then(Ee=>Ee.put(ue,ve)).catch(Ee=>pi(Ee.message))})}(u,L,k),f=!0,a(null,B,R.headers.get("Cache-Control"),R.headers.get("Expires")))}).catch(B=>{g||a(new Error(B.message))})};return y?function(R,L){if(el(),os==null)return L(null);os.then(k=>{let B=zo(R.url,{persistentParams:mc}),G=R.headers.get("Range");G&&(B=fo(B,{range:G})),k.match(B).then(X=>{let W=function(K){if(!K)return!1;let pe=new Date(K.headers.get("Expires")||0),ce=Pi(K.headers.get("Cache-Control")||"");return Number(pe)>Date.now()&&!ce["no-cache"]}(X);k.delete(B).catch(L),W&&k.put(B,X.clone()).catch(L),L(null,X,W)}).catch(L)}).catch(L)}(u,E):E(null,null),{cancel:()=>{g=!0,f||h.abort()}}}(r,e);if(Hi(self)&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var i;return function(s,a){let h=new XMLHttpRequest;h.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(h.responseType="arraybuffer");for(let u in s.headers)h.setRequestHeader(u,s.headers[u]);return s.type==="json"&&(h.responseType="text",h.setRequestHeader("Accept","application/json")),h.withCredentials=s.credentials==="include",h.onerror=()=>{a(new Error(h.statusText))},h.onload=()=>{if((h.status>=200&&h.status<300||h.status===0)&&h.response!==null){let u=h.response;if(s.type==="json")try{u=JSON.parse(h.response)}catch(f){return a(f)}a(null,u,h.getResponseHeader("Cache-Control"),h.getResponseHeader("Expires"))}else a(new wi(h.statusText,h.status,s.url))},h.send(s.body),{cancel:()=>h.abort()}}(r,e)},xc=function(r,e){return il(Le(r,{type:"arrayBuffer"}),e)};function ug(r){let e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}let vc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",Ta,Gs;Ta=[],Gs=0;let bc=function(r,e){if(hd.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),Gs>=mn.MAX_PARALLEL_IMAGE_REQUESTS){let h={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Ta.push(h),h}Gs++;let i=!1,s=()=>{if(!i)for(i=!0,Gs--;Ta.length&&Gs<mn.MAX_PARALLEL_IMAGE_REQUESTS;){let h=Ta.shift(),{requestParameters:u,callback:f,cancelled:g}=h;g||(h.cancel=bc(u,f).cancel)}},a=xc(r,(h,u,f,g)=>{s(),h?e(h):u&&(self.createImageBitmap?function(y,w){let E=new Blob([new Uint8Array(y)],{type:"image/png"});createImageBitmap(E).then(I=>{w(null,I)}).catch(I=>{w(new Error(`Could not load image because of ${I.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(u,(y,w)=>e(y,w,f,g)):function(y,w){let E=new Image;E.onload=()=>{w(null,E),URL.revokeObjectURL(E.src),E.onload=null,requestAnimationFrame(()=>{E.src=vc})},E.onerror=()=>w(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let I=new Blob([new Uint8Array(y)],{type:"image/png"});E.src=y.byteLength?URL.createObjectURL(I):vc}(u,(y,w)=>e(y,w,f,g)))});return{cancel:()=>{a.cancel(),s()}}};var Lf,Ch,zf,rl={exports:{}},Sa={exports:{}},Df={exports:{}},wc=function(){if(zf)return rl.exports;zf=1;var r=(Lf||(Lf=1,Sa.exports=function(i,s){var a,h,u,f,g,y,w,E;for(h=i.length-(a=3&i.length),u=s,g=3432918353,y=461845907,E=0;E<h;)w=255&i.charCodeAt(E)|(255&i.charCodeAt(++E))<<8|(255&i.charCodeAt(++E))<<16|(255&i.charCodeAt(++E))<<24,++E,u=27492+(65535&(f=5*(65535&(u=(u^=w=(65535&(w=(w=(65535&w)*g+(((w>>>16)*g&65535)<<16)&4294967295)<<15|w>>>17))*y+(((w>>>16)*y&65535)<<16)&4294967295)<<13|u>>>19))+((5*(u>>>16)&65535)<<16)&4294967295))+((58964+(f>>>16)&65535)<<16);switch(w=0,a){case 3:w^=(255&i.charCodeAt(E+2))<<16;case 2:w^=(255&i.charCodeAt(E+1))<<8;case 1:u^=w=(65535&(w=(w=(65535&(w^=255&i.charCodeAt(E)))*g+(((w>>>16)*g&65535)<<16)&4294967295)<<15|w>>>17))*y+(((w>>>16)*y&65535)<<16)&4294967295}return u^=i.length,u=2246822507*(65535&(u^=u>>>16))+((2246822507*(u>>>16)&65535)<<16)&4294967295,u=3266489909*(65535&(u^=u>>>13))+((3266489909*(u>>>16)&65535)<<16)&4294967295,(u^=u>>>16)>>>0}),Sa.exports),e=(Ch||(Ch=1,Df.exports=function(i,s){for(var a,h=i.length,u=s^h,f=0;h>=4;)a=1540483477*(65535&(a=255&i.charCodeAt(f)|(255&i.charCodeAt(++f))<<8|(255&i.charCodeAt(++f))<<16|(255&i.charCodeAt(++f))<<24))+((1540483477*(a>>>16)&65535)<<16),u=1540483477*(65535&u)+((1540483477*(u>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),h-=4,++f;switch(h){case 3:u^=(255&i.charCodeAt(f+2))<<16;case 2:u^=(255&i.charCodeAt(f+1))<<8;case 1:u=1540483477*(65535&(u^=255&i.charCodeAt(f)))+((1540483477*(u>>>16)&65535)<<16)}return u=1540483477*(65535&(u^=u>>>13))+((1540483477*(u>>>16)&65535)<<16),(u^=u>>>15)>>>0}),Df.exports);return rl.exports=r,rl.exports.murmur3=r,rl.exports.murmur2=e,rl.exports}(),nl=cc(wc);class As{constructor(e,...i){Le(this,i[0]||{}),this.type=e}}class mo extends As{constructor(e,i={}){super("error",Le({error:e},i))}}function ud(r,e,i){i[r]&&i[r].indexOf(e)!==-1||(i[r]=i[r]||[],i[r].push(e))}function dd(r,e,i){if(i&&i[r]){let s=i[r].indexOf(e);s!==-1&&i[r].splice(s,1)}}class Ea{on(e,i){return this._listeners=this._listeners||{},ud(e,i,this._listeners),this}off(e,i){return dd(e,i,this._listeners),dd(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},ud(e,i,this._oneTimeListeners),this):new Promise(s=>{this.once(e,s)})}fire(e,i){let s=typeof e=="string"?new As(e,i):e,a=s.type;if(this.listens(a)){s.target=this;let h=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(let g of h)g.call(this,s);let u=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(let g of u)dd(a,g,this._oneTimeListeners),g.call(this,s);let f=this._eventedParent;f&&(Le(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),f.fire(s))}else s instanceof mo&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class Kn{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new Kn(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){let[i,s]=e.split("");return new Kn({name:i,iconsetId:s})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return Kn.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var pd,Ph={},fd=function(){if(pd)return Ph;pd=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(h){return(h=Math.round(h))<0?0:h>255?255:h}function i(h){return e(h[h.length-1]==="%"?parseFloat(h)/100*255:parseInt(h))}function s(h){return(u=h[h.length-1]==="%"?parseFloat(h)/100:parseFloat(h))<0?0:u>1?1:u;var u}function a(h,u,f){return f<0?f+=1:f>1&&(f-=1),6*f<1?h+(u-h)*f*6:2*f<1?u:3*f<2?h+(u-h)*(2/3-f)*6:h}try{Ph.parseCSSColor=function(h){var u,f=h.replace(/ /g,"").toLowerCase();if(f in r)return r[f].slice();if(f[0]==="#")return f.length===4?(u=parseInt(f.substr(1),16))>=0&&u<=4095?[(3840&u)>>4|(3840&u)>>8,240&u|(240&u)>>4,15&u|(15&u)<<4,1]:null:f.length===7&&(u=parseInt(f.substr(1),16))>=0&&u<=16777215?[(16711680&u)>>16,(65280&u)>>8,255&u,1]:null;var g=f.indexOf("("),y=f.indexOf(")");if(g!==-1&&y+1===f.length){var w=f.substr(0,g),E=f.substr(g+1,y-(g+1)).split(","),I=1;switch(w){case"rgba":if(E.length!==4)return null;I=s(E.pop());case"rgb":return E.length!==3?null:[i(E[0]),i(E[1]),i(E[2]),I];case"hsla":if(E.length!==4)return null;I=s(E.pop());case"hsl":if(E.length!==3)return null;var R=(parseFloat(E[0])%360+360)%360/360,L=s(E[1]),k=s(E[2]),B=k<=.5?k*(L+1):k+L-k*L,G=2*k-B;return[e(255*a(G,B,R+1/3)),e(255*a(G,B,R)),e(255*a(G,B,R-1/3)),I];default:return null}}return null}}catch{}return Ph}();class ki{constructor(e,i,s,a=1){this.r=e,this.g=i,this.b=s,this.a=a}static parse(e){if(!e)return;if(e instanceof ki)return e;if(typeof e!="string")return;let i=fd.parseCSSColor(e);return i?new ki(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){let[e,i,s,a]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*s)},${a})`}toNonPremultipliedRenderColor(e){let{r:i,g:s,b:a,a:h}=this;return new ol(e,i,s,a,h)}toPremultipliedRenderColor(e){let{r:i,g:s,b:a,a:h}=this;return new Of(e,i*h,s*h,a*h,h)}clone(){return new ki(this.r,this.g,this.b,this.a)}}class Tc{constructor(e,i,s,a,h,u=!1){if(this.premultiplied=!1,this.premultiplied=u,e){let f=e.image.height,g=f*f;this.premultiplied?(i=h===0?0:i/h*(f-1),s=h===0?0:s/h*(f-1),a=h===0?0:a/h*(f-1)):(i*=f-1,s*=f-1,a*=f-1);let y=Math.floor(i),w=Math.floor(s),E=Math.floor(a),I=Math.ceil(i),R=Math.ceil(s),L=Math.ceil(a),k=i-y,B=s-w,G=a-E,X=e.image.data,W=4*(y+w*g+E*f),K=4*(y+w*g+L*f),pe=4*(y+R*g+E*f),ce=4*(y+R*g+L*f),ue=4*(I+w*g+E*f),ge=4*(I+w*g+L*f),ve=4*(I+R*g+E*f),Ne=4*(I+R*g+L*f);if(W<0||Ne>=X.length)throw new Error("out of range");this.r=Bt(Bt(Bt(X[W],X[K],G),Bt(X[pe],X[ce],G),B),Bt(Bt(X[ue],X[ge],G),Bt(X[ve],X[Ne],G),B),k)/255*(this.premultiplied?h:1),this.g=Bt(Bt(Bt(X[W+1],X[K+1],G),Bt(X[pe+1],X[ce+1],G),B),Bt(Bt(X[ue+1],X[ge+1],G),Bt(X[ve+1],X[Ne+1],G),B),k)/255*(this.premultiplied?h:1),this.b=Bt(Bt(Bt(X[W+2],X[K+2],G),Bt(X[pe+2],X[ce+2],G),B),Bt(Bt(X[ue+2],X[ge+2],G),Bt(X[ve+2],X[Ne+2],G),B),k)/255*(this.premultiplied?h:1),this.a=h}else this.r=i,this.g=s,this.b=a,this.a=h}toArray(){let{r:e,g:i,b:s,a}=this;return[255*e,255*i,255*s,a]}toHslaArray(){let{r:e,g:i,b:s,a}=this;if(this.premultiplied){if(a===0)return[0,0,0,0];e/=a,i/=a,s/=a}let h=Math.min(Math.max(e,0),1),u=Math.min(Math.max(i,0),1),f=Math.min(Math.max(s,0),1),g=Math.min(h,u,f),y=Math.max(h,u,f),w=(g+y)/2;if(g===y)return[0,0,100*w,a];let E=y-g,I=w>.5?E/(2-y-g):E/(y+g),R=0;return y===h?R=(u-f)/E+(u<f?6:0):y===u?R=(f-h)/E+2:y===f&&(R=(h-u)/E+4),R*=60,[Math.min(Math.max(R,0),360),Math.min(Math.max(100*I,0),100),Math.min(Math.max(100*w,0),100),a]}toArray01(){let{r:e,g:i,b:s,a}=this;return[e,i,s,a]}toArray01Scaled(e){let{r:i,g:s,b:a}=this;return[i*e,s*e,a*e]}toArray01Linear(){let{r:e,g:i,b:s,a}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(s,2.2),a]}}class ol extends Tc{constructor(e,i,s,a,h){super(e,i,s,a,h,!1)}}class Of extends Tc{constructor(e,i,s,a,h){super(e,i,s,a,h,!0)}}function Bt(r,e,i){return r*(1-i)+e*i}function kf(r,e,i){return r.map((s,a)=>Bt(s,e[a],i))}ki.black=new ki(0,0,0,1),ki.white=new ki(1,1,1,1),ki.transparent=new ki(0,0,0,0),ki.red=new ki(1,0,0,1),ki.blue=new ki(0,0,1,1);var Sc=Object.freeze({__proto__:null,array:kf,color:function(r,e,i){return new ki(Bt(r.r,e.r,i),Bt(r.g,e.g,i),Bt(r.b,e.b,i),Bt(r.a,e.a,i))},number:Bt});function Ia(r,...e){for(let i of e)for(let s in i)r[s]=i[s];return r}class _o extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class md{constructor(e,i=[]){this.parent=e,this.bindings={};for(let[s,a]of i)this.bindings[s]=a}concat(e){return new md(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}let sl={kind:"null"},Dt={kind:"number"},zi={kind:"string"},Di={kind:"boolean"},Jn={kind:"color"},Ms={kind:"object"},Fi={kind:"value"},Rh={kind:"collator"},Ec={kind:"formatted"},Ic={kind:"resolvedImage"};function In(r,e){return{kind:"array",itemType:r,N:e}}function Zr(r){if(r.kind==="array"){let e=Zr(r.itemType);return typeof r.N=="number"?`array<${e}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${e}>`}return r.kind}let dg=[sl,Dt,zi,Di,Jn,Ec,Ms,In(Fi),Ic];function al(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!al(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(let i of dg)if(!al(i,e))return null}}return`Expected ${Zr(r)} but found ${Zr(e)} instead.`}function qs(r,e){return e.some(i=>i.kind===r.kind)}function Ac(r,e){return e.some(i=>i==="null"?r===null:i==="array"?Array.isArray(r):i==="object"?r&&!Array.isArray(r)&&typeof r=="object":i===typeof r)}function Lh(r,e){return r.kind==="array"&&e.kind==="array"?r.N===e.N&&Lh(r.itemType,e.itemType):r.kind===e.kind}class Mc{constructor(e,i,s){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class zh{constructor(e,i,s,a,h){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=s,this.fontStack=a,this.textColor=h}}class Ln{constructor(e){this.sections=e}static fromString(e){return new Ln([new zh(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Ln?e:Ln.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){let e=["format"];for(let i of this.sections){if(i.image){let a=i.image.getPrimary().id.toString();e.push(["image",a]);continue}e.push(i.text);let s={};i.fontStack&&(s["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(s["font-scale"]=i.scale),i.textColor&&(s["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(s)}return e}}class Cs{constructor(e,i={}){if(this.id=Kn.from(e),this.options=Object.assign({},i),i.transform){let{a:s,b:a,c:h,d:u,e:f,f:g}=i.transform;this.options.transform=new DOMMatrix([s,a,h,u,f,g])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){let{a:e,b:i,c:s,d:a,e:h,f:u}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:s,d:a,e:h,f:u}})}static parse(e){let i,s,a,h;try{({name:i,iconsetId:s,params:a,transform:h}=JSON.parse(e)||{})}catch{return null}if(!i)return null;let{a:u,b:f,c:g,d:y,e:w,f:E}=h||{};return new Cs({name:i,iconsetId:s},{params:a,transform:new DOMMatrix([u,f,g,y,w,E])})}scaleSelf(e,i){return this.options.transform.scaleSelf(e,i),this}}class Gn{constructor(e,i,s,a,h=!1){this.primaryId=Kn.from(e),this.primaryOptions=i,s&&(this.secondaryId=Kn.from(s)),this.secondaryOptions=a,this.available=h}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Cs(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Cs(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?Gn.build({name:e}):e}static build(e,i,s,a){return!e||typeof e=="object"&&!("name"in e)?null:new Gn(e,s,i,a)}}function Aa(r,e,i,s){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[r,e,i,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[r,e,i,s]:[r,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ti(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof ki||r instanceof Mc||r instanceof Ln||r instanceof Gn)return!0;if(Array.isArray(r)){for(let e of r)if(!ti(e))return!1;return!0}if(typeof r=="object"){for(let e in r)if(!ti(r[e]))return!1;return!0}return!1}function bt(r){if(r===null)return sl;if(typeof r=="string")return zi;if(typeof r=="boolean")return Di;if(typeof r=="number")return Dt;if(r instanceof ki)return Jn;if(r instanceof Mc)return Rh;if(r instanceof Ln)return Ec;if(r instanceof Gn)return Ic;if(Array.isArray(r)){let e=r.length,i;for(let s of r){let a=bt(s);if(i){if(i===a)continue;i=Fi;break}i=a}return In(i||Fi,e)}return Ms}function Do(r){let e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof Ln||r instanceof Gn||r instanceof ki?r.toString():JSON.stringify(r)}class Gt{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!ti(e[1]))return i.error("invalid value");let s=e[1],a=bt(s),h=i.expectedType;return a.kind!=="array"||a.N!==0||!h||h.kind!=="array"||typeof h.N=="number"&&h.N!==0||(a=h),new Gt(a,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof ki?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Ln?this.value.serialize():this.value}}class Ur{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}let Cc={string:zi,number:Dt,boolean:Di,object:Ms};class Nt{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s,a=1,h=e[0];if(h==="array"){let f,g;if(e.length>2){let y=e[1];if(typeof y!="string"||!(y in Cc)||y==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);f=Cc[y],a++}else f=Fi;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);g=e[2],a++}s=In(f,g)}else s=Cc[h];let u=[];for(;a<e.length;a++){let f=i.parse(e[a],a,Fi);if(!f)return null;u.push(f)}return new Nt(s,u)}evaluate(e){for(let i=0;i<this.args.length;i++){let s=this.args[i].evaluate(e);if(!al(this.type,bt(s)))return s;if(i===this.args.length-1)throw new Ur(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${Zr(bt(s))} but was expected to be of type ${Zr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=this.type,i=[e.kind];if(e.kind==="array"){let s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){i.push(s.kind);let a=e.N;(typeof a=="number"||this.args.length>1)&&i.push(a)}}return i.concat(this.args.map(s=>s.serialize()))}}class ll{constructor(e){this.type=Ec,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s=e[1];if(!Array.isArray(s)&&typeof s=="object")return i.error("First argument must be an image or text section.");let a=[],h=!1;for(let u=1;u<=e.length-1;++u){let f=e[u];if(h&&typeof f=="object"&&!Array.isArray(f)){h=!1;let g=null;if(f["font-scale"]&&(g=i.parseObjectValue(f["font-scale"],u,"font-scale",Dt),!g))return null;let y=null;if(f["text-font"]&&(y=i.parseObjectValue(f["text-font"],u,"text-font",In(zi)),!y))return null;let w=null;if(f["text-color"]&&(w=i.parseObjectValue(f["text-color"],u,"text-color",Jn),!w))return null;let E=a[a.length-1];E.scale=g,E.font=y,E.textColor=w}else{let g=i.parse(e[u],u,Fi);if(!g)return null;let y=g.type.kind;if(y!=="string"&&y!=="value"&&y!=="null"&&y!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");h=!0,a.push({content:g,scale:null,font:null,textColor:null})}}return new ll(a)}evaluate(e){return new Ln(this.sections.map(i=>{let s=i.content.evaluate(e);return Lh(bt(s),Ic)?new zh("",s,null,null,null):new zh(Do(s),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(let i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){let e=["format"];for(let i of this.sections){e.push(i.content.serialize());let s={};i.scale&&(s["font-scale"]=i.scale.serialize()),i.font&&(s["text-font"]=i.font.serialize()),i.textColor&&(s["text-color"]=i.textColor.serialize()),e.push(s)}return e}}class cl{constructor(e,i,s,a){this._imageWarnHistory={},this.type=Ic,this.namePrimary=e,this.nameSecondary=i,s&&(this.paramsPrimary=s.params,this.iconsetIdPrimary=s.iconset?s.iconset.id:void 0),a&&(this.paramsSecondary=a.params,this.iconsetIdSecondary=a.iconset?a.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let s=1,a=[];function h(){if(s<e.length){let f=i.parse(e[s],s++,zi);return f?(a.push({image:f,options:{}}),!0):(i.error(a.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function u(){if(s<e.length){let g=e[s];if((f=g)===null||typeof f!="object"||Array.isArray(f))return!0;let y=g.params,w=g.iconset,E=i.concat(s);if(!y&&!w)return s++,!0;if(y){if(typeof y!="object"||y.constructor!==Object)return E.error('Image options "params" should be an object'),!1;let I={},R=E.concat(void 0,"params");for(let L in y){if(!L)return R.error("Image parameter name should be non-empty"),!1;let k=R.concat(void 0,L).parse(y[L],void 0,Jn,void 0,{typeAnnotation:"coerce"});if(!k)return!1;I[L]=k}a[a.length-1].options.params=I}if(w){if(typeof w!="object"||w.constructor!==Object)return E.error('Image options "iconset" should be an object'),!1;if(!w.id)return E.error('Image options "iconset" should have an "id" property'),!1;a[a.length-1].options.iconset=w}return s++,!0}var f;return!0}for(let f=0;f<2;f++)if(!h()||!u())return;return new cl(a[0].image,a[1]?a[1].image:void 0,a[0].options,a[1]?a[1].options:void 0)}evaluateParams(e,i){let s={};if(i){for(let a in i)if(i[a])try{s[a]=i[a].evaluate(e)}catch{continue}if(Object.keys(s).length!==0)return{params:s}}}evaluate(e){let i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},s=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,a=Gn.build(i,s,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(a&&e.availableImages){let h=a.getPrimary().id;if(a.available=e.availableImages.some(u=>Kn.isEqual(u,h)),a.available){let u=a.getSecondary()?a.getSecondary().id:null;u&&(a.available=e.availableImages.some(f=>Kn.isEqual(f,u)))}}return a}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(let i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(let i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){let s={};if(i&&(s.iconset={id:i}),e){s.params={};for(let a in e)e[a]&&(s.params[a]=e[a].serialize())}return Object.keys(s).length>0?s:void 0}serialize(){let e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){let i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){let i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function Hs(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":r===null?"null":typeof r}let Ff={"to-boolean":Di,"to-color":Jn,"to-number":Dt,"to-string":zi};class Oo{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s=e[0],a=[],h=sl;if(s==="to-array"){if(!Array.isArray(e[1]))return null;let u=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);h=In(i.expectedType.itemType,u)}else{if(!(u>0&&ti(e[1][0])))return null;h=In(bt(e[1][0]),u)}for(let f=0;f<u;f++){let g=e[1][f],y;if(Hs(g)==="array")y=i.parse(g,void 0,h.itemType);else{let w=Hs(g);if(w!==h.itemType.kind)return i.error(`Expected ${h.itemType.kind} but found ${w}.`);y=i.registry.literal.parse(["literal",g===void 0?null:g],i)}if(!y)return null;a.push(y)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return i.error("Expected one argument.");h=Ff[s];for(let u=1;u<e.length;u++){let f=i.parse(e[u],u,Fi);if(!f)return null;a.push(f)}}return new Oo(h,a)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,s;for(let a of this.args){if(i=a.evaluate(e),s=null,i instanceof ki)return i;if(typeof i=="string"){let h=e.parseColor(i);if(h)return h}else if(Array.isArray(i)&&(s=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:Aa(i[0],i[1],i[2],i[3]),!s))return new ki(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Ur(s||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(let s of this.args){if(i=s.evaluate(e),i===null)return 0;let a=Number(i);if(!isNaN(a))return a}throw new Ur(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?Ln.fromString(Do(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Gn.build(Do(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):Do(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new ll([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new cl(this.args[0]).serialize();let e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}let zn=["Unknown","Point","LineString","Polygon"];class Pc{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?zn[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:s,y:a}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*i-e[0])+this.featureDistanceData.bearing[1]*(a*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=ki.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class cn{constructor(e,i,s,a,h){this.name=e,this.type=i,this._evaluate=s,this.args=a,this._overloadIndex=h}evaluate(e){if(!this._evaluate){let i=cn.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){let s=e[0],a=cn.definitions[s];if(!a)return i.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);let h=Array.isArray(a)?a[0]:a.type,u=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,f=[],g=null,y=-1;for(let[w,E]of u){if(Array.isArray(w)&&w.length!==e.length-1)continue;f.push(w),y++,g=new $h(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);let I=[],R=!1;for(let L=1;L<e.length;L++){let k=e[L],B=Array.isArray(w)?w[L-1]:w.type,G=g.parse(k,1+I.length,B);if(!G){R=!0;break}I.push(G)}if(!R)if(Array.isArray(w)&&w.length!==I.length)g.error(`Expected ${w.length} arguments, but found ${I.length} instead.`);else{for(let L=0;L<I.length;L++){let k=Array.isArray(w)?w[L]:w.type,B=I[L];g.concat(L+1).checkSubtype(k,B.type)}if(g.errors.length===0)return new cn(s,h,E,I,y)}}if(f.length===1)i.errors.push(...g.errors);else{let w=(f.length?f:u.map(([I])=>I)).map(_d).join(" | "),E=[];for(let I=1;I<e.length;I++){let R=i.parse(e[I],1+E.length);if(!R)return null;E.push(Zr(R.type))}i.error(`Expected arguments of type ${w}, but found (${E.join(", ")}) instead.`)}return null}static register(e,i){cn.definitions=i;for(let s in i)e[s]=cn}}function _d(r){return Array.isArray(r)?`(${r.map(Zr).join(", ")})`:`(${Zr(r.type)}...)`}class ss{constructor(e,i,s){this.type=Rh,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");let s=e[1];if(typeof s!="object"||Array.isArray(s))return i.error("Collator options argument must be an object.");let a=s["case-sensitive"]===void 0?i.parse(!1,1,Di):i.parseObjectValue(s["case-sensitive"],1,"case-sensitive",Di);if(!a)return null;let h=s["diacritic-sensitive"]===void 0?i.parse(!1,1,Di):i.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",Di);if(!h)return null;let u=null;return s.locale&&(u=i.parseObjectValue(s.locale,1,"locale",zi),!u)?null:new ss(a,h,u)}evaluate(e){return new Mc(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){let e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function An(r,e,i=0,s=r.length-1,a=pg){for(;s>i;){if(s-i>600){let g=s-i+1,y=e-i+1,w=Math.log(g),E=.5*Math.exp(2*w/3),I=.5*Math.sqrt(w*E*(g-E)/g)*(y-g/2<0?-1:1);An(r,e,Math.max(i,Math.floor(e-y*E/g+I)),Math.min(s,Math.floor(e+(g-y)*E/g+I)),a)}let h=r[e],u=i,f=s;for(Rc(r,i,e),a(r[s],h)>0&&Rc(r,i,s);u<f;){for(Rc(r,u,f),u++,f--;a(r[u],h)<0;)u++;for(;a(r[f],h)>0;)f--}a(r[i],h)===0?Rc(r,i,f):(f++,Rc(r,f,s)),f<=e&&(i=f+1),e<=f&&(s=f-1)}}function Rc(r,e,i){let s=r[e];r[e]=r[i],r[i]=s}function pg(r,e){return r<e?-1:r>e?1:0}function fg(r){let e=0;for(let i,s,a=0,h=r.length,u=h-1;a<h;u=a++)i=r[a],s=r[u],e+=(s.x-i.x)*(i.y+s.y);return e}function $s(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function hl(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function Ma(r,e,i){let s=r[0]-e[0],a=r[1]-e[1],h=r[0]-i[0],u=r[1]-i[1];return s*u-h*a==0&&s*h<=0&&a*u<=0}function ul(r,e,i=!1){let s=!1;for(let f=0,g=e.length;f<g;f++){let y=e[f];for(let w=0,E=y.length,I=E-1;w<E;I=w++){let R=y[I],L=y[w];if(Ma(r,R,L))return i;(h=R)[1]>(a=r)[1]!=(u=L)[1]>a[1]&&a[0]<(u[0]-h[0])*(a[1]-h[1])/(u[1]-h[1])+h[0]&&(s=!s)}}var a,h,u;return s}function Bf(r,e,i,s){let a=s[0]-i[0],h=s[1]-i[1],u=(r[0]-i[0])*h-a*(r[1]-i[1]),f=(e[0]-i[0])*h-a*(e[1]-i[1]);return u>0&&f<0||u<0&&f>0}function Dh(r,e,i,s){return(a=[s[0]-i[0],s[1]-i[1]])[0]*(h=[e[0]-r[0],e[1]-r[1]])[1]-a[1]*h[0]!=0&&!(!Bf(r,e,i,s)||!Bf(i,s,r,e));var a,h}function gd(r){let e=new Qe(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new Qe(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let s of r[0])e.x>s.x&&(e.x=s.x),e.y>s.y&&(e.y=s.y),i.x<s.x&&(i.x=s.x),i.y<s.y&&(i.y=s.y);return{min:e,max:i}}let Zs=8192;function mg(r,e){let i=(180+r[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(i*a*Zs),Math.round(s*a*Zs)]}function Nf(r,e){for(let i=0;i<e.length;i++)if(ul(r,e[i]))return!0;return!1}function _g(r,e,i){for(let s of i)for(let a=0,h=s.length,u=h-1;a<h;u=a++)if(Dh(r,e,s[u],s[a]))return!0;return!1}function Vf(r,e){for(let i=0;i<r.length;++i)if(!ul(r[i],e))return!1;for(let i=0;i<r.length-1;++i)if(_g(r[i],r[i+1],e))return!1;return!0}function Uf(r,e){for(let i=0;i<e.length;i++)if(Vf(r,e[i]))return!0;return!1}function yd(r,e,i){let s=[];for(let a=0;a<r.length;a++){let h=[];for(let u=0;u<r[a].length;u++){let f=mg(r[a][u],i);$s(e,f),h.push(f)}s.push(h)}return s}function Ws(r,e,i){let s=[];for(let a=0;a<r.length;a++){let h=yd(r[a],e,i);s.push(h)}return s}function jf(r,e,i,s){if(r[0]<i[0]||r[0]>i[2]){let a=.5*s,h=r[0]-i[0]>a?-s:i[0]-r[0]>a?s:0;h===0&&(h=r[0]-i[2]>a?-s:i[2]-r[0]>a?s:0),r[0]+=h}$s(e,r)}function Gf(r,e,i,s){let a=Math.pow(2,s.z)*Zs,h=[s.x*Zs,s.y*Zs],u=[];if(!r)return u;for(let f of r)for(let g of f){let y=[g.x+h[0],g.y+h[1]];jf(y,e,i,a),u.push(y)}return u}function Oh(r,e,i,s){let a=Math.pow(2,s.z)*Zs,h=[s.x*Zs,s.y*Zs],u=[];if(!r)return u;for(let g of r){let y=[];for(let w of g){let E=[w.x+h[0],w.y+h[1]];$s(e,E),y.push(E)}u.push(y)}if(e[2]-e[0]<=a/2){(f=e)[0]=f[1]=1/0,f[2]=f[3]=-1/0;for(let g of u)for(let y of g)jf(y,e,i,a)}var f;return u}class Xs{constructor(e,i){this.type=Di,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(ti(e[1])){let s=e[1];if(s.type==="FeatureCollection")for(let a=0;a<s.features.length;++a){let h=s.features[a].geometry.type;if(h==="Polygon"||h==="MultiPolygon")return new Xs(s,s.features[a].geometry)}else if(s.type==="Feature"){let a=s.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new Xs(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new Xs(s,s)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,s){let a=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],u=i.canonicalID();if(!u)return!1;if(s.type==="Polygon"){let f=yd(s.coordinates,h,u),g=Gf(i.geometry(),a,h,u);if(!hl(a,h))return!1;for(let y of g)if(!ul(y,f))return!1}if(s.type==="MultiPolygon"){let f=Ws(s.coordinates,h,u),g=Gf(i.geometry(),a,h,u);if(!hl(a,h))return!1;for(let y of g)if(!Nf(y,f))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,s){let a=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],u=i.canonicalID();if(!u)return!1;if(s.type==="Polygon"){let f=yd(s.coordinates,h,u),g=Oh(i.geometry(),a,h,u);if(!hl(a,h))return!1;for(let y of g)if(!Vf(y,f))return!1}if(s.type==="MultiPolygon"){let f=Ws(s.coordinates,h,u),g=Oh(i.geometry(),a,h,u);if(!hl(a,h))return!1;for(let y of g)if(!Uf(y,f))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}let Lc={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},ko=1/298.257223563,xd=ko*(2-ko),dl=Math.PI/180;class pl{static fromTile(e,i,s){let a=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),h=Math.atan(.5*(Math.exp(a)-Math.exp(-a)))/dl;return new pl(h,s)}static get units(){return Lc}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!Lc[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(Lc).join(", ")}`);let s=6378.137*dl*(i?Lc[i]:1),a=Math.cos(e*dl),h=1/(1-xd*(1-a*a)),u=Math.sqrt(h);this.kx=s*u*a,this.ky=s*u*h*(1-xd)}distance(e,i){let s=go(e[0]-i[0])*this.kx,a=(e[1]-i[1])*this.ky;return Math.sqrt(s*s+a*a)}bearing(e,i){let s=go(i[0]-e[0])*this.kx;return Math.atan2(s,(i[1]-e[1])*this.ky)/dl}destination(e,i,s){let a=s*dl;return this.offset(e,Math.sin(a)*i,Math.cos(a)*i)}offset(e,i,s){return[e[0]+i/this.kx,e[1]+s/this.ky]}lineDistance(e){let i=0;for(let s=0;s<e.length-1;s++)i+=this.distance(e[s],e[s+1]);return i}area(e){let i=0;for(let s=0;s<e.length;s++){let a=e[s];for(let h=0,u=a.length,f=u-1;h<u;f=h++)i+=go(a[h][0]-a[f][0])*(a[h][1]+a[f][1])*(s?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let s=0;if(i<=0)return e[0];for(let a=0;a<e.length-1;a++){let h=e[a],u=e[a+1],f=this.distance(h,u);if(s+=f,s>i)return kh(h,u,(i-(s-f))/f)}return e[e.length-1]}pointToSegmentDistance(e,i,s){let[a,h]=i,u=go(s[0]-a)*this.kx,f=(s[1]-h)*this.ky;if(u!==0||f!==0){let g=(go(e[0]-a)*this.kx*u+(e[1]-h)*this.ky*f)/(u*u+f*f);g>1?(a=s[0],h=s[1]):g>0&&(a+=u/this.kx*g,h+=f/this.ky*g)}return u=go(e[0]-a)*this.kx,f=(e[1]-h)*this.ky,Math.sqrt(u*u+f*f)}pointOnLine(e,i){let s=1/0,a=e[0][0],h=e[0][1],u=0,f=0;for(let g=0;g<e.length-1;g++){let y=e[g][0],w=e[g][1],E=go(e[g+1][0]-y)*this.kx,I=(e[g+1][1]-w)*this.ky,R=0;E===0&&I===0||(R=(go(i[0]-y)*this.kx*E+(i[1]-w)*this.ky*I)/(E*E+I*I),R>1?(y=e[g+1][0],w=e[g+1][1]):R>0&&(y+=E/this.kx*R,w+=I/this.ky*R)),E=go(i[0]-y)*this.kx,I=(i[1]-w)*this.ky;let L=E*E+I*I;L<s&&(s=L,a=y,h=w,u=g,f=R)}return{point:[a,h],index:u,t:Math.max(0,Math.min(1,f))}}lineSlice(e,i,s){let a=this.pointOnLine(s,e),h=this.pointOnLine(s,i);if(a.index>h.index||a.index===h.index&&a.t>h.t){let y=a;a=h,h=y}let u=[a.point],f=a.index+1,g=h.index;!vd(s[f],u[0])&&f<=g&&u.push(s[f]);for(let y=f+1;y<=g;y++)u.push(s[y]);return vd(s[g],h.point)||u.push(h.point),u}lineSliceAlong(e,i,s){let a=0,h=[];for(let u=0;u<s.length-1;u++){let f=s[u],g=s[u+1],y=this.distance(f,g);if(a+=y,a>e&&h.length===0&&h.push(kh(f,g,(e-(a-y))/y)),a>=i)return h.push(kh(f,g,(i-(a-y))/y)),h;a>e&&h.push(g)}return h}bufferPoint(e,i){let s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[0]+a,e[1]+s]}bufferBBox(e,i){let s=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-s,e[2]+a,e[3]+s]}insideBBox(e,i){return go(e[0]-i[0])>=0&&go(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function vd(r,e){return r[0]===e[0]&&r[1]===e[1]}function kh(r,e,i){let s=go(e[0]-r[0]);return[r[0]+s*i,r[1]+(e[1]-r[1])*i]}function go(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class Fh{constructor(e=[],i=(s,a)=>s<a?-1:s>a?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;let e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){let{data:i,compare:s}=this,a=i[e];for(;e>0;){let h=e-1>>1,u=i[h];if(s(a,u)>=0)break;i[e]=u,e=h}i[e]=a}_down(e){let{data:i,compare:s}=this,a=this.length>>1,h=i[e];for(;e<a;){let u=1+(e<<1),f=u+1;if(f<this.length&&s(i[f],i[u])<0&&(u=f),s(i[u],h)>=0)break;i[e]=i[u],e=u}i[e]=h}}var ht=8192;function bd(r,e){return e.dist-r.dist}let Bh=100,Nh=50;function zc(r){let e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==r[i])return!1;return!0}function Ca(r){return r[1]-r[0]+1}function Fo(r,e){let i=r[1]>=r[0]&&r[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function Vh(r,e){if(r[0]>r[1])return[null,null];let i=Ca(r);if(e){if(i===2)return[r,null];let s=Math.floor(i/2);return[[r[0],r[0]+s],[r[0]+s,r[1]]]}{if(i===1)return[r,null];let s=Math.floor(i/2)-1;return[[r[0],r[0]+s],[r[0]+s+1,r[1]]]}}function Ys(r,e){let i=[1/0,1/0,-1/0,-1/0];if(!Fo(e,r.length))return i;for(let s=e[0];s<=e[1];++s)$s(i,r[s]);return i}function Dc(r){let e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<r.length;++i)for(let s=0;s<r[i].length;++s)$s(e,r[i][s]);return e}function Yo(r,e,i){if(zc(r)||zc(e))return NaN;let s=0,a=0;return r[2]<e[0]&&(s=e[0]-r[2]),r[0]>e[2]&&(s=r[0]-e[2]),r[1]>e[3]&&(a=r[1]-e[3]),r[3]<e[1]&&(a=e[1]-r[3]),i.distance([0,0],[s,a])}function _i(r){return 360*r-180}function gg(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function wd(r,e){let i=Math.pow(2,e.z),s=(r.y/ht+e.y)/i;return[_i((r.x/ht+e.x)/i),gg(s)]}function yg(r,e){let i=[];for(let s=0;s<r.length;++s)i.push(wd(r[s],e));return i}function Td(r,e,i){let s=i.pointOnLine(e,r).point;return i.distance(r,s)}function qf(r,e,i,s,a){let h=i.slice(s[0],s[1]+1),u=1/0;for(let f=e[0];f<=e[1];++f)if((u=Math.min(u,Td(r[f],h,a)))===0)return 0;return u}function pr(r,e,i,s,a){let h=Math.min(a.pointToSegmentDistance(r,i,s),a.pointToSegmentDistance(e,i,s)),u=Math.min(a.pointToSegmentDistance(i,r,e),a.pointToSegmentDistance(s,r,e));return Math.min(h,u)}function xg(r,e,i,s,a){if(!Fo(e,r.length)||!Fo(s,i.length))return NaN;let h=1/0;for(let u=e[0];u<e[1];++u)for(let f=s[0];f<s[1];++f){if(Dh(r[u],r[u+1],i[f],i[f+1]))return 0;h=Math.min(h,pr(r[u],r[u+1],i[f],i[f+1],a))}return h}function vg(r,e,i,s,a){if(!Fo(e,r.length)||!Fo(s,i.length))return NaN;let h=1/0;for(let u=e[0];u<=e[1];++u)for(let f=s[0];f<=s[1];++f)if((h=Math.min(h,a.distance(r[u],i[f])))===0)return h;return h}function bg(r,e,i){if(ul(r,e,!0))return 0;let s=1/0;for(let a of e){let h=a.length;if(h<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(a[0]!==a[h-1]&&(s=Math.min(s,i.pointToSegmentDistance(r,a[h-1],a[0])))===0||(s=Math.min(s,Td(r,a,i)))===0)return s}return s}function wg(r,e,i,s){if(!Fo(e,r.length))return NaN;for(let h=e[0];h<=e[1];++h)if(ul(r[h],i,!0))return 0;let a=1/0;for(let h=e[0];h<e[1];++h)for(let u of i)for(let f=0,g=u.length,y=g-1;f<g;y=f++){if(Dh(r[h],r[h+1],u[y],u[f]))return 0;a=Math.min(a,pr(r[h],r[h+1],u[y],u[f],s))}return a}function Hf(r,e){for(let i of r)for(let s=0;s<=i.length-1;++s)if(ul(i[s],e,!0))return!0;return!1}function Tg(r,e,i,s=1/0){let a=Dc(r),h=Dc(e);if(s!==1/0&&Yo(a,h,i)>=s)return s;if(hl(a,h)){if(Hf(r,e))return 0}else if(Hf(e,r))return 0;let u=s;for(let f of r)for(let g=0,y=f.length,w=y-1;g<y;w=g++)for(let E of e)for(let I=0,R=E.length,L=R-1;I<R;L=I++){if(Dh(f[w],f[g],E[L],E[I]))return 0;u=Math.min(u,pr(f[w],f[g],E[L],E[I],i))}return u}function Uh(r,e,i,s,a,h,u){if(h===null||u===null)return;let f=Yo(Ys(s,h),Ys(a,u),i);f<e&&r.push({dist:f,range1:h,range2:u})}function Sg(r,e,i,s,a=1/0){let h=Math.min(s.distance(r[0],i[0][0]),a);if(h===0)return h;let u=new Fh([{dist:0,range1:[0,r.length-1],range2:[0,0]}],bd),f=e?Nh:Bh,g=Dc(i);for(;u.length;){let y=u.pop();if(y.dist>=h)continue;let w=y.range1;if(Ca(w)<=f){if(!Fo(w,r.length))return NaN;if(e){let E=wg(r,w,i,s);if((h=Math.min(h,E))===0)return h}else for(let E=w[0];E<=w[1];++E){let I=bg(r[E],i,s);if((h=Math.min(h,I))===0)return h}}else{let E=Vh(w,e);if(E[0]!==null){let I=Yo(Ys(r,E[0]),g,s);I<h&&u.push({dist:I,range1:E[0],range2:[0,0]})}if(E[1]!==null){let I=Yo(Ys(r,E[1]),g,s);I<h&&u.push({dist:I,range1:E[1],range2:[0,0]})}}}return h}function $f(r,e,i,s,a,h=1/0){let u=Math.min(h,a.distance(r[0],i[0]));if(u===0)return u;let f=new Fh([{dist:0,range1:[0,r.length-1],range2:[0,i.length-1]}],bd),g=e?Nh:Bh,y=s?Nh:Bh;for(;f.length;){let w=f.pop();if(w.dist>=u)continue;let E=w.range1,I=w.range2;if(Ca(E)<=g&&Ca(I)<=y){if(!Fo(E,r.length)||!Fo(I,i.length))return NaN;if(e&&s?u=Math.min(u,xg(r,E,i,I,a)):e||s?e&&!s?u=Math.min(u,qf(i,I,r,E,a)):!e&&s&&(u=Math.min(u,qf(r,E,i,I,a))):u=Math.min(u,vg(r,E,i,I,a)),u===0)return u}else{let R=Vh(E,e),L=Vh(I,s);Uh(f,u,a,r,i,R[0],L[0]),Uh(f,u,a,r,i,R[0],L[1]),Uh(f,u,a,r,i,R[1],L[0]),Uh(f,u,a,r,i,R[1],L[1])}}return u}function Sd(r,e,i,s,a=1/0){let h=a,u=Ys(r,[0,r.length-1]);for(let f of i)if(!(h!==1/0&&Yo(u,Ys(f,[0,f.length-1]),s)>=h)&&(h=Math.min(h,$f(r,e,f,!0,s,h)),h===0))return h;return h}function jh(r,e,i,s,a=1/0){let h=a,u=Ys(r,[0,r.length-1]);for(let f of i){if(h!==1/0&&Yo(u,Dc(f),s)>=h)continue;let g=Sg(r,e,f,s,h);if(isNaN(g))return g;if((h=Math.min(h,g))===0)return h}return h}function Ed(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class Pa{constructor(e,i){this.type=Dt,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(ti(e[1])){let s=e[1];if(s.type==="FeatureCollection"){for(let a=0;a<s.features.length;++a)if(Ed(s.features[a].geometry.type))return new Pa(s,s.features[a].geometry)}else if(s.type==="Feature"){if(Ed(s.geometry.type))return new Pa(s,s.geometry)}else if(Ed(s.type))return new Pa(s,s)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){let i=e.geometry(),s=e.canonicalID();if(i!=null&&s!=null){if(e.geometryType()==="Point")return function(a,h,u){let f=[];for(let y of a)for(let w of y)f.push(wd(w,h));let g=new pl(f[0][1],"meters");return u.type==="Point"||u.type==="MultiPoint"||u.type==="LineString"?$f(f,!1,u.type==="Point"?[u.coordinates]:u.coordinates,u.type==="LineString",g):u.type==="MultiLineString"?Sd(f,!1,u.coordinates,g):u.type==="Polygon"||u.type==="MultiPolygon"?jh(f,!1,u.type==="Polygon"?[u.coordinates]:u.coordinates,g):null}(i,s,this.geometries);if(e.geometryType()==="LineString")return function(a,h,u){let f=[];for(let y of a){let w=[];for(let E of y)w.push(wd(E,h));f.push(w)}let g=new pl(f[0][0][1],"meters");if(u.type==="Point"||u.type==="MultiPoint"||u.type==="LineString")return Sd(u.type==="Point"?[u.coordinates]:u.coordinates,u.type==="LineString",f,g);if(u.type==="MultiLineString"){let y=1/0;for(let w=0;w<u.coordinates.length;w++){let E=Sd(u.coordinates[w],!0,f,g,y);if(isNaN(E))return E;if((y=Math.min(y,E))===0)return y}return y}if(u.type==="Polygon"||u.type==="MultiPolygon"){let y=1/0;for(let w=0;w<f.length;w++){let E=jh(f[w],!0,u.type==="Polygon"?[u.coordinates]:u.coordinates,g,y);if(isNaN(E))return E;if((y=Math.min(y,E))===0)return y}return y}return null}(i,s,this.geometries);if(e.geometryType()==="Polygon")return function(a,h,u){let f=[];for(let y of function(w,E){let I=w.length;if(I<=1)return[w];let R=[],L,k;for(let B=0;B<I;B++){let G=fg(w[B]);G!==0&&(w[B].area=Math.abs(G),k===void 0&&(k=G<0),k===G<0?(L&&R.push(L),L=[w[B]]):L.push(w[B]))}return L&&R.push(L),R}(a)){let w=[];for(let E=0;E<y.length;++E)w.push(yg(y[E],h));f.push(w)}let g=new pl(f[0][0][0][1],"meters");if(u.type==="Point"||u.type==="MultiPoint"||u.type==="LineString")return jh(u.type==="Point"?[u.coordinates]:u.coordinates,u.type==="LineString",f,g);if(u.type==="MultiLineString"){let y=1/0;for(let w=0;w<u.coordinates.length;w++){let E=jh(u.coordinates[w],!0,f,g,y);if(isNaN(E))return E;if((y=Math.min(y,E))===0)return y}return y}return u.type==="Polygon"||u.type==="MultiPolygon"?function(y,w,E){let I=1/0;for(let R of y)for(let L of w){let k=Tg(R,L,E,I);if(isNaN(k))return k;if((I=Math.min(I,k))===0)return I}return I}(u.type==="Polygon"?[u.coordinates]:u.coordinates,f,g):null}(i,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function fl(r){if(r instanceof cn&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof Xs||r instanceof Pa)return!1;if(r instanceof _l)return r.featureConstant;let e=!0;return r.eachChild(i=>{e&&!fl(i)&&(e=!1)}),e}function Gh(r){if(r instanceof cn&&r.name==="feature-state")return!1;let e=!0;return r.eachChild(i=>{e&&!Gh(i)&&(e=!1)}),e}function qh(r){if(r instanceof _l)return new Set([r.key]);let e=new Set;return r.eachChild(i=>{e=new Set([...e,...qh(i)])}),e}function ml(r,e){if(r instanceof cn&&e.indexOf(r.name)>=0)return!1;let i=!0;return r.eachChild(s=>{i&&!ml(s,e)&&(i=!1)}),i}function Zf(r,e,i){return[r,e,i].filter(Boolean).join("")}function Id(r,e){switch(r){case"string":return Do(e);case"number":return+e;case"boolean":return!!e;case"color":return ki.parse(e);case"formatted":return Ln.fromString(Do(e));case"resolvedImage":return Gn.build(Do(e))}return e}function Wf(r,e,i,s){return s!==void 0&&(r=s*Math.round(r/s)),e!==void 0&&r<e&&(r=e),i!==void 0&&r>i&&(r=i),r}class _l{constructor(e,i,s,a=!1){this.type=e,this.key=i,this.scope=s,this.featureConstant=a}static parse(e,i){let s=i.expectedType;if(s==null&&(s=Fi),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");let a=i.parse(e[1],1);if(!(a instanceof Gt))return i.error("Key name of 'config' expression must be a string literal.");let h,u=!0,f=Do(a.value);if(e.length>=3){let g=i.parse(e[2],2);if(!(g instanceof Gt))return i.error("Scope of 'config' expression must be a string literal.");h=Do(g.value)}if(i.options){let g=Zf(f,h,i._scope),y=i.options.get(g);y&&(u=fl(y.value||y.default))}return new _l(s,f,h,u)}evaluate(e){let i=Zf(this.key,this.scope,e.scope),s=e.getConfig(i);if(!s)return null;let{type:a,value:h,values:u,minValue:f,maxValue:g,stepValue:y}=s,w=s.default.evaluate(e),E=w;if(h){let I=e.scope;e.scope=(I||"").split("").slice(1).join(""),E=h.evaluate(e),e.scope=I}return a&&(E=Id(a,E)),E===void 0||f===void 0&&g===void 0&&y===void 0||(typeof E=="number"?E=Wf(E,f,g,y):Array.isArray(E)&&(E=E.map(I=>typeof I=="number"?Wf(I,f,g,y):I))),h!==void 0&&E!==void 0&&u&&!u.includes(E)&&(E=w,a&&(E=Id(a,E))),(a&&a!==this.type||E!==void 0&&!Lh(bt(E),this.type))&&(E=Id(this.type.kind,E)),E}eachChild(){}outputDefined(){return!1}serialize(){let e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Hh{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");let s=e[1];return i.scope.has(s)?new Hh(s,i.scope.get(s)):i.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class $h{constructor(e,i=[],s,a=new md,h=[],u,f){this.registry=e,this.path=i,this.key=i.map(g=>typeof g=="string"?`['${g}']`:`[${g}]`).join(""),this.scope=a,this.errors=h,this.expectedType=s,this._scope=u,this.options=f}parse(e,i,s,a,h={}){return i||s?this.concat(i,null,s,a)._parse(e,h):this._parse(e,h)}parseObjectValue(e,i,s,a,h,u={}){return this.concat(i,s,a,h)._parse(e,u)}_parse(e,i){function s(a,h,u){return u==="assert"?new Nt(h,[a]):u==="coerce"?new Oo(h,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let a=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(a){let h=a.parse(e,this);if(!h)return null;if(this.expectedType){let u=this.expectedType,f=h.type;if(u.kind!=="string"&&u.kind!=="number"&&u.kind!=="boolean"&&u.kind!=="object"&&u.kind!=="array"||f.kind!=="value")if(u.kind!=="color"&&u.kind!=="formatted"&&u.kind!=="resolvedImage"||f.kind!=="value"&&f.kind!=="string"){if(this.checkSubtype(u,f))return null}else h=s(h,u,i.typeAnnotation||"coerce");else h=s(h,u,i.typeAnnotation||"assert")}if(!(h instanceof Gt)&&h.type.kind!=="resolvedImage"&&Ad(h)){let u=new Pc(this._scope,this.options);try{h=new Gt(h.type,h.evaluate(u))}catch(f){return this.error(f.message),null}}return h}return Oo.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,s,a){let h=typeof e=="number"?this.path.concat(e):this.path;h=typeof i=="string"?h.concat(i):h;let u=a?this.scope.concat(a):this.scope;return new $h(this.registry,h,s||null,u,this.errors,this._scope,this.options)}error(e,...i){let s=`${this.key}${i.map(a=>`[${a}]`).join("")}`;this.errors.push(new _o(s,e))}checkSubtype(e,i){let s=al(e,i);return s&&this.error(s),s}}function Ad(r){if(r instanceof Hh)return Ad(r.boundExpression);if(r instanceof cn&&r.name==="error"||r instanceof ss||r instanceof Xs||r instanceof Pa||r instanceof _l)return!1;let e=r instanceof Oo||r instanceof Nt,i=!0;return r.eachChild(s=>{i=e?i&&Ad(s):i&&s instanceof Gt}),!!i&&fl(r)&&ml(r,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Zh(r,e){let i=r.length-1,s,a,h=0,u=i,f=0;for(;h<=u;)if(f=Math.floor((h+u)/2),s=r[f],a=r[f+1],s<=e){if(f===i||e<a)return f;h=f+1}else{if(!(s>e))throw new Ur("Input is not a number.");u=f-1}return 0}class Oc{constructor(e,i,s){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(let[a,h]of s)this.labels.push(a),this.outputs.push(h)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");let s=i.parse(e[1],1,Dt);if(!s)return null;let a=[],h=null;i.expectedType&&i.expectedType.kind!=="value"&&(h=i.expectedType);for(let u=1;u<e.length;u+=2){let f=u===1?-1/0:e[u],g=e[u+1],y=u,w=u+1;if(typeof f!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',y);if(a.length&&a[a.length-1][0]>=f)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',y);let E=i.parse(g,w,h);if(!E)return null;h=h||E.type,a.push([f,E])}return new Oc(h,s,a)}evaluate(e){let i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);let a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);let h=i.length;return a>=i[h-1]?s[h-1].evaluate(e):s[Zh(i,a)].evaluate(e)}eachChild(e){e(this.input);for(let i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}let Xf=.95047,Yf=1.08883,Kf=4/29,gl=6/29,Jf=3*gl*gl,Md=gl*gl*gl,Eg=Math.PI/180,Qf=180/Math.PI;function Cd(r){return r>Md?Math.pow(r,1/3):r/Jf+Kf}function Pd(r){return r>gl?r*r*r:Jf*(r-Kf)}function Rd(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function Wh(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function Ld(r){let e=Wh(r.r),i=Wh(r.g),s=Wh(r.b),a=Cd((.4124564*e+.3575761*i+.1804375*s)/Xf),h=Cd((.2126729*e+.7151522*i+.072175*s)/1);return{l:116*h-16,a:500*(a-h),b:200*(h-Cd((.0193339*e+.119192*i+.9503041*s)/Yf)),alpha:r.a}}function Ra(r){let e=(r.l+16)/116,i=isNaN(r.a)?e:e+r.a/500,s=isNaN(r.b)?e:e-r.b/200;return e=1*Pd(e),i=Xf*Pd(i),s=Yf*Pd(s),new ki(Rd(3.2404542*i-1.5371385*e-.4985314*s),Rd(-.969266*i+1.8760108*e+.041556*s),Rd(.0556434*i-.2040259*e+1.0572252*s),r.alpha)}function em(r,e,i){let s=e-r;return r+i*(s>180||s<-180?s-360*Math.round(s/360):s)}let yl={forward:Ld,reverse:Ra,interpolate:function(r,e,i){return{l:Bt(r.l,e.l,i),a:Bt(r.a,e.a,i),b:Bt(r.b,e.b,i),alpha:Bt(r.alpha,e.alpha,i)}}},kc={forward:function(r){let{l:e,a:i,b:s}=Ld(r),a=Math.atan2(s,i)*Qf;return{h:a<0?a+360:a,c:Math.sqrt(i*i+s*s),l:e,alpha:r.a}},reverse:function(r){let e=r.h*Eg,i=r.c;return Ra({l:r.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:r.alpha})},interpolate:function(r,e,i){return{h:em(r.h,e.h,i),c:Bt(r.c,e.c,i),l:Bt(r.l,e.l,i),alpha:Bt(r.alpha,e.alpha,i)}}};var Xh=Object.freeze({__proto__:null,hcl:kc,lab:yl});class qn{constructor(e,i,s,a,h){this.type=e,this.operator=i,this.interpolation=s,this.input=a,this.labels=[],this.outputs=[];for(let[u,f]of h)this.labels.push(u),this.outputs.push(f)}static interpolationFactor(e,i,s,a){let h=0;if(e.name==="exponential")h=zd(i,e.base,s,a);else if(e.name==="linear")h=zd(i,1,s,a);else if(e.name==="cubic-bezier"){let u=e.controlPoints;h=new Qa(u[0],u[1],u[2],u[3]).solve(zd(i,1,s,a))}return h}static parse(e,i){let[s,a,h,...u]=e;if(!Array.isArray(a)||a.length===0)return i.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){let y=a[1];if(typeof y!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:y}}else{if(a[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(a[0])}`,1,0);{let y=a.slice(1);if(y.length!==4||y.some(w=>typeof w!="number"||w<0||w>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:y}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(h=i.parse(h,2,Dt),!h)return null;let f=[],g=null;s==="interpolate-hcl"||s==="interpolate-lab"?g=Jn:i.expectedType&&i.expectedType.kind!=="value"&&(g=i.expectedType);for(let y=0;y<u.length;y+=2){let w=u[y],E=u[y+1],I=y+3,R=y+4;if(typeof w!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',I);if(f.length&&f[f.length-1][0]>=w)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',I);let L=i.parse(E,R,g);if(!L)return null;g=g||L.type,f.push([w,L])}return g.kind==="number"||g.kind==="color"||g.kind==="array"&&g.itemType.kind==="number"&&typeof g.N=="number"?new qn(g,s,a,h,f):i.error(`Type ${Zr(g)} is not interpolatable.`)}evaluate(e){let i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);let a=this.input.evaluate(e);if(a<=i[0])return s[0].evaluate(e);let h=i.length;if(a>=i[h-1])return s[h-1].evaluate(e);let u=Zh(i,a),f=qn.interpolationFactor(this.interpolation,a,i[u],i[u+1]),g=s[u].evaluate(e),y=s[u+1].evaluate(e);return this.operator==="interpolate"?Sc[this.type.kind.toLowerCase()](g,y,f):this.operator==="interpolate-hcl"?kc.reverse(kc.interpolate(kc.forward(g),kc.forward(y),f)):yl.reverse(yl.interpolate(yl.forward(g),yl.forward(y),f))}eachChild(e){e(this.input);for(let i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];let i=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)i.push(this.labels[s],this.outputs[s].serialize());return i}}function zd(r,e,i,s){let a=s-i,h=r-i;return a===0?0:e===1?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1)}class Yh{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let s=null,a=i.expectedType;a&&a.kind!=="value"&&(s=a);let h=[];for(let f of e.slice(1)){let g=i.parse(f,1+h.length,s,void 0,{typeAnnotation:"omit"});if(!g)return null;s=s||g.type,h.push(g)}let u=a&&h.some(f=>al(a,f.type));return new Yh(u?Fi:s,h)}evaluate(e){let i,s=null,a=0;for(let h of this.args){if(a++,s=h.evaluate(e),s&&s instanceof Gn&&!s.available&&(i||(i=s),s=null,a===this.args.length))return i;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Fc{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(let i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);let s=[];for(let h=1;h<e.length-1;h+=2){let u=e[h];if(typeof u!="string")return i.error(`Expected string, but found ${typeof u} instead.`,h);if(/[^a-zA-Z0-9_]/.test(u))return i.error("Variable names must contain only alphanumeric characters or '_'.",h);let f=i.parse(e[h+1],h+1);if(!f)return null;s.push([u,f])}let a=i.parse(e[e.length-1],e.length-1,i.expectedType,s);return a?new Fc(s,a):null}outputDefined(){return this.result.outputDefined()}serialize(){let e=["let"];for(let[i,s]of this.bindings)e.push(i,s.serialize());return e.push(this.result.serialize()),e}}class Kh{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Dt),a=i.parse(e[2],2,In(i.expectedType||Fi));return s&&a?new Kh(a.type.itemType,s,a):null}evaluate(e){let i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Ur(`Array index out of bounds: ${i} < 0.`);if(i>=s.length)throw new Ur(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i!==Math.floor(i))throw new Ur(`Array index must be an integer, but found ${i} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return s[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Dd{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Dt),a=i.parse(e[2],2,In(i.expectedType||Fi));return s&&a?new Dd(a.type.itemType,s,a):null}evaluate(e){let i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Ur(`Array index out of bounds: ${i} < 0.`);if(i>s.length-1)throw new Ur(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i===Math.floor(i))return s[i];let a=Math.floor(i),h=Math.ceil(i),u=s[a],f=s[h];if(typeof u!="number"||typeof f!="number")throw new Ur(`Cannot interpolate between non-number values at index ${i}.`);let g=i-a;return u*(1-g)+f*g}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Od{constructor(e,i){this.type=Di,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Fi),a=i.parse(e[2],2,Fi);return s&&a?qs(s.type,[Di,zi,Dt,sl,Fi])?new Od(s,a):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${Zr(s.type)} instead`):null}evaluate(e){let i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!Ac(i,["boolean","string","number","null"]))throw new Ur(`Expected first argument to be of type boolean, string, number or null, but found ${Zr(bt(i))} instead.`);if(!Ac(s,["string","array"]))throw new Ur(`Expected second argument to be of type array or string, but found ${Zr(bt(s))} instead.`);return s.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Jh{constructor(e,i,s){this.type=Dt,this.needle=e,this.haystack=i,this.fromIndex=s}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Fi),a=i.parse(e[2],2,Fi);if(!s||!a)return null;if(!qs(s.type,[Di,zi,Dt,sl,Fi]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${Zr(s.type)} instead`);if(e.length===4){let h=i.parse(e[3],3,Dt);return h?new Jh(s,a,h):null}return new Jh(s,a)}evaluate(e){let i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Ac(i,["boolean","string","number","null"]))throw new Ur(`Expected first argument to be of type boolean, string, number or null, but found ${Zr(bt(i))} instead.`);if(!Ac(s,["string","array"]))throw new Ur(`Expected second argument to be of type array or string, but found ${Zr(bt(s))} instead.`);if(this.fromIndex){let a=this.fromIndex.evaluate(e);return s.indexOf(i,a)}return s.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){let e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Qh{constructor(e,i,s,a,h,u){this.inputType=e,this.type=i,this.input=s,this.cases=a,this.outputs=h,this.otherwise=u}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let s,a;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);let h={},u=[];for(let y=2;y<e.length-1;y+=2){let w=e[y],E=e[y+1];Array.isArray(w)||(w=[w]);let I=i.concat(y);if(w.length===0)return I.error("Expected at least one branch label.");for(let L of w){if(typeof L!="number"&&typeof L!="string")return I.error("Branch labels must be numbers or strings.");if(typeof L=="number"&&Math.abs(L)>Number.MAX_SAFE_INTEGER)return I.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof L=="number"&&Math.floor(L)!==L)return I.error("Numeric branch labels must be integer values.");if(s){if(I.checkSubtype(s,bt(L)))return null}else s=bt(L);if(h[String(L)]!==void 0)return I.error("Branch labels must be unique.");h[String(L)]=u.length}let R=i.parse(E,y,a);if(!R)return null;a=a||R.type,u.push(R)}let f=i.parse(e[1],1,Fi);if(!f)return null;let g=i.parse(e[e.length-1],e.length-1,a);return g?f.type.kind!=="value"&&i.concat(1).checkSubtype(s,f.type)?null:new Qh(s,a,f,h,u,g):null}evaluate(e){let i=this.input.evaluate(e);return(Lh(bt(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),s=[],a={};for(let u of i){let f=a[this.cases[u]];f===void 0?(a[this.cases[u]]=s.length,s.push([this.cases[u],[u]])):s[f][1].push(u)}let h=u=>this.inputType.kind==="number"?Number(u):u;for(let[u,f]of s)e.push(f.length===1?h(f[0]):f.map(h)),e.push(this.outputs[u].serialize());return e.push(this.otherwise.serialize()),e}}class eu{constructor(e,i,s){this.type=e,this.branches=i,this.otherwise=s}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let s;i.expectedType&&i.expectedType.kind!=="value"&&(s=i.expectedType);let a=[];for(let u=1;u<e.length-1;u+=2){let f=i.parse(e[u],u,Di);if(!f)return null;let g=i.parse(e[u+1],u+1,s);if(!g)return null;a.push([f,g]),s=s||g.type}let h=i.parse(e[e.length-1],e.length-1,s);return h?new eu(s,a,h):null}evaluate(e){for(let[i,s]of this.branches)if(i.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(let[i,s]of this.branches)e(i),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class La{constructor(e,i,s,a){this.type=e,this.input=i,this.beginIndex=s,this.endIndex=a}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,Fi),a=i.parse(e[2],2,Dt);if(!s||!a)return null;if(!qs(s.type,[In(Fi),zi,Fi]))return i.error(`Expected first argument to be of type array or string, but found ${Zr(s.type)} instead`);if(e.length===4){let h=i.parse(e[3],3,Dt);return h?new La(s.type,s,a,h):null}return new La(s.type,s,a)}evaluate(e){let i=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Ac(i,["string","array"]))throw new Ur(`Expected first argument to be of type array or string, but found ${Zr(bt(i))} instead.`);if(this.endIndex){let a=this.endIndex.evaluate(e);return i.slice(s,a)}return i.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){let e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class kd{constructor(e,i){this.type=In(zi),this.str=e,this.delimiter=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let s=i.parse(e[1],1,zi),a=i.parse(e[2],2,zi);return s&&a?new kd(s,a):void 0}evaluate(e){let i=this.str.evaluate(e),s=this.delimiter.evaluate(e);return i.split(s)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function Fd(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function tm(r,e,i,s){return s.compare(e,i)===0}function xl(r,e,i){let s=r!=="=="&&r!=="!=";return class QT{constructor(h,u,f){this.type=Di,this.lhs=h,this.rhs=u,this.collator=f,this.hasUntypedArgument=h.type.kind==="value"||u.type.kind==="value"}static parse(h,u){if(h.length!==3&&h.length!==4)return u.error("Expected two or three arguments.");let f=h[0],g=u.parse(h[1],1,Fi);if(!g)return null;if(!Fd(f,g.type))return u.concat(1).error(`"${f}" comparisons are not supported for type '${Zr(g.type)}'.`);let y=u.parse(h[2],2,Fi);if(!y)return null;if(!Fd(f,y.type))return u.concat(2).error(`"${f}" comparisons are not supported for type '${Zr(y.type)}'.`);if(g.type.kind!==y.type.kind&&g.type.kind!=="value"&&y.type.kind!=="value")return u.error(`Cannot compare types '${Zr(g.type)}' and '${Zr(y.type)}'.`);s&&(g.type.kind==="value"&&y.type.kind!=="value"?g=new Nt(y.type,[g]):g.type.kind!=="value"&&y.type.kind==="value"&&(y=new Nt(g.type,[y])));let w=null;if(h.length===4){if(g.type.kind!=="string"&&y.type.kind!=="string"&&g.type.kind!=="value"&&y.type.kind!=="value")return u.error("Cannot use collator to compare non-string types.");if(w=u.parse(h[3],3,Rh),!w)return null}return new QT(g,y,w)}evaluate(h){let u=this.lhs.evaluate(h),f=this.rhs.evaluate(h);if(s&&this.hasUntypedArgument){let g=bt(u),y=bt(f);if(g.kind!==y.kind||g.kind!=="string"&&g.kind!=="number")throw new Ur(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${g.kind}, ${y.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){let g=bt(u),y=bt(f);if(g.kind!=="string"||y.kind!=="string")return e(h,u,f)}return this.collator?i(h,u,f,this.collator.evaluate(h)):e(h,u,f)}eachChild(h){h(this.lhs),h(this.rhs),this.collator&&h(this.collator)}outputDefined(){return!0}serialize(){let h=[r];return this.eachChild(u=>{h.push(u.serialize())}),h}}}let im=xl("==",function(r,e,i){return e===i},tm),rm=xl("!=",function(r,e,i){return e!==i},function(r,e,i,s){return!tm(0,e,i,s)}),Ig=xl("<",function(r,e,i){return e<i},function(r,e,i,s){return s.compare(e,i)<0}),Ag=xl(">",function(r,e,i){return e>i},function(r,e,i,s){return s.compare(e,i)>0}),Mg=xl("<=",function(r,e,i){return e<=i},function(r,e,i,s){return s.compare(e,i)<=0}),tu=xl(">=",function(r,e,i){return e>=i},function(r,e,i,s){return s.compare(e,i)>=0});class Bd{constructor(e,i,s,a,h,u){this.type=zi,this.number=e,this.locale=i,this.currency=s,this.unit=a,this.minFractionDigits=h,this.maxFractionDigits=u}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");let s=i.parse(e[1],1,Dt);if(!s)return null;let a=e[2];if(typeof a!="object"||Array.isArray(a))return i.error("NumberFormat options argument must be an object.");let h=null;if(a.locale&&(h=i.parseObjectValue(a.locale,2,"locale",zi),!h))return null;let u=null;if(a.currency&&(u=i.parseObjectValue(a.currency,2,"currency",zi),!u))return null;let f=null;if(a.unit&&(f=i.parseObjectValue(a.unit,2,"unit",zi),!f))return null;let g=null;if(a["min-fraction-digits"]&&(g=i.parseObjectValue(a["min-fraction-digits"],2,"min-fraction-digits",Dt),!g))return null;let y=null;return a["max-fraction-digits"]&&(y=i.parseObjectValue(a["max-fraction-digits"],2,"max-fraction-digits",Dt),!y)?null:new Bd(s,h,u,f,g,y)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Nd{constructor(e){this.type=Dt,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);let s=i.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${Zr(s.type)} instead.`):new Nd(s):null}evaluate(e){let i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new Ur(`Expected value to be of type string or array, but found ${Zr(bt(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){let e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function nm(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let vl={"==":im,"!=":rm,">":Ag,"<":Ig,">=":tu,"<=":Mg,array:Nt,at:Kh,"at-interpolated":Dd,boolean:Nt,case:eu,coalesce:Yh,collator:ss,format:ll,image:cl,in:Od,"index-of":Jh,interpolate:qn,"interpolate-hcl":qn,"interpolate-lab":qn,length:Nd,let:Fc,literal:Gt,match:Qh,number:Nt,"number-format":Bd,object:Nt,slice:La,step:Oc,string:Nt,"to-boolean":Oo,"to-color":Oo,"to-number":Oo,"to-string":Oo,var:Hh,within:Xs,distance:Pa,config:_l,split:kd};function Vd(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);let h=a?a.evaluate(r):1,u=Aa(e,i,s,h);if(u)throw new Ur(u);return new ki(e/255,i/255,s/255,h)}function om(r,[e,i,s,a]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);let h=a?a.evaluate(r):1,u=function(y,w,E,I){return typeof y=="number"&&y>=0&&y<=360?typeof w=="number"&&w>=0&&w<=100&&typeof E=="number"&&E>=0&&E<=100?I===void 0||typeof I=="number"&&I>=0&&I<=1?null:`Invalid hsla value [${[y,w,E,I].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof I=="number"?[y,w,E,I]:[y,w,E]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof I=="number"?[y,w,E,I]:[y,w,E]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,s,h);if(u)throw new Ur(u);let f=`hsla(${e}, ${i}%, ${s}%, ${h})`,g=ki.parse(f);if(!g)throw new Ur(`Failed to parse HSLA color: ${f}`);return g}function sm(r,e){return r in e}function iu(r,e){let i=e[r];return i===void 0?null:i}function Ks(r){return{type:r}}function Ud(r){return{result:"success",value:r}}function Js(r){return{result:"error",value:r}}function Qs(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function ru(r){return r["property-type"]==="data-driven"}function am(r){return Qs(r.expression,"measure-light")}function lm(r){return Qs(r.expression,"zoom")}function nu(r){return!!r.expression&&r.expression.interpolated}function ou(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function cm(r){return r}function jd(r,e){let i=e.type==="color",s=r.stops&&typeof r.stops[0][0]=="object",a=s||!(s||r.property!==void 0),h=r.type||(nu(e)?"exponential":"interval");if(i&&((r=Ia({},r)).stops&&(r.stops=r.stops.map(y=>[y[0],ki.parse(y[1])])),r.default=ki.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!Xh[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let u,f,g;if(h==="exponential")u=um;else if(h==="interval")u=hm;else if(h==="categorical"){u=Gd,f=Object.create(null);for(let y of r.stops)f[y[0]]=y[1];g=typeof r.stops[0][0]}else{if(h!=="identity")throw new Error(`Unknown function type "${h}"`);u=ea}if(s){let y={},w=[];for(let R=0;R<r.stops.length;R++){let L=r.stops[R],k=L[0].zoom;y[k]===void 0&&(y[k]={zoom:k,type:r.type,property:r.property,default:r.default,stops:[]},w.push(k)),y[k].stops.push([L[0].value,L[1]])}let E=[];for(let R of w)E.push([y[R].zoom,jd(y[R],e)]);let I={name:"linear"};return{kind:"composite",interpolationType:I,interpolationFactor:qn.interpolationFactor.bind(void 0,I),zoomStops:E.map(R=>R[0]),evaluate:({zoom:R},L)=>um({stops:E,base:r.base},e,R).evaluate(R,L)}}if(a){let y=h==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:y,interpolationFactor:qn.interpolationFactor.bind(void 0,y),zoomStops:r.stops.map(w=>w[0]),evaluate:({zoom:w})=>u(r,e,w,f,g)}}return{kind:"source",evaluate(y,w){let E=w&&w.properties?w.properties[r.property]:void 0;return E===void 0?za(r.default,e.default):u(r,e,E,f,g)}}}function za(r,e,i){return r!==void 0?r:e!==void 0?e:i!==void 0?i:void 0}function Gd(r,e,i,s,a){return za(typeof i===a?s[i]:void 0,r.default,e.default)}function hm(r,e,i){if(Hs(i)!=="number")return za(r.default,e.default);let s=r.stops.length;if(s===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[s-1][0])return r.stops[s-1][1];let a=Zh(r.stops.map(h=>h[0]),i);return r.stops[a][1]}function um(r,e,i){let s=r.base!==void 0?r.base:1;if(Hs(i)!=="number")return za(r.default,e.default);let a=r.stops.length;if(a===1||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[a-1][0])return r.stops[a-1][1];let h=Zh(r.stops.map(w=>w[0]),i),u=function(w,E,I,R){let L=R-I,k=w-I;return L===0?0:E===1?k/L:(Math.pow(E,k)-1)/(Math.pow(E,L)-1)}(i,s,r.stops[h][0],r.stops[h+1][0]),f=r.stops[h][1],g=r.stops[h+1][1],y=Sc[e.type]||cm;if(r.colorSpace&&r.colorSpace!=="rgb"){let w=Xh[r.colorSpace];y=(E,I)=>w.reverse(w.interpolate(w.forward(E),w.forward(I),u))}return typeof f.evaluate=="function"?{evaluate(...w){let E=f.evaluate.apply(void 0,w),I=g.evaluate.apply(void 0,w);if(E!==void 0&&I!==void 0)return y(E,I,u)}}:y(f,g,u)}function ea(r,e,i){return e.type==="color"?i=ki.parse(i):e.type==="formatted"?i=Ln.fromString(i.toString()):e.type==="resolvedImage"?i=Gn.build(i.toString()):Hs(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),za(i,r.default,e.default)}cn.register(vl,{error:[{kind:"error"},[zi],(r,[e])=>{throw new Ur(e.evaluate(r))}],typeof:[zi,[Fi],(r,[e])=>Zr(bt(e.evaluate(r)))],"to-rgba":[In(Dt,4),[Jn],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[In(Dt,4),[Jn],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Jn,[Dt,Dt,Dt],Vd],rgba:[Jn,[Dt,Dt,Dt,Dt],Vd],hsl:[Jn,[Dt,Dt,Dt],om],hsla:[Jn,[Dt,Dt,Dt,Dt],om],has:{type:Di,overloads:[[[zi],(r,[e])=>sm(e.evaluate(r),r.properties())],[[zi,Ms],(r,[e,i])=>sm(e.evaluate(r),i.evaluate(r))]]},get:{type:Fi,overloads:[[[zi],(r,[e])=>iu(e.evaluate(r),r.properties())],[[zi,Ms],(r,[e,i])=>iu(e.evaluate(r),i.evaluate(r))]]},"feature-state":[Fi,[zi],(r,[e])=>iu(e.evaluate(r),r.featureState||{})],properties:[Ms,[],r=>r.properties()],"geometry-type":[zi,[],r=>r.geometryType()],worldview:[zi,[],r=>r.globals.worldview||""],id:[Fi,[],r=>r.id()],zoom:[Dt,[],r=>r.globals.zoom],pitch:[Dt,[],r=>r.globals.pitch||0],"distance-from-center":[Dt,[],r=>r.distanceFromCenter()],"measure-light":[Dt,[zi],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[Dt,[],r=>r.globals.heatmapDensity||0],"line-progress":[Dt,[],r=>r.globals.lineProgress||0],"raster-value":[Dt,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[Dt,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[Dt,[],r=>r.globals.skyRadialProgress||0],accumulated:[Fi,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[Dt,Ks(Dt),(r,e)=>{let i=0;for(let s of e)i+=s.evaluate(r);return i}],"*":[Dt,Ks(Dt),(r,e)=>{let i=1;for(let s of e)i*=s.evaluate(r);return i}],"-":{type:Dt,overloads:[[[Dt,Dt],(r,[e,i])=>e.evaluate(r)-i.evaluate(r)],[[Dt],(r,[e])=>-e.evaluate(r)]]},"/":[Dt,[Dt,Dt],(r,[e,i])=>e.evaluate(r)/i.evaluate(r)],"%":[Dt,[Dt,Dt],(r,[e,i])=>e.evaluate(r)%i.evaluate(r)],ln2:[Dt,[],()=>Math.LN2],pi:[Dt,[],()=>Math.PI],e:[Dt,[],()=>Math.E],"^":[Dt,[Dt,Dt],(r,[e,i])=>Math.pow(e.evaluate(r),i.evaluate(r))],sqrt:[Dt,[Dt],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[Dt,[Dt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[Dt,[Dt],(r,[e])=>Math.log(e.evaluate(r))],log2:[Dt,[Dt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN2],sin:[Dt,[Dt],(r,[e])=>Math.sin(e.evaluate(r))],cos:[Dt,[Dt],(r,[e])=>Math.cos(e.evaluate(r))],tan:[Dt,[Dt],(r,[e])=>Math.tan(e.evaluate(r))],asin:[Dt,[Dt],(r,[e])=>Math.asin(e.evaluate(r))],acos:[Dt,[Dt],(r,[e])=>Math.acos(e.evaluate(r))],atan:[Dt,[Dt],(r,[e])=>Math.atan(e.evaluate(r))],min:[Dt,Ks(Dt),(r,e)=>Math.min(...e.map(i=>i.evaluate(r)))],max:[Dt,Ks(Dt),(r,e)=>Math.max(...e.map(i=>i.evaluate(r)))],abs:[Dt,[Dt],(r,[e])=>Math.abs(e.evaluate(r))],round:[Dt,[Dt],(r,[e])=>{let i=e.evaluate(r);return i<0?-Math.round(-i):Math.round(i)}],floor:[Dt,[Dt],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[Dt,[Dt],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[Di,[zi,Fi],(r,[e,i])=>r.properties()[e.value]===i.value],"filter-id-==":[Di,[Fi],(r,[e])=>r.id()===e.value],"filter-type-==":[Di,[zi],(r,[e])=>r.geometryType()===e.value],"filter-<":[Di,[zi,Fi],(r,[e,i])=>{let s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<a}],"filter-id-<":[Di,[Fi],(r,[e])=>{let i=r.id(),s=e.value;return typeof i==typeof s&&i<s}],"filter->":[Di,[zi,Fi],(r,[e,i])=>{let s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>a}],"filter-id->":[Di,[Fi],(r,[e])=>{let i=r.id(),s=e.value;return typeof i==typeof s&&i>s}],"filter-<=":[Di,[zi,Fi],(r,[e,i])=>{let s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s<=a}],"filter-id-<=":[Di,[Fi],(r,[e])=>{let i=r.id(),s=e.value;return typeof i==typeof s&&i<=s}],"filter->=":[Di,[zi,Fi],(r,[e,i])=>{let s=r.properties()[e.value],a=i.value;return typeof s==typeof a&&s>=a}],"filter-id->=":[Di,[Fi],(r,[e])=>{let i=r.id(),s=e.value;return typeof i==typeof s&&i>=s}],"filter-has":[Di,[Fi],(r,[e])=>e.value in r.properties()],"filter-has-id":[Di,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[Di,[In(zi)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[Di,[In(Fi)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[Di,[zi,In(Fi)],(r,[e,i])=>i.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[Di,[zi,In(Fi)],(r,[e,i])=>function(s,a,h,u){for(;h<=u;){let f=h+u>>1;if(a[f]===s)return!0;a[f]>s?u=f-1:h=f+1}return!1}(r.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Di,overloads:[[[Di,Di],(r,[e,i])=>e.evaluate(r)&&i.evaluate(r)],[Ks(Di),(r,e)=>{for(let i of e)if(!i.evaluate(r))return!1;return!0}]]},any:{type:Di,overloads:[[[Di,Di],(r,[e,i])=>e.evaluate(r)||i.evaluate(r)],[Ks(Di),(r,e)=>{for(let i of e)if(i.evaluate(r))return!0;return!1}]]},"!":[Di,[Di],(r,[e])=>!e.evaluate(r)],"is-supported-script":[Di,[zi],(r,[e])=>{let i=r.globals&&r.globals.isSupportedScript;return!i||i(e.evaluate(r))}],upcase:[zi,[zi],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[zi,[zi],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[zi,Ks(Fi),(r,e)=>e.map(i=>Do(i.evaluate(r))).join("")],"resolved-locale":[zi,[Rh],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[Dt,[Dt,Dt,Fi],(r,e)=>{let[i,s,a]=e.map(u=>u.evaluate(r));if(i>s||i===s)return i;let h;if(typeof a=="string")h=function(u){let f=0;if(u.length===0)return f;for(let g=0;g<u.length;g++)f=(f<<5)-f+u.charCodeAt(g),f|=0;return f}(a);else{if(typeof a!="number")throw new Ur(`Invalid seed input: ${a}`);h=a}return i+nm(h)()*(s-i)}]});class qd{constructor(e,i,s,a){this.expression=e,this._warningHistory={},this._evaluator=new Pc(s,a),this._defaultValue=i?function(h){return h.type==="color"&&(ou(h.default)||Array.isArray(h.default))?new ki(0,0,0,0):h.type==="color"?ki.parse(h.default)||null:h.default===void 0?null:h.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=qh(e)}evaluateWithoutErrorHandling(e,i,s,a,h,u,f,g){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=s,this._evaluator.canonical=a||null,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=u,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=g||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,s,a,h,u,f,g){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=s||null,this._evaluator.canonical=a||null,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=u||null,this._evaluator.featureTileCoord=f||null,this._evaluator.featureDistanceData=g||null;try{let y=this.expression.evaluate(this._evaluator);if(y==null||typeof y=="number"&&y!=y)return this._defaultValue;if(this._enumValues&&!(y in this._enumValues))throw new Ur(`Expected value to be one of ${Object.keys(this._enumValues).map(w=>JSON.stringify(w)).join(", ")}, but found ${JSON.stringify(y)} instead.`);return y}catch(y){return this._warningHistory[y.message]||(this._warningHistory[y.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${y.message}`)),this._defaultValue}}}function Hd(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in vl}function Da(r,e,i,s){let a=new $h(vl,[],e?function(u){let f={color:Jn,string:zi,number:Dt,enum:zi,boolean:Di,formatted:Ec,resolvedImage:Ic};return u.type==="array"?In(f[u.value]||Fi,u.length):f[u.type]}(e):void 0,void 0,void 0,i,s),h=a.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return h?Ud(new qd(h,e,i,s)):Js(a.errors)}class su{constructor(e,i,s,a){this.kind=e,this._styleExpression=i,this.isLightConstant=s,this.isLineProgressConstant=a,this.isStateDependent=e!=="constant"&&!Gh(i.expression),this.configDependencies=qh(i.expression)}evaluateWithoutErrorHandling(e,i,s,a,h,u){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,h,u)}evaluate(e,i,s,a,h,u){return this._styleExpression.evaluate(e,i,s,a,h,u)}}class ta{constructor(e,i,s,a,h,u){this.kind=e,this.zoomStops=s,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!Gh(i.expression),this.isLightConstant=h,this.isLineProgressConstant=u,this.configDependencies=qh(i.expression),this.interpolationType=a}evaluateWithoutErrorHandling(e,i,s,a,h,u){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,a,h,u)}evaluate(e,i,s,a,h,u){return this._styleExpression.evaluate(e,i,s,a,h,u)}interpolationFactor(e,i,s){return this.interpolationType?qn.interpolationFactor(this.interpolationType,e,i,s):0}}function $d(r,e,i,s){if((r=Da(r,e,i,s)).result==="error")return r;let a=r.value.expression,h=fl(a);if(!h&&!ru(e))return Js([new _o("","data expressions not supported")]);let u=ml(a,["zoom","pitch","distance-from-center"]);if(!u&&!lm(e))return Js([new _o("","zoom expressions not supported")]);let f=ml(a,["measure-light"]);if(!f&&!am(e))return Js([new _o("","measure-light expression not supported")]);let g=ml(a,["line-progress"]);if(!g&&!function(E){return Qs(E.expression,"line-progress")}(e))return Js([new _o("","line-progress expression not supported")]);let y=e.expression&&e.expression.relaxZoomRestriction,w=Bc(a);return w||u||y?w instanceof _o?Js([w]):w instanceof qn&&!nu(e)?Js([new _o("",'"interpolate" expressions cannot be used with this property')]):Ud(w?new ta(h&&g?"camera":"composite",r.value,w.labels,w instanceof qn?w.interpolation:void 0,f,g):new su(h&&g?"constant":"source",r.value,f,g)):Js([new _o("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Oa{constructor(e,i){this._parameters=e,this._specification=i,Ia(this,jd(this._parameters,this._specification))}static deserialize(e){return new Oa(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Bc(r){let e=null;if(r instanceof Fc)e=Bc(r.result);else if(r instanceof Yh){for(let i of r.args)if(e=Bc(i),e)break}else(r instanceof Oc||r instanceof qn)&&r.input instanceof cn&&r.input.name==="zoom"&&(e=r);return e instanceof _o||r.eachChild(i=>{let s=Bc(i);s instanceof _o?e=s:e&&s&&e!==s&&(e=new _o("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Zd,dm,Wd=function(){if(dm)return Zd;dm=1,Zd=e;var r=3;function e(i,s,a){var h=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var u=new Int32Array(this.arrayBuffer);i=u[0],this.d=(s=u[1])+2*(a=u[2]);for(var f=0;f<this.d*this.d;f++){var g=u[r+f],y=u[r+f+1];h.push(g===y?null:u.subarray(g,y))}var w=u[r+h.length+1];this.keys=u.subarray(u[r+h.length],w),this.bboxes=u.subarray(w),this.insert=this._insertReadonly}else{this.d=s+2*a;for(var E=0;E<this.d*this.d;E++)h.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=i,this.padding=a,this.scale=s/i,this.uid=0;var I=a/s*i;this.min=-I,this.max=i+I}return e.prototype.insert=function(i,s,a,h,u){this._forEachCell(s,a,h,u,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(s),this.bboxes.push(a),this.bboxes.push(h),this.bboxes.push(u)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,s,a,h,u,f){this.cells[u].push(f)},e.prototype.query=function(i,s,a,h,u){var f=this.min,g=this.max;if(i<=f&&s<=f&&g<=a&&g<=h&&!u)return Array.prototype.slice.call(this.keys);var y=[];return this._forEachCell(i,s,a,h,this._queryCell,y,{},u),y},e.prototype._queryCell=function(i,s,a,h,u,f,g,y){var w=this.cells[u];if(w!==null)for(var E=this.keys,I=this.bboxes,R=0;R<w.length;R++){var L=w[R];if(g[L]===void 0){var k=4*L;(y?y(I[k+0],I[k+1],I[k+2],I[k+3]):i<=I[k+2]&&s<=I[k+3]&&a>=I[k+0]&&h>=I[k+1])?(g[L]=!0,f.push(E[L])):g[L]=!1}}},e.prototype._forEachCell=function(i,s,a,h,u,f,g,y){for(var w=this._convertToCellCoord(i),E=this._convertToCellCoord(s),I=this._convertToCellCoord(a),R=this._convertToCellCoord(h),L=w;L<=I;L++)for(var k=E;k<=R;k++){var B=this.d*k+L;if((!y||y(this._convertFromCellCoord(L),this._convertFromCellCoord(k),this._convertFromCellCoord(L+1),this._convertFromCellCoord(k+1)))&&u.call(this,i,s,a,h,B,f,g,y))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,s=r+this.cells.length+1+1,a=0,h=0;h<this.cells.length;h++)a+=this.cells[h].length;var u=new Int32Array(s+a+this.keys.length+this.bboxes.length);u[0]=this.extent,u[1]=this.n,u[2]=this.padding;for(var f=s,g=0;g<i.length;g++){var y=i[g];u[r+g]=f,u.set(y,f),f+=y.length}return u[r+i.length]=f,u.set(this.keys,f),u[r+i.length+1]=f+=this.keys.length,u.set(this.bboxes,f),f+=this.bboxes.length,u.buffer},Zd}(),ia=cc(Wd);let Nc={};function Tt(r,e,i={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),Nc[e]={klass:r,omit:i.omit||[]}}Tt(Object,"Object"),ia.serialize=function(r,e){let i=r.toArrayBuffer();return e&&e.add(i),{buffer:i}},ia.deserialize=function(r){return new ia(r.buffer)},Object.defineProperty(ia,"name",{value:"Grid"}),Tt(ia,"Grid"),delete Qe.prototype.constructor,typeof DOMMatrix<"u"&&Tt(DOMMatrix,"DOMMatrix"),Tt(ki,"Color"),Tt(Error,"Error"),Tt(Ln,"Formatted"),Tt(zh,"FormattedSection"),Tt(wi,"AJAXError"),Tt(Gn,"ResolvedImage"),Tt(Oa,"StylePropertyFunction"),Tt(qd,"StyleExpression",{omit:["_evaluator"]}),Tt(Kn,"ImageId"),Tt(Cs,"ImageVariant"),Tt(ta,"ZoomDependentExpression"),Tt(su,"ZoomConstantExpression"),Tt(cn,"CompoundExpression",{omit:["_evaluate"]});for(let r in vl)Nc[vl[r]._classRegistryKey]||Tt(vl[r],`Expression${r}`);function au(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function Vc(r){return self.ImageBitmap&&r instanceof ImageBitmap}function Ps(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(au(r)||Vc(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){let i=[];for(let s of r)i.push(Ps(s,e));return i}if(r instanceof Map){let i={$name:"Map",entries:[]};for(let[s,a]of r.entries())i.entries.push(Ps(s),Ps(a,e));return i}if(r instanceof Set){let i={$name:"Set"},s=0;for(let a of r.values())i[++s]=Ps(a);return i}if(r instanceof DOMMatrix){let i={$name:"DOMMatrix"},s=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(let a of s)i[a]=r[a];return i}if(typeof r=="bigint")return{$name:"BigInt",value:r.toString()};if(typeof r=="object"){let i=r.constructor,s=i._classRegistryKey;if(!s)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);let a=i.serialize?i.serialize(r,e):{};if(!i.serialize){for(let h in r)r.hasOwnProperty(h)&&(Nc[s].omit.indexOf(h)>=0||(a[h]=Ps(r[h],e)));r instanceof Error&&(a.message=r.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(a.$name=s),a}throw new Error("can't serialize object of type "+typeof r)}function Hn(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||au(r)||Vc(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(Hn);if(typeof r=="object"){let e=r.$name||"Object";if(e==="Map"){let a=r.entries||[],h=new Map;for(let u=0;u<a.length;u+=2)h.set(Hn(a[u]),Hn(a[u+1]));return h}if(e==="Set"){let a=new Set;for(let h of Object.keys(r))h!=="$name"&&a.add(Hn(r[h]));return a}if(e==="DOMMatrix"){let a;return a=r.is2D?[r.a,r.b,r.c,r.d,r.e,r.f]:[r.m11,r.m12,r.m13,r.m14,r.m21,r.m22,r.m23,r.m24,r.m31,r.m32,r.m33,r.m34,r.m41,r.m42,r.m43,r.m44],new DOMMatrix(a)}if(e==="BigInt")return BigInt(r.value);let{klass:i}=Nc[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(r);let s=Object.create(i.prototype);for(let a of Object.keys(r))a!=="$name"&&(s[a]=Hn(r[a]));return s}throw new Error("can't deserialize object of type "+typeof r)}let Ut={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function Xd(r){for(let e of r)if(lu(e.charCodeAt(0)))return!0;return!1}function Cg(r){for(let e of r)if(!Pg(e.charCodeAt(0)))return!1;return!0}function Pg(r){return!(Ut.Arabic(r)||Ut["Arabic Supplement"](r)||Ut["Arabic Extended-A"](r)||Ut["Arabic Presentation Forms-A"](r)||Ut["Arabic Presentation Forms-B"](r))}function lu(r){return!(r!==746&&r!==747&&(r<4352||!(Ut["Bopomofo Extended"](r)||Ut.Bopomofo(r)||Ut["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Ut["CJK Compatibility Ideographs"](r)||Ut["CJK Compatibility"](r)||Ut["CJK Radicals Supplement"](r)||Ut["CJK Strokes"](r)||!(!Ut["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Ut["CJK Unified Ideographs Extension A"](r)||Ut["CJK Unified Ideographs"](r)||Ut["Enclosed CJK Letters and Months"](r)||Ut["Hangul Compatibility Jamo"](r)||Ut["Hangul Jamo Extended-A"](r)||Ut["Hangul Jamo Extended-B"](r)||Ut["Hangul Jamo"](r)||Ut["Hangul Syllables"](r)||Ut.Hiragana(r)||Ut["Ideographic Description Characters"](r)||Ut.Kanbun(r)||Ut["Kangxi Radicals"](r)||Ut["Katakana Phonetic Extensions"](r)||Ut.Katakana(r)&&r!==12540||!(!Ut["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Ut["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Ut["Unified Canadian Aboriginal Syllabics"](r)||Ut["Unified Canadian Aboriginal Syllabics Extended"](r)||Ut["Vertical Forms"](r)||Ut["Yijing Hexagram Symbols"](r)||Ut["Yi Syllables"](r)||Ut["Yi Radicals"](r))))}function cu(r){return!(lu(r)||function(e){return!!(Ut["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Ut["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Ut["Letterlike Symbols"](e)||Ut["Number Forms"](e)||Ut["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Ut["Control Pictures"](e)&&e!==9251||Ut["Optical Character Recognition"](e)||Ut["Enclosed Alphanumerics"](e)||Ut["Geometric Shapes"](e)||Ut["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Ut["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Ut["CJK Symbols and Punctuation"](e)||Ut.Katakana(e)||Ut["Private Use Area"](e)||Ut["CJK Compatibility Forms"](e)||Ut["Small Form Variants"](e)||Ut["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(r))}function pm(r){return Ut.Arabic(r)||Ut["Arabic Supplement"](r)||Ut["Arabic Extended-A"](r)||Ut["Arabic Presentation Forms-A"](r)||Ut["Arabic Presentation Forms-B"](r)}function hu(r){return r>=1424&&r<=2303||Ut["Arabic Presentation Forms-A"](r)||Ut["Arabic Presentation Forms-B"](r)}function Rg(r,e){return!(!e&&hu(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Ut.Khmer(r))}function Lg(r){for(let e of r)if(hu(e.charCodeAt(0)))return!0;return!1}let Qn={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"},Yd=null,Dn=Qn.unavailable,ra=null,fm=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(Dn=Qn.error),Yd&&Yd(r)};function Kd(){Jd.fire(new As("pluginStateChange",{pluginStatus:Dn,pluginURL:ra}))}let Jd=new Ea,Qd=function(){return Dn},mm=function(){if(Dn!==Qn.deferred||!ra)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Dn=Qn.loading,Kd(),ra&&xc({url:ra},r=>{r?fm(r):(Dn=Qn.loaded,Kd())})},as={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Dn===Qn.loaded||as.applyArabicShaping!=null,isLoading:()=>Dn===Qn.loading,setState(r){Dn=r.pluginStatus,ra=r.pluginURL},isParsing:()=>Dn===Qn.parsing,isParsed:()=>Dn===Qn.parsed,getPluginURL:()=>ra};class ji{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,s){for(let a of i)if(!Rg(a.charCodeAt(0),s))return!1;return!0}(e,as.isLoaded())}}class Uc{constructor(e,i,s,a){this.property=e,this.value=i,this.expression=function(h,u,f,g){if(ou(h))return new Oa(h,u);if(Hd(h)||Array.isArray(h)&&h.length>0){let y=$d(h,u,f,g);if(y.result==="error")throw new Error(y.value.map(w=>`${w.key}: ${w.message}`).join(", "));return y.value}{let y=h;return typeof h=="string"&&u.type==="color"&&(y=ki.parse(h)),{kind:"constant",configDependencies:new Set,evaluate:()=>y}}}(i===void 0?e.specification.default:i,e.specification,s,a)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,s){return this.property.possiblyEvaluate(this,e,i,s)}}class uu{constructor(e,i,s){this.property=e,this.value=new Uc(e,void 0,i,s)}transitioned(e,i){return new _m(this.property,this.value,i,Le({},e.transition,this.transition),e.now)}untransitioned(){return new _m(this.property,this.value,null,{},0)}}class jc{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=s,this.configDependencies=new Set}getValue(e){return si(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new uu(this._values[e].property,this._scope,this._options)),this._values[e].value=new Uc(this._values[e].property,i===null?void 0:si(i),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);let s=this._properties.properties;if(e)for(let a in e){let h=e[a];if(a.endsWith("-transition")){let u=a.slice(0,-11);s[u]&&this.setTransition(u,h)}else s.hasOwnProperty(a)&&this.setValue(a,h)}}getTransition(e){return si(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new uu(this._values[e].property)),this._values[e].transition=si(i)||void 0}serialize(){let e={};for(let i of Object.keys(this._values)){let s=this.getValue(i);s!==void 0&&(e[i]=s);let a=this.getTransition(i);a!==void 0&&(e[`${i}-transition`]=a)}return e}transitioned(e,i){let s=new gm(this._properties);for(let a of Object.keys(this._values))s._values[a]=this._values[a].transitioned(e,i._values[a]);return s}untransitioned(){let e=new gm(this._properties);for(let i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class _m{constructor(e,i,s,a,h){let u=a.delay||0,f=a.duration||0;h=h||0,this.property=e,this.value=i,this.begin=h+u,this.end=this.begin+f,e.specification.transition&&(a.delay||a.duration)&&(this.prior=s)}possiblyEvaluate(e,i,s){let a=e.now||0,h=this.value.possiblyEvaluate(e,i,s),u=this.prior;if(u){if(a>this.end)return this.prior=null,h;if(this.value.isDataDriven())return this.prior=null,h;if(a<this.begin)return u.possiblyEvaluate(e,i,s);{let f=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(u.possiblyEvaluate(e,i,s),h,$(f))}}return h}}class gm{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,s){let a=new Ko(this._properties);for(let h of Object.keys(this._values))a._values[h]=this._values[h].possiblyEvaluate(e,i,s);return a}hasTransition(){for(let e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class na{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=s,this.configDependencies=new Set}getValue(e){return si(this._values[e].value)}setValue(e,i){this._values[e]=new Uc(this._values[e].property,i===null?void 0:si(i),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){let e={};for(let i of Object.keys(this._values)){let s=this.getValue(i);s!==void 0&&(e[i]=s)}return e}possiblyEvaluate(e,i,s){let a=new Ko(this._properties);for(let h of Object.keys(this._values))a._values[h]=this._values[h].possiblyEvaluate(e,i,s);return a}}class ka{constructor(e,i,s){this.property=e,this.value=i,this.parameters=s}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,s,a){return this.property.evaluate(this.value,this.parameters,e,i,s,a)}}class Ko{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ot{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,s){let a=Sc[this.specification.type];return a?a(e,i,s):e}}class gt{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,s,a){return new ka(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(i,null,{},s,a)}:e.expression,i)}interpolate(e,i,s){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new ka(this,{kind:"constant",value:void 0},e.parameters);let a=Sc[this.specification.type];return a?new ka(this,{kind:"constant",value:a(e.value.value,i.value.value,s)},e.parameters):e}evaluate(e,i,s,a,h,u){return e.kind==="constant"?e.value:e.evaluate(i,s,a,h,u)}}class bl{constructor(e){this.specification=e}possiblyEvaluate(e,i,s,a){return!!e.expression.evaluate(i,null,{},s,a)}interpolate(){return!1}}class Ar{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let i=new ji(0,{});for(let s in e){let a=e[s];a.specification.overridable&&this.overridableProperties.push(s);let h=this.defaultPropertyValues[s]=new Uc(a,void 0),u=this.defaultTransitionablePropertyValues[s]=new uu(a);this.defaultTransitioningPropertyValues[s]=u.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=h.possiblyEvaluate(i)}}}Tt(gt,"DataDrivenProperty"),Tt(ot,"DataConstantProperty"),Tt(bl,"ColorRampProperty");var Se=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"expression"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function ym(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function Gc(r){if(Array.isArray(r))return r.map(Gc);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){let e={};for(let i in r)e[i]=Gc(r[i]);return e}return ym(r)}function qc(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(let e of r.slice(1))if(!qc(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function wl(r,e="",i=null,s="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};qc(r)||(r=pu(r));let a=r,h=!0;try{h=function(w){if(!Tl(w))return w;let E=Gc(w);return du(E),E=ep(E),E}(a)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
>>>>>>> a526947f4e024d155ff980808ddb8c37daf4d8a2
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(a,null,2)}
<<<<<<< HEAD
        `)}let u=null,f=null;if(s!=="background"&&s!=="sky"&&s!=="slot"){f=Se[`filter_${s}`];let T=Oa(h,f,e,i);if(T.result==="error")throw new Error(T.value.map(E=>`${E.key}: ${E.message}`).join(", "));u=(E,A,R)=>T.value.evaluate(E,A,{},R)}let g=null,y=null;if(h!==a){let T=Oa(a,f,e,i);if(T.result==="error")throw new Error(T.value.map(E=>`${E.key}: ${E.message}`).join(", "));g=(E,A,R,L,k)=>T.value.evaluate(E,A,{},R,void 0,void 0,L,k),y=!ml(T.value.expression)}return{filter:u,dynamicFilter:g||void 0,needGeometry:ip(h),needFeature:!!y}}function tp(r){if(!Array.isArray(r))return r;let e=function(i){if(ls.has(i[0])){for(let s=1;s<i.length;s++)if(Sl(i[s]))return!0}return i}(r);return e===!0?e:e.map(i=>tp(i))}function pu(r){let e=!1,i=[];if(r[0]==="case"){for(let s=1;s<r.length-1;s+=2)e=e||Sl(r[s]),i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="match"){e=e||Sl(r[1]);for(let s=2;s<r.length-1;s+=2)i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="step"){e=e||Sl(r[1]);for(let s=1;s<r.length-1;s+=2)i.push(r[s+1])}e&&(r.length=0,r.push("any",...i));for(let s=1;s<r.length;s++)pu(r[s])}function Sl(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<r.length;i++)if(Sl(r[i]))return!0;return!1}let ls=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Dg(r,e){return r<e?-1:r>e?1:0}function ip(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(ip(r[e]))return!0;return!1}function fu(r){if(!r)return!0;let e=r[0];return r.length<=1?e!=="any":e==="=="?rp(r[1],r[2],"=="):e==="!="?mu(rp(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?rp(r[1],r[2],e):e==="any"?(i=r.slice(1),["any"].concat(i.map(fu))):e==="all"?["all"].concat(r.slice(1).map(fu)):e==="none"?["all"].concat(r.slice(1).map(fu).map(mu)):e==="in"?vm(r[1],r.slice(2)):e==="!in"?mu(vm(r[1],r.slice(2))):e==="has"?bm(r[1]):e!=="!has"||mu(bm(r[1]));var i}function rp(r,e,i){switch(r){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,r,e]}}function vm(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",r,["literal",e.sort(Dg)]]:["filter-in-small",r,["literal",e]]}}function bm(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function mu(r){return["!",r]}let $c="";function El(r,e){return e?`${r}${$c}${e}`:r}let wm="-transition",Og=new Set(["fill","line","background","hillshade","raster"]);class Mn extends Ia{constructor(e,i,s,a,h){if(super(),this.id=e.id,this.fqid=El(this.id,s),this.type=e.type,this.scope=s,this.lut=a,this.options=h,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;let u=Oa(this.filter,Se[`filter_${e.type}`]);u.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...u.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new oa(i.layout,this.scope,h),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new Gc(i.paint,this.scope,h);for(let u in e.paint)this.setPaintProperty(u,e.paint[u]);for(let u in e.layout)this.setLayoutProperty(u,e.layout[u]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ko(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Og.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);let s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(wm)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){let s=this._transitionablePaint,a=s._properties.properties;if(e.endsWith(wm)){let E=e.slice(0,-11);return a[E]&&s.setTransition(E,i||void 0),!1}if(!a[e])return!1;let h=s._values[e],u=h.value.isDataDriven(),f=h.value;s.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);let g=s._values[e].value,y=g.isDataDriven(),T=e.endsWith("pattern")||e==="line-dasharray";return y||u||T||this._handleOverridablePaintPropertyUpdate(e,f,g)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,s){return null}_handleOverridablePaintPropertyUpdate(e,i,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return ui({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,i)=>!(e===void 0||i==="layout"&&!Object.keys(e).length||i==="paint"&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(let e in this.paint._values){let i=this.paint.get(e);if(i instanceof Fa&&nu(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=Tl(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,s,a,h,u,f,g,y){}}let kg={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Zc{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class sr{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){let i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function gi(r,e=1){let i=0,s=0;return{members:r.map(a=>{let h=kg[a.type].BYTES_PER_ELEMENT,u=i=np(i,Math.max(e,h)),f=a.components||1;return s=Math.max(s,h),i+=h*f,{name:a.name,type:a.type,components:f,offset:u}}),size:np(i,Math.max(s,e)),alignment:e}}function np(r,e){return Math.ceil(r/e)*e}class Zn extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){let s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){let a=2*e;return this.int16[a+0]=i,this.int16[a+1]=s,e}}Zn.prototype.bytesPerElement=4,Tt(Zn,"StructArrayLayout2i4");class Il extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=3*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.int16[h+2]=a,e}}Il.prototype.bytesPerElement=6,Tt(Il,"StructArrayLayout3i6");class Al extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){let h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a)}emplace(e,i,s,a,h){let u=4*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=a,this.int16[u+3]=h,e}}Al.prototype.bytesPerElement=8,Tt(Al,"StructArrayLayout4i8");class Ba extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}Ba.prototype.bytesPerElement=4,Tt(Ba,"StructArrayLayout1f4");class op extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=4*e,u=2*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.float32[u+1]=a,e}}op.prototype.bytesPerElement=8,Tt(op,"StructArrayLayout2i1f8");class sp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=4*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.int16[h+2]=a,e}}sp.prototype.bytesPerElement=8,Tt(sp,"StructArrayLayout3i8");class _u extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h){let u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a,h)}emplace(e,i,s,a,h,u){let f=5*e;return this.int16[f+0]=i,this.int16[f+1]=s,this.int16[f+2]=a,this.int16[f+3]=h,this.int16[f+4]=u,e}}_u.prototype.bytesPerElement=10,Tt(_u,"StructArrayLayout5i10");class gu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f){let g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,h,u,f)}emplace(e,i,s,a,h,u,f,g){let y=6*e,T=12*e,E=3*e;return this.int16[y+0]=i,this.int16[y+1]=s,this.uint8[T+4]=a,this.uint8[T+5]=h,this.uint8[T+6]=u,this.uint8[T+7]=f,this.float32[E+2]=g,e}}gu.prototype.bytesPerElement=12,Tt(gu,"StructArrayLayout2i4ub1f12");class yo extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=3*e;return this.float32[h+0]=i,this.float32[h+1]=s,this.float32[h+2]=a,e}}yo.prototype.bytesPerElement=12,Tt(yo,"StructArrayLayout3f12");class sa extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h){let u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a,h)}emplace(e,i,s,a,h,u){let f=6*e,g=3*e;return this.uint16[f+0]=i,this.uint16[f+1]=s,this.uint16[f+2]=a,this.uint16[f+3]=h,this.float32[g+2]=u,e}}sa.prototype.bytesPerElement=12,Tt(sa,"StructArrayLayout4ui1f12");class Ml extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){let h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a)}emplace(e,i,s,a,h){let u=4*e;return this.uint16[u+0]=i,this.uint16[u+1]=s,this.uint16[u+2]=a,this.uint16[u+3]=h,e}}Ml.prototype.bytesPerElement=8,Tt(Ml,"StructArrayLayout4ui8");class yu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u){let f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,h,u)}emplace(e,i,s,a,h,u,f){let g=6*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.int16[g+2]=a,this.int16[g+3]=h,this.int16[g+4]=u,this.int16[g+5]=f,e}}yu.prototype.bytesPerElement=12,Tt(yu,"StructArrayLayout6i12");class xu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,T,E,A){let R=this.length;return this.resize(R+1),this.emplace(R,e,i,s,a,h,u,f,g,y,T,E,A)}emplace(e,i,s,a,h,u,f,g,y,T,E,A,R){let L=12*e;return this.int16[L+0]=i,this.int16[L+1]=s,this.int16[L+2]=a,this.int16[L+3]=h,this.uint16[L+4]=u,this.uint16[L+5]=f,this.uint16[L+6]=g,this.uint16[L+7]=y,this.int16[L+8]=T,this.int16[L+9]=E,this.int16[L+10]=A,this.int16[L+11]=R,e}}xu.prototype.bytesPerElement=24,Tt(xu,"StructArrayLayout4i4ui4i24");class Cl extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u){let f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,h,u)}emplace(e,i,s,a,h,u,f){let g=10*e,y=5*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.int16[g+2]=a,this.float32[y+2]=h,this.float32[y+3]=u,this.float32[y+4]=f,e}}Cl.prototype.bytesPerElement=20,Tt(Cl,"StructArrayLayout3i3f20");class aa extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a){let h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a)}emplace(e,i,s,a,h){let u=4*e;return this.float32[u+0]=i,this.float32[u+1]=s,this.float32[u+2]=a,this.float32[u+3]=h,e}}aa.prototype.bytesPerElement=16,Tt(aa,"StructArrayLayout4f16");class ap extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}ap.prototype.bytesPerElement=4,Tt(ap,"StructArrayLayout1ul4");class cs extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){let s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){let a=2*e;return this.uint16[a+0]=i,this.uint16[a+1]=s,e}}cs.prototype.bytesPerElement=4,Tt(cs,"StructArrayLayout2ui4");class lp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,T,E,A,R){let L=this.length;return this.resize(L+1),this.emplace(L,e,i,s,a,h,u,f,g,y,T,E,A,R)}emplace(e,i,s,a,h,u,f,g,y,T,E,A,R,L){let k=20*e,B=10*e;return this.int16[k+0]=i,this.int16[k+1]=s,this.int16[k+2]=a,this.int16[k+3]=h,this.int16[k+4]=u,this.float32[B+3]=f,this.float32[B+4]=g,this.float32[B+5]=y,this.float32[B+6]=T,this.int16[k+14]=E,this.uint32[B+8]=A,this.uint16[k+18]=R,this.uint16[k+19]=L,e}}lp.prototype.bytesPerElement=40,Tt(lp,"StructArrayLayout5i4f1i1ul2ui40");class vu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f){let g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,h,u,f)}emplace(e,i,s,a,h,u,f,g){let y=8*e;return this.int16[y+0]=i,this.int16[y+1]=s,this.int16[y+2]=a,this.int16[y+4]=h,this.int16[y+5]=u,this.int16[y+6]=f,this.int16[y+7]=g,e}}vu.prototype.bytesPerElement=16,Tt(vu,"StructArrayLayout3i2i2i16");class Pl extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h){let u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a,h)}emplace(e,i,s,a,h,u){let f=4*e,g=8*e;return this.float32[f+0]=i,this.float32[f+1]=s,this.float32[f+2]=a,this.int16[g+6]=h,this.int16[g+7]=u,e}}Pl.prototype.bytesPerElement=16,Tt(Pl,"StructArrayLayout2f1f2i16");class Rl extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u){let f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,h,u)}emplace(e,i,s,a,h,u,f){let g=20*e,y=5*e;return this.uint8[g+0]=i,this.uint8[g+1]=s,this.float32[y+1]=a,this.float32[y+2]=h,this.float32[y+3]=u,this.float32[y+4]=f,e}}Rl.prototype.bytesPerElement=20,Tt(Rl,"StructArrayLayout2ub4f20");class ur extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=3*e;return this.uint16[h+0]=i,this.uint16[h+1]=s,this.uint16[h+2]=a,e}}ur.prototype.bytesPerElement=6,Tt(ur,"StructArrayLayout3ui6");class Ll extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G,X,W,K,pe){let ce=this.length;return this.resize(ce+1),this.emplace(ce,e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G,X,W,K,pe)}emplace(e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G,X,W,K,pe,ce){let ue=30*e,ge=15*e,ve=60*e;return this.int16[ue+0]=i,this.int16[ue+1]=s,this.int16[ue+2]=a,this.float32[ge+2]=h,this.float32[ge+3]=u,this.uint16[ue+8]=f,this.uint16[ue+9]=g,this.uint32[ge+5]=y,this.uint32[ge+6]=T,this.uint32[ge+7]=E,this.uint16[ue+16]=A,this.uint16[ue+17]=R,this.uint16[ue+18]=L,this.float32[ge+10]=k,this.float32[ge+11]=B,this.uint8[ve+48]=G,this.uint8[ve+49]=X,this.uint8[ve+50]=W,this.uint32[ge+13]=K,this.int16[ue+28]=pe,this.uint8[ve+58]=ce,e}}Ll.prototype.bytesPerElement=60,Tt(Ll,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class cp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G,X,W,K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe,Ke,it,Fe){let Je=this.length;return this.resize(Je+1),this.emplace(Je,e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G,X,W,K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe,Ke,it,Fe)}emplace(e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G,X,W,K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe,Ke,it,Fe,Je){let Ie=20*e,Be=40*e,at=80*e;return this.float32[Ie+0]=i,this.float32[Ie+1]=s,this.int16[Be+4]=a,this.int16[Be+5]=h,this.int16[Be+6]=u,this.int16[Be+7]=f,this.int16[Be+8]=g,this.int16[Be+9]=y,this.int16[Be+10]=T,this.int16[Be+11]=E,this.int16[Be+12]=A,this.uint16[Be+13]=R,this.uint16[Be+14]=L,this.uint16[Be+15]=k,this.uint16[Be+16]=B,this.uint16[Be+17]=G,this.uint16[Be+18]=X,this.uint16[Be+19]=W,this.uint16[Be+20]=K,this.uint16[Be+21]=pe,this.uint16[Be+22]=ce,this.uint16[Be+23]=ue,this.uint16[Be+24]=ge,this.uint16[Be+25]=ve,this.uint16[Be+26]=Ne,this.uint16[Be+27]=Ee,this.uint32[Ie+14]=Ue,this.float32[Ie+15]=nt,this.float32[Ie+16]=qe,this.float32[Ie+17]=Ke,this.float32[Ie+18]=it,this.uint8[at+76]=Fe,this.uint16[Be+39]=Je,e}}cp.prototype.bytesPerElement=80,Tt(cp,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class hp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u){let f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,h,u)}emplace(e,i,s,a,h,u,f){let g=6*e;return this.float32[g+0]=i,this.float32[g+1]=s,this.float32[g+2]=a,this.float32[g+3]=h,this.float32[g+4]=u,this.float32[g+5]=f,e}}hp.prototype.bytesPerElement=24,Tt(hp,"StructArrayLayout6f24");class Na extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h){let u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a,h)}emplace(e,i,s,a,h,u){let f=5*e;return this.float32[f+0]=i,this.float32[f+1]=s,this.float32[f+2]=a,this.float32[f+3]=h,this.float32[f+4]=u,e}}Na.prototype.bytesPerElement=20,Tt(Na,"StructArrayLayout5f20");class up extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f){let g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,h,u,f)}emplace(e,i,s,a,h,u,f,g){let y=7*e;return this.float32[y+0]=i,this.float32[y+1]=s,this.float32[y+2]=a,this.float32[y+3]=h,this.float32[y+4]=u,this.float32[y+5]=f,this.float32[y+6]=g,e}}up.prototype.bytesPerElement=28,Tt(up,"StructArrayLayout7f28");class Wc extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,T,E){let A=this.length;return this.resize(A+1),this.emplace(A,e,i,s,a,h,u,f,g,y,T,E)}emplace(e,i,s,a,h,u,f,g,y,T,E,A){let R=11*e;return this.float32[R+0]=i,this.float32[R+1]=s,this.float32[R+2]=a,this.float32[R+3]=h,this.float32[R+4]=u,this.float32[R+5]=f,this.float32[R+6]=g,this.float32[R+7]=y,this.float32[R+8]=T,this.float32[R+9]=E,this.float32[R+10]=A,e}}Wc.prototype.bytesPerElement=44,Tt(Wc,"StructArrayLayout11f44");class dp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y){let T=this.length;return this.resize(T+1),this.emplace(T,e,i,s,a,h,u,f,g,y)}emplace(e,i,s,a,h,u,f,g,y,T){let E=9*e;return this.float32[E+0]=i,this.float32[E+1]=s,this.float32[E+2]=a,this.float32[E+3]=h,this.float32[E+4]=u,this.float32[E+5]=f,this.float32[E+6]=g,this.float32[E+7]=y,this.float32[E+8]=T,e}}dp.prototype.bytesPerElement=36,Tt(dp,"StructArrayLayout9f36");class la extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){let s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){let a=2*e;return this.float32[a+0]=i,this.float32[a+1]=s,e}}la.prototype.bytesPerElement=8,Tt(la,"StructArrayLayout2f8");class pp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){let h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a)}emplace(e,i,s,a,h){let u=6*e;return this.uint32[3*e+0]=i,this.uint16[u+2]=s,this.uint16[u+3]=a,this.uint16[u+4]=h,e}}pp.prototype.bytesPerElement=12,Tt(pp,"StructArrayLayout1ul3ui12");class fp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}fp.prototype.bytesPerElement=2,Tt(fp,"StructArrayLayout1ui2");class bu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B){let G=this.length;return this.resize(G+1),this.emplace(G,e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B)}emplace(e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G){let X=16*e;return this.float32[X+0]=i,this.float32[X+1]=s,this.float32[X+2]=a,this.float32[X+3]=h,this.float32[X+4]=u,this.float32[X+5]=f,this.float32[X+6]=g,this.float32[X+7]=y,this.float32[X+8]=T,this.float32[X+9]=E,this.float32[X+10]=A,this.float32[X+11]=R,this.float32[X+12]=L,this.float32[X+13]=k,this.float32[X+14]=B,this.float32[X+15]=G,e}}bu.prototype.bytesPerElement=64,Tt(bu,"StructArrayLayout16f64");class zl extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f){let g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,h,u,f)}emplace(e,i,s,a,h,u,f,g){let y=10*e,T=5*e;return this.uint16[y+0]=i,this.uint16[y+1]=s,this.uint16[y+2]=a,this.uint16[y+3]=h,this.float32[T+2]=u,this.float32[T+3]=f,this.float32[T+4]=g,e}}zl.prototype.bytesPerElement=20,Tt(zl,"StructArrayLayout4ui3f20");class mp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}mp.prototype.bytesPerElement=2,Tt(mp,"StructArrayLayout1i2");class wu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}wu.prototype.bytesPerElement=1,Tt(wu,"StructArrayLayout1ub1");class _p extends Zc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}_p.prototype.size=40;class Tm extends lp{get(e){return new _p(this,e)}}Tt(Tm,"CollisionBoxArray");class Tu extends Zc{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Tu.prototype.size=60;class Xc extends Ll{get(e){return new Tu(this,e)}}Tt(Xc,"PlacedSymbolArray");class gp extends Zc{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}gp.prototype.size=80;class Sm extends cp{get(e){return new gp(this,e)}}Tt(Sm,"SymbolInstanceArray");class yp extends Ba{getoffsetX(e){return this.float32[1*e+0]}}Tt(yp,"GlyphOffsetArray");class Em extends Zn{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Tt(Em,"SymbolLineVertexArray");class Su extends Zc{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Su.prototype.size=12;class Im extends pp{get(e){return new Su(this,e)}}Tt(Im,"FeatureIndexArray");class Am extends cs{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Tt(Am,"FillExtrusionCentroidArray");class Mm extends Zc{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Mm.prototype.size=6;class Cm extends Il{get(e){return new Mm(this,e)}}Tt(Cm,"FillExtrusionWallArray");let Pm=gi([{name:"a_pos",components:2,type:"Int16"}],4),Fg=gi([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Bg=gi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class gr{constructor(e=[]){this.segments=e}_prepareSegment(e,i,s,a){let h=this.segments[this.segments.length-1];return e>gr.MAX_VERTEX_ARRAY_LENGTH&&pi(`Max vertices per segment is ${gr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!h||h.vertexLength+e>gr.MAX_VERTEX_ARRAY_LENGTH||h.sortKey!==a)&&(h={vertexOffset:i,primitiveOffset:s,vertexLength:0,primitiveLength:0},a!==void 0&&(h.sortKey=a),this.segments.push(h)),h}prepareSegment(e,i,s,a){return this._prepareSegment(e,i.length,s.length,a)}get(){return this.segments}destroy(){for(let e of this.segments)for(let i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,s,a){return new gr([{vertexOffset:e,primitiveOffset:i,vertexLength:s,primitiveLength:a,vaos:{},sortKey:0}])}}function Rm(r,e){return 256*(r=re(Math.floor(r),0,255))+re(Math.floor(e),0,255)}gr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Tt(gr,"SegmentVector");let Ng=gi([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),xp=gi([{name:"a_pattern_b",components:4,type:"Uint16"}]),Vg=gi([{name:"a_dash",components:4,type:"Uint16"}]);class Yc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,s,a){this.ids.push(Kc(e)),this.positions.push(i,s,a)}eachPosition(e,i){let s=Kc(e),a=0,h=this.ids.length-1;for(;a<h;){let u=a+h>>1;this.ids[u]>=s?h=u:a=u+1}for(;this.ids[a]===s;)i(this.positions[3*a],this.positions[3*a+1],this.positions[3*a+2]),a++}static serialize(e,i){let s=new Float64Array(e.ids),a=new Uint32Array(e.positions);return vp(s,a,0,s.length-1),i&&(i.add(s.buffer),i.add(a.buffer)),{ids:s,positions:a}}static deserialize(e){let i=new Yc,s;i.ids=e.ids,i.positions=e.positions;for(let a of i.ids)a!==s&&i.uniqueIds.push(a),s=a;return i.indexed=!0,i}}function Kc(r){let e=+r;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:ol(String(r))}function vp(r,e,i,s){for(;i<s;){let a=r[i+s>>1],h=i-1,u=s+1;for(;;){do h++;while(r[h]<a);do u--;while(r[u]>a);if(h>=u)break;Eu(r,h,u),Eu(e,3*h,3*u),Eu(e,3*h+1,3*u+1),Eu(e,3*h+2,3*u+2)}u-i<s-u?(vp(r,e,i,u),i=u+1):(vp(r,e,u+1,s),s=u)}}function Eu(r,e,i){let s=r[e];r[e]=r[i],r[i]=s}Tt(Yc,"FeaturePositionMap");class Bo{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Iu extends Bo{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class Or extends Bo{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class hs extends Bo{constructor(e){super(e),this.current=[0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class Dl extends Bo{constructor(e){super(e),this.current=[0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class Jc extends Bo{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class bp extends Bo{constructor(e){super(e),this.current=ki.transparent.toPremultipliedRenderColor(null)}set(e,i,s){this.fetchUniformLocation(e,i)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}let Lm=new Float32Array(16);class Qc extends Bo{constructor(e){super(e),this.current=Lm}set(e,i,s){if(this.fetchUniformLocation(e,i)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let a=1;a<16;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}let Ug=new Float32Array(9),zm=new Float32Array(4);class wp extends Bo{constructor(e){super(e),this.current=zm}set(e,i,s){if(this.fetchUniformLocation(e,i)){for(let a=0;a<4;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function Tp(r){return[Rm(255*r.r,255*r.g),Rm(255*r.b,255*r.a)]}class eh{constructor(e,i,s,a){this.value=e,this.uniformNames=i.map(h=>`u_${h}`),this.type=s,this.context=a}setUniform(e,i,s,a,h){let u=a.constantOr(this.value);i.set(e,h,u instanceof ki?u.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):u)}getBinding(e,i){return this.type==="color"?new bp(e):new Or(e)}}class Ol{constructor(e,i){this.uniformNames=i.map(s=>`u_${s}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,s,a,h){let u=null;h!=="u_pattern"&&h!=="u_dash"||(u=this.pattern),h==="u_pattern_b"&&(u=this.patternTransition),h==="u_pixel_ratio"&&(u=this.pixelRatio),u&&i.set(e,h,u)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new Jc(e):new Or(e)}}class Ls{constructor(e,i,s,a){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=i.map(h=>({name:`a_${h}`,type:"Float32",components:s==="color"?2:1,offset:0})),this.paintVertexArray=new a}populatePaintArray(e,i,s,a,h,u,f,g){let y=this.paintVertexArray.length,T=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new ji(0,{brightness:u,worldview:g}),i,{},h,a,f):this.expression.kind==="constant"&&this.expression.value,E=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ji(0,{brightness:u,worldview:g}),i,{},h,a,f):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(y,e,T,E?null:this.context.lut)}updatePaintArray(e,i,s,a,h,u,f,g){let y=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:f,worldview:g},s,a,void 0,h):this.expression.kind==="constant"&&this.expression.value,T=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ji(0,{brightness:f,worldview:g}),s,a,void 0,h):this.lutExpression.value)==="none";this._setPaintValue(e,i,y,T?null:this.context.lut)}_setPaintValue(e,i,s,a){if(this.type==="color"){let h=Tp(s.toPremultipliedRenderColor(a));for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,h[0],h[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class No{constructor(e,i,s,a,h,u){this.expression=e,this.uniformNames=i.map(f=>`u_${f}_t`),this.type=s,this.useIntegerZoom=a,this.context=h,this.maxValue=0,this.paintVertexAttributes=i.map(f=>({name:`a_${f}`,type:"Float32",components:s==="color"?4:2,offset:0})),this.paintVertexArray=new u}populatePaintArray(e,i,s,a,h,u,f,g){let y=this.expression.evaluate(new ji(this.context.zoom,{brightness:u,worldview:g}),i,{},h,a,f),T=this.expression.evaluate(new ji(this.context.zoom+1,{brightness:u,worldview:g}),i,{},h,a,f),E=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ji(0,{brightness:u,worldview:g}),i,{},h,a,f):this.lutExpression.value)==="none",A=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(A,e,y,T,E?null:this.context.lut)}updatePaintArray(e,i,s,a,h,u,f,g){let y=this.expression.evaluate({zoom:this.context.zoom,brightness:f,worldview:g},s,a,void 0,h),T=this.expression.evaluate({zoom:this.context.zoom+1,brightness:f,worldview:g},s,a,void 0,h),E=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ji(0,{brightness:f,worldview:g}),s,a,void 0,h):this.lutExpression.value)==="none";this._setPaintValue(e,i,y,T,E?null:this.context.lut)}_setPaintValue(e,i,s,a,h){if(this.type==="color"){let u=Tp(s.toPremultipliedRenderColor(h)),f=Tp(s.toPremultipliedRenderColor(h));for(let g=e;g<i;g++)this.paintVertexArray.emplace(g,u[0],u[1],f[0],f[1])}else{for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,s,a);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,s,a,h){let u=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,f=re(this.expression.interpolationFactor(u,this.context.zoom,this.context.zoom+1),0,1);i.set(e,h,f)}getBinding(e,i){return new Or(e)}}class xo{constructor(e,i,s,a,h){this.expression=e,this.layerId=h,this.paintVertexAttributes=(s==="array"?Vg:Ng).members;for(let u=0;u<i.length;++u);this.paintVertexArray=new a,this.paintTransitionVertexArray=new Ml}populatePaintArray(e,i,s,a){let h=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(h,e,i.patterns&&i.patterns[this.layerId],s)}updatePaintArray(e,i,s,a,h,u,f){this._setPaintValues(e,i,s.patterns&&s.patterns[this.layerId],u)}_setPaintValues(e,i,s,a){if(!a||!s)return;let h=a[s[0]],u=a[s[1]];if(h){if(h){let{tl:f,br:g,pixelRatio:y}=h;for(let T=e;T<i;T++)this.paintVertexArray.emplace(T,f[0],f[1],g[0],g[1],y)}if(u){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);let{tl:f,br:g}=u;for(let y=e;y<i;y++)this.paintTransitionVertexArray.emplace(y,f[0],f[1],g[0],g[1])}}}upload(e){let i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,xp.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class On{constructor(e,i,s=()=>!0){this.binders={},this._buffers=[],this.context=i;let a=[];for(let h in e.paint._values){let u=e.paint.get(h);if(h.endsWith("-use-theme")||!s(h)||!(u instanceof Fa&&nu(u.property.specification)))continue;let f=Gg(h,e.type),g=u.value,y=u.property.specification.type,T=!!u.property.useIntegerZoom,E=h==="line-dasharray"||h.endsWith("pattern"),A=e.paint.get(`${h}-use-theme`),R=h==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||A&&A.value.kind!=="constant";if(g.kind!=="constant"||R)if(g.kind==="source"||R||E){let L=Dm(h,y,"source");this.binders[h]=E?new xo(g,f,y,L,e.id):new Ls(g,f,y,L),a.push(`/a_${h}`)}else{let L=Dm(h,y,"composite");this.binders[h]=new No(g,f,y,T,i,L),a.push(`/z_${h}`)}else this.binders[h]=E?new Ol(g.value,f):new eh(g.value,f,y,i),a.push(`/u_${h}`);A&&(this.binders[h].lutExpression=A.value)}this.cacheKey=a.sort().join("")}getMaxValue(e){let i=this.binders[e];return i instanceof Ls||i instanceof No?i.maxValue:0}populatePaintArrays(e,i,s,a,h,u,f,g){for(let y in this.binders){let T=this.binders[y];T.context=this.context,(T instanceof Ls||T instanceof No||T instanceof xo)&&T.populatePaintArray(e,i,s,a,h,u,f,g)}}setConstantPatternPositions(e,i){for(let s in this.binders){let a=this.binders[s];a instanceof Ol&&a.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){let i=this.binders[e];return i instanceof xo?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,s,a,h,u,f,g,y,T){let E=!1,A=Object.keys(e),R=A.length!==0&&!g,L=R?A:i.uniqueIds;this.context.lut=h.lut;for(let k in this.binders){let B=this.binders[k];if(B.context=this.context,(B instanceof Ls||B instanceof No||B instanceof xo)&&B.expression&&B.expression.kind&&B.expression.kind!=="constant"&&(B.expression.isStateDependent===!0||B.expression.isLightConstant===!1)){let G=h.paint.get(k);B.expression=G.value;for(let X of L){let W=e[X.toString()];i.eachPosition(X,(K,pe,ce)=>{let ue=a.feature(K);B.updatePaintArray(pe,ce,ue,W,u,f,y,T)})}if(!R)for(let X of s.uniqueIds){let W=e[X.toString()];s.eachPosition(X,(K,pe,ce)=>{let ue=a.feature(K);B.updatePaintArray(pe,ce,ue,W,u,f,y,T)})}E=!0}}return E}defines(){let e=[];for(let i in this.binders){let s=this.binders[i];(s instanceof eh||s instanceof Ol)&&e.push(...s.uniformNames.map(a=>`#define HAS_UNIFORM_${a}`))}return e}getBinderAttributes(){let e=[];for(let i in this.binders){let s=this.binders[i];if(s instanceof Ls||s instanceof No||s instanceof xo)for(let a=0;a<s.paintVertexAttributes.length;a++)e.push(s.paintVertexAttributes[a].name);if(s instanceof xo)for(let a=0;a<xp.members.length;a++)e.push(xp.members[a].name)}return e}getBinderUniforms(){let e=[];for(let i in this.binders){let s=this.binders[i];if(s instanceof eh||s instanceof Ol||s instanceof No)for(let a of s.uniformNames)e.push(a)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){let i=[];for(let s in this.binders){let a=this.binders[s];if(a instanceof eh||a instanceof Ol||a instanceof No)for(let h of a.uniformNames)i.push({name:h,property:s,binding:a.getBinding(e,h)})}return i}setUniforms(e,i,s,a,h){for(let{name:u,property:f,binding:g}of s)this.binders[f].setUniform(e,g,h,a.get(f),u)}updatePaintBuffers(){this._buffers=[];for(let e in this.binders){let i=this.binders[e];(i instanceof Ls||i instanceof No||i instanceof xo)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof xo&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(let i in this.binders){let s=this.binders[i];(s instanceof Ls||s instanceof No||s instanceof xo)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(let e in this.binders){let i=this.binders[e];(i instanceof Ls||i instanceof No||i instanceof xo)&&i.destroy()}}}class vo{constructor(e,i,s=()=>!0){this.programConfigurations={};for(let a of e)this.programConfigurations[a.id]=new On(a,i,s);this.needsUpload=!1,this._featureMap=new Yc,this._featureMapWithoutIds=new Yc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,s,a,h,u,f,g,y){for(let T in this.programConfigurations)this.programConfigurations[T].populatePaintArrays(e,i,a,h,u,f,g,y);i.id!==void 0?this._featureMap.add(i.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,s,a,h,u,f,g){for(let y of s)this.needsUpload=this.programConfigurations[y.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,y,a,h,u,f||0,g)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(let i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(let e in this.programConfigurations)this.programConfigurations[e].destroy()}}let jg={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function Gg(r,e){return jg[r]||[r.replace(`${e}-`,"").replace(/-/g,"_")]}let qg={"line-pattern":{source:sa,composite:sa},"fill-pattern":{source:sa,composite:sa},"fill-extrusion-pattern":{source:sa,composite:sa},"line-dasharray":{source:Ml,composite:Ml}},Hg={color:{source:la,composite:aa},number:{source:Ba,composite:la}};function Dm(r,e,i){let s=qg[r];return s&&s[i]||Hg[e][i]}Tt(eh,"ConstantBinder"),Tt(Ol,"PatternConstantBinder"),Tt(Ls,"SourceExpressionBinder"),Tt(xo,"PatternCompositeBinder"),Tt(No,"CompositeExpressionBinder"),Tt(On,"ProgramConfiguration",{omit:["_buffers"]}),Tt(vo,"ProgramConfigurationSet");let Cn=ht/Math.PI/2,Om=5,l=6,t=16383,o=64,c=[o,32,16],d=-Cn,p=Cn;function _(r,e,i,s=Cn){return i=Ai(i),[r*Math.sin(i)*s,-e*s,r*Math.cos(i)*s]}function x(r,e,i){return _(Math.cos(Ai(r)),Math.sin(Ai(r)),e,i)}let b=63710088e-1,M=2*Math.PI*b;class C{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new C(De(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){let i=Math.PI/180,s=this.lat*i,a=e.lat*i,h=Math.sin(s)*Math.sin(a)+Math.cos(s)*Math.cos(a)*Math.cos((e.lng-this.lng)*i);return b*Math.acos(Math.min(h,1))}toBounds(e=0){let i=360*e/40075017,s=i/Math.cos(Math.PI/180*this.lat);return new z({lng:this.lng-s,lat:this.lat-i},{lng:this.lng+s,lat:this.lat+i})}toEcef(e){return x(this.lat,this.lng,Cn+e*Cn/b)}static convert(e){if(e instanceof C)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new C(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new C(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class z{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(e.length===4){let s=e;this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]])}else{let s=e;this.setSouthWest(s[0]).setNorthEast(s[1])}}setNorthEast(e){return this._ne=e instanceof C?new C(e.lng,e.lat):C.convert(e),this}setSouthWest(e){return this._sw=e instanceof C?new C(e.lng,e.lat):C.convert(e),this}extend(e){let i=this._sw,s=this._ne,a,h;if(e instanceof C)a=e,h=e;else{if(!(e instanceof z))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(z.convert(e)):this.extend(C.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(C.convert(e)):this;if(a=e._sw,h=e._ne,!a||!h)return this}return i||s?(i.lng=Math.min(a.lng,i.lng),i.lat=Math.min(a.lat,i.lat),s.lng=Math.max(h.lng,s.lng),s.lat=Math.max(h.lat,s.lat)):(this._sw=new C(a.lng,a.lat),this._ne=new C(h.lng,h.lat)),this}getCenter(){return new C((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new C(this.getWest(),this.getNorth())}getSouthEast(){return new C(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){let{lng:i,lat:s}=C.convert(e),a=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(a=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&a}static convert(e){if(e)return e instanceof z?e:new z(e)}}let P=0,D=25.5;function N(r){return M*Math.cos(r*Math.PI/180)}function F(r){return(180+r)/360}function j(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function U(r,e){return r/N(e)}function Z(r){return 360*r-180}function Y(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Q(r,e){return r*N(Y(e))}let ne=85.051129;function he(r){return Math.cos(Ai(re(r,-ne,ne)))}function de(r,e){let i=re(e,P,D),s=Math.pow(2,i);return he(r)*M/(512*s)}function oe(r){return 1/Math.cos(r*Math.PI/180)}function se(r,e=0){let i=Math.exp(Math.PI*(1-(r.y+e/ht)/(1<<r.z)*2));return 80150034*i/(i*i+1)/ht/(1<<r.z)}class le{constructor(e,i,s=0){this.x=+e,this.y=+i,this.z=+s}static fromLngLat(e,i=0){let s=C.convert(e);return new le(F(s.lng),j(s.lat),U(i,s.lat))}toLngLat(){return new C(Z(this.x),Y(this.y))}toAltitude(){return Q(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/M*oe(Y(this.y))}}function Me(r,e,i,s,a,h,u,f,g){let y=(e+s)/2,T=(i+a)/2,E=new Qe(y,T);f(E),function(A,R,L,k,B,G){let X=L-B,W=k-G;return Math.abs((k-R)*X-(L-A)*W)/Math.hypot(X,W)}(E.x,E.y,h.x,h.y,u.x,u.y)>=g?(Me(r,e,i,y,T,h,E,f,g),Me(r,y,T,s,a,E,u,f,g)):r.push(u)}function _e(r,e,i){let s=r[0],a=s.x,h=s.y;e(s);let u=[s];for(let f=1;f<r.length;f++){let g=r[f],{x:y,y:T}=g;e(g),Me(u,a,h,y,T,s,g,e,i),a=y,h=T,s=g}return u}function Ve(r,e,i,s){if(s(e,i)){let a=e.add(i)._mult(.5);Ve(r,e,a,s),Ve(r,a,i,s)}else r.push(i)}function ze(r,e){let i=r[0],s=[i];for(let a=1;a<r.length;a++){let h=r[a];Ve(s,i,h,e),i=h}return s}let je=Math.pow(2,14)-1,rt=-je-1;function Ce(r,e){let i=Math.round(r.x*e),s=Math.round(r.y*e);return r.x=re(i,rt,je),r.y=re(s,rt,je),(i<r.x||i>r.x+1||s<r.y||s>r.y+1)&&pi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function me(r,e,i){let s=r.loadGeometry(),a=r.extent,h=ht/a;if(e&&i&&i.projection.isReprojectedInTileSpace){let u=1<<e.z,{scale:f,x:g,y,projection:T}=i,E=A=>{let R=Z((e.x+A.x/a)/u),L=Y((e.y+A.y/a)/u),k=T.project(R,L);A.x=(k.x*f-g)*a,A.y=(k.y*f-y)*a};for(let A=0;A<s.length;A++)if(r.type!==1)s[A]=_e(s[A],E,1);else{let R=[];for(let L of s[A])L.x<0||L.x>=a||L.y<0||L.y>=a||(E(L),R.push(L));s[A]=R}}for(let u of s)for(let f of u)Ce(f,h);return s}function ke(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?me(r):[]}}class Pe{constructor(e,i,s,a,h){this.properties={},this.extent=s,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=a,this._values=h,e.readFields($e,this,i)}loadGeometry(){let e=this._pbf;e.pos=this._geometry;let i=e.readVarint()+e.pos,s=[],a,h=1,u=0,f=0,g=0;for(;e.pos<i;){if(u<=0){let y=e.readVarint();h=7&y,u=y>>3}if(u--,h===1||h===2)f+=e.readSVarint(),g+=e.readSVarint(),h===1&&(a&&s.push(a),a=[]),a&&a.push(new Qe(f,g));else{if(h!==7)throw new Error(`unknown command ${h}`);a&&a.push(a[0].clone())}}return a&&s.push(a),s}bbox(){let e=this._pbf;e.pos=this._geometry;let i=e.readVarint()+e.pos,s=1,a=0,h=0,u=0,f=1/0,g=-1/0,y=1/0,T=-1/0;for(;e.pos<i;){if(a<=0){let E=e.readVarint();s=7&E,a=E>>3}if(a--,s===1||s===2)h+=e.readSVarint(),u+=e.readSVarint(),h<f&&(f=h),h>g&&(g=h),u<y&&(y=u),u>T&&(T=u);else if(s!==7)throw new Error(`unknown command ${s}`)}return[f,y,g,T]}toGeoJSON(e,i,s){let a=this.extent*Math.pow(2,s),h=this.extent*e,u=this.extent*i,f=this.loadGeometry();function g(A){return[360*(A.x+h)/a-180,360/Math.PI*Math.atan(Math.exp((1-2*(A.y+u)/a)*Math.PI))-90]}function y(A){return A.map(g)}let T;if(this.type===1){let A=[];for(let L of f)A.push(L[0]);let R=y(A);T=A.length===1?{type:"Point",coordinates:R[0]}:{type:"MultiPoint",coordinates:R}}else if(this.type===2){let A=f.map(y);T=A.length===1?{type:"LineString",coordinates:A[0]}:{type:"MultiLineString",coordinates:A}}else{if(this.type!==3)throw new Error("unknown feature type");{let A=function(L){let k=L.length;if(k<=1)return[L];let B=[],G,X;for(let W=0;W<k;W++){let K=Ze(L[W]);K!==0&&(X===void 0&&(X=K<0),X===K<0?(G&&B.push(G),G=[L[W]]):G&&G.push(L[W]))}return G&&B.push(G),B}(f),R=[];for(let L of A)R.push(L.map(y));T=R.length===1?{type:"Polygon",coordinates:R[0]}:{type:"MultiPolygon",coordinates:R}}}let E={type:"Feature",geometry:T,properties:this.properties};return this.id!=null&&(E.id=this.id),E}}function $e(r,e,i){r===1?e.id=i.readVarint():r===2?function(s,a){let h=s.readVarint()+s.pos;for(;s.pos<h;){let u=a._keys[s.readVarint()],f=a._values[s.readVarint()];a.properties[u]=f}}(i,e):r===3?e.type=i.readVarint():r===4&&(e._geometry=i.pos)}function Ze(r){let e=0;for(let i,s,a=0,h=r.length,u=h-1;a<h;u=a++)i=r[a],s=r[u],e+=(s.x-i.x)*(i.y+s.y);return e}Pe.types=["Unknown","Point","LineString","Polygon"];class Ye{constructor(e,i){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(ct,this,i),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];let i=this._pbf.readVarint()+this._pbf.pos;return new Pe(this._pbf,i,this.extent,this._keys,this._values)}}function ct(r,e,i){r===15?e.version=i.readVarint():r===1?e.name=i.readString():r===5?e.extent=i.readVarint():r===2?e._features.push(i.pos):r===3?e._keys.push(i.readString()):r===4&&e._values.push(function(s){let a=null,h=s.readVarint()+s.pos;for(;s.pos<h;){let u=s.readVarint()>>3;a=u===1?s.readString():u===2?s.readFloat():u===3?s.readDouble():u===4?s.readVarint64():u===5?s.readVarint():u===6?s.readSVarint():u===7?s.readBoolean():null}if(a==null)throw new Error("unknown feature value");return a}(i))}class Mt{constructor(e,i){this.layers=e.readFields(Ot,{},i)}}function Ot(r,e,i){if(r===3){let s=new Ye(i,i.readVarint()+i.pos);s.length&&(e[s.name]=s)}}let yt="3d_elevation_id",zt="level";class Rt{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,s){return this.get(e,!0,i,s)}optional(e,i,s){return this.get(e,!1,i,s)}success(){return this._valid}get(e,i,s,a){let h=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&h!==void 0&&!Number.isNaN(h)?s(a?a(h):h):i&&(this._valid=!1),this}}class $t{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,s){return this.featureFunc(e,i,s)}parseVertex(e,i,s){return this.vertexFunc(e,i,s)}}let Jt=new $t((r,e,i)=>r.reset(e).require(yt,s=>{i.id=s}).optional("fixed_height_relative",s=>{i.constantHeight=s},Ti.decodeRelativeHeight).geometry(s=>{i.bounds=s},yd).success(),(r,e,i)=>r.reset(e).require(yt,s=>{i.id=s}).require("elevation_idx",s=>{i.idx=s}).require("extent",s=>{i.extent=s}).require("height_relative",s=>{i.height=s},Ti.decodeRelativeHeight).geometry(s=>{i.position=s},Ti.getPoint).success()),ai=new $t((r,e,i)=>r.reset(e).require(yt,s=>{i.id=s}).optional("fixed_height",s=>{i.constantHeight=s},Ti.decodeMetricHeight).geometry(s=>{i.bounds=s},yd).success(),(r,e,i)=>r.reset(e).require(yt,s=>{i.id=s}).require("elevation_idx",s=>{i.idx=s}).require("extent",s=>{i.extent=s}).require("height",s=>{i.height=s},Ti.decodeMetricHeight).geometry(s=>{i.position=s},Ti.getPoint).success());class Ti{static getPoint(e){return uo(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){let i=[],s=[],a=e.length,h=new Rt;for(let f=0;f<a;f++){let g=e.feature(f),y=g.properties.version,T=(u=y)?u==="1.0.1"?ai:void 0:Jt;if(T===void 0){pi(`Unknown elevation feature version number ${y||"(unknown)"}`);continue}let E=g.properties.hasOwnProperty("type")?g.properties.type:void 0;if(E){if(Pe.types[g.type]==="Point"&&E==="curve_point"){let A={};T.parseVertex(h,g,A)&&i.push(A)}else if(Pe.types[g.type]==="Polygon"&&E==="curve_meta"){let A={};T.parseFeature(h,g,A)&&s.push(A)}}}var u;return{vertices:i,features:s}}}class Yt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){let a=hr(i,this.dir);if(Math.abs(a)<1e-6)return!1;let h=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/a;return s[0]=this.pos[0]+this.dir[0]*h,s[1]=this.pos[1]+this.dir[1]*h,!0}}class Si{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){let a=or(i,this.dir);if(Math.abs(a)<1e-6)return!1;let h=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/a;return s[0]=this.pos[0]+this.dir[0]*h,s[1]=this.pos[1]+this.dir[1]*h,s[2]=this.pos[2]+this.dir[2]*h,!0}closestPointOnSphere(e,i,s){if(function(R,L){var k=R[0],B=R[1],G=R[2],X=L[0],W=L[1],K=L[2];return Math.abs(k-X)<=O*Math.max(1,Math.abs(k),Math.abs(X))&&Math.abs(B-W)<=O*Math.max(1,Math.abs(B),Math.abs(W))&&Math.abs(G-K)<=O*Math.max(1,Math.abs(G),Math.abs(K))}(this.pos,e)||i===0)return s[0]=s[1]=s[2]=0,!1;let[a,h,u]=this.dir,f=this.pos[0]-e[0],g=this.pos[1]-e[1],y=this.pos[2]-e[2],T=a*a+h*h+u*u,E=2*(f*a+g*h+y*u),A=E*E-4*T*(f*f+g*g+y*y-i*i);if(A<0){let R=Math.max(-E/2,0),L=f+a*R,k=g+h*R,B=y+u*R,G=Math.hypot(L,k,B);return s[0]=L*i/G,s[1]=k*i/G,s[2]=B*i/G,!1}{let R=(-E-Math.sqrt(A))/(2*T);if(R<0){let L=Math.hypot(f,g,y);return s[0]=f*i/L,s[1]=g*i/L,s[2]=y*i/L,!1}return s[0]=f+a*R,s[1]=g+h*R,s[2]=y+u*R,!0}}}class Mi{constructor(e,i,s,a,h){this.TL=e,this.TR=i,this.BR=s,this.BL=a,this.horizon=h}static fromInvProjectionMatrix(e,i,s){let a=[-1,1,1],h=[1,1,1],u=[1,-1,1],f=[-1,-1,1],g=Lr(a,a,e),y=Lr(h,h,e),T=Lr(u,u,e),E=Lr(f,f,e);return new Mi(g,y,T,E,i/s)}}function Wi(r,e,i){let s=1/0,a=-1/0,h=[];for(let u of r){zr(h,u,e);let f=or(h,i);s=Math.min(s,f),a=Math.max(a,f)}return[s,a]}function ni(r,e){let i=!0;for(let s=0;s<r.planes.length;s++){let a=r.planes[s],h=0;for(let u=0;u<e.length;u++)h+=or(a,e[u])+a[3]>=0;if(h===0)return 0;h!==e.length&&(i=!1)}return i?2:1}function Ei(r,e){for(let i of r.projections){let s=Wi(e,r.points[0],i.axis);if(i.projection[1]<s[0]||i.projection[0]>s[1])return 0}return 1}function Ii(r,e){let i=0,s=[0,0,0,0];for(let u=0;u<r.length;u++)s[0]=r[u][0],s[1]=r[u][1],s[2]=r[u][2],s[3]=1,(a=s)[0]*(h=e)[0]+a[1]*h[1]+a[2]*h[2]+a[3]*h[3]>=0&&i++;var a,h;return i}class Ri{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=li.fromPoints(this.points),this.projections=[],this.frustumEdges=[zr([],this.points[2],this.points[3]),zr([],this.points[0],this.points[3]),zr([],this.points[4],this.points[0]),zr([],this.points[5],this.points[1]),zr([],this.points[6],this.points[2]),zr([],this.points[7],this.points[3])];for(let s of this.frustumEdges){let a=[0,-s[2],s[1]],h=[s[2],0,-s[0]];this.projections.push({axis:a,projection:Wi(this.points,this.points[0],a)}),this.projections.push({axis:h,projection:Wi(this.points,this.points[0],h)})}}static fromInvProjectionMatrix(e,i,s,a){let h=Math.pow(2,s),u=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(y=>{let T=Kn([],y,e),E=1/T[3]/i*h;return(A=T)[0]=(R=T)[0]*(L=[E,E,a?1/T[3]:E,E])[0],A[1]=R[1]*L[1],A[2]=R[2]*L[2],A[3]=R[3]*L[3],A;var A,R,L}),f=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(y=>{let T=Oi([],Vr([],zr([],u[y[0]],u[y[1]]),zr([],u[y[2]],u[y[1]]))),E=-or(T,u[y[1]]);return T.concat(E)}),g=[];for(let y=0;y<u.length;y++)g.push([u[y][0],u[y][1],u[y][2]]);return new Ri(g,f)}intersectsPrecise(e,i,s){for(let a=0;a<i.length;a++)if(!Ii(e,i[a]))return 0;for(let a=0;a<this.planes.length;a++)if(!Ii(e,this.planes[a]))return 0;for(let a of s)for(let h of this.frustumEdges){let u=Vr([],a,h),f=Ni(u);if(f===0)continue;Xi(u,u,1/f);let g=Wi(this.points,this.points[0],u),y=Wi(e,this.points[0],u);if(g[0]>y[1]||y[0]>g[1])return 0}return 1}containsPoint(e){for(let i of this.planes){let s=i[3];if(or([i[0],i[1],i[2]],e)+s<0)return!1}return!0}}class li{static fromPoints(e){let i=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(let a of e)Rr(i,i,a),Hr(s,s,a);return new li(i,s)}static fromTileIdAndHeight(e,i,s){let a=1<<e.canonical.z,h=e.canonical.x,u=e.canonical.y;return new li([h/a,u/a,i],[(h+1)/a,(u+1)/a,s])}static applyTransform(e,i){let s=e.getCorners();for(let a=0;a<s.length;++a)Lr(s[a],s[a],i);return li.fromPoints(s)}static applyTransformFast(e,i){let s=[i[12],i[13],i[14]],a=[...s];for(let h=0;h<3;h++)for(let u=0;u<3;u++){let f=i[4*u+h],g=f*e.min[u],y=f*e.max[u];s[h]+=Math.min(g,y),a[h]+=Math.max(g,y)}return new li(s,a)}static projectAabbCorners(e,i){let s=e.getCorners();for(let a=0;a<s.length;++a)Lr(s[a],s[a],i);return s}constructor(e,i){this.min=e,this.max=i,this.center=Xi([],vi([],this.min,this.max),.5)}quadrant(e){let i=[e%2==0,e<2],s=er(this.min),a=er(this.max);for(let h=0;h<i.length;h++)s[h]=i[h]?this.min[h]:this.center[h],a[h]=i[h]?this.center[h]:this.max[h];return a[2]=this.max[2],new li(s,a)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){let e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?ni(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?ni(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?Ei(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?Ei(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}Tt(li,"Aabb");class Vi{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){let e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,s=i[1],a=-i[0],h=(e.extent+1)*this.metersToTile;return[new Qe(Math.trunc(e.position[0]+s*h),Math.trunc(e.position[1]+a*h)),new Qe(Math.trunc(e.position[0]-s*h),Math.trunc(e.position[1]-a*h))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Ci{constructor(e,i,s,a,h,u){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:s,max:s},this.safeArea=i,this.constantHeight=s,this.constantHeight==null&&(this.constantHeight!=null||a.length!==0)){this.vertices=a,this.edges=h,this.edges=this.edges.filter(f=>{return f.a<this.vertices.length&&f.b<this.vertices.length&&!((g=this.vertices[f.a].position)[0]===(y=this.vertices[f.b].position)[0]&&g[1]===y[1]);var g,y}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let f of this.vertices)this.vertexProps.push({dir:uo(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,f.height),this.heightRange.max=Math.max(this.heightRange.max,f.height);for(let f of this.edges){let g=this.vertices[f.a].position,y=this.vertices[f.b].position,T=Ss(Sn(),y,g),E=js(T),A=Us(Sn(),T,1/E);this.edgeProps.push({vec:T,dir:A,len:E});let R=this.vertexProps[f.a].dir,L=this.vertexProps[f.b].dir;Vs(R,R,A),Vs(L,L,A)}for(let f of this.vertexProps)f.dir[0]===0&&f.dir[1]===0||Qa(f.dir,f.dir);this.tessellate(u)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;let i=this.getClosestEdge(e);if(i==null)return 0;let[s,a]=i;return Bt(this.vertices[this.edges[s].a].height,this.vertices[this.edges[s].b].height,a)}computeSlopeNormal(e,i){let s=this.getClosestEdge(e);if(!s)return yi(0,0,1);let a=s[0],h=this.edges[a],u=this.edgeProps[a].vec,f=yi(u[0],u[1],(this.vertices[h.b].height-this.vertices[h.a].height)*i),g=yi(f[1],-f[0],0);Vr(g,g,f);let y=Ni(g);return y>0?Xi(g,g,1/y):yi(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,s=Number.POSITIVE_INFINITY,a=0,h=uo(e.x,e.y);for(let u=0;u<this.edges.length;u++){let f=this.edges[u],g=this.edgeProps[u].dir,y=new Yt(h,this.edgeProps[u].dir),T=this.vertices[f.a].position,E=this.vertices[f.b].position,A=Sn(),R=Sn(),L=y.intersectsPlane(T,this.vertexProps[f.a].dir,A),k=y.intersectsPlane(E,this.vertexProps[f.b].dir,R);if(!L||!k)continue;let B=Ss(Sn(),R,A),G=Ss(Sn(),h,A),X=hr(B,B),W=X>0?hr(G,B)/X:0,K=re(W,0,1),pe=Math.abs((W-K)*this.edgeProps[u].len),ce=Ss(Sn(),h,T),ue=pe+Math.abs(hr(ce,uo(g[1],-g[0])));ue<s&&(i=u,s=ue,a=K)}return[i,a]}tessellate(e){for(let i=this.edges.length-1;i>=0;--i){let s=this.edges[i].a,a=this.edges[i].b,{position:h,height:u,extent:f}=this.vertices[s],{position:g,height:y,extent:T}=this.vertices[a],E=this.vertexProps[s].dir,A=this.vertexProps[a].dir,R=yi(h[0]/e,h[1]/e,u),L=yi(g[0]/e,g[1]/e,y),k=yi(E[1],-E[0],0);Xi(k,k,f);let B=yi(A[1],-A[0],0);if(Xi(B,B,T),this.distSqLines(yi(R[0]+.5*k[0],R[1]+.5*k[1],R[2]+.5*k[2]),yi(L[0]-.5*B[0],L[1]-.5*B[1],L[2]-.5*B[2]),yi(R[0]-.5*k[0],R[1]-.5*k[1],R[2]-.5*k[2]),yi(L[0]+.5*B[0],L[1]+.5*B[1],L[2]+.5*B[2]))<=.0025000000000000005)continue;let G=this.vertices.length,X=Vs(Sn(),h,g);this.vertices.push({position:Us(X,X,.5),height:.5*(u+y),extent:.5*(f+T)});let W=Vs(Sn(),E,A);this.vertexProps.push({dir:Qa(W,W)}),this.edges.splice(i,1),this.edgeProps.splice(i,1),this.edges.push({a:s,b:G}),this.edges.push({a:G,b:a});let K=Ss(Sn(),this.vertices[G].position,h),pe=js(K),ce={vec:K,dir:Us(Sn(),K,1/pe),len:pe};this.edgeProps.push(ce),this.edgeProps.push(ce)}}distSqLines(e,i,s,a){let h=mr(mt(),i,e),u=mr(mt(),a,s),f=mr(mt(),e,s),g=or(h,h),y=or(h,u),T=or(h,f),E=or(u,u),A=or(u,f),R=g*E-y*y;if(R===0){let B=or(f,u)/or(u,u);return Po(Nn(mt(),s,a,B),e)}let L=(y*A-T*E)/R,k=(g*A-y*T)/R;return Po(Nn(mt(),e,i,L),Nn(mt(),s,a,k))}}class yr{static parseFrom(e,i){let s=Ti.parse(e);if(!s)return[];let{vertices:a,features:h}=s,u=1/se(i);h.sort((T,E)=>T.id-E.id),a.sort((T,E)=>T.id-E.id||T.idx-E.idx),a=a.filter((T,E,A)=>E===A.findIndex(R=>R.id===T.id&&R.idx===T.idx));let f=new Array,g=0,y=a.length;for(let T of h){if(T.constantHeight){f.push(new Ci(T.id,T.bounds,T.constantHeight));continue}for(;g!==y&&a[g].id<T.id;)g++;if(g===y||a[g].id!==T.id)continue;let E=new Array,A=new Array,R=g;for(;g!==y&&a[g].id===T.id;){let L=a[g];if(E.push({position:L.position,height:L.height,extent:L.extent}),g!==R&&a[g-1].idx===L.idx-1){let k=g-R;A.push({a:k-1,b:k})}g++}f.push(new Ci(T.id,T.bounds,void 0,E,A,u))}return f}static getElevationFeature(e,i){if(!i)return;let s=+e.properties[yt];return Number.isNaN(s)?void 0:i.find(a=>a.id===s)}}class bi{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*ht,this.yOffset=(e.y*this.zScale-i.y)*ht)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,s){let a=this.constantElevation(i,s);return a??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),s))}computeBiasedHeight(e,i){return i<=0?e:e+i*ye(0,i,e>=0?e:Math.abs(.5*e))}}Tt(Ci,"ElevationFeature");class Li{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Zn,this.indexArray=new ur,this.segments=new gr,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Ba),this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){let h=this.layers[0],u=[],f=null;h.type==="circle"&&(f=h.layout.get("circle-sort-key"));for(let{feature:y,id:T,index:E,sourceLayerIndex:A}of e){let R=this.layers[0]._featureFilter.needGeometry,L=ke(y,R);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),L,s))continue;let k=f?f.evaluate(L,{},s):void 0,B={id:T,properties:y.properties,type:y.type,sourceLayerIndex:A,index:E,geometry:R?L.geometry:me(y,s,a),patterns:{},sortKey:k};u.push(B)}f&&u.sort((y,T)=>y.sortKey-T.sortKey);let g=null;a.projection.name==="globe"&&(this.globeExtVertexArray=new yu,g=a.projection);for(let y of u){let{geometry:T,index:E,sourceLayerIndex:A}=y,R=e[E].feature;this.addFeature(y,T,E,i.availableImages,s,g,i.brightness,i.elevationFeatures),i.featureIndex.insert(R,T,E,A,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,s,a,h,u,f){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Pm.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Bg.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Fg.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,s,a,h,u,f,g){let y;this.elevationMode!=="none"&&(y=yr.getElevationFeature(e,g));for(let T of i)for(let E of T){let A=E.x,R=E.y;if(A<0||A>=ht||R<0||R>=ht)continue;if(u){let B=u.projectTilePoint(A,R,h),G=u.upVector(h,A,R);this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G)}let L=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),k=L.vertexLength;if(this.addCircleVertex(A,R,-1,-1),this.addCircleVertex(A,R,1,-1),this.addCircleVertex(A,R,1,1),this.addCircleVertex(A,R,-1,1),this.elevationMode!=="none"){let B=y?y.pointElevation(new Qe(A,R)):0;this.hasElevation=this.hasElevation||B!==0;for(let G=0;G<4;G++)this.elevatedLayoutVertexArray.emplaceBack(B)}this.indexArray.emplaceBack(k,k+1,k+2),this.indexArray.emplaceBack(k,k+2,k+3),L.vertexLength+=4,L.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},a,h,f,void 0,this.worldview)}addCircleVertex(e,i,s,a){this.layoutVertexArray.emplaceBack(2*e+(s+1)/2,2*i+(a+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function $i(r,e){for(let i=0;i<r.length;i++)if(xn(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(xn(r,e[i]))return!0;return!!hn(r,e)}function kr(r,e,i){return!!xn(r,e)||!!yn(e,r,i)}function Dr(r,e){if(r.length===1)return Vo(e,r[0]);for(let i=0;i<e.length;i++){let s=e[i];for(let a=0;a<s.length;a++)if(xn(r,s[a]))return!0}for(let i=0;i<r.length;i++)if(Vo(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(hn(r,e[i]))return!0;return!1}function Br(r,e,i){if(r.length>1){if(hn(r,e))return!0;for(let s=0;s<e.length;s++)if(yn(e[s],r,i))return!0}for(let s=0;s<r.length;s++)if(yn(r[s],e,i))return!0;return!1}function hn(r,e){if(r.length===0||e.length===0)return!1;for(let i=0;i<r.length-1;i++){let s=r[i],a=r[i+1];for(let h=0;h<e.length-1;h++)if(Jo(s,a,e[h],e[h+1]))return!0}return!1}function Jo(r,e,i,s){return Mr(r,i,s)!==Mr(e,i,s)&&Mr(r,e,i)!==Mr(r,e,s)}function kn(r,e,i){return(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x)}function to(r,e,i,s){let a=kn(r,e,s),h=kn(r,e,i);if(Math.sign(a)===Math.sign(h))return;let u=kn(i,s,r),f=u+h-a;return Math.sign(u)!==Math.sign(f)?[u/(u-f),h/(h-a)]:void 0}function yn(r,e,i){let s=i*i;if(e.length===1)return r.distSqr(e[0])<s;for(let a=1;a<e.length;a++)if(bo(r,e[a-1],e[a])<s)return!0;return!1}function bo(r,e,i){let s=e.distSqr(i);if(s===0)return r.distSqr(e);let a=((r.x-e.x)*(i.x-e.x)+(r.y-e.y)*(i.y-e.y))/s;return r.distSqr(a<0?e:a>1?i:i.sub(e)._mult(a)._add(e))}function Vo(r,e){let i,s,a,h=!1;for(let u=0;u<r.length;u++){i=r[u];for(let f=0,g=i.length-1;f<i.length;g=f++)s=i[f],a=i[g],s.y>e.y!=a.y>e.y&&e.x<(a.x-s.x)*(e.y-s.y)/(a.y-s.y)+s.x&&(h=!h)}return h}function xn(r,e){let i=!1;for(let s=0,a=r.length-1;s<r.length;a=s++){let h=r[s],u=r[a];h.y>e.y!=u.y>e.y&&e.x<(u.x-h.x)*(e.y-h.y)/(u.y-h.y)+h.x&&(i=!i)}return i}function Cr(r,e,i,s,a){for(let u of r)if(e<=u.x&&i<=u.y&&s>=u.x&&a>=u.y)return!0;let h=[new Qe(e,i),new Qe(e,a),new Qe(s,a),new Qe(s,i)];if(r.length>2){for(let u of h)if(xn(r,u))return!0}for(let u=0;u<r.length-1;u++)if(Sr(r[u],r[u+1],h))return!0;return!1}function Sr(r,e,i){let s=i[0],a=i[2];if(r.x<s.x&&e.x<s.x||r.x>a.x&&e.x>a.x||r.y<s.y&&e.y<s.y||r.y>a.y&&e.y>a.y)return!1;let h=Mr(r,e,i[0]);return h!==Mr(r,e,i[1])||h!==Mr(r,e,i[2])||h!==Mr(r,e,i[3])}function Ki(r,e,i,s,a,h){let u=e.y-r.y,f=r.x-e.x;if(h=h||0){let g=u*u+f*f;if(g===0)return!0;let y=Math.sqrt(g);u/=y,f/=y}return!((i.x-r.x)*u+(i.y-r.y)*f-h<0||(s.x-r.x)*u+(s.y-r.y)*f-h<0||(a.x-r.x)*u+(a.y-r.y)*f-h<0)}function Wr(r,e,i,s,a,h,u){return!(Ki(r,e,s,a,h,u)||Ki(e,i,s,a,h,u)||Ki(i,r,s,a,h,u)||Ki(s,a,r,e,i,u)||Ki(a,h,r,e,i,u)||Ki(h,s,r,e,i,u))}function un(r,e,i){let s=e.paint.get(r).value;return s.kind==="constant"?s.value:i.programConfigurations.get(e.id).getMaxValue(r)}function Pr(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function wo(r,e,i,s,a){if(!e[0]&&!e[1])return r;let h=Qe.convert(e)._mult(a);i==="viewport"&&h._rotate(-s);let u=[];for(let f=0;f<r.length;f++)u.push(r[f].sub(h));return u}function Va(r,e,i,s){let a=Qe.convert(r)._mult(s);return e==="viewport"&&a._rotate(-i),a}let ca,kl;function Fl(r,e,i){var s=2*Math.PI*6378137/256/Math.pow(2,i);return[r*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}Tt(Li,"CircleBucket",{omit:["layers"]});class To{constructor(e,i,s){this.z=e,this.x=i,this.y=s,this.key=So(0,e,e,i,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){let i=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>i&&e.y===this.y>>i}url(e,i){let s=function(h,u,f){var g=Fl(256*h,256*(u=Math.pow(2,f)-u-1),f),y=Fl(256*(h+1),256*(u+1),f);return g[0]+","+g[1]+","+y[0]+","+y[1]}(this.x,this.y,this.z),a=function(h,u,f){let g,y="";for(let T=h;T>0;T--)g=1<<T-1,y+=(u&g?1:0)+(f&g?2:0);return y}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",a).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class us{constructor(e,i){this.wrap=e,this.canonical=i,this.key=So(e,i.z,i.z,i.x,i.y)}}class Xr{constructor(e,i,s,a,h){this.overscaledZ=e,this.wrap=i,this.canonical=new To(s,+a,+h),this.key=i===0&&e===s?this.canonical.key:So(i,e,s,a,h)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){let i=this.canonical.z-e;return e>this.canonical.z?new Xr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Xr(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return So(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{let s=this.canonical.z-e;return So(this.wrap*+i,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;let i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new Xr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let i=this.canonical.z+1,s=2*this.canonical.x,a=2*this.canonical.y;return[new Xr(i,this.wrap,i,s,a),new Xr(i,this.wrap,i,s+1,a),new Xr(i,this.wrap,i,s,a+1),new Xr(i,this.wrap,i,s+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Xr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Xr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new us(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function So(r,e,i,s,a){let h=1<<Math.min(i,22),u=h*(a%h)+s%h;return r&&i<22&&(u+=h*h*((r<0?-2*r-1:2*r)%(1<<2*(22-i)))),16*(32*u+i)+(e-i)}let Ua=[r=>{let e=r.canonical.x-1,i=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,i--),new Xr(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,i=r.wrap;return e===1<<r.canonical.z&&(e=0,i++),new Xr(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>new Xr(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new Xr(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];Tt(To,"CanonicalTileID"),Tt(Xr,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let AE=gi([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:km}=AE,ME=gi([{name:"a_pos_3",components:3,type:"Int16"}]);var Ox=gi([{name:"a_pos",type:"Int16",components:2}]);function Fm(r){return r*Cn/b}let CE=[new li([d,d,d],[p,p,p]),new li([d,d,d],[0,0,p]),new li([0,d,d],[p,0,p]),new li([d,0,d],[0,p,p]),new li([0,0,d],[p,p,p])];function kx(r,e,i,s=!0){let a=Xi([],r._camera.position,r.worldSize),h=[e,i,1,1];Kn(h,h,r.pixelMatrixInverse),vs(h,h,1/h[3]);let u=Oi([],zr([],h,a)),f=r.globeMatrix,g=[f[12],f[13],f[14]],y=zr([],g,a),T=Ni(y),E=Oi([],y),A=r.worldSize/(2*Math.PI),R=or(E,u),L=Math.asin(A/T);if(L<Math.acos(R)){if(!s)return null;let Ne=[],Ee=[];Xi(Ne,u,T/R),Oi(Ee,zr(Ee,Ne,y)),Oi(u,vi(u,y,Xi(u,Ee,Math.tan(L)*T)))}let k=[];new Si(a,u).closestPointOnSphere(g,A,k);let B=Oi([],wr(f,0)),G=Oi([],wr(f,1)),X=Oi([],wr(f,2)),W=or(B,k),K=or(G,k),pe=or(X,k),ce=Re(Math.asin(-K/A)),ue=Re(Math.atan2(W,pe));ue=r.center.lng+function(Ne,Ee){let Ue=(Ee-Ne+180)%360-180;return Ue<-180?Ue+360:Ue}(r.center.lng,ue);let ge=F(ue),ve=re(j(ce),0,1);return new le(ge,ve)}class PE{constructor(e,i,s){this.a=zr([],e,s),this.b=zr([],i,s),this.center=s;let a=Oi([],this.a),h=Oi([],this.b);this.angle=Math.acos(or(a,h))}}function $g(r,e){if(r.angle===0)return null;let i;return i=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),i<0||i>1?null:function(s,a,h,u){let f=Math.sin(h);return s*(Math.sin((1-u)*h)/f)+a*(Math.sin(u*h)/f)}(r.a[e],r.b[e],r.angle,re(i,0,1))+r.center[e]}function ha(r){if(r.z<=1)return CE[r.z+2*r.y+r.x];let e=Zg(Bm(r));return li.fromPoints(e)}function ja(r,e,i){return Xi(r,r,1-i),tn(r,r,e,i)}function Fx(r,e,i){for(let s of r)Lr(s,s,e),Xi(s,s,i)}function Bx(r,e,i,s){let a=e/r.worldSize,h=r.globeMatrix;if(i.z<=1){let ve=ha(i).getCorners();return Fx(ve,h,a),li.fromPoints(ve)}let u=Bm(i,s),f=Zg(u,Cn+Fm(r._tileCoverLift));Fx(f,h,a);let g=Number.MAX_VALUE,y=[-g,-g,-g],T=[g,g,g];if(u.contains(r.center)){for(let Ee of f)Rr(T,T,Ee),Hr(y,y,Ee);y[2]=0;let ve=r.point,Ne=[ve.x*a,ve.y*a,0];return Rr(T,T,Ne),Hr(y,y,Ne),new li(T,y)}if(r._tileCoverLift>0){for(let ve of f)Rr(T,T,ve),Hr(y,y,ve);return new li(T,y)}let E=[h[12]*a,h[13]*a,h[14]*a],A=u.getCenter(),R=re(r.center.lat,-ne,ne),L=re(A.lat,-ne,ne),k=F(r.center.lng),B=j(R),G=k-F(A.lng),X=B-j(L);G>.5?G-=1:G<-.5&&(G+=1);let W=0;Math.abs(G)>Math.abs(X)?W=G>=0?1:3:(W=X>=0?0:2,tn(E,E,[h[4]*a,h[5]*a,h[6]*a],-Math.sin(Ai(X>=0?u.getSouth():u.getNorth()))*Cn));let K=f[W],pe=f[(W+1)%4],ce=new PE(K,pe,E),ue=[$g(ce,0)||K[0],$g(ce,1)||K[1],$g(ce,2)||K[2]],ge=Bl(r.zoom);if(ge>0){let ve=function({x:Ee,y:Ue,z:nt},qe,Ke,it,Fe){let Je=1/(1<<nt),Ie=Ee*Je,Be=Ie+Je,at=Ue*Je,et=at+Je,Lt=0,St=(Ie+Be)/2-it;return St>.5?Lt=-1:St<-.5&&(Lt=1),Ie=((Ie+Lt)*qe-(it*=qe))*Ke+it,Be=((Be+Lt)*qe-it)*Ke+it,at=(at*qe-(Fe*=qe))*Ke+Fe,et=(et*qe-Fe)*Ke+Fe,[[Ie,et,0],[Be,et,0],[Be,at,0],[Ie,at,0]]}(i,e,r._pixelsPerMercatorPixel,k,B);for(let Ee=0;Ee<f.length;Ee++)ja(f[Ee],ve[Ee],ge);let Ne=vi([],ve[W],ve[(W+1)%4]);Xi(Ne,Ne,.5),ja(ue,Ne,ge)}for(let ve of f)Rr(T,T,ve),Hr(y,y,ve);return T[2]=Math.min(K[2],pe[2]),Rr(T,T,ue),Hr(y,y,ue),new li(T,y)}function Bm({x:r,y:e,z:i},s=!1){let a=1/(1<<i),h=new C(Z(r*a),e===(1<<i)-1&&s?-90:Y((e+1)*a)),u=new C(Z((r+1)*a),e===0&&s?90:Y(e*a));return new z(h,u)}function Zg(r,e=Cn){let i=Ai(r.getNorth()),s=Ai(r.getSouth()),a=Math.cos(i),h=Math.cos(s),u=Math.sin(i),f=Math.sin(s),g=r.getWest(),y=r.getEast();return[_(h,f,g,e),_(h,f,y,e),_(a,u,y,e),_(a,u,g,e)]}function Sp(r,e,i,s){let a=1<<i.z,h=(r/ht+i.x)/a;return x(Y((e/ht+i.y)/a),Z(h),s)}function Nm({min:r,max:e}){return t/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}let Nx=new Float64Array(16);function Vm(r){let e=Nm(r),i=wt(Nx,[e,e,e]);return We(i,i,Zo([],r.min))}function Wg(r){let e=(s=r.min,(i=Nx)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=s[0],i[13]=s[1],i[14]=s[2],i[15]=1,i);var i,s;let a=1/Nm(r);return ft(e,e,[a,a,a])}function Xg(r){let e=ht/(2*Math.PI);return r/(2*Math.PI)/e}function Vx(r,e){return ht/(512*Math.pow(2,r))*Nm(ha(e))}function Ux(r,e,i,s,a){let h=Xg(i),u=[r,e,-i/(2*Math.PI)],f=xe(new Float64Array(16));return We(f,f,u),ft(f,f,[h,h,h]),_t(f,f,Ai(-a)),Pt(f,f,Ai(-s)),f}function Bl(r){return ye(Om,l,r)}function jx(r,e){let i=x(e.lat,e.lng),s=function(L){let k=x(L._center.lat,L._center.lng),B=Vr([],yi(0,1,0),k),G=Ct([],-L.angle,k);B=Lr(B,B,G),Ct(G,-L._pitch,B);let X=Oi([],k);return Xi(X,X,Fm(L.cameraToCenterDistance/L.pixelsPerMeter)),Lr(X,X,G),vi([],k,X)}(r);return u=(a=mr([],s,i))[0],f=a[1],g=a[2],y=(h=i)[0],T=h[1],E=h[2],R=(A=Math.sqrt(u*u+f*f+g*g)*Math.sqrt(y*y+T*T+E*E))&&or(a,h)/A,Math.acos(Math.min(Math.max(R,-1),1));var a,h,u,f,g,y,T,E,A,R}function Yg(r,e){return jx(r,e)>Math.PI/2*1.01}let Gx=Ai(85),RE=Math.cos(Gx),LE=Math.sin(Gx),zE=Ae(),qx=r=>{let e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function Hx(r,e,i,s,a,h,u,f,g){if(h&&r.queryGeometry.isAboveHorizon)return!1;h&&(g*=r.pixelToTileUnitsFactor);let y=r.tileID.canonical,T=i.projection.upVectorScale(y,i.center.lat,i.worldSize).metersToTile;for(let E of e)for(let A of E){let R=A.add(f),L=a&&i.elevation?i.elevation.exaggeration()*a.getElevationAt(R.x,R.y,!0):0,k=i.projection.projectTilePoint(R.x,R.y,y);if(L>0){let W=i.projection.upVector(y,R.x,R.y);k.x+=W[0]*T*L,k.y+=W[1]*T*L,k.z+=W[2]*T*L}let B=h?R:DE(k.x,k.y,k.z,s),G=h?r.tilespaceRays.map(W=>kE(W,L)):r.queryGeometry.screenGeometry,X=Kn([],[k.x,k.y,k.z,1],s);if(!u&&h?g*=X[3]/i.cameraToCenterDistance:u&&!h&&(g*=i.cameraToCenterDistance/X[3]),h){let W=Y((A.y/ht+y.y)/(1<<y.z));g/=i.projection.pixelsPerMeter(W,1)/U(1,W)}if(kr(G,B,g))return!0}return!1}function DE(r,e,i,s){let a=Kn([],[r,e,i,1],s);return new Qe(a[0]/a[3],a[1]/a[3])}let $x=yi(0,0,0),OE=yi(0,0,1);function kE(r,e){let i=mt();return $x[2]=e,r.intersectsPlane($x,OE,i),new Qe(i[0],i[1])}class Zx extends Li{}let Wx,Xx,Yx,Kx;function Jx(r,{width:e,height:i},s,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*i*s)throw new RangeError("mismatched image size")}else a=new Uint8Array(e*i*s);return r.width=e,r.height=i,r.data=a,r}function Qx(r,e,i){let{width:s,height:a}=e;s===r.width&&a===r.height||(Kg(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,s),height:Math.min(r.height,a)},i,null),r.width=s,r.height=a,r.data=e.data)}function Kg(r,e,i,s,a,h,u,f){if(a.width===0||a.height===0)return e;if(a.width>r.width||a.height>r.height||i.x>r.width-a.width||i.y>r.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||s.x>e.width-a.width||s.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");let g=r.data,y=e.data,T=h===4&&f;for(let E=0;E<a.height;E++){let A=((i.y+E)*r.width+i.x)*h,R=((s.y+E)*e.width+s.x)*h;if(T)for(let L=0;L<a.width;L++){let k=A+L*h+3,B=R+L*h;y[B+0]=255,y[B+1]=255,y[B+2]=255,y[B+3]=g[k]}else if(u)for(let L=0;L<a.width;L++){let k=A+L*h,B=R+L*h,G=new ki(g[k+0]/255,g[k+1]/255,g[k+2]/255,g[k+3]).toNonPremultipliedRenderColor(u).toArray();y[B+0]=G[0],y[B+1]=G[1],y[B+2]=G[2],y[B+3]=G[3]}else for(let L=0;L<a.width*h;L++)y[R+L]=g[A+L]}return e}Tt(Zx,"HeatmapBucket",{omit:["layers"]});class Nl{constructor(e,i){Jx(this,e,1,i)}resize(e){Qx(this,new Nl(e),1)}clone(){return new Nl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,h){Kg(e,i,s,a,h,1,null)}}class vn{constructor(e,i){Jx(this,e,4,i)}resize(e){Qx(this,new vn(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new vn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,h,u,f){Kg(e,i,s,a,h,4,u,f)}}class ev{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function Ep(r){let e={},i=r.resolution||256,s=r.clips?r.clips.length:1,a=r.image||new vn({width:i,height:s}),h=(u,f,g)=>{e[r.evaluationKey]=g;let y=r.expression.evaluate(e),T=y?y.toNonPremultipliedRenderColor(null):null;T&&(a.data[u+f+0]=Math.floor(255*T.r),a.data[u+f+1]=Math.floor(255*T.g),a.data[u+f+2]=Math.floor(255*T.b),a.data[u+f+3]=Math.floor(255*T.a))};if(r.clips)for(let u=0,f=0;u<s;++u,f+=4*i)for(let g=0,y=0;g<i;g++,y+=4){let T=g/(i-1),{start:E,end:A}=r.clips[u];h(f,y,E*(1-T)+A*T)}else for(let u=0,f=0;u<i;u++,f+=4)h(0,f,u/(i-1));return a}Tt(Nl,"AlphaImage"),Tt(vn,"RGBAImage");let FE=gi([{name:"a_pos",components:2,type:"Int16"}],4),BE=gi([{name:"a_road_z_offset",components:1,type:"Float32"}],4),NE=gi([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),VE=gi([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Au(r,e,i=2){let s=e&&e.length,a=s?e[0]*i:r.length,h=tv(r,0,a,i,!0),u=[];if(!h||h.next===h.prev)return u;let f,g,y;if(s&&(h=function(T,E,A,R){let L=[];for(let k=0,B=E.length;k<B;k++){let G=tv(T,E[k]*R,k<B-1?E[k+1]*R:T.length,R,!1);G===G.next&&(G.steiner=!0),L.push(WE(G))}L.sort(HE);for(let k=0;k<L.length;k++)A=$E(L[k],A);return A}(r,e,h,i)),r.length>80*i){f=r[0],g=r[1];let T=f,E=g;for(let A=i;A<a;A+=i){let R=r[A],L=r[A+1];R<f&&(f=R),L<g&&(g=L),R>T&&(T=R),L>E&&(E=L)}y=Math.max(T-f,E-g),y=y!==0?32767/y:0}return Ip(h,u,i,f,g,y,0),u}function tv(r,e,i,s,a){let h;if(a===function(u,f,g,y){let T=0;for(let E=f,A=g-y;E<g;E+=y)T+=(u[A]-u[E])*(u[E+1]+u[A+1]),A=E;return T}(r,e,i,s)>0)for(let u=e;u<i;u+=s)h=ov(u/s|0,r[u],r[u+1],h);else for(let u=i-s;u>=e;u-=s)h=ov(u/s|0,r[u],r[u+1],h);return h&&Mu(h,h.next)&&(Cp(h),h=h.next),h}function th(r,e){if(!r)return r;e||(e=r);let i,s=r;do if(i=!1,s.steiner||!Mu(s,s.next)&&on(s.prev,s,s.next)!==0)s=s.next;else{if(Cp(s),s=e=s.prev,s===s.next)break;i=!0}while(i||s!==e);return e}function Ip(r,e,i,s,a,h,u){if(!r)return;!u&&h&&function(g,y,T,E){let A=g;do A.z===0&&(A.z=Jg(A.x,A.y,y,T,E)),A.prevZ=A.prev,A.nextZ=A.next,A=A.next;while(A!==g);A.prevZ.nextZ=null,A.prevZ=null,function(R){let L,k=1;do{let B,G=R;R=null;let X=null;for(L=0;G;){L++;let W=G,K=0;for(let ce=0;ce<k&&(K++,W=W.nextZ,W);ce++);let pe=k;for(;K>0||pe>0&&W;)K!==0&&(pe===0||!W||G.z<=W.z)?(B=G,G=G.nextZ,K--):(B=W,W=W.nextZ,pe--),X?X.nextZ=B:R=B,B.prevZ=X,X=B;G=W}X.nextZ=null,k*=2}while(L>1)}(A)}(r,s,a,h);let f=r;for(;r.prev!==r.next;){let g=r.prev,y=r.next;if(h?jE(r,s,a,h):UE(r))e.push(g.i,r.i,y.i),Cp(r),r=y.next,f=y.next;else if((r=y)===f){u?u===1?Ip(r=GE(th(r),e),e,i,s,a,h,2):u===2&&qE(r,e,i,s,a,h):Ip(th(r),e,i,s,a,h,1);break}}}function UE(r){let e=r.prev,i=r,s=r.next;if(on(e,i,s)>=0)return!1;let a=e.x,h=i.x,u=s.x,f=e.y,g=i.y,y=s.y,T=Math.min(a,h,u),E=Math.min(f,g,y),A=Math.max(a,h,u),R=Math.max(f,g,y),L=s.next;for(;L!==e;){if(L.x>=T&&L.x<=A&&L.y>=E&&L.y<=R&&Ap(a,f,h,g,u,y,L.x,L.y)&&on(L.prev,L,L.next)>=0)return!1;L=L.next}return!0}function jE(r,e,i,s){let a=r.prev,h=r,u=r.next;if(on(a,h,u)>=0)return!1;let f=a.x,g=h.x,y=u.x,T=a.y,E=h.y,A=u.y,R=Math.min(f,g,y),L=Math.min(T,E,A),k=Math.max(f,g,y),B=Math.max(T,E,A),G=Jg(R,L,e,i,s),X=Jg(k,B,e,i,s),W=r.prevZ,K=r.nextZ;for(;W&&W.z>=G&&K&&K.z<=X;){if(W.x>=R&&W.x<=k&&W.y>=L&&W.y<=B&&W!==a&&W!==u&&Ap(f,T,g,E,y,A,W.x,W.y)&&on(W.prev,W,W.next)>=0||(W=W.prevZ,K.x>=R&&K.x<=k&&K.y>=L&&K.y<=B&&K!==a&&K!==u&&Ap(f,T,g,E,y,A,K.x,K.y)&&on(K.prev,K,K.next)>=0))return!1;K=K.nextZ}for(;W&&W.z>=G;){if(W.x>=R&&W.x<=k&&W.y>=L&&W.y<=B&&W!==a&&W!==u&&Ap(f,T,g,E,y,A,W.x,W.y)&&on(W.prev,W,W.next)>=0)return!1;W=W.prevZ}for(;K&&K.z<=X;){if(K.x>=R&&K.x<=k&&K.y>=L&&K.y<=B&&K!==a&&K!==u&&Ap(f,T,g,E,y,A,K.x,K.y)&&on(K.prev,K,K.next)>=0)return!1;K=K.nextZ}return!0}function GE(r,e){let i=r;do{let s=i.prev,a=i.next.next;!Mu(s,a)&&rv(s,i,i.next,a)&&Mp(s,a)&&Mp(a,s)&&(e.push(s.i,i.i,a.i),Cp(i),Cp(i.next),i=r=a),i=i.next}while(i!==r);return th(i)}function qE(r,e,i,s,a,h){let u=r;do{let f=u.next.next;for(;f!==u.prev;){if(u.i!==f.i&&XE(u,f)){let g=nv(u,f);return u=th(u,u.next),g=th(g,g.next),Ip(u,e,i,s,a,h,0),void Ip(g,e,i,s,a,h,0)}f=f.next}u=u.next}while(u!==r)}function HE(r,e){let i=r.x-e.x;return i===0&&(i=r.y-e.y,i===0)&&(i=(r.next.y-r.y)/(r.next.x-r.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function $E(r,e){let i=function(a,h){let u=h,f=a.x,g=a.y,y,T=-1/0;if(Mu(a,u))return u;do{if(Mu(a,u.next))return u.next;if(g<=u.y&&g>=u.next.y&&u.next.y!==u.y){let k=u.x+(g-u.y)*(u.next.x-u.x)/(u.next.y-u.y);if(k<=f&&k>T&&(T=k,y=u.x<u.next.x?u:u.next,k===f))return y}u=u.next}while(u!==h);if(!y)return null;let E=y,A=y.x,R=y.y,L=1/0;u=y;do{if(f>=u.x&&u.x>=A&&f!==u.x&&iv(g<R?f:T,g,A,R,g<R?T:f,g,u.x,u.y)){let k=Math.abs(g-u.y)/(f-u.x);Mp(u,a)&&(k<L||k===L&&(u.x>y.x||u.x===y.x&&ZE(y,u)))&&(y=u,L=k)}u=u.next}while(u!==E);return y}(r,e);if(!i)return e;let s=nv(i,r);return th(s,s.next),th(i,i.next)}function ZE(r,e){return on(r.prev,r,e.prev)<0&&on(e.next,r,r.next)<0}function Jg(r,e,i,s,a){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-i)*a|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function WE(r){let e=r,i=r;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==r);return i}function iv(r,e,i,s,a,h,u,f){return(a-u)*(e-f)>=(r-u)*(h-f)&&(r-u)*(s-f)>=(i-u)*(e-f)&&(i-u)*(h-f)>=(a-u)*(s-f)}function Ap(r,e,i,s,a,h,u,f){return!(r===u&&e===f)&&iv(r,e,i,s,a,h,u,f)}function XE(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!function(i,s){let a=i;do{if(a.i!==i.i&&a.next.i!==i.i&&a.i!==s.i&&a.next.i!==s.i&&rv(a,a.next,i,s))return!0;a=a.next}while(a!==i);return!1}(r,e)&&(Mp(r,e)&&Mp(e,r)&&function(i,s){let a=i,h=!1,u=(i.x+s.x)/2,f=(i.y+s.y)/2;do a.y>f!=a.next.y>f&&a.next.y!==a.y&&u<(a.next.x-a.x)*(f-a.y)/(a.next.y-a.y)+a.x&&(h=!h),a=a.next;while(a!==i);return h}(r,e)&&(on(r.prev,r,e.prev)||on(r,e.prev,e))||Mu(r,e)&&on(r.prev,r,r.next)>0&&on(e.prev,e,e.next)>0)}function on(r,e,i){return(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y)}function Mu(r,e){return r.x===e.x&&r.y===e.y}function rv(r,e,i,s){let a=jm(on(r,e,i)),h=jm(on(r,e,s)),u=jm(on(i,s,r)),f=jm(on(i,s,e));return a!==h&&u!==f||!(a!==0||!Um(r,i,e))||!(h!==0||!Um(r,s,e))||!(u!==0||!Um(i,r,s))||!(f!==0||!Um(i,e,s))}function Um(r,e,i){return e.x<=Math.max(r.x,i.x)&&e.x>=Math.min(r.x,i.x)&&e.y<=Math.max(r.y,i.y)&&e.y>=Math.min(r.y,i.y)}function jm(r){return r>0?1:r<0?-1:0}function Mp(r,e){return on(r.prev,r,r.next)<0?on(r,e,r.next)>=0&&on(r,r.prev,e)>=0:on(r,e,r.prev)<0||on(r,r.next,e)<0}function nv(r,e){let i=Qg(r.i,r.x,r.y),s=Qg(e.i,e.x,e.y),a=r.next,h=e.prev;return r.next=e,e.prev=r,i.next=a,a.prev=i,s.next=i,i.prev=s,h.next=s,s.prev=h,s}function ov(r,e,i,s){let a=Qg(r,e,i);return s?(a.next=s.next,a.prev=s,s.next.prev=a,s.next=a):(a.prev=a,a.next=a),a}function Cp(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Qg(r,e,i){return{i:r,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Pp(r,e){let i=r.length;if(i<=1)return[r];let s=[],a,h;for(let u=0;u<i;u++){let f=Qr(r[u]);f!==0&&(r[u].area=Math.abs(f),h===void 0&&(h=f<0),h===f<0?(a&&s.push(a),a=[r[u]]):a.push(r[u]))}if(a&&s.push(a),e>1)for(let u=0;u<s.length;u++)s[u].length<=e||(An(s[u],e,1,s[u].length-1,YE),s[u]=s[u].slice(0,e));return s}function YE(r,e){return e.area-r.area}function sv(r,e,i=1){if(!r)return null;let s=typeof r=="string"?qn.from(r).getPrimary():r.getPrimary(),a=typeof r=="string"?null:r.getSecondary();for(let h of[s,a]){if(!h)continue;let u=h.id.toString();e.has(u)||e.set(u,[]),h.scaleSelf(i),e.get(u).push(h)}return{primary:s.toString(),secondary:a?a.toString():null}}function ey(r,e,i,s){let a=s.patternDependencies,h=!1;for(let u of e){let f=u.paint.get(`${r}-pattern`);f.isConstant()||(h=!0),sv(f.constantOr(null),a,i)&&(h=!0)}return h}function ty(r,e,i,s,a,h){let u=h.patternDependencies;for(let f of e){let g=f.paint.get(`${r}-pattern`).value;if(g.kind!=="constant"){let y=g.evaluate({zoom:s},i,{},h.availableImages);y=y&&y.name?y.name:y;let T=sv(y,u,a);if(!T)continue;let{primary:E,secondary:A}=T;E&&(i.patterns[f.id]=[E,A].filter(Boolean))}}return i}class av{constructor(){this.polygons=new Map}add(e,...i){this.polygons.has(e)?this.polygons.get(e).push(...i):this.polygons.set(e,i)}merge(e){for(let[i,s]of e.polygons)this.add(i,...s)}}class ih{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new ih;let i=[];for(let y of e)i.push(...y.portals);if(i.length===0)return new ih;let s=(y,T)=>y<=0&&T<=0||y>=ht&&T>=ht;for(let y of i){let T=y.va,E=y.vb;(s(T.x,E.x)||s(T.y,E.y))&&(y.type="border")}let a=i.filter(y=>y.type!=="unevaluated"),h=i.filter(y=>y.type==="unevaluated");if(h.length===0)return new ih;h.sort((y,T)=>y.hash===T.hash?y.isTunnel===T.isTunnel?0:y.isTunnel?-1:1:y.hash<T.hash?1:-1),i=a.concat(h);let u=a.length,f=u,g=u;do if(f++,f===i.length||i[u].hash!==i[f].hash){if(f-u==2){g<u&&(i[g]=i[u],i[u]=null);let y=i[g],T=i[f-1];y.type=y.isTunnel!==T.isTunnel?"tunnel":"polygon",y.connection={a:y.connection.a,b:T.connection.a},g++}u=f}while(u!==i.length);return i.splice(g),i.sort((y,T)=>y.hash<T.hash?1:-1),{portals:i}}}Tt(ih,"ElevationPortalGraph"),Tt(av,"ElevationPolygons");class KE{constructor(e,i,s){this.outPositions=e,this.outNormals=i,this.outIndices=s,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,i,s){let a=e[2];s!=null&&(a*=s);let h=this.getVec3Bits(e)<<96n|this.getVec3Bits(i),u=this.vertexLookup.get(h);if(u!=null)return u;let f=this.outPositions.length;this.vertexLookup.set(h,f);let g=Math.trunc(16384*i[0]),y=Math.trunc(16384*i[1]),T=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],a),this.outNormals.emplaceBack(g,y,T),f}addTriangle(e,i,s){this.outIndices.emplaceBack(e,i,s)}addTriangles(e,i,s){if(e.length===0)return;let a=s.length===1,h=mt(),u=mt();for(let f=0;f<e.length;f+=3){let g=i[e[f+0]],y=i[e[f+1]],T=i[e[f+2]],E=a?s[0]:s[e[f+1]],A=a?s[0]:s[e[f+2]];mi(h,g.x,g.y,a?s[0]:s[e[f+0]]);let R=this.addVertex(h,u);mi(h,y.x,y.y,E);let L=this.addVertex(h,u);mi(h,T.x,T.y,A);let k=this.addVertex(h,u);this.outIndices.emplaceBack(R,L,k)}}addQuad(e,i,s,a,h,u){let f=this.addVertex(e,h,u),g=this.addVertex(i,h,u),y=this.addVertex(s,h,u),T=this.addVertex(a,h,u);this.addTriangle(f,g,y),this.addTriangle(y,T,f)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class Eo{constructor(e,i,s,a){this.unevaluatedPortals=new ih,this.portalPolygons=new av,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new op,this.vertexNormals=new sp,this.indexArray=new ur,this.tileToMeters=se(e),this.bridgeProgramConfigurations=new vo(i,{zoom:s,lut:a},h=>h!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new vo(i,{zoom:s,lut:a},h=>h!=="fill-bridge-guard-rail-color")}addVertices(e,i){let s=this.unevalVertices.length;for(let a=0;a<e.length;a++)this.unevalVertices.push(e[a]),this.unevalHeights.push(i[a]);return s}addTriangles(e,i,s){let a=s?this.unevalTunnelTriangles:this.unevalTriangles;for(let h of e)a.push(h+i)}addRenderableRing(e,i,s,a,h,u){let f=[new Qe(h.min.x,h.min.y),new Qe(h.max.x,h.min.y),new Qe(h.max.x,h.max.y),new Qe(h.min.x,h.max.y)];for(let g=0;g<s-1;g++){let y=i+g,T=y+1,E=this.unevalVertices[y],A=this.unevalVertices[T];if(!(E.x>=h.min.x&&E.x<=h.max.x&&E.y>=h.min.y&&E.y<=h.max.y||A.x>=h.min.x&&A.x<=h.max.x&&A.y>=h.min.y&&A.y<=h.max.y||Sr(E,A,f))||this.isOnBorder(E.x,A.x)||this.isOnBorder(E.y,A.y))continue;let R=Eo.computeEdgeHash(this.unevalVertices[y],this.unevalVertices[T]),L,k=this.vertexHashLookup.get(Eo.computePosHash(E));k!=null?L=k.next:(k=this.vertexHashLookup.get(Eo.computePosHash(A)),L=k!=null?k.prev:R),this.unevalEdges.push({polygonIdx:e,a:y,b:T,hash:R,portalHash:L,isTunnel:a,type:"unevaluated",featureInfo:u})}}addPortalCandidates(e,i,s,a,h){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:h});let u=i[0];this.vertexHashLookup.clear();let f=Eo.computeEdgeHash(u[u.length-2],u[u.length-1]);for(let g=0;g<u.length-1;g++){let y=u[g+0],T=u[g+1],E=uo(T.x-y.x,T.y-y.y),A=js(E);if(A===0)continue;let R="unevaluated",L=a.pointElevation(y),k=a.pointElevation(T);Math.abs(L)<.01&&Math.abs(k)<.01?R="entrance":(this.isOnBorder(y.x,T.x)||this.isOnBorder(y.y,T.y))&&(R="border");let B=Eo.computeEdgeHash(y,T);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:y,vb:T,vab:E,length:A,hash:B,isTunnel:s,type:R});let G=Eo.computePosHash(y);this.vertexHashLookup.set(G,{prev:f,next:B}),f=B}}construct(e){if(this.unevalVertices.length===0)return;let i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),s=A=>{A.primitiveLength=this.indexArray.length-A.primitiveOffset},a=new KE(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);let h=i(),u=i(),f=i(),g=(A,R)=>{A.sort((k,B)=>k.type===R&&B.type!==R?-1:k.type!==R&&B.type===R?1:0);let L=A.findIndex(k=>k.type!==R);return L>=0?L:A.length},y=0;this.unevalEdges.length>0&&(y=g(this.unevalEdges,"none"),this.constructBridgeStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:y},this.tileToMeters)),s(f);let T=i(),E=i();if(this.unevalEdges.length>0){let A=this.unevalEdges.splice(y),R=g(A,"tunnel")+y;this.unevalEdges.push(...A),this.constructTunnelStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:y},{min:y,max:R})}s(T),a.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),s(E),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),s(u),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),s(h),this.maskSegments=gr.simpleSegment(0,E.primitiveOffset,0,E.primitiveLength),this.depthSegments=gr.simpleSegment(0,u.primitiveOffset,0,u.primitiveLength),this.renderableBridgeSegments=gr.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength),this.renderableTunnelSegments=gr.simpleSegment(0,T.primitiveOffset,0,T.primitiveLength),this.shadowCasterSegments=gr.simpleSegment(0,h.primitiveOffset,0,h.primitiveLength)}update(e,i,s,a,h,u,f,g){this.bridgeProgramConfigurations.updatePaintArrays(e,i,h,s,a,u,f,g),this.tunnelProgramConfigurations.updatePaintArrays(e,i,h,s,a,u,f,g)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,NE.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,VE.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,s,a,h){let u=(f,g)=>{for(let y=0;y<g.length-1;y++){let T=g[y].featureIndex,E=g[y+1].vertexStart,A=e.feature(T);f.populatePaintArrays(E,A,T,{},s,i,a,void 0,h)}};u(this.bridgeProgramConfigurations,this.bridgeFeatureSections),u(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,s,a,h){let u=new Map;for(let f=a;f<h;f++){let g=s[f],y=g.a,T=g.b,E=Eo.computePosHash(e[y]),A=Eo.computePosHash(e[T]),R=u.get(E);R||(R={},u.set(E,R));let L=u.get(A);L||(L={},u.set(A,L)),i[y]<=0&&i[T]<=0||(R.to=T,L.from=y)}return u}isTerminalVertex(e,i){let s=Eo.computePosHash(this.unevalVertices[e]),a=i.get(s);return!a||!a.from||!a.to}constructBridgeStructures(e,i,s,a,h,u){e.clearVertexLookup();let f=this.computeVertexConnections(i,s,a,h.min,h.max),g=1/u,y=.5*g,T=(Ke,it)=>mi(Ke,i[it].x,i[it].y,s[it]*g),E=mt(),A=mt(),R=mt(),L=mt(),k=mt(),B=(Ke,it)=>{let Fe=f.get(Eo.computePosHash(i[it])),Je=Fe.from,Ie=Fe.to;if(!Je||!Ie)return;T(E,Je),T(A,it),T(R,Ie),oc(L),Lo(E,A)||(zr(k,A,E),Oi(L,k)),Lo(R,A)||(zr(k,R,A),vi(L,L,Oi(k,k)));let Be=Ns(L);return Be>0?Xi(Ke,L,1/Be):void 0},G=Number.POSITIVE_INFINITY;this.sortSubarray(a,h.min,h.max,(Ke,it)=>Ke.featureInfo.featureIndex-it.featureInfo.featureIndex);let X=mt(),W=mt(),K=mt(),pe=mt(),ce=mt(),ue=mt(),ge=mt(),ve=mt(),Ne=mt(),Ee=[mt(),mt(),mt(),mt()],Ue=[mt(),mt(),mt(),mt()],nt=[{coord:new Qe(0,0),height:0},{coord:new Qe(0,0),height:0}],qe=(Ke,it)=>Ke>it;for(let Ke=h.min;Ke<h.max;Ke++){let it=a[Ke];if(!it.featureInfo.guardRailEnabled||!this.prepareEdgePoints(nt,i,s,it,qe))continue;let[Fe,Je]=nt;if(mi(X,Fe.coord.x,Fe.coord.y,g*Fe.height),mi(W,Je.coord.x,Je.coord.y,g*Je.height),Lo(X,W))continue;zr(K,W,X),Oi(K,K);let Ie=B(ve,it.a)||K,Be=B(Ne,it.b)||K;mi(pe,Ie[1],-Ie[0],0),Oi(pe,pe),mi(ce,Be[1],-Be[0],0),Oi(ce,ce),Vr(ve,pe,Ie),Oi(ue,ve),Vr(ve,ce,Be),Oi(ge,ve),vi(Ee[0],X,Xi(ve,zr(ve,pe,ue),y)),vi(Ee[1],X,Xi(ve,vi(ve,pe,ue),y)),vi(Ee[2],X,Xi(ve,ue,y)),Ee[3]=X,vi(Ue[0],W,Xi(ve,zr(ve,ce,ge),y)),vi(Ue[1],W,Xi(ve,vi(ve,ce,ge),y)),vi(Ue[2],W,Xi(ve,ge,y)),Ue[3]=W,G=this.addFeatureSection(it.featureInfo.featureIndex,G,this.bridgeFeatureSections,e);let at=e.addVertex(Ee[0],pe,u),et=e.addVertex(Ee[1],pe,u),Lt=e.addVertex(Ue[0],ce,u),St=e.addVertex(Ue[1],ce,u);e.addTriangle(at,et,Lt),e.addTriangle(et,St,Lt);let Xe=e.addVertex(Ee[1],ue,u),tt=e.addVertex(Ee[2],ue,u),It=e.addVertex(Ue[1],ge,u),xt=e.addVertex(Ue[2],ge,u);e.addTriangle(Xe,tt,It),e.addTriangle(tt,xt,It),Zo(pe,pe),Zo(ce,ce);let ut=e.addVertex(Ee[2],pe,u),vt=e.addVertex(Ee[3],pe,u),Vt=e.addVertex(Ue[2],ce,u),Zt=e.addVertex(Ue[3],ce,u);e.addTriangle(ut,vt,Vt),e.addTriangle(vt,Zt,Vt);let Qt=this.isTerminalVertex(it.a,f),Kt=this.isTerminalVertex(it.b,f);Fe.height<.01&&Qt&&e.addQuad(Ee[3],Ee[2],Ee[1],Ee[0],Zo(Ie,Ie),u),Je.height<.01&&Kt&&e.addQuad(Ue[0],Ue[1],Ue[2],Ue[3],Be,u)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,s,a,h,u){e.clearVertexLookup();let f=Number.POSITIVE_INFINITY,g=(G,X)=>G.featureInfo.featureIndex-X.featureInfo.featureIndex;this.sortSubarray(a,h.min,h.max,g),this.sortSubarray(a,u.min,u.max,g);let y=G=>Oi(G,G),T=[{coord:new Qe(0,0),height:0},{coord:new Qe(0,0),height:0}],E=(G,X)=>G<X,A=mt(),R=mt(),L=mt(),k=mt(),B=mt();for(let G=h.min;G<h.max;G++){if(!this.prepareEdgePoints(T,i,s,a[G],E))continue;let[X,W]=T,K=y(mi(B,-(W.coord.y-X.coord.y),W.coord.x-X.coord.x,0));f=this.addFeatureSection(a[G].featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(mi(A,X.coord.x,X.coord.y,X.height),mi(R,W.coord.x,W.coord.y,W.height),mi(L,W.coord.x,W.coord.y,a[G].isTunnel?-.1:0),mi(k,X.coord.x,X.coord.y,a[G].isTunnel?-.1:0),K)}for(let G=u.min;G<u.max;G++){let X=a[G];X.isTunnel&&([X.a,X.b]=[X.b,X.a]);let W=i[X.a],K=i[X.b],pe=y(mi(B,-(K.y-W.y),K.x-W.x,0));f=this.addFeatureSection(X.featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(mi(A,K.x,K.y,0),mi(R,W.x,W.y,0),mi(L,W.x,W.y,s[X.a]+4),mi(k,K.x,K.y,s[X.b]+4),pe),e.addQuad(mi(A,W.x,W.y,0),mi(R,K.x,K.y,0),mi(L,K.x,K.y,s[X.b]+4),mi(k,W.x,W.y,s[X.a]+4),pe)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,i,s,a){e.coord.x=i,e.coord.y=s,e.height=a}prepareEdgePoints(e,i,s,a,h){let u=i[a.a].x,f=i[a.a].y,g=i[a.b].x,y=i[a.b].y,T=s[a.a],E=s[a.b],A=h(T,0),R=h(E,0);if(A&&R)return this.setElevatedPoint(e[0],u,f,T),this.setElevatedPoint(e[1],g,y,E),!0;if(!A&&!R)return!1;if(A){if(!R){let L=E/(E-T);g=Bt(g,u,L),y=Bt(y,f,L),E=Bt(E,T,L)}}else{let L=T/(T-E);u=Bt(u,g,L),f=Bt(f,y,L),T=Bt(T,E,L)}return this.setElevatedPoint(e[0],u,f,T),this.setElevatedPoint(e[1],g,y,E),!0}prepareEdges(e,i){if(i.length===0)return;i.sort((f,g)=>f.hash===g.hash?g.polygonIdx-f.polygonIdx:g.hash>f.hash?1:-1);let s=0,a=0,h=0,u=i[s].polygonIdx;do a++,(a===i.length||i[s].hash!==i[a].hash)&&((a-s==1||i[a-1].polygonIdx!==u)&&(h<s&&(i[h]=i[s],i[s]=null),i[h].type="none",h++),s=a,s!==i.length&&(u=i[s].polygonIdx));while(s!==i.length);if(i.splice(h),i.length!==0&&e.length!==0){i.sort((y,T)=>y.portalHash<T.portalHash?1:-1);let f=0,g=0;for(;f!==i.length&&g!==e.length;){let y=i[f],T=e[g];y.portalHash>T.hash?f++:T.hash>y.portalHash?g++:(y.type=T.type,f++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=ht&&i>=ht}addFeatureSection(e,i,s,a){return e!==i&&(i=e,s.push({featureIndex:e,vertexStart:a.getVertexCount()}),a.clearVertexLookup()),i}sortSubarray(e,i,s,a){let h=e.slice(i,s);h.sort(a),e.splice(i,h.length,...h)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(Eo.computePosHash(e))<<32n|BigInt(Eo.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var lv,cv={exports:{}},hv=(lv||(lv=1,function(r,e){(function(i){function s(ee,te){return ee>te?1:ee<te?-1:0}var a=function(ee,te){ee===void 0&&(ee=s),te===void 0&&(te=!1),this._compare=ee,this._root=null,this._size=0,this._noDuplicates=!!te},h={size:{configurable:!0}};function u(ee,te,Oe,lt,pt){var dt=pt-lt;if(dt>0){var Et=lt+Math.floor(dt/2),qt={key:te[Et],data:Oe[Et],parent:ee};return qt.left=u(qt,te,Oe,lt,Et),qt.right=u(qt,te,Oe,Et+1,pt),qt}return null}function f(ee,te,Oe,lt,pt){if(!(Oe>=lt)){for(var dt=ee[Oe+lt>>1],Et=Oe-1,qt=lt+1;;){do Et++;while(pt(ee[Et],dt)<0);do qt--;while(pt(ee[qt],dt)>0);if(Et>=qt)break;var ci=ee[Et];ee[Et]=ee[qt],ee[qt]=ci,ci=te[Et],te[Et]=te[qt],te[qt]=ci}f(ee,te,Oe,qt,pt),f(ee,te,qt+1,lt,pt)}}a.prototype.rotateLeft=function(ee){var te=ee.right;te&&(ee.right=te.left,te.left&&(te.left.parent=ee),te.parent=ee.parent),ee.parent?ee===ee.parent.left?ee.parent.left=te:ee.parent.right=te:this._root=te,te&&(te.left=ee),ee.parent=te},a.prototype.rotateRight=function(ee){var te=ee.left;te&&(ee.left=te.right,te.right&&(te.right.parent=ee),te.parent=ee.parent),ee.parent?ee===ee.parent.left?ee.parent.left=te:ee.parent.right=te:this._root=te,te&&(te.right=ee),ee.parent=te},a.prototype._splay=function(ee){for(;ee.parent;){var te=ee.parent;te.parent?te.left===ee&&te.parent.left===te?(this.rotateRight(te.parent),this.rotateRight(te)):te.right===ee&&te.parent.right===te?(this.rotateLeft(te.parent),this.rotateLeft(te)):te.left===ee&&te.parent.right===te?(this.rotateRight(te),this.rotateLeft(te)):(this.rotateLeft(te),this.rotateRight(te)):te.left===ee?this.rotateRight(te):this.rotateLeft(te)}},a.prototype.splay=function(ee){for(var te,Oe,lt,pt,dt;ee.parent;)(Oe=(te=ee.parent).parent)&&Oe.parent?((lt=Oe.parent).left===Oe?lt.left=ee:lt.right=ee,ee.parent=lt):(ee.parent=null,this._root=ee),pt=ee.left,dt=ee.right,ee===te.left?(Oe&&(Oe.left===te?(te.right?(Oe.left=te.right,Oe.left.parent=Oe):Oe.left=null,te.right=Oe,Oe.parent=te):(pt?(Oe.right=pt,pt.parent=Oe):Oe.right=null,ee.left=Oe,Oe.parent=ee)),dt?(te.left=dt,dt.parent=te):te.left=null,ee.right=te,te.parent=ee):(Oe&&(Oe.right===te?(te.left?(Oe.right=te.left,Oe.right.parent=Oe):Oe.right=null,te.left=Oe,Oe.parent=te):(dt?(Oe.left=dt,dt.parent=Oe):Oe.left=null,ee.right=Oe,Oe.parent=ee)),pt?(te.right=pt,pt.parent=te):te.right=null,ee.left=te,te.parent=ee)},a.prototype.replace=function(ee,te){ee.parent?ee===ee.parent.left?ee.parent.left=te:ee.parent.right=te:this._root=te,te&&(te.parent=ee.parent)},a.prototype.minNode=function(ee){if(ee===void 0&&(ee=this._root),ee)for(;ee.left;)ee=ee.left;return ee},a.prototype.maxNode=function(ee){if(ee===void 0&&(ee=this._root),ee)for(;ee.right;)ee=ee.right;return ee},a.prototype.insert=function(ee,te){var Oe=this._root,lt=null,pt=this._compare;if(this._noDuplicates)for(;Oe;){if(lt=Oe,pt(Oe.key,ee)===0)return;Oe=pt(Oe.key,ee)<0?Oe.right:Oe.left}else for(;Oe;)lt=Oe,Oe=pt(Oe.key,ee)<0?Oe.right:Oe.left;return Oe={key:ee,data:te,left:null,right:null,parent:lt},lt?pt(lt.key,Oe.key)<0?lt.right=Oe:lt.left=Oe:this._root=Oe,this.splay(Oe),this._size++,Oe},a.prototype.find=function(ee){for(var te=this._root,Oe=this._compare;te;){var lt=Oe(te.key,ee);if(lt<0)te=te.right;else{if(!(lt>0))return te;te=te.left}}return null},a.prototype.contains=function(ee){for(var te=this._root,Oe=this._compare;te;){var lt=Oe(ee,te.key);if(lt===0)return!0;te=lt<0?te.left:te.right}return!1},a.prototype.remove=function(ee){var te=this.find(ee);if(!te)return!1;if(this.splay(te),te.left)if(te.right){var Oe=this.minNode(te.right);Oe.parent!==te&&(this.replace(Oe,Oe.right),Oe.right=te.right,Oe.right.parent=Oe),this.replace(te,Oe),Oe.left=te.left,Oe.left.parent=Oe}else this.replace(te,te.left);else this.replace(te,te.right);return this._size--,!0},a.prototype.removeNode=function(ee){if(!ee)return!1;if(this.splay(ee),ee.left)if(ee.right){var te=this.minNode(ee.right);te.parent!==ee&&(this.replace(te,te.right),te.right=ee.right,te.right.parent=te),this.replace(ee,te),te.left=ee.left,te.left.parent=te}else this.replace(ee,ee.left);else this.replace(ee,ee.right);return this._size--,!0},a.prototype.erase=function(ee){var te=this.find(ee);if(te){this.splay(te);var Oe=te.left,lt=te.right,pt=null;Oe&&(Oe.parent=null,pt=this.maxNode(Oe),this.splay(pt),this._root=pt),lt&&(Oe?pt.right=lt:this._root=lt,lt.parent=pt),this._size--}},a.prototype.pop=function(){var ee=this._root,te=null;if(ee){for(;ee.left;)ee=ee.left;te={key:ee.key,data:ee.data},this.remove(ee.key)}return te},a.prototype.next=function(ee){var te=ee;if(te)if(te.right)for(te=te.right;te&&te.left;)te=te.left;else for(te=ee.parent;te&&te.right===ee;)ee=te,te=te.parent;return te},a.prototype.prev=function(ee){var te=ee;if(te)if(te.left)for(te=te.left;te&&te.right;)te=te.right;else for(te=ee.parent;te&&te.left===ee;)ee=te,te=te.parent;return te},a.prototype.forEach=function(ee){for(var te=this._root,Oe=[],lt=!1,pt=0;!lt;)te?(Oe.push(te),te=te.left):Oe.length>0?(ee(te=Oe.pop(),pt++),te=te.right):lt=!0;return this},a.prototype.range=function(ee,te,Oe,lt){for(var pt=[],dt=this._compare,Et=this._root;pt.length!==0||Et;)if(Et)pt.push(Et),Et=Et.left;else{if(dt((Et=pt.pop()).key,te)>0)break;if(dt(Et.key,ee)>=0&&Oe.call(lt,Et))return this;Et=Et.right}return this},a.prototype.keys=function(){for(var ee=this._root,te=[],Oe=[],lt=!1;!lt;)ee?(te.push(ee),ee=ee.left):te.length>0?(ee=te.pop(),Oe.push(ee.key),ee=ee.right):lt=!0;return Oe},a.prototype.values=function(){for(var ee=this._root,te=[],Oe=[],lt=!1;!lt;)ee?(te.push(ee),ee=ee.left):te.length>0?(ee=te.pop(),Oe.push(ee.data),ee=ee.right):lt=!0;return Oe},a.prototype.at=function(ee){for(var te=this._root,Oe=[],lt=!1,pt=0;!lt;)if(te)Oe.push(te),te=te.left;else if(Oe.length>0){if(te=Oe.pop(),pt===ee)return te;pt++,te=te.right}else lt=!0;return null},a.prototype.load=function(ee,te,Oe){if(ee===void 0&&(ee=[]),te===void 0&&(te=[]),Oe===void 0&&(Oe=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var lt=ee.length;return Oe&&f(ee,te,0,lt-1,this._compare),this._root=u(null,ee,te,0,lt),this._size=lt,this},a.prototype.min=function(){var ee=this.minNode(this._root);return ee?ee.key:null},a.prototype.max=function(){var ee=this.maxNode(this._root);return ee?ee.key:null},a.prototype.isEmpty=function(){return this._root===null},h.size.get=function(){return this._size},a.createTree=function(ee,te,Oe,lt,pt){return new a(Oe,pt).load(ee,te,lt)},Object.defineProperties(a.prototype,h);var g=0,y=1,T=2,E=3,A=0,R=1,L=2,k=3;function B(ee,te,Oe){te===null?(ee.inOut=!1,ee.otherInOut=!0):(ee.isSubject===te.isSubject?(ee.inOut=!te.inOut,ee.otherInOut=te.otherInOut):(ee.inOut=!te.otherInOut,ee.otherInOut=te.isVertical()?!te.inOut:te.inOut),te&&(ee.prevInResult=!G(te,Oe)||te.isVertical()?te.prevInResult:te));var lt=G(ee,Oe);ee.resultTransition=lt?function(pt,dt){var Et,qt=!pt.inOut,ci=!pt.otherInOut;switch(dt){case A:Et=qt&&ci;break;case R:Et=qt||ci;break;case k:Et=qt^ci;break;case L:Et=pt.isSubject?qt&&!ci:ci&&!qt}return Et?1:-1}(ee,Oe):0}function G(ee,te){switch(ee.type){case g:switch(te){case A:return!ee.otherInOut;case R:return ee.otherInOut;case L:return ee.isSubject&&ee.otherInOut||!ee.isSubject&&!ee.otherInOut;case k:return!0}break;case T:return te===A||te===R;case E:return te===L;case y:return!1}return!1}var X=function(ee,te,Oe,lt,pt){this.left=te,this.point=ee,this.otherEvent=Oe,this.isSubject=lt,this.type=pt||g,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},W={inResult:{configurable:!0}};function K(ee,te){return ee[0]===te[0]&&ee[1]===te[1]}X.prototype.isBelow=function(ee){var te=this.point,Oe=this.otherEvent.point;return this.left?(te[0]-ee[0])*(Oe[1]-ee[1])-(Oe[0]-ee[0])*(te[1]-ee[1])>0:(Oe[0]-ee[0])*(te[1]-ee[1])-(te[0]-ee[0])*(Oe[1]-ee[1])>0},X.prototype.isAbove=function(ee){return!this.isBelow(ee)},X.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},W.inResult.get=function(){return this.resultTransition!==0},X.prototype.clone=function(){var ee=new X(this.point,this.left,this.otherEvent,this.isSubject,this.type);return ee.contourId=this.contourId,ee.resultTransition=this.resultTransition,ee.prevInResult=this.prevInResult,ee.isExteriorRing=this.isExteriorRing,ee.inOut=this.inOut,ee.otherInOut=this.otherInOut,ee},Object.defineProperties(X.prototype,W);var pe=11102230246251565e-32,ce=134217729,ue=(3+8*pe)*pe;function ge(ee,te,Oe,lt,pt){var dt,Et,qt,ci,hi=te[0],ii=lt[0],Gi=0,Tr=0;ii>hi==ii>-hi?(dt=hi,hi=te[++Gi]):(dt=ii,ii=lt[++Tr]);var ei=0;if(Gi<ee&&Tr<Oe)for(ii>hi==ii>-hi?(qt=dt-((Et=hi+dt)-hi),hi=te[++Gi]):(qt=dt-((Et=ii+dt)-ii),ii=lt[++Tr]),dt=Et,qt!==0&&(pt[ei++]=qt);Gi<ee&&Tr<Oe;)ii>hi==ii>-hi?(qt=dt-((Et=dt+hi)-(ci=Et-dt))+(hi-ci),hi=te[++Gi]):(qt=dt-((Et=dt+ii)-(ci=Et-dt))+(ii-ci),ii=lt[++Tr]),dt=Et,qt!==0&&(pt[ei++]=qt);for(;Gi<ee;)qt=dt-((Et=dt+hi)-(ci=Et-dt))+(hi-ci),hi=te[++Gi],dt=Et,qt!==0&&(pt[ei++]=qt);for(;Tr<Oe;)qt=dt-((Et=dt+ii)-(ci=Et-dt))+(ii-ci),ii=lt[++Tr],dt=Et,qt!==0&&(pt[ei++]=qt);return dt===0&&ei!==0||(pt[ei++]=dt),ei}function ve(ee){return new Float64Array(ee)}var Ne=33306690738754716e-32,Ee=22204460492503146e-32,Ue=11093356479670487e-47,nt=ve(4),qe=ve(8),Ke=ve(12),it=ve(16),Fe=ve(4);function Je(ee,te,Oe){var lt=function(pt,dt,Et,qt,ci,hi){var ii=(dt-hi)*(Et-ci),Gi=(pt-ci)*(qt-hi),Tr=ii-Gi;if(ii===0||Gi===0||ii>0!=Gi>0)return Tr;var ei=Math.abs(ii+Gi);return Math.abs(Tr)>=Ne*ei?Tr:-function(ar,Ji,Bi,xr,rr,Qi,tr){var Ui,ri,qi,vr,jt,xi,nr,Er,lr,Yr,Zi,jr,io,bn,_n,ro,pa,Kr,rn=ar-rr,wn=Bi-rr,Fn=Ji-Qi,Pn=xr-Qi;nt[0]=(_n=(Er=rn-(nr=(xi=ce*rn)-(xi-rn)))*(Yr=Pn-(lr=(xi=ce*Pn)-(xi-Pn)))-((bn=rn*Pn)-nr*lr-Er*lr-nr*Yr))-((Zi=_n-(pa=(Er=Fn-(nr=(xi=ce*Fn)-(xi-Fn)))*(Yr=wn-(lr=(xi=ce*wn)-(xi-wn)))-((ro=Fn*wn)-nr*lr-Er*lr-nr*Yr)))+(jt=_n-Zi))+(jt-pa),nt[1]=(io=bn-((jr=bn+Zi)-(jt=jr-bn))+(Zi-jt))-((Zi=io-ro)+(jt=io-Zi))+(jt-ro),nt[2]=jr-((Kr=jr+Zi)-(jt=Kr-jr))+(Zi-jt),nt[3]=Kr;var $l=function(Ez,ww){for(var Tw=ww[0],s0=1;s0<4;s0++)Tw+=ww[s0];return Tw}(0,nt),lf=Ee*tr;if($l>=lf||-$l>=lf||(Ui=ar-(rn+(jt=ar-rn))+(jt-rr),qi=Bi-(wn+(jt=Bi-wn))+(jt-rr),ri=Ji-(Fn+(jt=Ji-Fn))+(jt-Qi),vr=xr-(Pn+(jt=xr-Pn))+(jt-Qi),Ui===0&&ri===0&&qi===0&&vr===0)||(lf=Ue*tr+ue*Math.abs($l),($l+=rn*vr+Pn*Ui-(Fn*qi+wn*ri))>=lf||-$l>=lf))return $l;Fe[0]=(_n=(Er=Ui-(nr=(xi=ce*Ui)-(xi-Ui)))*(Yr=Pn-(lr=(xi=ce*Pn)-(xi-Pn)))-((bn=Ui*Pn)-nr*lr-Er*lr-nr*Yr))-((Zi=_n-(pa=(Er=ri-(nr=(xi=ce*ri)-(xi-ri)))*(Yr=wn-(lr=(xi=ce*wn)-(xi-wn)))-((ro=ri*wn)-nr*lr-Er*lr-nr*Yr)))+(jt=_n-Zi))+(jt-pa),Fe[1]=(io=bn-((jr=bn+Zi)-(jt=jr-bn))+(Zi-jt))-((Zi=io-ro)+(jt=io-Zi))+(jt-ro),Fe[2]=jr-((Kr=jr+Zi)-(jt=Kr-jr))+(Zi-jt),Fe[3]=Kr;var KM=ge(4,nt,4,Fe,qe);Fe[0]=(_n=(Er=rn-(nr=(xi=ce*rn)-(xi-rn)))*(Yr=vr-(lr=(xi=ce*vr)-(xi-vr)))-((bn=rn*vr)-nr*lr-Er*lr-nr*Yr))-((Zi=_n-(pa=(Er=Fn-(nr=(xi=ce*Fn)-(xi-Fn)))*(Yr=qi-(lr=(xi=ce*qi)-(xi-qi)))-((ro=Fn*qi)-nr*lr-Er*lr-nr*Yr)))+(jt=_n-Zi))+(jt-pa),Fe[1]=(io=bn-((jr=bn+Zi)-(jt=jr-bn))+(Zi-jt))-((Zi=io-ro)+(jt=io-Zi))+(jt-ro),Fe[2]=jr-((Kr=jr+Zi)-(jt=Kr-jr))+(Zi-jt),Fe[3]=Kr;var JM=ge(KM,qe,4,Fe,Ke);Fe[0]=(_n=(Er=Ui-(nr=(xi=ce*Ui)-(xi-Ui)))*(Yr=vr-(lr=(xi=ce*vr)-(xi-vr)))-((bn=Ui*vr)-nr*lr-Er*lr-nr*Yr))-((Zi=_n-(pa=(Er=ri-(nr=(xi=ce*ri)-(xi-ri)))*(Yr=qi-(lr=(xi=ce*qi)-(xi-qi)))-((ro=ri*qi)-nr*lr-Er*lr-nr*Yr)))+(jt=_n-Zi))+(jt-pa),Fe[1]=(io=bn-((jr=bn+Zi)-(jt=jr-bn))+(Zi-jt))-((Zi=io-ro)+(jt=io-Zi))+(jt-ro),Fe[2]=jr-((Kr=jr+Zi)-(jt=Kr-jr))+(Zi-jt),Fe[3]=Kr;var QM=ge(JM,Ke,4,Fe,it);return it[QM-1]}(pt,dt,Et,qt,ci,hi,ei)}(ee[0],ee[1],te[0],te[1],Oe[0],Oe[1]);return lt>0?-1:lt<0?1:0}function Ie(ee,te){var Oe=ee.point,lt=te.point;return Oe[0]>lt[0]?1:Oe[0]<lt[0]?-1:Oe[1]!==lt[1]?Oe[1]>lt[1]?1:-1:function(pt,dt,Et,qt){return pt.left!==dt.left?pt.left?1:-1:Je(Et,pt.otherEvent.point,dt.otherEvent.point)!==0?pt.isBelow(dt.otherEvent.point)?-1:1:!pt.isSubject&&dt.isSubject?1:-1}(ee,te,Oe)}function Be(ee,te,Oe){var lt=new X(te,!1,ee,ee.isSubject),pt=new X(te,!0,ee.otherEvent,ee.isSubject);return K(ee.point,ee.otherEvent.point)&&console.warn("what is that, a collapsed segment?",ee),lt.contourId=pt.contourId=ee.contourId,Ie(pt,ee.otherEvent)>0&&(ee.otherEvent.left=!0,pt.left=!1),ee.otherEvent.otherEvent=pt,ee.otherEvent=lt,Oe.push(pt),Oe.push(lt),Oe}function at(ee,te){return ee[0]*te[1]-ee[1]*te[0]}function et(ee,te){return ee[0]*te[0]+ee[1]*te[1]}function Lt(ee,te,Oe){var lt=function(ci,hi,ii,Gi,Tr){var ei=[hi[0]-ci[0],hi[1]-ci[1]],ar=[Gi[0]-ii[0],Gi[1]-ii[1]];function Ji(xi,nr,Er){return[xi[0]+nr*Er[0],xi[1]+nr*Er[1]]}var Bi=[ii[0]-ci[0],ii[1]-ci[1]],xr=at(ei,ar),rr=xr*xr,Qi=et(ei,ei);if(rr>0){var tr=at(Bi,ar)/xr;if(tr<0||tr>1)return null;var Ui=at(Bi,ei)/xr;return Ui<0||Ui>1?null:tr===0||tr===1?[Ji(ci,tr,ei)]:Ui===0||Ui===1?[Ji(ii,Ui,ar)]:[Ji(ci,tr,ei)]}if((rr=(xr=at(Bi,ei))*xr)>0)return null;var ri=et(ei,Bi)/Qi,qi=ri+et(ei,ar)/Qi,vr=Math.min(ri,qi),jt=Math.max(ri,qi);return vr<=1&&jt>=0?vr===1?[Ji(ci,vr>0?vr:0,ei)]:jt===0?[Ji(ci,jt<1?jt:1,ei)]:[Ji(ci,vr>0?vr:0,ei),Ji(ci,jt<1?jt:1,ei)]:null}(ee.point,ee.otherEvent.point,te.point,te.otherEvent.point),pt=lt?lt.length:0;if(pt===0||pt===1&&(K(ee.point,te.point)||K(ee.otherEvent.point,te.otherEvent.point))||pt===2&&ee.isSubject===te.isSubject)return 0;if(pt===1)return K(ee.point,lt[0])||K(ee.otherEvent.point,lt[0])||Be(ee,lt[0],Oe),K(te.point,lt[0])||K(te.otherEvent.point,lt[0])||Be(te,lt[0],Oe),1;var dt=[],Et=!1,qt=!1;return K(ee.point,te.point)?Et=!0:Ie(ee,te)===1?dt.push(te,ee):dt.push(ee,te),K(ee.otherEvent.point,te.otherEvent.point)?qt=!0:Ie(ee.otherEvent,te.otherEvent)===1?dt.push(te.otherEvent,ee.otherEvent):dt.push(ee.otherEvent,te.otherEvent),Et&&qt||Et?(te.type=y,ee.type=te.inOut===ee.inOut?T:E,Et&&!qt&&Be(dt[1].otherEvent,dt[0].point,Oe),2):qt?(Be(dt[0],dt[1].point,Oe),3):dt[0]!==dt[3].otherEvent?(Be(dt[0],dt[1].point,Oe),Be(dt[1],dt[2].point,Oe),3):(Be(dt[0],dt[1].point,Oe),Be(dt[3].otherEvent,dt[2].point,Oe),3)}function St(ee,te){if(ee===te)return 0;if(Je(ee.point,ee.otherEvent.point,te.point)!==0||Je(ee.point,ee.otherEvent.point,te.otherEvent.point)!==0)return K(ee.point,te.point)?ee.isBelow(te.otherEvent.point)?-1:1:ee.point[0]===te.point[0]?ee.point[1]<te.point[1]?-1:1:Ie(ee,te)===1?te.isAbove(ee.point)?-1:1:ee.isBelow(te.point)?-1:1;if(ee.isSubject!==te.isSubject)return ee.isSubject?-1:1;var Oe=ee.point,lt=te.point;return Oe[0]===lt[0]&&Oe[1]===lt[1]?(Oe=ee.otherEvent.point)[0]===(lt=te.otherEvent.point)[0]&&Oe[1]===lt[1]?0:ee.contourId>te.contourId?1:-1:Ie(ee,te)===1?1:-1}var Xe=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function tt(ee,te,Oe,lt){var pt,dt=ee+1,Et=te[ee].point,qt=te.length;for(dt<qt&&(pt=te[dt].point);dt<qt&&pt[0]===Et[0]&&pt[1]===Et[1];){if(!Oe[dt])return dt;++dt<qt&&(pt=te[dt].point)}for(dt=ee-1;Oe[dt]&&dt>lt;)dt--;return dt}Xe.prototype.isExterior=function(){return this.holeOf==null};var It=ut,xt=ut;function ut(ee,te){if(!(this instanceof ut))return new ut(ee,te);if(this.data=ee||[],this.length=this.data.length,this.compare=te||vt,this.length>0)for(var Oe=(this.length>>1)-1;Oe>=0;Oe--)this._down(Oe)}function vt(ee,te){return ee<te?-1:ee>te?1:0}ut.prototype={push:function(ee){this.data.push(ee),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var ee=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),ee}},peek:function(){return this.data[0]},_up:function(ee){for(var te=this.data,Oe=this.compare,lt=te[ee];ee>0;){var pt=ee-1>>1,dt=te[pt];if(Oe(lt,dt)>=0)break;te[ee]=dt,ee=pt}te[ee]=lt},_down:function(ee){for(var te=this.data,Oe=this.compare,lt=this.length>>1,pt=te[ee];ee<lt;){var dt=1+(ee<<1),Et=dt+1,qt=te[dt];if(Et<this.length&&Oe(te[Et],qt)<0&&(dt=Et,qt=te[Et]),Oe(qt,pt)>=0)break;te[ee]=qt,ee=dt}te[ee]=pt}},It.default=xt;var Vt=Math.max,Zt=Math.min,Qt=0;function Kt(ee,te,Oe,lt,pt,dt){var Et,qt,ci,hi,ii,Gi;for(Et=0,qt=ee.length-1;Et<qt;Et++)if(hi=ee[Et+1],ii=new X(ci=ee[Et],!1,void 0,te),Gi=new X(hi,!1,ii,te),ii.otherEvent=Gi,ci[0]!==hi[0]||ci[1]!==hi[1]){ii.contourId=Gi.contourId=Oe,dt||(ii.isExteriorRing=!1,Gi.isExteriorRing=!1),Ie(ii,Gi)>0?Gi.left=!0:ii.left=!0;var Tr=ci[0],ei=ci[1];pt[0]=Zt(pt[0],Tr),pt[1]=Zt(pt[1],ei),pt[2]=Vt(pt[2],Tr),pt[3]=Vt(pt[3],ei),lt.push(ii),lt.push(Gi)}}var fi=[];function oi(ee,te,Oe){typeof ee[0][0][0]=="number"&&(ee=[ee]),typeof te[0][0][0]=="number"&&(te=[te]);var lt=function(ei,ar,Ji){var Bi=null;return ei.length*ar.length==0&&(Ji===A?Bi=fi:Ji===L?Bi=ei:Ji!==R&&Ji!==k||(Bi=ei.length===0?ar:ei)),Bi}(ee,te,Oe);if(lt)return lt===fi?null:lt;var pt=[1/0,1/0,-1/0,-1/0],dt=[1/0,1/0,-1/0,-1/0],Et=function(ei,ar,Ji,Bi,xr){var rr,Qi,tr,Ui,ri,qi,vr=new It(null,Ie);for(tr=0,Ui=ei.length;tr<Ui;tr++)for(ri=0,qi=(rr=ei[tr]).length;ri<qi;ri++)(Qi=ri===0)&&Qt++,Kt(rr[ri],!0,Qt,vr,Ji,Qi);for(tr=0,Ui=ar.length;tr<Ui;tr++)for(ri=0,qi=(rr=ar[tr]).length;ri<qi;ri++)Qi=ri===0,xr===L&&(Qi=!1),Qi&&Qt++,Kt(rr[ri],!1,Qt,vr,Bi,Qi);return vr}(ee,te,pt,dt,Oe);if(lt=function(ei,ar,Ji,Bi,xr){var rr=null;return(Ji[0]>Bi[2]||Bi[0]>Ji[2]||Ji[1]>Bi[3]||Bi[1]>Ji[3])&&(xr===A?rr=fi:xr===L?rr=ei:xr!==R&&xr!==k||(rr=ei.concat(ar))),rr}(ee,te,pt,dt,Oe))return lt===fi?null:lt;for(var qt=function(ei){var ar,Ji,Bi=function(tr){var Ui,ri,qi,vr,jt=[];for(ri=0,qi=tr.length;ri<qi;ri++)((Ui=tr[ri]).left&&Ui.inResult||!Ui.left&&Ui.otherEvent.inResult)&&jt.push(Ui);for(var xi=!1;!xi;)for(xi=!0,ri=0,qi=jt.length;ri<qi;ri++)ri+1<qi&&Ie(jt[ri],jt[ri+1])===1&&(vr=jt[ri],jt[ri]=jt[ri+1],jt[ri+1]=vr,xi=!1);for(ri=0,qi=jt.length;ri<qi;ri++)(Ui=jt[ri]).otherPos=ri;for(ri=0,qi=jt.length;ri<qi;ri++)(Ui=jt[ri]).left||(vr=Ui.otherPos,Ui.otherPos=Ui.otherEvent.otherPos,Ui.otherEvent.otherPos=vr);return jt}(ei),xr={},rr=[],Qi=function(){if(!xr[ar]){var tr=rr.length,Ui=function(jt,xi,nr){var Er=new Xe;if(jt.prevInResult!=null){var lr=jt.prevInResult,Yr=lr.outputContourId;if(lr.resultTransition>0){var Zi=xi[Yr];if(Zi.holeOf!=null){var jr=Zi.holeOf;xi[jr].holeIds.push(nr),Er.holeOf=jr,Er.depth=xi[Yr].depth}else xi[Yr].holeIds.push(nr),Er.holeOf=Yr,Er.depth=xi[Yr].depth+1}else Er.holeOf=null,Er.depth=xi[Yr].depth}else Er.holeOf=null,Er.depth=0;return Er}(Bi[ar],rr,tr),ri=function(jt){xr[jt]=!0,jt<Bi.length&&Bi[jt]&&(Bi[jt].outputContourId=tr)},qi=ar,vr=ar;for(Ui.points.push(Bi[ar].point);ri(qi),ri(qi=Bi[qi].otherPos),Ui.points.push(Bi[qi].point),!((qi=tt(qi,Bi,xr,vr))==vr||qi>=Bi.length)&&Bi[qi];);rr.push(Ui)}};for(ar=0,Ji=Bi.length;ar<Ji;ar++)Qi();return rr}(function(ei,ar,Ji,Bi,xr,rr){for(var Qi,tr,Ui,ri=new a(St),qi=[],vr=Math.min(Bi[2],xr[2]);ei.length!==0;){var jt=ei.pop();if(qi.push(jt),rr===A&&jt.point[0]>vr||rr===L&&jt.point[0]>Bi[2])break;if(jt.left){tr=Qi=ri.insert(jt),Qi=Qi!==(Ui=ri.minNode())?ri.prev(Qi):null,tr=ri.next(tr);var xi=Qi?Qi.key:null;if(B(jt,xi,rr),tr&&Lt(jt,tr.key,ei)===2&&(B(jt,xi,rr),B(tr.key,jt,rr)),Qi&&Lt(Qi.key,jt,ei)===2){var nr=Qi;B(xi,(nr=nr!==Ui?ri.prev(nr):null)?nr.key:null,rr),B(jt,xi,rr)}}else tr=Qi=ri.find(jt=jt.otherEvent),Qi&&tr&&(Qi=Qi!==Ui?ri.prev(Qi):null,tr=ri.next(tr),ri.remove(jt),tr&&Qi&&Lt(Qi.key,tr.key,ei))}return qi}(Et,0,0,pt,dt,Oe)),ci=[],hi=0;hi<qt.length;hi++){var ii=qt[hi];if(ii.isExterior()){for(var Gi=[ii.points],Tr=0;Tr<ii.holeIds.length;Tr++)Gi.push(qt[ii.holeIds[Tr]].points);ci.push(Gi)}}return ci}var ir={UNION:R,DIFFERENCE:L,INTERSECTION:A,XOR:k};i.diff=function(ee,te){return oi(ee,te,L)},i.intersection=function(ee,te){return oi(ee,te,A)},i.operations=ir,i.union=function(ee,te){return oi(ee,te,R)},i.xor=function(ee,te){return oi(ee,te,k)},Object.defineProperty(i,"__esModule",{value:!0})})(e)}(0,cv.exports)),cv.exports);function Gm(r,e,i,s){let a=[],h=s===0?(u,f,g,y,T,E)=>{u.push(new Qe(E,g+(E-f)/(y-f)*(T-g)))}:(u,f,g,y,T,E)=>{u.push(new Qe(f+(E-g)/(T-g)*(y-f),E))};for(let u of r){let f=[];for(let g of u){if(g.length<=2)continue;let y=[];for(let A=0;A<g.length-1;A++){let R=g[A].x,L=g[A].y,k=g[A+1].x,B=g[A+1].y,G=s===0?R:L,X=s===0?k:B;G<e?X>e&&h(y,R,L,k,B,e):G>i?X<i&&h(y,R,L,k,B,i):y.push(g[A]),X<e&&G>=e&&h(y,R,L,k,B,e),X>i&&G<=i&&h(y,R,L,k,B,i)}let T=g[g.length-1],E=s===0?T.x:T.y;E>=e&&E<=i&&y.push(T),y.length&&(T=y[y.length-1],y[0].x===T.x&&y[0].y===T.y||y.push(y[0]),f.push(y))}f.length&&a.push(f)}return a}function JE(r,e){let i=iy(r),s=iy([e]),a=hv.intersection(i,s);return a==null?[]:uv(a)}function QE(r,e){let s=iy(r,65536);for(;e.valid();e.next()){let[a,h]=e.get(),u=a.x*65536,f=a.y*65536,g=h.x*65536,y=h.y*65536,T=g-u,E=y-f,A=Math.hypot(T,E),R=Math.trunc(E/A*3),L=-Math.trunc(T/A*3);s=hv.diff(s,[[[u,f],[g,y],[g+R,y+L],[u+R,f+L],[u,f]]])}return uv(s,1/65536)}function iy(r,e=1){return[r.map(i=>i.map(s=>[s.x*e,s.y*e]))]}function uv(r,e=1){return r.map(i=>i.map((s,a)=>{let h=s.map(u=>new Qe(u[0]*e,u[1]*e).round());return a>0&&h.reverse(),h}))}class ry{constructor(e,i){this.layoutVertexArray=new Zn,this.indexArray=new ur,this.lineIndexArray=new cs,this.triangleSegments=new gr,this.lineSegments=new gr,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new Ba)}update(e,i,s,a,h,u,f,g){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,g)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,FE.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,BE.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,s,a,h,u,f){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,s,a,h,u,void 0,f)}}class ny{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new ry(e,!1),this.elevationBufferData=new ry(e,!0),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.hasPattern=ey("fill",this.layers,this.pixelRatio,i);let h=this.layers[0].layout.get("fill-sort-key"),u=[];for(let{feature:f,id:g,index:y,sourceLayerIndex:T}of e){let E=this.layers[0]._featureFilter.needGeometry,A=ke(f,E);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),A,s))continue;let R=h?h.evaluate(A,{},s,i.availableImages):void 0,L={id:g,properties:f.properties,type:f.type,sourceLayerIndex:T,index:y,geometry:E?A.geometry:me(f,s,a),patterns:{},sortKey:R};u.push(L)}h&&u.sort((f,g)=>f.sortKey-g.sortKey);for(let f of u){let{geometry:g,index:y,sourceLayerIndex:T}=f;if(this.hasPattern){let E=ty("fill",this.layers,f,this.zoom,this.pixelRatio,i);this.patternFeatures.push(E)}else this.addFeature(f,g,y,s,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[y].feature,g,y,T,this.index)}}update(e,i,s,a,h,u,f){this.bufferData.update(e,i,s,a,h,u,f,this.worldview),this.elevationBufferData.update(e,i,s,a,h,u,f,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,s,a,h,u,f,this.worldview)}addFeatures(e,i,s,a,h,u){for(let f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,s,a,u,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,s,a,h,u=[],f,g){let y=Pp(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,y,a,s,g):this.addGeometry(y,this.bufferData),this.bufferData.populatePaintArrays(e,s,h,u,a,f,this.worldview),this.elevationBufferData.populatePaintArrays(e,s,h,u,a,f,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,s,a,h){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,s,a,h,this.worldview))}addElevatedRoadFeature(e,i,s,a,h){let u=new Array,f=yr.getElevationFeature(e,h);if(!f)return void this.addGeometry(i,this.bufferData);{let y=this.clipPolygonsToTile(i,1);y.length>0&&u.push({polygons:y,elevationFeature:f,elevationTileID:s})}let g={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},s),featureIndex:a};for(let y of u)if(y.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Eo(y.elevationTileID,this.layers,this.zoom,this.lut));let E=y.elevationFeature.isTunnel(),A=0;e.properties.hasOwnProperty(zt)&&(A=+e.properties[zt]);for(let R of y.polygons)this.elevatedStructures.addPortalCandidates(y.elevationFeature.id,R,E,y.elevationFeature,A)}y.elevationFeature.constantHeight==null&&(y.polygons=this.prepareElevatedPolygons(y.polygons,y.elevationFeature,y.elevationTileID));let T=new bi(s,y.elevationTileID);this.addElevatedGeometry(y.polygons,T,y.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,a,g)}}addElevatedGeometry(e,i,s,a,h,u){let f={elevation:s,elevationSampler:i,bias:a,index:h,featureInfo:u},[g,y]=this.addGeometry(e,this.elevationBufferData,f);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:g,max:y}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,g),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,y))}addGeometry(e,i,s){let a=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,u=null;s&&(u=s.elevationSampler.constantElevation(s.elevation,s.bias),u!=null&&(a=u,h=u));let f=(g,y,T)=>{if(s!=null)if(y.push(g),u!=null)i.elevatedLayoutVertexArray.emplaceBack(u),T.push(u);else{let E=s.elevationSampler.pointElevation(g,s.elevation,s.bias);i.elevatedLayoutVertexArray.emplaceBack(E),T.push(E),a=Math.min(a,E),h=Math.max(h,E)}};for(let g of e){let y=0;for(let W of g)y+=W.length;let T=i.triangleSegments.prepareSegment(y,i.layoutVertexArray,i.indexArray),E=T.vertexLength,A=[],R=[],L=[],k=[],B=[],G=i.layoutVertexArray.length;for(let W of g){if(W.length===0)continue;W!==g[0]&&R.push(A.length/2);let K=i.lineSegments.prepareSegment(W.length,i.layoutVertexArray,i.lineIndexArray),pe=K.vertexLength;s&&B.push(i.layoutVertexArray.length-G),f(W[0],L,k),i.layoutVertexArray.emplaceBack(W[0].x,W[0].y),i.lineIndexArray.emplaceBack(pe+W.length-1,pe),A.push(W[0].x),A.push(W[0].y);for(let ce=1;ce<W.length;ce++)f(W[ce],L,k),i.layoutVertexArray.emplaceBack(W[ce].x,W[ce].y),i.lineIndexArray.emplaceBack(pe+ce-1,pe+ce),A.push(W[ce].x),A.push(W[ce].y);K.vertexLength+=W.length,K.primitiveLength+=W.length}let X=Au(A,R);for(let W=0;W<X.length;W+=3)i.indexArray.emplaceBack(E+X[W],E+X[W+1],E+X[W+2]);if(X.length>0&&s&&this.elevationMode==="hd-road-base"){let W=s.elevation.isTunnel(),K=s.elevation.safeArea,pe=this.elevatedStructures.addVertices(L,k);this.elevatedStructures.addTriangles(X,pe,W);let ce=B.length;if(ce>0){for(let ue=0;ue<ce-1;ue++)this.elevatedStructures.addRenderableRing(s.index,B[ue]+pe,B[ue+1]-B[ue],W,K,s.featureInfo);this.elevatedStructures.addRenderableRing(s.index,B[ce-1]+pe,L.length-B[ce-1],W,K,s.featureInfo)}}T.vertexLength+=y,T.primitiveLength+=X.length/3}return[a,h]}prepareElevatedPolygons(e,i,s){let a=1/se(s),h=[];for(let u of e){let f=QE(u,new Vi(i,a));h.push(...f)}return h}clipPolygonsToTile(e,i){let s=-i,a=-i,h=ht+i,u=ht+i,f=0,g=[],y=[];for(;f<e.length;f++){let A=e[f],R=yd(A);(R.min.x>=s&&R.max.x<=h&&R.min.y>=a&&R.max.y<=u?g:y).push(A)}if(g.length===e.length)return e;let T=[new Qe(s,a),new Qe(h,a),new Qe(h,u),new Qe(s,u),new Qe(s,a)],E=g;for(let A of y)E.push(...JE(A,T));return E}}let dv,pv,fv,mv;Tt(ny,"FillBucket",{omit:["layers","patternFeatures"]}),Tt(ry,"FillBufferData"),Tt(Eo,"ElevatedStructures");class qm{constructor(e,i,s,a){if(this.triangleCount=i.length/3,this.min=new Qe(0,0),this.max=new Qe(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;let[h,u]=[e[0].clone(),e[0].clone()];for(let E=1;E<e.length;++E){let A=e[E];h.x=Math.min(h.x,A.x),h.y=Math.min(h.y,A.y),u.x=Math.max(u.x,A.x),u.y=Math.max(u.y,A.y)}if(a){let E=Math.ceil(Math.max(u.x-h.x,u.y-h.y)/a);s=Math.max(s,E)}if(s===0)return;this.min=h,this.max=u;let f=this.max.sub(this.min);f.x=Math.max(f.x,1),f.y=Math.max(f.y,1);let g=Math.max(f.x,f.y)/s;this.cellsX=Math.max(1,Math.ceil(f.x/g)),this.cellsY=Math.max(1,Math.ceil(f.y/g)),this.xScale=1/g,this.yScale=1/g;let y=[];for(let E=0;E<this.triangleCount;E++){let A=e[i[3*E+0]].sub(this.min),R=e[i[3*E+1]].sub(this.min),L=e[i[3*E+2]].sub(this.min),k=ua(Math.floor(Math.min(A.x,R.x,L.x)),this.xScale,this.cellsX),B=ua(Math.floor(Math.max(A.x,R.x,L.x)),this.xScale,this.cellsX),G=ua(Math.floor(Math.min(A.y,R.y,L.y)),this.yScale,this.cellsY),X=ua(Math.floor(Math.max(A.y,R.y,L.y)),this.yScale,this.cellsY),W=new Qe(0,0),K=new Qe(0,0),pe=new Qe(0,0),ce=new Qe(0,0);for(let ue=G;ue<=X;++ue){W.y=K.y=ue*g,pe.y=ce.y=(ue+1)*g;for(let ge=k;ge<=B;++ge)W.x=pe.x=ge*g,K.x=ce.x=(ge+1)*g,(Wr(A,R,L,W,K,ce)||Wr(A,R,L,W,ce,pe))&&y.push({cellIdx:ue*this.cellsX+ge,triIdx:E})}}if(y.length===0)return;y.sort((E,A)=>E.cellIdx-A.cellIdx||E.triIdx-A.triIdx);let T=0;for(;T<y.length;){let E=y[T].cellIdx,A={start:this.payload.length,len:0};for(;T<y.length&&y[T].cellIdx===E;)++A.len,this.payload.push(y[T++].triIdx);this.cells[E]=A}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;let s=ua(e.x-this.min.x,this.xScale,this.cellsX),a=ua(e.y-this.min.y,this.yScale,this.cellsY),h=this.cells[a*this.cellsX+s];if(h){this._lazyInitLookup();for(let u=0;u<h.len;u++){let f=this.payload[h.start+u],g=Math.floor(f/8),y=1<<f%8;if(!(this.lookup[g]&y)&&(this.lookup[g]|=y,i.push(f),i.length===this.triangleCount))return}}}query(e,i,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();let a=ua(e.x-this.min.x,this.xScale,this.cellsX),h=ua(i.x-this.min.x,this.xScale,this.cellsX),u=ua(e.y-this.min.y,this.yScale,this.cellsY),f=ua(i.y-this.min.y,this.yScale,this.cellsY);for(let g=u;g<=f;g++)for(let y=a;y<=h;y++){let T=this.cells[g*this.cellsX+y];if(T)for(let E=0;E<T.len;E++){let A=this.payload[T.start+E],R=Math.floor(A/8),L=1<<A%8;if(!(this.lookup[R]&L)&&(this.lookup[R]|=L,s.push(A),s.length===this.triangleCount))return}}}}function ua(r,e,i){return Math.max(0,Math.min(i-1,Math.floor(r*e)))}Tt(qm,"TriangleGridIndex");class _v{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,i){for(let s of this.footprints)i.push({footprint:s,id:e})}populate(e,i,s,a){let h=[];for(let{feature:u,id:f,index:g,sourceLayerIndex:y}of e){let T=this.layers[0]._featureFilter.needGeometry,E=ke(u,T);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),E,s))continue;let A={id:f,properties:u.properties,type:u.type,sourceLayerIndex:y,index:g,geometry:T?E.geometry:me(u,s,a),patterns:{}};h.push(A)}for(let u of h){let{geometry:f,index:g,sourceLayerIndex:y}=u;this.addFeature(u,f,g,s,{},i.availableImages,i.brightness),i.featureIndex.insert(e[g].feature,f,g,y,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,s,a,h,u,f){}destroy(){}addFeature(e,i,s,a,h,u=[],f){for(let g of Pp(i,2)){let y=[],T=[],E=[],A=new Qe(1/0,1/0),R=new Qe(-1/0,-1/0);for(let B of g)if(B.length!==0){B!==g[0]&&E.push(T.length/2);for(let G=0;G<B.length;G++)T.push(B[G].x),T.push(B[G].y),y.push(B[G]),A.x=Math.min(A.x,B[G].x),A.y=Math.min(A.y,B[G].y),R.x=Math.max(R.x,B[G].x),R.y=Math.max(R.y,B[G].y)}let L=Au(T,E),k=new qm(y,L,8,256);this.footprints.push({vertices:y,indices:L,grid:k,min:A,max:R})}}}Tt(_v,"ClipBucket",{omit:["layers"]});let eI=gi([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),tI=gi([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),iI=gi([{name:"a_centroid_pos",components:2,type:"Uint16"}]),rI=gi([{name:"a_join_normal_inside",components:3,type:"Int16"}]),nI=gi([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),oI=gi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:sI}=eI,Rp=Number.MAX_SAFE_INTEGER,gv=Rp-1;function yv(r,e,i,s){return r.order<e||r.order===Rp||!(r.clipMask&i)||function(a,h){return h.length!==0&&h.find(u=>u===a)===void 0}(s,r.clipScope)}function Hm(r,e){return r.x-e.x||r.y-e.y}function xv(r,e){return Hm(r.min,e.min)===0&&Hm(r.max,e.max)===0}function oy(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function $m(r,e){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(r[i].sourceId!==e[i].sourceId||!xv(r[i],e[i])||r[i].order!==e[i].order||r[i].clipMask!==e[i].clipMask||!Es(r[i].clipScope,e[i].clipScope))return!1;return!0}function vv(r,e,i){let s=1/ht,a=1/(1<<i.canonical.z),h=(e.x*s+i.canonical.x)*a+i.wrap,u=(e.y*s+i.canonical.y)*a;return{min:new Qe((r.x*s+i.canonical.x)*a+i.wrap,(r.y*s+i.canonical.y)*a),max:new Qe(h,u)}}function aI(r,e,i){let s=1<<i.canonical.z,a=((e.x-i.wrap)*s-i.canonical.x)*ht,h=(e.y*s-i.canonical.y)*ht;return{min:new Qe(((r.x-i.wrap)*s-i.canonical.x)*ht,(r.y*s-i.canonical.y)*ht),max:new Qe(a,h)}}function sy(r,e,i,s,a,h,u){let f=r.indices,g=r.vertices,y=[];for(let T=s;T<s+a;T+=3){let E=e[i[T+0]+h],A=e[i[T+1]+h],R=e[i[T+2]+h],L=Math.min(E.x,A.x,R.x),k=Math.max(E.x,A.x,R.x),B=Math.min(E.y,A.y,R.y),G=Math.max(E.y,A.y,R.y);y.length=0,r.grid.query(new Qe(L,B),new Qe(k,G),y);for(let X=0;X<y.length;X++){let W=y[X];if(Wr(g[f[3*W+0]],g[f[3*W+1]],g[f[3*W+2]],E,A,R,u))return!0}}return!1}function bv(r,e,i,s){if(!r||!i)return!1;let a=r.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(i.vertices.length<r.vertices.length)return bv(i,s,r,e);let h=e.canonical,u=s.canonical,f=Math.pow(2,u.z-h.z);a=r.vertices.map(g=>new Qe((g.x+h.x*ht)*f-u.x*ht,(g.y+h.y*ht)*f-u.y*ht))}return sy(i,a,r.indices,0,r.indices.length,0,0)}function wv(r,e,i,s){let a=Math.pow(2,s.z-i.z);return new Qe((r+i.x*ht)*a-s.x*ht,(e+i.y*ht)*a-s.y*ht)}function ay(r,e){let i=[];e.grid.queryPoint(r,i);let s=e.indices,a=e.vertices;for(let h=0;h<i.length;h++){let u=i[h];if(xn([a[s[3*u+0]],a[s[3*u+1]],a[s[3*u+2]]],r))return!0}return!1}let ly=[new Qe(0,0),new Qe(ht,0),new Qe(ht,ht),new Qe(0,ht)];function Tv(r,e){let i=[],s=[];if(!e||r.length<2)return[r];if(r.length===2)return Sr(r[0],r[1],ly)?[r]:[];for(let a=0;a<r.length+2;a++){let h=r[a%r.length],u=r[(a+1)%r.length],f=Sr(a===0?r[r.length-1]:r[(a-1)%r.length],h,ly),g=Sr(h,u,ly),y=f||g;y&&s.push(h),y&&g||s.length>0&&(s.length>1&&i.push(s),s=[])}return s.length>1&&i.push(s),i}let cy=Pe.types,lI=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],cI=["fill-extrusion-flood-light-ground-radius"],hI=Math.pow(2,13),uI=Math.pow(2,15)-1,Sv=new Qe(0,1),Vl=2147483648;function Lp(r,e,i,s,a,h,u,f){r.emplaceBack((e<<1)+u,(i<<1)+h,(Math.floor(s*hI)<<1)+a,Math.round(f))}function zp(r,e,i){r.emplaceBack(e.x*ht,e.y*ht,i?1:0)}function Zm(r,e,i,s,a,h){r.emplaceBack(e.x,e.y,(i.x<<1)+s,(i.y<<1)+a,h)}function Dp(r,e,i){r.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class Ev{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Iv{constructor(){this.centroidXY=new Qe(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Qe(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Qe(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Qe(this.max.x-this.min.x,this.max.y-this.min.y)}}class Av{constructor(){this.acc=new Qe(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,s){this.accCount++,this.acc._add(i);let a=!!this.borders;i.x<e.min.x?(e.min.x=i.x,a=!0):i.x>e.max.x&&(e.max.x=i.x,a=!0),i.y<e.min.y?(e.min.y=i.y,a=!0):i.y>e.max.y&&(e.max.y=i.y,a=!0),((i.x===0||i.x===ht)&&i.x===s.x)!=((i.y===0||i.y===ht)&&i.y===s.y)&&this.processBorderOverlap(i,s),a&&this.checkBorderIntersection(i,s)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Bt(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>ht!=e.x>ht&&this.addBorderIntersection(1,Bt(i.y,e.y,(ht-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Bt(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>ht!=e.y>ht&&this.addBorderIntersection(3,Bt(i.x,e.x,(ht-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let s=this.borders[e];i<s[0]&&(s[0]=i),i>s[1]&&(s[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;let s=e.x===0?0:1;this.addBorderIntersection(s,i.y),this.addBorderIntersection(s,e.y)}else{let s=e.y===0?2:3;this.addBorderIntersection(s,i.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new Qe(0,0):new Qe(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function Mv(r,e){let i=r.add(e)._unit(),s=re(r.x*i.x+r.y*i.y,-1,1);var a,h,u;return a=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(a)))/4*uI*((h=r).x*(u=e).y-h.y*u.x<0?-1:1)}let dI=[r=>r.x<0,r=>r.x>ht,r=>r.y<0,r=>r.y>ht];function pI(r,e,i,s){let a=[4];if(s===0)return a;i._mult(s);let h=r.sub(i),u=e.sub(i),f=[r,e,h,u];for(let g=0;g<4;g++)for(let y of f)if(dI[g](y)){a.push(g);break}return a}class hy{constructor(e){this.vertexArray=new _u,this.indexArray=new ur,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut},i=>cI.includes(i)),this._segments=new gr,this.hiddenByLandmarkVertexArray=new wu,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new gr}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,s,a=!1){let h=e.length;if(h>2){let u=Math.max(0,this._segments.get().length-1),f=this._segments._prepareSegment(4*h,this.vertexArray.length,2*this._segmentToGroundQuads[u].length),g;u!==this._segments.get().length-1&&(u++,this._segmentToGroundQuads[u]=[],this._segmentToRegionTriCounts[u]=[0,0,0,0,0]);{let y=e[0],T=e[1];g=Mv(y.sub(e[h-1])._perp()._unit(),T.sub(y)._perp()._unit())}for(let y=0;y<h;y++){let T=y===h-1?0:y+1,E=e[y],A=e[T],R=e[T===h-1?0:T+1],L=A.sub(E)._perp()._unit(),k=Mv(L,R.sub(A)._perp()._unit()),B=g,G=k;if(uy(E,A,i)||a&&Rv(E,i)&&Rv(A,i)){g=k;continue}let X=f.vertexLength;Zm(this.vertexArray,E,A,1,1,B),Zm(this.vertexArray,E,A,1,0,B),Zm(this.vertexArray,E,A,0,1,G),Zm(this.vertexArray,E,A,0,0,G),f.vertexLength+=4;let W=pI(E,A,L,s);for(let K of W)this._segmentToGroundQuads[u].push({id:X,region:K}),this._segmentToRegionTriCounts[u][K]+=2,f.primitiveLength+=2;g=k}}}prepareBorderSegments(){if(!this.hasData())return;let e=this._segments.get(),i=e.length;for(let s=0;s<i;s++)this._segmentToGroundQuads[s].sort((a,h)=>a.region-h.region);for(let s=0;s<i;s++){let a=this._segmentToGroundQuads[s],h=e[s],u=this._segmentToRegionTriCounts[s];u.reduce((g,y)=>g+y,0);let f=0;for(let g=0;g<=4;g++){let y=u[g];if(y!==0){let T=this.regionSegments[g];T||(T=this.regionSegments[g]=new gr);let E={vertexOffset:h.vertexOffset,primitiveOffset:h.primitiveOffset+f,vertexLength:h.vertexLength,primitiveLength:y};T.get().push(E)}f+=y}for(let g=0;g<a.length;g++){let y=a[g].id;this.indexArray.emplaceBack(y,y+1,y+3),this.indexArray.emplaceBack(y,y+3,y+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,s,a,h,u,f){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,s,a,h,u,void 0,f)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,tI.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,s,a,h,u,f,g){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,s,a,h,u,f,g)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Vl))}updateHiddenByLandmarkRange(e,i,s){if(!this.hasData())return;let a=i+e;if(i!==0){for(let h=e;h<a;++h)this.hiddenByLandmarkVertexArray.emplace(h,s?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,nI.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){let i=this.regionSegments[e];i&&i.destroy()}}}}class Wm{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ur,this.footprintVertices=new Zn,this.footprintSegments=[],this.layoutVertexArray=new Al,this.centroidVertexArray=new Am,this.wallVertexArray=new Cm,this.indexArray=new ur,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut},i=>lI.includes(i)),this.segments=new gr,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new hy(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.features=[],this.hasPattern=ey("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=se(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(let{feature:h,id:u,index:f,sourceLayerIndex:g}of e){let y=this.layers[0]._featureFilter.needGeometry,T=ke(h,y);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),T,s))continue;let E={id:u,sourceLayerIndex:g,index:f,geometry:y?T.geometry:me(h,s,a),properties:h.properties,type:h.type,patterns:{}},A=this.layoutVertexArray.length,R=cy[E.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:h.id,feature:ty("fill-extrusion",this.layers,E,this.zoom,this.pixelRatio,i)});else if(this.wallMode)for(let L of E.geometry)for(let k of Tv(L,R))this.addFeature(h.id,E,[k],f,s,{},i.availableImages,a,i.brightness);else this.addFeature(h.id,E,E.geometry,f,s,{},i.availableImages,a,i.brightness);i.featureIndex.insert(h,E.geometry,f,g,this.index,A)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,s,a,h,u){for(let{featureId:f,feature:g}of this.features){let y=cy[g.type]==="Polygon",{geometry:T}=g;if(this.wallMode)for(let E of T)for(let A of Tv(E,y))this.addFeature(f,g,[A],g.index,i,s,a,h,u);else this.addFeature(f,g,T,g.index,i,s,a,h,u)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,s,a,h,u,f){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,this.worldview),this.groundEffect.update(e,i,h,s,a,u,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,sI),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,rI.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,oI.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,iI.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,s,a,h,u,f,g,y){let T=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(i,{})/this.tileToMeter,E=[new Qe(0,0),new Qe(ht,ht)],A=g.projection,R=A.name==="globe",L=this.wallMode||cy[i.type]==="Polygon",k=new Av;k.centroidDataIndex=this.centroidData.length;let B=new Iv;B.buildingId=e,i.properties&&i.properties.hasOwnProperty("building_id")&&(B.buildingId=i.properties.building_id);let G=this.layers[0].paint.get("fill-extrusion-base").evaluate(i,{},h)<=0,X=this.layers[0].paint.get("fill-extrusion-height").evaluate(i,{},h),W;if(B.height=X,B.vertexArrayOffset=this.layoutVertexArray.length,B.groundVertexArrayOffset=this.groundEffect.vertexArray.length,R&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new yu),this.wallMode){if(R)return void pi("Non zero fill-extrusion-line-width is not yet supported on globe.");if(s.length!==1)return;W=function(Ee){let Ue=Ee[0].x===Ee[Ee.length-1].x&&Ee[0].y===Ee[Ee.length-1].y;(function(tt){let It=0,xt=tt.length;for(let ut=0;ut<xt;ut++)It+=(tt[(ut+1)%xt].x-tt[ut].x)*(tt[(ut+1)%xt].y+tt[ut].y);return It>=0})(Ee)||(Ee=Ee.reverse());let qe={geometry:[],joinNormals:[],indices:[]},Ke=[],it=[],Fe=[],Je=Ee.length;for(;Je>=2&&Ee[Je-1].equals(Ee[Je-2]);)Je--;if(Je<(Ue?3:2))return qe;let Ie,Be,at,et,Lt,St=0;for(;St<Je-1&&Ee[St].equals(Ee[St+1]);)St++;Ue&&(Ie=Ee[Je-2],Lt=Ee[St].sub(Ie)._unit()._perp());for(let tt=St;tt<Je;tt++){if(at=tt===Je-1?Ue?Ee[St+1]:void 0:Ee[tt+1],at&&Ee[tt].equals(at))continue;Lt&&(et=Lt),Ie&&(Be=Ie),Ie=Ee[tt],Lt=at?at.sub(Ie)._unit()._perp():et,et=et||Lt;let It=et.add(Lt);It.x===0&&It.y===0||It._unit();let xt=It.x*Lt.x+It.y*Lt.y,ut=xt!==0?1/xt:1/0,vt=et.x*Lt.y-et.y*Lt.x>0,Vt="miter",Zt=2;Vt==="miter"&&ut>Zt&&(Vt="bevel"),Vt==="bevel"&&(ut>100&&(Vt="flipbevel"),ut<Zt&&(Vt="miter"));let Qt=(Kt,fi,oi,ir)=>{let ee=new Qe(Kt.x,Kt.y),te=new Qe(Kt.x,Kt.y);ee.x+=fi.x*ir,ee.y+=fi.y*ir,te.x-=fi.x*Math.max(oi,1),te.y-=fi.y*Math.max(oi,1),Fe.push(fi),Ke.push(ee),it.push(te)};if(Vt==="miter")It._mult(ut),Qt(Ie,It,0,0);else if(Vt==="flipbevel")It=Lt.mult(-1),Qt(Ie,It,0,0),Qt(Ie,It.mult(-1),0,0);else{let Kt=-Math.sqrt(ut*ut-1),fi=vt?Kt:0,oi=vt?0:Kt;Be&&Qt(Ie,et,fi,oi),at&&Qt(Ie,Lt,fi,oi)}}qe.geometry=[...Ke,...it.reverse(),Ke[0]],qe.joinNormals=[...Fe,...Fe.reverse(),Fe[Fe.length-1]];let Xe=qe.geometry.length-1;for(let tt=0;tt<Xe/2;tt++)if(tt+1<Xe/2){let It=tt,xt=tt+1,ut=Xe-1-tt,vt=Xe-2-tt;It=It===0?Xe-1:It-1,xt=xt===0?Xe-1:xt-1,ut=ut===0?Xe-1:ut-1,vt=vt===0?Xe-1:vt-1,qe.indices.push(ut),qe.indices.push(xt),qe.indices.push(It),qe.indices.push(ut),qe.indices.push(vt),qe.indices.push(xt)}return qe}(s[0]),s=[W.geometry]}let K=(Ee,Ue)=>Ee<(Ue.length-1)/2||Ee===Ue.length-1,pe=this.wallMode?[s]:Pp(s,500);for(let Ee=pe.length-1;Ee>=0;Ee--){let Ue=pe[Ee];(Ue.length===0||(ce=Ue[0]).every(nt=>nt.x<=0)||ce.every(nt=>nt.x>=ht)||ce.every(nt=>nt.y<=0)||ce.every(nt=>nt.y>=ht))&&pe.splice(Ee,1)}var ce;let ue;if(R)ue=Ov(pe,E,h);else{ue=[];for(let Ee of pe)ue.push({polygon:Ee,bounds:E})}let ge=L?this.edgeRadius:0,ve=ge>0&&this.zoom<17,Ne=(Ee,Ue)=>{if(Ee.length===0)return!1;let nt=Ee[Ee.length-1];return Ue.x===nt.x&&Ue.y===nt.y};for(let{polygon:Ee,bounds:Ue}of ue){let nt=0,qe=0;for(let Je of Ee)L&&!Je[0].equals(Je[Je.length-1])&&Je.push(Je[0]),qe+=L?Je.length-1:Je.length;let Ke=this.segments.prepareSegment((L?5:4)*qe,this.layoutVertexArray,this.indexArray);B.footprintSegIdx<0&&(B.footprintSegIdx=this.footprintSegments.length),B.polygonSegIdx<0&&(B.polygonSegIdx=this.polygonSegments.length);let it={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Fe=new Ev;if(Fe.vertexOffset=this.footprintVertices.length,Fe.indexOffset=3*this.footprintIndices.length,Fe.ringIndices=[],L){let Je=[],Ie=[];nt=Ke.vertexLength;for(let at=0;at<Ee.length;at++){let et=Ee[at];et.length&&at!==0&&Ie.push(Je.length/2);let Lt=[],St,Xe;St=et[1].sub(et[0])._perp()._unit(),Fe.ringIndices.push(et.length-1);for(let tt=1;tt<et.length;tt++){let It=et[tt],xt=et[tt===et.length-1?1:tt+1],ut=It.clone();if(ge){Xe=xt.sub(It)._perp()._unit();let vt=St.add(Xe)._unit(),Vt=ge*Math.min(4,1/(St.x*vt.x+St.y*vt.y));ut.x+=Vt*vt.x,ut.y+=Vt*vt.y,ut.x=Math.round(ut.x),ut.y=Math.round(ut.y),St=Xe}if(!G||ge!==0&&!ve||Ne(Lt,ut)||Lt.push(ut),Lp(this.layoutVertexArray,ut.x,ut.y,0,0,1,1,0),this.wallMode){let vt=K(tt,et);zp(this.wallVertexArray,W.joinNormals[tt],!vt)}Ke.vertexLength++,this.footprintVertices.emplaceBack(It.x,It.y),Je.push(It.x,It.y),R&&Dp(this.layoutVertexExtArray,A.projectTilePoint(ut.x,ut.y,h),A.upVector(h,ut.x,ut.y))}G&&(ge===0||ve)&&(Lt.length!==0&&Ne(Lt,Lt[0])&&Lt.pop(),this.groundEffect.addData(Lt,Ue,T))}let Be=this.wallMode?W.indices:Au(Je,Ie);for(let at=0;at<Be.length;at+=3)this.footprintIndices.emplaceBack(Fe.vertexOffset+Be[at+0],Fe.vertexOffset+Be[at+1],Fe.vertexOffset+Be[at+2]),this.indexArray.emplaceBack(nt+Be[at],nt+Be[at+2],nt+Be[at+1]),Ke.primitiveLength++;Fe.indexCount+=Be.length,Fe.vertexCount+=this.footprintVertices.length-Fe.vertexOffset}for(let Je=0;Je<Ee.length;Je++){let Ie=Ee[Je];k.startRing(B,Ie[0]);let Be=Ie.length>4&&Lv(Ie[Ie.length-2],Ie[0],Ie[1]),at=ge?fI(Ie[Ie.length-2],Ie[0],Ie[1],ge):0,et=[],Lt,St,Xe;St=Ie[1].sub(Ie[0])._perp()._unit();let tt=!0;for(let It=1,xt=0;It<Ie.length;It++){let ut=Ie[It-1],vt=Ie[It],Vt=Ie[It===Ie.length-1?1:It+1];if(k.appendEdge(B,vt,ut),uy(vt,ut,Ue)){ge&&(St=Vt.sub(vt)._perp()._unit(),tt=!tt);continue}let Zt=vt.sub(ut)._perp(),Qt=Zt.x/(Math.abs(Zt.x)+Math.abs(Zt.y)),Kt=Zt.y>0?1:0,fi=ut.dist(vt);if(xt+fi>32768&&(xt=0),ge){Xe=Vt.sub(vt)._perp()._unit();let te=Pv(ut,vt,Vt,Cv(St,Xe),ge);isNaN(te)&&(te=0);let Oe=vt.sub(ut)._unit();ut=ut.add(Oe.mult(at))._round(),vt=vt.add(Oe.mult(-te))._round(),at=te,St=Xe,G&&this.zoom>=17&&(Ne(et,ut)||et.push(ut),Ne(et,vt)||et.push(vt))}let oi=Ke.vertexLength,ir=Ie.length>4&&Lv(ut,vt,Vt),ee=zv(xt,Be,tt);if(Lp(this.layoutVertexArray,ut.x,ut.y,Qt,Kt,0,0,ee),Lp(this.layoutVertexArray,ut.x,ut.y,Qt,Kt,0,1,ee),this.wallMode){let te=K(It-1,Ie),Oe=W.joinNormals[It-1];zp(this.wallVertexArray,Oe,te),zp(this.wallVertexArray,Oe,te)}if(xt+=fi,ee=zv(xt,ir,!tt),Be=ir,Lp(this.layoutVertexArray,vt.x,vt.y,Qt,Kt,0,0,ee),Lp(this.layoutVertexArray,vt.x,vt.y,Qt,Kt,0,1,ee),this.wallMode){let te=K(It,Ie),Oe=W.joinNormals[It];zp(this.wallVertexArray,Oe,te),zp(this.wallVertexArray,Oe,te)}if(Ke.vertexLength+=4,this.indexArray.emplaceBack(oi+0,oi+1,oi+2),this.indexArray.emplaceBack(oi+1,oi+3,oi+2),Ke.primitiveLength+=2,ge){let te=nt+(It===1?Ie.length-2:It-2),Oe=It===1?nt:te+1;if(this.indexArray.emplaceBack(oi+1,te,oi+3),this.indexArray.emplaceBack(te,Oe,oi+3),Ke.primitiveLength+=2,Lt===void 0&&(Lt=oi),!uy(Vt,Ie[It],Ue)){let lt=It===Ie.length-1?Lt:Ke.vertexLength;this.indexArray.emplaceBack(oi+2,oi+3,lt),this.indexArray.emplaceBack(oi+3,lt+1,lt),this.indexArray.emplaceBack(oi+3,Oe,lt+1),Ke.primitiveLength+=3}tt=!tt}if(R){let te=this.layoutVertexExtArray,Oe=A.projectTilePoint(ut.x,ut.y,h),lt=A.projectTilePoint(vt.x,vt.y,h),pt=A.upVector(h,ut.x,ut.y),dt=A.upVector(h,vt.x,vt.y);Dp(te,Oe,pt),Dp(te,Oe,pt),Dp(te,lt,dt),Dp(te,lt,dt)}}L&&(nt+=Ie.length-1),G&&ge&&this.zoom>=17&&(et.length!==0&&Ne(et,et[0])&&et.pop(),this.groundEffect.addData(et,Ue,T,ge>0))}this.footprintSegments.push(Fe),it.triangleCount=this.indexArray.length-it.triangleArrayOffset,this.polygonSegments.push(it),++B.footprintSegLen,++B.polygonSegLen}if(B.vertexCount=this.layoutVertexArray.length-B.vertexArrayOffset,B.groundVertexCount=this.groundEffect.vertexArray.length-B.groundVertexArrayOffset,B.vertexCount!==0){if(B.centroidXY=k.borders?Sv:this.encodeCentroid(k,B),this.centroidData.push(B),k.borders){this.featuresOnBorder.push(k);let Ee=this.featuresOnBorder.length-1;for(let Ue=0;Ue<k.borders.length;Ue++)k.borders[Ue][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Ue].push(Ee)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,a,u,f,h,y,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(i,a,u,f,h,y,this.worldview),this.maxHeight=Math.max(this.maxHeight,X)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,s)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}splitToSubtiles(){let e=[];for(let f=0;f<this.centroidData.length;f++){let g=this.centroidData[f],y=+(g.min.y+g.max.y>ht),T=2*y+(+(g.min.x+g.max.x>ht)^y);for(let E=0;E<g.polygonSegLen;E++){let A=g.polygonSegIdx+E;e.push({centroidIdx:f,subtile:T,polygonSegmentIdx:A,triangleSegmentIdx:this.polygonSegments[A].triangleSegIdx})}}let i=new ur;e.sort((f,g)=>f.triangleSegmentIdx===g.triangleSegmentIdx?f.subtile-g.subtile:f.triangleSegmentIdx-g.triangleSegmentIdx);let s=0,a=0,h=0;for(let f of e){if(f.triangleSegmentIdx!==s)break;h++}let u=e.length;for(;a!==e.length;){s=e[a].triangleSegmentIdx;let f=0,g=a,y=a;for(let T=g;T<h&&e[T].subtile===f;T++)y++;for(;g!==h;){let T=e[g];f=T.subtile;let E=this.centroidData[T.centroidIdx].min.clone(),A=this.centroidData[T.centroidIdx].max.clone(),R={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let L=g;L<y;L++){let k=e[L],B=this.polygonSegments[k.polygonSegmentIdx],G=this.centroidData[k.centroidIdx].min,X=this.centroidData[k.centroidIdx].max,W=this.indexArray.uint16;for(let K=B.triangleArrayOffset;K<B.triangleArrayOffset+B.triangleCount;K++)i.emplaceBack(W[3*K],W[3*K+1],W[3*K+2]);R.primitiveLength+=B.triangleCount,E.x=Math.min(E.x,G.x),E.y=Math.min(E.y,G.y),A.x=Math.max(A.x,X.x),A.y=Math.max(A.y,X.y)}R.primitiveLength>0&&this.triangleSubSegments.push({segment:R,min:E,max:A}),g=y;for(let L=g;L<h&&e[L].subtile===e[g].subtile;L++)y++}a=h;for(let T=a;T<u&&e[T].triangleSegmentIdx===e[a].triangleSegmentIdx;T++)h++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,s){let a=new gr;if(this.wallMode){for(let k of this.triangleSubSegments)a.segments.push(k.segment);return a}let h=0,u=0,f=1<<e.canonical.z;if(i){let k=i.getMinMaxForTile(e);k&&(h=k.min,u=k.max)}u+=this.maxHeight;let g=e.toUnwrapped(),y,T=[g.canonical.x/f+g.wrap,g.canonical.y/f],E=[(g.canonical.x+1)/f+g.wrap,(g.canonical.y+1)/f],A=(k,B,G)=>[k[0]*(1-G[0])+B[0]*G[0],k[1]*(1-G[1])+B[1]*G[1]],R=[],L=[];for(let k of this.triangleSubSegments){R[0]=k.min.x/ht,R[1]=k.min.y/ht,L[0]=k.max.x/ht,L[1]=k.max.y/ht;let B=A(T,E,R),G=A(T,E,L);if(new li([B[0],B[1],h],[G[0],G[1],u]).intersectsPrecise(s)===0){y&&(a.segments.push(y),y=void 0);continue}let X=k.segment;y&&y.vertexOffset!==X.vertexOffset&&(a.segments.push(y),y=void 0),y?(y.vertexLength+=X.vertexLength,y.primitiveLength+=X.primitiveLength):y={vertexOffset:X.vertexOffset,primitiveLength:X.primitiveLength,vertexLength:X.vertexLength,primitiveOffset:X.primitiveOffset,sortKey:void 0,vaos:{}}}return y&&a.segments.push(y),a}encodeCentroid(e,i){let s=e.centroid(),a=i.span(),h=Math.min(7,Math.round(a.x*this.tileToMeter/10)),u=Math.min(7,Math.round(a.y*this.tileToMeter/10));return new Qe(re(s.x,1,ht-1)<<3|h,re(s.y,1,ht-1)<<3|u)}encodeBorderCentroid(e){if(!e.borders)return new Qe(0,0);let i=e.borders,s=Number.MAX_VALUE;if(i[0][0]!==s||i[1][0]!==s){let a=i[0][0]!==s?0:1;return new Qe(6|(i[0][0]!==s?0:65528),(i[a][0]+i[a][1])/2<<3|6)}{let a=i[2][0]!==s?2:3;return new Qe((i[a][0]+i[a][1])/2<<3|6,6|(i[2][0]!==s?0:65528))}}showCentroid(e){let i=this.centroidData[e.centroidDataIndex];i.flags&=2147483647,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);let i=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,a=e.flags&Vl?Sv:e.centroidXY,h=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==a.y||h!==a.x){for(let u=i;u<s;++u)this.centroidVertexArray.emplace(u,a.x,a.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;let a=i.getReplacementRegionsForTile(e.toUnwrapped());if($m(this.activeReplacements,a))return;if(this.activeReplacements=a,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(let u of this.centroidData)u.flags&=2147483647;let h=[];for(let u of this.activeReplacements){if(u.order<s)continue;let f=Math.max(1,Math.pow(2,u.footprintTileId.canonical.z-e.canonical.z));if(u.footprint.buildingId){let g=u.footprint.buildingId;for(let y of this.centroidData)y.buildingId===g&&(y.flags|=Vl)}else for(let g of this.centroidData)if(!(g.flags&Vl||u.min.x>g.max.x||g.min.x>u.max.x||u.min.y>g.max.y||g.min.y>u.max.y))for(let y=0;y<g.footprintSegLen;y++){let T=this.footprintSegments[g.footprintSegIdx+y];if(h.length=0,mI(this.footprintVertices,T.vertexOffset,T.vertexCount,u.footprintTileId.canonical,e.canonical,h),sy(u.footprint,h,this.footprintIndices.uint16,T.indexOffset,T.indexCount,-T.vertexOffset,-f)){g.flags|=Vl;break}}}for(let u of this.centroidData)this.writeCentroidToBuffer(u);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,s){let a=!1;for(let h=0;h<s.footprintSegLen;h++){let u=this.footprintSegments[s.footprintSegIdx+h],f=0;for(let g of u.ringIndices){for(let y=f,T=g+f-1;y<g+f;T=y++){let E=this.footprintVertices.int16[2*(y+u.vertexOffset)+0],A=this.footprintVertices.int16[2*(y+u.vertexOffset)+1],R=this.footprintVertices.int16[2*(T+u.vertexOffset)+1];A>i!=R>i&&e<(this.footprintVertices.int16[2*(T+u.vertexOffset)+0]-E)*(i-A)/(R-A)+E&&(a=!a)}f=g}}return a}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0,h=4*(e+ht)*ht+(i+ht);if(this.partLookup.hasOwnProperty(h)){let u=this.partLookup[h];return u?{height:u.height,hidden:!!(u.flags&Vl)}:void 0}for(let u of this.centroidData)e>u.max.x||u.min.x>e||i>u.max.y||u.min.y>i||u.height<=s||this.footprintContainsPoint(e,i,u)&&(s=u.height,this.partLookup[h]=u,a=!!(u.flags&Vl));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.partLookup[h]=void 0}}function Cv(r,e){let i=r.add(e)._unit();return r.x*i.x+r.y*i.y}function fI(r,e,i,s){let a=e.sub(r)._perp()._unit(),h=i.sub(e)._perp()._unit();return Pv(r,e,i,Cv(a,h),s)}function Pv(r,e,i,s,a){let h=Math.sqrt(1-s*s);return Math.min(r.dist(e)/3,e.dist(i)/3,a*h/s)}function uy(r,e,i){return r.x<i[0].x&&e.x<i[0].x||r.x>i[1].x&&e.x>i[1].x||r.y<i[0].y&&e.y<i[0].y||r.y>i[1].y&&e.y>i[1].y}function Rv(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function Lv(r,e,i){if(r.x<0||r.x>=ht||e.x<0||e.x>=ht||i.x<0||i.x>=ht)return!1;let s=i.sub(e),a=s.perp(),h=r.sub(e);return(s.x*h.x+s.y*h.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(h.x*h.x+h.y*h.y))>-.866&&a.x*h.x+a.y*h.y<0}function zv(r,e,i){let s=e?2|r:-3&r;return i?1|s:-2&s}function Dv(){let r=Math.PI/32,e=Math.tan(r),i=b;return i*Math.sqrt(1+2*e*e)-i}function Ov(r,e,i){let s=1<<i.z,a=Z(i.x/s),h=Z((i.x+1)/s),u=Y(i.y/s),f=Y((i.y+1)/s);return function(g,y,T,E,A=0,R){let L=[];if(!g.length||!T||!E)return L;let k=(ce,ue)=>{for(let ge of ce)L.push({polygon:ge,bounds:ue})},B=Math.ceil(Math.log2(T)),G=Math.ceil(Math.log2(E)),X=B-G,W=[];for(let ce=0;ce<Math.abs(X);ce++)W.push(X>0?0:1);for(let ce=0;ce<Math.min(B,G);ce++)W.push(0),W.push(1);let K=g;if(K=Gm(K,y[0].y-A,y[1].y+A,1),K=Gm(K,y[0].x-A,y[1].x+A,0),!K.length)return L;let pe=[];for(W.length?pe.push({polygons:K,bounds:y,depth:0}):k(K,y);pe.length;){let ce=pe.pop(),ue=ce.depth,ge=W[ue],ve=ce.bounds[0],Ne=ce.bounds[1],Ee=ge===0?ve.x:ve.y,Ue=ge===0?Ne.x:Ne.y,nt=R?R(ge,Ee,Ue):.5*(Ee+Ue),qe=Gm(ce.polygons,Ee-A,nt+A,ge),Ke=Gm(ce.polygons,nt-A,Ue+A,ge);if(qe.length){let it=[ve,new Qe(ge===0?nt:Ne.x,ge===1?nt:Ne.y)];W.length>ue+1?pe.push({polygons:qe,bounds:it,depth:ue+1}):k(qe,it)}if(Ke.length){let it=[new Qe(ge===0?nt:ve.x,ge===1?nt:ve.y),Ne];W.length>ue+1?pe.push({polygons:Ke,bounds:it,depth:ue+1}):k(Ke,it)}}return L}(r,e,Math.ceil((h-a)/11.25),Math.ceil((u-f)/11.25),1,(g,y,T)=>{if(g===0)return .5*(y+T);{let E=Y((i.y+y/ht)/s);return(j(.5*(Y((i.y+T/ht)/s)+E))*s-i.y)*ht}})}function mI(r,e,i,s,a,h){let u=Math.pow(2,s.z-a.z);for(let f=0;f<i;f++){let g=r.int16[2*(f+e)+0],y=r.int16[2*(f+e)+1];g=(g+a.x*ht)*u-s.x*ht,y=(y+a.y*ht)*u-s.y*ht,h.push(new Qe(g,y))}}let kv,Fv;Tt(Wm,"FillExtrusionBucket",{omit:["layers","features"]}),Tt(Iv,"PartData"),Tt(Ev,"FootprintSegment"),Tt(Av,"BorderCentroidData"),Tt(hy,"GroundEffect");class rh extends Qe{constructor(e,i,s){super(e,i),this.z=s}}class Bv extends rh{constructor(e,i,s,a){super(e,i,s),this.w=a}}function Nv(r,e,i,s){let a=i==="x"?"y":"x",h=(s-r[i])/(e[i]-r[i]);r[a]=Math.round(r[a]+(e[a]-r[a])*h),r[i]=s,r.hasOwnProperty("z")&&(r.z=Bt(r.z,e.z,h)),r.hasOwnProperty("w")&&(r.w=Bt(r.w,e.w,h))}function Vv(r,e,i,s){let a=i,h=s;for(let u of["x","y"]){let f=r,g=e;f[u]>=g[u]&&(f=e,g=r),f[u]<a&&g[u]>a&&Nv(f,g,u,a),f[u]<h&&g[u]>h&&Nv(g,f,u,h)}}function Xm(r,e,i,s,a,h){let u=[];for(let f=0;f<r.length;f++){let g=r[f],y,T=u.length,E=0;for(let A=0;A<g.length-1;A++){let R=g[A],L=g[A+1],k=0,B=E,G,X;h&&(k=Math.hypot(L.x-R.x,L.y-R.y),E+=k,G=R,X=L),R.x<e&&L.x<e||(R.x<e?R=new Qe(e,R.y+(e-R.x)/(L.x-R.x)*(L.y-R.y))._round():L.x<e&&(L=new Qe(e,R.y+(e-R.x)/(L.x-R.x)*(L.y-R.y))._round()),R.y<i&&L.y<i||(R.y<i?R=new Qe(R.x+(i-R.y)/(L.y-R.y)*(L.x-R.x),i)._round():L.y<i&&(L=new Qe(R.x+(i-R.y)/(L.y-R.y)*(L.x-R.x),i)._round()),R.x>=s&&L.x>=s||(R.x>=s?R=new Qe(s,R.y+(s-R.x)/(L.x-R.x)*(L.y-R.y))._round():L.x>=s&&(L=new Qe(s,R.y+(s-R.x)/(L.x-R.x)*(L.y-R.y))._round()),R.y>=a&&L.y>=a||(R.y>=a?R=new Qe(R.x+(a-R.y)/(L.y-R.y)*(L.x-R.x),a)._round():L.y>=a&&(L=new Qe(R.x+(a-R.y)/(L.y-R.y)*(L.x-R.x),a)._round()),y&&R.equals(y[y.length-1])||(y=[R],u.push(y),h&&h.push({progress:{min:B+Uv(G,X,R)*k,max:1},parentIndex:f,prevPoint:G,nextPoint:X})),y.push(L),h&&(h[h.length-1].progress.max=B+Uv(G,X,L)*k,h[h.length-1].nextPoint=X)))))}if(h&&E>0)for(let A=T;A<u.length;A++)h[A].progress.min/=E,h[A].progress.max/=E}return u}function _I(r,e,i,s,a){if(r.length<2)return void s.push(r);let h=[];for(;e.valid();){let[y,T]=e.get();for(let E=0;E<r.length-1;E++){let A=r[E],R=r[E+1],L=to(A,R,y,T);if(L){let[k]=L,B=new Qe(Bt(A.x,R.x,k),Bt(A.y,R.y,k));h.push({t:E+k,distance:0,point:B})}}e.next()}if(h.length===0)return void s.push(r);h.sort((y,T)=>y.t-T.t);let u=0,f=0,g=[];for(s.push(g);u!==r.length;){if(f===h.length){for(;u!==r.length;)g.length!==0&&g[g.length-1].equals(r[u])||g.push(r[u]),u++;break}h[f].t<=u?(g.length!==0&&g[g.length-1].equals(h[f].point)||g.push(h[f].point),Math.trunc(h[f].t),f++):(g.length!==0&&g[g.length-1].equals(r[u])||g.push(r[u]),u++)}}function Uv(r,e,i){return r.x!==e.x?(i.x-r.x)/(e.x-r.x):r.y!==e.y?(i.y-r.y)/(e.y-r.y):0}function Op(r,e){return r.x*e.x+r.y*e.y}function jv(r,e){if(r.length===1){let i=0,s=e[i++],a;for(;!a||s.equals(a);)if(a=e[i++],!a)return 1/0;for(;i<e.length;i++){let h=e[i],u=r[0],f=a.sub(s),g=h.sub(s),y=u.sub(s),T=Op(f,f),E=Op(f,g),A=Op(g,g),R=Op(y,f),L=Op(y,g),k=T*A-E*E,B=(A*R-E*L)/k,G=(T*L-E*R)/k,X=s.z*(1-B-G)+a.z*B+h.z*G;if(isFinite(X))return X}return 1/0}{let i=1/0;for(let s of e)i=Math.min(i,s.z);return i}}function Gv(r,e,i,s,a,h,u,f){let g=u*a.getElevationAt(r,e,!0,!0),y=h[0]!==0,T=y?h[1]===0?u*(h[0]/7-450):u*function(E,A,R){let L=Math.floor(A[0]/8),k=Math.floor(A[1]/8),B=10*(A[0]-8*L),G=10*(A[1]-8*k),X=E.getElevationAt(L,k,!0,!0),W=E.getMeterToDEM(R),K=Math.floor(.5*(B*W-1)),pe=Math.floor(.5*(G*W-1)),ce=E.tileCoordToPixel(L,k),ue=2*K+1,ge=2*pe+1,ve=function(Ke,it,Fe,Je,Ie){return[Ke.getElevationAtPixel(it,Fe,!0),Ke.getElevationAtPixel(it+Ie,Fe,!0),Ke.getElevationAtPixel(it,Fe+Ie,!0),Ke.getElevationAtPixel(it+Je,Fe+Ie,!0)]}(E,ce.x-K,ce.y-pe,ue,ge),Ne=Math.abs(ve[0]-ve[1]),Ee=Math.abs(ve[2]-ve[3]),Ue=Math.abs(ve[0]-ve[2])+Math.abs(ve[1]-ve[3]),nt=Math.min(.25,.5*W*(Ne+Ee)/ue),qe=Math.min(.25,.5*W*Ue/ge);return X+Math.max(nt*B,qe*G)}(a,h,f):g;return{base:g+(i===0?-1:i),top:y?Math.max(T+s,g+i+2):g+s}}class gI{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class yI{constructor(){this.tasks={},this.taskQueue=[],Ht(["process"],this),this.invoker=new gI(this.process),this.nextId=0}add(e,i){let s=this.nextId++,a=function({type:h,isSymbolTile:u,zoom:f}){return f=f||0,h==="message"?0:h!=="maybePrepare"||u?h!=="parseTile"||u?h==="parseTile"&&u?300-f:h==="maybePrepare"&&u?400-f:500:200-f:100-f}(i);if(a===0){try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:i,priority:a,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;let e=this.pick();if(e===null)return;let i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let a=0;a<this.taskQueue.length;a++){let h=this.tasks[this.taskQueue[a]];h.priority<i&&(i=h.priority,e=a)}if(e===null)return null;let s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class qv{constructor(e,i,s){this.target=e,this.parent=i,this.mapId=s,this.callbacks={},this.cancelCallbacks={},Ht(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new yI}send(e,i,s,a,h=!1,u){let f=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=u,this.callbacks[f]=s);let g=new Set;return this.target.postMessage({id:f,type:e,hasCallback:!!s,targetMapId:a,mustQueue:h,sourceMapId:this.mapId,data:Rs(i,g)},g),{cancel:()=>{s&&delete this.callbacks[f],this.target.postMessage({id:f,type:"<cancel>",targetMapId:a,sourceMapId:this.mapId})}}}receive(e){let i=e.data;if(!i)return;let s=i.id;if(s&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){let a=this.cancelCallbacks[s];delete this.cancelCallbacks[s],a&&a.cancel()}else if(i.mustQueue||Hi(self)){let a=this.callbacks[s],h=this.scheduler.add(()=>this.processTask(s,i),a&&a.metadata||{type:"message"});h&&(this.cancelCallbacks[s]=h)}else this.processTask(s,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){let s=this.callbacks[e];delete this.callbacks[e],s&&(i.error?s($n(i.error)):s(null,$n(i.data)))}else{let s=new Set,a=i.hasCallback?(u,f)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:u?Rs(u):null,data:Rs(f,s)},s)}:()=>{},h=$n(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,h,a);else if(this.parent.getWorkerSource){let u=i.type.split("."),{source:f,scope:g}=h;this.parent.getWorkerSource(i.sourceMapId,u[0],f,g)[u[1]](h,a)}else a(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var kp={workerUrl:"",workerClass:null,workerParams:void 0};let dy="mapboxgl_preloaded_worker_pool";class nh{constructor(){this.active={}}acquire(e,i=nh.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(kp.workerClass!=null?new kp.workerClass:new self.Worker(kp.workerUrl,kp.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[dy]}numActive(){return Object.keys(this.active).length}}nh.workerCount=2;class Cu{constructor(e,i,s="Worker",a=nh.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=He();let h=this.workerPool.acquire(this.id,a);for(let u=0;u<h.length;u++){let f=new Cu.Actor(h[u],i,this.id);f.name=`${s} ${u}`,this.actors.push(f)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,s){be(this.actors,(a,h)=>{a.send(e,i,h)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let Fp,py;function Ym(){return Fp||(Fp=new nh),Fp}Cu.Actor=qv;class xI{constructor(e){this.module=e}createIntArray(e){let i=new Int32Array(e),s=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heap32.set(i,s/i.BYTES_PER_ELEMENT),s}createFloatArray(e){let i=new Float32Array(e),s=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heapF32.set(i,s/i.BYTES_PER_ELEMENT),s}createStringBuffer(e){let i=this.module.malloc(e.length+1);for(let s=0;s<e.length;++s)this.module.heapU8[i+s]=e.charCodeAt(s);return this.module.heapU8[i+e.length]=0,i}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){let i=e.entranceColorRgb,s=e.facadeGlazingColorRgb,a=e.roofColorRgb,h=e.wallColorRgb,u=e.normalScale;this.module.setStyle(i[0],i[1],i[2],s[0],s[1],s[2],a[0],a[1],a[2],h[0],h[1],h[2],u[0],u[1],u[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,i){this.module.setFacadeOptions(e,i?1:0)}setFauxFacadeOptions(e,i,s){this.module.setFauxFacadeOptions(e?1:0,i?1:0,s)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,i){for(let f of e){let g=this.createStringBuffer(f.roofType),y=[0],T=[];for(let R of f.coordinates)if(Array.isArray(R)){for(let L of R)T.push(L.x),T.push(L.y);y.push(T.length)}let E=this.createIntArray(y),A=this.createFloatArray(T);this.module.addFeature(f.id,f.sourceId,f.minHeight,f.height,g,f.roofType.length,A,E,y.length-1),this.module.free(g),this.module.free(E),this.module.free(A)}for(let f of i){let g;g=f.entrances?JSON.parse(f.entrances):[];let y=this.createFloatArray(g),T=[];for(let A of f.coordinates)T.push(A.x),T.push(A.y);let E=this.createFloatArray(T);this.module.addFacade(f.sourceId,f.crossPerc,f.distanceToRoad,y,g.length,E,T.length),this.module.free(y),this.module.free(E)}if(!this.module.generateMesh()){let f=this.module.getLastError();return this.readStringBuffer(f)}let s=this.module.getMeshCount(),a=new Array(s);for(let f=0;f<s;f++){let g=this.module.getPositionsPtr(f),y=this.module.getPositionsLength(f),T=new Float32Array(this.module.heapF32.buffer,g,y),E=this.module.getNormalsPtr(f),A=this.module.getNormalsLength(f),R=new Float32Array(this.module.heapF32.buffer,E,A),L=this.module.getColorsPtr(f),k=this.module.getColorsLength(f),B=new Uint8Array(this.module.heapU8.buffer,L,k),G=this.module.getAOPtr(f),X=this.module.getAOLength(f),W=new Float32Array(this.module.heapF32.buffer,G,X),K=this.module.getUVPtr(f),pe=this.module.getUVLength(f),ce=new Float32Array(this.module.heapF32.buffer,K,pe),ue=this.module.getFauxFacadePtr(f),ge=this.module.getFauxFacadeLength(f),ve=new Uint8Array(this.module.heapU8.buffer,ue,ge),Ne=this.module.getIndicesPtr(f),Ee=this.module.getIndicesLength(f),Ue=new Int32Array(this.module.heap32.buffer,Ne,Ee),nt=this.module.getBuildingPart(f),qe=this.readStringBuffer(nt);a[f]={positions:T,normals:R,colors:B,ao:W,uv:ce,isFauxFacade:ve,indices:Ue,buildingPart:qe}}let h=this.module.getRingCount(),u=[];for(let f=0;f<h;f++){let g=this.module.getRingPtr(f),y=this.module.getRingLength(f),T=new Float32Array(this.module.heapF32.buffer,g,y);u.push(T)}return{meshes:a,modifiedPolygonRings:u}}}let Bp,fy,zs,Pu,my,Ru=null,Lu=null,Hv=null,Km=null;function $v(){return Hi(self)&&self.worker.dracoUrl?self.worker.dracoUrl:fy||mn.DRACO_URL}function Zv(){if(Hi(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Pu)return Pu;let r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Pu=WebAssembly.validate(r)?mn.MESHOPT_SIMD_URL:mn.MESHOPT_URL,Pu}function vI(){return Km}let Jm={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},bI={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Np={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Wv(r,e,i){let s=i.json.bufferViews.length,a=i.buffers.length;e.bufferView=s,i.json.bufferViews[s]={buffer:a,byteLength:r.byteLength},i.buffers[a]=r}let _y="KHR_draco_mesh_compression";function wI(r,e){let i=r.extensions&&r.extensions[_y];if(!i)return;let s=new zs.Decoder,a=Jv(e,i.bufferView),h=new zs.Mesh;if(!s.DecodeArrayToMesh(a,a.byteLength,h))throw new Error("Failed to decode Draco mesh");let u=e.json.accessors[r.indices],f=Jm[u.componentType],g=u.count*f.BYTES_PER_ELEMENT,y=zs._malloc(g);f===Uint16Array?s.GetTrianglesUInt16Array(h,g,y):s.GetTrianglesUInt32Array(h,g,y),Wv(zs.memory.buffer.slice(y,y+g),u,e),zs._free(y);for(let T of Object.keys(i.attributes)){let E=s.GetAttributeByUniqueId(h,i.attributes[T]),A=e.json.accessors[r.attributes[T]],R=bI[A.componentType],L=A.count*Np[A.type]*Jm[A.componentType].BYTES_PER_ELEMENT,k=zs._malloc(L);s.GetAttributeDataArrayForAllPoints(h,E,zs[R],L,k),Wv(zs.memory.buffer.slice(k,k+L),A,e),zs._free(k)}s.destroy(),h.destroy(),delete r.extensions[_y]}let Qm="EXT_meshopt_compression";function TI(r,e){if(!r.extensions||!r.extensions[Qm])return;let i=r.extensions[Qm],s=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),a=new Uint8Array(i.count*i.byteStride);my.decodeGltfBuffer(a,i.count,i.byteStride,s,i.mode,i.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=a.buffer,delete r.extensions[Qm]}let Xv=1179937895,Yv=new TextDecoder("utf8");function Kv(r,e){return new URL(r,e).href}function SI(r,e,i,s){return fetch(Kv(r.uri,s)).then(a=>a.arrayBuffer()).then(a=>{e.buffers[i]=a})}function Jv(r,e){let i=r.json.bufferViews[e];return new Uint8Array(r.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function EI(r,e,i,s){if(r.uri){let a=Kv(r.uri,s);return fetch(a).then(h=>h.blob()).then(h=>createImageBitmap(h)).then(h=>{e.images[i]=h})}if(r.bufferView!==void 0){let a=Jv(e,r.bufferView),h=new Blob([a],{type:r.mimeType});return createImageBitmap(h).then(u=>{e.images[i]=u})}}function Qv(r,e=0,i){let s={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===Xv){let T=new Uint32Array(r,e),E=2,A=(T[E++]>>2)-3,R=T[E++]>>2;if(E++,s.json=JSON.parse(Yv.decode(T.subarray(E,E+R))),E+=R,E<A){let L=T[E++];E++;let k=e+(E<<2);s.buffers[0]=r.slice(k,k+L)}}else s.json=JSON.parse(Yv.decode(new Uint8Array(r,e)));let{buffers:a,images:h,meshes:u,extensionsUsed:f,bufferViews:g}=s.json,y=Promise.resolve();if(a){let T=[];for(let E=0;E<a.length;E++){let A=a[E];A.uri?T.push(SI(A,s,E,i)):s.buffers[E]||(s.buffers[E]=null)}y=Promise.all(T)}return y.then(()=>{let T=[],E=f&&f.includes(_y),A=f&&f.includes(Qm);if(E&&T.push(function(){if(!zs)return Bp??(Bp=function(R){let L,k=null;function B(){L=new Uint8Array(k.buffer)}function G(){throw new Error("Unexpected Draco error.")}let X={a:{a:G,d:function(W,K,pe){return L.copyWithin(W,K,K+pe)},c:function(W){let K=L.length,pe=Math.max(W>>>0,Math.ceil(1.2*K)),ce=Math.ceil((pe-K)/65536);try{return k.grow(ce),B(),!0}catch{return!1}},b:G}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(R,X):R.then(W=>W.arrayBuffer()).then(W=>WebAssembly.instantiate(W,X))).then(W=>{let{Rb:K,Qb:pe,P:ce,T:ue,X:ge,Ja:ve,La:Ne,Qa:Ee,Va:Ue,Wa:nt,eb:qe,jb:Ke,f:it,e:Fe,yb:Je,zb:Ie,Ab:Be,Bb:at,Db:et,Gb:Lt}=W.instance.exports;k=Fe;let St=(()=>{let Xe=0,tt=0,It=0,xt=0;return ut=>{It&&(K(xt),K(Xe),tt+=It,It=Xe=0),Xe||(tt+=128,Xe=pe(tt));let vt=ut.length+7&-8,Vt=Xe;vt>=tt&&(It=vt,Vt=xt=pe(vt));for(let Zt=0;Zt<ut.length;Zt++)L[Vt+Zt]=ut[Zt];return Vt}})();return B(),it(),{memory:Fe,_free:K,_malloc:pe,Mesh:class{constructor(){this.ptr=ce()}destroy(){ue(this.ptr)}},Decoder:class{constructor(){this.ptr=ve()}destroy(){Ke(this.ptr)}DecodeArrayToMesh(Xe,tt,It){let xt=St(Xe),ut=Ne(this.ptr,xt,tt,It.ptr);return!!ge(ut)}GetAttributeByUniqueId(Xe,tt){return{ptr:Ee(this.ptr,Xe.ptr,tt)}}GetTrianglesUInt16Array(Xe,tt,It){Ue(this.ptr,Xe.ptr,tt,It)}GetTrianglesUInt32Array(Xe,tt,It){nt(this.ptr,Xe.ptr,tt,It)}GetAttributeDataArrayForAllPoints(Xe,tt,It,xt,ut){qe(this.ptr,Xe.ptr,tt.ptr,It,xt,ut)}},DT_INT8:Je(),DT_UINT8:Ie(),DT_INT16:Be(),DT_UINT16:at(),DT_UINT32:et(),DT_FLOAT32:Lt()}})}(fetch($v())),Bp.then(R=>{zs=R,Bp=void 0}))}()),A&&T.push(function(){if(my)return;let R=function(L){let k,B=WebAssembly.instantiateStreaming(L,{}).then(W=>{k=W.instance,k.exports.__wasm_call_ctors()}),G={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},X={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:B,supported:!0,decodeGltfBuffer(W,K,pe,ce,ue,ge){(function(ve,Ne,Ee,Ue,nt,qe,Ke){let it=ve.exports.sbrk,Fe=Ue+3&-4,Je=it(Fe*nt),Ie=it(qe.length),Be=new Uint8Array(ve.exports.memory.buffer);Be.set(qe,Ie);let at=Ne(Je,Ue,nt,Ie,qe.length);if(at===0&&Ke&&Ke(Je,Fe,nt),Ee.set(Be.subarray(Je,Je+Ue*nt)),it(Je-it(0)),at!==0)throw new Error(`Malformed buffer data: ${at}`)})(k,k.exports[X[ue]],W,K,pe,ce,k.exports[G[ge]])}}}(fetch(Zv()));return R.ready.then(()=>{my=R})}()),h)for(let R=0;R<h.length;R++)T.push(EI(h[R],s,R,i));return(T.length?Promise.all(T):Promise.resolve()).then(()=>{if(E&&u)for(let{primitives:R}of u)for(let L of R)wI(L,s);if(A&&u&&g)for(let R of g)TI(R,s);return s})})}function gy(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function yy(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class xy{constructor(e,i,s,a){this.context=e,this.format=s,this.useMipmap=a&&a.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:a&&a.premultiply})}update(e,i){let s=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,a=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:h}=this,{gl:u}=h,{x:f,y:g}=i&&i.position?i.position:{x:0,y:0},y=f+s,T=g+a;!this.size||this.size[0]===y&&this.size[1]===T||(u.bindTexture(u.TEXTURE_2D,null),u.deleteTexture(this.texture),this.texture=u.createTexture(),this.size=null),u.bindTexture(u.TEXTURE_2D,this.texture),h.pixelStoreUnpackFlipY.set(!1),h.pixelStoreUnpack.set(1),h.pixelStoreUnpackPremultiplyAlpha.set(this.format===u.RGBA8&&(!i||i.premultiply!==!1));let E=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&y>0&&T>0){let A=this.useMipmap?Math.floor(Math.log2(Math.max(y,T)))+1:1;u.texStorage2D(u.TEXTURE_2D,A,this.format,y,T),this.size=[y,T]}if(this.size)if(E)u.texSubImage2D(u.TEXTURE_2D,0,f,g,gy(this.format),yy(this.format),e);else{let A=e.data;A&&u.texSubImage2D(u.TEXTURE_2D,0,f,g,s,a,gy(this.format),yy(this.format),A)}this.useMipmap&&u.generateMipmap(u.TEXTURE_2D)}bind(e,i,s=!1){let{context:a}=this,{gl:h}=a;h.bindTexture(h.TEXTURE_2D,this.texture),e!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===h.NEAREST?h.NEAREST_MIPMAP_NEAREST:h.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,s,a,h){let{context:u}=this,{gl:f}=u;f.bindTexture(f.TEXTURE_2D,this.texture),i!==this.magFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,s),this.wrapS=s),a!==this.wrapT&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,a),this.wrapT=a),h!==this.compareMode&&(h?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.COMPARE_REF_TO_TEXTURE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_FUNC,h)):f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.NONE),this.compareMode=h)}destroy(){let{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Vp{constructor(e,i){this.context=e,this.texture=i}bind(e,i){let{context:s}=this,{gl:a}=s;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}}let II=gi([{name:"a_pos_3f",components:3,type:"Float32"}]),AI=gi([{name:"a_color_3f",components:3,type:"Float32"}]),MI=gi([{name:"a_color_4f",components:4,type:"Float32"}]),CI=gi([{name:"a_uv_2f",components:2,type:"Float32"}]),PI=gi([{name:"a_normal_3f",components:3,type:"Float32"}]),RI=gi([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),LI=gi([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function e1(r,e){let i=e_(r.projection,r.zoom,r.width,r.height),s=function(h,u,f,g,y){let T=new C(f.lng-180*Ul,f.lat),E=new C(f.lng+180*Ul,f.lat),A=h.project(T.lng,T.lat),R=h.project(E.lng,E.lat),L=-Math.atan2(R.y-A.y,R.x-A.x),k=le.fromLngLat(f);k.y=re(k.y,-1+Ul,1-Ul);let B=k.toLngLat(),G=h.project(B.lng,B.lat),X=le.fromLngLat(B);X.x+=Ul;let W=X.toLngLat(),K=h.project(W.lng,W.lat),pe=i1(K.x-G.x,K.y-G.y,L),ce=le.fromLngLat(B);ce.y+=Ul;let ue=ce.toLngLat(),ge=h.project(ue.lng,ue.lat),ve=i1(ge.x-G.x,ge.y-G.y,L),Ne=Math.abs(pe.x)/Math.abs(ve.y),Ee=xe([]);At(Ee,Ee,-L*(1-(y?0:g)));let Ue=xe([]);return ft(Ue,Ue,[1,1-(1-Ne)*g,1]),Ue[4]=-ve.x/ve.y*g,At(Ue,Ue,L),Te(Ue,Ee,Ue),Ue}(r.projection,0,r.center,i,e),a=t1(r);return ft(s,s,[a,a,1]),s}function t1(r){let e=r.projection,i=e_(r.projection,r.zoom,r.width,r.height),s=vy(e,r.center),a=vy(e,C.convert(e.center));return Math.pow(2,s*i+(1-i)*a)}function e_(r,e,i,s,a=1/0){let h=r.range;if(!h)return 0;let u=Math.min(a,Math.max(i,s)),f=Math.log(u/1024)/Math.LN2;return ye(h[0]+f,h[1]+f,e)}let Ul=1/4e4;function vy(r,e){let i=re(e.lat,-ne,ne),s=new C(e.lng-180*Ul,i),a=new C(e.lng+180*Ul,i),h=r.project(s.lng,i),u=r.project(a.lng,i),f=le.fromLngLat(s),g=le.fromLngLat(a),y=u.x-h.x,T=u.y-h.y,E=g.x-f.x,A=g.y-f.y,R=Math.sqrt((E*E+A*A)/(y*y+T*T));return Math.log(R)/Math.LN2}function i1(r,e,i){let s=Math.cos(i),a=Math.sin(i);return{x:r*s-e*a,y:r*a+e*s}}function r1(r,e,i){xe(r),At(r,r,Ai(e[2])),_t(r,r,Ai(e[0])),Pt(r,r,Ai(e[1])),ft(r,r,i),Te(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function t_(r,e,i,s,a,h,u,f){let g=[i[0]-e[0],i[1]-e[1],0],y=[s[0]-e[0],s[1]-e[1],0];if(Ni(g)<1e-12||Ni(y)<1e-12)return ws(r);let T=Vr([],g,y);Oi(T,T),mr(y,s,e),g[2]=(h-a)*f,y[2]=(u-a)*f;let E=g;return Vr(E,g,y),Oi(E,E),Ja(r,T,E)}function by(r,e,i=!1){let s=Bl(e.zoom),a=function(h,u,f){let g=u.worldSize,y=[h[12],h[13],h[14]],T=Y(y[1]/g),E=Z(y[0]/g),A=xe([]),R=U(1,T)*g,L=U(1,0)*g*de(T,u.zoom),k=1/Xg(g),B=L*k;if(f){let K=e_(u.projection,u.zoom,u.width,u.height,1024);B=k*u.projection.pixelSpaceConversion(u.center.lat,g,K)}let G=x(T,E);vi(G,G,Xi([],Oi([],G),R*B*y[2]));let X=function(K){let pe=[K[0],K[1],K[2]],ce=[0,1,0],ue=Vr([],ce,pe);return Vr(ce,pe,ue),Ro(ce)===0&&(ce=[0,1,0],Vr(ue,pe,ce)),Oi(ue,ue),Oi(ce,ce),Oi(pe,pe),[ue[0],ue[1],ue[2],0,ce[0],ce[1],ce[2],0,pe[0],pe[1],pe[2],0,K[0],K[1],K[2],1]}(G);ft(A,A,[B,B,B*R]),We(A,A,[-y[0],-y[1],-y[2]]);let W=Te([],u.globeMatrix,X);return Te(W,W,A),Te(W,W,h),W}(r,e,i);if(s>0){let h=function(u,f){let g=f.worldSize,y=U(1,0)*g*de(f.center.lat,f.zoom)/Xg(g),T=U(1,f.center.lat)*g,E=xe([]);return Pt(E,E,Ai(f.center.lng)),_t(E,E,Ai(f.center.lat)),We(E,E,[0,0,Cn]),ft(E,E,[y,y,y*T]),We(E,E,[f.point.x-.5*g,f.point.y-.5*g,0]),Te(E,E,u),Te(E,f.globeMatrix,E)}(r,e);return function(u,f,g){let y=(L,k,B)=>{let G=Ni(L),X=Ni(k),W=ja(L,k,B);return Xi(W,W,1/Ni(W)*Bt(G,X,B))},T=y([u[0],u[1],u[2]],[f[0],f[1],f[2]],g),E=y([u[4],u[5],u[6]],[f[4],f[5],f[6]],g),A=y([u[8],u[9],u[10]],[f[8],f[9],f[10]],g),R=ja([u[12],u[13],u[14]],[f[12],f[13],f[14]],g);return[T[0],T[1],T[2],0,E[0],E[1],E[2],0,A[0],A[1],A[2],0,R[0],R[1],R[2],1]}(a,h,s)}return a}function n1(r,e,i,s){let a=li.projectAabbCorners(s,i),h=Number.MAX_VALUE,u=-1;for(let y=0;y<a.length;++y){let T=a[y];T[0]=(.5*T[0]+.5)*e.width,T[1]=(.5-.5*T[1])*e.height,T[2]<h&&(u=y,h=T[2])}let f=y=>new Qe(a[y][0],a[y][1]),g;switch(u){case 0:case 6:g=[f(1),f(5),f(4),f(7),f(3),f(2),f(1)];break;case 1:case 7:g=[f(0),f(4),f(5),f(6),f(2),f(3),f(0)];break;case 3:case 5:g=[f(1),f(0),f(4),f(7),f(6),f(2),f(1)];break;default:g=[f(1),f(5),f(6),f(7),f(3),f(0),f(1)]}if($i(r,g))return h}let oh=64,zu={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function o1(r,e,i,s,a,h,u,f,g,y=!1){let T=i.zoom,E=i.project(s),A=de(s.lat,T),R=1/A;xe(r),We(r,r,[E.x+u[0]*R,E.y+u[1]*R,u[2]]);let L=1,k=1,B=i.worldSize;if(y){if(i.projection.name==="mercator"){let K=0;i.elevation&&(K=i.elevation.getAtPointOrZero(new le(E.x/B,E.y/B),0));let pe=Kn([],[E.x,E.y,K,1],i.projMatrix)[3]/i.cameraToCenterDistance;L=pe,k=pe*de(i.center.lat,T)}else if(i.projection.name==="globe"){let K=by(r,i),pe=[0,0,0,1];Kn(pe,pe,Te([],i.projMatrix,K));let ce=pe[3]/i.cameraToCenterDistance,ue=Bl(T),ge=i.projection.pixelsPerMeter(s.lat,B)*de(s.lat,T),ve=i.projection.pixelsPerMeter(i.center.lat,B)*de(i.center.lat,T);L=ce/Bt(ge,he(i.center.lat),ue),k=ce*A/ge,L*=ve,k*=ve}}else L=R;ft(r,r,[L,L,k]);let G=[...r],X=e.orientation,W=[];if(r1(W,[X[0]+a[0],X[1]+a[1],X[2]+a[2]],h),Te(r,G,W),f&&i.elevation){let K=0,pe=[];if(g&&i.elevation){K=function(ue,ge,ve,Ne,Ee){let Ue=ge.elevation;if(!Ue)return 0;let nt=li.projectAabbCorners(ve,Ne),qe=U(1,Ee.lat)*ge.worldSize,Ke=function(tt,It){let xt=[0,0,1],ut=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let vt of ut){let Vt=tt[vt.corners[0]],Zt=tt[vt.corners[1]],Qt=tt[vt.corners[2]],Kt=[Zt[0]-Vt[0],Zt[1]-Vt[1],It*(Zt[2]-Vt[2])],fi=Vr(Kt,Kt,[Qt[0]-Vt[0],Qt[1]-Vt[1],It*(Qt[2]-Vt[2])]);Oi(fi,fi),vt.dotProductWithUp=or(fi,xt)}return ut.sort((vt,Vt)=>vt.dotProductWithUp-Vt.dotProductWithUp),ut[0].corners}(nt,qe),it=nt[Ke[0]],Fe=nt[Ke[1]],Je=nt[Ke[2]],Ie=nt[Ke[3]],Be=Ue.getAtPointOrZero(new le(it[0]/ge.worldSize,it[1]/ge.worldSize),0),at=Ue.getAtPointOrZero(new le(Fe[0]/ge.worldSize,Fe[1]/ge.worldSize),0),et=Ue.getAtPointOrZero(new le(Je[0]/ge.worldSize,Je[1]/ge.worldSize),0),Lt=Ue.getAtPointOrZero(new le(Ie[0]/ge.worldSize,Ie[1]/ge.worldSize),0),St=(Be+Lt)/2,Xe=(at+et)/2;return St>Xe?at<et?t_(ue,Fe,Ie,it,at,Lt,Be,qe):t_(ue,Je,it,Ie,et,Be,Lt,qe):Be<Lt?t_(ue,it,Fe,Je,Be,at,et,qe):t_(ue,Ie,Je,Fe,Lt,et,at,qe),Math.max(St,Xe)}(pe,i,e.aabb,r,s);let ce=Te([],Ft([],pe),W);Te(r,G,ce)}else K=i.elevation.getAtPointOrZero(new le(E.x/B,E.y/B),0);K!==0&&(r[14]+=K)}}function Up(r,e,i=!1){r.uploaded||(r.gfxTexture=new xy(e,r.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function zI(r,e,i){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,II.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,PI.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,CI.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?AI:MI).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,LI.members,!0)),r.segments=gr.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);let s=r.material;s.pbrMetallicRoughness.baseColorTexture&&Up(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&Up(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&Up(s.normalTexture,e),s.occlusionTexture&&Up(s.occlusionTexture,e,i),s.emissionTexture&&Up(s.emissionTexture,e)}function wy(r,e,i){if(r.meshes)for(let s of r.meshes)zI(s,e,i);if(r.children)for(let s of r.children)wy(s,e,i)}function i_(r){if(r.meshes)for(let e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(let e of r.children)i_(e)}function Ty(r){if(r.meshes)for(let i of r.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(let i of r.children)Ty(i)}function sh(r,e){let i=r.json.bufferViews[e.bufferView],s=Jm[e.componentType];return new s(r.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==Np[e.type]*s.BYTES_PER_ELEMENT?i.byteStride/s.BYTES_PER_ELEMENT:Np[e.type]))}function Sy(r,e,i,s){let a=Jm[e.componentType],h=function(T){switch(T){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(a),u=r.json.bufferViews[e.bufferView],f=u.byteStride?u.byteStride/a.BYTES_PER_ELEMENT:Np[e.type],g=i.float32,y=g.length/i.capacity;for(let T=0,E=0;T<e.count*f;T+=f,E+=y)for(let A=0;A<y;A++)g[E+A]=s[T+A]*h;i._trim()}function DI(r,e,i){let s=r.indices,a=r.attributes,h={};h.indexArray=new ur;let u=e.json.accessors[s],f=u.count/3;h.indexArray.reserve(f);let g=sh(e,u);for(let A=0;A<f;A++)h.indexArray.emplaceBack(g[3*A],g[3*A+1],g[3*A+2]);h.indexArray._trim(),h.vertexArray=new yo;let y=e.json.accessors[a.POSITION];h.vertexArray.reserve(y.count);let T=sh(e,y);for(let A=0;A<y.count;A++)h.vertexArray.emplaceBack(T[3*A],T[3*A+1],T[3*A+2]);if(h.vertexArray._trim(),h.aabb=new li(y.min,y.max),h.centroid=function(A,R){let L=[0,0,0],k=A.length;if(k>0){for(let B=0;B<k;B++){let G=3*A[B];L[0]+=R[G],L[1]+=R[G+1],L[2]+=R[G+2]}L[0]/=k,L[1]/=k,L[2]/=k}return L}(g,T),a.COLOR_0!==void 0){let A=e.json.accessors[a.COLOR_0],R=Np[A.type],L=sh(e,A);h.colorArray=R===3?new yo:new aa,h.colorArray.resize(A.count),Sy(e,A,h.colorArray,L)}if(a.NORMAL!==void 0){h.normalArray=new yo;let A=e.json.accessors[a.NORMAL];h.normalArray.resize(A.count);let R=sh(e,A);Sy(e,A,h.normalArray,R)}if(a.TEXCOORD_0!==void 0&&i.length>0){h.texcoordArray=new la;let A=e.json.accessors[a.TEXCOORD_0];h.texcoordArray.resize(A.count);let R=sh(e,A);Sy(e,A,h.texcoordArray,R)}if(a._FEATURE_ID_RGBA4444!==void 0){let A=e.json.accessors[a._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(h.featureData=sh(e,A))}a._FEATURE_RGBA4444!==void 0&&(h.featureData=new Uint32Array(sh(e,e.json.accessors[a._FEATURE_RGBA4444]).buffer));let E=r.material;return h.material=function(A,R){let{emissiveFactor:L=[0,0,0],alphaMode:k="OPAQUE",alphaCutoff:B=.5,normalTexture:G,occlusionTexture:X,emissiveTexture:W,doubleSided:K}=A,{baseColorFactor:pe=[1,1,1,1],metallicFactor:ce=1,roughnessFactor:ue=1,baseColorTexture:ge,metallicRoughnessTexture:ve}=A.pbrMetallicRoughness||{},Ne=X?R[X.index]:void 0;if(X&&X.extensions&&X.extensions.KHR_texture_transform&&Ne){let Ee=X.extensions.KHR_texture_transform;Ne.offsetScale=[Ee.offset[0],Ee.offset[1],Ee.scale[0],Ee.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new ki(...pe),metallicFactor:ce,roughnessFactor:ue,baseColorTexture:ge?R[ge.index]:void 0,metallicRoughnessTexture:ve?R[ve.index]:void 0},doubleSided:K,emissiveFactor:new ki(...L),alphaMode:k,alphaCutoff:B,normalTexture:G?R[G.index]:void 0,occlusionTexture:Ne,emissionTexture:W?R[W.index]:void 0,defined:A.defined===void 0}}(E!==void 0?e.json.materials[E]:{defined:!1},i),h}function s1(r,e,i){let{matrix:s,rotation:a,translation:h,scale:u,mesh:f,extras:g,children:y}=r,T={};if(T.matrix=s||function(E,A,R,L){var k=A[0],B=A[1],G=A[2],X=A[3],W=k+k,K=B+B,pe=G+G,ce=k*W,ue=k*K,ge=k*pe,ve=B*K,Ne=B*pe,Ee=G*pe,Ue=X*W,nt=X*K,qe=X*pe,Ke=L[0],it=L[1],Fe=L[2];return E[0]=(1-(ve+Ee))*Ke,E[1]=(ue+qe)*Ke,E[2]=(ge-nt)*Ke,E[3]=0,E[4]=(ue-qe)*it,E[5]=(1-(ce+Ee))*it,E[6]=(Ne+Ue)*it,E[7]=0,E[8]=(ge+nt)*Fe,E[9]=(Ne-Ue)*Fe,E[10]=(1-(ce+ve))*Fe,E[11]=0,E[12]=R[0],E[13]=R[1],E[14]=R[2],E[15]=1,E}([],a||[0,0,0,1],h||[0,0,0],u||[1,1,1]),f!==void 0){T.meshes=i[f];let E=T.anchor=[0,0];for(let A of T.meshes){let{min:R,max:L}=A.aabb;E[0]+=R[0]+L[0],E[1]+=R[1]+L[1]}E[0]=Math.floor(E[0]/T.meshes.length/2),E[1]=Math.floor(E[1]/T.meshes.length/2)}if(g&&(g.id&&(T.id=g.id),g.lights&&(T.lights=function(E){if(!E.length)return[];let A=function(G){let X=atob(G),W=new Uint8Array(X.length);for(let K=0;K<X.length;K++)W[K]=X.codePointAt(K);return W}(E),R=[],L=A.length/24,k=new Uint16Array(A.buffer),B=new Float32Array(A.buffer);for(let G=0;G<L;G++){let X=k[2*G*6]/30,W=k[2*G*6+1]/30,K=k[2*G*6+10]/100,pe=B[6*G+1],ce=B[6*G+2],ue=B[6*G+3],ge=B[6*G+4],ve=ue-pe,Ne=ge-ce,Ee=Math.hypot(ve,Ne);R.push({pos:[pe+.5*ve,ce+.5*Ne,W],normal:[Ne/Ee,-ve/Ee,0],width:Ee,height:X,depth:K,points:[pe,ce,ue,ge]})}return R}(g.lights))),y){let E=[];for(let A of y)E.push(s1(e.json.nodes[A],e,i));T.children=E}return T}function OI(r){if(r.vertices.length===0||r.indices.length===0)return null;let e=new qm(r.vertices,r.indices,8,256),[i,s]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:i,max:s}}function kI(r){if(!r.extras||!r.extras.ground)return null;let e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;let i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;let s=[];for(let u of i){if(!Array.isArray(u)||u.length!==2)continue;let f=u[0],g=u[1];typeof f=="number"&&typeof g=="number"&&s.push(new Qe(f,g))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let a=0;for(let u=0;u<s.length;u++){let f=s[u],g=s[(u+1)%s.length],y=s[(u+2)%s.length];a+=(f.x-g.x)*(y.y-g.y)-(y.x-g.x)*(f.y-g.y)}a>0&&s.reverse();let h=Au(s.flatMap(u=>[u.x,u.y]),[]);return h.length===0?null:{vertices:s,indices:h}}function FI(r,e){let i=[],s=[],a=0,h=[];for(let u of r){a=i.length;let f=u.vertexArray.float32,g=u.indexArray.uint16;for(let y=0;y<u.vertexArray.length;y++)h[0]=f[3*y+0],h[1]=f[3*y+1],h[2]=f[3*y+2],Lr(h,h,e),i.push(new Qe(h[0],h[1]));for(let y=0;y<3*u.indexArray.length;y++)s.push(g[y]+a)}if(s.length%3!=0)return null;for(let u=0;u<s.length;u+=3){let f=i[s[u+0]],g=i[s[u+1]],y=i[s[u+2]];(f.x-g.x)*(y.y-g.y)-(y.x-g.x)*(f.y-g.y)>0&&([s[u+1],s[u+2]]=[s[u+2],s[u+1]])}return{vertices:i,indices:s}}function a1(r){let e=function(g,y){let T=[],E=WebGL2RenderingContext;if(g.json.textures)for(let A of g.json.textures){let R={magFilter:E.LINEAR,minFilter:E.NEAREST,wrapS:E.REPEAT,wrapT:E.REPEAT};A.sampler!==void 0&&Object.assign(R,g.json.samplers[A.sampler]),T.push({image:y[A.source],sampler:R,uploaded:!1})}return T}(r,r.images),i=function(g,y){let T=[];for(let E of g.json.meshes){let A=[];for(let R of E.primitives)A.push(DI(R,g,y));T.push(A)}return T}(r,e),{scenes:s,scene:a,nodes:h}=r.json,u=s?s[a||0].nodes:h,f=[];for(let g of u)f.push(s1(h[g],r,i));return function(g,y,T){let E={},A=new Set;for(let R=0;R<g.length;R++){let L=T[y[R]];if(!L.extras)continue;let k=L.extras["mapbox:footprint:version"],B=L.extras["mapbox:footprint:id"];(k||B)&&A.add(R),k==="1.0.0"&&B&&(E[B]=R)}for(let R=0;R<g.length;R++){if(A.has(R))continue;let L=g[R],k=T[y[R]];if(!k.extras)continue;let B=null;L.id in E&&(B=FI(g[E[L.id]].meshes,L.matrix)),B||(B=kI(k)),B&&(L.footprint=OI(B))}if(A.size>0){let R=Array.from(A.values()).sort((L,k)=>L-k);for(let L=R.length-1;L>=0;L--)g.splice(R[L],1)}}(f,u,r.json.nodes),f}function BI(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);let e=r.vertexArray.float32,i=r.aabb.min[0]-1,s=r.aabb.min[1]-1,a=oh/(r.aabb.max[0]-i+2),h=oh/(r.aabb.max[1]-s+2);for(let u=0;u<e.length;u+=3){let f=e[u+2],g=(e[u+0]-i)*a|0,y=(e[u+1]-s)*h|0;f>r.heightmap[y*oh+g]&&(r.heightmap[y*oh+g]=f)}}function l1(r,e,i,s,a){i.reserve(i.length+4*r.length),s.reserve(s.length+10*r.length),a.reserve(a.length+10*r.length);let h=s.length;for(let u of r){let f=Math.min(10,Math.max(4,1.3*u.height))*e,g=[-u.normal[1],u.normal[0],0],y=Math.min(.29,.1*u.width/u.depth),T=u.width-2*u.depth*e*(y+.01),E=tn([],u.pos,g,T/2),A=tn([],u.pos,g,-T/2),R=[E[0],E[1],E[2]+u.height],L=[A[0],A[1],A[2]+u.height],k=tn([],u.normal,g,y);Xi(k,k,f);let B=tn([],u.normal,g,-y);Xi(B,B,f),vi(k,E,k),vi(B,A,B),E[2]+=.1,A[2]+=.1,s.emplaceBack(k[0],k[1],k[2]),s.emplaceBack(B[0],B[1],B[2]),s.emplaceBack(E[0],E[1],E[2]),s.emplaceBack(A[0],A[1],A[2]),s.emplaceBack(R[0],R[1],R[2]),s.emplaceBack(L[0],L[1],L[2]),s.emplaceBack(E[0],E[1],E[2]),s.emplaceBack(A[0],A[1],A[2]),s.emplaceBack(k[0],k[1],k[2]),s.emplaceBack(B[0],B[1],B[2]);let G=T/f/2;a.emplaceBack(-G-y,-1,G,.8),a.emplaceBack(G+y,-1,G,.8),a.emplaceBack(-G,0,G,1.3),a.emplaceBack(G,0,G,1.3),a.emplaceBack(G+y,-.8,G,.7),a.emplaceBack(G+y,-.8,G,.7),a.emplaceBack(0,0,G,1.3),a.emplaceBack(0,0,G,1.3),a.emplaceBack(G+y,-1.2,G,.8),a.emplaceBack(G+y,-1.2,G,.8),i.emplaceBack(6+h,4+h,8+h),i.emplaceBack(7+h,9+h,5+h),i.emplaceBack(0+h,1+h,2+h),i.emplaceBack(1+h,3+h,2+h),h+=10}}function NI(r,e){let i={};i.indexArray=new ur,i.vertexArray=new yo,i.colorArray=new aa,l1(r,e,i.indexArray,i.vertexArray,i.colorArray);let s={defined:!0};s.emissiveFactor=ki.black;let a={};return a.baseColorFactor=ki.white,s.pbrMetallicRoughness=a,i.material=s,i.aabb=new li([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}let c1=gi([{name:"a_pos_3f",components:3,type:"Float32"}]),VI=gi([{name:"a_normal_3",components:3,type:"Int16"}]),h1=gi([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),UI=gi([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),u1=Pe.types,Ey=32767;function jI(r,e){let i=ht+e;for(let s of r)for(let a of s)if(a.x<-e||a.x>i||a.y<-e||a.y>i)return!1;return!0}class d1{constructor(e){this.layoutAOArray=[],this.indexArrayForConflationUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.layoutVertexArray=new yo,this.layoutNormalArray=new Il,this.layoutColorArray=new cs,this.indexArray=new ur,this.indexArrayForConflation=new ur,this.entranceBloom={layoutVertexArray:new yo,layoutVertexBuffer:null,layoutAttenuationArray:new aa,layoutAttenuationBuffer:null,layoutColorArray:new cs,layoutColorBuffer:null,indexArray:new ur,indexArrayForConflation:new ur,indexBuffer:null,segmentsBucket:new gr},this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segmentsBucket=new gr,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.groundEffect=new hy(e)}get segments(){return this.segmentsBucket}get bloomGeometry(){return this.entranceBloom}updateFootprints(e,i){for(let s of this.footprints)i.push({footprint:s,id:e})}prepare(){return function(){if(Km!=null||Hv!=null)return null;if(Lu!=null)return Lu;let e=fetch(mn.BUILDING_GEN_URL);return Lu=function(i){let s,a,h,u;function f(){s=new Uint8Array(u.buffer),a=new Int32Array(u.buffer),h=new Float32Array(u.buffer)}function g(){throw new Error("Unexpected BuildingGen error.")}let y=()=>{},T={a:{a:g,f:function(E){let A=s.length,R=Math.max(E>>>0,Math.ceil(1.2*A)),L=Math.ceil((R-A)/65536);try{return u.grow(L),f(),!0}catch{return!1}},g,b:y,c:y,d:y,e:y}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,T):i.then(E=>E.arrayBuffer()).then(E=>WebAssembly.instantiate(E,T))).then(E=>{let A=E.instance.exports;return(0,A.g)(),u=A.f,f(),new xI({setStyle:A.h,setAOOptions:A.i,setMetricOptions:A.j,setStructuralOptions:A.k,setFacadeOptions:A.l,setFauxFacadeOptions:A.m,setFacadeClassifierOptions:A.n,addFeature:A.o,addFacade:A.p,generateMesh:A.q,getLastError:A.r,getMeshCount:A.s,getPositionsPtr:A.t,getPositionsLength:A.u,getNormalsPtr:A.v,getNormalsLength:A.w,getColorsPtr:A.x,getColorsLength:A.y,getAOPtr:A.z,getAOLength:A.A,getUVPtr:A.B,getUVLength:A.C,getFauxFacadePtr:A.D,getFauxFacadeLength:A.E,getIndicesPtr:A.F,getIndicesLength:A.G,getBuildingPart:A.H,getRingCount:A.I,getRingPtr:A.J,getRingLength:A.K,free:A.L,malloc:A.M,heapU8:s,heap32:a,heapF32:h})})}(e).then(i=>(Lu=null,Km=i,Km)).catch(i=>{pi("Could not load building-gen"),Lu=null,Hv=i}),Lu}()}populate(e,i,s,a){let h=vI();if(!h)return;let u=se(s);this.tileToMeter=u,this.brightness=i.brightness,h.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,u],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:u,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),h.setAOOptions(!1,.3),h.setMetricOptions(!1,16),h.setStructuralOptions(!0),h.setFacadeOptions(4,!0),h.setFauxFacadeOptions(!1,!1,1),h.setFacadeClassifierOptions(3);let f=new Map;for(let{feature:g}of e){if(u1[g.type]!=="LineString")continue;let y=this.layers[0]._featureFilter.needGeometry,T=ke(g,y);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),T,s))continue;let E=y?T.geometry:me(g,s,a),A=[];for(let B of E)for(let G of B)A.push({x:G.x,y:G.y});let R={coordinates:A,crossPerc:g.properties.cross_perc,distanceToRoad:g.properties.distance_to_road,entrances:g.properties.entrances,sourceId:0},L=g.properties.source_id,k=f.get(L);k||(k=[],f.set(L,k)),k.push(R)}this.maxHeight=0;for(let{feature:g,index:y}of e){if(u1[g.type]==="LineString")continue;let T=this.layers[0]._featureFilter.needGeometry,E=ke(g,T);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),E,s))continue;let A=T?E.geometry:me(g,s,a),R=Pp(A,500);if(!jI(A,163))continue;let L=this.layers[0],k=L.layout.get("building-base").evaluate(g,{},s),B=L.layout.get("building-height").evaluate(g,{},s),G=L.layout.get("building-roof-shape").evaluate(g,{},s),X=L.paint.get("building-ambient-occlusion-intensity"),W=L.paint.get("building-ambient-occlusion-ground-radius")/this.tileToMeter;if(G==="flat")continue;let K=g.properties.source_id,pe;pe=f.has(K)?f.get(K):[];let ce=[],ue=new Qe(1/0,1/0),ge=new Qe(-1/0,-1/0);for(let Xe of R)if(Xe.length>0){let tt=[];for(let It of Xe){let xt=[];for(let ut=It.length-1;ut>=0;ut--){let vt=It[ut];xt.push({x:vt.x,y:vt.y}),ue.x=Math.min(ue.x,vt.x),ue.y=Math.min(ue.y,vt.y),ge.x=Math.max(ge.x,vt.x),ge.y=Math.max(ge.y,vt.y)}tt.push(xt)}ce.push({id:g.id,height:B,minHeight:k,sourceId:0,roofType:G,coordinates:tt})}let ve=h.generateMesh(ce,pe);if(typeof ve=="string"||ve.meshes.length===0||ve.modifiedPolygonRings.length===0)continue;let Ne=0;for(let Xe of ve.meshes)Ne+=Xe.positions.length/3;let Ee=this.segmentsBucket.prepareSegment(Ne,this.layoutVertexArray,this.indexArray),Ue=[],nt=null,qe=0,Ke=-1,it=this.indexArray.length,Fe=0;for(let Xe of ve.meshes){let tt=this.layoutVertexArray.length;if(Xe.buildingPart==="entrance"){let xt=new Array;for(let Zt=0;Zt<Xe.indices.length;Zt+=12){let Qt=Xe.positions[Zt+0],Kt=Xe.positions[Zt+1],fi=Xe.positions[Zt+3],oi=Xe.positions[Zt+4],ir=Xe.positions[Zt+2],ee=Xe.positions[Zt+8]-ir,te=1,Oe=fi-Qt,lt=oi-Kt,pt=Math.hypot(Oe,lt);xt.push({pos:[Qt+.5*Oe,Kt+.5*lt,ir],normal:[lt/pt,-Oe/pt,0],width:pt,height:ee,depth:te,points:[Qt,Kt,fi,oi]})}let ut=this.entranceBloom.segmentsBucket.prepareSegment(10*xt.length,this.entranceBloom.layoutVertexArray,this.entranceBloom.indexArray),vt=this.entranceBloom.layoutVertexArray.length;qe=this.entranceBloom.indexArray.length,l1(xt,.5/this.tileToMeter,this.entranceBloom.indexArray,this.entranceBloom.layoutVertexArray,this.entranceBloom.layoutAttenuationArray);let Vt=this.entranceBloom.layoutVertexArray.length-vt;Ke=this.entranceBloom.indexArray.length-qe;for(let Zt=0;Zt<Vt;Zt++)this.entranceBloom.layoutColorArray.emplaceBack(65535,65535);ut.vertexLength+=Vt,ut.primitiveLength+=Ke,nt={part:Xe.buildingPart,vertexOffset:vt,vertexLength:Vt}}for(let xt=0;xt<Xe.positions.length;xt+=3)Fe=Math.max(Fe,Xe.positions[xt+2]),this.layoutVertexArray.emplaceBack(Xe.positions[xt],Xe.positions[xt+1],Xe.positions[xt+2]);for(let xt=0;xt<Xe.normals.length;xt+=3)this.layoutNormalArray.emplaceBack(Xe.normals[xt+0]*Ey,Xe.normals[xt+1]*Ey,Xe.normals[xt+2]*Ey);for(let xt=0;xt<Xe.ao.length;xt++)this.layoutAOArray.push(Xe.ao[xt]);for(let xt=0;xt<Xe.colors.length;xt+=3){let ut=1+(Xe.ao[xt/3]-1)*X;this.layoutColorArray.emplaceBack(Xe.colors[xt]*ut<<8|Xe.colors[xt+1]*ut,Xe.colors[xt+2]*ut<<8)}let It=Ee.vertexLength;for(let xt=0;xt<Xe.indices.length;xt+=3)this.indexArray.emplaceBack(It+Xe.indices[xt],It+Xe.indices[xt+1],It+Xe.indices[xt+2]);Ee.vertexLength+=Xe.positions.length/3,Ee.primitiveLength+=Xe.indices.length/3,(Xe.buildingPart==="roof"||Xe.buildingPart==="wall"||Xe.buildingPart==="facade_glazing"||Xe.buildingPart==="entrance")&&Ue.push({part:Xe.buildingPart,vertexOffset:tt,vertexLength:Xe.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Fe),this.buildingFeatures.push({feature:E,segment:Ee,parts:Ue,buildingBloom:nt});let Je=this.indexArray.length-it,Ie=[],Be=[],at=new Qe(1/0,1/0),et=new Qe(-1/0,-1/0),Lt=this.groundEffect.vertexArray.length;for(let Xe of ve.modifiedPolygonRings){let tt=[],It=new Qe(1/0,1/0),xt=new Qe(-1/0,-1/0);for(let ut=0;ut<Xe.length;ut+=2){let vt=Xe.length-ut-2;It.x=Math.min(It.x,Xe[vt]),It.y=Math.min(It.y,Xe[vt+1]),xt.x=Math.max(xt.x,Xe[vt]),xt.y=Math.max(xt.y,Xe[vt+1]);let Vt=new Qe(Xe[vt],Xe[vt+1]);tt.push(Vt),Ie.push(Vt.x,Vt.y),Be.push(Vt.clone())}at.x=Math.min(at.x,It.x),at.y=Math.min(at.y,It.y),et.x=Math.max(et.x,xt.x),et.y=Math.max(et.y,xt.y),this.groundEffect.addData(tt,[It,xt],W)}let St=this.groundEffect.vertexArray.length-Lt;(ue.x<0||ge.x>ht||ue.y<0||ge.y>ht)&&this.featuresOnBorder.push({featureId:g.id,footprintIndex:this.footprints.length});{let Xe=Au(Ie,null,2),tt=new qm(Be,Xe,8,256),It=g.id;g.properties&&g.properties.hasOwnProperty("building_id")&&(It=g.properties.building_id),this.footprints.push({vertices:Be,indices:Xe,grid:tt,min:at,max:et,buildingId:It,hiddenFlags:0,indicesOffset:it,indicesLength:Je,bloomIndicesOffset:qe,bloomIndicesLength:Ke,groundEffectVertexOffset:Lt,groundEffectVertexLength:St,segment:Ee,height:Fe})}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,g,y,{},i.availableImages,s,i.brightness),this.groundEffect.addPaintPropertiesData(g,y,{},i.availableImages,s,i.brightness)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0])}update(e,i,s,a,h,u,f){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f),this.groundEffect.update(e,i,h,s,a,u,f)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,c1.members),this.layoutNormalBuffer=e.createVertexBuffer(this.layoutNormalArray,VI.members),this.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(this.entranceBloom.layoutVertexArray,c1.members),this.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(this.entranceBloom.layoutAttenuationArray,UI.members),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.layoutNormalBuffer.destroy(),this.layoutColorBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segmentsBucket.destroy(),this.entranceBloom.layoutVertexBuffer.destroy(),this.entranceBloom.layoutColorBuffer.destroy(),this.entranceBloom.layoutAttenuationBuffer.destroy(),this.entranceBloom.indexBuffer.destroy(),this.entranceBloom.segmentsBucket.destroy())}updateFootprintHiddenFlags(e,i,s=!0){let a=!1,h=s?i:0,u=0|(s?-1:~i);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let f of e){let g=this.footprints[f],y=g.hiddenFlags&u|h;g.hiddenFlags!==y&&(g.hiddenFlags=y,a=!0,this.groundEffect.updateHiddenByLandmarkRange(g.groundEffectVertexOffset,g.groundEffectVertexLength,g.hiddenFlags!==0))}return a&&(this.indexArrayForConflationUploaded=!1),a}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),!this.indexArrayForConflationUploaded&&this.indexArray.length!==0){this.indexArrayForConflation.resize(this.indexArray.length),this.indexArrayForConflation.uint16.set(this.indexArray.uint16),this.entranceBloom.indexArrayForConflation.resize(this.entranceBloom.indexArray.length),this.entranceBloom.indexArrayForConflation.uint16.set(this.entranceBloom.indexArray.uint16);for(let i of this.footprints){let s=i.indicesOffset+i.indicesLength;if(i.hiddenFlags!==0){for(let h=i.indicesOffset;h<s;h++)this.indexArrayForConflation.uint16[3*h+0]=0,this.indexArrayForConflation.uint16[3*h+1]=0,this.indexArrayForConflation.uint16[3*h+2]=0;let a=i.bloomIndicesOffset+i.bloomIndicesLength;for(let h=i.bloomIndicesOffset;h<a;h++)this.entranceBloom.indexArrayForConflation.uint16[3*h+0]=0,this.entranceBloom.indexArrayForConflation.uint16[3*h+1]=0,this.entranceBloom.indexArrayForConflation.uint16[3*h+2]=0}}this.indexBuffer?this.indexBuffer.updateData(this.indexArrayForConflation):this.indexBuffer=e.createIndexBuffer(this.indexArrayForConflation,!0),this.entranceBloom.indexBuffer?this.entranceBloom.indexBuffer.updateData(this.entranceBloom.indexArrayForConflation):this.entranceBloom.indexBuffer=e.createIndexBuffer(this.entranceBloom.indexArrayForConflation,!0),this.indexArrayForConflationUploaded=!0}}uploadUpdatedColorBuffer(e){this.layoutColorBuffer?this.layoutColorBuffer.updateData(this.layoutColorArray):this.layoutColorBuffer=e.createVertexBuffer(this.layoutColorArray,h1.members,!0),this.entranceBloom.layoutColorBuffer?this.entranceBloom.layoutColorBuffer.updateData(this.entranceBloom.layoutColorArray):this.entranceBloom.layoutColorBuffer=e.createVertexBuffer(this.entranceBloom.layoutColorArray,h1.members,!0)}evaluate(e){let i=e.paint.get("building-ambient-occlusion-intensity");for(let s of this.buildingFeatures){let a=s.feature;a.properties["building-part"]="roof";let h=e.paint.get("building-color").evaluate(a,{},this.canonical),u=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="wall";let f=e.paint.get("building-color").evaluate(a,{},this.canonical),g=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="window";let y=e.paint.get("building-color").evaluate(a,{},this.canonical),T=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="door";let E=e.paint.get("building-color").evaluate(a,{},this.canonical),A=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);for(let L of s.parts){let k,B=h;L.part==="roof"?(B=h,k=u):L.part==="wall"?(B=f,k=g):L.part==="facade_glazing"?(B=y,k=T):L.part==="entrance"&&(B=E,k=A),k=re(k,0,1);for(let G=0;G<L.vertexLength;G++){let X=L.vertexOffset+G,W=1+(this.layoutAOArray[X]-1)*i;this.layoutColorArray.emplace(X,B.r*W*255<<8|B.g*W*255,B.b*W*255<<8|255*k)}}let R=s.buildingBloom;if(R)for(let L=0;L<R.vertexLength;L++)this.bloomGeometry.layoutColorArray.emplace(R.vertexOffset+L,255*E.r<<8|255*E.g,255*E.b<<8|51*A)}}needsEvaluation(e,i){let s=e.transform.projectionOptions,a=e.style.getBrightness();return!(this.uploaded&&s.name===this.projection.name&&this.brightness===a||(this.projection=s,this.brightness=a,0))}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;let a=i.getReplacementRegionsForTile(e.toUnwrapped());if($m(this.activeReplacements,a))return;this.activeReplacements=a;for(let u of this.footprints)u.hiddenFlags&=-2;let h=[];for(let u of this.activeReplacements){if(u.order<=gv)continue;let f=Math.max(1,Math.pow(2,u.footprintTileId.canonical.z-e.canonical.z));for(let g of this.footprints)g.min.x>u.max.x||g.max.x<u.min.x||g.min.y>u.max.y||g.max.y<u.min.y||(h.length=0,GI(g.vertices,0,g.vertices.length,u.footprintTileId.canonical,e.canonical,h),sy(u.footprint,h,g.indices,0,g.indices.length,0,-f)&&(g.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let u of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(u.groundEffectVertexOffset,u.groundEffectVertexLength,u.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0,h=4*(e+ht)*ht+(i+ht);if(this.footprintLookup.hasOwnProperty(h)){let f=this.footprintLookup[h];return f?{height:f.height,hidden:f.hiddenFlags!==0}:void 0}let u=new Qe(e,i);for(let f of this.footprints)e>f.max.x||f.min.x>e||i>f.max.y||f.min.y>i||f.height<=s||ay(u,f)&&(s=f.height,this.footprintLookup[h]=f,a=f.hiddenFlags!==0);if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.footprintLookup[h]=void 0}}function GI(r,e,i,s,a,h){let u=Math.pow(2,s.z-a.z);for(let f=0;f<i;f++){let g=r[f+e].x,y=r[f+e].y;g=(g+a.x*ht)*u-s.x*ht,y=(y+a.y*ht)*u-s.y*ht,h.push(new Qe(g,y))}}let p1,f1;Tt(d1,"BuildingBucket",{omit:["layers"]});let qI=gi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),HI=gi([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:$I}=qI,ZI=gi([{name:"a_packed",components:3,type:"Float32"}]),{members:WI}=ZI,XI=gi([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:YI}=XI;class m1{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new Nl({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){let s=this.getKey(e,i);return this.positions[s]}trim(){let e=this.width,i=this.height=kt(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,s){let a=[],h=e.length%2==1?-e[e.length-1]*s:0,u=e[0]*s,f=!0;a.push({left:h,right:u,isDash:f,zeroLength:e[0]===0});let g=e[0];for(let y=1;y<e.length;y++){f=!f;let T=e[y];h=g*s,g+=T,u=g*s,a.push({left:h,right:u,isDash:f,zeroLength:T===0})}return a}addRoundDash(e,i,s){let a=i/2;for(let h=-s;h<=s;h++){let u=this.width*(this.nextRow+s+h),f=0,g=e[f];for(let y=0;y<this.width;y++){y/g.right>1&&(g=e[++f]);let T=Math.abs(y-g.left),E=Math.abs(y-g.right),A=Math.min(T,E),R,L=h/s*(a+1);if(g.isDash){let k=a-Math.abs(L);R=Math.sqrt(A*A+k*k)}else R=a-Math.sqrt(A*A+L*L);this.image.data[u+y]=Math.max(0,Math.min(255,R+128))}}}addRegularDash(e,i){for(let g=e.length-1;g>=0;--g){let y=e[g],T=e[g+1];y.zeroLength?e.splice(g,1):T&&T.isDash===y.isDash&&(T.left=y.left,e.splice(g,1))}let s=e[0],a=e[e.length-1];s.isDash===a.isDash&&(s.left=a.left-this.width,a.right=s.right+this.width);let h=this.width*this.nextRow,u=0,f=e[u];for(let g=0;g<this.width;g++){g/f.right>1&&(f=e[++u]);let y=Math.abs(g-f.left),T=Math.abs(g-f.right),E=Math.min(y,T);this.image.data[h+g]=Math.max(0,Math.min(255,(f.isDash?E:-E)+i+128))}}addDash(e,i){let s=this.getKey(e,i);if(this.positions[s])return this.positions[s];let a=i==="round",h=a?7:0,u=2*h+1;if(this.nextRow+u>this.height)return pi("LineAtlas out of space"),null;e.length===0&&e.push(1);let f=0;for(let T=0;T<e.length;T++)e[T]<0&&(pi("Negative value is found in line dasharray, replacing values with 0"),e[T]=0),f+=e[T];if(f!==0){let T=this.width/f,E=this.getDashRanges(e,this.width,T);a?this.addRoundDash(E,T,h):this.addRegularDash(E,i==="square"?.5*T:0)}let g=this.nextRow+h;this.nextRow+=u;let y={tl:[g,h],br:[f,0]};return this.positions[s]=y,y}}Tt(m1,"LineAtlas");let KI=Pe.types,JI=Math.cos(Math.PI/180*37.5),QI=Math.cos(Math.PI/180*5);class Iy{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new gu,this.layoutVertexArray2=new yo,this.patternVertexArray=new yo,this.indexArray=new ur,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new gr,this.maxLineLength=0,this.zOffsetVertexArray=new yo,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:ht/64,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.hasPattern=ey("line",this.layers,this.pixelRatio,i);let h=this.layers[0].layout.get("line-sort-key");this.tileToMeter=se(s);let u=this.layers[0].layout.get("line-elevation-reference");if(u==="hd-road-markup")this.elevationType="road";else{let A=this.layers[0].layout.get("line-z-offset"),R=A.isConstant()&&!A.constantOr(0);this.elevationType=u!=="sea"&&u!=="ground"&&R?"none":"offset",this.elevationType==="offset"&&u==="none"&&pi(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}let f=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&f!==void 0;let g=[];for(let{feature:A,id:R,index:L,sourceLayerIndex:k}of e){let B=this.layers[0]._featureFilter.needGeometry,G=ke(A,B);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),G,s))continue;let X=h?h.evaluate(G,{},s):void 0,W={id:R,properties:A.properties,type:A.type,sourceLayerIndex:k,index:L,geometry:B?G.geometry:me(A,s,a),patterns:{},sortKey:X};g.push(W)}h&&g.sort((A,R)=>A.sortKey-R.sortKey);let{lineAtlas:y,featureIndex:T}=i,E=this.addConstantDashes(y);for(let A of g){let{geometry:R,index:L,sourceLayerIndex:k}=A;if(E&&this.addFeatureDashes(A,y),this.hasPattern){let B=ty("line",this.layers,A,this.zoom,this.pixelRatio,i);this.patternFeatures.push(B)}else this.addFeature(A,R,L,s,y.positions,i.availableImages,i.brightness,i.elevationFeatures);T.insert(e[L].feature,R,L,k,this.index)}}addConstantDashes(e){let i=!1;for(let s of this.layers){let a=s.paint.get("line-dasharray").value,h=s.layout.get("line-cap").value;if(a.kind!=="constant"||h.kind!=="constant")i=!0;else{let u=h.value,f=a.value;if(!f)continue;e.addDash(f,u)}}return i}addFeatureDashes(e,i){let s=this.zoom;for(let a of this.layers){let h=a.paint.get("line-dasharray").value,u=a.layout.get("line-cap").value;if(h.kind==="constant"&&u.kind==="constant")continue;let f,g;if(h.kind==="constant"){if(f=h.value,!f)continue}else f=h.evaluate({zoom:s},e);g=u.kind==="constant"?u.value:u.evaluate({zoom:s},e),i.addDash(f,g),e.patterns[a.id]=[i.getKey(f,g)]}}update(e,i,s,a,h,u,f,g){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,g)}addFeatures(e,i,s,a,h,u){for(let f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,s,a,u)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,WI)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,YI)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,HI.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,$I),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,s,a,h,u,f,g){let y=this.layers[0].layout,T=y.get("line-join").evaluate(e,{}),E=y.get("line-cap").evaluate(e,{}),A=y.get("line-miter-limit"),R=y.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=y.get("line-z-offset").value;let L=this.layers[0].paint.get("line-width").value;if(L.kind!=="constant"&&L.isLineProgressConstant===!1&&(this.variableWidthValue=L),this.elevationType==="road"){let k=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,a,g,T,E,A,R)){let[B,G]=this.clipRuntimeLinesToTile(i,1);for(let X=0;X<B.length;X++){let W=B[X],K=G[X],pe={progress:{min:K.progress.min,max:K.progress.max},nextDir:this.computeSegNextDir(K,W),prevDir:this.computeSegPrevDir(K,W)};this.addLine(W,e,a,T,E,A,R,pe)}this.fillNonElevatedRoadSegment(k)}}else for(let k of i)this.addLine(k,e,a,T,E,A,R);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,h,u,a,f,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return Xm(e,-i,-i,ht+i,ht+i)}clipRuntimeLinesToTile(e,i){let s=[];return[Xm(e,-i,-i,ht+i,ht+i,s),s]}addElevatedRoadFeature(e,i,s,a,h,u,f,g){let y=[],T=yr.getElevationFeature(e,a);if(T){let E=this.clipLinesToTile(i,1),A=this.prepareElevatedLines(E,T,s);for(let R of A)y.push({geometry:R,elevation:T,elevationTileID:s,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(y.length===0)return!1;for(let E of y){let A=this.layoutVertexArray.length;this.addLine(E.geometry,e,s,h,u,f,g);let R=new bi(s,E.elevationTileID);if(E.elevation)for(let L=A;L<this.layoutVertexArray.length;L++){let k=new Qe(this.layoutVertexArray.int16[6*L]>>1,this.layoutVertexArray.int16[6*L+1]>>1),B=R.pointElevation(k,E.elevation,.05);this.updateHeightRange(B),this.zOffsetVertexArray.emplaceBack(B,0,0)}else this.fillNonElevatedRoadSegment(A)}return!0}prepareElevatedLines(e,i,s){if(i.constantHeight!=null)return e;let a=[],h=1/se(s);for(let u of e)_I(u,new Vi(i,h),0,a);return a}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,s,a,h,u,f,g){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;let y=a==="none";this.patternJoinNone=this.hasPattern&&y,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];let T=g&&g.progress.min>0,E=g&&g.progress.max<1;if(this.lineClips){let ge={min:this.lineClips.start,max:this.lineClips.end},ve=1;if(g){let Ue=this.lineClips.end-this.lineClips.start;ge=function(nt,qe,Ke){return{min:dc(nt.min,qe,Ke),max:dc(nt.max,qe,Ke)}}(g.progress,{min:0,max:1},ge),Ue>0&&(ve=(ge.max-ge.min)/Ue)}let Ne=+i.properties.mapbox_clip_feature_len,Ee=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(Ne)||Number.isNaN(Ee)){for(let nt=0;nt<e.length-1;nt++)this.totalDistance+=e[nt].dist(e[nt+1]);let Ue=this.totalDistance/(ge.max-ge.min);this.totalFeatureLength=Number.isFinite(Ue)?Ue:0,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Ne,this.distance=Ee*ve,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}let A=KI[i.type]==="Polygon",R=e.length;for(;R>=2&&e[R-1].equals(e[R-2]);)R--;let L=0;for(;L<R-1&&e[L].equals(e[L+1]);)L++;if(R<(A?3:2))return;a==="bevel"&&(u=1.05);let k=this.segments.prepareSegment(10*R,this.layoutVertexArray,this.indexArray),B,G,X,W,K,pe,ce,ue;g&&g.prevDir&&(pe=g.prevDir.perp()),g&&g.nextDir&&(ce=g.nextDir.perp()),this.e1=this.e2=-1,A&&(B=e[R-2],K=e[L].sub(B)._unit()._perp());for(let ge=L;ge<R;ge++){if(X=ge===R-1?A?e[L+1]:void 0:e[ge+1],X&&e[ge].equals(X))continue;K&&(W=K),B&&(G=B),B=e[ge],ue=this.evaluateLineProgressFeatures(G?G.dist(B):0),K=X?X.sub(B)._unit()._perp():W,W=W||K;let ve=G&&X,Ne=ve?a:A||y?"butt":h,Ee=W.x*K.x+W.y*K.y;if(y){let Ie=function(Be){if(Be.patternJoinNone){let at=Be.segmentPoints.length/2,et=Be.lineSoFar-Be.segmentStart;for(let Lt=0;Lt<at;++Lt){let St=Be.segmentPoints[2*Lt+1],Xe=Math.round(Be.segmentPoints[2*Lt])+.5+.25*St;Be.patternVertexArray.emplaceBack(Xe,et,Be.segmentStart),Be.patternVertexArray.emplaceBack(Xe,et,Be.segmentStart)}Be.segmentPoints.length=0}Be.e1=Be.e2=-1};if(ve&&Ee<QI){this.updateDistance(G,B),this.addCurrentVertex(B,W,1,1,k,ue),Ie(this),this.addCurrentVertex(B,K,-1,-1,k,ue);continue}if(G){if(!X){this.updateDistance(G,B),this.addCurrentVertex(B,W,1,1,k,ue),Ie(this);continue}Ne="miter"}}let Ue=W.add(K);Ue.x===0&&Ue.y===0||Ue._unit();let nt=Ue.x*K.x+Ue.y*K.y,qe=nt!==0?1/nt:1/0,Ke=2*Math.sqrt(2-2*nt),it=nt<JI&&G&&X,Fe=W.x*K.y-W.y*K.x>0,Je=this.overscaling<=16?15*ht/(512*this.overscaling):0;if(ve&&Ne==="round"){if(qe<f)Ne="miter";else if(qe<=2){let Ie=Ay(B,-10,ht+10);Ne=this.elevationType==="offset"&&(Ie||this.hasCrossSlope)?"miter":"fakeround"}}if(Ne==="miter"&&qe>u&&(Ne="bevel"),Ne==="bevel"&&(qe>2&&(Ne="flipbevel"),qe<u&&(Ne="miter")),G&&!(Ne==="miter"&&it)&&this.updateDistance(G,B),Ne==="miter")if(it){let Ie=B.dist(G);if(Ie>2*Je){let at=B.sub(B.sub(G)._mult(Je/Ie)._round());this.updateDistance(G,at),this.addCurrentVertex(at,W,0,0,k,ue),G=at}this.updateDistance(G,B),Ue._mult(qe),this.addCurrentVertex(B,Ue,0,0,k,ue);let Be=B.dist(X);if(Be>2*Je){let at=B.add(X.sub(B)._mult(Je/Be)._round());this.updateDistance(B,at),this.addCurrentVertex(at,K,0,0,k,ue),B=at}}else Ue._mult(qe),this.addCurrentVertex(B,Ue,0,0,k,ue);else if(Ne==="flipbevel"){if(qe>100)Ue=K.mult(-1);else{let Ie=qe*W.add(K).mag()/W.sub(K).mag();Ue._perp()._mult(Ie*(Fe?-1:1))}this.addCurrentVertex(B,Ue,0,0,k,ue),this.addCurrentVertex(B,Ue.mult(-1),0,0,k,ue)}else if(Ne==="bevel"||Ne==="fakeround"){ue!=null&&G&&this.addCurrentVertex(B,ce||W,-1,-1,k,ue);let Ie=B.dist(G)<=2*Je&&Ne!=="bevel",Be=Ue.mult(Fe?1:-1);Be._mult(qe);let at=K.mult(Fe?-1:1),et=W.mult(Fe?-1:1),Lt=this.evaluateLineProgressFeatures(this.distance);if(ue==null&&(this.addHalfVertex(B,Be.x,Be.y,!1,!Fe,0,k,Lt),Ie||this.addHalfVertex(B,Be.x+2*et.x,Be.y+2*et.y,!1,Fe,0,k,Lt)),Ne==="fakeround"){let St=Math.round(180*Ke/Math.PI/20);this.addHalfVertex(B,et.x,et.y,!1,Fe,0,k,Lt);for(let Xe=0;Xe<St;Xe++){let tt=Xe/St;if(tt!==.5){let xt=tt-.5;tt+=tt*xt*(tt-1)*((1.0904+Ee*(Ee*(3.55645-1.43519*Ee)-3.2452))*xt*xt+(.848013+Ee*(.215638*Ee-1.06021)))}let It=at.sub(et)._mult(tt)._add(et)._unit();this.addHalfVertex(B,It.x,It.y,!1,Fe,0,k,Lt)}this.addHalfVertex(B,at.x,at.y,!1,Fe,0,k,Lt)}Ie||ue!=null||this.addHalfVertex(B,Be.x+2*at.x,Be.y+2*at.y,!1,Fe,0,k,Lt),ue!=null&&X&&this.addCurrentVertex(B,pe||K,1,1,k,ue)}else if(Ne==="butt")this.addCurrentVertex(B,Ue,0,0,k,ue);else if(Ne==="square"){if(!G){let Ie=T?0:-1;this.addCurrentVertex(B,Ue,Ie,Ie,k,ue)}if(this.addCurrentVertex(B,Ue,0,0,k,ue),G){let Ie=E?0:1;this.addCurrentVertex(B,Ue,Ie,Ie,k,ue)}}else if(Ne==="round"){if(G){let Ie=!ve&&ce?ce:W;this.addCurrentVertex(B,Ie,0,0,k,ue),!ve&&E||this.addCurrentVertex(B,Ie,1,1,k,ue,!0)}if(X){let Ie=!ve&&pe?pe:K;!ve&&T||this.addCurrentVertex(B,Ie,-1,-1,k,ue,!0),this.addCurrentVertex(B,Ie,0,0,k,ue)}}}}addVerticesTo(e,i,s,a,h,u,f,g,y,T){let E=(i.w-e.w)/this.tessellationStep|0,A=0,R=this.scaledDistance;if(E>1){this.lineSoFar=e.w;let k=(i.x-e.x)/E,B=(i.y-e.y)/E,G=(i.z-e.z)/E,X=(i.w-e.w)/E;for(let W=1;W<E;++W){e.x+=k,e.y+=B,e.z+=G,this.lineSoFar+=X,A+=X;let K=this.evaluateLineProgressFeatures(this.prevDistance+A);this.scaledDistance=(this.prevDistance+A)/this.totalDistance,this.addHalfVertex(e,s,a,T,!1,f,y,K),this.addHalfVertex(e,h,u,T,!0,-g,y,K)}}this.lineSoFar=i.w,this.scaledDistance=R;let L=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,s,a,T,!1,f,y,L),this.addHalfVertex(i,h,u,T,!0,-g,y,L)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):pi(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,s,a,h,u,f=!1){let g=i.x+i.y*s,y=i.y-i.x*s,T=i.y*a-i.x,E=-i.y-i.x*a;if(u!=null){let A=this.elevationType==="offset",R=-10,L=ht+10,k=u.zOffset,B=new Bv(e.x,e.y,k,this.lineSoFar),G=!!A&&Ay(e,R,L),X=this.lineSoFar,W=this.distance;if(this.currentVertex)if(G){let K=this.currentVertexIsOutside,pe=this.currentVertex,ce=new Bv(e.x,e.y,k,this.lineSoFar);if(Vv(pe,ce,R,L),!Ay(ce,R,L)){if(K){this.e1=this.e2=-1,this.distance-=pe.dist(B),this.lineSoFar=pe.w;let ue=this.evaluateLineProgressFeatures(pe.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(pe,g,y,f,!1,s,h,ue),this.addHalfVertex(pe,T,E,f,!0,-a,h,ue),this.prevDistance=this.distance}this.distance=this.prevDistance+pe.dist(ce),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(pe,ce,g,y,T,E,s,a,h,f),this.distance=W,this.scaledDistance=this.distance/this.totalDistance}}else{let K=this.currentVertex;if(this.currentVertexIsOutside){Vv(K,B,R,L),this.e1=this.e2=-1,this.distance-=K.dist(B),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=K.w;let pe=this.evaluateLineProgressFeatures(K.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(K,g,y,f,!1,s,h,pe),this.addHalfVertex(K,T,E,f,!0,-a,h,pe),this.prevDistance=this.distance,this.distance=W,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(K,B,g,y,T,E,s,a,h,f)}else G||(this.addHalfVertex(e,g,y,f,!1,s,h,u),this.addHalfVertex(e,T,E,f,!0,-a,h,u));this.currentVertex=B,this.currentVertexIsOutside=G,this.lineSoFar=X}else this.addHalfVertex(e,g,y,f,!1,s,h,u),this.addHalfVertex(e,T,E,f,!0,-a,h,u)}addHalfVertex({x:e,y:i},s,a,h,u,f,g,y){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),u||this.segmentPoints.push(this.lineSoFar-this.segmentStart,f)),this.layoutVertexArray.emplaceBack((e<<1)+(h?1:0),(i<<1)+(u?1:0),Math.round(63*s)+128,Math.round(63*a)+128,1+(f===0?0:f<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){let E=Bt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,E)}let T=g.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,T),g.primitiveLength++),u?this.e2=T:this.e1=T,y!=null&&this.zOffsetVertexArray.emplaceBack(y.zOffset,y.variableWidth,y.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function Ay(r,e,i){return r.x<e||r.x>i||r.y<e||r.y>i}let _1,g1;function y1(r,e,i){return e*(ht/(r.tileSize*Math.pow(2,i-r.tileID.overscaledZ)))}Tt(Iy,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let x1=(r,e,i)=>(1-i)*r+i*e;function v1(r,e){return 1/y1(r,1,e.tileZoom)}function b1(r,e,i,s){return r.translatePosMatrix(s||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}let w1=r=>{let e=[];T1(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");let i=r.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");let s=r.layout.get("line-join").constantOr("miter")==="none",a=!!r.paint.get("line-pattern").constantOr(1);return s&&a&&e.push("LINE_JOIN_NONE"),e};function T1(r){let e=r.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let My,S1=()=>My||(My={layout:_1||(_1=new Ar({"line-cap":new gt(Se.layout_line["line-cap"]),"line-join":new gt(Se.layout_line["line-join"]),"line-miter-limit":new ot(Se.layout_line["line-miter-limit"]),"line-round-limit":new ot(Se.layout_line["line-round-limit"]),"line-sort-key":new gt(Se.layout_line["line-sort-key"]),"line-z-offset":new gt(Se.layout_line["line-z-offset"]),"line-elevation-reference":new ot(Se.layout_line["line-elevation-reference"]),"line-cross-slope":new ot(Se.layout_line["line-cross-slope"]),visibility:new ot(Se.layout_line.visibility),"line-width-unit":new ot(Se.layout_line["line-width-unit"])})),paint:g1||(g1=new Ar({"line-opacity":new gt(Se.paint_line["line-opacity"]),"line-color":new gt(Se.paint_line["line-color"]),"line-translate":new ot(Se.paint_line["line-translate"]),"line-translate-anchor":new ot(Se.paint_line["line-translate-anchor"]),"line-width":new gt(Se.paint_line["line-width"]),"line-gap-width":new gt(Se.paint_line["line-gap-width"]),"line-offset":new gt(Se.paint_line["line-offset"]),"line-blur":new gt(Se.paint_line["line-blur"]),"line-dasharray":new gt(Se.paint_line["line-dasharray"]),"line-pattern":new gt(Se.paint_line["line-pattern"]),"line-pattern-cross-fade":new ot(Se.paint_line["line-pattern-cross-fade"]),"line-gradient":new wl(Se.paint_line["line-gradient"]),"line-trim-offset":new ot(Se.paint_line["line-trim-offset"]),"line-trim-fade-range":new ot(Se.paint_line["line-trim-fade-range"]),"line-trim-color":new ot(Se.paint_line["line-trim-color"]),"line-emissive-strength":new ot(Se.paint_line["line-emissive-strength"]),"line-border-width":new gt(Se.paint_line["line-border-width"]),"line-border-color":new gt(Se.paint_line["line-border-color"]),"line-occlusion-opacity":new ot(Se.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},My);class eA extends gt{possiblyEvaluate(e,i){return i=new ji(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,s,a){return i=Le({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,s,a)}}let jp;function E1(r,e){return e>0?e+2*r:r}let tA=gi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),iA=gi([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),rA=gi([{name:"a_projected_pos",components:4,type:"Float32"}],4);gi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let nA=gi([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),oA=gi([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),sA=gi([{name:"a_texb",components:2,type:"Uint16"}]),aA=gi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),lA=gi([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);gi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let I1=gi([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),cA=gi([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);gi([{name:"triangle",components:3,type:"Uint16"}]),gi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),gi([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),gi([{type:"Float32",name:"offsetX"}]),gi([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var dn=24;function hA(r,e,i){return r.sections.forEach(s=>{s.text=function(a,h,u){let f=h.layout.get("text-transform").evaluate(u,{});return f==="uppercase"?a=a.toLocaleUpperCase():f==="lowercase"&&(a=a.toLocaleLowerCase()),as.applyArabicShaping&&(a=as.applyArabicShaping(a)),a}(s.text,e,i)}),r}let Gp={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42","\u2190":"\u2191","\u2192":"\u2193"};function uA(r){return r==="\uFE36"||r==="\uFE48"||r==="\uFE38"||r==="\uFE44"||r==="\uFE42"||r==="\uFE3E"||r==="\uFE3C"||r==="\uFE3A"||r==="\uFE18"||r==="\uFE40"||r==="\uFE10"||r==="\uFE13"||r==="\uFE14"||r==="\uFF40"||r==="\uFFE3"||r==="\uFE11"||r==="\uFE12"}function dA(r){return r==="\uFE35"||r==="\uFE47"||r==="\uFE37"||r==="\uFE43"||r==="\uFE41"||r==="\uFE3D"||r==="\uFE3B"||r==="\uFE39"||r==="\uFE17"||r==="\uFE3F"}let Cy=4294967296,A1=1/Cy,M1=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),r_=class{constructor(r=new Uint8Array(16)){this.buf=ArrayBuffer.isView(r)?r:new Uint8Array(r),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(r,e,i=this.length){for(;this.pos<i;){let s=this.readVarint(),a=s>>3,h=this.pos;this.type=7&s,r(a,e,this),this.pos===h&&this.skip(s)}return e}readMessage(r,e){return this.readFields(r,e,this.readVarint()+this.pos)}readFixed32(){let r=this.dataView.getUint32(this.pos,!0);return this.pos+=4,r}readSFixed32(){let r=this.dataView.getInt32(this.pos,!0);return this.pos+=4,r}readFixed64(){let r=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*Cy;return this.pos+=8,r}readSFixed64(){let r=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*Cy;return this.pos+=8,r}readFloat(){let r=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,r}readDouble(){let r=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,r}readVarint(r){let e=this.buf,i,s;return s=e[this.pos++],i=127&s,s<128?i:(s=e[this.pos++],i|=(127&s)<<7,s<128?i:(s=e[this.pos++],i|=(127&s)<<14,s<128?i:(s=e[this.pos++],i|=(127&s)<<21,s<128?i:(s=e[this.pos],i|=(15&s)<<28,function(a,h,u){let f=u.buf,g,y;if(y=f[u.pos++],g=(112&y)>>4,y<128||(y=f[u.pos++],g|=(127&y)<<3,y<128)||(y=f[u.pos++],g|=(127&y)<<10,y<128)||(y=f[u.pos++],g|=(127&y)<<17,y<128)||(y=f[u.pos++],g|=(127&y)<<24,y<128)||(y=f[u.pos++],g|=(1&y)<<31,y<128))return Du(a,g,h);throw new Error("Expected varint not more than 10 bytes")}(i,r,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){let r=this.readVarint();return r%2==1?(r+1)/-2:r/2}readBoolean(){return!!this.readVarint()}readString(){let r=this.readVarint()+this.pos,e=this.pos;return this.pos=r,r-e>=12&&M1?M1.decode(this.buf.subarray(e,r)):function(i,s,a){let h="",u=s;for(;u<a;){let f=i[u],g,y,T,E=null,A=f>239?4:f>223?3:f>191?2:1;if(u+A>a)break;A===1?f<128&&(E=f):A===2?(g=i[u+1],(192&g)==128&&(E=(31&f)<<6|63&g,E<=127&&(E=null))):A===3?(g=i[u+1],y=i[u+2],(192&g)==128&&(192&y)==128&&(E=(15&f)<<12|(63&g)<<6|63&y,(E<=2047||E>=55296&&E<=57343)&&(E=null))):A===4&&(g=i[u+1],y=i[u+2],T=i[u+3],(192&g)==128&&(192&y)==128&&(192&T)==128&&(E=(15&f)<<18|(63&g)<<12|(63&y)<<6|63&T,(E<=65535||E>=1114112)&&(E=null))),E===null?(E=65533,A=1):E>65535&&(E-=65536,h+=String.fromCharCode(E>>>10&1023|55296),E=56320|1023&E),h+=String.fromCharCode(E),u+=A}return h}(this.buf,e,r)}readBytes(){let r=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,r);return this.pos=r,e}readPackedVarint(r=[],e){let i=this.readPackedEnd();for(;this.pos<i;)r.push(this.readVarint(e));return r}readPackedSVarint(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSVarint());return r}readPackedBoolean(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readBoolean());return r}readPackedFloat(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFloat());return r}readPackedDouble(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readDouble());return r}readPackedFixed32(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed32());return r}readPackedSFixed32(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed32());return r}readPackedFixed64(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed64());return r}readPackedSFixed64(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed64());return r}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(r){let e=7&r;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(r,e){this.writeVarint(r<<3|e)}realloc(r){let e=this.length||16;for(;e<this.pos+r;)e*=2;if(e!==this.length){let i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeSFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*A1),!0),this.pos+=8}writeSFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*A1),!0),this.pos+=8}writeVarint(r){(r=+r||0)>268435455||r<0?function(e,i){let s,a;if(e>=0?(s=e%4294967296|0,a=e/4294967296|0):(s=~(-e%4294967296),a=~(-e/4294967296),4294967295^s?s=s+1|0:(s=0,a=a+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),function(h,u,f){f.buf[f.pos++]=127&h|128,h>>>=7,f.buf[f.pos++]=127&h|128,h>>>=7,f.buf[f.pos++]=127&h|128,h>>>=7,f.buf[f.pos++]=127&h|128,f.buf[f.pos]=127&(h>>>=7)}(s,0,i),function(h,u){let f=(7&h)<<4;u.buf[u.pos++]|=f|((h>>>=3)?128:0),h&&(u.buf[u.pos++]=127&h|((h>>>=7)?128:0),h&&(u.buf[u.pos++]=127&h|((h>>>=7)?128:0),h&&(u.buf[u.pos++]=127&h|((h>>>=7)?128:0),h&&(u.buf[u.pos++]=127&h|((h>>>=7)?128:0),h&&(u.buf[u.pos++]=127&h)))))}(a,i)}(r,this):(this.realloc(4),this.buf[this.pos++]=127&r|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=r>>>7&127))))}writeSVarint(r){this.writeVarint(r<0?2*-r-1:2*r)}writeBoolean(r){this.writeVarint(+r)}writeString(r){r=String(r),this.realloc(4*r.length),this.pos++;let e=this.pos;this.pos=function(s,a,h){for(let u,f,g=0;g<a.length;g++){if(u=a.charCodeAt(g),u>55295&&u<57344){if(!f){u>56319||g+1===a.length?(s[h++]=239,s[h++]=191,s[h++]=189):f=u;continue}if(u<56320){s[h++]=239,s[h++]=191,s[h++]=189,f=u;continue}u=f-55296<<10|u-56320|65536,f=null}else f&&(s[h++]=239,s[h++]=191,s[h++]=189,f=null);u<128?s[h++]=u:(u<2048?s[h++]=u>>6|192:(u<65536?s[h++]=u>>12|224:(s[h++]=u>>18|240,s[h++]=u>>12&63|128),s[h++]=u>>6&63|128),s[h++]=63&u|128)}return h}(this.buf,r,this.pos);let i=this.pos-e;i>=128&&C1(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i}writeFloat(r){this.realloc(4),this.dataView.setFloat32(this.pos,r,!0),this.pos+=4}writeDouble(r){this.realloc(8),this.dataView.setFloat64(this.pos,r,!0),this.pos+=8}writeBytes(r){let e=r.length;this.writeVarint(e),this.realloc(e);for(let i=0;i<e;i++)this.buf[this.pos++]=r[i]}writeRawMessage(r,e){this.pos++;let i=this.pos;r(e,this);let s=this.pos-i;s>=128&&C1(i,s,this),this.pos=i-1,this.writeVarint(s),this.pos+=s}writeMessage(r,e,i){this.writeTag(r,2),this.writeRawMessage(e,i)}writePackedVarint(r,e){e.length&&this.writeMessage(r,pA,e)}writePackedSVarint(r,e){e.length&&this.writeMessage(r,fA,e)}writePackedBoolean(r,e){e.length&&this.writeMessage(r,gA,e)}writePackedFloat(r,e){e.length&&this.writeMessage(r,mA,e)}writePackedDouble(r,e){e.length&&this.writeMessage(r,_A,e)}writePackedFixed32(r,e){e.length&&this.writeMessage(r,yA,e)}writePackedSFixed32(r,e){e.length&&this.writeMessage(r,xA,e)}writePackedFixed64(r,e){e.length&&this.writeMessage(r,vA,e)}writePackedSFixed64(r,e){e.length&&this.writeMessage(r,bA,e)}writeBytesField(r,e){this.writeTag(r,2),this.writeBytes(e)}writeFixed32Field(r,e){this.writeTag(r,5),this.writeFixed32(e)}writeSFixed32Field(r,e){this.writeTag(r,5),this.writeSFixed32(e)}writeFixed64Field(r,e){this.writeTag(r,1),this.writeFixed64(e)}writeSFixed64Field(r,e){this.writeTag(r,1),this.writeSFixed64(e)}writeVarintField(r,e){this.writeTag(r,0),this.writeVarint(e)}writeSVarintField(r,e){this.writeTag(r,0),this.writeSVarint(e)}writeStringField(r,e){this.writeTag(r,2),this.writeString(e)}writeFloatField(r,e){this.writeTag(r,5),this.writeFloat(e)}writeDoubleField(r,e){this.writeTag(r,1),this.writeDouble(e)}writeBooleanField(r,e){this.writeVarintField(r,+e)}};function Du(r,e,i){return i?4294967296*e+(r>>>0):4294967296*(e>>>0)+(r>>>0)}function C1(r,e,i){let s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(s);for(let a=i.pos-1;a>=r;a--)i.buf[a+s]=i.buf[a]}function pA(r,e){for(let i=0;i<r.length;i++)e.writeVarint(r[i])}function fA(r,e){for(let i=0;i<r.length;i++)e.writeSVarint(r[i])}function mA(r,e){for(let i=0;i<r.length;i++)e.writeFloat(r[i])}function _A(r,e){for(let i=0;i<r.length;i++)e.writeDouble(r[i])}function gA(r,e){for(let i=0;i<r.length;i++)e.writeBoolean(r[i])}function yA(r,e){for(let i=0;i<r.length;i++)e.writeFixed32(r[i])}function xA(r,e){for(let i=0;i<r.length;i++)e.writeSFixed32(r[i])}function vA(r,e){for(let i=0;i<r.length;i++)e.writeFixed64(r[i])}function bA(r,e){for(let i=0;i<r.length;i++)e.writeSFixed64(r[i])}let Py=3;function wA(r,e,i){e.glyphs=[],r===1&&i.readMessage(TA,e)}function TA(r,e,i){if(r===3){let{id:s,bitmap:a,width:h,height:u,left:f,top:g,advance:y}=i.readMessage(SA,{});e.glyphs.push({id:s,bitmap:new Nl({width:h+2*Py,height:u+2*Py},a),metrics:{width:h,height:u,left:f,top:g,advance:y}})}else r===4?e.ascender=i.readSVarint():r===5&&(e.descender=i.readSVarint())}function SA(r,e,i){r===1?e.id=i.readVarint():r===2?e.bitmap=i.readBytes():r===3?e.width=i.readVarint():r===4?e.height=i.readVarint():r===5?e.left=i.readSVarint():r===6?e.top=i.readSVarint():r===7&&(e.advance=i.readVarint())}let P1=Py,Io={horizontal:1,vertical:2,horizontalOnly:3};class qp{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){let s=new qp;return s.scale=e||1,s.fontStack=i,s}static forImage(e){let i=new qp;return i.image=e,i}}class Ou{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,s){let a=new Ou;for(let h=0;h<e.sections.length;h++){let u=e.sections[h];u.image?a.addImageSection(u,s):a.addTextSection(u,i)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,s){let a="";for(let h=0;h<i.length;h++){let u=i.charCodeAt(h+1)||null,f=i.charCodeAt(h-1)||null;a+=!s&&(u&&hu(u)&&!Gp[i[h+1]]||f&&hu(f)&&!Gp[i[h-1]])||!Gp[i[h]]?i[h]:Gp[i[h]]}return a}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&n_[this.text.charCodeAt(s)];s++)e++;let i=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&n_[this.text.charCodeAt(s)];s--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){let s=new Ou;return s.text=this.text.substring(e,i),s.sectionIndex=this.sectionIndex.slice(e,i),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(qp.forText(e.scale,e.fontStack||i));let s=this.sections.length-1;for(let a=0;a<e.text.length;++a)this.sectionIndex.push(s)}addImageSection(e,i){let s=e.image?e.image.getPrimary():null;if(!s)return void pi("Can't add FormattedSection with an empty image.");s.scaleSelf(i);let a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCodePoint(a),this.sections.push(qp.forImage(s)),this.sectionIndex.push(this.sections.length-1)):pi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Ry(r,e,i,s,a,h,u,f,g,y,T,E,A,R,L,k=1){let B=Ou.fromFeature(r,a,k);E===Io.vertical&&B.verticalizePunctuation(A);let G=[],X=function(ue,ge,ve,Ne,Ee,Ue){if(!ue)return[];let nt=[],qe=function(Je,Ie,Be,at,et,Lt){let St=0;for(let Xe=0;Xe<Je.length();Xe++){let tt=Je.getSection(Xe);St+=R1(Je.getCodePoint(Xe),tt,at,et,Ie,Lt)}return St/Math.max(1,Math.ceil(St/Be))}(ue,ge,ve,Ne,Ee,Ue),Ke=ue.text.indexOf("\u200B")>=0,it=0;for(let Je=0;Je<ue.length();Je++){let Ie=ue.getSection(Je),Be=ue.getCodePoint(Je);if(n_[Be]||(it+=R1(Be,Ie,Ne,Ee,ge,Ue)),Je<ue.length()-1){let at=!((Fe=Be)<11904||!(Ut["Bopomofo Extended"](Fe)||Ut.Bopomofo(Fe)||Ut["CJK Compatibility Forms"](Fe)||Ut["CJK Compatibility Ideographs"](Fe)||Ut["CJK Compatibility"](Fe)||Ut["CJK Radicals Supplement"](Fe)||Ut["CJK Strokes"](Fe)||Ut["CJK Symbols and Punctuation"](Fe)||Ut["CJK Unified Ideographs Extension A"](Fe)||Ut["CJK Unified Ideographs"](Fe)||Ut["Enclosed CJK Letters and Months"](Fe)||Ut["Halfwidth and Fullwidth Forms"](Fe)||Ut.Hiragana(Fe)||Ut["Ideographic Description Characters"](Fe)||Ut["Kangxi Radicals"](Fe)||Ut["Katakana Phonetic Extensions"](Fe)||Ut.Katakana(Fe)||Ut["Vertical Forms"](Fe)||Ut["Yi Radicals"](Fe)||Ut["Yi Syllables"](Fe)));(EA[Be]||at||Ie.image)&&nt.push(z1(Je+1,it,qe,nt,IA(Be,ue.getCodePoint(Je+1),at&&Ke),!1))}}var Fe;return D1(z1(ue.length(),it,qe,nt,0,!0))}(B,y,h,e,s,R),{processBidirectionalText:W,processStyledBidirectionalText:K}=as;if(W&&B.sections.length===1){let ue=W(B.toString(),X);for(let ge of ue){let ve=new Ou;ve.text=ge,ve.sections=B.sections;for(let Ne=0;Ne<ge.length;Ne++)ve.sectionIndex.push(0);G.push(ve)}}else if(K){let ue=K(B.text,B.sectionIndex,X);for(let ge of ue){let ve=new Ou;ve.text=ge[0],ve.sectionIndex=ge[1],ve.sections=B.sections,G.push(ve)}}else G=function(ue,ge){let ve=[],Ne=ue.text,Ee=0;for(let Ue of ge)ve.push(ue.substring(Ee,Ue)),Ee=Ue;return Ee<Ne.length&&ve.push(ue.substring(Ee,Ne.length)),ve}(B,X);let pe=[],ce={positionedLines:pe,text:B.toString(),top:T[1],bottom:T[1],left:T[0],right:T[0],writingMode:E,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(ue,ge,ve,Ne,Ee,Ue,nt,qe,Ke,it,Fe,Je){let Ie=0,Be=0,at=0,et=qe==="right"?1:qe==="left"?0:.5,Lt=!1;for(let ut of Ee){let vt=ut.getSections();for(let Vt of vt){if(Vt.image)continue;let Zt=ge[Vt.fontStack];if(Zt&&(Lt=Zt.ascender!==void 0&&Zt.descender!==void 0,!Lt))break}if(!Lt)break}let St=0;for(let ut of Ee){ut.trim();let vt=ut.getMaxScale(),Vt=(vt-1)*dn,Zt={positionedGlyphs:[],lineOffset:0};ue.positionedLines[St]=Zt;let Qt=Zt.positionedGlyphs,Kt=0;if(!ut.length()){Be+=Ue,++St;continue}let fi=0,oi=0;for(let ee=0;ee<ut.length();ee++){let te=ut.getSection(ee),Oe=ut.getSectionIndex(ee),lt=ut.getCodePoint(ee),pt=te.scale,dt=null,Et=null,qt=null,ci=dn,hi=0,ii=Ke;ii===Io.vertical&&((Xe=lt)===12312||Xe===12313||Xe===12316||Xe===12540||Xe===12448)&&(ii=Io.horizontal);let Gi=!(ii===Io.horizontal||!Fe&&!cu(lt)||Fe&&(n_[lt]||fm(lt)));if(te.image){let Tr=Ne.get(te.image.toString());if(!Tr)continue;qt=te.image,ue.iconsInText=ue.iconsInText||!0,Et=Tr.paddedRect;let ei=Tr.displaySize;pt=pt*dn/Je,dt={width:ei[0],height:ei[1],left:0,top:-P1,advance:Gi?ei[1]:ei[0],localGlyph:!1},hi=Lt?-dt.height*pt:vt*dn-17-ei[1]*pt,ci=dt.advance;let ar=(Gi?ei[0]:ei[1])*pt-dn*vt;ar>0&&ar>Kt&&(Kt=ar)}else{let Tr=ve[te.fontStack];if(!Tr)continue;Tr[lt]&&(Et=Tr[lt]);let ei=ge[te.fontStack];if(!ei)continue;let ar=ei.glyphs[lt];if(!ar)continue;if(dt=ar.metrics,ci=lt!==8203?dn:0,Lt){let Ji=ei.ascender!==void 0?Math.abs(ei.ascender):0,Bi=ei.descender!==void 0?Math.abs(ei.descender):0,xr=(Ji+Bi)*pt;fi<xr&&(fi=xr,oi=(Ji-Bi)/2*pt),hi=-Ji*pt}else hi=(vt-pt)*dn-17}Gi?(ue.verticalizable=!0,Qt.push({glyph:lt,image:qt,x:Ie,y:Be+hi,vertical:Gi,scale:pt,localGlyph:dt.localGlyph,fontStack:te.fontStack,sectionIndex:Oe,metrics:dt,rect:Et}),Ie+=ci*pt+it):(Qt.push({glyph:lt,image:qt,x:Ie,y:Be+hi,vertical:Gi,scale:pt,localGlyph:dt.localGlyph,fontStack:te.fontStack,sectionIndex:Oe,metrics:dt,rect:Et}),Ie+=dt.advance*pt+it)}Qt.length!==0&&(at=Math.max(Ie-it,at),Lt?O1(Qt,et,Kt,oi,Ue*vt/2):O1(Qt,et,Kt,0,Ue/2)),Ie=0;let ir=Ue*vt+Kt;Zt.lineOffset=Math.max(Kt,Vt),Be+=ir,++St}var Xe;let tt=Be,{horizontalAlign:It,verticalAlign:xt}=Ly(nt);(function(ut,vt,Vt,Zt,Qt,Kt){let fi=(vt-Vt)*Qt,oi=-Kt*Zt;for(let ir of ut)for(let ee of ir.positionedGlyphs)ee.x+=fi,ee.y+=oi})(ue.positionedLines,et,It,xt,at,tt),ue.top+=-xt*tt,ue.bottom=ue.top+tt,ue.left+=-It*at,ue.right=ue.left+at,ue.hasBaseline=Lt}(ce,e,i,s,G,u,f,g,E,y,A,L),!function(ue){for(let ge of ue)if(ge.positionedGlyphs.length!==0)return!1;return!0}(pe))return ce}let n_={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},EA={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function R1(r,e,i,s,a,h){if(e.image){let u=s.get(e.image.toString());return u?u.displaySize[0]*e.scale*dn/h+a:0}{let u=i[e.fontStack],f=u&&u.glyphs[r];return f?f.metrics.advance*e.scale+a:0}}function L1(r,e,i,s){let a=Math.pow(r-e,2);return s?r<e?a/2:2*a:a+Math.abs(i)*i}function IA(r,e,i){let s=0;return r===10&&(s-=1e4),i&&(s+=150),r!==40&&r!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function z1(r,e,i,s,a,h){let u=null,f=L1(e,i,a,h);for(let g of s){let y=L1(e-g.x,i,a,h)+g.badness;y<=f&&(u=g,f=y)}return{index:r,x:e,priorBreak:u,badness:f}}function D1(r){return r?D1(r.priorBreak).concat(r.index):[]}function Ly(r){let e=.5,i=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function O1(r,e,i,s,a){if(!(e||i||s||a))return;let h=r.length-1,u=r[h],f=(u.x+u.metrics.advance*u.scale)*e;for(let g=0;g<=h;g++)r[g].x-=f,r[g].y+=i+s+a}function k1(r){return r.imagePrimary!==void 0&&r.top!==void 0&&r.bottom!==void 0&&r.left!==void 0&&r.right!==void 0}function AA(r,e,i,s){let{horizontalAlign:a,verticalAlign:h}=Ly(s),u=i[0]-r.displaySize[0]*a,f=i[1]-r.displaySize[1]*h;return{imagePrimary:r,imageSecondary:e,top:f,bottom:f+r.displaySize[1],left:u,right:u+r.displaySize[0]}}function F1(r,e,i,s,a,h){let u=r.imagePrimary,f;if(u.content){let B=u.content,G=u.pixelRatio||1;f=[B[0]/G,B[1]/G,u.displaySize[0]-B[2]/G,u.displaySize[1]-B[3]/G]}let g=e.left*h,y=e.right*h,T,E,A,R;i==="width"||i==="both"?(R=a[0]+g-s[3],E=a[0]+y+s[1]):(R=a[0]+(g+y-u.displaySize[0])/2,E=R+u.displaySize[0]);let L=e.top*h,k=e.bottom*h;return i==="height"||i==="both"?(T=a[1]+L-s[0],A=a[1]+k+s[2]):(T=a[1]+(L+k-u.displaySize[1])/2,A=T+u.displaySize[1]),{imagePrimary:u,imageSecondary:void 0,top:T,right:E,bottom:A,left:R,collisionPadding:f}}function B1(r){return!r.imagePrimary.stretchX}function N1(r){return!r.imagePrimary.stretchY}function V1(r){return{width:r.right-r.left,height:r.bottom-r.top}}let da=128;function U1(r,e,i){let{expression:s}=e;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new ji(r+1,{worldview:i}))};if(s.kind==="source")return{kind:"source"};{let{zoomStops:a,interpolationType:h}=s,u=0;for(;u<a.length&&a[u]<=r;)u++;u=Math.max(0,u-1);let f=u;for(;f<a.length&&a[f]<r+1;)f++;f=Math.min(a.length-1,f);let g=a[u],y=a[f];return s.kind==="composite"?{kind:"composite",minZoom:g,maxZoom:y,interpolationType:h}:{kind:"camera",minZoom:g,maxZoom:y,minSize:s.evaluate(new ji(g,{worldview:i})),maxSize:s.evaluate(new ji(y,{worldview:i})),interpolationType:h}}}function zy(r,{uSize:e,uSizeT:i},{lowerSize:s,upperSize:a}){return r.kind==="source"?s/da:r.kind==="composite"?Bt(s/da,a/da,i):e}function Hp(r,e,i=1){let s=0,a=0;if(r.kind==="constant")a=r.layoutSize*i;else if(r.kind!=="source"){let{interpolationType:h,minZoom:u,maxZoom:f}=r,g=h?re(Hn.interpolationFactor(h,e,u,f),0,1):0;r.kind==="camera"?a=Bt(r.minSize,r.maxSize,g)*i:s=g*i}return{uSizeT:s,uSize:a}}class Ga extends Qe{constructor(e,i,s,a,h){super(e,i),this.angle=a,this.z=s,h!==void 0&&(this.segment=h)}clone(){return new Ga(this.x,this.y,this.z,this.angle,this.segment)}}function j1(r,e,i,s,a){if(e.segment===void 0)return!0;let h=e,u=e.segment+1,f=0;for(;f>-i/2;){if(u--,u<0)return!1;f-=r[u].dist(h),h=r[u]}f+=r[u].dist(r[u+1]),u++;let g=[],y=0;for(;f<i/2;){let T=r[u],E=r[u+1];if(!E)return!1;let A=r[u-1].angleTo(T)-T.angleTo(E);for(A=Math.abs((A+3*Math.PI)%(2*Math.PI)-Math.PI),g.push({distance:f,angleDelta:A}),y+=A;f-g[0].distance>s;)y-=g.shift().angleDelta;if(y>a)return!1;u++,f+=T.dist(E)}return!0}function G1(r){let e=0;for(let i=0;i<r.length-1;i++)e+=r[i].dist(r[i+1]);return e}function q1(r,e,i){return r?.6*e*i:0}function H1(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function MA(r,e,i,s,a,h){let u=q1(i,a,h),f=H1(i,s)*h,g=0,y=G1(r)/2;for(let T=0;T<r.length-1;T++){let E=r[T],A=r[T+1],R=E.dist(A);if(g+R>y){let L=(y-g)/R,k=Bt(E.x,A.x,L),B=Bt(E.y,A.y,L),G=new Ga(k,B,0,A.angleTo(E),T);return!u||j1(r,G,f,u,e)?G:void 0}g+=R}}function CA(r,e,i,s,a,h,u,f,g){let y=q1(s,h,u),T=H1(s,a),E=T*u,A=r[0].x===0||r[0].x===g||r[0].y===0||r[0].y===g;return e-E<e/4&&(e=E+e/4),$1(r,A?e/2*f%e:(T/2+2*h)*u*f%e,e,y,i,E,A,!1,g)}function $1(r,e,i,s,a,h,u,f,g){let y=h/2,T=G1(r),E=0,A=e-i,R=[];for(let L=0;L<r.length-1;L++){let k=r[L],B=r[L+1],G=k.dist(B),X=B.angleTo(k);for(;A+i<E+G;){A+=i;let W=(A-E)/G,K=Bt(k.x,B.x,W),pe=Bt(k.y,B.y,W);if(K>=0&&K<g&&pe>=0&&pe<g&&A-y>=0&&A+y<=T){let ce=new Ga(K,pe,0,X,L);s&&!j1(r,ce,h,s,a)||R.push(ce)}}E+=G}return f||R.length||u||(R=$1(r,E/2,i,s,a,h,u,!0,g)),R}function Z1(r){let e=0,i=0;for(let u of r)e+=u.w*u.h,i=Math.max(i,u.w);r.sort((u,f)=>f.h-u.h);let s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}],a=0,h=0;for(let u of r)for(let f=s.length-1;f>=0;f--){let g=s[f];if(!(u.w>g.w||u.h>g.h)){if(u.x=g.x,u.y=g.y,h=Math.max(h,u.y+u.h),a=Math.max(a,u.x+u.w),u.w===g.w&&u.h===g.h){let y=s.pop();y&&f<s.length&&(s[f]=y)}else u.h===g.h?(g.x+=u.w,g.w-=u.w):u.w===g.w?(g.y+=u.h,g.h-=u.h):(s.push({x:g.x+u.w,y:g.y,w:g.w-u.w,h:u.h}),g.y+=u.h,g.h-=u.h);break}}return{w:a,h,fill:e/(a*h)||0}}Tt(Ga,"Anchor");let ah=1;class $p{static getImagePositionScale(e,i,s){if(i&&e&&e.options&&e.options.transform){let a=e.options.transform;return{x:a.a,y:a.d}}return{x:s,y:s}}constructor(e,i,s,a){this.paddedRect=e;let{pixelRatio:h,version:u,stretchX:f,stretchY:g,content:y,sdf:T,usvg:E}=i;this.pixelRatio=h,this.stretchX=f,this.stretchY=g,this.content=y,this.version=u,this.padding=s,this.sdf=T,this.usvg=E,this.scale=$p.getImagePositionScale(a,E,h)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function Dy(r,e,i){let s=Ps.parse(r),a=function(h,u,f=[1,1]){return{x:0,y:0,w:(h.data?h.data.width:h.width*f[0])+2*u,h:(h.data?h.data.height:h.height*f[1])+2*u}}(e,i,[s.options.transform.a,s.options.transform.d]);return{bin:a,imagePosition:new $p(a,e,i,s),imageVariant:s}}class W1{constructor(e,i,s){let a=new Map,h=new Map;this.haveRenderCallbacks=[];let u=[];this.addImages(e,a,ah,u),this.addImages(i,h,2,u);let{w:f,h:g}=Z1(u),y=new vn({width:f||1,height:g||1});for(let[T,E]of e.entries()){let A=a.get(T).paddedRect;vn.copy(E.data,y,{x:0,y:0},{x:A.x+ah,y:A.y+ah},E.data,s,E.sdf)}for(let[T,E]of i.entries()){let A=h.get(T),R=A.paddedRect,L=A.padding,k=R.x+L,B=R.y+L,G=E.data.width,X=E.data.height;L=L>1?L-1:L,vn.copy(E.data,y,{x:0,y:0},{x:k,y:B},E.data,s),vn.copy(E.data,y,{x:0,y:X-L},{x:k,y:B-L},{width:G,height:L},s),vn.copy(E.data,y,{x:0,y:0},{x:k,y:B+X},{width:G,height:L},s),vn.copy(E.data,y,{x:G-L,y:0},{x:k-L,y:B},{width:L,height:X},s),vn.copy(E.data,y,{x:0,y:0},{x:k+G,y:B},{width:L,height:X},s),vn.copy(E.data,y,{x:G-L,y:X-L},{x:k-L,y:B-L},{width:L,height:L},s),vn.copy(E.data,y,{x:0,y:X-L},{x:k+G,y:B-L},{width:L,height:L},s),vn.copy(E.data,y,{x:0,y:0},{x:k+G,y:B+X},{width:L,height:L},s),vn.copy(E.data,y,{x:G-L,y:0},{x:k-L,y:B+X},{width:L,height:L},s)}this.lut=s,this.image=y,this.iconPositions=a,this.patternPositions=h}addImages(e,i,s,a){for(let[h,u]of e.entries()){let{bin:f,imagePosition:g,imageVariant:y}=Dy(h,u,s);i.set(h,g),a.push(f),u.hasRenderCallback&&this.haveRenderCallbacks.push(y.id)}}patchUpdatedImages(e,i,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(a=>e.hasImage(a,s)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(let a of e.getUpdatedImages(s)){for(let h of this.iconPositions.keys()){let u=Ps.parse(h);if(Jn.isEqual(u.id,a)){let f=e.getImage(a,s);this.patchUpdatedImage(this.iconPositions.get(h),f,i)}}for(let h of this.patternPositions.keys()){let u=Ps.parse(h);if(Jn.isEqual(u.id,a)){let f=e.getImage(a,s);this.patchUpdatedImage(this.patternPositions.get(h),f,i)}}}}patchUpdatedImage(e,i,s){if(!e||!i||e.version===i.version)return;e.version=i.version;let[a,h]=e.tl,u=e.sdf;if(this.lut||u){let f={width:i.data.width,height:i.data.height},g=new vn(f);vn.copy(i.data,g,{x:0,y:0},{x:0,y:0},f,this.lut,u),s.update(g,{position:{x:a,y:h}})}else s.update(i.data,{position:{x:a,y:h}})}}Tt($p,"ImagePosition"),Tt(W1,"ImageAtlas");let Zp=1e20;function X1(r,e,i,s,a,h,u,f,g){for(let y=e;y<e+s;y++)Y1(r,i*h+y,h,a,u,f,g);for(let y=i;y<i+a;y++)Y1(r,y*h+e,1,s,u,f,g)}function Y1(r,e,i,s,a,h,u){h[0]=0,u[0]=-Zp,u[1]=Zp,a[0]=r[e];for(let f=1,g=0,y=0;f<s;f++){a[f]=r[e+f*i];let T=f*f;do{let E=h[g];y=(a[f]-a[E]+T-E*E)/(f-E)/2}while(y<=u[g]&&--g>-1);g++,h[g]=f,u[g]=y,u[g+1]=Zp}for(let f=0,g=0;f<s;f++){for(;u[g+1]<f;)g++;let y=h[g],T=f-y;r[e+f*i]=a[y]+T*T}}let Ds=2,Oy={none:0,ideographs:1,all:2};class ku{constructor(e,i,s){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=s,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,i){let s=[],a=this.url||mn.GLYPHS_URL;for(let h in e)for(let u of e[h])s.push({stack:h,id:u});be(s,({stack:h,id:u},f)=>{let g=this.entries[h];g||(g=this.entries[h]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let y=g.glyphs[u];if(y!==void 0)return void f(null,{stack:h,id:u,glyph:y});if(y=this._tinySDF(g,h,u),y)return g.glyphs[u]=y,void f(null,{stack:h,id:u,glyph:y});let T=Math.floor(u/256);if(256*T>65535)return pi("glyphs > 65535 not supported"),void f(null,{stack:h,id:u,glyph:y});if(g.ranges[T])return void f(null,{stack:h,id:u,glyph:y});let E=g.requests[T];E||(E=g.requests[T]=[],ku.loadGlyphRange(h,T,a,this.requestManager,(A,R)=>{if(R){g.ascender=R.ascender,g.descender=R.descender;for(let L in R.glyphs)this._doesCharSupportLocalGlyph(+L)||(g.glyphs[+L]=R.glyphs[+L]);g.ranges[T]=!0}for(let L of E)L(A,R);delete g.requests[T]})),E.push((A,R)=>{A?f(A):R&&f(null,{stack:h,id:u,glyph:R.glyphs[u]||null})})},(h,u)=>{if(h)i(h);else if(u){let f={};for(let{stack:g,id:y,glyph:T}of u)f[g]===void 0&&(f[g]={}),f[g].glyphs===void 0&&(f[g].glyphs={}),f[g].glyphs[y]=T&&{id:T.id,bitmap:T.bitmap.clone(),metrics:T.metrics},f[g].ascender=this.entries[g].ascender,f[g].descender=this.entries[g].descender;i(null,f)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Oy.none&&(this.localGlyphMode===Oy.all?!!this.localFontFamily:!!this.localFontFamily&&(Ut["CJK Unified Ideographs"](e)||Ut["Hangul Syllables"](e)||Ut.Hiragana(e)||Ut.Katakana(e)||Ut["CJK Symbols and Punctuation"](e)||Ut["CJK Unified Ideographs Extension A"](e)||Ut["CJK Unified Ideographs Extension B"](e)||Ut.Osage(e)))}_tinySDF(e,i,s){let a=this.localFontFamily;if(!a||!this._doesCharSupportLocalGlyph(s))return;let h=e.tinySDF;if(!h){let k="400";/bold/i.test(i)?k="900":/medium/i.test(i)?k="500":/light/i.test(i)&&(k="200"),h=e.tinySDF=new ku.TinySDF({fontFamily:a,fontWeight:k,fontSize:24*Ds,buffer:3*Ds,radius:8*Ds}),h.fontWeight=k}if(this.localGlyphs[h.fontWeight][s])return this.localGlyphs[h.fontWeight][s];let u=String.fromCodePoint(s),{data:f,width:g,height:y,glyphWidth:T,glyphHeight:E,glyphLeft:A,glyphTop:R,glyphAdvance:L}=h.draw(u);return this.localGlyphs[h.fontWeight][s]={id:s,bitmap:new Nl({width:g,height:y},f),metrics:{width:T/Ds,height:E/Ds,left:A/Ds,top:R/Ds-27,advance:L/Ds,localGlyph:!0}}}}ku.loadGlyphRange=function(r,e,i,s,a){let h=256*e,u=h+255,f=s.transformRequest(s.normalizeGlyphsURL(i).replace("{fontstack}",r).replace("{range}",`${h}-${u}`),xc.Glyphs);vc(f,(g,y)=>{if(g)a(g);else if(y){let T={},E=function(A){return new r_(A).readFields(wA,{})}(y);for(let A of E.glyphs)T[A.id]=A;a(null,{glyphs:T,ascender:E.ascender,descender:E.descender})}})},ku.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:i=8,cutoff:s=.25,fontFamily:a="sans-serif",fontWeight:h="normal",fontStyle:u="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=i;let f=this.size=r+4*e,g=this._createCanvas(f),y=this.ctx=g.getContext("2d",{willReadFrequently:!0});y.font=`${u} ${h} ${r}px ${a}`,y.textBaseline="alphabetic",y.textAlign="left",y.fillStyle="black",this.gridOuter=new Float64Array(f*f),this.gridInner=new Float64Array(f*f),this.f=new Float64Array(f),this.z=new Float64Array(f+1),this.v=new Uint16Array(f)}_createCanvas(r){let e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){let{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:s,actualBoundingBoxLeft:a,actualBoundingBoxRight:h}=this.ctx.measureText(r),u=Math.ceil(i),f=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(h-a))),g=Math.min(this.size-this.buffer,u+Math.ceil(s)),y=f+2*this.buffer,T=g+2*this.buffer,E=Math.max(y*T,0),A=new Uint8ClampedArray(E),R={data:A,width:y,height:T,glyphWidth:f,glyphHeight:g,glyphTop:u,glyphLeft:0,glyphAdvance:e};if(f===0||g===0)return R;let{ctx:L,buffer:k,gridInner:B,gridOuter:G}=this;L.clearRect(k,k,f,g),L.fillText(r,k,k+u);let X=L.getImageData(k,k,f,g);G.fill(Zp,0,E),B.fill(0,0,E);for(let W=0;W<g;W++)for(let K=0;K<f;K++){let pe=X.data[4*(W*f+K)+3]/255;if(pe===0)continue;let ce=(W+k)*y+K+k;if(pe===1)G[ce]=0,B[ce]=Zp;else{let ue=.5-pe;G[ce]=ue>0?ue*ue:0,B[ce]=ue<0?ue*ue:0}}X1(G,0,0,y,T,y,this.f,this.v,this.z),X1(B,k,k,f,g,y,this.f,this.v,this.z);for(let W=0;W<E;W++){let K=Math.sqrt(G[W])-Math.sqrt(B[W]);A[W]=Math.round(255-255*(K/this.radius+this.cutoff))}return R}};let jl=ah;function K1(r,e){return r+e[1]-e[0]}function J1(r,e,i,s,a=1){let h=[],u=r.imagePrimary,f=u.pixelRatio,g=u.paddedRect.w-2*jl,y=u.paddedRect.h-2*jl,T=(r.right-r.left)*a,E=(r.bottom-r.top)*a,A=u.stretchX||[[0,g]],R=u.stretchY||[[0,y]],L=A.reduce(K1,0),k=R.reduce(K1,0),B=g-L,G=y-k,X=0,W=L,K=0,pe=k,ce=0,ue=B,ge=0,ve=G;if(u.content&&s){let Ee=u.content;X=o_(A,0,Ee[0]),K=o_(R,0,Ee[1]),W=o_(A,Ee[0],Ee[2]),pe=o_(R,Ee[1],Ee[3]),ce=Ee[0]-X,ge=Ee[1]-K,ue=Ee[2]-Ee[0]-W,ve=Ee[3]-Ee[1]-pe}let Ne=(Ee,Ue,nt,qe)=>{let Ke=s_(Ee.stretch-X,W,T,r.left*a),it=a_(Ee.fixed-ce,ue,Ee.stretch,L),Fe=s_(Ue.stretch-K,pe,E,r.top*a),Je=a_(Ue.fixed-ge,ve,Ue.stretch,k),Ie=s_(nt.stretch-X,W,T,r.left*a),Be=a_(nt.fixed-ce,ue,nt.stretch,L),at=s_(qe.stretch-K,pe,E,r.top*a),et=a_(qe.fixed-ge,ve,qe.stretch,k),Lt=new Qe(Ke,Fe),St=new Qe(Ie,Fe),Xe=new Qe(Ie,at),tt=new Qe(Ke,at),It=new Qe(it/f,Je/f),xt=new Qe(Be/f,et/f),ut=e*Math.PI/180;if(ut){let fi=Math.sin(ut),oi=Math.cos(ut),ir=[oi,-fi,fi,oi];Lt._matMult(ir),St._matMult(ir),tt._matMult(ir),Xe._matMult(ir)}let vt=Ee.stretch+Ee.fixed,Vt=nt.stretch+nt.fixed,Zt=Ue.stretch+Ue.fixed,Qt=qe.stretch+qe.fixed,Kt=r.imageSecondary;return{tl:Lt,tr:St,bl:tt,br:Xe,texPrimary:{x:u.paddedRect.x+jl+vt,y:u.paddedRect.y+jl+Zt,w:Vt-vt,h:Qt-Zt},texSecondary:Kt?{x:Kt.paddedRect.x+jl+vt,y:Kt.paddedRect.y+jl+Zt,w:Vt-vt,h:Qt-Zt}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:It,pixelOffsetBR:xt,minFontScaleX:ue/f/T,minFontScaleY:ve/f/E,isSDF:i}};if(s&&(u.stretchX||u.stretchY)){let Ee=Q1(A,B,L),Ue=Q1(R,G,k);for(let nt=0;nt<Ee.length-1;nt++){let qe=Ee[nt],Ke=Ee[nt+1];for(let it=0;it<Ue.length-1;it++)h.push(Ne(qe,Ue[it],Ke,Ue[it+1]))}}else h.push(Ne({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:g+1},{fixed:0,stretch:y+1}));return h}function o_(r,e,i){let s=0;for(let a of r)s+=Math.max(e,Math.min(i,a[1]))-Math.max(e,Math.min(i,a[0]));return s}function Q1(r,e,i){let s=[{fixed:-jl,stretch:0}];for(let[a,h]of r){let u=s[s.length-1];s.push({fixed:a-u.stretch,stretch:u.stretch}),s.push({fixed:a-u.stretch,stretch:u.stretch+(h-a)})}return s.push({fixed:e+jl,stretch:i}),s}function s_(r,e,i,s){return r/e*i+s}function a_(r,e,i,s){return r-e*i/s}function PA(r,e,i,s){let a=e+r.positionedLines[s].lineOffset;return s===0?i+a/2:i+(a+(e+r.positionedLines[s-1].lineOffset))/2}function RA(r,e=1,i=!1){let s=1/0,a=1/0,h=-1/0,u=-1/0,f=r[0];for(let R=0;R<f.length;R++){let L=f[R];(!R||L.x<s)&&(s=L.x),(!R||L.y<a)&&(a=L.y),(!R||L.x>h)&&(h=L.x),(!R||L.y>u)&&(u=L.y)}let g=Math.min(h-s,u-a),y=g/2,T=new Bh([],LA);if(g===0)return new Qe(s,a);for(let R=s;R<h;R+=g)for(let L=a;L<u;L+=g)T.push(new Fu(R+y,L+y,y,r));let E=function(R){let L=0,k=0,B=0,G=R[0];for(let X=0,W=G.length,K=W-1;X<W;K=X++){let pe=G[X],ce=G[K],ue=pe.x*ce.y-ce.x*pe.y;k+=(pe.x+ce.x)*ue,B+=(pe.y+ce.y)*ue,L+=3*ue}return new Fu(k/L,B/L,0,R)}(r),A=T.length;for(;T.length;){let R=T.pop();(R.d>E.d||!E.d)&&(E=R,i&&console.log("found best %d after %d probes",Math.round(1e4*R.d)/1e4,A)),R.max-E.d<=e||(y=R.h/2,T.push(new Fu(R.p.x-y,R.p.y-y,y,r)),T.push(new Fu(R.p.x+y,R.p.y-y,y,r)),T.push(new Fu(R.p.x-y,R.p.y+y,y,r)),T.push(new Fu(R.p.x+y,R.p.y+y,y,r)),A+=4)}return i&&(console.log(`num probes: ${A}`),console.log(`best distance: ${E.d}`)),E.p}function LA(r,e){return e.max-r.max}class Fu{constructor(e,i,s,a){this.p=new Qe(e,i),this.h=s,this.d=function(h,u){let f=!1,g=1/0;for(let y=0;y<u.length;y++){let T=u[y];for(let E=0,A=T.length,R=A-1;E<A;R=E++){let L=T[E],k=T[R];L.y>h.y!=k.y>h.y&&h.x<(k.x-L.x)*(h.y-L.y)/(k.y-L.y)+L.x&&(f=!f),g=Math.min(g,bo(h,L,k))}}return(f?1:-1)*Math.sqrt(g)}(this.p,a),this.max=this.d+this.h*Math.SQRT2}}let zA=Object.keys,ky=Number.POSITIVE_INFINITY,DA=Math.sqrt(2);function eb(r,[e,i]){let s=0,a=0;if(i===ky){e<0&&(e=0);let h=e/DA;switch(r){case"top-right":case"top-left":a=h-7;break;case"bottom-right":case"bottom-left":a=7-h;break;case"bottom":a=7-e;break;case"top":a=e-7}switch(r){case"top-right":case"bottom-right":s=-h;break;case"top-left":case"bottom-left":s=h;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),r){case"top-right":case"top-left":case"top":a=i-7;break;case"bottom-right":case"bottom-left":case"bottom":a=7-i}switch(r){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,a]}function l_(r,e,i,s,a,h,u,f,g){if(!e||!e.usvg)return;let y=V1(s),T=V1(a),E=h!=="both"&&h!=="width"||!B1(s)?1:T.width/y.width,A=h!=="both"&&h!=="height"||!N1(s)?1:T.height/y.height;i.scaleSelf(E,A);let R=i.toString();u.set(R,i),f.set(R,e);let{imagePosition:L}=Dy(R,e,ah);g.set(R,L)}function tb(r,e,i,s,a,h,u,f,g){if(!r)return;let y=function(T,E,A,R,L,k){if(T.kind==="camera")return T.maxSize;if(T.kind==="composite"){let B=E.possiblyEvaluate(new ji(T.maxZoom,{worldview:k}),A).evaluate(L,{},A),G=E.possiblyEvaluate(new ji(T.minZoom,{worldview:k}),A).evaluate(L,{},A);return Math.max(B,G)}return E.possiblyEvaluate(new ji(R,{worldview:k})).evaluate(L,{},A)}(e,i,s,a,h,g);return r.scaleSelf(y*f*u)}function ib(r,e,i,s,a,h,u,f,g){return{iconPrimary:tb(r.getPrimary(),e,i,s,a,h,u,f,g),iconSecondary:tb(r.getSecondary(),e,i,s,a,h,u,f,g)}}function OA(r,e,i){if(!e)return;let s=i.get(r.toString()),a=i.get(e.toString());a&&(s.paddedRect.w===a.paddedRect.w&&s.paddedRect.h===a.paddedRect.h||pi(`Mismatch in icon variant sizes: ${r.toString()} and ${e.toString()}`),s.usvg!==a.usvg&&pi(`Mismatch in icon variant image types: ${r.id} and ${e.id}`))}function rb(r,e,i,s){if(!r)return;let a=e.get(i.toString());if(r.imagePrimary=a,s){let h=e.get(s.toString());r.imageSecondary=h}}function kA(r,e){for(let i in r.horizontal)nb(r.horizontal[i],e);nb(r.vertical,e)}function nb(r,e){if(r){for(let i of r.positionedLines)for(let s of i.positionedGlyphs)if(s.image!==null){let a=s.image.toString();s.rect=e.get(a).paddedRect}}}function Fy(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function FA(r,e,i,s,a,h,u,f,g){let y=By(h.horizontal)||h.vertical,T=i.get("icon-text-fit-padding").evaluate(s,{},a),E,A=e;return e&&g!=="none"&&(r.allowVerticalPlacement&&h.vertical&&(E=F1(e,h.vertical,g,T,f,u)),y&&(A=F1(e,y,g,T,f,u))),{defaultShapedIcon:A,verticallyShapedIcon:E}}function BA(r,e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G,X,W){let K=u.textMaxSize.evaluate(e,{},A);K===void 0?K=f*u.textScaleFactor:K*=u.textScaleFactor;let pe=r.layers[0].layout,ce=By(i.horizontal)||i.vertical,ue=R.name==="globe",ge=dn,ve=r.tilePixelRatio*K/ge,Ne=(it=r.overscaling,r.zoom>18&&it>2&&(it>>=1),Math.max(ht/(512*it),1)*pe.get("symbol-spacing")),Ee=pe.get("text-padding")*r.tilePixelRatio,Ue=pe.get("icon-padding")*r.tilePixelRatio,nt=Ai(pe.get("text-max-angle")),qe=pe.get("icon-rotation-alignment")==="map"&&W!=="point",Ke=Ne/2;var it;r.hasAnyIconTextFit===!1&&B!=="none"&&(r.hasAnyIconTextFit=!0);let Fe=e.properties?+e.properties[yt]:null,Je=Fe&&r.elevationFeatureIdToIndex?r.elevationFeatureIdToIndex.get(Fe):65535,Ie=(Be,at,et)=>{if(at.x<0||at.x>=ht||at.y<0||at.y>=ht)return;let Lt=null;if(ue){let{x:St,y:Xe,z:tt}=R.projectTilePoint(at.x,at.y,et);Lt={anchor:new Ga(St,Xe,tt,0,void 0),up:R.upVector(et,at.x,at.y)}}(function(St,Xe,tt,It,xt,ut,vt,Vt,Zt,Qt,Kt,fi,oi,ir,ee,te,Oe,lt,pt,dt,Et,qt,ci,hi,ii,Gi,Tr,ei,ar){let Ji=St.addToLineVertexArray(Xe,It),Bi,xr,rr,Qi,tr,Ui,ri,qi=0,vr=0,jt=0,xi=0,nr=-1,Er=-1,lr={},Yr=ol(""),Zi=tt?tt.anchor:Xe,jr=ei!=="none",io=0,bn=0;if(Zt._unevaluatedLayout.getValue("text-radial-offset")===void 0){let Kr=Zt.layout.get("text-offset").evaluate(Et,{},ii);io=Kr[0]*dn,bn=Kr[1]*dn}else io=Zt.layout.get("text-radial-offset").evaluate(Et,{},ii)*dn,bn=ky;if(St.allowVerticalPlacement&&xt.vertical){let Kr=xt.vertical;if(ee)Ui=Ny(Kr),Vt&&(ri=Ny(Vt));else{let rn=Zt.layout.get("text-rotate").evaluate(Et,{},ii)+90;rr=c_(Qt,Zi,Xe,Kt,fi,oi,Kr,ir,rn,te),Vt&&(Qi=c_(Qt,Zi,Xe,Kt,fi,oi,Vt,lt,rn))}}if(ut){let Kr=St.iconSizeData,rn=Zt.layout.get("icon-rotate").evaluate(Et,{},ii),wn=J1(ut,rn,ci,jr,qt.iconScaleFactor),Fn=Vt?J1(Vt,rn,ci,jr,qt.iconScaleFactor):void 0;xr=c_(Qt,Zi,Xe,Kt,fi,oi,ut,lt,rn,null),qi=4*wn.length;let Pn=null;Kr.kind==="source"?(Pn=[da*Zt.layout.get("icon-size").evaluate(Et,{},ii)*qt.iconScaleFactor],Pn[0]>Gl&&pi(`${St.layerIds[0]}: Value for "icon-size" is >= ${Wp}. Reduce your "icon-size".`)):Kr.kind==="composite"&&(Pn=[da*qt.compositeIconSizes[0].evaluate(Et,{},ii)*qt.iconScaleFactor,da*qt.compositeIconSizes[1].evaluate(Et,{},ii)*qt.iconScaleFactor],(Pn[0]>Gl||Pn[1]>Gl)&&pi(`${St.layerIds[0]}: Value for "icon-size" is >= ${Wp}. Reduce your "icon-size".`)),St.addSymbols(St.icon,wn,Pn,dt,pt,Et,void 0,tt,Xe,Ji.lineStartIndex,Ji.lineLength,-1,hi,ii,Gi,Tr),nr=St.icon.placedSymbolArray.length-1,Fn&&(vr=4*Fn.length,St.addSymbols(St.icon,Fn,Pn,dt,pt,Et,Io.vertical,tt,Xe,Ji.lineStartIndex,Ji.lineLength,-1,hi,ii,Gi,Tr),Er=St.icon.placedSymbolArray.length-1)}for(let Kr in xt.horizontal){let rn=Kr,wn=xt.horizontal[rn];Bi||(Yr=ol(wn.text),ee?tr=Ny(wn):Bi=c_(Qt,Zi,Xe,Kt,fi,oi,wn,ir,Zt.layout.get("text-rotate").evaluate(Et,{},ii),te));let Fn=wn.positionedLines.length===1;if(jt+=ob(St,tt,Xe,wn,vt,Zt,ee,Et,te,Ji,xt.vertical?Io.horizontal:Io.horizontalOnly,Fn?zA(xt.horizontal):[rn],lr,nr,qt,hi,ii,Gi),Fn)break}xt.vertical&&(xi+=ob(St,tt,Xe,xt.vertical,vt,Zt,ee,Et,te,Ji,Io.vertical,["vertical"],lr,Er,qt,hi,ii,Gi));let _n=-1,ro=(Kr,rn)=>Kr?Math.max(Kr,rn):rn;_n=ro(tr,_n),_n=ro(Ui,_n),_n=ro(ri,_n);let pa=_n>-1?1:0;St.glyphOffsetArray.length>=65535&&pi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Et.sortKey!==void 0&&St.addToSortKeyRanges(St.symbolInstances.length,Et.sortKey),St.symbolInstances.emplaceBack(Xe.x,Xe.y,Zi.x,Zi.y,Zi.z,lr.right>=0?lr.right:-1,lr.center>=0?lr.center:-1,lr.left>=0?lr.left:-1,lr.vertical>=0?lr.vertical:-1,nr,Er,Yr,Bi!==void 0?Bi:St.collisionBoxArray.length,Bi!==void 0?Bi+1:St.collisionBoxArray.length,rr!==void 0?rr:St.collisionBoxArray.length,rr!==void 0?rr+1:St.collisionBoxArray.length,xr!==void 0?xr:St.collisionBoxArray.length,xr!==void 0?xr+1:St.collisionBoxArray.length,Qi||St.collisionBoxArray.length,Qi?Qi+1:St.collisionBoxArray.length,Kt,jt,xi,qi,vr,pa,0,io,bn,_n,0,jr?1:0,ar)})(r,at,Lt,Be,i,s,h,a,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,Ee,X,y,0,Ue,qe,G,e,u,T,E,A,L,k,B,Je)};if(W==="line")for(let Be of Xm(e.geometry,0,0,ht,ht)){let at=CA(Be,Ne,nt,i.vertical||ce,s,ge,ve,r.overscaling,ht);for(let et of at)ce&&NA(r,ce.text,Ke,et)||Ie(Be,et,A)}else if(W==="line-center"){for(let Be of e.geometry)if(Be.length>1){let at=MA(Be,nt,i.vertical||ce,s,ge,ve);at&&Ie(Be,at,A)}}else if(e.type==="Polygon")for(let Be of Pp(e.geometry,0)){let at=RA(Be,16);Ie(Be[0],new Ga(at.x,at.y,0,0,void 0),A)}else if(e.type==="LineString")for(let Be of e.geometry)Ie(Be,new Ga(Be[0].x,Be[0].y,0,0,void 0),A);else if(e.type==="Point")for(let Be of e.geometry)for(let at of Be)Ie([at],new Ga(at.x,at.y,0,0,void 0),A)}let Wp=255,Gl=Wp*da;function ob(r,e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B,G){let X=function(pe,ce,ue,ge,ve,Ne,Ee,Ue){let nt=[];if(ce.positionedLines.length===0)return nt;let qe=ge.layout.get("text-rotate").evaluate(Ne,{})*Math.PI/180,Ke=function(Be){let at=Be[0],et=Be[1],Lt=at*et;return Lt>0?[at,-et]:Lt<0?[-at,et]:at===0?[et,at]:[et,-at]}(ue),it=Math.abs(ce.top-ce.bottom);for(let Be of ce.positionedLines)it-=Be.lineOffset;let Fe=ce.positionedLines.length,Je=it/Fe,Ie=ce.top-ue[1];for(let Be=0;Be<Fe;++Be){let at=ce.positionedLines[Be];Ie=PA(ce,Je,Ie,Be);for(let et of at.positionedGlyphs){if(!et.rect)continue;let Lt=et.rect||{},St=P1+1,Xe=!0,tt=1,It=0;if(et.image){let Et=Ee.get(et.image.toString());if(!Et)continue;if(Et.sdf){pi("SDF images are not supported in formatted text and will be ignored.");continue}Xe=!1,tt=Et.pixelRatio,St=ah/tt}let xt=(ve||Ue)&&et.vertical,ut=et.metrics.advance*et.scale/2,vt=et.metrics,Vt=et.rect;if(Vt===null)continue;Ue&&ce.verticalizable&&(It=et.image?ut-et.metrics.width*et.scale/2:0);let Zt=ve?[et.x+ut,et.y]:[0,0],Qt=[0,0],Kt=[0,0],fi=!1;ve||(xt?(Kt=[et.x+ut+Ke[0],et.y+Ke[1]-It],fi=!0):Qt=[et.x+ut+ue[0],et.y+ue[1]-It]);let oi=Vt.w*et.scale/(tt*(et.localGlyph?Ds:1)),ir=Vt.h*et.scale/(tt*(et.localGlyph?Ds:1)),ee,te,Oe,lt;if(xt){let Et=et.y-Ie,qt=new Qe(-ut,ut-Et),ci=-Math.PI/2,hi=new Qe(...Kt);ee=new Qe(-ut+Qt[0],Qt[1]),ee._rotateAround(ci,qt)._add(hi),ee.x+=-Et+ut,ee.y-=(vt.left-St)*et.scale;let ii=et.image?vt.advance*et.scale:dn*et.scale,Gi=String.fromCodePoint(et.glyph);uA(Gi)?ee.x+=(1-St)*et.scale:dA(Gi)?ee.x+=ii-vt.height*et.scale+(-St-1)*et.scale:ee.x+=et.image||vt.width+2*St===Vt.w&&vt.height+2*St===Vt.h?(ii-ir)/2:(ii-(vt.height+2*St)*et.scale)/2,te=new Qe(ee.x,ee.y-oi),Oe=new Qe(ee.x+ir,ee.y),lt=new Qe(ee.x+ir,ee.y-oi)}else{let Et=(vt.left-St)*et.scale-ut+Qt[0],qt=(-vt.top-St)*et.scale+Qt[1],ci=Et+oi,hi=qt+ir;ee=new Qe(Et,qt),te=new Qe(ci,qt),Oe=new Qe(Et,hi),lt=new Qe(ci,hi)}if(qe){let Et;Et=ve?new Qe(0,0):fi?new Qe(Ke[0],Ke[1]):new Qe(ue[0],ue[1]),ee._rotateAround(qe,Et),te._rotateAround(qe,Et),Oe._rotateAround(qe,Et),lt._rotateAround(qe,Et)}let pt=new Qe(0,0),dt=new Qe(0,0);nt.push({tl:ee,tr:te,bl:Oe,br:lt,texPrimary:Lt,texSecondary:void 0,writingMode:ce.writingMode,glyphOffset:Zt,sectionIndex:et.sectionIndex,isSDF:Xe,pixelOffsetTL:pt,pixelOffsetBR:dt,minFontScaleX:0,minFontScaleY:0})}}return nt}(0,s,g,h,u,f,a,r.allowVerticalPlacement),W=r.textSizeData,K=null;W.kind==="source"?(K=[da*h.layout.get("text-size").evaluate(f,{},B)*L.textScaleFactor],K[0]>Gl&&pi(`${r.layerIds[0]}: Value for "text-size" is >= ${Wp}. Reduce your "text-size".`)):W.kind==="composite"&&(K=[da*L.compositeTextSizes[0].evaluate(f,{},B)*L.textScaleFactor,da*L.compositeTextSizes[1].evaluate(f,{},B)*L.textScaleFactor],(K[0]>Gl||K[1]>Gl)&&pi(`${r.layerIds[0]}: Value for "text-size" is >= ${Wp}. Reduce your "text-size".`)),r.addSymbols(r.text,X,K,g,u,f,T,e,i,y.lineStartIndex,y.lineLength,R,k,B,G,!1);for(let pe of E)A[pe]=r.text.placedSymbolArray.length-1;return 4*X.length}function By(r){for(let e in r)return r[e];return null}function c_(r,e,i,s,a,h,u,f,g,y){let T=u.top,E=u.bottom,A=u.left,R=u.right;if(k1(u)&&u.collisionPadding){let L=u.collisionPadding;A-=L[0],T-=L[1],R+=L[2],E+=L[3]}if(g){let L=new Qe(A,T),k=new Qe(R,T),B=new Qe(A,E),G=new Qe(R,E),X=Ai(g),W=new Qe(0,0);y&&(W=new Qe(y[0],y[1])),L._rotateAround(X,W),k._rotateAround(X,W),B._rotateAround(X,W),G._rotateAround(X,W),A=Math.min(L.x,k.x,B.x,G.x),R=Math.max(L.x,k.x,B.x,G.x),T=Math.min(L.y,k.y,B.y,G.y),E=Math.max(L.y,k.y,B.y,G.y)}return r.emplaceBack(e.x,e.y,e.z,i.x,i.y,A,T,R,E,f,s,a,h),r.length-1}function Ny(r){k1(r)&&r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);let e=r.bottom-r.top;return e>0?Math.max(10,e):null}function NA(r,e,i,s){let a=r.compareText;if(e in a){let h=a[e];for(let u=h.length-1;u>=0;u--)if(s.dist(h[u])<i)return!0}else a[e]=[];return a[e].push(s),!1}function sb(r,e){let i=r.fovAboveCenter,s=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,a=(r._camera.position[2]*r.worldSize-s)/Math.cos(r._pitch),h=Math.sin(i)*a/Math.sin(Math.max(Math.PI/2-r._pitch-i,.01)),u=Math.sin(r._pitch)*h+a,f=a*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let g=Math.max(r.zoom-17,0);r.isOrthographic&&(g/=10),u*=1+g}return Math.min(1.01*u,f)}function Xp(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};let i=Math.pow(2,-r.z),s=r.x*i,a=(r.x+1)*i,h=r.y*i,u=(r.y+1)*i,f=Z(s),g=Z(a),y=Y(h),T=Y(u),E=e.project(f,y),A=e.project(g,y),R=e.project(g,T),L=e.project(f,T),k=Math.min(E.x,A.x,R.x,L.x),B=Math.min(E.y,A.y,R.y,L.y),G=Math.max(E.x,A.x,R.x,L.x),X=Math.max(E.y,A.y,R.y,L.y),W=i/16;function K(ce,ue,ge,ve,Ne,Ee){let Ue=(ge+Ne)/2,nt=(ve+Ee)/2,qe=e.project(Z(Ue),Y(nt)),Ke=Math.max(0,k-qe.x,B-qe.y,qe.x-G,qe.y-X);k=Math.min(k,qe.x),G=Math.max(G,qe.x),B=Math.min(B,qe.y),X=Math.max(X,qe.y),Ke>W&&(K(ce,qe,ge,ve,Ue,nt),K(qe,ue,Ue,nt,Ne,Ee))}K(E,A,s,h,a,h),K(A,R,a,h,a,u),K(R,L,a,u,s,u),K(L,E,s,u,s,h),k-=W,B-=W,G+=W,X+=W;let pe=1/Math.max(G-k,X-B);return{scale:pe,x:k*pe,y:B*pe,x2:G*pe,y2:X*pe,projection:e}}function ab(r,{x:e,y:i},s=0){return new Qe(((e-s)*r.scale-r.x)*ht,(i*r.scale-r.y)*ht)}let VA=xe(new Float32Array(16));class ql{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new C(0,0)}projectTilePoint(e,i,s){return{x:e,y:i,z:0}}locationPoint(e,i,s,a=!0){return e._coordinatePoint(e.locationCoordinate(i,s),a)}pixelsPerMeter(e,i){return U(1,e)*i}pixelSpaceConversion(e,i,s){return 1}farthestPixelDistance(e){return sb(e,e.pixelsPerMeter)}pointCoordinate(e,i,s,a){let h=e.horizonLineFromTop(!1),u=new Qe(i,Math.max(h,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(u,a))}pointCoordinate3D(e,i,s){let a=new Qe(i,s);if(e.elevation)return e.elevation.pointCoordinate(a);{let h=this.pointCoordinate(e,a.x,a.y,0);return[h.x,h.y,h.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);let s=e.horizonLineFromTop();return i.y<s}createInversionMatrix(e,i){return VA}createTileMatrix(e,i,s){let a,h,u,f=s.canonical,g=xe(new Float64Array(16));if(this.isReprojectedInTileSpace){let y=Xp(f,this);a=1,h=y.x+s.wrap*y.scale,u=y.y,ft(g,g,[a/y.scale,a/y.scale,e.pixelsPerMeter/i])}else a=i/e.zoomScale(f.z),h=(f.x+Math.pow(2,f.z)*s.wrap)*a,u=f.y*a;return We(g,g,[h,u,0]),ft(g,g,[a/ht,a/ht,1]),g}upVector(e,i,s){return[0,0,1]}upVectorScale(e,i,s){return{metersToTile:1}}}class UA extends ql{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];let[i,s]=this.parallels=e.parallels||[29.5,45.5],a=Math.sin(Ai(i));this.n=(a+Math.sin(Ai(s)))/2,this.c=1+a*(2*this.n-a),this.r0=Math.sqrt(this.c)/this.n}project(e,i){let{n:s,c:a,r0:h}=this,u=Ai(e-this.center[0]),f=Ai(i),g=Math.sqrt(a-2*s*Math.sin(f))/s;return{x:g*Math.sin(u*s),y:g*Math.cos(u*s)-h,z:0}}unproject(e,i){let{n:s,c:a,r0:h}=this,u=h+i,f=Math.atan2(e,Math.abs(u))*Math.sign(u);u*s<0&&(f-=Math.PI*Math.sign(e)*Math.sign(u));let g=Ai(this.center[0])*s;f=De(f,-Math.PI-g,Math.PI-g);let y=re(Re(f/s)+this.center[0],-180,180),T=Math.asin(re((a-(e*e+u*u)*s*s)/(2*s),-1,1)),E=re(Re(T),-ne,ne);return new C(y,E)}}let Yp=1.340264,Kp=-.081106,Jp=893e-6,Qp=.003796,h_=Math.sqrt(3)/2;class jA extends ql{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;let s=Math.asin(h_*Math.sin(i)),a=s*s,h=a*a*a;return{x:.5*(e*Math.cos(s)/(h_*(Yp+3*Kp*a+h*(7*Jp+9*Qp*a)))/Math.PI+.5),y:1-.5*(s*(Yp+Kp*a+h*(Jp+Qp*a))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=s*s,h=a*a*a;for(let T,E,A,R=0;R<12&&(E=s*(Yp+Kp*a+h*(Jp+Qp*a))-i,A=Yp+3*Kp*a+h*(7*Jp+9*Qp*a),T=E/A,s=re(s-T,-Math.PI/3,Math.PI/3),a=s*s,h=a*a*a,!(Math.abs(T)<1e-12));++R);let u=h_*e*(Yp+3*Kp*a+h*(7*Jp+9*Qp*a))/Math.cos(s),f=Math.asin(Math.sin(s)/h_),g=re(180*u/Math.PI,-180,180),y=re(180*f/Math.PI,-ne,ne);return new C(g,y)}}class GA extends ql{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){let s=360*(e-.5),a=re(360*(.5-i),-ne,ne);return new C(s,a)}}let Bu=Math.PI/2;function u_(r){return Math.tan((Bu+r)/2)}class qA extends ql{constructor(e){super(e),this.center=e.center||[0,30];let[i,s]=this.parallels=e.parallels||[30,30],a=Ai(i),h=Ai(s);this.southernCenter=a+h<0,this.southernCenter&&(a=-a,h=-h);let u=Math.cos(a),f=u_(a);this.n=a===h?Math.sin(a):Math.log(u/Math.cos(h))/Math.log(u_(h)/f),this.f=u*Math.pow(u_(a),this.n)/this.n}project(e,i){i=Ai(i),this.southernCenter&&(i=-i),e=Ai(e-this.center[0]);let s=1e-6,{n:a,f:h}=this;h>0?i<-Bu+s&&(i=-Bu+s):i>Bu-s&&(i=Bu-s);let u=h/Math.pow(u_(i),a),f=u*Math.sin(a*e),g=h-u*Math.cos(a*e);return f=.5*(f/Math.PI+.5),g=.5*(g/Math.PI+.5),{x:f,y:this.southernCenter?g:1-g,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;let{n:s,f:a}=this,h=a-i,u=Math.sign(h),f=Math.sign(s)*Math.sqrt(e*e+h*h),g=Math.atan2(e,Math.abs(h))*u;h*s<0&&(g-=Math.PI*Math.sign(e)*u);let y=re(Re(g/s)+this.center[0],-180,180),T=re(Re(2*Math.atan(Math.pow(a/f,1/s))-Bu),-ne,ne);return new C(y,this.southernCenter?-T:T)}}class lb extends ql{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:F(e),y:j(i),z:0}}unproject(e,i){let s=Z(e),a=Y(i);return new C(s,a)}}let cb=Ai(ne);class HA extends ql{project(e,i){let s=(i=Ai(i))*i,a=s*s;return{x:.5*((e=Ai(e))*(.8707-.131979*s+a*(a*(.003971*s-.001529*a)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+s*(.015085+a*(.028874*s-.044475-.005916*a)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=25,h=0,u=s*s;do{u=s*s;let y=u*u;h=(s*(1.007226+u*(.015085+y*(.028874*u-.044475-.005916*y)))-i)/(1.007226+u*(.045255+y*(.259866*u-.311325-.005916*11*y))),s=re(s-h,-cb,cb)}while(Math.abs(h)>1e-6&&--a>0);u=s*s;let f=re(Re(e/(.8707+u*(u*(u*u*u*(.003971-.001529*u)-.013791)-.131979))),-180,180),g=Re(s);return new C(f,g)}}let hb=Ai(ne);class $A extends ql{project(e,i){i=Ai(i),e=Ai(e);let s=Math.cos(i),a=2/Math.PI,h=Math.acos(s*Math.cos(e/2)),u=Math.sin(h)/h,f=.5*(e*a+2*s*Math.sin(e/2)/u)||0,g=.5*(i+Math.sin(i)/u)||0;return{x:.5*(f/Math.PI+.5),y:1-.5*(g/Math.PI+1),z:0}}unproject(e,i){let s=e=(2*e-.5)*Math.PI,a=i=(2*(1-i)-1)*Math.PI,h=25,u=1e-6,f=0,g=0;do{let y=Math.cos(a),T=Math.sin(a),E=2*T*y,A=T*T,R=y*y,L=Math.cos(s/2),k=Math.sin(s/2),B=2*L*k,G=k*k,X=1-R*L*L,W=X?1/X:0,K=X?Math.acos(y*L)*Math.sqrt(1/X):0,pe=.5*(2*K*y*k+2*s/Math.PI)-e,ce=.5*(K*T+a)-i,ue=.5*W*(R*G+K*y*L*A)+1/Math.PI,ge=W*(B*E/4-K*T*k),ve=.125*W*(E*k-K*T*R*B),Ne=.5*W*(A*L+K*G*y)+.5,Ee=ge*ve-Ne*ue;f=(ce*ge-pe*Ne)/Ee,g=(pe*ve-ce*ue)/Ee,s=re(s-f,-Math.PI,Math.PI),a=re(a-g,-hb,hb)}while((Math.abs(f)>u||Math.abs(g)>u)&&--h>0);return new C(Re(s),Re(a))}}class ub extends ql{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Ai(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){let{scale:s,cosPhi:a}=this;return{x:Ai(e)*a*s+.5,y:-Math.sin(Ai(i))/a*s+.5,z:0}}unproject(e,i){let{scale:s,cosPhi:a}=this,h=-(i-.5)/s,u=re(Re((e-.5)/s)/a,-180,180),f=Math.asin(re(h*a,-1,1)),g=re(Re(f),-ne,ne);return new C(u,g)}}class ZA extends lb{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,s){let a=Sp(e,i,s);return Lr(a,a,Vm(ha(s))),{x:a[0],y:a[1],z:a[2]}}locationPoint(e,i,s){let a=x(i.lat,i.lng),h=Oi([],a),u=s?e._centerAltitude+s:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;tn(a,a,h,U(1,0)*ht*u);let f=xe(new Float64Array(16));return Te(f,e.pixelMatrix,e.globeMatrix),Lr(a,a,f),new Qe(a[0],a[1])}pixelsPerMeter(e,i){return U(1,0)*i}pixelSpaceConversion(e,i,s){let a=U(1,e)*i,h=Bt(U(1,45)*i,a,s);return this.pixelsPerMeter(e,i)/h}createTileMatrix(e,i,s){let a=Wg(ha(s.canonical));return Te(new Float64Array(16),e.globeMatrix,a)}createInversionMatrix(e,i){let{center:s}=e,a=Vm(ha(i));return Pt(a,a,Ai(s.lng)),_t(a,a,Ai(s.lat)),ft(a,a,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(a)}pointCoordinate(e,i,s,a){return kx(e,i,s,!0)||new le(0,0)}pointCoordinate3D(e,i,s){let a=this.pointCoordinate(e,i,s,0);return[a.x,a.y,a.z]}isPointAboveHorizon(e,i){return!kx(e,i.x,i.y,!1)}farthestPixelDistance(e){let i=function(a,h){let u=a.cameraToCenterDistance,f=a._centerAltitude*h,g=a._camera,y=a._camera.forward(),T=vi([],Xi([],y,-u),[0,0,f]),E=a.worldSize/(2*Math.PI),A=[0,0,-E],R=a.width/a.height,L=Math.tan(a.fovAboveCenter),k=Xi([],g.up(),L),B=Xi([],g.right(),L*R),G=Oi([],vi([],vi([],y,k),B)),X=[],W;if(new Si(T,G).closestPointOnSphere(A,E,X)){let K=vi([],X,A),pe=zr([],K,T);W=Math.cos(a.fovAboveCenter)*Ni(pe)}else{let K=zr([],T,A),pe=zr([],A,T);Oi(pe,pe);let ce=Ni(K)-E;W=Math.sqrt(ce*(ce+2*E));let ue=Math.acos(W/(E+ce))-Math.acos(or(y,pe));W*=Math.cos(ue)}return 1.01*W}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Bl(e.zoom);if(s>0){let a=sb(e,U(1,e.center.lat)*e.worldSize),h=e.worldSize/(2*Math.PI),u=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Bt(i,a+h*(1-Math.cos(u)),Math.pow(s,10))}return i}upVector(e,i,s){return Sp(i,s,e,1)}upVectorScale(e){return{metersToTile:Fm(Nm(ha(e)))}}}function db(r){let e=r.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new lb(r);case"equirectangular":return new GA(r);case"naturalEarth":return new HA(r);case"equalEarth":return new jA(r);case"winkelTripel":return new $A(r);case"albers":return i?new ub(r):new UA(r);case"lambertConformalConic":return i?new ub(r):new qA(r);case"globe":return new ZA(r)}throw new Error(`Invalid projection name: ${r.name}`)}let WA=Pe.types,XA=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function d_(r,e,i,s,a,h,u,f,g,y,T,E,A){let R=f?Math.min(Gl,Math.round(f[0])):0,L=f?Math.min(Gl,Math.round(f[1])):0;r.emplaceBack(e,i,Math.round(32*s),Math.round(32*a),h,u,(R<<1)+(g?1:0),L,16*y,16*T,256*E,256*A)}function p_(r,e,i){r.emplaceBack(e,i)}function f_(r,e,i,s,a,h,u){r.emplaceBack(e,i,s,a,h,u)}let m_=(r,e,i,s)=>{for(let a=0;a<e;a++)r.emplaceBack(i[0],i[1],i[2],s[0],s[1],s[2])};function __(r,e,i,s,a){r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a)}function YA(r){for(let e of r.sections)if(zg(e.text))return!0;return!1}class Vy{constructor(e){this.layoutVertexArray=new xu,this.indexArray=new ur,this.programConfigurations=e,this.segments=new gr,this.dynamicLayoutVertexArray=new aa,this.opacityVertexArray=new ap,this.placedSymbolArray=new Xc,this.iconTransitioningVertexArray=new cs,this.globeExtVertexArray=new Cl,this.zOffsetVertexArray=new Ba,this.orientationVertexArray=new hp}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,s,a,h){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,tA.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,rA.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,XA,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,sA.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,iA.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||h)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,nA.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,oA.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Tt(Vy,"SymbolBuffers");class Uy{constructor(e,i,s){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new s,this.segments=new gr,this.collisionVertexArray=new Rl,this.collisionVertexArrayExt=new aa}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,aA.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,lA.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Tt(Uy,"CollisionBuffers");class g_{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(u=>u.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=xe([]),this.placementViewportMatrix=xe([]);let i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=U1(this.zoom,i["text-size"],this.worldview),this.iconSizeData=U1(this.zoom,i["icon-size"],this.worldview);let s=this.layers[0].layout,a=s.get("symbol-sort-key"),h=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=h!=="viewport-y"&&a.constantOr(1)!==void 0,this.sortFeaturesByY=(h==="viewport-y"||h==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(u=>Io[u]),this.stateDependentLayerIds=this.layers.filter(u=>u.isStateDependent()).map(u=>u.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1}createArrays(){this.text=new Vy(new vo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new Vy(new vo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new yp,this.lineVertexArray=new Em,this.symbolInstances=new Sm}calculateGlyphDependencies(e,i,s,a,h){for(let u of e){let f=u.codePointAt(0);if(f===void 0)break;if(i[f]=!0,a&&h&&f<=65535){let g=Gp[u];g&&(i[g.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;let s=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!$m(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}populate(e,i,s,a){let h=this.layers[0],u=h.layout,f=this.projection.name==="globe",g=u.get("text-font"),y=u.get("text-field"),T=u.get("icon-image"),[E,A]=u.get("icon-size-scale-range"),R=re(i.scaleFactor||1,E,A),L=(y.value.kind!=="constant"||y.value.value instanceof Ln&&!y.value.value.isEmpty()||y.value.value.toString().length>0)&&(g.value.kind!=="constant"||g.value.value.length>0),k=T.value.kind!=="constant"||!!T.value.value||Object.keys(T.parameters).length>0,B=u.get("symbol-sort-key");if(this.features=[],!L&&!k)return;let G=i.iconDependencies,X=i.glyphDependencies,W=i.availableImages,K=new ji(this.zoom,{worldview:this.worldview});for(let{feature:pe,id:ce,index:ue,sourceLayerIndex:ge}of e){let ve=h._featureFilter.needGeometry,Ne=ke(pe,ve);if(!h._featureFilter.filter(K,Ne,s))continue;if(ve||(Ne.geometry=me(pe,s,a)),f&&pe.type!==1&&s.z<=5){let Ke=Ne.geometry,it=.98078528056,Fe=(Je,Ie)=>or(Sp(Je.x,Je.y,s,1),Sp(Ie.x,Ie.y,s,1))<it;for(let Je=0;Je<Ke.length;Je++)Ke[Je]=ze(Ke[Je],Fe)}let Ee,Ue;if(L){let Ke=h.getValueAndResolveTokens("text-field",Ne,s,W),it=Ln.factory(Ke);YA(it)&&(this.hasRTLText=!0),(!this.hasRTLText||ep()==="unavailable"||this.hasRTLText&&as.isParsed())&&(Ee=hA(it,h,Ne))}if(k){let Ke=h.getValueAndResolveTokens("icon-image",Ne,s,W);Ue=typeof Ke=="string"?qn.build(Ke):Ke}if(!Ee&&!Ue)continue;let nt=this.sortFeaturesByKey?B.evaluate(Ne,{},s):void 0,qe={id:ce,text:Ee,icon:Ue,index:ue,sourceLayerIndex:ge,geometry:Ne.geometry,properties:pe.properties,type:WA[pe.type],sortKey:nt};if(this.features.push(qe),Ue){let Ke=this.layers[0]._unevaluatedLayout._values,{iconPrimary:it,iconSecondary:Fe}=ib(Ue,this.iconSizeData,Ke["icon-size"],s,this.zoom,qe,this.pixelRatio,R,this.worldview),Je=it.id.toString();if(G.has(Je)?G.get(Je).push(it):G.set(Je,[it]),Fe){this.hasAnySecondaryIcon=!0;let Ie=Fe.id.toString();G.has(Ie)?G.get(Ie).push(Fe):G.set(Ie,[Fe])}}if(Ee){let Ke=g.evaluate(Ne,{},s).join(","),it=u.get("text-rotation-alignment")==="map"&&u.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Io.vertical)>=0;for(let Fe of Ee.sections)if(Fe.image){let Je=Fe.image.getPrimary().scaleSelf(this.pixelRatio),Ie=Je.id.toString(),Be=G.get(Ie)||[];Be.push(Je),G.set(Ie,Be)}else{let Je=Yd(Ee.toString()),Ie=Fe.fontStack||Ke,Be=X[Ie]=X[Ie]||{};this.calculateGlyphDependencies(Fe.text,Be,it,this.allowVerticalPlacement,Je)}}}if(u.get("symbol-placement")==="line"&&(this.features=function(pe){let ce={},ue={},ge=[],ve=0;function Ne(qe){ge.push(pe[qe]),ve++}function Ee(qe,Ke,it){let Fe=ue[qe];return delete ue[qe],ue[Ke]=Fe,ge[Fe].geometry[0].pop(),ge[Fe].geometry[0]=ge[Fe].geometry[0].concat(it[0]),Fe}function Ue(qe,Ke,it){let Fe=ce[Ke];return delete ce[Ke],ce[qe]=Fe,ge[Fe].geometry[0].shift(),ge[Fe].geometry[0]=it[0].concat(ge[Fe].geometry[0]),Fe}function nt(qe,Ke,it){let Fe=it?Ke[0][Ke[0].length-1]:Ke[0][0];return`${qe}:${Fe.x}:${Fe.y}`}for(let qe=0;qe<pe.length;qe++){let Ke=pe[qe],it=Ke.geometry,Fe=Ke.text?Ke.text.toString():null;if(!Fe){Ne(qe);continue}let Je=nt(Fe,it),Ie=nt(Fe,it,!0);if(Je in ue&&Ie in ce&&ue[Je]!==ce[Ie]){let Be=Ue(Je,Ie,it),at=Ee(Je,Ie,ge[Be].geometry);delete ce[Je],delete ue[Ie],ue[nt(Fe,ge[at].geometry,!0)]=at,ge[Be].geometry=null}else Je in ue?Ee(Je,Ie,it):Ie in ce?Ue(Je,Ie,it):(Ne(qe),ce[Je]=ve-1,ue[Ie]=ve-1)}return ge.filter(qe=>qe.geometry)}(this.features)),u.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(let pe of i.elevationFeatures)this.elevationFeatureIdToIndex.set(pe.id,this.elevationFeatures.length),this.elevationFeatures.push(pe)}}else u.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((pe,ce)=>pe.sortKey-ce.sortKey)}update(e,i,s,a,h,u,f){this.text.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1,s=se(e),a=1/s,h=!1,u=!1;for(let f=0;f<this.symbolInstances.length;f++){let g=this.symbolInstances.get(f),y=yi(1,0,0),T=yi(0,1,0),{numHorizontalGlyphVertices:E,numVerticalGlyphVertices:A,numIconVertices:R,numVerticalIconVertices:L}=g,k=E>0||A>0,B=R>0,G=this.elevationFeatures[g.elevationFeatureIndex];if(G){let X=new Qe(g.tileAnchorX,g.tileAnchorY),W=.075+G.pointElevation(X);g.zOffset!==W&&(i=!0,g.zOffset=W);let K=G.computeSlopeNormal(X,a),pe=Ja(bs(),yi(0,0,1),K);Bs(y,y,pe),Bs(T,T,pe),y[2]*=s,T[2]*=s,y[0]===1&&y[1]===0&&y[2]===0&&T[0]===0&&T[1]===1&&T[2]===0||(h=h||k,u=u||B)}if(k&&(m_(this.text.orientationVertexArray,E,y,T),m_(this.text.orientationVertexArray,A,y,T)),B){let{placedIconSymbolIndex:X,verticalPlacedIconSymbolIndex:W}=g;X>=0&&m_(this.icon.orientationVertexArray,R,y,T),W>=0&&m_(this.icon.orientationVertexArray,L,y,T)}}h||(this.text.orientationVertexArray=void 0),u||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){let e=(h,u,f)=>{s+=u,s>h.length&&h.resize(s);for(let g=-u;g<0;g++)h.emplace(g+s,f)},i=(h,u,f)=>{a+=u,a>h.length&&h.resize(a);for(let g=-u;g<0;g++)h.emplace(g+a,f)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,a=0;for(let h=0;h<this.symbolInstances.length;h++){let u=this.symbolInstances.get(h),{numHorizontalGlyphVertices:f,numVerticalGlyphVertices:g,numIconVertices:y}=u,T=u.zOffset,E=y>0;if((f>0||g>0)&&(e(this.text.zOffsetVertexArray,f,T),e(this.text.zOffsetVertexArray,g,T)),E){let{placedIconSymbolIndex:A,verticalPlacedIconSymbolIndex:R}=u;A>=0&&i(this.icon.zOffsetVertexArray,y,T),R>=0&&i(this.icon.zOffsetVertexArray,u.numVerticalIconVertices,T)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=db(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){let s=this.lineVertexArray.length;if(e.segment!==void 0)for(let{x:a,y:h}of i)this.lineVertexArray.emplaceBack(a,h);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,i,s,a,h,u,f,g,y,T,E,A,R,L,k,B){let G=e.indexArray,X=e.layoutVertexArray,W=e.globeExtVertexArray,K=e.segments.prepareSegment(4*i.length,X,G,this.canOverlap?u.sortKey:void 0),pe=this.glyphOffsetArray.length,ce=K.vertexLength,ue=this.allowVerticalPlacement&&f===Io.vertical?Math.PI/2:0,ge=u.text&&u.text.sections;for(let Ne=0;Ne<i.length;Ne++){let{tl:Ee,tr:Ue,bl:nt,br:qe,texPrimary:Ke,texSecondary:it,pixelOffsetTL:Fe,pixelOffsetBR:Je,minFontScaleX:Ie,minFontScaleY:Be,glyphOffset:at,isSDF:et,sectionIndex:Lt}=i[Ne],St=K.vertexLength,Xe=at[1];if(d_(X,y.x,y.y,Ee.x,Xe+Ee.y,Ke.x,Ke.y,s,et,Fe.x,Fe.y,Ie,Be),d_(X,y.x,y.y,Ue.x,Xe+Ue.y,Ke.x+Ke.w,Ke.y,s,et,Je.x,Fe.y,Ie,Be),d_(X,y.x,y.y,nt.x,Xe+nt.y,Ke.x,Ke.y+Ke.h,s,et,Fe.x,Je.y,Ie,Be),d_(X,y.x,y.y,qe.x,Xe+qe.y,Ke.x+Ke.w,Ke.y+Ke.h,s,et,Je.x,Je.y,Ie,Be),g){let{x:tt,y:It,z:xt}=g.anchor,[ut,vt,Vt]=g.up;f_(W,tt,It,xt,ut,vt,Vt),f_(W,tt,It,xt,ut,vt,Vt),f_(W,tt,It,xt,ut,vt,Vt),f_(W,tt,It,xt,ut,vt,Vt),__(e.dynamicLayoutVertexArray,tt,It,xt,ue)}else __(e.dynamicLayoutVertexArray,y.x,y.y,y.z,ue);if(B){let tt=it||Ke;p_(e.iconTransitioningVertexArray,tt.x,tt.y),p_(e.iconTransitioningVertexArray,tt.x+tt.w,tt.y),p_(e.iconTransitioningVertexArray,tt.x,tt.y+tt.h),p_(e.iconTransitioningVertexArray,tt.x+tt.w,tt.y+tt.h)}G.emplaceBack(St,St+1,St+2),G.emplaceBack(St+1,St+2,St+3),K.vertexLength+=4,K.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(at[0]),Ne!==i.length-1&&Lt===i[Ne+1].sectionIndex||e.programConfigurations.populatePaintArrays(X.length,u,u.index,{},R,L,k,ge&&ge[Lt],this.worldview)}let ve=g?g.anchor:y;e.placedSymbolArray.emplaceBack(ve.x,ve.y,ve.z,y.x,y.y,pe,this.glyphOffsetArray.length-pe,ce,T,E,y.segment,s?s[0]:0,s?s[1]:0,a[0],a[1],f,0,0,0,A,0)}_commitLayoutVertex(e,i,s,a,h,u,f){e.emplaceBack(i,s,a,h,u,Math.round(f.x),Math.round(f.y))}_addCollisionDebugVertices(e,i,s,a,h,u,f){let g=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),y=g.vertexLength,T=f.tileAnchorX,E=f.tileAnchorY;for(let R=0;R<4;R++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,i,e.padding,f.zOffset),this._commitLayoutVertex(s.layoutVertexArray,a,h,u,T,E,new Qe(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,h,u,T,E,new Qe(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,h,u,T,E,new Qe(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,a,h,u,T,E,new Qe(e.x1,e.y2)),g.vertexLength+=4;let A=s.indexArray;A.emplaceBack(y,y+1),A.emplaceBack(y+1,y+2),A.emplaceBack(y+2,y+3),A.emplaceBack(y+3,y),g.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,s,a,h,u){for(let f=a;f<h;f++){let g=s.get(f),y=this.getSymbolInstanceTextSize(e,u,i,f);this._addCollisionDebugVertices(g,y,this.textCollisionBox,g.projectedAnchorX,g.projectedAnchorY,g.projectedAnchorZ,u)}}_addIconDebugCollisionBoxes(e,i,s,a,h,u){for(let f=a;f<h;f++){let g=s.get(f),y=this.getSymbolInstanceIconSize(e,i,u.placedIconSymbolIndex);this._addCollisionDebugVertices(g,y,this.iconCollisionBox,g.projectedAnchorX,g.projectedAnchorY,g.projectedAnchorZ,u)}}generateCollisionDebugBuffers(e,i,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Uy(vu,I1.members,cs),this.iconCollisionBox=new Uy(vu,I1.members,cs);let a=Hp(this.iconSizeData,e),h=Hp(this.textSizeData,e,s);for(let u=0;u<this.symbolInstances.length;u++){let f=this.symbolInstances.get(u);this._addTextDebugCollisionBoxes(h,e,i,f.textBoxStartIndex,f.textBoxEndIndex,f),this._addTextDebugCollisionBoxes(h,e,i,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.iconBoxStartIndex,f.iconBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex,f)}}getSymbolInstanceTextSize(e,i,s,a){let h=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:a),u=zy(this.textSizeData,e,h)/dn;return this.tilePixelRatio*u}getSymbolInstanceIconSize(e,i,s){let a=this.icon.placedSymbolArray.get(s),h=zy(this.iconSizeData,e,a);return this.tilePixelRatio*h}_commitDebugCollisionVertexUpdate(e,i,s,a){e.emplaceBack(i,-s,-s,a),e.emplaceBack(i,s,-s,a),e.emplaceBack(i,s,s,a),e.emplaceBack(i,-s,s,a)}_updateTextDebugCollisionBoxes(e,i,s,a,h,u,f){for(let g=a;g<h;g++){let y=s.get(g),T=this.getSymbolInstanceTextSize(e,u,i,g);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,T,y.padding,u.zOffset)}}_updateIconDebugCollisionBoxes(e,i,s,a,h,u,f){for(let g=a;g<h;g++){let y=s.get(g),T=this.getSymbolInstanceIconSize(e,i,u.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,T,y.padding,u.zOffset)}}updateCollisionDebugBuffers(e,i,s,a){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let h=Hp(this.iconSizeData,e,a),u=Hp(this.textSizeData,e,s);for(let f=0;f<this.symbolInstances.length;f++){let g=this.symbolInstances.get(f);this._updateTextDebugCollisionBoxes(u,e,i,g.textBoxStartIndex,g.textBoxEndIndex,g,s),this._updateTextDebugCollisionBoxes(u,e,i,g.verticalTextBoxStartIndex,g.verticalTextBoxEndIndex,g,s),this._updateIconDebugCollisionBoxes(h,e,i,g.iconBoxStartIndex,g.iconBoxEndIndex,g,a),this._updateIconDebugCollisionBoxes(h,e,i,g.verticalIconBoxStartIndex,g.verticalIconBoxEndIndex,g,a)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,s,a,h,u,f,g,y){let T={};if(i<s){let{x1:E,y1:A,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K,featureIndex:pe}=e.get(i);T.textBox={x1:E,y1:A,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K},T.textFeatureIndex=pe}if(a<h){let{x1:E,y1:A,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K,featureIndex:pe}=e.get(a);T.verticalTextBox={x1:E,y1:A,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K},T.verticalTextFeatureIndex=pe}if(u<f){let{x1:E,y1:A,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K,featureIndex:pe}=e.get(u);T.iconBox={x1:E,y1:A,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K},T.iconFeatureIndex=pe}if(g<y){let{x1:E,y1:A,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K,featureIndex:pe}=e.get(g);T.verticalIconBox={x1:E,y1:A,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K},T.verticalIconFeatureIndex=pe}return T}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){let s=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){let s=e.placedSymbolArray.get(i),a=s.vertexStartIndex+4*s.numGlyphs;for(let h=s.vertexStartIndex;h<a;h+=4)e.indexArray.emplaceBack(h,h+1,h+2),e.indexArray.emplaceBack(h+1,h+2,h+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let i=Math.sin(e),s=Math.cos(e),a=[],h=[],u=[];for(let f=0;f<this.symbolInstances.length;++f){u.push(f);let g=this.symbolInstances.get(f);a.push(0|Math.round(i*g.tileAnchorX+s*g.tileAnchorY)),h.push(g.featureIndex)}return u.sort((f,g)=>a[f]-a[g]||h[g]-h[f]),u}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){let s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===i?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let i of this.symbolInstanceIndexes){let s=this.symbolInstances.get(i);this.featureSortOrder.push(s.featureIndex);let{rightJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:h,leftJustifiedTextSymbolIndex:u,verticalPlacedTextSymbolIndex:f,placedIconSymbolIndex:g,verticalPlacedIconSymbolIndex:y}=s;a>=0&&this.addIndicesForPlacedSymbol(this.text,a),h>=0&&h!==a&&this.addIndicesForPlacedSymbol(this.text,h),u>=0&&u!==h&&u!==a&&this.addIndicesForPlacedSymbol(this.text,u),f>=0&&this.addIndicesForPlacedSymbol(this.text,f),g>=0&&this.addIndicesForPlacedSymbol(this.icon,g),y>=0&&this.addIndicesForPlacedSymbol(this.icon,y)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let pb,fb,jy;Tt(g_,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),g_.addDynamicAttributes=__;class mb{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:al,this.defaultValue=e}evaluate(e){if(e.formattedSection){let i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Tt(mb,"FormatSectionOverride",{omit:["defaultValue"]});let Gy=()=>jy||(jy={layout:pb||(pb=new Ar({"symbol-placement":new ot(Se.layout_symbol["symbol-placement"]),"symbol-spacing":new ot(Se.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ot(Se.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new gt(Se.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ot(Se.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ot(Se.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new ot(Se.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new ot(Se.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ot(Se.layout_symbol["icon-ignore-placement"]),"icon-optional":new ot(Se.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ot(Se.layout_symbol["icon-rotation-alignment"]),"icon-size":new gt(Se.layout_symbol["icon-size"]),"icon-size-scale-range":new ot(Se.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new gt(Se.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new gt(Se.layout_symbol["icon-text-fit-padding"]),"icon-image":new gt(Se.layout_symbol["icon-image"]),"icon-rotate":new gt(Se.layout_symbol["icon-rotate"]),"icon-padding":new ot(Se.layout_symbol["icon-padding"]),"icon-keep-upright":new ot(Se.layout_symbol["icon-keep-upright"]),"icon-offset":new gt(Se.layout_symbol["icon-offset"]),"icon-anchor":new gt(Se.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ot(Se.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ot(Se.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ot(Se.layout_symbol["text-rotation-alignment"]),"text-field":new gt(Se.layout_symbol["text-field"]),"text-font":new gt(Se.layout_symbol["text-font"]),"text-size":new gt(Se.layout_symbol["text-size"]),"text-size-scale-range":new ot(Se.layout_symbol["text-size-scale-range"]),"text-max-width":new gt(Se.layout_symbol["text-max-width"]),"text-line-height":new gt(Se.layout_symbol["text-line-height"]),"text-letter-spacing":new gt(Se.layout_symbol["text-letter-spacing"]),"text-justify":new gt(Se.layout_symbol["text-justify"]),"text-radial-offset":new gt(Se.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ot(Se.layout_symbol["text-variable-anchor"]),"text-anchor":new gt(Se.layout_symbol["text-anchor"]),"text-max-angle":new ot(Se.layout_symbol["text-max-angle"]),"text-writing-mode":new ot(Se.layout_symbol["text-writing-mode"]),"text-rotate":new gt(Se.layout_symbol["text-rotate"]),"text-padding":new ot(Se.layout_symbol["text-padding"]),"text-keep-upright":new ot(Se.layout_symbol["text-keep-upright"]),"text-transform":new gt(Se.layout_symbol["text-transform"]),"text-offset":new gt(Se.layout_symbol["text-offset"]),"text-allow-overlap":new ot(Se.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ot(Se.layout_symbol["text-ignore-placement"]),"text-optional":new ot(Se.layout_symbol["text-optional"]),visibility:new ot(Se.layout_symbol.visibility)})),paint:fb||(fb=new Ar({"icon-opacity":new gt(Se.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new gt(Se.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new gt(Se.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new gt(Se.paint_symbol["text-emissive-strength"]),"icon-color":new gt(Se.paint_symbol["icon-color"]),"icon-halo-color":new gt(Se.paint_symbol["icon-halo-color"]),"icon-halo-width":new gt(Se.paint_symbol["icon-halo-width"]),"icon-halo-blur":new gt(Se.paint_symbol["icon-halo-blur"]),"icon-translate":new ot(Se.paint_symbol["icon-translate"]),"icon-translate-anchor":new ot(Se.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new ot(Se.paint_symbol["icon-image-cross-fade"]),"text-opacity":new gt(Se.paint_symbol["text-opacity"]),"text-occlusion-opacity":new gt(Se.paint_symbol["text-occlusion-opacity"]),"text-color":new gt(Se.paint_symbol["text-color"],{runtimeType:Qn,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new gt(Se.paint_symbol["text-halo-color"]),"text-halo-width":new gt(Se.paint_symbol["text-halo-width"]),"text-halo-blur":new gt(Se.paint_symbol["text-halo-blur"]),"text-translate":new ot(Se.paint_symbol["text-translate"]),"text-translate-anchor":new ot(Se.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new ot(Se.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new ot(Se.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new ot(Se.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new ot(Se.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new gt(Se.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},jy);class y_ extends Mn{constructor(e,i,s,a){super(e,Gy(),i,s,a),this._colorAdjustmentMatrix=xe([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let s=this.layout.get("text-writing-mode");if(s){let a=[];for(let h of s)a.indexOf(h)<0&&a.push(h);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,s,a){return this._saturation===e&&this._contrast===i&&this._brightnessMin===s&&this._brightnessMax===a||(this._colorAdjustmentMatrix=function(h,u,f,g){h=En(h),u=jn(u);let y=Ae(),T=h/3,E=1-2*T,A=[E,T,T,0,T,E,T,0,T,T,E,0,0,0,0,1],R=.5-.5*u,L=g-f;return Te(y,[L,0,0,0,0,L,0,0,0,0,L,0,f,f,f,1],[u,0,0,0,0,u,0,0,0,0,u,0,R,R,R,1]),Te(y,y,A),y}(e,i,s,a),this._saturation=e,this._contrast=i,this._brightnessMin=s,this._brightnessMax=a),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,s,a){let h=this.layout.get(e).evaluate(i,{},s,a),u=this._unevaluatedLayout._values[e];return u.isDataDriven()||$d(u.value)||!h?h:function(f,g){return g.replace(/{([^{}]+)}/g,(y,T)=>T in f?String(f[T]):"")}(i.properties,h)}createBucket(e){return new g_(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let e of Gy().paint.overridableProperties){if(!y_.hasPaintOverride(this.layout,e))continue;let i=this.paint.get(e),s=new mb(i),a=new Hd(s,i.property.specification,this.scope,this.options),h=null;h=i.value.kind==="constant"||i.value.kind==="source"?new au("source",a):new ia("composite",a,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new Fa(i.property,h,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,s){return!(!this.layout||i.isDataDriven()||s.isDataDriven())&&y_.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){let s=e.get("text-field"),a=Gy().paint.properties[i],h=!1,u=f=>{for(let g of f)if(a.overrides&&a.overrides.hasOverride(g))return void(h=!0)};if(s.value.kind==="constant"&&s.value.value instanceof Ln)u(s.value.value.sections);else if(s.value.kind==="source"){let f=y=>{h||(y instanceof Gt&&bt(y.value)===Ic?u(y.value.sections):y instanceof cl?u(y.sections):y.eachChild(f))},g=s.value;g._styleExpression&&f(g._styleExpression.expression)}return h}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,s){return{config:new On(this,{zoom:i,lut:s}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let _b,gb,yb,xb;var qy=gi([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function x_(r,e,i,s,a,h,u,f){let g=[r,e,1,i,s,1,a,h,1],y=[u,f,1],T=ae([],g),[E,A,R]=Fs(y,y,T);return we(g,g,[E,0,0,0,A,0,0,0,R])}function vb(r,e,i,s,a,h,u,f){let g=function(y,T,E,A,R,L,k,B){let G=x_(0,0,1,0,1,1,0,1),X=x_(y,T,E,A,R,L,k,B);return we(X,X,ae([],G))}(r,e,i,s,a,h,u,f);return[g[2]/g[8]/ht,g[5]/g[8]/ht]}function v_(r){return[r[0],Math.min(Math.max(r[1],-ne),ne)]}class bb extends Ia{constructor(e,i,s,a){super(),this.id=e,this.dispatcher=s,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(a),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new Ms("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=wc(this.map._requestManager.transformRequest(this.url,xc.Image),(s,a)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new mo(s)):a&&(this.image=a instanceof HTMLImageElement?Wo.getImageData(a):a,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Vp(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Ms("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Vp||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],s=e[0][1];for(let h of e)h[1]>s&&(s=h[1]),h[1]<i&&(i=h[1]);let a=(s+i)/2;if(a>ne?this.onNorthPole=!0:a<-ne&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let h=e.map(le.fromLngLat);this.tileID=function(u){let f=1/0,g=1/0,y=-1/0,T=-1/0;for(let k of u)f=Math.min(f,k.x),g=Math.min(g,k.y),y=Math.max(y,k.x),T=Math.max(T,k.y);let E=Math.max(y-f,T-g),A=Math.max(0,Math.floor(-Math.log(E)/Math.LN2)),R=Math.pow(2,A),L=Math.floor((f+y)/2*R);return L>1&&(L-=1),new To(A,L,Math.floor((g+T)/2*R))}(h),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Ms("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Vp||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(let G in this.tiles){let X=this.tiles[G];X.state!=="loaded"&&(X.state="loaded",X.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let i=Xp(new To(0,0,0),this.map.transform.projection),s=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(G){let X=G[1].x-G[0].x,W=G[1].y-G[0].y,K=G[2].x-G[1].x,pe=G[2].y-G[1].y,ce=G[3].x-G[2].x,ue=G[3].y-G[2].y,ge=G[0].x-G[3].x,ve=G[0].y-G[3].y,Ne=X*pe-K*W,Ee=K*ue-ce*pe,Ue=ce*ve-ge*ue,nt=ge*W-X*ve;return Ne>0&&Ee>0&&Ue>0&&nt>0||Ne<0&&Ee<0&&Ue<0&&nt<0}(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let a=Xp(this.tileID,this.map.transform.projection),[h,u,f,g]=this.coordinates.map(G=>{let X=a.projection.project(G[0],G[1]);return ab(a,X)._round()});this.perspectiveTransform=vb(h.x,h.y,u.x,u.y,f.x,f.y,g.x,g.y);let y=this._boundsArray=new Al;y.emplaceBack(h.x,h.y,0,0),y.emplaceBack(u.x,u.y,ht,0),y.emplaceBack(g.x,g.y,0,ht),y.emplaceBack(f.x,f.y,ht,ht),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(y,qy.members),this.boundsSegments=gr.simpleSegment(0,0,4,2);let T=[],E=[v_((A=this.coordinates)[0]),v_(A[1]),v_(A[2]),v_(A[3])];var A;let[R,L,k,B]=function(G){let X=G[0][0],W=X,K=G[0][1],pe=K;for(let ce=1;ce<G.length;ce++)G[ce][0]<X?X=G[ce][0]:G[ce][0]>W&&(W=G[ce][0]),G[ce][1]<K?K=G[ce][1]:G[ce][1]>pe&&(pe=G[ce][1]);return[X,K,W-X,pe-K]}(E);{let G=new Al,[X,W,K,pe]=function(Fe){let Je=Fe[0].x,Ie=Je,Be=Fe[0].y,at=Be;for(let et=1;et<Fe.length;et++)Fe[et].x<Je?Je=Fe[et].x:Fe[et].x>Ie&&(Ie=Fe[et].x),Fe[et].y<Be?Be=Fe[et].y:Fe[et].y>at&&(at=Fe[et].y);return[Je,Be,Ie-Je,at-Be]}(s),ce=Fe=>[(Fe.x-X)/K,(Fe.y-W)/pe],[ue,ge,ve,Ne]=s.map(ce),Ee=function(Fe,Je,Ie,Be,at,et,Lt,St){let Xe=x_(0,0,1,0,1,1,0,1);return we(Xe,Xe,ae([],x_(Fe,Je,Ie,Be,at,et,Lt,St)))}(ue[0],ue[1],ge[0],ge[1],ve[0],ve[1],Ne[0],Ne[1]);this.elevatedGlobePerspectiveTransform=vb(ue[0],ue[1],ge[0],ge[1],ve[0],ve[1],Ne[0],Ne[1]);let Ue=(Fe,Je)=>{T.push(Fe.lng);let Ie=Math.round((Fe.lng-R)/k*ht),Be=Math.round((Fe.lat-L)/B*ht),at=ce(Je),et=Fs([],[at[0],at[1],1],Ee),Lt=Math.round(et[0]/et[2]*ht),St=Math.round(et[1]/et[2]*ht);G.emplaceBack(Ie,Be,Lt,St)},nt=s[3].x-s[0].x,qe=s[3].y-s[0].y,Ke=s[2].x-s[1].x,it=s[2].y-s[1].y;for(let Fe=0;Fe<65;Fe++){let Je=Fe/64,Ie=[s[0].x+Je*nt,s[0].y+Je*qe],Be=[s[1].x+Je*Ke,s[1].y+Je*it],at=Be[0]-Ie[0],et=Be[1]-Ie[1];for(let Lt=0;Lt<65;Lt++){let St=Lt/64,Xe={x:Ie[0]+at*St,y:Ie[1]+et*St};Ue(i.projection.unproject(Xe.x,Xe.y),Xe)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(G,qy.members)}{this.maxLongitudeTriangleSize=0;let G=[],X=new ur,W=(K,pe,ce)=>{X.emplaceBack(K,pe,ce);let ue=T[K],ge=T[pe],ve=T[ce],Ne=Math.min(Math.min(ue,ge),ve),Ee=Math.max(Math.max(ue,ge),ve)-Ne;Ee>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Ee),G.push(Ne+Ee/2)};for(let K=0;K<64;K++)for(let pe=0;pe<64;pe++){let ce=65*K+pe,ue=ce+1,ge=ce+65,ve=ge+1;W(ce,ge,ue),W(ue,ge,ve)}[G,X]=function(K,pe){let ce=Array.from({length:K.length},(ve,Ne)=>Ne);ce.sort((ve,Ne)=>K[ve]-K[Ne]);let ue=[],ge=new ur;for(let ve=0;ve<ce.length;ve++){let Ne=ce[ve];ue.push(K[Ne]);let Ee=3*Ne,Ue=Ee+1;ge.emplaceBack(pe.uint16[Ee],pe.uint16[Ue],pe.uint16[Ue+1])}return[ue,ge]}(G,X),this.elevatedGlobeTrianglesCenterLongitudes=G,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(X)}this.elevatedGlobeSegments=gr.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,k/ht,0,B/ht,0,0,L,R,0])}prepare(){let e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;let i=this.map.painter.context,s=i.gl;!this._dirty||this.texture instanceof Vp||(this.texture?this.texture.update(this.image):(this.texture=new xy(i,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){let i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;let s=this.elevatedGlobeTrianglesCenterLongitudes,a=(h=e+180)+360*Math.round((s[0]-h)/360);var h;let u=new gr,f=(E,A)=>{u.segments.push({vertexOffset:0,primitiveOffset:E,vertexLength:i.segments[0].vertexLength,primitiveLength:A,sortKey:void 0,vaos:{}})},g=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-a)<=g){let E=ln(s,0,s.length,a+g);return E===s.length||f(E,_r(s,E+1,s.length,a+360-g)-E),u}a<s[0]&&(a+=360);let y=_r(s,0,s.length,a-g);if(y===s.length)return f(0,s.length),u;f(0,y-0);let T=ln(s,y+1,s.length,a+g);return T!==s.length&&f(T,s.length-T),u}}let KA=(Math.pow(256,2)-1)/16907520;class wb extends Mn{constructor(e,i,s,a){super(e,{layout:yb||(yb=new Ar({visibility:new ot(Se.layout_raster.visibility)})),paint:xb||(xb=new Ar({"raster-opacity":new ot(Se.paint_raster["raster-opacity"]),"raster-color":new wl(Se.paint_raster["raster-color"]),"raster-color-mix":new ot(Se.paint_raster["raster-color-mix"]),"raster-color-range":new ot(Se.paint_raster["raster-color-range"]),"raster-hue-rotate":new ot(Se.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ot(Se.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ot(Se.paint_raster["raster-brightness-max"]),"raster-saturation":new ot(Se.paint_raster["raster-saturation"]),"raster-contrast":new ot(Se.paint_raster["raster-contrast"]),"raster-resampling":new ot(Se.paint_raster["raster-resampling"]),"raster-fade-duration":new ot(Se.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new ot(Se.paint_raster["raster-emissive-strength"]),"raster-array-band":new ot(Se.paint_raster["raster-array-band"]),"raster-elevation":new ot(Se.paint_raster["raster-elevation"]),"raster-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof bb&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;let i=this._transitionablePaint._values["raster-color"].value.expression,[s,a]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(a)||s===this._curRampRange[0]&&a===this._curRampRange[1]||(this.colorRamp=Ep({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:a}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,a])}}let Tb,Sb,Eb,Ib,Ab;class Mb extends Mn{constructor(e,i,s,a){super(e,{layout:Tb||(Tb=new Ar({visibility:new ot(Se["layout_raster-particle"].visibility)})),paint:Sb||(Sb=new Ar({"raster-particle-array-band":new ot(Se["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new ot(Se["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new wl(Se["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new ot(Se["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new ot(Se["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new ot(Se["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new ot(Se["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new ot(Se["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this._updateColorRamp(),this.lastInvalidatedAt=Wo.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Ep({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Wo.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class JA extends Mn{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function Hy(r,e,i){let s=[0,0,1],a=ws([]);return Ka(a,a,i?-Ai(r)+Math.PI:Ai(r)),va(a,a,-Ai(e)),Bs(s,s,a),Oi(s,s)}let Cb={None:0,Model:1,Symbol:2,FillExtrusion:4};class b_{constructor(e,i,s,a){this.message=(e?`${e}: `:"")+s,a&&(this.identifier=a),i!=null&&i.__line__&&(this.line=i.__line__)}}function $y(r,e){let i=r.indexOf("://")===-1;try{return new URL(r,i&&e?"http://example.com":void 0),!0}catch{return!1}}class Pb{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Rb{constructor(){this.instancedDataArray=new bu,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Zy{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,i){}populate(e,i,s,a){this.tileToMeter=se(s);let h=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(let{feature:u,id:f,index:g,sourceLayerIndex:y}of e){let T=f??(u.properties&&u.properties.hasOwnProperty("id")?u.properties.id:void 0),E=ke(u,h);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),E,s))continue;let A={id:T,sourceLayerIndex:y,index:g,geometry:h?E.geometry:me(u,s,a),properties:u.properties,type:u.type,patterns:{}},R=this.addFeature(A,A.geometry,E);R&&i.featureIndex.insert(u,A.geometry,g,y,this.index,this.instancesPerModel[R].instancedDataArray.length,ht/32)}this.lookup=null}update(e,i,s,a){for(let h in this.instancesPerModel){let u=this.instancesPerModel[h];for(let f in e)u.idToFeaturesIndex.hasOwnProperty(f)&&(this.evaluate(u.features[u.idToFeaturesIndex[f]],e[f],u,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(let i in this.instancesPerModel){let s=this.instancesPerModel[i];for(let a of s.features){let h=this.layers[0],u=a.feature,f=this.canonical,g=h.paint.get("model-rotation").evaluate(u,{},f),y=h.paint.get("model-scale").evaluate(u,{},f),T=h.paint.get("model-translation").evaluate(u,{},f);Lo(a.rotation,g)&&Lo(a.scale,y)&&Lo(a.translation,T)||(this.evaluate(a,a.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,i,s,a){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;let h=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if($m(this.activeReplacements,h))return!1;this.activeReplacements=h;let u=!1;for(let f in this.instancesPerModel){let g=this.instancesPerModel[f],y=g.instancedDataArray;for(let T of g.features){let E=T.instancedDataOffset,A=T.instancedDataCount;for(let R=0;R<A;R++){let L=16*(R+E),k=y.float32[L+0],B=k>ht;k=B?k-ht:k;let G=Math.floor(k),X=y.float32[L+1],W=!1;for(let K of this.activeReplacements)if(!yv(K,s,Cb.Model,a)&&!(K.min.x>G||G>K.max.x||K.min.y>X||X>K.max.y)&&(W=ay(wv(G,X,e.canonical,K.footprintTileId.canonical),K.footprint),W))break;y.float32[L]=W?k+ht:k,u=u||W!==B}}}return u}isEmpty(){for(let e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(let i in this.instancesPerModel){let s=this.instancesPerModel[i];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,RI.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let i in this.instancesPerModel){let s=this.instancesPerModel[i];s.instancedDataArray.length!==0&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}let e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(let i of this.modelUris)e.removeModel(i,"",!0)}addFeature(e,i,s){let a=this.layers[0],h=a.layout.get("model-id").evaluate(s,{},this.canonical);if(!h)return pi(`modelId is not evaluated for layer ${a.id} and it is not going to get rendered.`),h;($y(h,!1)||this.styleDefinedModelURLs[h]!==void 0)&&(this.modelUris.includes(h)||this.modelUris.push(h)),this.instancesPerModel[h]||(this.instancesPerModel[h]=new Rb);let u=this.instancesPerModel[h],f=u.instancedDataArray,g=new Pb(s,f.length);for(let y of i)for(let T of y){if(T.x<0||T.x>=ht||T.y<0||T.y>=ht)continue;let E=(this.lookupDim-1)/ht,A=this.lookupDim*(T.y*E|0)+T.x*E|0;if(this.lookup){if(this.lookup[A]!==0)continue;this.lookup[A]=1}this.instanceCount++;let R=f.length;f.resize(R+1),u.instancesEvaluatedElevation.push(0),f.float32[16*R]=T.x,f.float32[16*R+1]=T.y}return g.instancedDataCount=u.instancedDataArray.length-g.instancedDataOffset,g.instancedDataCount>0&&(e.id&&(u.idToFeaturesIndex[e.id]=u.features.length),u.features.push(g),this.evaluate(g,{},u,!1)),h}getModelUris(){return this.modelUris}evaluate(e,i,s,a){let h=this.layers[0],u=e.feature,f=this.canonical,g=e.rotation=h.paint.get("model-rotation").evaluate(u,i,f),y=e.scale=h.paint.get("model-scale").evaluate(u,i,f),T=e.translation=h.paint.get("model-translation").evaluate(u,i,f),E=h.paint.get("model-color").evaluate(u,i,f);E.a=h.paint.get("model-color-mix-intensity").evaluate(u,i,f);let A=[];this.maxVerticalOffset<T[2]&&(this.maxVerticalOffset=T[2]),this.maxScale=Math.max(Math.max(this.maxScale,y[0]),Math.max(y[1],y[2])),r1(A,g,y);let R=Math.round(100*E.a)+E.b/1.05;for(let L=0;L<e.instancedDataCount;++L){let k=e.instancedDataOffset+L,B=16*k,G=s.instancedDataArray.float32,X=0;a&&(X=G[B+6]-s.instancesEvaluatedElevation[k]);let W=0|G[B+1];G[B]=(0|G[B])+E.r/1.05,G[B+1]=W+E.g/1.05,G[B+2]=R,G[B+3]=1/(f.z>10?this.tileToMeter:se(f,W)),G[B+4]=T[0],G[B+5]=T[1],G[B+6]=T[2]+X,G[B+7]=A[0],G[B+8]=A[1],G[B+9]=A[2],G[B+10]=A[4],G[B+11]=A[5],G[B+12]=A[6],G[B+13]=A[8],G[B+14]=A[9],G[B+15]=A[10],s.instancesEvaluatedElevation[k]=T[2]}}}let Lb,zb;Tt(Zy,"ModelBucket",{omit:["layers"]}),Tt(Rb,"PerModelAttributes"),Tt(Pb,"ModelFeature");class Nu{constructor(e,i,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=s}static create(e,i,s){let a=s||e.findDEMTileFor(i);if(!a||!a.dem)return;let h=a.dem,u=a.tileID,f=1<<i.canonical.z-u.canonical.z;return new Nu(a,h.dim/ht/f,[(i.canonical.x/f-u.canonical.x)*h.dim,(i.canonical.y/f-u.canonical.y)*h.dim])}tileCoordToPixel(e,i){let s=i*this._scale+this._offset[1];return new Qe(Math.floor(e*this._scale+this._offset[0]),Math.floor(s))}getElevationAt(e,i,s,a){let h=e*this._scale+this._offset[0],u=i*this._scale+this._offset[1],f=Math.floor(h),g=Math.floor(u),y=this._dem;return a=!!a,s?Bt(Bt(y.get(f,g,a),y.get(f,g+1,a),u-g),Bt(y.get(f+1,g,a),y.get(f+1,g+1,a),u-g),h-f):y.get(f,g,a)}getElevationAtPixel(e,i,s){return this._dem.get(e,i,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*U(1,e)*this._dem.stride}}let Wy=new Float32Array(262144),lh=new Uint8Array(262144);function Db(r){let e=0;if(r.meshes)for(let i of r.meshes)e=Math.max(e,i.aabb.max[2]);if(r.children)for(let i of r.children)e=Math.max(e,Db(i));return e}function Ob(r,e,i){if(r.meshes)for(let s of r.meshes){if(s.aabb.min[0]===1/0)continue;let a=li.applyTransform(s.aabb,r.matrix);i.insert(e,a.min[0],a.min[1],a.max[0],a.max[1])}if(r.children)for(let s of r.children)Ob(s,e,i)}let kb=["","wall","door","roof","window","lamp","logo"];class Fb{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:Db(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new li([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0,i=new li([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=li.applyTransformFast(s.aabb,this.node.matrix),i.encapsulate(s.transformedAabb)),e++;this.aabb=i}return this.aabb}}class w_{constructor(e,i,s,a,h,u,f,g){this.id=s,this.layers=e,this.layerIds=this.layers.map(y=>y.fqid),this.stateDependentLayerIds=this.layers.filter(y=>y.isStateDependent()).map(y=>y.id),this.modelTraits|=zu.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,a&&(this.modelTraits|=zu.HasMapboxMeshFeatures),h&&(this.modelTraits|=zu.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=u,this.worldview=g,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(let y of i)this.nodesInfo.push(new Fb(y)),Ob(y,f.featureIndexArray.length,f.grid),f.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,f.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(let s of this.getNodesInfo()){let a=s.node;a.footprint&&i.push({footprint:a.footprint,id:e})}}update(e){let i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;let s=i?this.stateDependentLayers:this.layers;if(!Es(e,this.states))for(let a of s)this.evaluate(a,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;let i=this.getNodesInfo();for(let s of i){let a=s.node;this.uploaded?this.updatePbrBuffer(a):wy(a,e,!0)}for(let s of i)i_(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(let s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),i=!0);return i}needsReEvaluation(e,i,s){let a=e.transform.projectionOptions,h=e.style.getBrightness(),u=this.brightness!==h;if(!this.uploaded||this.dirty||a.name!==this.projection.name||ef(s.paint.get("model-color").value,u)||ef(s.paint.get("model-color-mix-intensity").value,u)||ef(s.paint.get("model-roughness").value,u)||ef(s.paint.get("model-emissive-strength").value,u)||ef(s.paint.get("model-height-based-emissive-strength-multiplier").value,u)){this.projection=a,this.brightness=h;let f=this.getNodesInfo();for(let g of f)g.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;let s=this.getNodesInfo(),a=this.id.canonical;for(let h of s){let u=h.feature;h.evaluatedTranslation=i.paint.get("model-translation").evaluate(u,{},a),h.evaluatedScale=i.paint.get("model-scale").evaluate(u,{},a)}}evaluate(e,i){let s=this.getNodesInfo();for(let a of s){if(!a.node.meshes)continue;let h=a.feature,u=i&&i[h.id];if(Es(u,a.state))continue;a.state=structuredClone(u);let f=a.node.meshes&&a.node.meshes[0].featureData,g=a.evaluatedColor[2],y=a.evaluatedRMEA[2],T=this.id.canonical;if(a.hasTranslucentParts=!1,f){for(let E=0;E<kb.length;E++){let A=kb[E];A.length&&(h.properties.part=A);let R=e.paint.get("model-color").evaluate(h,u,T).toPremultipliedRenderColor(null),L=e.paint.get("model-color-mix-intensity").evaluate(h,u,T);a.evaluatedColor[E]=[R.r,R.g,R.b,L],a.evaluatedRMEA[E][0]=e.paint.get("model-roughness").evaluate(h,u,T),a.evaluatedRMEA[E][2]=e.paint.get("model-emissive-strength").evaluate(h,u,T),a.evaluatedRMEA[E][3]=R.a,a.emissionHeightBasedParams[E]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(h,u,T),!a.hasTranslucentParts&&R.a<1&&(a.hasTranslucentParts=!0)}delete h.properties.part,eM(a,g!==a.evaluatedColor[2]||y!==a.evaluatedRMEA[2],this.modelTraits)}else a.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(h,u,T);a.evaluatedTranslation=e.paint.get("model-translation").evaluate(h,u,T),a.evaluatedScale=e.paint.get("model-scale").evaluate(h,u,T),this.updatePbrBuffer(a.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,s,a){let h=e.findDEMTileFor(s);if(h&&(h.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(h.dem&&h.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=h.tileID.overscaledZ;let u=Nu.create(e,s,h);if(!u)return;this.modelTraits&zu.HasMapboxMeshFeatures&&this.updateDEM(e,u,s,a);for(let f of this.getNodesInfo()){let g=f.node;if(!g.footprint||!g.footprint.vertices||!g.footprint.vertices.length)continue;let y=g.footprint.vertices,T=u.getElevationAt(y[0].x,y[0].y,!0,!0);for(let E=1;E<y.length;E++)T=Math.min(T,u.getElevationAt(y[E].x,y[E].y,!0,!0));g.elevation=T}}this.terrainTile=h.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,s,a){let h=i._dem._modifiedForSources[a];if(h===void 0&&(i._dem._modifiedForSources[a]=[],h=i._dem._modifiedForSources[a]),h.includes(s.canonical))return;let u=i._dem.dim;h.push(s.canonical);let f=!1;for(let g of this.getNodesInfo()){let y=g.node;if(!y.footprint||!y.footprint.grid)continue;let T=y.footprint.grid,E=i.tileCoordToPixel(T.min.x,T.min.y),A=i.tileCoordToPixel(T.max.x,T.max.y),R=Math.min(Math.min(u-A.y,E.x),Math.min(E.y,u-A.x));if(R<0)continue;let L=re(R,2,5),k=Math.max(0,E.x-L),B=Math.max(0,E.y-L),G=Math.min(A.x+L,u-1),X=Math.min(A.y+L,u-1);for(let ce=B;ce<=X;++ce)for(let ue=k;ue<=G;++ue)lh[ce*u+ue]=255;let W=0,K=0;for(let ce=0;ce<T.cellsY;++ce)for(let ue=0;ue<T.cellsX;++ue){if(!T.cells[ce*T.cellsX+ue])continue;let ge=i.tileCoordToPixel(T.min.x+ue/T.xScale,T.min.y+ce/T.yScale),ve=i.tileCoordToPixel(T.min.x+(ue+1)/T.xScale,T.min.y+(ce+1)/T.yScale);for(let Ne=ge.y;Ne<=Math.min(ve.y+1,u-1);++Ne)for(let Ee=ge.x;Ee<=Math.min(ve.x+1,u-1);++Ee)lh[Ne*u+Ee]===255&&(lh[Ne*u+Ee]=0,W+=i.getElevationAtPixel(Ee,Ne),K++)}let pe=W/K;k=Math.max(1,E.x-L),B=Math.max(1,E.y-L),G=Math.min(A.x+L,u-2),X=Math.min(A.y+L,u-2),f=!0;for(let ce=B;ce<=X;++ce)for(let ue=k;ue<=G;++ue)lh[ce*u+ue]===0&&(Wy[ce*u+ue]=i._dem.set(ue,ce,pe));for(let ce=1;ce<L;++ce){k=Math.max(1,E.x-ce),B=Math.max(1,E.y-ce),G=Math.min(A.x+ce,u-2),X=Math.min(A.y+ce,u-2);for(let ue=B;ue<=X;++ue)for(let ge=k;ge<=G;++ge){let ve=ue*u+ge;if(lh[ve]===255){let Ne=0,Ee=0,Ue=-1,nt=-1;for(let qe=-1;qe<=1;++qe)for(let Ke=-1;Ke<=1;++Ke){let it=(ue+qe)*u+ge+Ke;if(lh[it]>=ce)continue;let Fe=Wy[it],Je=Math.abs(Fe);Je>Ee&&(Ne=Fe,Ee=Je,Ue=Ke,nt=qe)}if(Ee>.1){let qe=1-(ce+.5*Math.abs(Ue*nt))/L,Ke=i._dem.get(ge,ue)+Ne*qe,it=i._dem.get(ge+Ue,ue+nt),Fe=i._dem.get(ge-Ue,ue-nt,!0);(Ke-it)*(Ke-Fe)>0&&(Ke=(it+Fe)/2),Wy[ve]=i._dem.set(ge,ue,Ke),lh[ve]=ce}}}}}f&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=Wo.now())}setFilter(e){this.filter=e?Tl(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new ji(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){let e=this.getNodesInfo();for(let i of e)i_(i.node),Ty(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;let s=i.getReplacementRegionsForTile(e.toUnwrapped());for(let a of this.getNodesInfo()){let h=a.node.footprint;a.hiddenByReplacement=!!h&&!s.find(u=>u.footprint===h)}}getHeightAtTileCoord(e,i){let s=[],a=[0,0,0],h=xe([]);for(let u of this.getNodesInfo()){let f=u.node.meshes[0],g=f.transformedAabb;if(e<g.min[0]||i<g.min[1]||e>g.max[0]||i>g.max[1])continue;if(u.node.hidden===!0)return{height:1/0,maxHeight:u.feature.properties.height,hidden:!1,verticalScale:u.evaluatedScale[2]};Ge(h,u.node.matrix),a[0]=e,a[1]=i,Lr(a,a,h);let y=(a[0]-f.aabb.min[0])/(f.aabb.max[0]-f.aabb.min[0])*oh|0,T=Math.min(63,(a[1]-f.aabb.min[1])/(f.aabb.max[1]-f.aabb.min[1])*oh|0)*oh+Math.min(63,y),E=f.heightmap[T];if(!(E<0&&u.node.footprint))return u.hiddenByReplacement?void 0:{height:E,maxHeight:u.feature.properties.height,hidden:!1,verticalScale:u.evaluatedScale[2]};if(u.node.footprint.grid.query(new Qe(e,i),new Qe(e,i),s),s.length>0)return{height:void 0,maxHeight:u.feature.properties.height,hidden:u.hiddenByReplacement,verticalScale:u.evaluatedScale[2]}}}}function ef(r,e){return r instanceof au&&!r.isLightConstant&&e}function QA(r,e,i,s,a,h,u,f){let g=(61440&e|(61440&e)>>4)>>8,y=(3840&e|(3840&e)>>4)>>4,T=240&e|(240&e)>>4;i[3]>0&&(g=Bt(g,255*i[0],i[3]),y=Bt(y,255*i[1],i[3]),T=Bt(T,255*i[2],i[3]));let E=g<<8|y,A=T<<8|Math.floor(255*s[3]),R=function(ce){let ue=re(ce,0,2);return Math.min(Math.round(.5*ue*255),255)}(s[2])<<8|15*s[0]<<4|15*s[1],L=re(a[0],0,1),k=re(a[1],0,1),B=re(a[2],0,1),G=re(a[3],0,1),X,W,K,pe;if(L!==k&&u!==h&&k!==L){let ce=u-h;W=1/(ce*(k-L)),K=-(h+ce*L)/(ce*(k-L));let ue=re(a[4],-1,1);pe=Math.pow(10,ue),X=255*B<<8|255*G}else X=65535,W=0,K=1,pe=1;if(r.emplaceBack(E,A,R,X,W,K,pe),f){let ce=f.length;f.clear();for(let ue=0;ue<ce;ue++)f.emplaceBack(E,A,R,X,W,K,pe)}}function eM(r,e,i){let s=r.node,a=0,h=i&zu.HasMeshoptCompression;for(let u of s.meshes){if(s.lights&&s.lightMeshIndex===a||!u.featureData)continue;u.featureArray=new zl,u.featureArray.reserve(u.featureData.length);let f=e;for(let g of u.featureData){let y=h?65535&g:g>>16&65535,T=h?g>>16&65535:65535&g,E=(15&T)<8?15&T:0,A=r.evaluatedRMEA[E],R=r.evaluatedColor[E],L=r.emissionHeightBasedParams[E],k;if(f&&E===2&&s.lights&&(k=new zl,k.resize(10*s.lights.length)),QA(u.featureArray,y,R,A,L,u.aabb.min[2],u.aabb.max[2],k),k&&f){f=!1;let B=s.meshes[s.lightMeshIndex];B.featureArray=k,B.featureArray._trim()}}u.featureArray._trim(),a++}}function Bb(r,e,i,s){let a=1<<r.z;e.lat=Y((s/ht+r.y)/a),e.lng=Z((i/ht+r.x)/a)}function tM(r,e,i,s){let a=r.getNodesInfo()[e];if(!a||a.hiddenByReplacement||!a.node.meshes)return;let h=Number.MAX_VALUE,u=a.node,f=i.tile,g=s.calculatePosMatrix(f.tileID.toUnwrapped(),s.worldSize),y=a.evaluatedScale,T=0;s.elevation&&u.elevation&&(T=u.elevation*s.elevation.exaggeration()),We(g,g,[(u.anchor?u.anchor[0]:0)*(y[0]-1),(u.anchor?u.anchor[1]:0)*(y[1]-1),T]),ft(g,g,y);let E=i.queryGeometry,A=E.isPointQuery()?E.screenBounds:E.screenGeometry,R=function(k){let B=Te([],g,k.matrix);Te(B,s.expandedFarZProjMatrix,B);for(let G=0;G<k.meshes.length;++G){let X=k.meshes[G];if(G===k.lightMeshIndex)continue;let W=n1(A,s,B,X.aabb);W!=null&&(h=Math.min(W,h))}if(k.children)for(let G of k.children)R(G)};if(R(u),h===Number.MAX_VALUE)return;let L=new C(0,0);return Bb(f.tileID.canonical,L,a.node.anchor[0],a.node.anchor[1]),{intersectionZ:h,position:L,feature:a.feature}}Tt(w_,"Tiled3dModelBucket",{omit:["layers"]}),Tt(Fb,"Tiled3dModelFeature");let iM={circle:class extends Mn{constructor(r,e,i,s){super(r,{layout:ca||(ca=new Ar({"circle-sort-key":new gt(Se.layout_circle["circle-sort-key"]),"circle-elevation-reference":new ot(Se.layout_circle["circle-elevation-reference"]),visibility:new ot(Se.layout_circle.visibility)})),paint:kl||(kl=new Ar({"circle-radius":new gt(Se.paint_circle["circle-radius"]),"circle-color":new gt(Se.paint_circle["circle-color"]),"circle-blur":new gt(Se.paint_circle["circle-blur"]),"circle-opacity":new gt(Se.paint_circle["circle-opacity"]),"circle-translate":new ot(Se.paint_circle["circle-translate"]),"circle-translate-anchor":new ot(Se.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ot(Se.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ot(Se.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new gt(Se.paint_circle["circle-stroke-width"]),"circle-stroke-color":new gt(Se.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new gt(Se.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ot(Se.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}createBucket(r){return new Li(r)}queryRadius(r){let e=r;return un("circle-radius",this,e)+un("circle-stroke-width",this,e)+Pr(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,i,s,a,h,u,f){let g=Va(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),h.angle,r.pixelToTileUnitsFactor),y=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return Hx(r,s,h,u,f,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",g,y)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,i){let s=qx(this);return{config:new On(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}is3D(r){return!r&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends Mn{createBucket(r){return new Zx(r)}constructor(r,e,i,s){super(r,{layout:Wx||(Wx=new Ar({visibility:new ot(Se.layout_heatmap.visibility)})),paint:Xx||(Xx=new Ar({"heatmap-radius":new gt(Se.paint_heatmap["heatmap-radius"]),"heatmap-weight":new gt(Se.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ot(Se.paint_heatmap["heatmap-intensity"]),"heatmap-color":new wl(Se.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ot(Se.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Ep({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(r){return un("heatmap-radius",this,r)}queryIntersectsFeature(r,e,i,s,a,h,u,f){let g=this.paint.get("heatmap-radius").evaluate(e,i);return Hx(r,s,h,u,f,!0,!0,new Qe(0,0),g)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,i){return r==="heatmap"?{config:new On(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends Mn{constructor(r,e,i,s){super(r,{layout:Yx||(Yx=new Ar({visibility:new ot(Se.layout_hillshade.visibility)})),paint:Kx||(Kx=new Ar({"hillshade-illumination-direction":new ot(Se.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ot(Se.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ot(Se.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ot(Se.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ot(Se.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ot(Se.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ot(Se.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}},fill:class extends Mn{constructor(r,e,i,s){super(r,{layout:dv||(dv=new Ar({"fill-sort-key":new gt(Se.layout_fill["fill-sort-key"]),visibility:new ot(Se.layout_fill.visibility),"fill-elevation-reference":new ot(Se.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new gt(Se.layout_fill["fill-construct-bridge-guard-rail"])})),paint:pv||(pv=new Ar({"fill-antialias":new ot(Se.paint_fill["fill-antialias"]),"fill-opacity":new gt(Se.paint_fill["fill-opacity"]),"fill-color":new gt(Se.paint_fill["fill-color"]),"fill-outline-color":new gt(Se.paint_fill["fill-outline-color"]),"fill-translate":new ot(Se.paint_fill["fill-translate"]),"fill-translate-anchor":new ot(Se.paint_fill["fill-translate-anchor"]),"fill-pattern":new gt(Se.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new ot(Se.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new ot(Se.paint_fill["fill-emissive-strength"]),"fill-z-offset":new gt(Se.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new gt(Se.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new gt(Se.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){let r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(r,e,i){return{config:new On(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);let i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new ny(r)}queryRadius(){return Pr(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,i,s,a,h){return!r.queryGeometry.isAboveHorizon&&Dr(wo(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),h.angle,r.pixelToTileUnitsFactor),s)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(r){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;let e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return r!=null?e&&!r:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends Mn{constructor(r,e,i,s){super(r,{layout:kv||(kv=new Ar({visibility:new ot(Se["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ot(Se["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:Fv||(Fv=new Ar({"fill-extrusion-opacity":new ot(Se["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new gt(Se["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ot(Se["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ot(Se["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new gt(Se["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new ot(Se["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new gt(Se["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new gt(Se["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new ot(Se["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new ot(Se["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new ot(Se["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ot(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ot(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new gt(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new gt(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ot(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ot(Se["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ot(Se["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ot(Se["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new gt(Se["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new gt(Se["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new ot(Se["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Wm(r)}queryRadius(){return Pr(this.paint.get("fill-extrusion-translate"))}is3D(r){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,i,s,a,h,u,f,g){let y=Va(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),h.angle,r.pixelToTileUnitsFactor),T=this.paint.get("fill-extrusion-height").evaluate(e,i),E=this.paint.get("fill-extrusion-base").evaluate(e,i),A=[0,0],R=f&&h.elevation,L=h.elevation?h.elevation.exaggeration():1,k=r.tile.getBucket(this);if(R&&k instanceof Wm){let K=k.centroidVertexArray,pe=g+1;pe<K.length&&(A[0]=K.geta_centroid_pos0(pe),A[1]=K.geta_centroid_pos1(pe))}if(A[0]===0&&A[1]===1)return!1;h.projection.name==="globe"&&(s=Ov([s],[new Qe(0,0),new Qe(ht,ht)],r.tileID.canonical).map(K=>K.polygon).flat());let B=R?f:null,[G,X]=function(K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe){return K.projection.name==="globe"?function(Ke,it,Fe,Je,Ie,Be,at,et,Lt,St,Xe){let tt=[],It=[],xt=Ke.projection.upVectorScale(Xe,Ke.center.lat,Ke.worldSize).metersToTile,ut=[0,0,0,1],vt=[0,0,0,1],Vt=(Qt,Kt,fi,oi)=>{Qt[0]=Kt,Qt[1]=fi,Qt[2]=oi,Qt[3]=1},Zt=Dv();Fe>0&&(Fe+=Zt),Je+=Zt;for(let Qt of it){let Kt=[],fi=[];for(let oi of Qt){let ir=oi.x+Ie.x,ee=oi.y+Ie.y,te=Ke.projection.projectTilePoint(ir,ee,Xe),Oe=Ke.projection.upVector(Xe,oi.x,oi.y),lt=Fe,pt=Je;if(at){let dt=Gv(ir,ee,Fe,Je,at,et,Lt,St);lt+=dt.base,pt+=dt.top}Fe!==0?Vt(ut,te.x+Oe[0]*xt*lt,te.y+Oe[1]*xt*lt,te.z+Oe[2]*xt*lt):Vt(ut,te.x,te.y,te.z),Vt(vt,te.x+Oe[0]*xt*pt,te.y+Oe[1]*xt*pt,te.z+Oe[2]*xt*pt),Lr(ut,ut,Be),Lr(vt,vt,Be),Kt.push(new rh(ut[0],ut[1],ut[2])),fi.push(new rh(vt[0],vt[1],vt[2]))}tt.push(Kt),It.push(fi)}return[tt,It]}(K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe):Ne?function(Ke,it,Fe,Je,Ie,Be,at,et,Lt){let St=[],Xe=[],tt=[0,0,0,1];for(let It of Ke){let xt=[],ut=[];for(let vt of It){let Vt=vt.x+Je.x,Zt=vt.y+Je.y,Qt=Gv(Vt,Zt,it,Fe,Be,at,et,Lt);tt[0]=Vt,tt[1]=Zt,tt[2]=Qt.base,tt[3]=1,Kn(tt,tt,Ie),tt[3]=Math.max(tt[3],1e-5);let Kt=new rh(tt[0]/tt[3],tt[1]/tt[3],tt[2]/tt[3]);tt[0]=Vt,tt[1]=Zt,tt[2]=Qt.top,tt[3]=1,Kn(tt,tt,Ie),tt[3]=Math.max(tt[3],1e-5);let fi=new rh(tt[0]/tt[3],tt[1]/tt[3],tt[2]/tt[3]);xt.push(Kt),ut.push(fi)}St.push(xt),Xe.push(ut)}return[St,Xe]}(pe,ce,ue,ge,ve,Ne,Ee,Ue,nt):function(Ke,it,Fe,Je,Ie){let Be=[],at=[],et=Ie[8]*it,Lt=Ie[9]*it,St=Ie[10]*it,Xe=Ie[11]*it,tt=Ie[8]*Fe,It=Ie[9]*Fe,xt=Ie[10]*Fe,ut=Ie[11]*Fe;for(let vt of Ke){let Vt=[],Zt=[];for(let Qt of vt){let Kt=Qt.x+Je.x,fi=Qt.y+Je.y,oi=Ie[0]*Kt+Ie[4]*fi+Ie[12],ir=Ie[1]*Kt+Ie[5]*fi+Ie[13],ee=Ie[2]*Kt+Ie[6]*fi+Ie[14],te=Ie[3]*Kt+Ie[7]*fi+Ie[15],Oe=oi+et,lt=ir+Lt,pt=ee+St,dt=Math.max(te+Xe,1e-5),Et=oi+tt,qt=ir+It,ci=ee+xt,hi=Math.max(te+ut,1e-5);Vt.push(new rh(Oe/dt,lt/dt,pt/dt)),Zt.push(new rh(Et/hi,qt/hi,ci/hi))}Be.push(Vt),at.push(Zt)}return[Be,at]}(pe,ce,ue,ge,ve)}(h,s,E,T,y,u,B,A,L,h.center.lat,r.tileID.canonical),W=r.queryGeometry;return function(K,pe,ce){let ue=1/0;Dr(ce,pe)&&(ue=jv(ce,pe[0]));for(let ge=0;ge<pe.length;ge++){let ve=pe[ge],Ne=K[ge];for(let Ee=0;Ee<ve.length-1;Ee++){let Ue=ve[Ee],nt=[Ue,ve[Ee+1],Ne[Ee+1],Ne[Ee],Ue];$i(ce,nt)&&(ue=Math.min(ue,jv(ce,nt)))}}return ue!==1/0&&ue}(G,X,W.isPointQuery()?W.screenBounds:W.screenGeometry)}},building:class extends Mn{constructor(r,e,i,s){super(r,{layout:p1||(p1=new Ar({visibility:new ot(Se.layout_building.visibility),"building-facade":new gt(Se.layout_building["building-facade"]),"building-facade-floors":new gt(Se.layout_building["building-facade-floors"]),"building-facade-window":new gt(Se.layout_building["building-facade-window"]),"building-roof-shape":new gt(Se.layout_building["building-roof-shape"]),"building-height":new gt(Se.layout_building["building-height"]),"building-base":new gt(Se.layout_building["building-base"])})),paint:f1||(f1=new Ar({"building-opacity":new ot(Se.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new ot(Se.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new ot(Se.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new ot(Se.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new ot(Se.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new ot(Se.paint_building["building-vertical-scale"]),"building-cast-shadows":new ot(Se.paint_building["building-cast-shadows"]),"building-color":new gt(Se.paint_building["building-color"]),"building-emissive-strength":new gt(Se.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new ot(Se.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new ot(Se.paint_building["building-cutoff-fade-range"]),"building-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new d1(r)}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(r){return!0}},line:class extends Mn{constructor(r,e,i,s){let a=S1();super(r,a,e,i,s),a.layout&&(this.layout=new Ko(a.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){let e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof kc,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(jp)return jp;let i=S1();return jp=new eA(i.paint.properties["line-width"].specification),jp.useIntegerZoom=!0,jp})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new Iy(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,i){let s=w1(this);return{config:new On(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}queryRadius(r){let e=r,i=E1(un("line-width",this,e),un("line-gap-width",this,e)),s=un("line-offset",this,e);return i/2+Math.abs(s)+Pr(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,i,s,a,h){if(r.queryGeometry.isAboveHorizon)return!1;let u=wo(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),h.angle,r.pixelToTileUnitsFactor),f=r.pixelToTileUnitsFactor/2*E1(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),g=this.paint.get("line-offset").evaluate(e,i);return g&&(s=function(y,T){let E=[],A=new Qe(0,0);for(let R=0;R<y.length;R++){let L=y[R],k=[];for(let B=0;B<L.length;B++){let G=L[B],X=L[B+1],W=B===0?A:G.sub(L[B-1])._unit()._perp(),K=B===L.length-1?A:X.sub(G)._unit()._perp(),pe=W._add(K)._unit();pe._mult(1/(pe.x*K.x+pe.y*K.y)),k.push(pe._mult(T)._add(G))}E.push(k)}return E}(s,g*r.pixelToTileUnitsFactor)),function(y,T,E){for(let A=0;A<T.length;A++){let R=T[A];if(y.length>=3){for(let L=0;L<R.length;L++)if(xn(y,R[L]))return!0}if(Br(y,R,E))return!0}return!1}(u,s,f)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(r){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:y_,background:class extends Mn{constructor(r,e,i,s){super(r,{layout:_b||(_b=new Ar({visibility:new ot(Se.layout_background.visibility)})),paint:gb||(gb=new Ar({"background-pitch-alignment":new ot(Se.paint_background["background-pitch-alignment"]),"background-color":new ot(Se.paint_background["background-color"]),"background-pattern":new ot(Se.paint_background["background-pattern"]),"background-opacity":new ot(Se.paint_background["background-opacity"]),"background-emissive-strength":new ot(Se.paint_background["background-emissive-strength"]),"background-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}is3D(r){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:wb,"raster-particle":Mb,sky:class extends Mn{constructor(r,e,i,s){super(r,{layout:Eb||(Eb=new Ar({visibility:new ot(Se.layout_sky.visibility)})),paint:Ib||(Ib=new Ar({"sky-type":new ot(Se.paint_sky["sky-type"]),"sky-atmosphere-sun":new ot(Se.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ot(Se.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ot(Se.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ot(Se.paint_sky["sky-gradient-radius"]),"sky-gradient":new wl(Se.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ot(Se.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ot(Se.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ot(Se.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Ep({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){let s=this.paint.get("sky-atmosphere-sun"),a=!s,h=r.style.light,u=h.properties.get("position");return a&&h.properties.get("anchor")==="viewport"&&pi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),a?Hy(u.azimuthal,90-u.polar,e):Hy(s[0],90-s[1],e)}let i=this.paint.get("sky-gradient-center");return Hy(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends Mn{constructor(r,e,i,s){super(r,{paint:Ab||(Ab=new Ar({}))},e,null)}},model:class extends Mn{constructor(r,e,i,s){super(r,{layout:Lb||(Lb=new Ar({visibility:new ot(Se.layout_model.visibility),"model-id":new gt(Se.layout_model["model-id"])})),paint:zb||(zb=new Ar({"model-opacity":new gt(Se.paint_model["model-opacity"]),"model-rotation":new gt(Se.paint_model["model-rotation"]),"model-scale":new gt(Se.paint_model["model-scale"]),"model-translation":new gt(Se.paint_model["model-translation"]),"model-color":new gt(Se.paint_model["model-color"]),"model-color-mix-intensity":new gt(Se.paint_model["model-color-mix-intensity"]),"model-type":new ot(Se.paint_model["model-type"]),"model-cast-shadows":new ot(Se.paint_model["model-cast-shadows"]),"model-receive-shadows":new ot(Se.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ot(Se.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new gt(Se.paint_model["model-emissive-strength"]),"model-roughness":new gt(Se.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new gt(Se.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ot(Se.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new ot(Se.paint_model["model-front-cutoff"]),"model-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Zy(r)}getProgramIds(){return["model"]}is3D(r){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof w_?ht-1:0}queryIntersectsFeature(r,e,i,s,a,h){if(!this.modelManager)return!1;let u=this.modelManager,f=r.tile.getBucket(this);if(!(f&&f instanceof Zy))return!1;for(let g in f.instancesPerModel){let y=f.instancesPerModel[g],T=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(y.idToFeaturesIndex.hasOwnProperty(T)){let E=y.features[y.idToFeaturesIndex[T]],A=u.getModel(g,this.scope);if(!A)return!1;let R=Ae(),L=new C(0,0),k=f.canonical,B=Number.MAX_VALUE;for(let G=0;G<E.instancedDataCount;++G){let X=16*(E.instancedDataOffset+G),W=y.instancedDataArray.float32,K=[W[X+4],W[X+5],W[X+6]];Bb(k,L,W[X],0|W[X+1]),o1(R,A,h,L,E.rotation,E.scale,K,!1,!1,!1),h.projection.name==="globe"&&(R=by(R,h));let pe=Te([],h.projMatrix,R),ce=r.queryGeometry,ue=n1(ce.isPointQuery()?ce.screenBounds:ce.screenGeometry,h,pe,A.aabb);ue!=null&&(B=Math.min(ue,B))}return B!==Number.MAX_VALUE&&B}}return!1}_handleOverridablePaintPropertyUpdate(r,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){let e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof ia}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Mn{constructor(r,e,i,s){super(r,{layout:fv||(fv=new Ar({"clip-layer-types":new ot(Se.layout_clip["clip-layer-types"]),"clip-layer-scope":new ot(Se.layout_clip["clip-layer-scope"])})),paint:mv||(mv=new Ar({}))},e,i,s)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new _v(r)}is3D(r){return!0}}},Xy=new ki(0,0,0),Yy={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},Ky={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},T_={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},rM={PAINT_ORDER_FILL_AND_STROKE:1},tf={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},Nb={MASK_TYPE_LUMINANCE:1};function nM(r,e,i){r===1&&e.icons.push(function(s,a){return function(h){if(h.usvg_tree.height||(h.usvg_tree.height=h.usvg_tree.width),!h.metadata)return h;let{metadata:u}=h;if(u.content_area){let{content_area:f}=u;f.top==null&&(f.top=f.left),f.width==null&&(f.width=h.usvg_tree.width),f.height==null&&(f.height=f.width)}return u.stretch_x&&u.stretch_x.length&&Vb(u,"x"),u.stretch_y&&u.stretch_y.length&&Vb(u,"y"),h}(s.readFields(oM,{name:void 0},a))}(i,i.readVarint()+i.pos))}function Vb(r,e){let i=[],s=r[`stretch_${e}`],a=null;for(let h=0;h<s.length;h++)a===null?a=i.length===0?s[0]:i[i.length-1][1]+s[h]:(i.push([a,a+s[h]]),a=null);r[`stretch_${e}_areas`]=i}function oM(r,e,i){r===1?e.name=i.readString():r===2?e.metadata=function(s,a){return s.readFields(sM,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},a)}(i,i.readVarint()+i.pos):r===3&&(e.usvg_tree=function(s,a){return s.readFields(cM,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},a)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function sM(r,e,i){r===1?e.stretch_x=i.readPackedVarint():r===2?e.stretch_y=i.readPackedVarint():r===3?e.content_area=function(s,a){return s.readFields(aM,{left:0},a)}(i,i.readVarint()+i.pos):r===4&&e.variables.push(function(s,a){return s.readFields(lM,{name:void 0},a)}(i,i.readVarint()+i.pos))}function aM(r,e,i){r===1?e.left=i.readVarint():r===2?e.width=i.readVarint():r===3?e.top=i.readVarint():r===4&&(e.height=i.readVarint())}function lM(r,e,i){r===1?e.name=i.readString():r===2&&(e.rgb_color=I_(i.readVarint()),e.value="rgb_color")}function cM(r,e,i){r===1?e.width=e.height=i.readVarint():r===2?e.height=i.readVarint():r===3?e.children.push(S_(i,i.readVarint()+i.pos)):r===4?e.linear_gradients.push(function(s,a){return s.readFields(_M,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},a)}(i,i.readVarint()+i.pos)):r===5?e.radial_gradients.push(function(s,a){return s.readFields(yM,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},a)}(i,i.readVarint()+i.pos)):r===7?e.clip_paths.push(function(s,a){return s.readFields(xM,{children:[]},a)}(i,i.readVarint()+i.pos)):r===8&&e.masks.push(function(s,a){let h=s.readFields(vM,{left:0,width:20,mask_type:Nb.MASK_TYPE_LUMINANCE,children:[]},a);return h.height==null&&(h.height=h.width),h.top==null&&(h.top=h.left),h}(i,i.readVarint()+i.pos))}function S_(r,e){return r.readFields(hM,{},e)}function hM(r,e,i){r===1?(e.group=function(s,a){return s.readFields(uM,{opacity:255,children:[]},a)}(i,i.readVarint()+i.pos),e.node="group"):r===2&&(e.path=function(s,a){return s.readFields(pM,{paint_order:1,commands:[],step:1,diffs:[],rule:Yy.PATH_RULE_NON_ZERO},a)}(i,i.readVarint()+i.pos),e.node="path")}function uM(r,e,i){r===1?e.transform=E_(i,i.readVarint()+i.pos):r===2?e.opacity=i.readVarint():r===5?e.clip_path_idx=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(S_(i,i.readVarint()+i.pos))}function E_(r,e){return r.readFields(dM,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function dM(r,e,i){r===1?e.sx=i.readFloat():r===2?e.ky=i.readFloat():r===3?e.kx=i.readFloat():r===4?e.sy=i.readFloat():r===5?e.tx=i.readFloat():r===6&&(e.ty=i.readFloat())}function pM(r,e,i){r===1?e.fill=function(s,a){return s.readFields(fM,{rgb_color:Xy,paint:"rgb_color",opacity:255},a)}(i,i.readVarint()+i.pos):r===2?e.stroke=function(s,a){return s.readFields(mM,{rgb_color:Xy,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},a)}(i,i.readVarint()+i.pos):r===3?e.paint_order=i.readVarint():r===5?i.readPackedVarint(e.commands):r===6?e.step=i.readFloat():r===7?i.readPackedSVarint(e.diffs):r===8&&(e.rule=i.readVarint())}function fM(r,e,i){r===1?(e.rgb_color=I_(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=i.readVarint())}function I_(r){return new ki((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function mM(r,e,i){r===1?(e.rgb_color=I_(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5?i.readPackedFloat(e.dasharray):r===6?e.dashoffset=i.readFloat():r===7?e.miterlimit=i.readFloat():r===8?e.opacity=i.readVarint():r===9?e.width=i.readFloat():r===10?e.linecap=i.readVarint():r===11&&(e.linejoin=i.readVarint())}function _M(r,e,i){r===1?e.transform=E_(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(Ub(i,i.readVarint()+i.pos)):r===4?e.x1=i.readFloat():r===5?e.y1=i.readFloat():r===6?e.x2=i.readFloat():r===7&&(e.y2=i.readFloat())}function Ub(r,e){return r.readFields(gM,{offset:0,opacity:255,rgb_color:Xy},e)}function gM(r,e,i){r===1?e.offset=i.readFloat():r===2?e.opacity=i.readVarint():r===3&&(e.rgb_color=I_(i.readVarint()))}function yM(r,e,i){r===1?e.transform=E_(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(Ub(i,i.readVarint()+i.pos)):r===4?e.cx=i.readFloat():r===5?e.cy=i.readFloat():r===6?e.r=i.readFloat():r===7?e.fx=i.readFloat():r===8?e.fy=i.readFloat():r===9&&(e.fr=i.readFloat())}function xM(r,e,i){r===1?e.transform=E_(i,i.readVarint()+i.pos):r===2?e.clip_path_idx=i.readVarint():r===3&&e.children.push(S_(i,i.readVarint()+i.pos))}function vM(r,e,i){r===1?e.left=e.top=i.readFloat():r===2?e.width=e.height=i.readFloat():r===3?e.top=i.readFloat():r===4?e.height=i.readFloat():r===5?e.mask_type=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(S_(i,i.readVarint()+i.pos))}class bM{static calculate(e={},i=[]){let s=new Map,a=new Map;if(Object.keys(e).length===0)return s;i.forEach(h=>{a.set(h.name,h.rgb_color||new ki(0,0,0))});for(let[h,u]of Object.entries(e))a.has(h)?s.set(a.get(h).toString(),u):console.warn(`Ignoring unknown image variable "${h}"`);return s}}function Vu(r,e=255,i){let s=e/255,a=r.toString(),h=i.has(a)?i.get(a).clone():r.clone();return h.a*=s,h.toString()}function rf(r,e){if(!Mh()){let i=document.createElement("canvas");return i.width=r,i.height=e,i}return new OffscreenCanvas(r,e)}function wM(r,e){let i=bM.calculate(e.params,r.metadata?r.metadata.variables:[]),s=r.usvg_tree,a=s.width,h=s.height,u=e.transform?e.transform:new DOMMatrix,f=Math.max(1,Math.round(a*u.a)),g=Math.max(1,Math.round(h*u.d)),y=new DOMMatrix([f/a,0,0,g/h,0,0]),T=rf(f,g).getContext("2d");return Jy(T,y,s,s,i),T.getImageData(0,0,f,g)}function Jy(r,e,i,s,a){for(let h of s.children)jb(r,e,i,h,a)}function jb(r,e,i,s,a){s.group?(r.save(),function(h,u,f,g,y){let T=g.mask_idx!=null?f.masks[g.mask_idx]:null,E=g.clip_path_idx!=null?f.clip_paths[g.clip_path_idx]:null;if(g.transform&&(u=Uu(g.transform).preMultiplySelf(u)),!function(L,k,B){return L.opacity!==255||k||B}(g,E!=null,T!=null))return void Jy(h,u,f,g,y);let A=rf(h.canvas.width,h.canvas.height),R=A.getContext("2d");Jy(R,u,f,g,y),E&&Xb(R,u,f,E),T&&Yb(R,u,f,T,y),h.globalAlpha=g.opacity/255,h.drawImage(A,0,0)}(r,e,i,s.group,a),r.restore()):s.path&&(r.save(),function(h,u,f,g,y){h.setTransform(u),g.paint_order===rM.PAINT_ORDER_FILL_AND_STROKE?(Gb(h,f,g,y),Hb(h,f,g,y)):(Hb(h,f,g,y),Gb(h,f,g,y))}(r,e,i,s.path,a),r.restore())}function Gb(r,e,i,s){let a=i.fill;if(!a)return;let h=a.opacity/255;switch(r.save(),r.beginPath(),Kb(i,r),a.paint){case"rgb_color":r.fillStyle=Vu(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":{let u=e.linear_gradients[a.linear_gradient_idx];u.transform&&r.setTransform(Uu(u.transform).preMultiplySelf(r.getTransform())),r.fillStyle=$b(r,u,h,s);break}case"radial_gradient_idx":{let u=e.radial_gradients[a.radial_gradient_idx];u.transform&&r.setTransform(Uu(u.transform).preMultiplySelf(r.getTransform())),r.fillStyle=Zb(r,u,h,s)}}r.fill(qb(i)),r.restore()}function qb(r){return r.rule===Yy.PATH_RULE_NON_ZERO?"nonzero":r.rule===Yy.PATH_RULE_EVEN_ODD?"evenodd":void 0}function Hb(r,e,i,s){let a=i.stroke;if(!a)return;let h=Jb(i);r.lineWidth=a.width,r.miterLimit=a.miterlimit,r.setLineDash(a.dasharray),r.lineDashOffset=a.dashoffset;let u=a.opacity/255;switch(a.paint){case"rgb_color":r.strokeStyle=Vu(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":r.strokeStyle=$b(r,e.linear_gradients[a.linear_gradient_idx],u,s,!0);break;case"radial_gradient_idx":r.strokeStyle=Zb(r,e.radial_gradients[a.radial_gradient_idx],u,s,!0)}switch(a.linejoin){case T_.LINE_JOIN_MITER_CLIP:case T_.LINE_JOIN_MITER:r.lineJoin="miter";break;case T_.LINE_JOIN_ROUND:r.lineJoin="round";break;case T_.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(a.linecap){case Ky.LINE_CAP_BUTT:r.lineCap="butt";break;case Ky.LINE_CAP_ROUND:r.lineCap="round";break;case Ky.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(h)}function $b(r,e,i,s,a=!1){if(e.stops.length===1){let A=e.stops[0];return Vu(A.rgb_color,A.opacity*i,s)}let{x1:h,y1:u,x2:f,y2:g}=e,y=new DOMPoint(h,u),T=new DOMPoint(f,g);if(a){let A=Uu(e.transform);y=A.transformPoint(y),T=A.transformPoint(T)}let E=r.createLinearGradient(y.x,y.y,T.x,T.y);for(let A of e.stops)E.addColorStop(A.offset,Vu(A.rgb_color,A.opacity*i,s));return E}function Zb(r,e,i,s,a=!1){if(e.stops.length===1){let G=e.stops[0];return Vu(G.rgb_color,G.opacity*i,s)}let h=Uu(e.transform),{fx:u,fy:f,fr:g,cx:y,cy:T,r:E}=e,A=new DOMPoint(u,f),R=new DOMPoint(y,T),L=g,k=E;if(a){A=h.transformPoint(A),R=h.transformPoint(R);let G=(h.a+h.d)/2;L=g*G,k=e.r*G}let B=r.createRadialGradient(A.x,A.y,L,R.x,R.y,k);for(let G of e.stops)B.addColorStop(G.offset,Vu(G.rgb_color,G.opacity*i,s));return B}function Wb(r,e,i,s){let a=s.transform?Uu(s.transform).preMultiplySelf(e):e,h=rf(r.canvas.width,r.canvas.height),u=h.getContext("2d");for(let g of s.children)if(g.group)Wb(u,a,i,g.group);else if(g.path){let y=g.path,T=new Path2D;T.addPath(Jb(y),a),u.fill(T,qb(y))}let f=s.clip_path_idx!=null?i.clip_paths[s.clip_path_idx]:null;f&&Xb(u,a,i,f),r.globalCompositeOperation="source-over",r.drawImage(h,0,0)}function Xb(r,e,i,s){let a=rf(r.canvas.width,r.canvas.height);Wb(a.getContext("2d"),e,i,s),r.globalCompositeOperation="destination-in",r.drawImage(a,0,0)}function Yb(r,e,i,s,a){if(s.children.length===0)return;let h=s.mask_idx!=null?i.masks[s.mask_idx]:null;h&&Yb(r,e,i,h,a);let u=r.canvas.width,f=r.canvas.height,g=rf(u,f),y=g.getContext("2d"),T=s.width,E=s.height,A=s.left,R=s.top,L=new Path2D,k=new Path2D;k.rect(A,R,T,E),L.addPath(k,e),y.clip(L);for(let X of s.children)jb(y,e,i,X,a);let B=y.getImageData(0,0,u,f),G=B.data;if(s.mask_type===Nb.MASK_TYPE_LUMINANCE)for(let X=0;X<G.length;X+=4)G[X+3]=G[X+3]/255*(.2126*G[X]+.7152*G[X+1]+.0722*G[X+2]);y.putImageData(B,0,0),r.globalCompositeOperation="destination-in",r.drawImage(g,0,0)}function Uu(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function Kb(r,e){let i=r.step,s=r.diffs[0]*i,a=r.diffs[1]*i;e.moveTo(s,a);for(let h=0,u=2;h<r.commands.length;h++)switch(r.commands[h]){case tf.PATH_COMMAND_MOVE:s+=r.diffs[u++]*i,a+=r.diffs[u++]*i,e.moveTo(s,a);break;case tf.PATH_COMMAND_LINE:s+=r.diffs[u++]*i,a+=r.diffs[u++]*i,e.lineTo(s,a);break;case tf.PATH_COMMAND_QUAD:{let f=s+r.diffs[u++]*i,g=a+r.diffs[u++]*i;s=f+r.diffs[u++]*i,a=g+r.diffs[u++]*i,e.quadraticCurveTo(f,g,s,a);break}case tf.PATH_COMMAND_CUBIC:{let f=s+r.diffs[u++]*i,g=a+r.diffs[u++]*i,y=f+r.diffs[u++]*i,T=g+r.diffs[u++]*i;s=y+r.diffs[u++]*i,a=T+r.diffs[u++]*i,e.bezierCurveTo(f,g,y,T,s,a);break}case tf.PATH_COMMAND_CLOSE:e.closePath()}return e}function Jb(r){return Kb(r,new Path2D)}class A_{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}Tt(A_,"LRUCache");class Qy{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new vn(e,e.data)}getFromCache(e,i,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new A_(150)),this.cacheMap.get(s).get(El(e.toString(),i))}setInCache(e,i,s,a){this.cacheDependenciesMap.has(a)||this.cacheDependenciesMap.set(a,new Map),this.cacheMap.has(a)||this.cacheMap.set(a,new A_(150));let h=this.cacheDependenciesMap.get(a),u=El(e.id.toString(),s);h.get(u)||h.set(u,new Set);let f=this.cacheMap.get(a),g=e.toString();h.get(u).add(g),f.put(El(e.toString(),s),i)}removeImagesFromCacheByIds(e,i,s=0){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;let a=this.cacheMap.get(s),h=this.cacheDependenciesMap.get(s);for(let u of e){let f=El(u.toString(),i);if(h.has(f)){for(let g of h.get(f))a.delete(g);h.delete(f)}}}rasterize(e,i,s,a,h=wM){let u=this.getFromCache(e,s,a);if(u)return u.clone();let f=h(i.icon,e.options),g=Qy._getImage(f);return this.setInCache(e,g,s,a),g.clone()}}class Qb{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){let s=this.toIdx(e,i);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function ew(r,e,i,s){let a=0,h=Number.MAX_VALUE;for(let u=0;u<3;u++)if(Math.abs(s[u])<1e-15){if(i[u]<r[u]||i[u]>e[u])return null}else{let f=1/s[u],g=(r[u]-i[u])*f,y=(e[u]-i[u])*f;if(g>y){let T=g;g=y,y=T}if(g>a&&(a=g),y<h&&(h=y),a>h)return null}return a}function tw(r,e,i,s,a,h,u,f,g,y,T){let E=s-r,A=a-e,R=h-i,L=u-r,k=f-e,B=g-i,G=T[1]*B-T[2]*k,X=T[2]*L-T[0]*B,W=T[0]*k-T[1]*L,K=E*G+A*X+R*W;if(Math.abs(K)<1e-15)return null;let pe=1/K,ce=y[0]-r,ue=y[1]-e,ge=y[2]-i,ve=(ce*G+ue*X+ge*W)*pe;if(ve<0||ve>1)return null;let Ne=ue*R-ge*A,Ee=ge*E-ce*R,Ue=ce*A-ue*E,nt=(T[0]*Ne+T[1]*Ee+T[2]*Ue)*pe;return nt<0||ve+nt>1?null:(L*Ne+k*Ee+B*Ue)*pe}function iw(r,e,i){return(r-e)/(i-e)}function rw(r,e,i,s,a,h,u,f,g){let y=1<<i,T=h-s,E=u-a,A=(r+1)/y*T+s,R=(e+0)/y*E+a,L=(e+1)/y*E+a;f[0]=(r+0)/y*T+s,f[1]=R,g[0]=A,g[1]=L}class nw{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let i=function(h){let u=Math.ceil(Math.log2(h.dim/8)),f=[],g=Math.ceil(Math.pow(2,u)),y=1/g,T=(R,L,k,B,G)=>{let X=B?1:0,W=(R+1)*k-X,K=L*k,pe=(L+1)*k-X;G[0]=R*k,G[1]=K,G[2]=W,G[3]=pe},E=new Qb(g),A=[];for(let R=0;R<g*g;R++){T(R%g,Math.floor(R/g),y,!1,A);let L=Hl(A[0],A[1],h),k=Hl(A[2],A[1],h),B=Hl(A[2],A[3],h),G=Hl(A[0],A[3],h);E.minimums.push(Math.min(L,k,B,G)),E.maximums.push(Math.max(L,k,B,G)),E.leaves.push(1)}for(f.push(E),g/=2;g>=1;g/=2){let R=f[f.length-1];E=new Qb(g);for(let L=0;L<g*g;L++){T(L%g,Math.floor(L/g),2,!0,A);let k=R.getElevation(A[0],A[1]),B=R.getElevation(A[2],A[1]),G=R.getElevation(A[2],A[3]),X=R.getElevation(A[0],A[3]),W=R.isLeaf(A[0],A[1]),K=R.isLeaf(A[2],A[1]),pe=R.isLeaf(A[2],A[3]),ce=R.isLeaf(A[0],A[3]),ue=Math.min(k.min,B.min,G.min,X.min),ge=Math.max(k.max,B.max,G.max,X.max),ve=W&&K&&pe&&ce;E.maximums.push(ge),E.minimums.push(ue),E.leaves.push(ge-ue<=5&&ve?1:0)}f.push(E)}return f}(this.dem),s=i.length-1,a=i[s];this._addNode(a.minimums[0],a.maximums[0],a.leaves[0]),this._construct(i,0,0,s,0)}raycastRoot(e,i,s,a,h,u,f=1){return ew([e,i,-100],[s,a,this.maximums[0]*f],h,u)}raycast(e,i,s,a,h,u,f=1){if(!this.nodeCount)return null;let g=this.raycastRoot(e,i,s,a,h,u,f);if(g==null)return null;let y=[],T=[],E=[],A=[],R=[{idx:0,t:g,nodex:0,nodey:0,depth:0}];for(;R.length>0;){let{idx:L,t:k,nodex:B,nodey:G,depth:X}=R.pop();if(this.leaves[L]){rw(B,G,X,e,i,s,a,E,A);let K=1<<X,pe=(B+0)/K,ce=(B+1)/K,ue=(G+0)/K,ge=(G+1)/K,ve=Hl(pe,ue,this.dem)*f,Ne=Hl(ce,ue,this.dem)*f,Ee=Hl(ce,ge,this.dem)*f,Ue=Hl(pe,ge,this.dem)*f,nt=tw(E[0],E[1],ve,A[0],E[1],Ne,A[0],A[1],Ee,h,u),qe=tw(A[0],A[1],Ee,E[0],A[1],Ue,E[0],E[1],ve,h,u),Ke=Math.min(nt!==null?nt:Number.MAX_VALUE,qe!==null?qe:Number.MAX_VALUE);if(Ke!==Number.MAX_VALUE)return Ke;{let it=tn([],h,u,k);if(ow(ve,Ne,Ue,Ee,iw(it[0],E[0],A[0]),iw(it[1],E[1],A[1]))>=it[2])return k}continue}let W=0;for(let K=0;K<this._siblingOffset.length;K++){rw((B<<1)+this._siblingOffset[K][0],(G<<1)+this._siblingOffset[K][1],X+1,e,i,s,a,E,A),E[2]=-100,A[2]=this.maximums[this.childOffsets[L]+K]*f;let pe=ew(E,A,h,u);if(pe!=null){let ce=pe;y[K]=ce;let ue=!1;for(let ge=0;ge<W&&!ue;ge++)ce>=y[T[ge]]&&(T.splice(ge,0,K),ue=!0);ue||(T[W]=K),W++}}for(let K=0;K<W;K++){let pe=T[K];R.push({idx:this.childOffsets[L]+pe,t:y[pe],nodex:(B<<1)+this._siblingOffset[pe][0],nodey:(G<<1)+this._siblingOffset[pe][1],depth:X+1})}}return null}_addNode(e,i,s){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,s,a,h){if(e[a].isLeaf(i,s)===1)return;this.childOffsets[h]||(this.childOffsets[h]=this.nodeCount);let u=a-1,f=e[u],g=0,y=0;for(let T=0;T<this._siblingOffset.length;T++){let E=2*i+this._siblingOffset[T][0],A=2*s+this._siblingOffset[T][1],R=f.getElevation(E,A),L=f.isLeaf(E,A),k=this._addNode(R.min,R.max,L);L&&(g|=1<<T),y||(y=k)}for(let T=0;T<this._siblingOffset.length;T++)g&1<<T||this._construct(e,2*i+this._siblingOffset[T][0],2*s+this._siblingOffset[T][1],u,y+T)}}function ow(r,e,i,s,a,h){return Bt(Bt(r,i,h),Bt(e,s,h),a)}function Hl(r,e,i){let s=i.dim,a=re(r*s-.5,0,s-1),h=re(e*s-.5,0,s-1),u=Math.floor(a),f=Math.floor(h),g=Math.min(u+1,s-1),y=Math.min(f+1,s-1);return ow(i.get(u,f),i.get(g,f),i.get(u,y),i.get(g,y),a-u,h-f)}let TM={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function SM(r,e,i){return(256*r*256+256*e+i)/10-1e4}function EM(r,e,i){return 256*r+e+i/256-32768}class M_{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,s,a=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return void pi(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;let h=this.dim=i.height-2,u=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=a,this._modifiedForSources={},!a){for(let g=0;g<h;g++)u[this._idx(-1,g)]=u[this._idx(0,g)],u[this._idx(h,g)]=u[this._idx(h-1,g)],u[this._idx(g,-1)]=u[this._idx(g,0)],u[this._idx(g,h)]=u[this._idx(g,h-1)];u[this._idx(-1,-1)]=u[this._idx(0,0)],u[this._idx(h,-1)]=u[this._idx(h-1,0)],u[this._idx(-1,h)]=u[this._idx(0,h-1)],u[this._idx(h,h)]=u[this._idx(h-1,h-1)]}let f=s==="terrarium"?EM:SM;for(let g=0;g<u.length;++g){let y=4*g;this.floatView[g]=f(this.pixels[y],this.pixels[y+1],this.pixels[y+2])}this._timestamp=Wo.now()}_buildQuadTree(){this._tree=new nw(this)}get(e,i,s=!1){s&&(e=re(e,-1,this.dim),i=re(i,-1,this.dim));let a=this._idx(e,i);return this.floatView[a]}set(e,i,s){let a=this._idx(e,i),h=this.floatView[a];return this.floatView[a]=s,s-h}static getUnpackVector(e){return TM[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){let s=[0,0,0,0],a=M_.getUnpackVector(i),h=Math.floor((e+a[3])/a[2]);return s[2]=h%256,h=Math.floor(h/256),s[1]=h%256,h=Math.floor(h/256),s[0]=h,s}getPixels(){return new ev({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=i*this.dim,h=i*this.dim+this.dim,u=s*this.dim,f=s*this.dim+this.dim;switch(i){case-1:a=h-1;break;case 1:h=a+1}switch(s){case-1:u=f-1;break;case 1:f=u+1}let g=-i*this.dim,y=-s*this.dim;for(let T=u;T<f;T++)for(let E=a;E<h;E++){let A=4*this._idx(E,T),R=4*this._idx(E+g,T+y);this.pixels[A+0]=e.pixels[R+0],this.pixels[A+1]=e.pixels[R+1],this.pixels[A+2]=e.pixels[R+2],this.pixels[A+3]=e.pixels[R+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function IM(r,e,i){r===1?e.headerLength=i.readFixed32():r===2?e.x=i.readVarint():r===3?e.y=i.readVarint():r===4?e.z=i.readVarint():r===5&&e.layers.push(function(s,a){return s.readFields(RM,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},a)}(i,i.readVarint()+i.pos))}function AM(r,e,i){r===1?(e.delta_filter=function(s,a){return s.readFields(MM,{blockSize:0},a)}(i,i.readVarint()+i.pos),e.filter="delta_filter"):r===2?(i.readVarint(),e.filter="zigzag_filter"):r===3?(i.readVarint(),e.filter="bitshuffle_filter"):r===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function MM(r,e,i){r===1&&(e.blockSize=i.readVarint())}function CM(r,e,i){r===1?(i.readVarint(),e.codec="gzip_data"):r===2?(i.readVarint(),e.codec="jpeg_image"):r===3?(i.readVarint(),e.codec="webp_image"):r===4&&(i.readVarint(),e.codec="png_image")}function PM(r,e,i){let s=0,a=0;r===1?e.firstByte=i.readFixed64():r===2?e.lastByte=i.readFixed64():r===3?e.filters.push(function(h,u){return h.readFields(AM,{},u)}(i,i.readVarint()+i.pos)):r===4?e.codec=function(h,u){return h.readFields(CM,{},u)}(i,i.readVarint()+i.pos):r===5?a=i.readFloat():r===6?s=i.readFloat():r===7?e.bands.push(i.readString()):r===8?e.offset=i.readDouble():r===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=a),e.scale===0&&(e.scale=s)}function RM(r,e,i){r===1?e.version=i.readVarint():r===2?e.name=i.readString():r===3?e.units=i.readString():r===4?e.tileSize=i.readVarint():r===5?e.buffer=i.readVarint():r===6?e.pixelFormat=i.readVarint():r===7&&e.dataIndex.push(function(s,a){return s.readFields(PM,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},a)}(i,i.readVarint()+i.pos))}function LM(r,e,i){if(r===2)(function(s,a,h){s.readFields(zM,h,a)})(i,i.readVarint()+i.pos,e);else if(r===3)throw new Error("Not implemented")}function zM(r,e,i){if(r===1){let s=0,a=i.readVarint()+i.pos;for(;i.pos<a;)e[s++]=i.readVarint()}}function DM(r,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let s=2;s>=1;s--){let a=s===1?1:0,h=s===2?1:0;for(let u=0;u<e[0];u++){let f=e[1]*u;for(let g=a;g<e[1];g++){let y=e[2]*(g+f);for(let T=h;T<e[2];T++){let E=e[3]*(T+y);for(let A=0;A<e[3];A++){let R=E+A;r[R]+=r[R-i]}}}}i*=e[s]}return r}function OM(r){for(let e=0,i=r.length;e<i;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function kM(r,e){switch(e){case"uint32":return r;case"uint16":for(let i=0;i<r.length;i+=2){let s=r[i],a=r[i+1];r[i]=(240&s)>>4|(61440&s)>>8|(240&a)<<4|61440&a,r[i+1]=15&s|(3840&s)>>4|(15&a)<<8|(3840&a)<<4}return r;case"uint8":for(let i=0;i<r.length;i+=4){let s=r[i],a=r[i+1],h=r[i+2],u=r[i+3];r[i+0]=(192&s)>>6|(192&a)>>4|(192&h)>>2|192&u,r[i+1]=(48&s)>>4|(48&a)>>2|48&h|(48&u)<<2,r[i+2]=(12&s)>>2|12&a|(12&h)<<2|(12&u)<<4,r[i+3]=3&s|(3&a)<<2|(3&h)<<4|(3&u)<<6}return r;default:throw new Error(`Invalid pixel format, "${e}"`)}}Tt(M_,"DEMData"),Tt(nw,"DemMinMaxQuadTree",{omit:["dem"]});var Qo=Uint8Array,nf=Uint16Array,FM=Int32Array,sw=new Qo([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),aw=new Qo([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),BM=new Qo([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),lw=function(r,e){for(var i=new nf(31),s=0;s<31;++s)i[s]=e+=1<<r[s-1];var a=new FM(i[30]);for(s=1;s<30;++s)for(var h=i[s];h<i[s+1];++h)a[h]=h-i[s]<<5|s;return{b:i,r:a}},cw=lw(sw,2),hw=cw.b,NM=cw.r;hw[28]=258,NM[258]=28;for(var VM=lw(aw,0).b,uw=new nf(32768),en=0;en<32768;++en){var ju=(43690&en)>>1|(21845&en)<<1;uw[en]=((65280&(ju=(61680&(ju=(52428&ju)>>2|(13107&ju)<<2))>>4|(3855&ju)<<4))>>8|(255&ju)<<8)>>1}var of=function(r,e,i){for(var s=r.length,a=0,h=new nf(e);a<s;++a)r[a]&&++h[r[a]-1];var u,f=new nf(e);for(a=1;a<e;++a)f[a]=f[a-1]+h[a-1]<<1;u=new nf(1<<e);var g=15-e;for(a=0;a<s;++a)if(r[a])for(var y=a<<4|r[a],T=e-r[a],E=f[r[a]-1]++<<T,A=E|(1<<T)-1;E<=A;++E)u[uw[E]>>g]=y;return u},sf=new Qo(288);for(en=0;en<144;++en)sf[en]=8;for(en=144;en<256;++en)sf[en]=9;for(en=256;en<280;++en)sf[en]=7;for(en=280;en<288;++en)sf[en]=8;var dw=new Qo(32);for(en=0;en<32;++en)dw[en]=5;var UM=of(sf,9),jM=of(dw,5),e0=function(r){for(var e=r[0],i=1;i<r.length;++i)r[i]>e&&(e=r[i]);return e},Os=function(r,e,i){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(7&e)&i},t0=function(r,e){var i=e/8|0;return(r[i]|r[i+1]<<8|r[i+2]<<16)>>(7&e)},GM=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],ks=function(r,e,i){var s=new Error(e||GM[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,ks),!i)throw s;return s},qM=new Qo(0),HM=typeof TextDecoder<"u"&&new TextDecoder;try{HM.decode(qM,{stream:!0})}catch{}let $M={gzip_data:"gzip"};class ds extends Error{constructor(e){super(e),this.name="MRTError"}}let ZM={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},pw={uint32:1,uint16:2,uint8:4},WM={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},i0;class C_{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){let i=this.layers[e];if(!i)throw new ds(`Layer '${e}' not found`);return i}getHeaderLength(e){let i=new Uint8Array(e),s=new DataView(e);if(i[0]!==13)throw new ds("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){let i=new Uint8Array(e),s=this.getHeaderLength(e);if(i.length<s)throw new ds(`Expected header with length >= ${s} but got buffer of length ${i.length}`);let a=new i0(i.subarray(0,s)).readFields(IM,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==a.x||this.y!==a.y||this.z!==a.z))throw new ds(`Invalid attempt to parse header ${a.z}/${a.x}/${a.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=a.x,this.y=a.y,this.z=a.z;for(let h of a.layers)this.layers[h.name]=new fw(h,{cacheSize:this._cacheSize});return this}createDecodingTask(e){let i=[],s=this.getLayer(e.layerName);for(let a of e.blockIndices){let h=s.dataIndex[a],u=h.firstByte-e.firstByte,f=h.lastByte-e.firstByte;if(s._blocksInProgress.has(a))continue;let g={layerName:s.name,firstByte:u,lastByte:f,pixelFormat:s.pixelFormat,blockIndex:a,blockShape:[h.bands.length].concat(s.bandShape),buffer:s.buffer,codec:h.codec.codec,filters:h.filters.map(y=>y.filter)};s._blocksInProgress.add(a),i.push(g)}return new mw(i,()=>{i.forEach(a=>s._blocksInProgress.delete(a.blockIndex))},(a,h)=>{if(i.forEach(u=>s._blocksInProgress.delete(u.blockIndex)),a)throw a;h.forEach(u=>{this.getLayer(u.layerName).processDecodedData(u)})})}}class fw{constructor({version:e,name:i,units:s,tileSize:a,pixelFormat:h,buffer:u,dataIndex:f},g){if(this.version=e,this.version!==1)throw new ds(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=s,this.tileSize=a,this.buffer=u,this.pixelFormat=ZM[h],this.dataIndex=f,this.bandShape=[a+2*u,a+2*u,pw[this.pixelFormat]],this._decodedBlocks=new A_(g?g.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return pw[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){let i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(let[s,a]of this.dataIndex.entries()){for(let[h,u]of a.bands.entries())if(u===e)return{bandIndex:i+h,blockIndex:s,blockBandIndex:h};i+=a.bands.length}break;case"number":for(let[s,a]of this.dataIndex.entries()){if(e>=i&&e<i+a.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-i};i+=a.bands.length}break;default:throw new ds(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,s=-1/0,a=[],h=new Set;for(let u of e){let{blockIndex:f}=this.getBlockForBand(u);if(f<0)throw new ds(`Invalid band: ${JSON.stringify(u)}`);let g=this.dataIndex[f];a.includes(f)||a.push(f),h.add(f),i=Math.min(i,g.firstByte),s=Math.max(s,g.lastByte)}if(h.size>this.cacheSize)throw new ds(`Number of blocks to decode (${h.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:s,blockIndices:a}}hasBand(e){let{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){let{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){let{blockIndex:i,blockBandIndex:s}=this.getBlockForBand(e);if(i<0)throw new ds(`Band not found: ${JSON.stringify(e)}`);let a=this._decodedBlocks.get(i.toString());if(!a)throw new ds(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);let h=this.dataIndex[i],u=this.bandShape.reduce((y,T)=>y*T,1),f=s*u,g=a.subarray(f,f+u);return{data:g,bytes:new Uint8Array(g.buffer).subarray(g.byteOffset,g.byteOffset+g.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:h.offset,scale:h.scale}}}C_.setPbf=function(r){i0=r};class mw{constructor(e,i,s){this.tasks=e,this._onCancel=i,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}C_.performDecoding=function(r,e){let i=new Uint8Array(r);return Promise.all(e.tasks.map(s=>{let{layerName:a,firstByte:h,lastByte:u,pixelFormat:f,blockShape:g,blockIndex:y,filters:T,codec:E}=s,A=i.subarray(h,u+1),R=new Uint32Array(g[0]*g[1]*g[2]),L;if(E!=="gzip_data")throw new ds(`Unhandled codec: ${E}`);return L=function(k,B){if(!globalThis.DecompressionStream&&B==="gzip_data")return Promise.resolve(((K=function(ue){ue[0]==31&&ue[1]==139&&ue[2]==8||ks(6,"invalid gzip data");var ge=ue[3],ve=10;4&ge&&(ve+=2+(ue[10]|ue[11]<<8));for(var Ne=(ge>>3&1)+(ge>>4&1);Ne>0;Ne-=!ue[ve++]);return ve+(2&ge)}(W=k))+8>W.length&&ks(6,"invalid gzip data"),function(ue,ge,ve,Ne){var Ee=ue.length;if(!Ee||ge.f&&!ge.l)return ve||new Qo(0);var Ue=!ve,nt=Ue||ge.i!=2,qe=ge.i;Ue&&(ve=new Qo(3*Ee));var Ke,it,Fe=function(xr){var rr=ve.length;if(xr>rr){var Qi=new Qo(Math.max(2*rr,xr));Qi.set(ve),ve=Qi}},Je=ge.f||0,Ie=ge.p||0,Be=ge.b||0,at=ge.l,et=ge.d,Lt=ge.m,St=ge.n,Xe=8*Ee;do{if(!at){Je=Os(ue,Ie,1);var tt=Os(ue,Ie+1,3);if(Ie+=3,!tt){var It=ue[(ee=4+((Ie+7)/8|0))-4]|ue[ee-3]<<8,xt=ee+It;if(xt>Ee){qe&&ks(0);break}nt&&Fe(Be+It),ve.set(ue.subarray(ee,xt),Be),ge.b=Be+=It,ge.p=Ie=8*xt,ge.f=Je;continue}if(tt==1)at=UM,et=jM,Lt=9,St=5;else if(tt==2){var ut=Os(ue,Ie,31)+257,vt=Os(ue,Ie+10,15)+4,Vt=ut+Os(ue,Ie+5,31)+1;Ie+=14;for(var Zt=new Qo(Vt),Qt=new Qo(19),Kt=0;Kt<vt;++Kt)Qt[BM[Kt]]=Os(ue,Ie+3*Kt,7);Ie+=3*vt;var fi=e0(Qt),oi=(1<<fi)-1,ir=of(Qt,fi);for(Kt=0;Kt<Vt;){var ee,te=ir[Os(ue,Ie,oi)];if(Ie+=15&te,(ee=te>>4)<16)Zt[Kt++]=ee;else{var Oe=0,lt=0;for(ee==16?(lt=3+Os(ue,Ie,3),Ie+=2,Oe=Zt[Kt-1]):ee==17?(lt=3+Os(ue,Ie,7),Ie+=3):ee==18&&(lt=11+Os(ue,Ie,127),Ie+=7);lt--;)Zt[Kt++]=Oe}}var pt=Zt.subarray(0,ut),dt=Zt.subarray(ut);Lt=e0(pt),St=e0(dt),at=of(pt,Lt),et=of(dt,St)}else ks(1);if(Ie>Xe){qe&&ks(0);break}}nt&&Fe(Be+131072);for(var Et=(1<<Lt)-1,qt=(1<<St)-1,ci=Ie;;ci=Ie){var hi=(Oe=at[t0(ue,Ie)&Et])>>4;if((Ie+=15&Oe)>Xe){qe&&ks(0);break}if(Oe||ks(2),hi<256)ve[Be++]=hi;else{if(hi==256){ci=Ie,at=null;break}var ii=hi-254;hi>264&&(ii=Os(ue,Ie,(1<<(ei=sw[Kt=hi-257]))-1)+hw[Kt],Ie+=ei);var Gi=et[t0(ue,Ie)&qt],Tr=Gi>>4;if(Gi||ks(3),Ie+=15&Gi,dt=VM[Tr],Tr>3){var ei=aw[Tr];dt+=t0(ue,Ie)&(1<<ei)-1,Ie+=ei}if(Ie>Xe){qe&&ks(0);break}nt&&Fe(Be+131072);var ar=Be+ii;if(Be<dt){var Ji=0-dt,Bi=Math.min(dt,ar);for(Ji+Be<0&&ks(3);Be<Bi;++Be)ve[Be]=(void 0)[Ji+Be]}for(;Be<ar;++Be)ve[Be]=ve[Be-dt]}}ge.l=at,ge.p=ci,ge.b=Be,ge.f=Je,at&&(Je=1,ge.m=Lt,ge.d=et,ge.n=St)}while(!Je);return Be!=ve.length&&Ue?(Ke=ve,((it=Be)==null||it>Ke.length)&&(it=Ke.length),new Qo(Ke.subarray(0,it))):ve.subarray(0,Be)}(W.subarray(K,-8),{i:2},new Qo(((G=W)[(X=G.length)-4]|G[X-3]<<8|G[X-2]<<16|G[X-1]<<24)>>>0))));var G,X,W,K;let pe=$M[B];if(!pe)throw new Error(`Unhandled codec: ${B}`);let ce=new globalThis.DecompressionStream(pe);return new Response(new Blob([k]).stream().pipeThrough(ce)).arrayBuffer().then(ue=>new Uint8Array(ue))}(A,E).then(k=>(function(B,G){B.readFields(LM,G)}(new i0(k),R),new WM[f](R.buffer))),L.then(k=>{for(let B=T.length-1;B>=0;B--)switch(T[B]){case"delta_filter":DM(k,g);break;case"zigzag_filter":OM(k);break;case"bitshuffle_filter":kM(k,f);break;default:throw new ds(`Unhandled filter "${T[B]}"`)}return{layerName:a,blockIndex:y,data:k}}).catch(k=>{throw k})}))},Tt(mw,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Tt(C_,"MapboxRasterTile"),Tt(fw,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class _w{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){let s=e[i];this._stringToNumber[s]=i,this._numberToString[i]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}let XM=["id","tile","layer","source","sourceLayer","state"];class Gu{constructor(e,i,s,a,h){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=s,this._y=a,this.properties=e.properties,this.id=h}clone(){let e=new Gu(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){let e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let i of XM)this[i]!==void 0&&(e[i]=this[i]);return e}}class gw{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new ra(ht,16,0),this.featureIndexArray=new Im,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,s,a,h,u=0,f=0){let g=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,a,h,u);let y=this.grid;for(let T=0;T<i.length;T++){let E=i[T],A=[1/0,1/0,-1/0,-1/0];for(let R=0;R<E.length;R++){let L=E[R];A[0]=Math.min(A[0],L.x),A[1]=Math.min(A[1],L.y),A[2]=Math.max(A[2],L.x),A[3]=Math.max(A[3],L.y)}f!==0&&(A[0]-=f,A[1]-=f,A[2]+=f,A[3]+=f),A[0]<ht&&A[1]<ht&&A[2]>=0&&A[3]>=0&&y.insert(g,A[0],A[1],A[2],A[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Mt(new r_(this.rawTileData)).layers,this.sourceLayerCoder=new _w(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(let e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){let{tilespaceGeometry:s,transform:a,tileTransform:h,pixelPosMatrix:u,availableImages:f,worldview:g}=i;this.loadVTLayers(),this.serializedLayersCache.clear();let y=s.bufferedTilespaceBounds,T=this.grid.query(y.min.x,y.min.y,y.max.x,y.max.y,(L,k,B,G)=>Cr(s.bufferedTilespaceGeometry,L,k,B,G));T.sort(YM);let E=null;a.elevation&&T.length>0&&(E=Nu.create(a.elevation,this.tileID));let A={},R;for(let L=0;L<T.length;L++){let k=T[L];if(k===R)continue;R=k;let B=this.featureIndexArray.get(k),G=null;this.is3DTile?this.loadMatchingModelFeature(A,B,e,s,a,g):this.loadMatchingFeature(A,B,e,f,g,(X,W,K,pe=0)=>(G||(G=me(X,this.tileID.canonical,h)),W.queryIntersectsFeature(s,X,K,G,this.z,a,u,E,pe)))}return A}loadMatchingFeature(e,i,s,a,h,u){let{featureIndex:f,bucketIndex:g,sourceLayerIndex:y,layoutVertexArrayOffset:T}=i,E=this.bucketLayerIDs[g],A=s.layers,R=Object.keys(A);if(R.length&&!di(R,E))return;let L=s.sourceCache,k=this.sourceLayerCoder.decode(y),B=this.vtLayers[k].feature(f),G=this.getId(B,k);for(let X=0;X<E.length;X++){let W=E[X];if(!A[W])continue;let{styleLayer:K,targets:pe}=A[W],ce={};G!==void 0&&(ce=L.getFeatureState(K.sourceLayer,G));let ue=!u||u(B,K,ce,T);if(!ue)continue;let ge=new Gu(B,this.z,this.x,this.y,G);ge.tile=this.tileID.canonical,ge.state=ce;let ve=this.serializedLayersCache.get(W);ve||(ve=K.serialize(),ve.id=W,this.serializedLayersCache.set(W,ve)),ge.source=ve.source,ge.sourceLayer=ve["source-layer"],ge.layer=Le({},ve),ge.layer.paint=yw(ve.paint,K.paint,B,ce,a),ge.layer.layout=yw(ve.layout,K.layout,B,ce,a);let Ne=!1;for(let Ee of pe){this.updateFeatureProperties(ge,Ee);let{filter:Ue}=Ee;if(Ue){if(B.properties=ge.properties,Ue.needGeometry){let nt=ke(B,!0);if(!Ue.filter(new ji(this.tileID.overscaledZ,{worldview:h}),nt,this.tileID.canonical))continue}else if(!Ue.filter(new ji(this.tileID.overscaledZ,{worldview:h}),B))continue}Ne=!0,Ee.targetId&&this.addFeatureVariant(ge,Ee)}Ne&&this.appendToResult(e,W,f,ge,ue)}}loadMatchingModelFeature(e,i,s,a,h,u){let{featureIndex:f,bucketIndex:g}=i,y=this.bucketLayerIDs[g],T=s.layers,E=Object.keys(T);if(!E.length||di(E,y))for(let A=0;A<y.length;A++){let R=y[A],{styleLayer:L,targets:k}=T[R];if(L.type!=="model")continue;let B=a.tile,G=B.getBucket(L);if(!(G&&G instanceof w_))continue;let X=tM(G,f,a,h);if(!X)continue;let{z:W,x:K,y:pe}=B.tileID.canonical,{feature:ce,intersectionZ:ue,position:ge}=X,ve={};ce.id!==void 0&&(ve=s.sourceCache.getFeatureState(L.sourceLayer,ce.id));let Ne=new Gu({},W,K,pe,ce.id);Ne.tile=this.tileID.canonical,Ne.state=ve,Ne.properties=ce.properties,Ne.geometry={type:"Point",coordinates:[ge.lng,ge.lat]};let Ee=this.serializedLayersCache.get(R);Ee||(Ee=L.serialize(),Ee.id=R,this.serializedLayersCache.set(R,Ee)),Ne.source=Ee.source,Ne.sourceLayer=Ee["source-layer"],Ne.layer=Le({},Ee);let Ue=!1;for(let nt of k){this.updateFeatureProperties(Ne,nt);let{filter:qe}=nt;if(qe){if(ce.properties=Ne.properties,qe.needGeometry){if(!qe.filter(new ji(this.tileID.overscaledZ,{worldview:u}),ce,this.tileID.canonical))continue}else if(!qe.filter(new ji(this.tileID.overscaledZ,{worldview:u}),ce))continue}Ue=!0,nt.targetId&&this.addFeatureVariant(Ne,nt)}Ue&&this.appendToResult(e,R,f,Ne,ue)}}updateFeatureProperties(e,i,s){if(i.properties){let a={};for(let h in i.properties){let u=i.properties[h].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);u!=null&&(a[h]=u)}e.properties=a}}addFeatureVariant(e,i,s){let a={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(a.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(a)}appendToResult(e,i,s,a,h){let u=e[i];u===void 0&&(u=e[i]=[]),u.push({featureIndex:s,feature:a,intersectionZ:h})}lookupSymbolFeatures(e,i,s,a,h,u){let f={};this.loadVTLayers();for(let g of e)this.loadMatchingFeature(f,{bucketIndex:i,sourceLayerIndex:s,featureIndex:g,layoutVertexArrayOffset:0},a,h,u);return f}loadFeature(e){let{featureIndex:i,sourceLayerIndex:s}=e;this.loadVTLayers();let a=this.sourceLayerCoder.decode(s),h=this.vtFeatures[a];if(h[i])return h[i];let u=this.vtLayers[a].feature(i);return h[i]=u,u}hasLayer(e){for(let i of this.bucketLayerIDs)for(let s of i)if(e===s)return!0;return!1}getId(e,i){let s=e.id;if(this.promoteId){let a=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(a!=null)if(Array.isArray(a)){if(!this.promoteIdExpression){let h=Oa(a);if(h.result!=="success"){let u=h.value.map(f=>`${f.key}: ${f.message}`).join(", ");return void pi(`Failed to create expression for promoteId: ${u}`)}this.promoteIdExpression=h.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Rc),s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[a];typeof s=="boolean"&&(s=Number(s))}return s}}function yw(r,e,i,s,a){return Xt(r,(h,u)=>{let f=e instanceof Ko?e.get(u):null;return f&&f.evaluate?f.evaluate(i,s,void 0,a):f})}function YM(r,e){return e-r}Tt(gw,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let xw=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class r0{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[i,s]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");let a=s>>4;if(a!==1)throw new Error(`Got v${a} data when expected v1.`);let h=xw[15&s];if(!h)throw new Error("Unrecognized array type.");let[u]=new Uint16Array(e,2,1),[f]=new Uint32Array(e,4,1);return new r0(f,u,h,e)}constructor(e,i=64,s=Float64Array,a){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;let h=xw.indexOf(this.ArrayType),u=2*e*this.ArrayType.BYTES_PER_ELEMENT,f=e*this.IndexArrayType.BYTES_PER_ELEMENT,g=(8-f%8)%8;if(h<0)throw new Error(`Unexpected typed array class: ${s}.`);a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+g,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+u+f+g),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+g,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+h]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){let s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=i,s}finish(){let e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return n0(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,s,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:h,coords:u,nodeSize:f}=this,g=[0,h.length-1,0],y=[];for(;g.length;){let T=g.pop()||0,E=g.pop()||0,A=g.pop()||0;if(E-A<=f){for(let B=A;B<=E;B++){let G=u[2*B],X=u[2*B+1];G>=e&&G<=s&&X>=i&&X<=a&&y.push(h[B])}continue}let R=A+E>>1,L=u[2*R],k=u[2*R+1];L>=e&&L<=s&&k>=i&&k<=a&&y.push(h[R]),(T===0?e<=L:i<=k)&&(g.push(A),g.push(R-1),g.push(1-T)),(T===0?s>=L:a>=k)&&(g.push(R+1),g.push(E),g.push(1-T))}return y}within(e,i,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:a,coords:h,nodeSize:u}=this,f=[0,a.length-1,0],g=[],y=s*s;for(;f.length;){let T=f.pop()||0,E=f.pop()||0,A=f.pop()||0;if(E-A<=u){for(let B=A;B<=E;B++)bw(h[2*B],h[2*B+1],e,i)<=y&&g.push(a[B]);continue}let R=A+E>>1,L=h[2*R],k=h[2*R+1];bw(L,k,e,i)<=y&&g.push(a[R]),(T===0?e-s<=L:i-s<=k)&&(f.push(A),f.push(R-1),f.push(1-T)),(T===0?e+s>=L:i+s>=k)&&(f.push(R+1),f.push(E),f.push(1-T))}return g}}function n0(r,e,i,s,a,h){if(a-s<=i)return;let u=s+a>>1;vw(r,e,u,s,a,h),n0(r,e,i,s,u-1,1-h),n0(r,e,i,u+1,a,1-h)}function vw(r,e,i,s,a,h){for(;a>s;){if(a-s>600){let y=a-s+1,T=i-s+1,E=Math.log(y),A=.5*Math.exp(2*E/3),R=.5*Math.sqrt(E*A*(y-A)/y)*(T-y/2<0?-1:1);vw(r,e,i,Math.max(s,Math.floor(i-T*A/y+R)),Math.min(a,Math.floor(i+(y-T)*A/y+R)),h)}let u=e[2*i+h],f=s,g=a;for(af(r,e,s,i),e[2*a+h]>u&&af(r,e,s,a);f<g;){for(af(r,e,f,g),f++,g--;e[2*f+h]<u;)f++;for(;e[2*g+h]>u;)g--}e[2*s+h]===u?af(r,e,s,g):(g++,af(r,e,g,a)),g<=i&&(s=g+1),i<=g&&(a=g-1)}}function af(r,e,i,s){o0(r,i,s),o0(e,2*i,2*s),o0(e,2*i+1,2*s+1)}function o0(r,e,i){let s=r[e];r[e]=r[i],r[i]=s}function bw(r,e,i,s){let a=r-i,h=e-s;return a*a+h*h}n.$=cn,n.A=Ms,n.B=Ps,n.C=El,n.D=Cu,n.E=Ia,n.F=2,n.G=$p,n.H=Z1,n.I=Jn,n.J=$s,n.K=class extends b_{},n.L=Aa,n.M=xm,n.N=ou,n.O=nu,n.P=Qe,n.Q=cm,n.R=xc,n.S=$d,n.T=xy,n.U=qc,n.V=b_,n.W=Zd,n.X=Oa,n.Y=qh,n.Z=_l,n._=ml,n.a=function(r){return mn.API_CDN_URL_REGEX.test(r)},n.a$=He,n.a0=md,n.a1=Hc,n.a2=su,n.a3=lm,n.a4=function(r){let e=r.value,i=[];if(!e)return i;let s=$s(e);return s!=="string"?(i=i.concat([new b_(r.key,e,`string expected, "${s}" found`)]),i):($y(e,!0)||(i=i.concat([new b_(r.key,e,`invalid url "${e}"`)])),i)},n.a5=Se,n.a6=Gc,n.a7=Ar,n.a8=ot,n.a9=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return $r(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Bt(r.x,e.x,i),y:Bt(r.y,e.y,i),z:Bt(r.z,e.z,i),azimuthal:Bt(r.azimuthal,e.azimuthal,i),polar:Bt(r.polar,e.polar,i)}}},n.aA=Kn,n.aB=Cn,n.aC=xn,n.aD=F,n.aE=_e,n.aF=function(r,e){let i={};for(let s=0;s<e.length;s++){let a=e[s];a in r&&(i[a]=r[a])}return i},n.aG=z,n.aH=j,n.aI=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,i,s){let a=this.entries[r]=this.entries[r]||{callbacks:[]};if(a.result){let[h,u]=a.result;return this.scheduler?this.scheduler.add(()=>{s(h,u)},e):s(h,u),()=>{}}return a.callbacks.push(s),a.cancel||(a.cancel=i((h,u)=>{a.result=[h,u];for(let f of a.callbacks)this.scheduler?this.scheduler.add(()=>{f(h,u)},e):f(h,u);setTimeout(()=>delete this.entries[r],3e3)})),()=>{a.result||(a.callbacks=a.callbacks.filter(h=>h!==s),a.callbacks.length||(a.cancel(),delete this.entries[r]))}}},n.aJ=function(r,e,i){let s=JSON.stringify(r.request);return r.data&&(this.deduped.entries[s]={result:[null,r.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},a=>{let h=vc(r.request,(u,f,g,y)=>{u?a(u):f&&a(null,{vectorTile:i?void 0:new Mt(new r_(f)),rawData:f,cacheControl:g,expires:y})});return()=>{h.cancel(),a()}},e)},n.aK=function(r){hd++,hd>As&&(r.getActor().send("enforceCacheSizeLimit",Xo),hd=0)},n.aL=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log(r)/Math.LN2))},n.aM=Xr,n.aN=wb,n.aO=Mb,n.aP=bb,n.aQ=function(r,e){let i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let s=0;s<r.length;s++){let a=document.createElement("source");dg(r[s])||(i.crossOrigin="Anonymous"),a.src=r[s],i.appendChild(a)}return{cancel:()=>{}}},n.aR=Vp,n.aS=function(r){return fetch(r).then(e=>e.arrayBuffer()).then(e=>Qv(e,0,r))},n.aT=a1,n.aU=class{constructor(r,e,i,s){this.id=r,this.position=e!=null?new C(e[0],e[1]):new C(0,0),this.orientation=i??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new li([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(r,e){if(Te(r.matrix,e,r.matrix),r.meshes)for(let i of r.meshes){let s=li.applyTransformFast(i.aabb,r.matrix);this.aabb.encapsulate(s)}if(r.children)for(let i of r.children)this._applyTransformations(i,r.matrix)}computeBoundsAndApplyParent(){let r=xe([]);for(let e of this.nodes)this._applyTransformations(e,r)}computeModelMatrix(r,e,i,s,a,h,u=!1){o1(this.matrix,this,r.transform,this.position,e,i,s,a,h,u)}upload(r){if(!this.uploaded){for(let e of this.nodes)wy(e,r);for(let e of this.nodes)i_(e);this.uploaded=!0}}destroy(){for(let r of this.nodes)Ty(r)}},n.aV=Ht,n.aW=Xp,n.aX=Z,n.aY=Y,n.aZ=Al,n.a_=ur,n.aa=ji,n.ab=ia,n.ac=le,n.ad=Lr,n.ae=Ni,n.af=ye,n.ag=Ko,n.ah=Bl,n.ai=Bt,n.aj=ht,n.ak=Ff,n.al=Ai,n.am=ki,n.an=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return function([i,s]){let a=$r([1,i,s]);return{x:a.x,y:a.y,z:a.z}}(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Bt(r.x,e.x,i),y:Bt(r.y,e.y,i),z:Bt(r.z,e.z,i)}}},n.ao=function(r,e,i=0,s=!0){let a=new Qe(i,i),h=r.sub(a),u=e.add(a),f=[h,new Qe(u.x,h.y),u,new Qe(h.x,u.y)];return s&&f.push(h.clone()),f},n.ap=function(r,e){let i=[];for(let s=0;s<r.length;s++){let a=De(s-1,-1,r.length-1),h=De(s+1,-1,r.length-1),u=r[s],f=r[h],g=r[a].sub(u).unit(),y=f.sub(u).unit(),T=y.angleWithSep(g.x,g.y),E=g.add(y).unit().mult(-1*e/Math.sin(T/2));i.push(u.add(E))}return i},n.aq=ab,n.ar=Cr,n.as=function(r,e,i=0){return yi(((e.x-i)*r.scale-r.x)*ht,(e.y*r.scale-r.y)*ht,Q(e.z,e.y))},n.at=zr,n.au=Oi,n.av=Si,n.aw=y1,n.ax=function(r){let e=1/0,i=1/0,s=-1/0,a=-1/0;for(let h of r)e=Math.min(e,h.x),i=Math.min(i,h.y),s=Math.max(s,h.x),a=Math.max(a,h.y);return{min:new Qe(e,i),max:new Qe(s,a)}},n.ay=re,n.az=Te,n.b=function(r){return mn.API_FONTS_REGEX.test(r)},n.b$=Fy,n.b0=Tm,n.b1=g_,n.b2=function(){as.isLoading()||as.isLoaded()||ep()!=="deferred"||_m()},n.b3=Tl,n.b4=ke,n.b5=Gu,n.b6=Pi,n.b7=Iy,n.b8=ny,n.b9=me,n.bA=function(r,e){let{x:i,y:s}=r.point,a=Ux(i,s,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Te(a,a,Wg(ha(e)))},n.bB=H,n.bC=oc,n.bD=function(r,e){return Math.hypot(e[0]-r[0],e[1]-r[1],e[2]-r[2])},n.bE=tn,n.bF=Vr,n.bG=or,n.bH=Hp,n.bI=Io,n.bJ=zy,n.bK=function(r,e,i,s,a){let h=5*e+2;r.float32[h+0]=i,r.float32[h+1]=s,r.float32[h+2]=a},n.bL=__,n.bM=uo,n.bN=Us,n.bO=Vs,n.bP=po,n.bQ=De,n.bR=function(r,e,i,s){var a=new V(4);return a[0]=r,a[1]=e,a[2]=i,a[3]=s,a},n.bS=Xm,n.bT=$i,n.bU=dn,n.bV=yv,n.bW=Cb,n.bX=wv,n.bY=ay,n.bZ=Ly,n.b_=eb,n.ba=Zn,n.bb=fp,n.bc=Ox,n.bd=gr,n.be=Au,n.bf=qy,n.bg=function(r,e){let i=Bl(e.zoom);if(i===0)return ha(r);let s=Bm(r),a=Zg(s),h=F(s.getWest())*e.worldSize,u=F(s.getEast())*e.worldSize,f=j(s.getNorth())*e.worldSize,g=j(s.getSouth())*e.worldSize,y=[h,f,0],T=[u,f,0],E=[h,g,0],A=[u,g,0],R=Ge([],e.globeMatrix);return Lr(y,y,R),Lr(T,T,R),Lr(E,E,R),Lr(A,A,R),a[0]=ja(a[0],E,i),a[1]=ja(a[1],A,i),a[2]=ja(a[2],T,i),a[3]=ja(a[3],y,i),li.fromPoints(a)},n.bh=Vm,n.bi=Ge,n.bj=Sp,n.bk=ja,n.bl=Il,n.bm=ME,n.bn=wt,n.bo=We,n.bp=C_,n.bq=r_,n.br=vc,n.bs=function(r,e){let i=[];for(let s in r)s in e||i.push(s);return i},n.bt=be,n.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],n.bv=Es,n.bw=function(r){var e=new V(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e},n.bx=xe,n.by=At,n.bz=Ae,n.c=Eh,n.c$=45,n.c0=r0,n.c1=Xi,n.c2=Ns,n.c3=ws,n.c4=function(r,e,i){i*=.5;var s=e[0],a=e[1],h=e[2],u=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+a*f,r[1]=a*g-s*f,r[2]=h*g+u*f,r[3]=u*g-h*f,r},n.c5=va,n.c6=wr,n.c7=function(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r},n.c8=Ft,n.c9=function(r,e,i,s,a){var h,u=1/Math.tan(e/2);return r[0]=u/i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=u,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,a!=null&&a!==1/0?(r[10]=(a+s)*(h=1/(s-a)),r[14]=2*a*s*h):(r[10]=-1,r[14]=-2*s),r},n.cA=To,n.cB=Bx,n.cC=function(r,e,i,s,a,h,u,f,g){if(g.name==="globe")return Bx(r,e,new To(i,s,a),!1);let y=Xp({z:i,x:s,y:a},g);return new li([(h+y.x/y.scale)*e,e*(y.y/y.scale),u],[(h+y.x2/y.scale)*e,e*(y.y2/y.scale),f])},n.cD=function(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r[3]=Math.min(e[3],i[3]),r},n.cE=function(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r[3]=Math.max(e[3],i[3]),r},n.cF=function(r){let e=Math.round((r+45+360)%360/90)%4;return q[e]},n.cG=ne,n.cH=vs,n.cI=l,n.cJ=function(r){let e=xe(new Float64Array(16));Te(e,r.pixelMatrix,r.globeMatrix);let i=[0,d,0],s=[0,p,0];return Lr(i,i,e),Lr(s,s,e),[i[0]>0&&i[0]<=r.width&&i[1]>0&&i[1]<=r.height&&!Yg(r,new C(r.center.lat,90)),s[0]>0&&s[0]<=r.width&&s[1]>0&&s[1]<=r.height&&!Yg(r,new C(r.center.lat,-90))]},n.cK=function(r,e){let{scale:i}=r.tileTransform,s=i*ht/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return function(a,h,u){var f=h[1],g=h[2],y=h[3],T=u[0],E=u[1];return a[0]=h[0]*T,a[1]=f*T,a[2]=g*E,a[3]=y*E,a}(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},n.cL=e_,n.cM=Wt,n.cN=e1,n.cO=function(r){let e=e1(r,!0);return H([],[e[0],e[1],e[4],e[5]])},n.cP=ft,n.cQ=Mi,n.cR=_t,n.cS=function(r){let{x:e,y:i}=r.point,{lng:s,lat:a}=r._center;return Ux(e,i,r.worldSize,s,a)},n.cT=Fr,n.cU=Re,n.cV=So,n.cW=Sr,n.cX=Om,n.cY=function(r,e,i){let s=0;for(let a=0;a<2;++a)r[a]>0&&(s+=(r[a]-0)*(r[a]-0)),e[a]<0&&(s+=(0-e[a])*(0-e[a]));return s},n.cZ=function(r){return r*r*r*r*r},n.c_=N,n.ca=function(r,e,i,s,a,h,u){var f=1/(e-i),g=1/(s-a),y=1/(h-u);return r[0]=-2*f,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*g,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*y,r[11]=0,r[12]=(e+i)*f,r[13]=(a+s)*g,r[14]=(u+h)*y,r[15]=1,r},n.cb=U,n.cc=function(r,e,i){r[4*e+0]=i[0],r[4*e+1]=i[1],r[4*e+2]=i[2],r[4*e+3]=i[3]},n.cd=Iu,n.ce=Dl,n.cf=Or,n.cg=hs,n.ch=Qc,n.ci=C,n.cj=db,n.ck=function(){var r=new V(4);return V!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r},n.cl=function(r,e,i){var s=e[0],a=e[1],h=e[2],u=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+h*f,r[1]=a*g+u*f,r[2]=s*-f+h*g,r[3]=a*-f+u*g,r},n.cm=function(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]},n.cn=Lo,n.co=function(r){return Math.hypot(r[0],r[1],r[2],r[3])},n.cp=Ts,n.cq=Bs,n.cr=us,n.cs=3,n.ct=2,n.cu=7,n.cv=6,n.cw=Nn,n.cx=mt,n.cy=Ri,n.cz=t1,n.d=function(r){return mn.API_TILEJSON_REGEX.test(r)},n.d$=(r,e,i,s,a,h,u,f,g,y)=>{let T=r.transform,E=T.calculatePixelsToTileUnitsMatrix(e),A=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",R=T.pitch<15?x1(.07,.7,re((14-T.zoom)/5,0,1)):.07;return{u_matrix:b1(r,e,i,s),u_pixels_to_tile_units:E,u_device_pixel_ratio:h,u_width_scale:u,u_floor_width_scale:f,u_units_to_pixels:[1/T.pixelsToGLUnits[0],1/T.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:T1(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:v1(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:g,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(A?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:R,u_tile_to_meter:se(e.tileID.canonical,0),u_ground_shadow_factor:y}},n.d0=Jc,n.d1=function(r,e,i){let s=Math.sqrt(r*r+e*e+i*i),a=s>0?Math.acos(i/s)*uc:0,h=r!==0||e!==0?Math.atan2(-e,-r)*uc+90:0;return h<0&&(h+=360),[s,h,a]},n.d2=yi,n.d3=$r,n.d4=se,n.d5=vi,n.d6=li,n.d7=mr,n.d8=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},n.d9=$y,n.dA=Bm,n.dB=function(r){let e=ne-5;r=re(r,-e,e)/e*90;let i=Math.pow(Math.abs(Math.sin(Ai(r))),3);return Math.round(i*(c.length-1))},n.dC=function(r,e,i,s){let a=e.getNorth(),h=e.getSouth(),u=e.getWest(),f=e.getEast(),g=1<<r.z,y=f-u,T=a-h,E=y/o,A=-T/c[i],R=[0,E,0,A,0,0,a,u,0];if(r.z>0){let L=180/s;we(R,R,[L/y+1,0,0,0,L/T+1,0,-.5*L/E,.5*L/A,1])}return R[2]=g,R[5]=r.x,R[8]=r.y,R},n.dD=ha,n.dE=function(r,e,i){let s=xe(new Float64Array(16)),a=(e/(1<<r)-.5)*Math.PI*2;return Pt(s,i.globeMatrix,a),Float32Array.from(s)},n.dF=class{isDataAvailableAtPoint(r){let e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;let i=e.getSource().maxzoom,s=1<<i,a=Math.floor(r.x),h=Math.floor((r.x-a)*s),u=Math.floor(r.y*s),f=this.findDEMTileFor(new Xr(i,a,i,h,u));return!(!f||!f.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);let s=this._source();if(!s||r.y<0||r.y>1)return e;let a=s.getSource().maxzoom,h=1<<a,u=Math.floor(r.x),f=r.x-u,g=new Xr(a,u,a,Math.floor(f*h),Math.floor(r.y*h)),y=this.findDEMTileFor(g);if(!y||!y.dem)return e;let T=y.dem,E=1<<y.tileID.canonical.z,A=(f*E-y.tileID.canonical.x)*T.dim,R=(r.y*E-y.tileID.canonical.y)*T.dim,L=Math.floor(A),k=Math.floor(R);return(i?this.exaggeration():1)*Bt(Bt(T.get(L,k),T.get(L,k+1),R-k),Bt(T.get(L+1,k),T.get(L+1,k+1),R-k),A-L)}getAtTileOffset(r,e,i){let s=1<<r.canonical.z;return this.getAtPointOrZero(new le(r.wrap+(r.canonical.x+e/ht)/s,(r.canonical.y+i/ht)/s))}getAtTileOffsetFunc(r,e,i,s){return a=>{let h=this.getAtTileOffset(r,a.x,a.y),u=s.upVector(r.canonical,a.x,a.y);return Xi(u,u,h*s.upVectorScale(r.canonical,e,i).metersToTile),u}}getForTilePoints(r,e,i,s){if(this.isUsingMockSource())return!1;let a=Nu.create(this,r,s);return!!a&&(e.forEach(h=>{h[2]=this.exaggeration()*a.getElevationAt(h[0],h[1],i)}),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;let e=this.findDEMTileFor(r);if(!e||!e.dem)return null;let i=e.dem.tree,s=e.tileID,a=1<<r.canonical.z-s.canonical.z,h=r.canonical.x/a-s.canonical.x,u=r.canonical.y/a-s.canonical.y,f=0;for(let g=0;g<r.canonical.z-s.canonical.z&&!i.leaves[f];g++){h*=2,u*=2;let y=2*Math.floor(u)+Math.floor(h);f=i.childOffsets[f]+y,h%=1,u%=1}return{min:this.exaggeration()*i.minimums[f],max:this.exaggeration()*i.maximums[f]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(let a of r){let h=this.getMinMaxForTile(a.tileID);h&&(i=Math.min(i,h.min),s=Math.max(s,h.max),e=!0)}return e?{min:i,max:s}:null}},n.dG=ev,n.dH=Fm,n.dI=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},n.dJ=J,n.dK=function(r,e){var i=Math.sin(e),s=Math.cos(e);return r[0]=s,r[1]=i,r[2]=0,r[3]=-i,r[4]=s,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},n.dL=Fs,n.dM=Vx,n.dN=jn,n.dO=En,n.dP=256,n.dQ=function(r,e){let i=[0,0,0];return Lr(i,i,Vm(ha(e.canonical))),Lr(i,i,r),i},n.dR=r=>({u_matrix:new Qc(r),u_texsize:new hs(r),u_pixels_to_tile_units:new wp(r),u_device_pixel_ratio:new Or(r),u_width_scale:new Or(r),u_floor_width_scale:new Or(r),u_image:new Iu(r),u_units_to_pixels:new hs(r),u_tile_units_to_pixels:new Or(r),u_alpha_discard_threshold:new Or(r),u_trim_offset:new hs(r),u_trim_fade_range:new hs(r),u_trim_color:new Jc(r),u_emissive_strength:new Or(r),u_zbias_factor:new Or(r),u_tile_to_meter:new Or(r),u_ground_shadow_factor:new Dl(r),u_pattern_transition:new Or(r)}),n.dS=r=>({u_matrix:new Qc(r),u_pixels_to_tile_units:new wp(r),u_device_pixel_ratio:new Or(r),u_width_scale:new Or(r),u_floor_width_scale:new Or(r),u_units_to_pixels:new hs(r),u_dash_image:new Iu(r),u_gradient_image:new Iu(r),u_image_height:new Or(r),u_texsize:new hs(r),u_tile_units_to_pixels:new Or(r),u_alpha_discard_threshold:new Or(r),u_trim_offset:new hs(r),u_trim_fade_range:new hs(r),u_trim_color:new Jc(r),u_emissive_strength:new Or(r),u_zbias_factor:new Or(r),u_tile_to_meter:new Or(r),u_ground_shadow_factor:new Dl(r)}),n.dT=r=>({u_camera_to_center_distance:new Or(r),u_extrude_scale:new wp(r),u_device_pixel_ratio:new Or(r),u_matrix:new Qc(r),u_inv_rot_matrix:new Qc(r),u_merc_center:new hs(r),u_tile_id:new Dl(r),u_zoom_transition:new Or(r),u_up_dir:new Dl(r),u_emissive_strength:new Or(r)}),n.dU=Pl,n.dV=cA,n.dW=qx,n.dX=(r,e,i,s,a,h)=>{let u=r.transform,f=u.projection.name==="globe",g;if(h.paint.get("circle-pitch-alignment")==="map")if(f){let T=Vx(u.zoom,e.canonical)*u._pixelsPerMercatorPixel;g=Float32Array.from([T,0,0,T])}else g=u.calculatePixelsToTileUnitsMatrix(i);else g=new Float32Array([u.pixelsToGLUnits[0],0,0,u.pixelsToGLUnits[1]]);let y={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(u.projection),u_matrix:r.translatePosMatrix(e.projMatrix,i,h.paint.get("circle-translate"),h.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Wo.devicePixelRatio,u_extrude_scale:g,u_inv_rot_matrix:zE,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:h.paint.get("circle-emissive-strength")};if(f){y.u_inv_rot_matrix=s,y.u_merc_center=a,y.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],y.u_zoom_transition=Bl(u.zoom);let T=a[0]*ht,E=a[1]*ht;y.u_up_dir=u.projection.upVector(new To(0,0,0),T,E)}return y},n.dY=w1,n.dZ=qn,n.d_=(r,e,i,s,a,h,u,f,g,y)=>{let T=r.transform,E=T.pitch<15?x1(.07,.7,re((14-T.zoom)/5,0,1)):.07,A=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:b1(r,e,i,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:T.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:a,u_width_scale:h,u_floor_width_scale:u,u_image:0,u_tile_units_to_pixels:v1(e,T),u_units_to_pixels:[1/T.pixelsToGLUnits[0],1/T.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:f,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(A?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:E,u_tile_to_meter:se(e.tileID.canonical,0),u_ground_shadow_factor:g,u_pattern_transition:y}},n.da=function(r,e){return r.readFields(nM,{icons:[]},e)},n.db=Ym,n.dc=ku,n.dd=Oy,n.de=Ch,n.df=mm,n.dg=zo,n.dh=ol,n.di=si,n.dj=function(r){let e=r.indexOf($c);return e>=0?r.slice(0,e):r},n.dk=function(r){return r.indexOf($c)>=0},n.dl=function(r){let e=r.lastIndexOf($c);return e>=0?r.slice(e+1):""},n.dm=function(r){let e=[],i=r.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),r.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},n.dn=function(r,e,i,s){return r.type==="custom"?new JA(r,e):new iM[r.type](r,e,i,s)},n.dp=ui,n.dq=function(r){let e=r.indexOf($c);return e>=0?r.slice(e+1):""},n.dr=class extends Gu{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){let r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},n.ds=Qd,n.dt=rl,n.du=function(r){return r({pluginStatus:Dn,pluginURL:na}),Qd.on("pluginStateChange",r),r},n.dv=bp,n.dw=class extends Bo{constructor(r){super(r),this.current=Ug}set(r,e,i){if(this.fetchUniformLocation(r,e)){for(let s=0;s<9;s++)if(i[s]!==this.current[s]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},n.dx=$,n.dy=function(r,e,i){let s=Bl(i.zoom),a=r.style.map._antialias,h=r.terrain&&r.terrain.exaggeration()>0;return s===0&&!a&&!h},n.dz=function(r){let e=r.pixelsPerMeter,i=e/U(1,r.center.lat),s=xe(new Float64Array(16));return We(s,s,[r.point.x,r.point.y,0]),ft(s,s,[i,i,e]),Float32Array.from(s)},n.e=mn,n.e$=ep,n.e0=kt,n.e1=Ep,n.e2=Q,n.e3=Ua,n.e4=Wm,n.e5=Dv,n.e6=Vl,n.e7=450,n.e8=7,n.e9=de,n.eA=function(r,e,i,s,a,h,u,f,g,y,T,E,A,R,L,k){var B=new V(16);return B[0]=r,B[1]=e,B[2]=i,B[3]=s,B[4]=a,B[5]=h,B[6]=u,B[7]=f,B[8]=g,B[9]=y,B[10]=T,B[11]=E,B[12]=A,B[13]=R,B[14]=L,B[15]=k,B},n.eB=b,n.eC=dp,n.eD=Wc,n.eE=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Qe(1/0,1/0),max:new Qe(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){let i=vv(new Qe(0,0),new Qe(ht,ht),r),s=[];if(e&&!oy(i,this._globalClipBounds))return s;for(let a of this._activeRegions){if(a.hiddenByOverlap||!oy(i,a))continue;let h=aI(a.min,a.max,r);s.push({min:h.min,max:h.max,sourceId:this._sourceIds[a.priority],footprint:a.footprint,footprintTileId:a.tileId,order:a.order,clipMask:a.clipMask,clipScope:a.clipScope})}return s}setSources(r){this._setSources(r.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{let i=[];for(let s of e.cache.getVisibleCoordinates()){let a=e.cache.getTile(s).buckets[e.layer];a&&a.updateFootprints(s.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(r){let e=r.getFootprints();if(e.length===0)return;let i=r.getOrder(),s=r.getClipMask(),a=r.getClipScope();for(let h of e){if(!h.footprint)continue;let u=vv(h.footprint.min,h.footprint.max,h.id);this._activeRegions.push({min:u.min,max:u.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:h.id,footprint:h.footprint,order:i,clipMask:s,clipScope:a})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||Hm(e.min,i.min)||Hm(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(s,a){let h=(u,f)=>u+f;return s.length-a.length||s.reduce(h,"").localeCompare(a.reduce(h,""))}(e.clipScope,i.clipScope));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){let i=this._activeRegions[e],s=this._prevRegions[e];r=i.priority!==s.priority||!xv(i,s)||i.order!==s.order||i.clipMask!==s.clipMask||!Es(i.clipScope,s.clipScope),++e}}if(r){++this._updateTime;for(let i of this._activeRegions)i.order!==Rp&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));let e=i=>{let s=this._activeRegions;if(i>=s.length)return i;let a=s[i].priority;for(;i<s.length&&s[i].priority===a;)++i;return i};if(this._sourceIds.length>1){let i=0,s=e(i);for(;i!==s;){let a=i,h=i;for(;a!==s;){let u=this._activeRegions[a];u.hiddenByOverlap=!1;for(let f=0;f<h;f++){let g=this._activeRegions[f];if(!g.hiddenByOverlap&&u.order===Rp&&oy(u,g)&&(u.hiddenByOverlap=bv(u.footprint,u.tileId,g.footprint,g.tileId),u.hiddenByOverlap))break}++a}i=s,s=e(i)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},n.eF=Rp,n.eG=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(let r of this._poleSegments)r.destroy();for(let r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){let i=new Zn,s=new ur,a=[],h=r+1+2,u=e[0]+1,f=e[0]+1+(1+e.length),g=(y,T,E)=>{let A=y===h-1?y-2:y===0?y:y-1;return A+=E?24575:0,[A,T]};for(let y=0;y<h;++y)i.emplaceBack(...g(y,0,!0));for(let y=0;y<u;++y)for(let T=0;T<h;++T)i.emplaceBack(...g(T,y,(T===0||T===h-1)&&!0));for(let y=0;y<e.length;++y){let T=e[y];for(let E=0;E<h;++E)i.emplaceBack(...g(E,T,!0))}for(let y=0;y<e.length;++y){let T=s.length,E=e[y]+1+2,A=new ur;for(let k=0;k<E-1;k++){let B=k===E-2,G=B?h*(f-e.length+y-k):h;for(let X=0;X<h-1;X++){let W=k*h+X;k===0||B||X===0||X===h-2?(A.emplaceBack(W+1,W,W+G),A.emplaceBack(W+G,W+G+1,W+1)):(s.emplaceBack(W+1,W,W+G),s.emplaceBack(W+G,W+G+1,W+1))}}let R=gr.simpleSegment(0,T,i.length,s.length-T);for(let k=0;k<A.uint16.length;k+=3)s.emplaceBack(A.uint16[k],A.uint16[k+1],A.uint16[k+2]);let L=gr.simpleSegment(0,T,i.length,s.length-T);a.push({withoutSkirts:R,withSkirts:L})}return{vertices:i,indices:s,segments:a}}_createGrid(r){let e=this._fillGridMeshWithLods(o,c);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,Ox.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){let e=new ur;for(let u=0;u<=o;u++)e.emplaceBack(0,u+1,u+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);let i=new Na,s=new Na,a=new Na,h=new Na;this._poleSegments=[];for(let u=0,f=0;u<Om;u++){let g=360/(1<<u);i.emplaceBack(0,-Cn,0,.5,0),s.emplaceBack(0,-Cn,0,.5,1),a.emplaceBack(0,-Cn,0,.5,.5),h.emplaceBack(0,-Cn,0,.5,.5);for(let y=0;y<=o;y++){let T=y/o,E=0,A=Bt(0,g,T),[R,L,k]=_(RE,LE,A,Cn);i.emplaceBack(R,L,k,T,E),s.emplaceBack(R,L,k,T,1-E);let B=Ai(A);T=.5+.5*Math.sin(B),E=.5+.5*Math.cos(B),a.emplaceBack(R,L,k,T,E),h.emplaceBack(R,L,k,T,1-E)}this._poleSegments.push(gr.simpleSegment(f,0,66,64)),f+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(i,km,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(s,km,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(a,km,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(h,km,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},n.eH=gv,n.eI=ie,n.eJ=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},n.eK=fe,n.eL=oe,n.eM=function(r,e,i){return r[0]=e[0]/i[0],r[1]=e[1]/i[1],r[2]=e[2]/i[2],r},n.eN=Vn,n.eO=x,n.eP=Ro,n.eQ=mi,n.eR=function([r,e,i]){let s=Math.hypot(r,e,i),a=Math.atan2(r,i),h=.5*Math.PI-Math.acos(-e/s);return new C(Re(a),Re(h))},n.eS=co,n.eT=vy,n.eU=function(r){let e=r.navigator?r.navigator.userAgent:null;return!!function(i){if(Ir==null){let s=i.navigator?i.navigator.userAgent:null;Ir=!!i.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Ir}(r)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},n.eV=function(r,e){Xo=r,As=e},n.eW=Yg,n.eX=jx,n.eY=function(r){let e=[0,0,0],i=xe(new Float64Array(16));return Te(i,r.pixelMatrix,r.globeMatrix),Lr(e,e,i),new Qe(e[0],e[1])},n.eZ=function(){let r=Fp;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(dy),Fp=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},n.e_=function(){Ym().acquire(dy)},n.ea=function(r,e){if(r===e){var i=e[1],s=e[2],a=e[3],h=e[6],u=e[7],f=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=i,r[6]=e[9],r[7]=e[13],r[8]=s,r[9]=h,r[11]=e[14],r[12]=a,r[13]=u,r[14]=f}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r},n.eb=KA,n.ec=gi,n.ed=mp,n.ee=256,n.ef=Wg,n.eg=yo,n.eh=Pt,n.ei=function(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],r},n.ej=Na,n.ek=up,n.el=om,n.em=function(r,e,i,s,a){return re((r-e)/(i-e)*(a-s)+s,s,a)},n.en=Ka,n.eo=function(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=e[4],f=e[5],g=e[6],y=e[7],T=e[8],E=T*u-f*y,A=-T*h+f*g,R=y*h-u*g,L=i*E+s*A+a*R;return L?(r[0]=E*(L=1/L),r[1]=(-T*s+a*y)*L,r[2]=(f*s-a*u)*L,r[3]=A*L,r[4]=(T*i-a*g)*L,r[5]=(-f*i+a*h)*L,r[6]=R*L,r[7]=(-y*i+s*g)*L,r[8]=(u*i-s*h)*L,r):null},n.ep=2,n.eq=Zo,n.er=by,n.es=[1,1,1],n.et=class{constructor(r,e,i,s){this.context=r,this.format=s,this.size=i,this.texture=r.gl.createTexture();let[a,h,u]=this.size,{gl:f}=r;f.bindTexture(f.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),f.texImage3D(f.TEXTURE_3D,0,this.format,a,h,u,0,gy(this.format),yy(this.format),e.data)}bind(r,e){let{context:i}=this,{gl:s}=i;s.bindTexture(s.TEXTURE_3D,this.texture),r!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){let{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},n.eu=Nu,n.ev=sc,n.ew=function(r,e,i,s){var a=e[0],h=e[1],u=e[2],f=e[3];return r[0]=a+s*(i[0]-a),r[1]=h+s*(i[1]-h),r[2]=u+s*(i[2]-u),r[3]=f+s*(i[3]-f),r},n.ex=zu,n.ey=cs,n.ez=la,n.f=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},n.f0=function(r,e,i=!1){if(Dn===eo.deferred||Dn===eo.loading||Dn===eo.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");na=Wo.resolveURL(r),Dn=eo.deferred,Kd=e,Jd(),i||_m()},n.f1=function(r){Pu=Wo.resolveURL(r),Ru||(Ru=new Cu(Ym(),new Ia)),Ru.broadcast("setMeshoptUrl",Pu)},n.f2=Zv,n.f3=function(r){fy=Wo.resolveURL(r),Ru||(Ru=new Cu(Ym(),new Ia)),Ru.broadcast("setDracoUrl",fy)},n.f4=$v,n.f5=kp,n.f6=function(r){let e=wa();if(!e)return;let i=e.delete(Is);r&&i.then(()=>r()).catch(r)},n.f7=nh,n.f8=Tt,n.f9=Nl,n.fa=Ds,n.fb=_w,n.fc=gw,n.fd=m1,n.fe=yt,n.ff="hd_road_elevation",n.fg=yr,n.fh=Xt,n.fi=ih,n.fj=Dy,n.fk=ah,n.fl=function(r,e,i,s,a,h,u,f=1,g,y,T){r.createArrays(),r.tilePixelRatio=ht/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;let E=r.layers[0].layout,A=r.layers[0]._unevaluatedLayout._values,R={};R.scaleFactor=f,R.textSizeScaleRange=E.get("text-size-scale-range"),R.iconSizeScaleRange=E.get("icon-size-scale-range");let[L,k]=R.textSizeScaleRange,[B,G]=R.iconSizeScaleRange;R.textScaleFactor=re(R.scaleFactor,L,k),R.iconScaleFactor=re(R.scaleFactor,B,G);let X=A["text-size"],W=A["icon-size"];if(r.textSizeData.kind==="composite"){let{minZoom:ve,maxZoom:Ne}=r.textSizeData;R.compositeTextSizes=[X.possiblyEvaluate(new ji(ve,{worldview:T}),h),X.possiblyEvaluate(new ji(Ne,{worldview:T}),h)]}if(r.iconSizeData.kind==="composite"){let{minZoom:ve,maxZoom:Ne}=r.iconSizeData;R.compositeIconSizes=[W.possiblyEvaluate(new ji(ve,{worldview:T}),h),W.possiblyEvaluate(new ji(Ne,{worldview:T}),h)]}R.layoutTextSize=X.possiblyEvaluate(new ji(u+1,{worldview:T}),h),R.layoutIconSize=W.possiblyEvaluate(new ji(u+1,{worldview:T}),h),R.textMaxSize=X.possiblyEvaluate(new ji(18,{worldview:T}),h);let K=E.get("symbol-placement"),pe=E.get("text-rotation-alignment")==="map"&&K!=="point",ce=E.get("text-size"),ue=!1,ge=[];for(let ve of r.features){let Ne=E.get("text-font").evaluate(ve,{},h).join(","),Ee=ce.evaluate(ve,{},h)*R.textScaleFactor,Ue=R.layoutTextSize.evaluate(ve,{},h)*R.textScaleFactor,nt=R.layoutIconSize.evaluate(ve,{},h)*R.iconScaleFactor,qe={horizontal:{},vertical:void 0},Ke=ve.text,it,Fe=[0,0];if(Ke){let vt=Ke.toString(),Vt=E.get("text-letter-spacing").evaluate(ve,{},h)*dn,Zt=E.get("text-line-height").evaluate(ve,{},h)*dn,Qt=Pg(vt)?Vt:0,Kt=E.get("text-anchor").evaluate(ve,{},h),fi=E.get("text-variable-anchor");if(!fi){let Oe=E.get("text-radial-offset").evaluate(ve,{},h);if(Oe)Fe=eb(Kt,[Oe*dn,ky]);else{let lt=E.get("text-offset").evaluate(ve,{},h);Fe=[lt[0]*dn,lt[1]*dn]}}let oi=pe?"center":E.get("text-justify").evaluate(ve,{},h),ir=K==="point",ee=ir?E.get("text-max-width").evaluate(ve,{},h)*dn:1/0,te=Oe=>{r.allowVerticalPlacement&&Yd(vt)&&(qe.vertical=Ry(Ke,e,i,a,Ne,ee,Zt,Kt,Oe,Qt,Fe,Io.vertical,!0,Ue,Ee,g))};if(!pe&&fi){let Oe=oi==="auto"?fi.map(pt=>Fy(pt)):[oi],lt=!1;for(let pt=0;pt<Oe.length;pt++){let dt=Oe[pt];if(!qe.horizontal[dt])if(lt)qe.horizontal[dt]=qe.horizontal[0];else{let Et=Ry(Ke,e,i,a,Ne,ee,Zt,"center",dt,Qt,Fe,Io.horizontal,!1,Ue,Ee,g);Et&&(qe.horizontal[dt]=Et,lt=Et.positionedLines.length===1)}}te("left")}else{if(oi==="auto"&&(oi=Fy(Kt)),ir||E.get("text-writing-mode").indexOf("horizontal")>=0||!Yd(vt)){let Oe=Ry(Ke,e,i,a,Ne,ee,Zt,Kt,oi,Qt,Fe,Io.horizontal,!1,Ue,Ee,g);Oe&&(qe.horizontal[oi]=Oe)}te(ir?"left":oi)}}let Je,Ie,Be,at,et,Lt,St=!1,Xe=E.get("icon-text-fit").evaluate(ve,{},h);if(ve.icon&&ve.icon.hasPrimary()){let vt=ib(ve.icon,r.iconSizeData,A["icon-size"],h,r.zoom,ve,g,R.iconScaleFactor,T);Je=vt.iconPrimary,Be=vt.iconSecondary;let Vt=Je.toString();if(Ie=s.get(Vt),Ie&&(et=E.get("icon-offset").evaluate(ve,{},h),Lt=E.get("icon-anchor").evaluate(ve,{},h),it=AA(a.get(Vt),Be?a.get(Be.toString()):void 0,et,Lt),St=Ie.sdf,r.sdfIcons===void 0?r.sdfIcons=Ie.sdf:r.sdfIcons!==Ie.sdf&&pi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ie.pixelRatio!==r.pixelRatio||E.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0)),Be){let Zt=Be.toString();at=s.get(Zt)}}ue=ue||!(!ve.icon||!ve.icon.hasSecondary());let tt=By(qe.horizontal)||qe.vertical;r.iconsInText||(r.iconsInText=!!tt&&tt.iconsInText);let It=Ue*R.textScaleFactor/dn,{defaultShapedIcon:xt,verticallyShapedIcon:ut}=FA(r,it,E,ve,h,qe,It,et,Xe);Xe!=="none"&&it&&(B1(it)||N1(it))&&(l_(0,Ie,Je,it,xt,Xe,y,s,a),l_(0,at,Be,it,xt,Xe,y,s,a),ut&&(l_(0,Ie,Je,it,ut,Xe,y,s,a),l_(0,at,Be,it,ut,Xe,y,s,a))),it=xt,ge.push({feature:ve,shapedTextOrientations:qe,shapedText:tt,shapedIcon:it,iconPrimary:Je,iconSecondary:Be,iconOffset:et,iconAnchor:Lt,verticallyShapedIcon:ut,layoutTextSize:Ue,layoutIconSize:nt,textOffset:Fe,isSDFIcon:St,iconTextFit:Xe})}return{featureData:ge,sizes:R,hasAnySecondaryIcon:ue,textAlongLine:pe,symbolPlacement:K}},n.fm=W1,n.fn=function(r,e,i,s,a,h,u,f,g,y){let{featureData:T,hasAnySecondaryIcon:E,sizes:A,textAlongLine:R,symbolPlacement:L}=e;for(let k of T){let{shapedIcon:B,verticallyShapedIcon:G,feature:X,shapedTextOrientations:W,shapedText:K,layoutTextSize:pe,textOffset:ce,isSDFIcon:ue,iconPrimary:ge,iconSecondary:ve,iconTextFit:Ne,iconOffset:Ee}=k;rb(B,y.iconPositions,ge,ve),rb(G,y.iconPositions,ge,ve),kA(W,y.iconPositions),OA(ge,ve,y.iconPositions),(K||B)&&BA(r,X,W,B,G,g,A,pe,0,ce,ue,s,a,u,f,E,Ne,Ee,R,L)}i&&r.generateCollisionDebugBuffers(h,r.collisionBoxArray,A.textScaleFactor)},n.fo=Mt,n.fp=M_,n.fq=Pe,n.fr=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==Xv){let i=new Uint32Array(r,0,7),[,,s,a,h,u]=i;e=i.byteLength+a+h+u+h,(s!==r.byteLength||e>=r.byteLength)&&pi("Invalid b3dm header information.")}return Qv(r,e)},n.fs=function(r,e){let i=a1(r);for(let s of i){for(let a of s.meshes)BI(a);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(NI(s.lights,e)))}return i},n.ft=w_,n.fu=Hi,n.fv=qv,n.fw=as,n.fx=eo,n.fy=function(r){tl(),os?.then(e=>{e.keys().then(i=>{for(let s=0;s<i.length-r;s++)e.delete(i[s]).catch(a=>pi(a.message))}).catch(i=>pi(i.message))}).catch(e=>pi(e.message))},n.g=function(r,e){return rl(Le(r,{method:"GET"}),e)},n.h=Le,n.i=function(r){return mn.API_STYLE_REGEX.test(r)&&!Eh(r)},n.j=function(r){return r.indexOf("mapbox:")===0},n.k=Gs,n.l=ud,n.m=function(r){return decodeURIComponent(atob(r).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},n.n=function(r,e){return rl(Le(r,{type:"json"}),e)},n.o=wc,n.p=function(r,e){return rl(Le(r,{method:"POST"}),e)},n.q=Wo,n.r=vn,n.s=function(r){try{let e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},n.t=Mh,n.u=function(){return function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)}()},n.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},n.w=pi,n.x=function(){return py||(py=new nh),py},n.y=Qy,n.z=mo}),w(["./shared"],function(n){function O(Re){let q=Re?Re.url.toString():void 0;return q?performance.getEntriesByName(q):[]}function V(Re){if(typeof Re=="number"||typeof Re=="boolean"||typeof Re=="string"||Re==null)return JSON.stringify(Re);if(Array.isArray(Re)){let $="[";for(let ie of Re)$+=`${V(ie)},`;return`${$}]`}let q="{";for(let $ of Object.keys(Re).sort())q+=`${$}:${V(Re[$])},`;return`${q}}`}function H(Re){let q="";for(let $ of n.bu)q+=`/${V(Re[$])}`;return q}class J{constructor(q){this.keyCache={},this._layers={},this._layerConfigs={},q&&this.replace(q)}replace(q,$){this._layerConfigs={},this._layers={},this.update(q,[],$)}update(q,$,ie){this._options=ie;for(let re of q)this._layerConfigs[re.id]=re,(this._layers[re.id]=n.dn(re,this.scope,null,this._options)).compileFilter(ie),this.keyCache[re.id]&&delete this.keyCache[re.id];for(let re of $)delete this.keyCache[re],delete this._layerConfigs[re],delete this._layers[re];this.familiesBySource={};let fe=function(re,ye){let De={};for(let Le=0;Le<re.length;Le++){let st=re[Le],He=ye&&ye[st.id];He||(st.type==="symbol"?He=st.id:(He=H(st),st.type==="line"&&st.paint&&function Ht(Xt){return typeof Xt=="string"&&Xt==="line-progress"||(Array.isArray(Xt)?Xt.some(Ht):!(!Xt||typeof Xt!="object")&&Object.values(Xt).some(Ht))}(st.paint["line-width"])&&(He+=`/${V(st.paint["line-width"])}`))),ye&&(ye[st.id]=He);let kt=De[He];kt||(kt=De[He]=[]),kt.push(st)}let be=[];for(let Le in De)be.push(De[Le]);return be}(Object.values(this._layerConfigs),this.keyCache);for(let re of fe){let ye=re.map(kt=>this._layers[kt.id]),De=ye[0];if(De.visibility==="none")continue;let be=De.source||"",Le=this.familiesBySource[be];Le||(Le=this.familiesBySource[be]={});let st=De.sourceLayer||"_geojsonTileLayer",He=Le[st];He||(He=Le[st]=[]),He.push(ye)}}}let ae=1*n.fa;class we{constructor(q){let $={},ie=[];for(let De in q){let be=q[De],Le=$[De]={};for(let st in be.glyphs){let He=be.glyphs[+st];if(!He||He.bitmap.width===0||He.bitmap.height===0)continue;let kt=He.metrics.localGlyph?ae:1,Ht={x:0,y:0,w:He.bitmap.width+2*kt,h:He.bitmap.height+2*kt};ie.push(Ht),Le[st]=Ht}}let{w:fe,h:re}=n.H(ie),ye=new n.f9({width:fe||1,height:re||1});for(let De in q){let be=q[De];for(let Le in be.glyphs){let st=be.glyphs[+Le];if(!st||st.bitmap.width===0||st.bitmap.height===0)continue;let He=$[De][Le],kt=st.metrics.localGlyph?ae:1;n.f9.copy(st.bitmap,ye,{x:0,y:0},{x:He.x+kt,y:He.y+kt},st.bitmap)}}this.image=ye,this.positions=$}}n.f8(we,"GlyphAtlas");class Ae{constructor(q){this.tileID=new n.aM(q.tileID.overscaledZ,q.tileID.wrap,q.tileID.canonical.z,q.tileID.canonical.x,q.tileID.canonical.y),this.tileZoom=q.tileZoom,this.uid=q.uid,this.zoom=q.zoom,this.lut=q.lut,this.canonical=q.tileID.canonical,this.pixelRatio=q.pixelRatio,this.tileSize=q.tileSize,this.source=q.source,this.scope=q.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=q.showCollisionBoxes,this.collectResourceTiming=!!q.request&&q.request.collectResourceTiming,this.promoteId=q.promoteId,this.isSymbolTile=q.isSymbolTile,this.tileTransform=n.aW(q.tileID.canonical,q.projection),this.projection=q.projection,this.worldview=q.worldview,this.localizableLayerIds=q.localizableLayerIds,this.brightness=q.brightness,this.extraShadowCaster=!!q.extraShadowCaster,this.tessellationStep=q.tessellationStep,this.scaleFactor=q.scaleFactor,this.worldview=q.worldview}parse(q,$,ie,fe,re,ye){this.status="parsing",this.data=q,this.collisionBoxArray=new n.b0;let De=new n.fb(Object.keys(q.layers).sort()),be=new n.fc(this.tileID,this.promoteId);be.bucketLayerIDs=[];let Le={},st=new n.fd(256,256),He={featureIndex:be,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:st,availableImages:ie,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},kt=[],Ht=$.familiesBySource[this.source];for(let ui in Ht){let si=q.layers[ui];if(!si)continue;let di=!1,Yi=!1,pi=!1;for(let Hi of Ht[ui])Hi[0].type==="symbol"?di=!0:Yi=!0,Hi[0].is3D()&&Hi[0].type!=="model"&&(pi=!0);if(this.extraShadowCaster&&!pi||this.isSymbolTile===!0&&!di||this.isSymbolTile===!1&&!Yi)continue;si.version===1&&n.w(`Vector tile source "${this.source}" layer "${ui}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let Mr=De.encode(ui),Qr=[],$r=!1;for(let Hi=0,Pi=0;Hi<si.length;Hi++){let Ir=si.feature(Hi),wr=be.getId(Ir,ui);if(this.localizableLayerIds&&this.localizableLayerIds.has(ui)){let _r=Ir.properties?Ir.properties.worldview:null;if(this.worldview&&typeof _r=="string")if(_r==="all")Ir.properties.$localized=!0;else{if(!_r.split(",").includes(this.worldview))continue;Ir.properties.$localized=!0,Ir.properties.worldview=this.worldview}}!$r&&Ir.properties&&Ir.properties.hasOwnProperty(n.fe)&&($r=!0),Qr.push({feature:Ir,id:wr,index:Pi,sourceLayerIndex:Mr}),Pi++}$r&&!He.elevationFeatures&&q.layers.hasOwnProperty(n.ff)&&(He.elevationFeatures=n.fg.parseFrom(q.layers[n.ff],this.canonical));for(let Hi of Ht[ui]){let Pi=Hi[0];if(this.extraShadowCaster&&(!Pi.is3D()||Pi.type==="model")||this.isSymbolTile!==void 0&&Pi.type==="symbol"!==this.isSymbolTile||Pi.minzoom&&this.zoom<Math.floor(Pi.minzoom)||Pi.maxzoom&&this.zoom>=Pi.maxzoom||Pi.visibility==="none")continue;xe(Hi,this.zoom,He.brightness,ie,this.worldview);let Ir=Le[Pi.id]=Pi.createBucket({index:be.bucketLayerIDs.length,layers:Hi,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Mr,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:fe,worldview:this.worldview});be.bucketLayerIDs.push(Hi.map(_r=>n.C(_r.id,_r.scope)));let wr=Ir.prepare?Ir.prepare():null;wr!=null?(wr=wr.then(()=>Ir.populate(Qr,He,this.tileID.canonical,this.tileTransform)),kt.push(wr)):Ir.populate(Qr,He,this.tileID.canonical,this.tileTransform)}}let Xt=()=>{let ui,si,di,Yi,pi,Mr;st.trim();let Qr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},$r=()=>{if(ui)return this.status="done",ye(ui);if(this.extraShadowCaster)this.status="done",ye(null,{buckets:Object.values(Le).filter(Pi=>!Pi.isEmpty()),featureIndex:be,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:He.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(si&&di&&Yi){let Pi=new we(si),Ir=new Map;for(let[ln,jn]of di.entries()){let{imagePosition:En}=n.fj(ln,jn,n.fk);Ir.set(ln,En)}let wr={};for(let ln in Le){let jn=Le[ln];jn instanceof n.b1&&(xe(jn.layers,this.zoom,He.brightness,ie,this.worldview),wr[ln]=n.fl(jn,si,Pi.positions,di,Ir,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,pi,this.worldview))}let _r={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(re,di,pi,()=>{_r.iconsPending=!1,Hi(wr,Pi,_r)}),this.rasterizeIfNeeded(re,Yi,Mr,()=>{_r.patternsPending=!1,Hi(wr,Pi,_r)})}},Hi=(Pi,Ir,wr,_r)=>{if(wr.iconsPending||wr.patternsPending)return;let ln=new n.fm(di,Yi,this.lut);for(let jn in Le){let En=Le[jn];if(jn in Pi)n.fn(En,Pi[jn],this.showCollisionBoxes,ie,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,di,ln);else if(En.hasPattern&&(En instanceof n.b7||En instanceof n.b8||En instanceof n.e4)){xe(En.layers,this.zoom,He.brightness,ie,this.worldview);let dc=Object.fromEntries(ln.patternPositions);En.addFeatures(He,this.tileID.canonical,dc,ie,this.tileTransform,this.brightness)}}this.status="done",ye(null,{buckets:Object.values(Le).filter(jn=>!jn.isEmpty()),featureIndex:be,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ir.image,lineAtlas:st,imageAtlas:ln,brightness:He.brightness})};if(!this.extraShadowCaster){let Pi=n.fh(He.glyphDependencies,_r=>Object.keys(_r).map(Number));Object.keys(Pi).length?re.send("getGlyphs",{uid:this.uid,stacks:Pi},(_r,ln)=>{ui||(ui=_r,si=ln,$r())},void 0,!1,Qr):si={};let Ir=Array.from(He.iconDependencies.keys()).map(_r=>n.I.parse(_r));Ir.length?re.send("getImages",{images:Ir,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(_r,ln)=>{ui||(ui=_r,di=new Map,pi=this.updateImageMapAndGetImageTaskQueue(di,ln,He.iconDependencies),$r())},void 0,!1,Qr):(di=new Map,pi=new Map);let wr=Array.from(He.patternDependencies.keys()).map(_r=>n.I.parse(_r));wr.length?re.send("getImages",{images:wr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(_r,ln)=>{ui||(ui=_r,Yi=new Map,Mr=this.updateImageMapAndGetImageTaskQueue(Yi,ln,He.patternDependencies),$r())},void 0,!1,Qr):(Yi=new Map,Mr=new Map)}if(He.elevationFeatures&&He.elevationFeatures.length>0){let Pi=[];for(let wr of Object.values(Le))if(wr instanceof n.b8){let _r=wr.getUnevaluatedPortalGraph();_r&&Pi.push(_r)}let Ir=n.fi.evaluate(Pi);for(let wr of Object.values(Le))if(wr instanceof n.b8){let _r=q.layers[De.decode(wr.sourceLayerIndex)];wr.setEvaluatedPortalGraph(Ir,_r,this.tileID.canonical,He.availableImages,He.brightness)}}$r()};kt.length>0?Promise.allSettled(kt).then(Xt).catch(ye):Xt()}rasterizeIfNeeded(q,$,ie,fe){Array.from($.values()).some(re=>re.usvg)?this.rasterize(q,$,ie,fe):fe()}updateImageMapAndGetImageTaskQueue(q,$,ie){let fe=new Map;for(let re of $.keys()){let ye=ie.get(re)||[];for(let De of ye){let be=De.toString(),Le=$.get(De.id.toString());Le.usvg?fe.has(be)||(fe.set(be,De),q.set(be,Object.assign({},Le))):q.set(be,Le)}}return fe}rasterize(q,$,ie,fe){this.rasterizeTask=q.send("rasterizeImages",{scope:this.scope,tasks:ie},(re,ye)=>{if(!re)for(let[De,be]of ye.entries()){let Le=Object.assign($.get(De),{data:be});$.set(De,Le)}fe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function xe(Re,q,$,ie,fe){let re=new n.aa(q,{brightness:$,worldview:fe});for(let ye of Re)ye.recalculate(re,ie)}class Ge extends n.E{constructor(q,$,ie,fe,re,ye,De){super(),this.actor=q,this.layerIndex=$,this.availableImages=ie,this.availableModels=fe,this.loadVectorData=ye||n.aJ,this.loading={},this.loaded={},this.deduped=new n.aI(q.scheduler),this.isSpriteLoaded=re,this.scheduler=q.scheduler,this.brightness=De}loadTile(q,$){let ie=q.uid,fe=q&&q.request,re=fe&&fe.collectResourceTiming,ye=this.loading[ie]=new Ae(q);ye.abort=this.loadVectorData(q,(De,be)=>{let Le=!this.loading[ie];if(delete this.loading[ie],ye.cancelRasterize(),Le||De||!be)return ye.status="done",Le||(this.loaded[ie]=ye),$(De);let st=be.rawData,He={};be.expires&&(He.expires=be.expires),be.cacheControl&&(He.cacheControl=be.cacheControl),ye.vectorTile=be.vectorTile||new n.fo(new n.bq(st));let kt=()=>{ye.parse(ye.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Ht,Xt)=>{if(Ht||!Xt)return $(Ht);let ui={};if(re){let si=O(fe);si.length>0&&(ui.resourceTiming=JSON.parse(JSON.stringify(si)))}$(null,n.h({rawTileData:st.slice(0)},Xt,He,ui))})};this.isSpriteLoaded?kt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(kt,{type:"parseTile",isSymbolTile:q.isSymbolTile,zoom:q.tileZoom}):kt()}),this.loaded=this.loaded||{},this.loaded[ie]=ye})}reloadTile(q,$){let ie=this.loaded,fe=q.uid;if(ie&&ie[fe]){let re=ie[fe];re.scaleFactor=q.scaleFactor,re.showCollisionBoxes=q.showCollisionBoxes,re.projection=q.projection,re.brightness=q.brightness,re.tileTransform=n.aW(q.tileID.canonical,q.projection),re.extraShadowCaster=q.extraShadowCaster,re.lut=q.lut,re.worldview=q.worldview;let ye=(De,be)=>{let Le=re.reloadCallback;Le&&(delete re.reloadCallback,re.parse(re.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Le)),$(De,be)};re.status==="parsing"?re.reloadCallback=ye:re.status==="done"&&(re.vectorTile?re.parse(re.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,ye):ye())}else $(null,void 0)}abortTile(q,$){let ie=q.uid,fe=this.loading[ie];fe&&(fe.abort&&fe.abort(),delete this.loading[ie]),$()}removeTile(q,$){let ie=this.loaded,fe=q.uid;ie&&ie[fe]&&delete ie[fe],$()}}class Te{loadTile(q,$){let{uid:ie,encoding:fe,rawImageData:re,padding:ye}=q,De=ImageBitmap&&re instanceof ImageBitmap?this.getImageData(re,ye):re;$(null,new n.fp(ie,De,fe,ye<1))}reloadTile(q,$){$(null,null)}abortTile(q,$){$()}removeTile(q,$){$()}getImageData(q,$){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(q.width,q.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=q.width,this.offscreenCanvas.height=q.height,this.offscreenCanvasContext.drawImage(q,0,0,q.width,q.height);let ie=this.offscreenCanvasContext.getImageData(-$,-$,q.width+2*$,q.height+2*$);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ie}}n.bp.setPbf(n.bq);class We{constructor(q){this._mrt=new n.bp(q.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=q.uid,this.tileID=q.tileID,this.source=q.source}parse(q,$){let ie=this._mrt;this.status="parsing",this._entireBuffer=q;try{ie.parseHeader(q),this._isHeaderLoaded=!0;let fe=[];for(let re in ie.layers){let ye=ie.getLayer(re),De=ye.getDataRange(ye.getBandList()),be=ie.createDecodingTask(De),Le=q.slice(De.firstByte,De.lastByte+1),st=n.bp.performDecoding(Le,be).then(He=>be.complete(null,He)).catch(He=>be.complete(He,null));fe.push(st)}Promise.allSettled(fe).then(()=>$(null,ie)).catch(re=>$(re))}catch(fe){$(fe)}}}class ft{constructor(q){this.actor=q,this.loading={},this.loaded={}}loadTile(q,$){let ie=q.uid,fe=q.request,re=this.loading[ie]=new We(q),{cancel:ye}=n.br(fe,(De,be,Le,st)=>{let He=!this.loading[ie];if(delete this.loading[ie],He||De||!be)return re.status="done",He||(this.loaded[ie]=re),$(De);re.parse(be,(kt,Ht)=>{if(kt||!Ht)return $(kt);$(null,Ht,Le,st)}),this.loaded[ie]=re});re.abort=ye}reloadTile(q,$){$(null,void 0)}abortTile(q,$){let ie=q.uid,fe=this.loading[ie];fe&&(fe.abort&&fe.abort(),delete this.loading[ie]),$()}removeTile(q,$){let ie=q.uid;this.loaded[ie]&&delete this.loaded[ie],$()}decodeRasterArray(q,$){n.bp.performDecoding(q.buffer,q.task).then(ie=>$(null,ie)).catch(ie=>$(ie))}}let _t=n.fq.prototype.toGeoJSON;class Pt{constructor(q){this._feature=q,this.extent=n.aj,this.type=q.type,this.properties=q.tags,"id"in q&&!isNaN(q.id)&&(this.id=parseInt(q.id,10))}loadGeometry(){if(this._feature.type===1){let q=[];for(let $ of this._feature.geometry)q.push([new n.P($[0],$[1])]);return q}{let q=[];for(let $ of this._feature.geometry){let ie=[];for(let fe of $)ie.push(new n.P(fe[0],fe[1]));q.push(ie)}return q}}toGeoJSON(q,$,ie){return _t.call(this,q,$,ie)}}class At{constructor(q,$){this.name=q,this.extent=n.aj,this.length=$.length,this._jsonFeatures=$}feature(q){return new Pt(this._jsonFeatures[q])}}class wt{constructor(q){this.layers={},this.extent=n.aj;for(let $ of Object.keys(q))this.layers[$]=new At($,q[$])}}let Ct=64/4096,Ft=128;class Wt{constructor(){this.features=new Map}clear(){this.features.clear()}load(q=[],$){for(let ie of q){let fe=ie.id;if(fe==null)continue;let re=this.features.get(fe);re&&this.updateCache(re,$),ie.geometry?(re=er(ie),this.updateCache(re,$),this.features.set(fe,re)):this.features.delete(fe),this.updateCache(re,$)}}updateCache(q,$){for(let{canonical:ie,uid:fe}of Object.values($)){let{z:re,x:ye,y:De}=ie;mt(q,Math.pow(2,re),ye,De)&&delete $[fe]}}getTile(q,$,ie){let fe=Math.pow(2,q),re=[];for(let ye of this.features.values())mt(ye,fe,$,ie)&&re.push(vi(ye,fe,$,ie));return{features:re}}getFeatures(){return[...this.features.values()]}}function mt({minX:Re,minY:q,maxX:$,maxY:ie},fe,re,ye){return Re<(re+1+Ct)/fe&&q<(ye+1+Ct)/fe&&$>(re-Ct)/fe&&ie>(ye-Ct)/fe}function er(Re){let{id:q,geometry:$,properties:ie}=Re;if(!$)return;if($.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");let{type:fe,coordinates:re}=$,ye={id:q,type:1,geometry:[],tags:ie,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},De=ye.geometry;if(fe==="Point")Ni(re,De,ye);else if(fe==="MultiPoint")for(let be of re)Ni(be,De,ye);else if(fe==="LineString")ye.type=2,yi(re,De,ye);else if(fe==="MultiLineString")ye.type=2,mi(re,De,ye);else if(fe==="Polygon")ye.type=3,mi(re,De,ye,!0);else{if(fe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");ye.type=3;for(let be of re)mi(be,De,ye,!0)}return ye}function Ni([Re,q],$,ie){let fe=n.aD(Re),re=n.aH(q);re=re<0?0:re>1?1:re,$.push(fe,re),ie.minX=Math.min(ie.minX,fe),ie.minY=Math.min(ie.minY,re),ie.maxX=Math.max(ie.maxX,fe),ie.maxY=Math.max(ie.maxY,re)}function yi(Re,q,$,ie=!1,fe=!1){let re=[];for(let ye of Re)Ni(ye,re,$);q.push(re),ie&&function(ye,De){let be=0;for(let Le=0,st=ye.length,He=st-2;Le<st;He=Le,Le+=2)be+=(ye[Le]-ye[He])*(ye[Le+1]+ye[He+1]);if(be>0===De)for(let Le=0,st=ye.length;Le<st/2;Le+=2){let He=ye[Le],kt=ye[Le+1];ye[Le]=ye[st-2-Le],ye[Le+1]=ye[st-1-Le],ye[st-2-Le]=He,ye[st-1-Le]=kt}}(re,fe)}function mi(Re,q,$,ie=!1){for(let fe=0;fe<Re.length;fe++)yi(Re[fe],q,$,ie,fe===0)}function vi(Re,q,$,ie){let{id:fe,type:re,geometry:ye,tags:De}=Re,be=[];if(re===1)(function(Le,st,He,kt,Ht){for(let Xt=0;Xt<Le.length;Xt+=2){let ui=Math.round(n.aj*(Le[Xt+0]*st-He)),si=Math.round(n.aj*(Le[Xt+1]*st-kt));Ht.push([ui,si])}})(ye,q,$,ie,be);else for(let Le of ye)mr(Le,q,$,ie,be);return{id:fe,type:re,geometry:be,tags:De}}function mr(Re,q,$,ie,fe){let re=-Ft,ye=n.aj+Ft,De;for(let be=0;be<Re.length-2;be+=2){let Le=Math.round(n.aj*(Re[be+0]*q-$)),st=Math.round(n.aj*(Re[be+1]*q-ie)),He=Math.round(n.aj*(Re[be+2]*q-$)),kt=Math.round(n.aj*(Re[be+3]*q-ie)),Ht=He-Le,Xt=kt-st;Le<re&&He<re||(Le<re?(st+=Math.round(Xt*((re-Le)/Ht)),Le=re):He<re&&(kt=st+Math.round(Xt*((re-Le)/Ht)),He=re),st<re&&kt<re||(st<re?(Le+=Math.round(Ht*((re-st)/Xt)),st=re):kt<re&&(He=Le+Math.round(Ht*((re-st)/Xt)),kt=re),Le>=ye&&He>=ye||(Le>=ye?(st+=Math.round(Xt*((ye-Le)/Ht)),Le=ye):He>=ye&&(kt=st+Math.round(Xt*((ye-Le)/Ht)),He=ye),st>=ye&&kt>=ye||(st>=ye?(Le+=Math.round(Ht*((ye-st)/Xt)),st=ye):kt>=ye&&(He=Le+Math.round(Ht*((ye-st)/Xt)),kt=ye),De&&Le===De[De.length-1][0]&&st===De[De.length-1][1]||(De=[[Le,st]],fe.push(De)),De.push([He,kt])))))}}function Fr({name:Re,features:q},$){$.writeStringField(1,Re),$.writeVarintField(5,n.aj);let ie=new Map,fe=new Map,re={keys:ie,values:fe,feature:null};for(let ye of q)re.feature=ye,$.writeMessage(2,Rr,re);for(let ye of ie.keys())$.writeStringField(3,ye);for(let ye of fe.keys())$.writeMessage(4,Ro,ye)}function Rr(Re,q){let $=Re.feature;$.id===void 0||isNaN(+$.id)||q.writeVarintField(1,+$.id),$.tags&&q.writeMessage(2,Hr,Re),q.writeVarintField(3,$.type),q.writeMessage(4,Po,$)}function Hr({keys:Re,values:q,feature:$},ie){for(let fe of Object.keys($.tags)){let re=$.tags[fe];if(re===null)continue;let ye=Re.get(fe);ye===void 0&&(ye=Re.size,Re.set(fe,ye)),ie.writeVarint(ye);let De=typeof re;De!=="string"&&De!=="boolean"&&De!=="number"&&(re=JSON.stringify(re));let be=q.get(re);be===void 0&&(be=q.size,q.set(re,be)),ie.writeVarint(be)}}function Xi(Re,q){return(q<<3)+(7&Re)}function tn(Re){return Re<<1^Re>>31}function Po(Re,q){let{geometry:$,type:ie}=Re,fe=0,re=0;if(ie===1){q.writeVarint(Xi(1,$.length));for(let ye of $){let De=ye[0]-fe,be=ye[1]-re;q.writeVarint(tn(De)),q.writeVarint(tn(be)),fe+=De,re+=be}}else for(let ye of $){q.writeVarint(Xi(1,1));let De=ye.length-(ie===3?1:0);for(let be=0;be<De;be++){be===1&&q.writeVarint(Xi(2,De-1));let Le=ye[be][0]-fe,st=ye[be][1]-re;q.writeVarint(tn(Le)),q.writeVarint(tn(st)),fe+=Le,re+=st}ie===3&&q.writeVarint(Xi(7,1))}}function Ro(Re,q){let $=typeof Re;$==="string"?q.writeStringField(1,Re):$==="boolean"?q.writeBooleanField(7,Re):$==="number"&&(Re%1!=0?q.writeDoubleField(3,Re):Re<0?q.writeSVarintField(6,Re):q.writeVarintField(5,Re))}let Zo={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Re=>Re},Oi=Math.fround||(or=new Float32Array(1),Re=>(or[0]=+Re,or[0]));var or;let Vr=3,Nn=5,Lr=6;class Fs{constructor(q){this.options=Object.assign(Object.create(Zo),q),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(q){let{log:$,minZoom:ie,maxZoom:fe}=this.options;$&&console.time("total time");let re=`prepare ${q.length} points`;$&&console.time(re),this.points=q;let ye=[];for(let be=0;be<q.length;be++){let Le=q[be];if(!Le.geometry)continue;let[st,He]=Le.geometry.coordinates,kt=Oi(Lo(st)),Ht=Oi(zr(He));ye.push(kt,Ht,1/0,be,-1,1),this.options.reduce&&ye.push(0)}let De=this.trees[fe+1]=this._createTree(ye);$&&console.timeEnd(re);for(let be=fe;be>=ie;be--){let Le=+Date.now();De=this.trees[be]=this._createTree(this._cluster(De,be)),$&&console.log("z%d: %d clusters in %dms",be,De.numItems,+Date.now()-Le)}return $&&console.timeEnd("total time"),this}getClusters(q,$){let ie=((q[0]+180)%360+360)%360-180,fe=Math.max(-90,Math.min(90,q[1])),re=q[2]===180?180:((q[2]+180)%360+360)%360-180,ye=Math.max(-90,Math.min(90,q[3]));if(q[2]-q[0]>=360)ie=-180,re=180;else if(ie>re){let He=this.getClusters([ie,fe,180,ye],$),kt=this.getClusters([-180,fe,re,ye],$);return He.concat(kt)}let De=this.trees[this._limitZoom($)],be=De.range(Lo(ie),zr(ye),Lo(re),zr(fe)),Le=De.data,st=[];for(let He of be){let kt=this.stride*He;st.push(Le[kt+Nn]>1?Bs(Le,kt,this.clusterProps):this.points[Le[kt+Vr]])}return st}getChildren(q){let $=this._getOriginId(q),ie=this._getOriginZoom(q),fe="No cluster with the specified id.",re=this.trees[ie];if(!re)throw new Error(fe);let ye=re.data;if($*this.stride>=ye.length)throw new Error(fe);let De=this.options.radius/(this.options.extent*Math.pow(2,ie-1)),be=re.within(ye[$*this.stride],ye[$*this.stride+1],De),Le=[];for(let st of be){let He=st*this.stride;ye[He+4]===q&&Le.push(ye[He+Nn]>1?Bs(ye,He,this.clusterProps):this.points[ye[He+Vr]])}if(Le.length===0)throw new Error(fe);return Le}getLeaves(q,$,ie){let fe=[];return this._appendLeaves(fe,q,$=$||10,ie=ie||0,0),fe}getTile(q,$,ie){let fe=this.trees[this._limitZoom(q)],re=Math.pow(2,q),{extent:ye,radius:De}=this.options,be=De/ye,Le=(ie-be)/re,st=(ie+1+be)/re,He={features:[]};return this._addTileFeatures(fe.range(($-be)/re,Le,($+1+be)/re,st),fe.data,$,ie,re,He),$===0&&this._addTileFeatures(fe.range(1-be/re,Le,1,st),fe.data,re,ie,re,He),$===re-1&&this._addTileFeatures(fe.range(0,Le,be/re,st),fe.data,-1,ie,re,He),He.features.length?He:null}getClusterExpansionZoom(q){let $=this._getOriginZoom(q)-1;for(;$<=this.options.maxZoom;){let ie=this.getChildren(q);if($++,ie.length!==1)break;q=ie[0].properties.cluster_id}return $}_appendLeaves(q,$,ie,fe,re){let ye=this.getChildren($);for(let De of ye){let be=De.properties;if(be&&be.cluster?re+be.point_count<=fe?re+=be.point_count:re=this._appendLeaves(q,be.cluster_id,ie,fe,re):re<fe?re++:q.push(De),q.length===ie)break}return re}_createTree(q){let $=new n.c0(q.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ie=0;ie<q.length;ie+=this.stride)$.add(q[ie],q[ie+1]);return $.finish(),$.data=q,$}_addTileFeatures(q,$,ie,fe,re,ye){for(let De of q){let be=De*this.stride,Le=$[be+Nn]>1,st,He,kt;if(Le)st=oc($,be,this.clusterProps),He=$[be],kt=$[be+1];else{let ui=this.points[$[be+Vr]];st=ui.properties;let[si,di]=ui.geometry.coordinates;He=Lo(si),kt=zr(di)}let Ht={type:1,geometry:[[Math.round(this.options.extent*(He*re-ie)),Math.round(this.options.extent*(kt*re-fe))]],tags:st},Xt;Xt=Le||this.options.generateId?$[be+Vr]:this.points[$[be+Vr]].id,Xt!==void 0&&(Ht.id=Xt),ye.features.push(Ht)}}_limitZoom(q){return Math.max(this.options.minZoom,Math.min(Math.floor(+q),this.options.maxZoom+1))}_cluster(q,$){let{radius:ie,extent:fe,reduce:re,minPoints:ye}=this.options,De=ie/(fe*Math.pow(2,$)),be=q.data,Le=[],st=this.stride;for(let He=0;He<be.length;He+=st){if(be[He+2]<=$)continue;be[He+2]=$;let kt=be[He],Ht=be[He+1],Xt=q.within(be[He],be[He+1],De),ui=be[He+Nn],si=ui;for(let di of Xt){let Yi=di*st;be[Yi+2]>$&&(si+=be[Yi+Nn])}if(si>ui&&si>=ye){let di,Yi=kt*ui,pi=Ht*ui,Mr=-1,Qr=(He/st<<5)+($+1)+this.points.length;for(let $r of Xt){let Hi=$r*st;if(be[Hi+2]<=$)continue;be[Hi+2]=$;let Pi=be[Hi+Nn];Yi+=be[Hi]*Pi,pi+=be[Hi+1]*Pi,be[Hi+4]=Qr,re&&(di||(di=this._map(be,He,!0),Mr=this.clusterProps.length,this.clusterProps.push(di)),re(di,this._map(be,Hi)))}be[He+4]=Qr,Le.push(Yi/si,pi/si,1/0,Qr,-1,si),re&&Le.push(Mr)}else{for(let di=0;di<st;di++)Le.push(be[He+di]);if(si>1)for(let di of Xt){let Yi=di*st;if(!(be[Yi+2]<=$)){be[Yi+2]=$;for(let pi=0;pi<st;pi++)Le.push(be[Yi+pi])}}}}return Le}_getOriginId(q){return q-this.points.length>>5}_getOriginZoom(q){return(q-this.points.length)%32}_map(q,$,ie){if(q[$+Nn]>1){let ye=this.clusterProps[q[$+Lr]];return ie?Object.assign({},ye):ye}let fe=this.points[q[$+Vr]].properties,re=this.options.map(fe);return ie&&re===fe?Object.assign({},re):re}}function Bs(Re,q,$){return{type:"Feature",id:Re[q+Vr],properties:oc(Re,q,$),geometry:{type:"Point",coordinates:[(ie=Re[q],360*(ie-.5)),Vn(Re[q+1])]}};var ie}function oc(Re,q,$){let ie=Re[q+Nn],fe=ie>=1e4?`${Math.round(ie/1e3)}k`:ie>=1e3?Math.round(ie/100)/10+"k":ie,re=Re[q+Lr],ye=re===-1?{}:Object.assign({},$[re]);return Object.assign(ye,{cluster:!0,cluster_id:Re[q+Vr],point_count:ie,point_count_abbreviated:fe})}function Lo(Re){return Re/360+.5}function zr(Re){let q=Math.sin(Re*Math.PI/180),$=.5-.25*Math.log((1+q)/(1-q))/Math.PI;return $<0?0:$>1?1:$}function Vn(Re){let q=(180-360*Re)*Math.PI/180;return 360*Math.atan(Math.exp(q))/Math.PI-90}function Ns(Re,q,$,ie){let fe=ie,re=q+($-q>>1),ye,De=$-q,be=Re[q],Le=Re[q+1],st=Re[$],He=Re[$+1];for(let kt=q+3;kt<$;kt+=3){let Ht=sc(Re[kt],Re[kt+1],be,Le,st,He);if(Ht>fe)ye=kt,fe=Ht;else if(Ht===fe){let Xt=Math.abs(kt-re);Xt<De&&(ye=kt,De=Xt)}}fe>ie&&(ye-q>3&&Ns(Re,q,ye,ie),Re[ye+2]=fe,$-ye>3&&Ns(Re,ye,$,ie))}function sc(Re,q,$,ie,fe,re){let ye=fe-$,De=re-ie;if(ye!==0||De!==0){let be=((Re-$)*ye+(q-ie)*De)/(ye*ye+De*De);be>1?($=fe,ie=re):be>0&&($+=ye*be,ie+=De*be)}return ye=Re-$,De=q-ie,ye*ye+De*De}function vs(Re,q,$,ie){let fe={id:Re??null,type:q,geometry:$,tags:ie,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(q==="Point"||q==="MultiPoint"||q==="LineString")co(fe,$);else if(q==="Polygon")co(fe,$[0]);else if(q==="MultiLineString")for(let re of $)co(fe,re);else if(q==="MultiPolygon")for(let re of $)co(fe,re[0]);return fe}function co(Re,q){for(let $=0;$<q.length;$+=3)Re.minX=Math.min(Re.minX,q[$]),Re.minY=Math.min(Re.minY,q[$+1]),Re.maxX=Math.max(Re.maxX,q[$]),Re.maxY=Math.max(Re.maxY,q[$+1])}function Kn(Re,q,$,ie){if(!q.geometry)return;let fe=q.geometry.coordinates;if(fe&&fe.length===0)return;let re=q.geometry.type,ye=Math.pow($.tolerance/((1<<$.maxZoom)*$.extent),2),De=[],be=q.id;if($.promoteId?be=q.properties[$.promoteId]:$.generateId&&(be=ie||0),re==="Point")bs(fe,De);else if(re==="MultiPoint")for(let Le of fe)bs(Le,De);else if(re==="LineString")ws(fe,De,ye,!1);else if(re==="MultiLineString"){if($.lineMetrics){for(let Le of fe)De=[],ws(Le,De,ye,!1),Re.push(vs(be,"LineString",De,q.properties));return}va(fe,De,ye,!1)}else if(re==="Polygon")va(fe,De,ye,!0);else{if(re!=="MultiPolygon"){if(re==="GeometryCollection"){for(let Le of q.geometry.geometries)Kn(Re,{id:be,geometry:Le,properties:q.properties},$,ie);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let Le of fe){let st=[];va(Le,st,ye,!0),De.push(st)}}Re.push(vs(be,re,De,q.properties))}function bs(Re,q){q.push(Ka(Re[0]),Un(Re[1]),0)}function ws(Re,q,$,ie){let fe,re,ye=0;for(let be=0;be<Re.length;be++){let Le=Ka(Re[be][0]),st=Un(Re[be][1]);q.push(Le,st,0),be>0&&(ye+=ie?(fe*st-Le*re)/2:Math.sqrt(Math.pow(Le-fe,2)+Math.pow(st-re,2))),fe=Le,re=st}let De=q.length-3;q[2]=1,Ns(q,0,De,$),q[De+2]=1,q.size=Math.abs(ye),q.start=0,q.end=q.size}function va(Re,q,$,ie){for(let fe=0;fe<Re.length;fe++){let re=[];ws(Re[fe],re,$,ie),q.push(re)}}function Ka(Re){return Re/360+.5}function Un(Re){let q=Math.sin(Re*Math.PI/180),$=.5-.25*Math.log((1+q)/(1-q))/Math.PI;return $<0?0:$>1?1:$}function ho(Re,q,$,ie,fe,re,ye,De){if(ie/=q,re>=($/=q)&&ye<ie)return Re;if(ye<$||re>=ie)return null;let be=[];for(let Le of Re){let st=Le.geometry,He=Le.type,kt=fe===0?Le.minX:Le.minY,Ht=fe===0?Le.maxX:Le.maxY;if(kt>=$&&Ht<ie){be.push(Le);continue}if(Ht<$||kt>=ie)continue;let Xt=[];if(He==="Point"||He==="MultiPoint")ac(st,Xt,$,ie,fe);else if(He==="LineString")Ts(st,Xt,$,ie,fe,!1,De.lineMetrics);else if(He==="MultiLineString")Sn(st,Xt,$,ie,fe,!1);else if(He==="Polygon")Sn(st,Xt,$,ie,fe,!0);else if(He==="MultiPolygon")for(let ui of st){let si=[];Sn(ui,si,$,ie,fe,!0),si.length&&Xt.push(si)}if(Xt.length){if(De.lineMetrics&&He==="LineString"){for(let ui of Xt)be.push(vs(Le.id,He,ui,Le.tags));continue}He!=="LineString"&&He!=="MultiLineString"||(Xt.length===1?(He="LineString",Xt=Xt[0]):He="MultiLineString"),He!=="Point"&&He!=="MultiPoint"||(He=Xt.length===3?"Point":"MultiPoint"),be.push(vs(Le.id,He,Xt,Le.tags))}}return be.length?be:null}function ac(Re,q,$,ie,fe){for(let re=0;re<Re.length;re+=3){let ye=Re[re+fe];ye>=$&&ye<=ie&&uo(q,Re[re],Re[re+1],Re[re+2])}}function Ts(Re,q,$,ie,fe,re,ye){let De=Ja(Re),be=fe===0?Vs:Ss,Le,st,He=Re.start;for(let si=0;si<Re.length-3;si+=3){let di=Re[si],Yi=Re[si+1],pi=Re[si+2],Mr=Re[si+3],Qr=Re[si+4],$r=fe===0?di:Yi,Hi=fe===0?Mr:Qr,Pi=!1;ye&&(Le=Math.sqrt(Math.pow(di-Mr,2)+Math.pow(Yi-Qr,2))),$r<$?Hi>$&&(st=be(De,di,Yi,Mr,Qr,$),ye&&(De.start=He+Le*st)):$r>ie?Hi<ie&&(st=be(De,di,Yi,Mr,Qr,ie),ye&&(De.start=He+Le*st)):uo(De,di,Yi,pi),Hi<$&&$r>=$&&(st=be(De,di,Yi,Mr,Qr,$),Pi=!0),Hi>ie&&$r<=ie&&(st=be(De,di,Yi,Mr,Qr,ie),Pi=!0),!re&&Pi&&(ye&&(De.end=He+Le*st),q.push(De),De=Ja(Re)),ye&&(He+=Le)}let kt=Re.length-3,Ht=Re[kt],Xt=Re[kt+1],ui=fe===0?Ht:Xt;ui>=$&&ui<=ie&&uo(De,Ht,Xt,Re[kt+2]),kt=De.length-3,re&&kt>=3&&(De[kt]!==De[0]||De[kt+1]!==De[1])&&uo(De,De[0],De[1],De[2]),De.length&&q.push(De)}function Ja(Re){let q=[];return q.size=Re.size,q.start=Re.start,q.end=Re.end,q}function Sn(Re,q,$,ie,fe,re){for(let ye of Re)Ts(ye,q,$,ie,fe,re,!1)}function uo(Re,q,$,ie){Re.push(q,$,ie)}function Vs(Re,q,$,ie,fe,re){let ye=(re-q)/(ie-q);return uo(Re,re,$+(fe-$)*ye,1),ye}function Ss(Re,q,$,ie,fe,re){let ye=(re-$)/(fe-$);return uo(Re,q+(ie-q)*ye,re,1),ye}function Us(Re,q){let $=[];for(let ie=0;ie<Re.length;ie++){let fe=Re[ie],re=fe.type,ye;if(re==="Point"||re==="MultiPoint"||re==="LineString")ye=js(fe.geometry,q);else if(re==="MultiLineString"||re==="Polygon"){ye=[];for(let De of fe.geometry)ye.push(js(De,q))}else if(re==="MultiPolygon"){ye=[];for(let De of fe.geometry){let be=[];for(let Le of De)be.push(js(Le,q));ye.push(be)}}$.push(vs(fe.id,re,ye,fe.tags))}return $}function js(Re,q){let $=[];$.size=Re.size,Re.start!==void 0&&($.start=Re.start,$.end=Re.end);for(let ie=0;ie<Re.length;ie+=3)$.push(Re[ie]+q,Re[ie+1],Re[ie+2]);return $}function Qa(Re,q){if(Re.transformed)return Re;let $=1<<Re.z,ie=Re.x,fe=Re.y;for(let re of Re.features){let ye=re.geometry,De=re.type;if(re.geometry=[],De===1)for(let be=0;be<ye.length;be+=2)re.geometry.push(hr(ye[be],ye[be+1],q,$,ie,fe));else for(let be=0;be<ye.length;be++){let Le=[];for(let st=0;st<ye[be].length;st+=2)Le.push(hr(ye[be][st],ye[be][st+1],q,$,ie,fe));re.geometry.push(Le)}}return Re.transformed=!0,Re}function hr(Re,q,$,ie,fe,re){return[Math.round($*(Re*ie-fe)),Math.round($*(q*ie-re))]}function lc(Re,q,$,ie,fe){let re=q===fe.maxZoom?0:fe.tolerance/((1<<q)*fe.extent),ye={features:[],numPoints:0,numSimplified:0,numFeatures:Re.length,source:null,x:$,y:ie,z:q,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let De of Re)cc(ye,De,re,fe);return ye}function cc(Re,q,$,ie){let fe=q.geometry,re=q.type,ye=[];if(Re.minX=Math.min(Re.minX,q.minX),Re.minY=Math.min(Re.minY,q.minY),Re.maxX=Math.max(Re.maxX,q.maxX),Re.maxY=Math.max(Re.maxY,q.maxY),re==="Point"||re==="MultiPoint")for(let De=0;De<fe.length;De+=3)ye.push(fe[De],fe[De+1]),Re.numPoints++,Re.numSimplified++;else if(re==="LineString")po(ye,fe,Re,$,!1,!1);else if(re==="MultiLineString"||re==="Polygon")for(let De=0;De<fe.length;De++)po(ye,fe[De],Re,$,re==="Polygon",De===0);else if(re==="MultiPolygon")for(let De=0;De<fe.length;De++){let be=fe[De];for(let Le=0;Le<be.length;Le++)po(ye,be[Le],Re,$,!0,Le===0)}if(ye.length){let De=q.tags||null;if(re==="LineString"&&ie.lineMetrics){De={};for(let Le in q.tags)De[Le]=q.tags[Le];De.mapbox_clip_start=fe.start/fe.size,De.mapbox_clip_end=fe.end/fe.size}let be={geometry:ye,type:re==="Polygon"||re==="MultiPolygon"?3:re==="LineString"||re==="MultiLineString"?2:1,tags:De};q.id!==null&&(be.id=q.id),Re.features.push(be)}}function po(Re,q,$,ie,fe,re){let ye=ie*ie;if(ie>0&&q.size<(fe?ye:ie))return void($.numPoints+=q.length/3);let De=[];for(let be=0;be<q.length;be+=3)(ie===0||q[be+2]>ye)&&($.numSimplified++,De.push(q[be],q[be+1])),$.numPoints++;fe&&function(be,Le){let st=0;for(let He=0,kt=be.length,Ht=kt-2;He<kt;Ht=He,He+=2)st+=(be[He]-be[Ht])*(be[He+1]+be[Ht+1]);if(st>0===Le)for(let He=0,kt=be.length;He<kt/2;He+=2){let Ht=be[He],Xt=be[He+1];be[He]=be[kt-2-He],be[He+1]=be[kt-1-He],be[kt-2-He]=Ht,be[kt-1-He]=Xt}}(De,re),Re.push(De)}let hc={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class ld{constructor(q,$){let ie=($=this.options=function(re,ye){for(let De in ye)re[De]=ye[De];return re}(Object.create(hc),$)).debug;if(ie&&console.time("preprocess data"),$.maxZoom<0||$.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if($.promoteId&&$.generateId)throw new Error("promoteId and generateId cannot be used together.");let fe=function(re,ye){let De=[];if(re.type==="FeatureCollection")for(let be=0;be<re.features.length;be++)Kn(De,re.features[be],ye,be);else Kn(De,re.type==="Feature"?re:{geometry:re},ye);return De}(q,$);this.tiles={},this.tileCoords=[],ie&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",$.indexMaxZoom,$.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),fe=function(re,ye){let De=ye.buffer/ye.extent,be=re,Le=ho(re,1,-1-De,De,0,-1,2,ye),st=ho(re,1,1-De,2+De,0,-1,2,ye);return(Le||st)&&(be=ho(re,1,-De,1+De,0,-1,2,ye)||[],Le&&(be=Us(Le,1).concat(be)),st&&(be=be.concat(Us(st,-1)))),be}(fe,$),fe.length&&this.splitTile(fe,0,0,0),ie&&(fe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(q,$,ie,fe,re,ye,De){let be=[q,$,ie,fe],Le=this.options,st=Le.debug;for(;be.length;){fe=be.pop(),ie=be.pop(),$=be.pop(),q=be.pop();let He=1<<$,kt=el($,ie,fe),Ht=this.tiles[kt];if(!Ht&&(st>1&&console.time("creation"),Ht=this.tiles[kt]=lc(q,$,ie,fe,Le),this.tileCoords.push({z:$,x:ie,y:fe}),st)){st>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",$,ie,fe,Ht.numFeatures,Ht.numPoints,Ht.numSimplified),console.timeEnd("creation"));let Pi=`z${$}`;this.stats[Pi]=(this.stats[Pi]||0)+1,this.total++}if(Ht.source=q,re==null){if($===Le.indexMaxZoom||Ht.numPoints<=Le.indexMaxPoints)continue}else{if($===Le.maxZoom||$===re)continue;if(re!=null){let Pi=re-$;if(ie!==ye>>Pi||fe!==De>>Pi)continue}}if(Ht.source=null,q.length===0)continue;st>1&&console.time("clipping");let Xt=.5*Le.buffer/Le.extent,ui=.5-Xt,si=.5+Xt,di=1+Xt,Yi=null,pi=null,Mr=null,Qr=null,$r=ho(q,He,ie-Xt,ie+si,0,Ht.minX,Ht.maxX,Le),Hi=ho(q,He,ie+ui,ie+di,0,Ht.minX,Ht.maxX,Le);q=null,$r&&(Yi=ho($r,He,fe-Xt,fe+si,1,Ht.minY,Ht.maxY,Le),pi=ho($r,He,fe+ui,fe+di,1,Ht.minY,Ht.maxY,Le),$r=null),Hi&&(Mr=ho(Hi,He,fe-Xt,fe+si,1,Ht.minY,Ht.maxY,Le),Qr=ho(Hi,He,fe+ui,fe+di,1,Ht.minY,Ht.maxY,Le),Hi=null),st>1&&console.timeEnd("clipping"),be.push(Yi||[],$+1,2*ie,2*fe),be.push(pi||[],$+1,2*ie,2*fe+1),be.push(Mr||[],$+1,2*ie+1,2*fe),be.push(Qr||[],$+1,2*ie+1,2*fe+1)}}getTile(q,$,ie){q=+q,$=+$,ie=+ie;let fe=this.options,{extent:re,debug:ye}=fe;if(q<0||q>24)return null;let De=1<<q,be=el(q,$=$+De&De-1,ie);if(this.tiles[be])return Qa(this.tiles[be],re);ye>1&&console.log("drilling down to z%d-%d-%d",q,$,ie);let Le,st=q,He=$,kt=ie;for(;!Le&&st>0;)st--,He>>=1,kt>>=1,Le=this.tiles[el(st,He,kt)];return Le&&Le.source?(ye>1&&(console.log("found parent tile z%d-%d-%d",st,He,kt),console.time("drilling down")),this.splitTile(Le.source,st,He,kt,q,$,ie),ye>1&&console.timeEnd("drilling down"),this.tiles[be]?Qa(this.tiles[be],re):null):null}}function el(Re,q,$){return 32*((1<<Re)*$+q)+Re}function Qe(Re,q){let $=Re.tileID.canonical;if(!this._geoJSONIndex)return void q(null,null);let ie=this._geoJSONIndex.getTile($.z,$.x,$.y);if(!ie)return void q(null,null);let fe=Le=>Le.tags&&"3d_elevation_id"in Le.tags&&"source"in Le.tags&&Le.tags.source==="elevation",re=ie.features.filter(Le=>fe(Le)),ye={_geojsonTileLayer:ie.features};re.length>0&&(ye={_geojsonTileLayer:ie.features.filter(Le=>!fe(Le)),hd_road_elevation:re});let De=new wt(ye),be=function(Le){let st=new n.bq;for(let He of Object.keys(Le))st.writeMessage(3,Fr,{name:He,features:Le[He]});return st.finish()}(ye).buffer;q(null,{vectorTile:De,rawData:be})}class Es extends Ge{constructor(q,$,ie,fe,re,ye,De){super(q,$,ie,fe,re,Qe,De),ye&&(this.loadGeoJSON=ye),this._dynamicIndex=new Wt}loadData(q,$){let ie=q&&q.request,fe=ie&&ie.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(q,(re,ye)=>{if(re||!ye)return $(re);if(typeof ye!="object")return $(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`));{try{if(q.filter){let be=n.X(q.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(be.result==="error")throw new Error(be.value.map(Le=>`${Le.key}: ${Le.message}`).join(", "));ye.features=ye.features.filter(Le=>be.value.evaluate({zoom:0},Le))}q.dynamic?(ye.type==="Feature"&&(ye={type:"FeatureCollection",features:[ye]}),q.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(ye.features,this.loaded),q.cluster&&(ye.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=q.cluster?new Fs(function({superclusterOptions:be,clusterProperties:Le}){if(!Le||!be)return be;let st={},He={},kt={accumulated:null,zoom:0},Ht={properties:null},Xt=Object.keys(Le);for(let ui of Xt){let[si,di]=Le[ui],Yi=n.X(di),pi=n.X(typeof si=="string"?[si,["accumulated"],["get",ui]]:si);st[ui]=Yi.value,He[ui]=pi.value}return be.map=ui=>{Ht.properties=ui;let si={};for(let di of Xt)si[di]=st[di].evaluate(kt,Ht);return si},be.reduce=(ui,si)=>{Ht.properties=si;for(let di of Xt)kt.accumulated=ui[di],ui[di]=He[di].evaluate(kt,Ht)},be}(q)).load(ye.features):q.dynamic?this._dynamicIndex:function(be,Le){return new ld(be,Le)}(ye,q.geojsonVtOptions)}catch(be){return $(be)}let De={};if(fe){let be=O(ie);be&&(De.resourceTiming={},De.resourceTiming[q.source]=JSON.parse(JSON.stringify(be)))}$(null,De)}})}reloadTile(q,$){let ie=this.loaded;return ie&&ie[q.uid]?q.partial?$(null,void 0):super.reloadTile(q,$):this.loadTile(q,$)}loadGeoJSON(q,$){if(q.request)n.n(q.request,$);else{if(typeof q.data!="string")return $(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return $(null,JSON.parse(q.data))}catch{return $(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(q,$){try{$(null,this._geoJSONIndex.getClusterExpansionZoom(q.clusterId))}catch(ie){$(ie)}}getClusterChildren(q,$){try{$(null,this._geoJSONIndex.getChildren(q.clusterId))}catch(ie){$(ie)}}getClusterLeaves(q,$){try{$(null,this._geoJSONIndex.getLeaves(q.clusterId,q.limit,q.offset))}catch(ie){$(ie)}}}class cd{constructor(q,$,ie){this.tileID=new n.aM(q.tileID.overscaledZ,q.tileID.wrap,q.tileID.canonical.z,q.tileID.canonical.x,q.tileID.canonical.y),this.tileZoom=q.tileZoom,this.uid=q.uid,this.zoom=q.zoom,this.canonical=q.tileID.canonical,this.pixelRatio=q.pixelRatio,this.tileSize=q.tileSize,this.source=q.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=q.projection,this.brightness=$,this.worldview=ie}parse(q,$,ie,fe){this.status="parsing";let re=new n.aM(ie.tileID.overscaledZ,ie.tileID.wrap,ie.tileID.canonical.z,ie.tileID.canonical.x,ie.tileID.canonical.y),ye=[],De=$.familiesBySource[ie.source],be=new n.fc(re,ie.promoteId);be.bucketLayerIDs=[],be.is3DTile=!0,n.fr(q).then(Le=>{if(!Le)return fe(new Error("Could not parse tile"));let st=Le.json.extensionsUsed&&Le.json.extensionsUsed.includes("MAPBOX_mesh_features")||Le.json.asset.extras&&Le.json.asset.extras.MAPBOX_mesh_features,He=Le.json.extensionsUsed&&Le.json.extensionsUsed.includes("EXT_meshopt_compression"),kt=new n.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(let Ht in De)for(let Xt of De[Ht]){let ui=Xt[0];be.bucketLayerIDs.push(Xt.map(Yi=>n.C(Yi.id,Yi.scope))),ui.recalculate(kt,[]);let si=n.fs(Le,1/n.d4(ie.tileID.canonical)),di=new n.ft(Xt,si,re,st,He,this.brightness,be,this.worldview);st||(di.needsUpload=!0),ye.push(di),di.evaluate(ui)}this.status="done",fe(null,{buckets:ye,featureIndex:be,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Le=>fe(new Error(Le.message)))}}class uc{constructor(q,$,ie,fe,re,ye,De,be){this.actor=q,this.layerIndex=$,this.availableImages=ie,this.availableModels=fe,this.brightness=De,this.loading={},this.loaded={},this.worldview=be}loadTile(q,$){let ie=q.uid,fe=this.loading[ie]=new cd(q,this.brightness,this.worldview);n.br(q.request,(re,ye)=>{let De=!this.loading[ie];return delete this.loading[ie],De||re?(fe.status="done",De||(this.loaded[ie]=fe),$(re)):ye&&ye.byteLength!==0?void fe.parse(ye,this.layerIndex,q,(be,Le)=>{fe.status="done",this.loaded=this.loaded||{},this.loaded[ie]=fe,be||!Le?$(be):$(null,Le)}):(fe.status="done",this.loaded[ie]=fe,$())})}reloadTile(q,$){let ie=this.loaded,fe=q.uid;if(ie&&ie[fe]){let re=ie[fe];re.projection=q.projection,re.brightness=q.brightness;let ye=(De,be)=>{re.reloadCallback&&(delete re.reloadCallback,this.loadTile(q,$)),$(De,be)};re.status==="parsing"?re.reloadCallback=ye:re.status==="done"&&this.loadTile(q,$)}}abortTile(q,$){let ie=q.uid;this.loading[ie]&&delete this.loading[ie],$()}removeTile(q,$){let ie=this.loaded,fe=q.uid;ie&&ie[fe]&&delete ie[fe],$()}}class Ai{constructor(q){this.self=q,this.actor=new n.fv(q,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new n.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=n.cj({name:"mercator"}),this.workerSourceTypes={vector:Ge,geojson:Es,"raster-dem":Te,"raster-array":ft,"batched-model":uc},this.workerSources={},this.self.registerWorkerSource=($,ie)=>{if(this.workerSourceTypes[$])throw new Error(`Worker source with name "${$}" already registered.`);this.workerSourceTypes[$]=ie},this.self.registerRTLTextPlugin=$=>{if(n.fw.isParsed())throw new Error("RTL text plugin already registered.");n.fw.setState({pluginStatus:n.fx.parsed,pluginURL:n.fw.getPluginURL()}),n.fw.applyArabicShaping=$.applyArabicShaping,n.fw.processBidirectionalText=$.processBidirectionalText,n.fw.processStyledBidirectionalText=$.processStyledBidirectionalText;for(let ie of this.rtlPluginParsingListeners)ie(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(q,$,ie){delete this.layerIndexes[q],delete this.availableImages[q],delete this.availableModels[q],delete this.workerSources[q],ie()}checkIfReady(q,$,ie){ie()}setReferrer(q,$){this.referrer=$}spriteLoaded(q,$){this.isSpriteLoaded[q]||(this.isSpriteLoaded[q]={});let{scope:ie,isLoaded:fe}=$;if(this.isSpriteLoaded[q][ie]=fe,this.workerSources[q]&&this.workerSources[q][ie])for(let re in this.workerSources[q][ie]){let ye=this.workerSources[q][ie][re];for(let De in ye){let be=ye[De];be instanceof Ge&&(be.isSpriteLoaded=fe,be.fire(new n.A("isSpriteLoaded")))}}}setImages(q,$,ie){this.availableImages[q]||(this.availableImages[q]={});let{scope:fe,images:re}=$;if(this.availableImages[q][fe]=re,this.workerSources[q]&&this.workerSources[q][fe]){for(let ye in this.workerSources[q][fe]){let De=this.workerSources[q][fe][ye];for(let be in De)De[be].availableImages=re}ie()}else ie()}setModels(q,{scope:$,models:ie},fe){if(this.availableModels[q]||(this.availableModels[q]={}),this.availableModels[q][$]=ie,this.workerSources[q]&&this.workerSources[q][$]){for(let re in this.workerSources[q][$]){let ye=this.workerSources[q][$][re];for(let De in ye)ye[De].availableModels=ie}fe()}else fe()}setProjection(q,$){this.projections[q]=n.cj($)}setBrightness(q,$,ie){this.brightness=$,ie()}setWorldview(q,$,ie){this.worldview=$,ie()}setLayers(q,$,ie){this.getLayerIndex(q,$.scope).replace($.layers,$.options),ie()}updateLayers(q,$,ie){this.getLayerIndex(q,$.scope).update($.layers,$.removedIds,$.options),ie()}loadTile(q,$,ie){$.projection=this.projections[q]||this.defaultProjection,this.getWorkerSource(q,$.type,$.source,$.scope).loadTile($,ie)}decodeRasterArray(q,$,ie){this.getWorkerSource(q,$.type,$.source,$.scope).decodeRasterArray($,ie)}reloadTile(q,$,ie){$.projection=this.projections[q]||this.defaultProjection,this.getWorkerSource(q,$.type,$.source,$.scope).reloadTile($,ie)}abortTile(q,$,ie){this.getWorkerSource(q,$.type,$.source,$.scope).abortTile($,ie)}removeTile(q,$,ie){this.getWorkerSource(q,$.type,$.source,$.scope).removeTile($,ie)}removeSource(q,$,ie){if(!(this.workerSources[q]&&this.workerSources[q][$.scope]&&this.workerSources[q][$.scope][$.type]&&this.workerSources[q][$.scope][$.type][$.source]))return;let fe=this.workerSources[q][$.scope][$.type][$.source];delete this.workerSources[q][$.scope][$.type][$.source],fe.removeSource!==void 0?fe.removeSource($,ie):ie()}loadWorkerSource(q,$,ie){try{this.self.importScripts($.url),ie()}catch(fe){ie(fe.toString())}}syncRTLPluginState(q,$,ie){if(n.fw.isParsed())ie(null,!0);else if(n.fw.isParsing())this.rtlPluginParsingListeners.push(ie);else try{n.fw.setState($);let fe=n.fw.getPluginURL();!n.fw.isLoaded()||n.fw.isParsed()||n.fw.isParsing()||fe==null||(n.fw.setState({pluginStatus:n.fx.parsing,pluginURL:n.fw.getPluginURL()}),this.self.importScripts(fe),n.fw.isParsed()?ie(null,!0):this.rtlPluginParsingListeners.push(ie))}catch(fe){ie(fe.toString())}}setDracoUrl(q,$){this.dracoUrl=$}getAvailableImages(q,$){this.availableImages[q]||(this.availableImages[q]={});let ie=this.availableImages[q][$];return ie||(ie=[]),ie}getAvailableModels(q,$){this.availableModels[q]||(this.availableModels[q]={});let ie=this.availableModels[q][$];return ie||(ie={}),ie}getLayerIndex(q,$){this.layerIndexes[q]||(this.layerIndexes[q]={});let ie=this.layerIndexes[q][$];return ie||(ie=this.layerIndexes[q][$]=new J,ie.scope=$),ie}getWorkerSource(q,$,ie,fe){let re=this.workerSources;return re[q]||(re[q]={}),re[q][fe]||(re[q][fe]={}),re[q][fe][$]||(re[q][fe][$]={}),this.isSpriteLoaded[q]||(this.isSpriteLoaded[q]={}),re[q][fe][$][ie]||(re[q][fe][$][ie]=new this.workerSourceTypes[$]({send:(ye,De,be,Le,st,He)=>this.actor.send(ye,De,be,q,st,He),scheduler:this.actor.scheduler},this.getLayerIndex(q,fe),this.getAvailableImages(q,fe),this.getAvailableModels(q,fe),this.isSpriteLoaded[q][fe],void 0,this.brightness,this.worldview)),re[q][fe][$][ie]}rasterizeImagesWorker(q,$,ie){let fe=new Map;for(let[re,{image:ye,imageVariant:De}]of $.tasks.entries()){let be=this.imageRasterizer.rasterize(De,ye,$.scope,q);fe.set(re,be)}ie(void 0,fe)}removeRasterizedImages(q,$,ie){this.imageRasterizer.removeImagesFromCacheByIds($.imageIds,$.scope,q),ie()}enforceCacheSizeLimit(q,$){n.fy($)}getWorkerPerformanceMetrics(q,$,ie){ie(void 0,void 0)}}return n.fu(self)&&(self.worker=new Ai(self)),Ai}),w(["./shared"],function(n){var O="3.14.0";let V={create:"create",load:"load",fullLoad:"fullLoad"},H={mark(l){performance.mark(l)},measure(l,t,o){performance.measure(l,t,o)}};function J(l){let t=l.name.split("?")[0];return n.a(t)&&t.includes("mapbox-gl.js")?"javascript":n.a(t)&&t.includes("mapbox-gl.css")?"css":n.b(t)?"fontRange":n.c(t)?"sprite":n.i(t)?"style":n.d(t)?"tilejson":"other"}var ae,we={},Ae=function(){if(ae)return we;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var p,_,x=new Blob([""],{type:"text/javascript"}),b=URL.createObjectURL(x);try{_=new Worker(b),p=!0}catch{p=!1}return _&&_.terminate(),URL.revokeObjectURL(b),p}()?function(){var p=document.createElement("canvas");p.width=p.height=1;var _=p.getContext("2d");if(!_)return!1;var x=_.getImageData(0,0,1,1);return x&&x.width===p.width}()?(o[d=c&&c.failIfMajorPerformanceCaveat]===void 0&&(o[d]=function(p){var _,x=function(b){var M=document.createElement("canvas"),C=Object.create(l.webGLContextAttributes);return C.failIfMajorPerformanceCaveat=b,M.getContext("webgl2",C)}(p);if(!x)return!1;try{_=x.createShader(x.VERTEX_SHADER)}catch{return!1}return!(!_||x.isContextLost())&&(x.shaderSource(_,"void main() {}"),x.compileShader(_),x.getShaderParameter(_,x.COMPILE_STATUS)===!0)}(d)),o[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}ae=1,we.supported=l,we.notSupportedReason=t;var o={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},we}();function xe(l,t,o){let c=document.createElement(l);return t!=null&&(c.className=t),o&&o.appendChild(c),c}function Ge(l,t,o){let c=document.createElementNS("http://www.w3.org/2000/svg",l);for(let d of Object.keys(t))c.setAttributeNS(null,d,String(t[d]));return o&&o.appendChild(c),c}let Te=typeof document<"u"?document.documentElement&&document.documentElement.style:null,We=Te&&Te.userSelect!==void 0?"userSelect":"WebkitUserSelect",ft;function _t(){Te&&We&&(ft=Te[We],Te[We]="none")}function Pt(){Te&&We&&(Te[We]=ft)}function At(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",At,!0)}function wt(){window.addEventListener("click",At,!0),window.setTimeout(()=>{window.removeEventListener("click",At,!0)},0)}function Ct(l,t){let o=l.getBoundingClientRect();return mt(l,o,t)}function Ft(l,t){let o=l.getBoundingClientRect(),c=[];for(let d=0;d<t.length;d++)c.push(mt(l,o,t[d]));return c}function Wt(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&l.button===2&&l.ctrlKey?0:l.button}function mt(l,t,o){let c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new n.P((o.clientX-t.left)*c,(o.clientY-t.top)*c)}let er="01",Ni="NO_ACCESS_TOKEN";class yi{constructor(t,o,c){this._transformRequestFn=t,this._customAccessToken=o,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){let t=function(){let o="";for(let c=0;c<10;c++)o+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",er,o].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,o){return this._transformRequestFn&&this._transformRequestFn(t,o)||{url:t}}normalizeStyleURL(t,o){if(!n.j(t))return t;let c=vi(t);return c.params.push(`sdk=js-${O}`),c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||o)}normalizeGlyphsURL(t,o){if(!n.j(t))return t;let c=vi(t);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||o)}normalizeModelURL(t,o){if(!n.j(t))return t;let c=vi(t);return c.path=`/models/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||o)}normalizeSourceURL(t,o,c,d){if(!n.j(t))return t;let p=vi(t);return p.path=`/v4/${p.authority}.json`,p.params.push("secure"),c&&p.params.push(`language=${c}`),d&&p.params.push(`worldview=${d}`),this._makeAPIURL(p,this._customAccessToken||o)}normalizeIconsetURL(t,o){let c=vi(t);return n.j(t)?(c.path=`/styles/v1${c.path}/iconset.pbf`,this._makeAPIURL(c,this._customAccessToken||o)):mr(c)}normalizeSpriteURL(t,o,c,d){let p=vi(t);return n.j(t)?(p.path=`/styles/v1${p.path}/sprite${o}${c}`,this._makeAPIURL(p,this._customAccessToken||d)):(p.path+=`${o}${c}`,mr(p))}normalizeTileURL(t,o,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!n.j(t))return t;let d=vi(t);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${o||c&&d.authority!=="raster"&&c===512?"@2x":""}${n.l.supported?".webp":"$1"}`),d.authority==="raster"?d.path=`/${n.e.RASTER_URL_PREFIX}${d.path}`:d.authority==="rasterarrays"?d.path=`/${n.e.RASTERARRAYS_URL_PREFIX}${d.path}`:d.authority==="3dtiles"?d.path=`/${n.e.TILES3D_URL_PREFIX}${d.path}`:(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path=`/${n.e.TILE_URL_VERSION}${d.path}`);let p=this._customAccessToken||function(_){for(let x of _){let b=x.match(/^access_token=(.*)$/);if(b)return b[1]}return null}(d.params)||n.e.ACCESS_TOKEN;return n.e.REQUIRE_ACCESS_TOKEN&&p&&this._skuToken&&d.params.push(`sku=${this._skuToken}`),this._makeAPIURL(d,p)}canonicalizeTileURL(t,o){let c=vi(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let d="mapbox://";c.path.match(/^\/raster\/v1\//)?d+=`raster/${c.path.replace(`/${n.e.RASTER_URL_PREFIX}/`,"")}`:c.path.match(/^\/rasterarrays\/v1\//)?d+=`rasterarrays/${c.path.replace(`/${n.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:d+=`tiles/${c.path.replace(`/${n.e.TILE_URL_VERSION}/`,"")}`;let p=c.params;return o&&(p=p.filter(_=>!_.match(/^access_token=/))),p.length&&(d+=`?${p.join("&")}`),d}canonicalizeTileset(t,o){let c=!!o&&n.j(o),d=[];for(let p of t.tiles||[])n.k(p)?d.push(this.canonicalizeTileURL(p,c)):d.push(p);return d}_makeAPIURL(t,o){let c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",d=vi(n.e.API_URL);if(t.protocol=d.protocol,t.authority=d.authority,t.protocol==="http"){let p=t.params.indexOf("secure");p>=0&&t.params.splice(p,1)}if(d.path!=="/"&&(t.path=`${d.path}${t.path}`),!n.e.REQUIRE_ACCESS_TOKEN)return mr(t);if(o=o||n.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!o)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if(o[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return t.params=t.params.filter(p=>p.indexOf("access_token")===-1),t.params.push(`access_token=${o||""}`),mr(t)}}let mi=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function vi(l){let t=l.match(mi);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function mr(l){let t=l.params.length?`?${l.params.join("&")}`:"";return`${l.protocol}://${l.authority}${l.path}${t}`}let Fr="mapbox.eventData";function Rr(l){if(!l)return null;let t=l.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(n.m(t[1]))}catch{return null}}class Hr{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){let o=Rr(n.e.ACCESS_TOKEN),c="";return c=o&&o.u?n.f(o.u):n.e.ACCESS_TOKEN||"",t?`${Fr}.${t}:${c}`:`${Fr}:${c}`}fetchEventData(){let t=n.s("localStorage"),o=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{let d=localStorage.getItem(o);d&&(this.eventData=JSON.parse(d));let p=localStorage.getItem(c);p&&(this.anonId=p)}catch{n.w("Unable to read from LocalStorage")}}saveEventData(){let t=n.s("localStorage"),o=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.anonId;if(t&&d)try{localStorage.setItem(c,d),Object.keys(this.eventData).length>=1&&localStorage.setItem(o,JSON.stringify(this.eventData))}catch{n.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,o,c,d){if(!n.e.EVENTS_URL)return;let p=vi(n.e.EVENTS_URL);p.params.push(`access_token=${d||n.e.ACCESS_TOKEN||""}`);let _={event:this.type,created:new Date(t).toISOString()},x=o?n.h(_,o):_,b={url:mr(p),headers:{"Content-Type":"text/plain"},body:JSON.stringify([x])};this.pendingRequest=n.p(b,M=>{this.pendingRequest=null,c(M),this.saveEventData(),this.processRequests(d)})}queueRequest(t,o){this.queue.push(t),this.processRequests(o)}}let Xi=new class extends Hr{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){n.e.EVENTS_URL&&n.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some(o=>n.j(o)||n.k(o))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let t=Rr(n.e.ACCESS_TOKEN),o=t?t.u:n.e.ACCESS_TOKEN,c=o!==this.eventData.tokenU;n.v(this.anonId)||(this.anonId=n.u(),c=!0);let d=this.queue.shift();if(this.eventData.lastSuccess){let p=new Date(this.eventData.lastSuccess),_=new Date(d),x=(d-this.eventData.lastSuccess)/864e5;c=c||x>=1||x<-1||p.getDate()!==_.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:O,skuId:er,"enabled.telemetry":!1,userId:this.anonId},p=>{p||(this.eventData.lastSuccess=d,this.eventData.tokenU=o)},l):this.processRequests()}},tn=Xi.postTurnstileEvent.bind(Xi),Po=new class extends Hr{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,o,c){this.skuToken=t,this.errorCb=c,n.e.EVENTS_URL&&(o||n.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},o):this.errorCb(new Error(Ni)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),n.v(this.anonId)||(this.anonId=n.u()),this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:O,skuId:er,skuToken:this.skuToken,userId:this.anonId},c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l))}remove(){this.errorCb=null}},Ro=Po.postMapLoadEvent.bind(Po),Zo=new class extends Hr{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=n.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){let t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){let{map:o,style:c,importedStyles:d}=t;if(!n.e.EVENTS_URL||!l&&!n.e.ACCESS_TOKEN)return;let p=this.getMapInstanceId(o),_={mapInstanceId:p,eventId:this.getEventId(p),style:c};d.length&&(_.importedStyles=d),this.queueRequest({timestamp:Date.now(),payload:_},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,payload:o}=this.queue.shift();this.postEvent(t,o,()=>{},l)}},Oi=Zo.postStyleLoadEvent.bind(Zo),or=new class extends Hr{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){n.e.EVENTS_URL&&(l||n.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,performanceData:o}=this.queue.shift(),c=function(d){let p=performance.getEntriesByType("resource"),_=performance.getEntriesByType("mark"),x=function(D){let N={};if(D){for(let F in D)if(F!=="other")for(let j of D[F]){let U=`${F}ResolveRangeMin`,Z=`${F}ResolveRangeMax`,Y=`${F}RequestCount`,Q=`${F}RequestCachedCount`;N[U]=Math.min(N[U]||1/0,j.startTime),N[Z]=Math.max(N[Z]||-1/0,j.responseEnd);let ne=he=>{N[he]===void 0&&(N[he]=0),++N[he]};j.transferSize!==void 0&&j.transferSize===0&&ne(Q),ne(Y)}}return N}(function(D,N){let F={};if(D)for(let j of D){let U=N(j);F[U]===void 0&&(F[U]=[]),F[U].push(j)}return F}(p,J)),b=window.devicePixelRatio,M=navigator.connection||navigator.mozConnection||navigator.webkitConnection,C=M?M.effectiveType:void 0,z={counters:[],metadata:[],attributes:[]},P=(D,N,F)=>{F!=null&&D.push({name:N,value:F.toString()})};for(let D in x)P(z.counters,D,x[D]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(P(z.counters,"interactionRangeMin",d.interactionRange[0]),P(z.counters,"interactionRangeMax",d.interactionRange[1])),_)for(let D of Object.keys(V)){let N=V[D],F=_.find(j=>j.name===N);F&&P(z.counters,N,F.startTime)}return P(z.counters,"visibilityHidden",d.visibilityHidden),P(z.attributes,"style",function(D){if(D)for(let N of D){let F=N.name.split("?")[0];if(n.i(F)){let j=F.split("/").slice(-2);if(j.length===2)return`mapbox://styles/${j[0]}/${j[1]}`}}}(p)),P(z.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),P(z.attributes,"fogEnabled",d.fogEnabled?"true":"false"),P(z.attributes,"projection",d.projection),P(z.attributes,"zoom",d.zoom),P(z.metadata,"devicePixelRatio",b),P(z.metadata,"connectionEffectiveType",C),P(z.metadata,"navigatorUserAgent",navigator.userAgent),P(z.metadata,"screenWidth",window.screen.width),P(z.metadata,"screenHeight",window.screen.height),P(z.metadata,"windowWidth",window.innerWidth),P(z.metadata,"windowHeight",window.innerHeight),P(z.metadata,"mapWidth",d.width/b),P(z.metadata,"mapHeight",d.height/b),P(z.metadata,"webglRenderer",d.renderer),P(z.metadata,"webglVendor",d.vendor),P(z.metadata,"sdkVersion",O),P(z.metadata,"sdkIdentifier","mapbox-gl-js"),z}(o);for(let d of c.metadata);for(let d of c.counters);for(let d of c.attributes);this.postEvent(t,c,()=>{},l)}},Vr=or.postPerformanceEvent.bind(or),Nn=new class extends Hr{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,o,c){if(!n.e.API_URL||!n.e.SESSION_PATH)return;let d=vi(n.e.API_URL+n.e.SESSION_PATH);d.params.push(`sku=${t||""}`),d.params.push(`access_token=${c||n.e.ACCESS_TOKEN||""}`);let p={url:mr(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=n.g(p,_=>{this.pendingRequest=null,o(_),this.saveEventData(),this.processRequests(c)})}getSessionAPI(l,t,o,c){this.skuToken=t,this.errorCb=c,n.e.SESSION_PATH&&n.e.API_URL&&(o||n.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},o):this.errorCb(new Error(Ni)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||this.getSession(o,this.skuToken,c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l)}remove(){this.errorCb=null}},Lr=Nn.getSessionAPI.bind(Nn),Fs=new Set;function Bs(l,t){t?Fs.add(l):Fs.delete(l)}class oc{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,o){this._updatedSourceCaches[t]=o,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){let o=t.scope;this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._updatedLayers[o].add(t.id),this.setDirty()}removeLayer(t){let o=t.scope;this._removedLayers[o]=this._removedLayers[o]||{},this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._removedLayers[o][t.id]=t,this._updatedLayers[o].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){let t={};for(let o in this._updatedLayers)t[o]=t[o]||{},t[o].updatedIds=Array.from(this._updatedLayers[o].values());for(let o in this._removedLayers)t[o]=t[o]||{},t[o].removedIds=Object.keys(this._removedLayers[o]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,o){this._updatedImages[o]=this._updatedImages[o]||new Set,this._updatedImages[o].add(n.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Lo(l){let{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class zr extends n.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&n.t()&&(this.imageRasterizerDispatcher=new n.D(n.x(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new n.r({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);let o=this.atlasTexture.get(t);o&&(o.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,o){this.imageProviders.has(o)||this.imageProviders.set(o,new Map),this.imageProviders.get(o).set(t.id,t)}removeImageProvider(t,o){this.imageProviders.has(o)&&this.imageProviders.get(o).delete(t)}getPendingImageProviders(){let t=[];for(let o of this.imageProviders.values())for(let c of o.values())c.hasPendingRequests()&&t.push(c);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new n.y),this._imageRasterizer}isLoaded(){for(let t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,o){if(this.loaded.get(o)!==t&&(this.loaded.set(o,t),t)){for(let{ids:c,callback:d}of this.requestors)this._notify(c,o,d);this.requestors=[]}}hasImage(t,o){return!!this.getImage(t,o)}getImage(t,o){return this.images.get(o).get(t.toString())}addImage(t,o,c){this._validate(t,c)&&this.images.get(o).set(t.toString(),c)}_validate(t,o){let c=!0;return this._validateStretch(o.stretchX,o.data&&o.data.width)||(this.fire(new n.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),c=!1),this._validateStretch(o.stretchY,o.data&&o.data.height)||(this.fire(new n.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),c=!1),this._validateContent(o.content,o)||(this.fire(new n.z(new Error(`Image "${t.name}" has invalid "content" value`))),c=!1),c}_validateStretch(t,o){if(!t)return!0;let c=0;for(let d of t){if(d[0]<c||d[1]<d[0]||o<d[1])return!1;c=d[1]}return!0}_validateContent(t,o){return t?t.length!==4||!o.usvg&&(t[0]<0||o.data.width<t[0]||t[1]<0||o.data.height<t[1]||t[2]<0||o.data.width<t[2]||t[3]<0||o.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,o,c){let d=this.images.get(o).get(t.toString());c.version=d.version+1,this.images.get(o).set(t.toString(),c),this.updatedImages.get(o).add(t),this.removeFromImageRasterizerCache(t,o)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,o){this.spriteFormat!=="raster"&&(n.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:o}):this.imageRasterizer.removeImagesFromCacheByIds([t],o))}removeImage(t,o){let c=this.images.get(o),d=c.get(t.toString());c.delete(t.toString()),this.patterns.get(o).delete(t.toString()),this.removeFromImageRasterizerCache(t,o),d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(o=>n.I.from(o))}getImages(t,o,c){let d=[],p=[],_=this.imageProviders.get(o);for(let C of t){if(!C.iconsetId){d.push(C);continue}let z=_.get(C.iconsetId);z&&(this.getImage(C,o)?p.push(C):z.addPendingRequest(C))}if(d.length===0)return void this._notify(p,o,c);let x=!0,b=!!this.loaded.get(o),M=this.images.get(o);if(!b)for(let C of d)M.has(C.toString())||(x=!1);b||x?this._notify(d,o,c):this.requestors.push({ids:d,scope:o,callback:c})}rasterizeImages(t,o){let c=new Map,{tasks:d,scope:p}=t;for(let[_,x]of d.entries()){let b=this.getImage(x.id,p);b&&c.set(_,{image:b,imageVariant:x})}this._rasterizeImages(p,c,o)}_rasterizeImages(t,o,c){if(n.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:o,scope:t},c);else{let d=new Map;for(let[p,{image:_,imageVariant:x}]of o.entries())d.set(p,this.imageRasterizer.rasterize(x,_,t,0));c(void 0,d)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,o,c){let d=this.images.get(o),p=new Map;for(let _ of t){if(!d.get(_.toString())){if(_.iconsetId)continue;this.fire(new n.A("styleimagemissing",{id:_.name}))}let x=d.get(_.toString());if(!x){n.w(`Image "${_.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}let b={data:x.usvg?null:x.data.clone(),pixelRatio:x.pixelRatio,sdf:x.sdf,usvg:x.usvg,version:x.version,stretchX:x.stretchX,stretchY:x.stretchY,content:x.content,hasRenderCallback:!!(x.userImage&&x.userImage.render)};x.usvg&&Object.assign(b,{width:x.icon.usvg_tree.width,height:x.icon.usvg_tree.height}),p.set(n.I.toString(_),b)}c(null,p)}getPixelSize(t){let{width:o,height:c}=this.atlasImage.get(t);return{width:o,height:c}}getPattern(t,o,c){let d=t.toString(),p=this.patterns.get(o),_=p.get(d),x=this.getImage(t,o);if(!x)return null;if(_){if(_.position.version===x.version)return _.position;_.position.version=x.version}else{if(x.usvg&&!x.data){let b=this.getPatternInFlightId(d,o);if(this.patternsInFlight.has(b))return null;this.patternsInFlight.add(b);let M=new n.B(t).scaleSelf(n.q.devicePixelRatio),C=new Map([[M.toString(),{image:x,imageVariant:M}]]);return this._rasterizeImages(o,C,(z,P)=>this.storePatternImage(M,o,x,c,P)),null}this.storePattern(t,o,x)}return this._updatePatternAtlas(o,c),p.get(d).position}getPatternInFlightId(t,o){return n.C(t,o)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,o,c,d,p){let _=t.toString(),x=p?p.get(_):void 0;x&&(c.data=x,this.storePattern(t.id,o,c),this._updatePatternAtlas(o,d),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),o)))}storePattern(t,o,c){let d={w:c.data.width+2*n.F,h:c.data.height+2*n.F,x:0,y:0},p=new n.G(d,c,n.F);this.patterns.get(o).set(t.toString(),{bin:d,position:p})}destroyAtlasTextures(){for(let t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,o){let c=t.gl,d=this.atlasTexture.get(o);d?this.dirty&&(d.update(this.atlasImage.get(o)),this.dirty=!1):(d=new n.T(t,this.atlasImage.get(o),c.RGBA8),this.atlasTexture.set(o,d)),d.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,o){let c=this.patterns.get(t),d=Array.from(c.values()).map(({bin:M})=>M),{w:p,h:_}=n.H(d),x=this.atlasImage.get(t);x.resize({width:p||1,height:_||1});let b=this.images.get(t);for(let[M,{bin:C,position:z}]of c.entries()){let P=z.padding,D=C.x+P,N=C.y+P,F=b.get(M).data,j=F.width,U=F.height;P=P>1?P-1:P,n.r.copy(F,x,{x:0,y:0},{x:D,y:N},{width:j,height:U},o),n.r.copy(F,x,{x:0,y:U-P},{x:D,y:N-P},{width:j,height:P},o),n.r.copy(F,x,{x:0,y:0},{x:D,y:N+U},{width:j,height:P},o),n.r.copy(F,x,{x:j-P,y:0},{x:D-P,y:N},{width:P,height:U},o),n.r.copy(F,x,{x:0,y:0},{x:D+j,y:N},{width:P,height:U},o),n.r.copy(F,x,{x:j-P,y:U-P},{x:D-P,y:N-P},{width:P,height:P},o),n.r.copy(F,x,{x:0,y:U-P},{x:D+j,y:N-P},{width:P,height:P},o),n.r.copy(F,x,{x:0,y:0},{x:D+j,y:N+U},{width:P,height:P},o),n.r.copy(F,x,{x:j-P,y:0},{x:D-P,y:N+U},{width:P,height:P},o)}this.dirty=!0}beginFrame(){for(let t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,o){let c=this.images.get(o);for(let d of t){if(this.callbackDispatchedThisFrame.get(o).has(d.toString()))continue;this.callbackDispatchedThisFrame.get(o).add(d.toString());let p=c.get(d.toString());Lo(p)&&this.updateImage(d,o,p)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Vn(l){let t=l.key,o=l.value,c=l.valueSpec||{},d=l.objectElementValidators||{},p=l.style,_=l.styleSpec,x=[],b=n.J(o);if(b!=="object")return[new n.V(t,o,`object expected, ${b} found`)];for(let M in o){let C=M.split(".")[0],z;d[C]?z=d[C]:c[C]?z=hr:d["*"]?z=d["*"]:c["*"]&&(z=hr),z?x=x.concat(z({key:(t&&`${t}.`)+M,value:o[M],valueSpec:c[C]||c["*"],style:p,styleSpec:_,object:o,objectKey:M},o)):x.push(new n.K(t,o[M],`unknown property "${M}"`))}for(let M in c)d[M]||c[M].required&&c[M].default===void 0&&o[M]===void 0&&x.push(new n.V(t,o,`missing required property "${M}"`));return x}function Ns(l){let t=l.value,o=l.valueSpec,c=l.style,d=l.styleSpec,p=l.key,_=l.arrayElementValidator||hr;if(n.J(t)!=="array")return[new n.V(p,t,`array expected, ${n.J(t)} found`)];if(o.length&&t.length!==o.length)return[new n.V(p,t,`array length ${o.length} expected, length ${t.length} found`)];if(o["min-length"]&&t.length<o["min-length"])return[new n.V(p,t,`array length at least ${o["min-length"]} expected, length ${t.length} found`)];let x={type:o.value,values:o.values,minimum:o.minimum,maximum:o.maximum,function:void 0};d.$version<7&&(x.function=o.function),n.J(o.value)==="object"&&(x=o.value);let b=[];for(let M=0;M<t.length;M++)b=b.concat(_({array:t,arrayIndex:M,value:t[M],valueSpec:x,style:c,styleSpec:d,key:`${p}[${M}]`},!0));return b}function sc(l){let t=l.key,o=l.value,c=l.valueSpec,d=n.J(o);if(d==="number"&&o!=o&&(d="NaN"),d!=="number")return[new n.V(t,o,`number expected, ${d} found`)];if("minimum"in c){let p=c.minimum;if(n.J(c.minimum)==="array"&&(p=c.minimum[l.arrayIndex]),o<p)return[new n.V(t,o,`${o} is less than the minimum value ${p}`)]}if("maximum"in c){let p=c.maximum;if(n.J(c.maximum)==="array"&&(p=c.maximum[l.arrayIndex]),o>p)return[new n.V(t,o,`${o} is greater than the maximum value ${p}`)]}return[]}function vs(l){let t=l.valueSpec,o=n.M(l.value.type),c,d,p,_={},x=o!=="categorical"&&l.value.property===void 0,b=!x,M=n.J(l.value.stops)==="array"&&n.J(l.value.stops[0])==="array"&&n.J(l.value.stops[0][0])==="object",C=Vn({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(D){if(o==="identity")return[new n.V(D.key,D.value,'identity function may not have a "stops" property')];let N=[],F=D.value;return N=N.concat(Ns({key:D.key,value:F,valueSpec:D.valueSpec,style:D.style,styleSpec:D.styleSpec,arrayElementValidator:z})),n.J(F)==="array"&&F.length===0&&N.push(new n.V(D.key,F,"array must have at least one stop")),N},default:function(D){return hr({key:D.key,value:D.value,valueSpec:t,style:D.style,styleSpec:D.styleSpec})}}});return o==="identity"&&x&&C.push(new n.V(l.key,l.value,'missing required property "property"')),o==="identity"||l.value.stops||C.push(new n.V(l.key,l.value,'missing required property "stops"')),o==="exponential"&&l.valueSpec.expression&&!n.N(l.valueSpec)&&C.push(new n.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(b&&!n.O(l.valueSpec)?C.push(new n.V(l.key,l.value,"property functions not supported")):x&&!n.Q(l.valueSpec)&&C.push(new n.V(l.key,l.value,"zoom functions not supported"))),o!=="categorical"&&!M||l.value.property!==void 0||C.push(new n.V(l.key,l.value,'"property" property is required')),C;function z(D){let N=[],F=D.value,j=D.key;if(n.J(F)!=="array")return[new n.V(j,F,`array expected, ${n.J(F)} found`)];if(F.length!==2)return[new n.V(j,F,`array length 2 expected, length ${F.length} found`)];if(M){if(n.J(F[0])!=="object")return[new n.V(j,F,`object expected, ${n.J(F[0])} found`)];if(F[0].zoom===void 0)return[new n.V(j,F,"object stop key must have zoom")];if(F[0].value===void 0)return[new n.V(j,F,"object stop key must have value")];let U=n.M(F[0].zoom);if(typeof U!="number")return[new n.V(j,F[0].zoom,"stop zoom values must be numbers")];if(p&&p>U)return[new n.V(j,F[0].zoom,"stop zoom values must appear in ascending order")];U!==p&&(p=U,d=void 0,_={}),N=N.concat(Vn({key:`${j}[0]`,value:F[0],valueSpec:{zoom:{}},style:D.style,styleSpec:D.styleSpec,objectElementValidators:{zoom:sc,value:P}}))}else N=N.concat(P({key:`${j}[0]`,value:F[0],style:D.style,styleSpec:D.styleSpec},F));return n.S(n.U(F[1]))?N.concat([new n.V(`${j}[1]`,F[1],"expressions are not allowed in function stops.")]):N.concat(hr({key:`${j}[1]`,value:F[1],valueSpec:t,style:D.style,styleSpec:D.styleSpec}))}function P(D,N){let F=n.J(D.value),j=n.M(D.value),U=D.value!==null?D.value:N;if(c){if(F!==c)return[new n.V(D.key,U,`${F} stop domain type must match previous stop domain type ${c}`)]}else c=F;if(F!=="number"&&F!=="string"&&F!=="boolean"&&typeof j!="number"&&typeof j!="string"&&typeof j!="boolean")return[new n.V(D.key,U,"stop domain value must be a number, string, or boolean")];if(F!=="number"&&o!=="categorical"){let Z=`number expected, ${F} found`;return n.O(t)&&o===void 0&&(Z+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new n.V(D.key,U,Z)]}return o!=="categorical"||F!=="number"||typeof j=="number"&&isFinite(j)&&Math.floor(j)===j?o!=="categorical"&&F==="number"&&typeof j=="number"&&typeof d=="number"&&d!==void 0&&j<d?[new n.V(D.key,U,"stop domain values must appear in ascending order")]:(d=j,o==="categorical"&&j in _?[new n.V(D.key,U,"stop domain values must be unique")]:(_[j]=!0,[])):[new n.V(D.key,U,`integer expected, found ${String(j)}`)]}}function co(l){let t=(l.expressionContext==="property"?n.W:n.X)(n.U(l.value),l.valueSpec);if(t.result==="error")return t.value.map(c=>new n.V(`${l.key}${c.key}`,l.value,c.message));let o=t.value.expression||t.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!o.outputDefined())return[new n.V(l.key,l.value,`Invalid data expression for "${l.propertyKey}". Output values must be contained as literals within the expression.`)];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!n.Y(o))return[new n.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return Kn(o,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!n.Z(o,["zoom","feature-state"]))return[new n.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!n._(o))return[new n.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Kn(l,t){let o=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(let d of t.valueSpec.expression.parameters)o.delete(d);if(o.size===0)return[];let c=[];return l instanceof n.$&&o.has(l.name)?[new n.V(t.key,t.value,`["${l.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(l.eachChild(d=>{c.push(...Kn(d,t))}),c)}function bs(l){let t=l.key,o=l.value,c=l.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf(n.M(o))===-1&&d.push(new n.V(t,o,`expected one of [${c.values.join(", ")}], ${JSON.stringify(o)} found`)):Object.keys(c.values).indexOf(n.M(o))===-1&&d.push(new n.V(t,o,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(o)} found`)),d}function ws(l){return n.a1(n.U(l.value))?co(n.L({},l,{expressionContext:"filter",valueSpec:l.styleSpec[`filter_${l.layerType||"fill"}`]})):va(l)}function va(l){let t=l.value,o=l.key;if(n.J(t)!=="array")return[new n.V(o,t,`array expected, ${n.J(t)} found`)];let c=l.styleSpec,d,p=[];if(t.length<1)return[new n.V(o,t,"filter array must have at least 1 element")];switch(p=p.concat(bs({key:`${o}[0]`,value:t[0],valueSpec:c.filter_operator,style:l.style,styleSpec:l.styleSpec})),n.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&n.M(t[1])==="$type"&&p.push(new n.V(o,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&p.push(new n.V(o,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(d=n.J(t[1]),d!=="string"&&p.push(new n.V(`${o}[1]`,t[1],`string expected, ${d} found`)));for(let _=2;_<t.length;_++)d=n.J(t[_]),n.M(t[1])==="$type"?p=p.concat(bs({key:`${o}[${_}]`,value:t[_],valueSpec:c.geometry_type,style:l.style,styleSpec:l.styleSpec})):d!=="string"&&d!=="number"&&d!=="boolean"&&p.push(new n.V(`${o}[${_}]`,t[_],`string, number, or boolean expected, ${d} found`));break;case"any":case"all":case"none":for(let _=1;_<t.length;_++)p=p.concat(va({key:`${o}[${_}]`,value:t[_],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":d=n.J(t[1]),t.length!==2?p.push(new n.V(o,t,`filter array for "${t[0]}" operator must have 2 elements`)):d!=="string"&&p.push(new n.V(`${o}[1]`,t[1],`string expected, ${d} found`))}return p}function Ka(l,t){let o=l.key,c=l.style,d=l.layer,p=l.styleSpec,_=l.value,x=l.objectKey,b=p[`${t}_${l.layerType}`];if(!b)return[];let M=x.match(/^(.*)-use-theme$/);if(t==="paint"&&M&&b[M[1]])return n.S(_)?[].concat(hr({key:l.key,value:_,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:x})):hr({key:o,value:_,valueSpec:{type:"string"},style:c,styleSpec:p});let C=x.match(/^(.*)-transition$/);if(t==="paint"&&C&&b[C[1]]&&b[C[1]].transition)return hr({key:o,value:_,valueSpec:p.transition,style:c,styleSpec:p});let z=l.valueSpec||b[x];if(!z)return[new n.K(o,_,`unknown property "${x}"`)];let P;if(n.J(_)==="string"&&n.O(z)&&!z.tokens&&(P=/^{([^}]+)}$/.exec(_))){let N=`\`{ "type": "identity", "property": ${P?JSON.stringify(P[1]):'"_"'} }\``;return[new n.V(o,_,`"${x}" does not support interpolation syntax
Use an identity property function instead: ${N}.`)]}let D=[];if(l.layerType==="symbol")x!=="text-field"||!c||c.glyphs||c.imports||D.push(new n.V(o,_,'use of "text-field" requires a style "glyphs" property')),x==="text-font"&&n.a2(n.U(_))&&n.M(_.type)==="identity"&&D.push(new n.V(o,_,'"text-font" does not support identity functions'));else if(l.layerType==="model"&&t==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&n.O(z)&&(n.a3(z)||n.Q(z))){let N=n.W(n.U(_),z),F=N.value.expression||N.value._styleExpression.expression;F&&!n.Z(F,["measure-light"])&&(x==="model-emissive-strength"&&n._(F)&&n.Y(F)||D.push(new n.V(o,_,`${x} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return D.concat(hr({key:l.key,value:_,valueSpec:z,style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:x}))}function Un(l){return Ka(l,"paint")}function ho(l){return Ka(l,"layout")}function ac(l){let t=[],o=l.value,c=l.key,d=l.style,p=l.styleSpec;o.type||o.ref||t.push(new n.V(c,o,'either "type" or "ref" is required'));let _=n.M(o.type),x=n.M(o.ref);if(o.id){let b=n.M(o.id);for(let M=0;M<l.arrayIndex;M++){let C=d.layers[M];n.M(C.id)===b&&t.push(new n.V(c,o.id,`duplicate layer id "${o.id}", previously used at line ${C.id.__line__}`))}}if("ref"in o){let b;["type","source","source-layer","filter","layout"].forEach(M=>{M in o&&t.push(new n.V(c,o[M],`"${M}" is prohibited for ref layers`))}),d.layers.forEach(M=>{n.M(M.id)===x&&(b=M)}),b?b.ref?t.push(new n.V(c,o.ref,"ref cannot reference another ref layer")):_=n.M(b.type):typeof x=="string"&&t.push(new n.V(c,o.ref,`ref layer "${x}" not found`))}else if(_!=="background"&&_!=="sky"&&_!=="slot")if(o.source){let b=d.sources&&d.sources[o.source],M=b&&n.M(b.type);b?M==="vector"&&_==="raster"?t.push(new n.V(c,o.source,`layer "${o.id}" requires a raster source`)):M==="raster"&&_!=="raster"?t.push(new n.V(c,o.source,`layer "${o.id}" requires a vector source`)):M!=="vector"||o["source-layer"]?M==="raster-dem"&&_!=="hillshade"?t.push(new n.V(c,o.source,"raster-dem source can only be used with layer type 'hillshade'.")):M!=="raster-array"||["raster","raster-particle"].includes(_)?_==="line"&&o.paint&&(o.paint["line-gradient"]||o.paint["line-trim-offset"])&&M==="geojson"&&!b.lineMetrics?t.push(new n.V(c,o,`layer "${o.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):_==="raster-particle"&&M!=="raster-array"&&t.push(new n.V(c,o.source,`layer "${o.id}" requires a 'raster-array' source.`)):t.push(new n.V(c,o.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new n.V(c,o,`layer "${o.id}" must specify a "source-layer"`)):t.push(new n.V(c,o.source,`source "${o.source}" not found`))}else t.push(new n.V(c,o,'missing required property "source"'));return t=t.concat(Vn({key:c,value:o,valueSpec:p.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>hr({key:`${c}.type`,value:o.type,valueSpec:p.layer.type,style:l.style,styleSpec:l.styleSpec,object:o,objectKey:"type"}),filter:b=>ws(n.L({layerType:_},b)),layout:b=>Vn({layer:o,key:b.key,value:b.value,valueSpec:{},style:b.style,styleSpec:b.styleSpec,objectElementValidators:{"*":M=>ho(n.L({layerType:_},M))}}),paint:b=>Vn({layer:o,key:b.key,value:b.value,valueSpec:{},style:b.style,styleSpec:b.styleSpec,objectElementValidators:{"*":M=>Un(n.L({layerType:_,layer:o},M))}})}})),t}function Ts(l){let t=l.value,o=l.key,c=n.J(t);return c!=="string"?[new n.V(o,t,`string expected, ${c} found`)]:[]}let Ja={promoteId:function l({key:t,value:o}){if(n.J(o)==="string")return Ts({key:t,value:o});if(Array.isArray(o)){let c=[],d=n.U(o),p=n.X(d);return p.result==="error"&&p.value.forEach(_=>{c.push(new n.V(`${t}${_.key}`,null,`${_.message}`))}),n.Z(p.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||c.push(new n.V(`${t}`,null,"promoteId expression should be only feature dependent")),c}{let c=[];for(let d in o)c.push(...l({key:`${t}.${d}`,value:o[d]}));return c}}};function Sn(l){let t=l.value,o=l.key,c=l.styleSpec,d=l.style;if(!t.type)return[new n.V(o,t,'"type" is required')];let p=n.M(t.type),_=[];switch(["vector","raster","raster-dem","raster-array"].includes(p)&&(t.url||t.tiles||_.push(new n.K(o,t,'Either "url" or "tiles" is required.'))),p){case"vector":case"raster":case"raster-dem":case"raster-array":return _=_.concat(Vn({key:o,value:t,valueSpec:c[`source_${p.replace("-","_")}`],style:l.style,styleSpec:c,objectElementValidators:Ja})),_;case"geojson":if(_=Vn({key:o,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:Ja}),t.cluster)for(let x in t.clusterProperties){let[b,M]=t.clusterProperties[x],C=typeof b=="string"?[b,["accumulated"],["get",x]]:b;_.push(...co({key:`${o}.${x}.map`,value:M,expressionContext:"cluster-map"})),_.push(...co({key:`${o}.${x}.reduce`,value:C,expressionContext:"cluster-reduce"}))}return _;case"video":return Vn({key:o,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return Vn({key:o,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new n.V(o,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return bs({key:`${o}.type`,value:t.type,valueSpec:{values:uo(c)}})}}function uo(l){return l.source.reduce((t,o)=>{let c=l[o];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values))),t},[])}function Vs(l){let t=l.value,o=l.styleSpec,c=o.light,d=l.style,p=[],_=n.J(t);if(t===void 0)return p;if(_!=="object")return p=p.concat([new n.V("light",t,`object expected, ${_} found`)]),p;for(let x in t){let b=x.match(/^(.*)-transition$/),M=x.match(/^(.*)-use-theme$/);p=p.concat(M&&c[M[1]]?hr({key:x,value:t[x],valueSpec:{type:"string"},style:d,styleSpec:o}):b&&c[b[1]]&&c[b[1]].transition?hr({key:x,value:t[x],valueSpec:o.transition,style:d,styleSpec:o}):c[x]?hr({key:x,value:t[x],valueSpec:c[x],style:d,styleSpec:o}):[new n.V(x,t[x],`unknown property "${x}"`)])}return p}function Ss(l){let t=l.value,o=[];if(!t)return o;let c=n.J(t);if(c!=="object")return o=o.concat([new n.V("light-3d",t,`object expected, ${c} found`)]),o;let d=l.styleSpec,p=d["light-3d"],_=l.key,x=l.style,b=l.style.lights;for(let z of["type","id"])if(!(z in t))return o=o.concat([new n.V("light-3d",t,`missing property ${z} on light`)]),o;if(t.type&&b)for(let z=0;z<l.arrayIndex;z++){let P=n.M(t.type),D=b[z];n.M(D.type)===P&&o.push(new n.V(_,t.id,`duplicate light type "${t.type}", previously defined at line ${D.id.__line__}`))}let M=`properties_light_${t.type}`;if(!(M in d))return o=o.concat([new n.V("light-3d",t,`Invalid light type ${t.type}`)]),o;let C=d[M];for(let z in t)if(z==="properties"){let P=t[z],D=n.J(P);if(D!=="object")return o=o.concat([new n.V("properties",P,`object expected, ${D} found`)]),o;for(let N in P){let F=N.match(/^(.*)-transition$/),j=N.match(/^(.*)-use-theme$/);o=o.concat(j&&C[j[1]]?hr({key:z,value:P[N],valueSpec:{type:"string"},style:x,styleSpec:d}):F&&C[F[1]]&&C[F[1]].transition?hr({key:z,value:t[z],valueSpec:d.transition,style:x,styleSpec:d}):C[N]?hr({key:N,value:P[N],valueSpec:C[N],style:x,styleSpec:d}):[new n.K(l.key,P[N],`unknown property "${N}"`)])}}else o=o.concat(p[z]?hr({key:z,value:t[z],valueSpec:p[z],style:x,styleSpec:d}):[new n.K(z,t[z],`unknown property "${z}"`)]);return o}function Us(l){let t=l.value,o=l.key,c=l.style,d=l.styleSpec,p=d.terrain,_=[],x=n.J(t);if(t===void 0||x==="null")return _;if(x!=="object")return _=_.concat([new n.V("terrain",t,`object expected, ${x} found`)]),_;for(let b in t){let M=b.match(/^(.*)-transition$/),C=b.match(/^(.*)-use-theme$/);_=_.concat(C&&p[C[1]]?hr({key:b,value:t[b],valueSpec:{type:"string"},style:c,styleSpec:d}):M&&p[M[1]]&&p[M[1]].transition?hr({key:b,value:t[b],valueSpec:d.transition,style:c,styleSpec:d}):p[b]?hr({key:b,value:t[b],valueSpec:p[b],style:c,styleSpec:d}):[new n.K(b,t[b],`unknown property "${b}"`)])}if(t.source){let b=c.sources&&c.sources[t.source],M=b&&n.M(b.type);b?M!=="raster-dem"&&_.push(new n.V(o,t.source,`terrain cannot be used with a source of type ${String(M)}, it only be used with a "raster-dem" source type`)):_.push(new n.V(o,t.source,`source "${t.source}" not found`))}else _.push(new n.V(o,t,'terrain is missing required property "source"'));return _}function js(l){let t=l.value,o=l.style,c=l.styleSpec,d=c.fog,p=[],_=n.J(t);if(t===void 0)return p;if(_!=="object")return p=p.concat([new n.V("fog",t,`object expected, ${_} found`)]),p;for(let x in t){let b=x.match(/^(.*)-transition$/),M=x.match(/^(.*)-use-theme$/);p=p.concat(M&&d[M[1]]?hr({key:x,value:t[x],valueSpec:{type:"string"},style:o,styleSpec:c}):b&&d[b[1]]&&d[b[1]].transition?hr({key:x,value:t[x],valueSpec:c.transition,style:o,styleSpec:c}):d[x]?hr({key:x,value:t[x],valueSpec:d[x],style:o,styleSpec:c}):[new n.K(x,t[x],`unknown property "${x}"`)])}return p}let Qa={"*":()=>[],array:Ns,boolean:function(l){let t=l.value,o=l.key,c=n.J(t);return c!=="boolean"?[new n.V(o,t,`boolean expected, ${c} found`)]:[]},number:sc,color:function(l){let t=l.key,o=l.value,c=n.J(o);return c!=="string"?[new n.V(t,o,`color expected, ${c} found`)]:n.a0.parseCSSColor(o)===null?[new n.V(t,o,`color expected, "${o}" found`)]:[]},enum:bs,filter:ws,function:vs,layer:ac,object:Vn,source:Sn,model:n.a4,light:Vs,"light-3d":Ss,terrain:Us,fog:js,string:Ts,formatted:function(l){return Ts(l).length===0?[]:co(l)},resolvedImage:function(l){return Ts(l).length===0?[]:co(l)},projection:function(l){let t=l.value,o=l.styleSpec,c=o.projection,d=l.style,p=[],_=n.J(t);if(_==="object")for(let x in t)p=p.concat(hr({key:x,value:t[x],valueSpec:c[x],style:d,styleSpec:o}));else _!=="string"&&(p=p.concat([new n.V("projection",t,`object or string expected, ${_} found`)]));return p},import:function(l){let{value:t,styleSpec:o}=l,{data:c,...d}=t;Object.defineProperty(d,"__line__",{value:t.__line__,enumerable:!1});let p=Vn(n.L({},l,{value:d,valueSpec:o.import}));return n.M(d.id)===""&&p.push(new n.V(`${l.key}.id`,d,"import id can't be an empty string")),c&&(p=p.concat(cc(c,o,{key:`${l.key}.data`}))),p},iconset:function(l){let t=l.value,o=l.key,c=l.styleSpec,d=l.style;if(!t.type)return[new n.V(o,t,'"type" is required')];let p=n.M(t.type),_=[];if(_=_.concat(Vn({key:o,value:t,valueSpec:c[`iconset_${p}`],style:d,styleSpec:c})),p==="source"&&t.source){let x=d.sources&&d.sources[t.source],b=x&&n.M(x.type);x?b!=="raster-array"&&_.push(new n.V(o,t.source,`iconset cannot be used with a source of type ${String(b)}, it only be used with a "raster-array" source type`)):_.push(new n.V(o,t.source,`source "${t.source}" not found`))}return _}};function hr(l,t=!1){let o=l.value,c=l.valueSpec,d=l.styleSpec;if(c.expression&&n.a2(n.M(o)))return vs(l);if(c.expression&&n.S(n.U(o)))return co(l);if(c.type&&Qa[c.type]){let p=Qa[c.type](l);return t===!0&&p.length>0&&n.J(l.value)==="array"?co(l):p}return Vn(n.L({},l,{valueSpec:c.type?d[c.type]:c}))}function lc(l){let t=l.value,o=l.key,c=Ts(l);return c.length||(t.indexOf("{fontstack}")===-1&&c.push(new n.V(o,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&c.push(new n.V(o,t,'"glyphs" url must include a "{range}" token'))),c}function cc(l,t=n.a5,o={}){return hr({key:o.key||"",value:l,valueSpec:t.$root,styleSpec:t,style:l,objectElementValidators:{glyphs:lc,"*":()=>[]}})}function po(l,t=n.a5){return fe(cc(l,t))}let hc=l=>fe(Sn(l)),ld=l=>fe(Vs(l)),el=l=>fe(Ss(l)),Qe=l=>fe(Us(l)),Es=l=>fe(js(l)),cd=l=>fe(function(t){let o=t.value,c=t.style,d=t.styleSpec,p=d.snow,_=[],x=n.J(o);if(o===void 0)return _;if(x!=="object")return _=_.concat([new n.V("snow",o,`object expected, ${x} found`)]),_;for(let b in o){let M=b.match(/^(.*)-transition$/);_=_.concat(M&&p[M[1]]&&p[M[1]].transition?hr({key:b,value:o[b],valueSpec:d.transition,style:c,styleSpec:d}):p[b]?hr({key:b,value:o[b],valueSpec:p[b],style:c,styleSpec:d}):[new n.K(b,o[b],`unknown property "${b}"`)])}return _}(l)),uc=l=>fe(function(t){let o=t.value,c=t.style,d=t.styleSpec,p=d.rain,_=[],x=n.J(o);if(o===void 0)return _;if(x!=="object")return _=_.concat([new n.V("rain",o,`object expected, ${x} found`)]),_;for(let b in o){let M=b.match(/^(.*)-transition$/);_=_.concat(M&&p[M[1]]&&p[M[1]].transition?hr({key:b,value:o[b],valueSpec:d.transition,style:c,styleSpec:d}):p[b]?hr({key:b,value:o[b],valueSpec:p[b],style:c,styleSpec:d}):[new n.K(b,o[b],`unknown property "${b}"`)])}return _}(l)),Ai=l=>fe(ac(l)),Re=l=>fe(ws(l)),q=l=>fe(Un(l)),$=l=>fe(ho(l)),ie=l=>fe(n.a4(l));function fe(l){return l.slice().sort((t,o)=>t.line&&o.line?t.line-o.line:0)}function re(l,t){let o=!1;if(t&&t.length)for(let c of t)c instanceof n.K?n.w(c.message):(l.fire(new n.z(new Error(c.message))),o=!0);return o}let ye;class De extends n.E{constructor(t,o="flat"){super(),this._transitionable=new n.a6(ye||(ye=new n.a7({anchor:new n.a8(n.a5.light.anchor),position:new n.a9(n.a5.light.position),color:new n.a8(n.a5.light.color),intensity:new n.a8(n.a5.light.intensity)}))),this.setLight(t,o),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,o,c={}){this._validate(ld,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=o)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,c){return(!c||c.validate!==!1)&&re(this,t.call(po,n.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:n.a5})))}}let be=class extends n.E{constructor(l,t,o,c,d){super(),this.scope=o,this._transitionable=new n.a6(new n.a7({source:new n.a8(n.a5.terrain.source),exaggeration:new n.a8(n.a5.terrain.exaggeration)}),o,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=d}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new n.aa(l,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;let l=this._transitionable._values.exaggeration;if(!l)return null;let t=l.value.expression;if(!t)return null;let o=-1,c=-1,d=1;for(let p of t.zoomStops)d=t.evaluate(new n.aa(p,{worldview:this.worldview})),d>.01?(o=p,c=-1):c=p;return d<.01&&o>0&&c>o?[o,c]:null}isZoomDependent(){let l=this._transitionable._values.exaggeration;return l!=null&&l.value!=null&&l.value.expression!=null&&l.value.expression instanceof n.ab}},Le=45,st=65,He=.05;function kt(l,t,o,c){let d=n.af(Le,st,o),[p,_]=Ht(l,c),x=1-Math.min(1,Math.exp((t-p)/(_-p)*-6));return x*=x*x,x=Math.min(1,1.00747*x),x*d*l.alpha}function Ht(l,t){let o=.5/Math.tan(.5*t);return[l.range[0]+o,l.range[1]+o]}function Xt(l,t,o,c,d){let p=n.ad([],[t,o,c],d.mercatorFogMatrix);return kt(l,n.ae(p),d.pitch,d._fov)}function ui(l,t,o,c,d,p,_){let x=[[o,c,0],[d,c,0],[d,p,0],[o,p,0]],b=Number.MAX_VALUE,M=-Number.MAX_VALUE;for(let C of x){let z=n.ad([],C,t),P=n.ae(z);b=Math.min(b,P),M=Math.max(M,P)}return[kt(l,b,_.pitch,_._fov),kt(l,M,_.pitch,_._fov)]}class si extends n.E{constructor(t,o,c,d){super();let p=new n.a7({range:new n.a8(n.a5.fog.range),color:new n.a8(n.a5.fog.color),"color-use-theme":new n.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new n.a8(n.a5.fog["high-color"]),"high-color-use-theme":new n.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new n.a8(n.a5.fog["space-color"]),"space-color-use-theme":new n.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new n.a8(n.a5.fog["horizon-blend"]),"star-intensity":new n.a8(n.a5.fog["star-intensity"]),"vertical-range":new n.a8(n.a5.fog["vertical-range"])});this._transitionable=new n.a6(p,c,new Map(d)),this.set(t,d),this._transitioning=this._transitionable.untransitioned(),this._transform=o,this.properties=new n.ag(p),this.scope=c}get state(){let t=this._transform,o=t.projection.name==="globe",c=n.ah(t.zoom),d=this.properties.get("range"),p=[.5,3];return{range:o?[n.ai(p[0],d[0],c),n.ai(p[1],d[1],c)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,o,c={}){if(this._validate(Es,t,c))return;let d=n.h({},t);for(let p of Object.keys(n.a5.fog))d[p]===void 0&&(d[p]=n.a5.fog[p].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,o)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;let o=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:n.af(Le,st,t))*o.a}getOpacityAtLatLng(t,o){return this._transform.projection.supportsFog?function(c,d,p){let _=n.ac.fromLngLat(d),x=p.elevation?p.elevation.getAtPointOrZero(_):0;return Xt(c,_.x,_.y,x,p)}(this.state,t,o):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];let o=this._transform.calculateFogTileMatrix(t.toUnwrapped());return ui(this.state,o,0,0,n.aj,n.aj,this._transform)}getOpacityForBounds(t,o,c,d,p){return this._transform.projection.supportsFog?ui(this.state,t,o,c,d,p,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?Ht(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;let o=[4,5,6,7];for(let c of o){let d=t.points[c],p;if(d[2]>=0)p=d;else{let _=t.points[c-4];p=n.ak(_,d,_[2]/(_[2]-d[2]))}if(Xt(this.state,p[0],p[1],0,this._transform)>=He)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,c){return(!c||c.validate!==!1)&&re(this,t.call(po,n.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:n.a5})))}}let di,Yi,pi,Mr,Qr=class extends n.E{constructor(l,t,o,c){super();let d=di||(di=new n.a7({density:new n.a8(n.a5.snow.density),intensity:new n.a8(n.a5.snow.intensity),color:new n.a8(n.a5.snow.color),opacity:new n.a8(n.a5.snow.opacity),vignette:new n.a8(n.a5.snow.vignette),"vignette-color":new n.a8(n.a5.snow["vignette-color"]),"center-thinning":new n.a8(n.a5.snow["center-thinning"]),direction:new n.a8(n.a5.snow.direction),"flake-size":new n.a8(n.a5.snow["flake-size"])}));this._transitionable=new n.a6(d,o,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new n.ag(d),this.scope=o}get state(){let l=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),c=n.al(o[0]),d=-Math.max(n.al(o[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],_=this.properties.get("vignette"),x=this.properties.get("vignette-color");return x.a=_,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new n.am(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:x}}get(){return this._transitionable.serialize()}set(l,t,o={}){if(this._validate(cd,l,o))return;let c=n.h({},l);for(let d of Object.keys(n.a5.snow))c[d]===void 0&&(c[d]=n.a5.snow[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,o){return(!o||o.validate!==!1)&&re(this,l.call(po,n.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:n.a5})))}},$r=class extends n.E{constructor(l,t,o,c){super();let d=Yi||(Yi=new n.a7({density:new n.a8(n.a5.rain.density),intensity:new n.a8(n.a5.rain.intensity),color:new n.a8(n.a5.rain.color),opacity:new n.a8(n.a5.rain.opacity),vignette:new n.a8(n.a5.rain.vignette),"vignette-color":new n.a8(n.a5.rain["vignette-color"]),"center-thinning":new n.a8(n.a5.rain["center-thinning"]),direction:new n.a8(n.a5.rain.direction),"droplet-size":new n.a8(n.a5.rain["droplet-size"]),"distortion-strength":new n.a8(n.a5.rain["distortion-strength"])}));this._transitionable=new n.a6(d,o,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new n.ag(d),this.scope=o}get state(){let l=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),c=n.al(o[0]),d=-Math.max(n.al(o[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],_=this.properties.get("vignette-color");return _.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new n.am(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:_}}get(){return this._transitionable.serialize()}set(l,t,o={}){if(this._validate(uc,l,o))return;let c=n.h({},l);for(let d of Object.keys(n.a5.rain))c[d]===void 0&&(c[d]=n.a5.rain[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,o){return(!o||o.validate!==!1)&&re(this,l.call(po,n.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:n.a5})))}};class Hi extends n.E{constructor(t,o,c,d){super(),this.scope=c,this._options=t,this.properties=new n.ag(o),this._transitionable=new n.a6(o,c,new Map(d)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,o){this._options=t,this._transitionable.setTransitionOrValue(t.properties,o)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Pi{constructor(t,o,c){this.screenBounds=t,this.cameraPoint=c.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=o,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,c)}static createFromScreenPoints(t,o){let c,d;if(t instanceof n.P||typeof t[0]=="number"){let p=n.P.convert(t);c=[p],d=o.isPointAboveHorizon(p)}else{let p=n.P.convert(t[0]),_=n.P.convert(t[1]),x=p.add(_)._div(2);c=[p,_],d=n.ao(p,_).every(b=>o.isPointAboveHorizon(b))&&o.isPointAboveHorizon(x)}return new Pi(c,d,o)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return n.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){let o=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new n.P(1,1)):this.screenBounds[1],d=n.ao(o,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>o.x&&this.cameraPoint.x<c.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?d[2]=this.cameraPoint:this.cameraPoint.x<=o.x&&(d[3]=this.cameraPoint)),n.ap(d,t)}bufferedCameraGeometryGlobe(t){let o=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new n.P(1,1)):this.screenBounds[1],d=n.ao(o,c,t),p=this.cameraPoint.clone();switch(3*((p.y>o.y)+(p.y>c.y))+((p.x>o.x)+(p.x>c.x))){case 0:d[0]=p,d[4]=p.clone();break;case 1:d.splice(1,0,p);break;case 2:d[1]=p;break;case 3:d.splice(4,0,p);break;case 5:d.splice(2,0,p);break;case 6:d[3]=p;break;case 7:d.splice(3,0,p);break;case 8:d[2]=p}return d}containsTile(t,o,c,d=0){let p=t.queryPadding/o._pixelsPerMercatorPixel+1,_=c?this._bufferedCameraMercator(p,o):this._bufferedScreenMercator(p,o),x=t.tileID.wrap+(_.unwrapped?d:0),b=_.polygon.map(j=>n.aq(t.tileTransform,j,x));if(!n.ar(b,0,0,n.aj,n.aj))return;x=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);let M=this.screenGeometryMercator.polygon.map(j=>n.as(t.tileTransform,j,x)),C=M.map(j=>new n.P(j[0],j[1])),z=o.getFreeCameraOptions().position||new n.ac(0,0,0),P=n.as(t.tileTransform,z,x),D=M.map(j=>{let U=n.at(j,j,P);return n.au(U,U),new n.av(P,U)}),N=n.aw(t,1,o.zoom)*o._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:C,tilespaceRays:D,bufferedTilespaceGeometry:b,bufferedTilespaceBounds:(F=n.ax(b),F.min.x=n.ay(F.min.x,0,n.aj),F.min.y=n.ay(F.min.y,0,n.aj),F.max.x=n.ay(F.max.x,0,n.aj),F.max.y=n.ay(F.max.y,0,n.aj),F),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:N};var F}_bufferedScreenMercator(t,o){let c=_r(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let d;return d=o.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),o):{polygon:this.bufferedScreenGeometry(t).map(p=>o.pointCoordinate3D(p)),unwrapped:!0},this._screenRaycastCache[c]=d,d}}_bufferedCameraMercator(t,o){let c=_r(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let d;return d=o.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),o):{polygon:this.bufferedCameraGeometry(t).map(p=>o.pointCoordinate3D(p)),unwrapped:!0},this._cameraRaycastCache[c]=d,d}}_projectAndResample(t,o){let c=function(p,_){let x=n.az([],_.pixelMatrix,_.globeMatrix),b=[0,-n.aB,0,1],M=[0,n.aB,0,1],C=[0,0,0,1];n.aA(b,b,x),n.aA(M,M,x),n.aA(C,C,x);let z=new n.P(b[0]/b[3],b[1]/b[3]),P=new n.P(M[0]/M[3],M[1]/M[3]),D=n.aC(p,z)&&b[3]<C[3],N=n.aC(p,P)&&M[3]<C[3];if(!D&&!N)return null;let F=function(de,oe,se){for(let le=1;le<de.length;le++){let Me=wr(oe.pointCoordinate3D(de[le-1]).x),_e=wr(oe.pointCoordinate3D(de[le]).x);if(se<0){if(Me<_e)return{idx:le,t:-Me/(_e-1-Me)}}else if(_e<Me)return{idx:le,t:(1-Me)/(_e+1-Me)}}return null}(p,_,D?-1:1);if(!F)return null;let{idx:j,t:U}=F,Z=j>1?Ir(p.slice(0,j),_):[],Y=j<p.length?Ir(p.slice(j),_):[];Z=Z.map(de=>new n.P(wr(de.x),de.y)),Y=Y.map(de=>new n.P(wr(de.x),de.y));let Q=[...Z];Q.length===0&&Q.push(Y[Y.length-1]);let ne=n.ai(Q[Q.length-1].y,(Y.length===0?Z[0]:Y[0]).y,U),he;return he=D?[new n.P(0,ne),new n.P(0,0),new n.P(1,0),new n.P(1,ne)]:[new n.P(1,ne),new n.P(1,1),new n.P(0,1),new n.P(0,ne)],Q.push(...he),Y.length===0?Q.push(Z[0]):Q.push(...Y),{polygon:Q.map(de=>new n.ac(de.x,de.y)),unwrapped:!1}}(t,o);if(c)return c;let d=function(p,_){let x=!1,b=-1/0,M=0;for(let z=0;z<p.length-1;z++)p[z].x>b&&(b=p[z].x,M=z);for(let z=0;z<p.length-1;z++){let P=(M+z)%(p.length-1),D=p[P],N=p[P+1];Math.abs(D.x-N.x)>.5&&(D.x<N.x?(D.x+=1,P===0&&(p[p.length-1].x+=1)):(N.x+=1,P+1===p.length-1&&(p[0].x+=1)),x=!0)}let C=n.aD(_.center.lng);return x&&C<Math.abs(C-1)&&p.forEach(z=>{z.x-=1}),{polygon:p,unwrapped:x}}(Ir(t,o).map(p=>new n.P(wr(p.x),p.y)),o);return{polygon:d.polygon.map(p=>new n.ac(p.x,p.y)),unwrapped:d.unwrapped}}}function Ir(l,t){return n.aE(l,o=>{let c=t.pointCoordinate3D(o);o.x=c.x,o.y=c.y},1/256)}function wr(l){return l<0?1+l%1:l%1}function _r(l){return 100*l|0}function ln(l,t,o,c,d){let p=function(x,b){if(x)return d(x);if(b){if(l.url&&b.tiles&&l.tiles&&delete l.tiles,b.variants){if(!Array.isArray(b.variants))return d(new Error("variants must be an array"));for(let C of b.variants){if(C==null||typeof C!="object"||C.constructor!==Object)return d(new Error("variant must be an object"));if(!Array.isArray(C.capabilities))return d(new Error("capabilities must be an array"));if(C.capabilities.length===1&&C.capabilities[0]==="meshopt"){b=n.h(b,C);break}}}let M=n.aF(n.h({},b,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);M.tiles=t.canonicalizeTileset(M,l.url),d(null,M)}},_=function(x,b,M){if(!x)return null;if(!b&&!M)return x;M=M||x.worldview_default;let C=Object.values(x.language||{});if(C.length===0)return null;let z=Object.values(x.worldview||{});if(z.length===0)return null;let P=C.every(N=>N===b),D=z.every(N=>N===M);return P&&D?x:b in(x.language_options||{})||M in(x.worldview_options||{})?null:x.language_options&&x.worldview_options?x:null}(l.data,o,c);return _?n.q.frame(()=>p(null,_)):l.url?n.n(t.transformRequest(t.normalizeSourceURL(l.url,null,o,c),n.R.Source),p):n.q.frame(()=>{let{data:x,...b}=l;p(null,b)})}function jn(l,t){let o=Math.pow(2,t.z),c=Math.floor(n.aD(l.getWest())*o),d=Math.floor(n.aH(l.getNorth())*o),p=Math.ceil(n.aD(l.getEast())*o),_=Math.ceil(n.aH(l.getSouth())*o);return t.x>=c&&t.x<p&&t.y>=d&&t.y<_}class En{constructor(t,o,c){this.bounds=t?n.aG.convert(this.validateBounds(t)):null,this.minzoom=o||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(let o of t)this.extraBounds.push(n.aG.convert(this.validateBounds(o)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!jn(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(let o of this.extraBounds)if(jn(o,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;let o=new En(t.bounds,t.minzoom,t.maxzoom);return o.addExtraBounds(t.extra_bounds),o}}class dc extends n.E{constructor(t,o,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,n.h(this,n.aF(o,["url","scheme","tileSize","promoteId"])),this._options=n.h({type:"vector"},o),this._collectResourceTiming=!!o.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new n.aI}load(t){this._loaded=!1,this.fire(new n.A("dataloading",{dataType:"source"}));let o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=ln(this._options,this.map._requestManager,o,c,(d,p)=>{if(this._tileJSONRequest=null,this._loaded=!0,d)o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),c&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new n.z(d));else if(p){if(n.h(this,p),this.hasWorldviews=!!p.worldview_options,p.worldview_default&&(this.worldviewDefault=p.worldview_default),p.vector_layers){this.vectorLayers=p.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(let _ of p.vector_layers)this.vectorLayerIds.push(_.id),p.worldview&&p.worldview[_.source]&&this.localizableLayerIds.add(_.id)}this.tileBounds=En.fromTileJSON(p),tn(p.tiles,this.map._requestManager._customAccessToken),this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(d)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=n.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return n.h({},this._options)}loadTile(t,o){let c=t.tileID.canonical.url(this.tiles,this.scheme),d=this.map._requestManager.normalizeTileURL(c),p=this.map._requestManager.transformRequest(d,n.R.Tile),_=this.map.style?this.map.style.getLut(this.scope):null,x=_?{image:_.image.clone()}:null,b={request:p,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:x,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:n.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&n.j(c)&&(b.localizableLayerIds=this.localizableLayerIds),b.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=o:t.request=t.actor.send("reloadTile",b,M.bind(this));else if(t.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",b,M.bind(this),void 0,!0);else{let C=n.aJ.call({deduped:this._deduped},b,(z,P)=>{z||!P?M.call(this,z):(b.data={cacheControl:P.cacheControl,expires:P.expires,rawData:P.rawData.slice(0)},t.actor&&t.actor.send("loadTile",b,M.bind(this),void 0,!0))},!0);t.request={cancel:C}}function M(C,z){return delete t.request,t.aborted?o(null):C&&C.status!==404?o(C):(z&&z.resourceTiming&&(t.resourceTiming=z.resourceTiming),this.map._refreshExpiredTiles&&z&&t.setExpiryData(z),t.loadVectorData(z,this.map.painter),n.aK(this.dispatcher),o(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class mn extends n.E{constructor(t,o,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=n.h({type:"raster"},o),n.h(this,n.aF(o,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new n.A("dataloading",{dataType:"source"}));let o=this.map.getWorldview();this._tileJSONRequest=ln(this._options,this.map._requestManager,null,o,(c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new n.z(c)):d&&(n.h(this,d),d.raster_layers&&(this.rasterLayers=d.raster_layers,this.rasterLayerIds=this.rasterLayers.map(p=>p.id)),this.tileBounds=En.fromTileJSON(d),tn(d.tiles),this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(c)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=n.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return n.h({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,o){let c=n.q.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=n.o(this.map._requestManager.transformRequest(d,n.R.Tile),(p,_,x,b)=>(delete t.request,t.aborted?(t.state="unloaded",o(null)):p?(t.state="errored",o(p)):_?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:x,expires:b}),t.setTexture(_,this.map.painter),t.state="loaded",n.aK(this.dispatcher),void o(null)):o(null)))}abortTile(t,o){t.request&&(t.request.cancel(),delete t.request),o&&o()}unloadTile(t,o){t.texture&&t.texture instanceof n.T?(t.destroy(!0),t.texture&&t.texture instanceof n.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),o&&o()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Gs extends mn{constructor(t,o,c,d){super(t,o,c,d),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=n.h({type:"raster-array"},o)}triggerRepaint(t){let o=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);o&&o.enabled&&c&&o._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,o){let c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,n.R.Tile),p={request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=d,t.actor||(t.actor=this.dispatcher.getActor());let _=(x,b,M,C)=>{if(delete t.request,t.aborted)return t.state="unloaded",o(null);if(x)return x.name==="AbortError"?void 0:(t.state="errored",o(x));if(this.map._refreshExpiredTiles&&b&&t.setExpiryData({cacheControl:M,expires:C}),this.partial)t.state="empty";else{if(!b)return o(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=b}o(null)};t.request=this.partial?t.fetchHeader(void 0,_.bind(this)):t.actor.send("loadTile",p,_.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){let c=t.texturePerLayer;if(t.flushAllQueues(),c.size){t.destroy(!0);for(let d of c.values())this.map.painter.saveTileTexture(d)}else t.destroy()}prepareTile(t,o,c,d){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(o,c,d,(p,_)=>{if(p)return t.state="errored",this.fire(new n.z(p)),void this.triggerRepaint(t);_&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(c,_,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;let o=this.rasterLayers.find(({id:p})=>p===t),c=o&&o.fields,d=c&&c.bands&&c.bands;return d?d[0]:0}getTextureDescriptor(t,o,c){if(!t)return;let d=o.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let p=null;o instanceof n.aN?p=o.paint.get("raster-array-band"):o instanceof n.aO&&(p=o.paint.get("raster-particle-array-band"));let _=p||this.getInitialBand(d);if(_==null)return;if(!t.textureDescriptorPerLayer.get(o.id))return void this.prepareTile(t,d,o.id,_);if(t.updateNeeded(o.id,_)&&!c)return;let x=t.textureDescriptorPerLayer.get(o.id);return Object.assign({},x,{texture:t.texturePerLayer.get(o.id)})}getImages(t,o){let c=new Map;for(let d of t)for(let p of o){let[_,x]=p.split("/"),b=d.getLayer(_);if(!b||!b.hasBand(x)||!b.hasDataForBand(x))continue;let{bytes:M,tileSize:C,buffer:z}=b.getBandView(x),P=C+2*z,D={data:new n.r({width:P,height:P},M),pixelRatio:2,sdf:!1,usvg:!1,version:0};c.set(p,D)}return c}}let Eh={vector:dc,raster:mn,"raster-dem":class extends mn{constructor(l,t,o,c){super(l,t,o,c),this.type="raster-dem",this.maxzoom=22,this._options=n.h({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){let o=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(d,p){d&&(l.state="errored",t(d)),p&&(l.dem=p,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=n.o(this.map._requestManager.transformRequest(o,n.R.Tile),function(d,p,_,x){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(d)l.state="errored",t(d);else if(p){this.map._refreshExpiredTiles&&l.setExpiryData({cacheControl:_,expires:x});let b=ImageBitmap&&p instanceof ImageBitmap&&n.t(),M=1-(p.width-n.aL(p.width))/2;M<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));let C=b?p:n.q.getImageData(p,M),z={uid:l.uid,tileID:l.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:C,encoding:this.encoding,padding:M};l.actor&&l.state!=="expired"||(l.actor=this.dispatcher.getActor(),l.actor.send("loadTile",z,c.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(l){let t=l.canonical,o=Math.pow(2,t.z),c=(t.x-1+o)%o,d=t.x===0?l.wrap-1:l.wrap,p=(t.x+1+o)%o,_=t.x+1===o?l.wrap+1:l.wrap,x={};return x[new n.aM(l.overscaledZ,d,t.z,c,t.y).key]={backfilled:!1},x[new n.aM(l.overscaledZ,_,t.z,p,t.y).key]={backfilled:!1},t.y>0&&(x[new n.aM(l.overscaledZ,d,t.z,c,t.y-1).key]={backfilled:!1},x[new n.aM(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},x[new n.aM(l.overscaledZ,_,t.z,p,t.y-1).key]={backfilled:!1}),t.y+1<o&&(x[new n.aM(l.overscaledZ,d,t.z,c,t.y+1).key]={backfilled:!1},x[new n.aM(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},x[new n.aM(l.overscaledZ,_,t.z,p,t.y+1).key]={backfilled:!1}),x}},"raster-array":Gs,geojson:class extends n.E{constructor(l,t,o,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=o.getActor(),this.setEventedParent(c),this._data=t.data,this._options=n.h({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;let d=n.aj/this.tileSize;this.workerOptions=n.h({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*d,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*d,extent:n.aj,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:n.aj,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*d,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new n.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof l!="string"&&(l.type==="Feature"&&(l={type:"FeatureCollection",features:[l]}),l.type!=="FeatureCollection"))return this.fire(new n.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof l!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){let t=new Map;for(let o of this._data.features)t.set(o.id,o);for(let o of l.features)t.set(o.id,o);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,o,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:o},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new n.A("dataloading",{dataType:"source"})),this._loaded=!1;let t=n.h({append:l},this.workerOptions);t.scope=this.scope;let o=this._data;typeof o=="string"?(t.request=this.map._requestManager.transformRequest(n.q.resolveURL(o),n.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(o),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(c,d)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new n.z(c));else{let p={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&d&&d.resourceTiming&&d.resourceTiming[this.id]&&(p.resourceTiming=d.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new n.A("data",p)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)})}loaded(){return this._loaded}reload(){let l=n.C(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){let o=l.actor?"reloadTile":"loadTile";l.actor=this.actor;let c=this.map.style?this.map.style.getLut(this.scope):null,d=c?{image:c.image.clone()}:null,p=this._partialReload,_={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d,scope:this.scope,pixelRatio:n.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:l.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:p,worldview:this.map.getWorldview()};l.request=this.actor.send(o,_,(x,b)=>p&&!b?(l.state="loaded",t(null)):(delete l.request,l.destroy(),l.aborted?t(null):x?t(x):(l.loadVectorData(b,this.map.painter,o==="reloadTile"),t(null))),void 0,o==="loadTile")}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return n.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends n.aP{constructor(l,t,o,c){super(l,t,o,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;let l=this.options;this.urls=[];for(let t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,n.R.Source).url);n.aQ(this.urls,(t,o)=>{this._loaded=!0,t?this.fire(new n.z(t)):o&&(this.video=o,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){let t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new n.z(new n.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new n.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:n.aP,model:class extends n.E{constructor(l,t,o,c){super(),this.id=l,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){let l=[];for(let t in this._options.models){let o=this._options.models[t],c=n.aS(this.map._requestManager.transformRequest(o.uri,n.R.Model).url).then(d=>{if(!d)return;let p=n.aT(d),_=new n.aU(t,o.position,o.orientation,p);_.computeBoundsAndApplyParent(),this.models.push(_)}).catch(d=>{this.fire(new n.z(new Error(`Could not load model ${t} from ${o.uri}: ${d.message}`)))});l.push(c)}Promise.allSettled(l).then(()=>{this._loaded=!0,this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this._loaded=!0,this.fire(new n.z(new Error(`Could not load models: ${t.message}`)))})}onAdd(l){this.map=l,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(l,t){}serialize(){return this._options}},"batched-model":class extends n.E{constructor(l,t,o,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=o,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();let l=n.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(l))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new n.A("dataloading",{dataType:"source"}));let t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map.getWorldview();this._tileJSONRequest=ln(this._options,this.map._requestManager,t,o,(c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),o&&o.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new n.z(c))):d&&(n.h(this,d),d.bounds&&(this.tileBounds=new En(d.bounds,this.minzoom,this.maxzoom)),tn(d.tiles,this.map._requestManager._customAccessToken),this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)})}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){let o=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(o,n.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:n.q.devicePixelRatio,promoteId:this.promoteId};if(l.actor&&l.state!=="expired")if(l.state==="loading")l.reloadCallback=t;else{if(l.buckets){let p=Object.values(l.buckets);for(let _ of p)_.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,d.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,d.bind(this),void 0,!0);function d(p,_){return l.aborted?t(null):p&&p.status!==404?t(p):(this.map._refreshExpiredTiles&&_&&l.setExpiryData(_),l.loadModelData(_,this.map.painter),l.state="loaded",void t(null))}}serialize(){return n.h({},this._options)}},canvas:class extends n.aP{constructor(l,t,o,c){super(l,t,o,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(d=>!Array.isArray(d)||d.length!==2||d.some(p=>typeof p!="number"))||this.fire(new n.z(new n.V(`sources.${l}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new n.z(new n.V(`sources.${l}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new n.z(new n.V(`sources.${l}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new n.z(new n.V(`sources.${l}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new n.z(new n.V(`sources.${l}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new n.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof n.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new n.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends n.E{constructor(l,t,o,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=o,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new n.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new n.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new En(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),n.h(this,n.aF(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return n.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new n.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){let{x:t,y:o,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:o,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){let{x:o,y:c,z:d}=l.tileID.canonical,p=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:o,y:c,z:d},{signal:p.signal})).then(function(_){return delete l.request,l.aborted?(l.state="unloaded",t(null)):_===void 0?(l.state="errored",t(null)):_===null?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):function(x){return x instanceof ImageData||x instanceof HTMLCanvasElement||x instanceof ImageBitmap||x instanceof HTMLImageElement}(_)?(this.loadTileData(l,_),l.state="loaded",void t(null)):(l.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch(_=>{_.name!=="AbortError"&&(l.state="errored",t(_))}),l.request.cancel=()=>p.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof n.T?(l.destroy(!0),l.texture&&l.texture instanceof n.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){let{x:o,y:c,z:d}=l.tileID.canonical;this._implementation.unloadTile({x:o,y:c,z:d})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z}))}_clearTiles(){let l=n.C(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))}}},pc=function(l,t,o,c){let d=new Eh[t.type](l,t,o,c);if(d.id!==l)throw new Error(`Expected Source id to be ${l} instead of ${d.id}`);return n.aV(["load","abort","unload","serialize","prepare"],d),d};function fc(l,t,o=""){return`${o}:${t.id||""}:${t.layer.id}:${function(c){if("layerId"in c)return`layer:${c.layerId}`;{let{featuresetId:d,importId:p}=c;return`featureset:${d}${p?`:import:${p}`:""}`}}(l.target)}`}function Ih(l,t,o,c=""){if(l.uniqueFeatureID){let d=fc(l,t,c);if(o.has(d))return!0;o.add(d)}return!1}function Ah(l,t,o,c,d=!1){let p=t.sourceCache.transform,_=t.sourceCache.tilesIn(l,t.has3DLayers,d);_.sort(Mh);let x=[];for(let b of _){let M=b.tile.queryRenderedFeatures(t,b,o,c,p,d);Object.keys(M).length&&x.push({wrappedTileID:b.tile.tileID.wrapped().key,queryResults:M})}return x.length===0?{}:function(b){let M={},C={};for(let z of b){let P=z.queryResults,D=z.wrappedTileID,N=C[D]=C[D]||{};for(let F in P){let j=P[F],U=N[F]=N[F]||{},Z=M[F]=M[F]||[];for(let Y of j)U[Y.featureIndex]||(U[Y.featureIndex]=!0,Z.push(Y))}}return M}(x)}function ba(l,t,o,c,d,p){let _={},x=c.queryRenderedSymbols(l),b=[];for(let M of Object.keys(x).map(Number))b.push(d[M]);b.sort(Mh);for(let M of b){let C=M.featureIndex.lookupSymbolFeatures(x[M.bucketInstanceId],M.bucketIndex,M.sourceLayerIndex,t,o,p);for(let z in C){let P=_[z]=_[z]||[],D=C[z];D.sort((N,F)=>{let j=M.featureSortOrder;if(j){let U=j.indexOf(N.featureIndex);return j.indexOf(F.featureIndex)-U}return F.featureIndex-N.featureIndex});for(let N of D)P.push(N)}}return _}function mc(l,t){let o=l.getRenderableIds().map(p=>l.getTileByID(p)),c=[],d={};for(let p=0;p<o.length;p++){let _=o[p],x=_.tileID.canonical.key;d[x]||(d[x]=!0,_.querySourceFeatures(c,t))}return c}function Mh(l,t){let o=l.tileID,c=t.tileID;return o.overscaledZ-c.overscaledZ||o.canonical.y-c.canonical.y||o.wrap-c.wrap||o.canonical.x-c.canonical.x}function Wo(l,t){let o={};if(!t)return o;for(let c of l){let d=c.layerIds.map(p=>t.getLayer(p)).filter(Boolean);if(d.length!==0){c.layers=d,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map(p=>d.filter(_=>_.id===p)[0]));for(let p of d)o[p.fqid]=c}}return o}let fo=32,zo=33,Is=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,o=0,c=0,d=0,p=0,_=0,x=0;for(1&t?d=p=_=fo:o=c=x=fo;(t>>=1)>1;){let M=o+d>>1,C=c+p>>1;1&t?(d=o,p=c,o=_,c=x):(o=d,c=p,d=_,p=x),_=M,x=C}let b=4*l;Is[b+0]=o,Is[b+1]=c,Is[b+2]=d,Is[b+3]=p}let Xo=new Uint16Array(2178),As=new Uint8Array(1089),_c=new Uint16Array(1089);function os(l){return l===0?-.03125:l===32?.03125:0}let gc={type:2,extent:n.aj,loadGeometry:()=>[[new n.P(0,0),new n.P(n.aj+1,0),new n.P(n.aj+1,n.aj+1),new n.P(0,n.aj+1),new n.P(0,0)]]};class wa{constructor(t,o,c,d,p,_){this.tileID=t,this.uid=n.a$(),this.uses=0,this.tileSize=o,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=p,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection),this.worldview=_}registerFadeDuration(t){let o=t+this.timeAdded;o<n.q.now()||this.fadeEndTime&&o<this.fadeEndTime||(this.fadeEndTime=o)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=n.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,o,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=Wo(t.buckets,o.style),this.hasSymbolBuckets=!1;for(let d in this.buckets){let p=this.buckets[d];if(p instanceof n.b1){if(this.hasSymbolBuckets=!0,!c)break;p.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let d in this.buckets){let p=this.buckets[d];if(p instanceof n.b1&&p.hasRTLText){this.hasRTLText=!0,n.b2();break}}this.queryPadding=0;for(let d in this.buckets){let p=this.buckets[d],_=o.style.getOwnLayer(d);if(!_)continue;let x=_.queryRadius(p);this.queryPadding=Math.max(this.queryPadding,x)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new n.b0}unloadVectorData(){if(this.hasData()){for(let t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,o,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,Wo(t.buckets,o.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(let d in this.buckets){let p=this.buckets[d];p.uploadPending()&&p.upload(t)}let o=t.gl,c=this.imageAtlas;c&&!c.uploaded&&(this.imageAtlasTexture=new n.T(t,c.image,o.RGBA8,{useMipmap:!!c.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new n.T(t,this.glyphAtlasImage,o.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new n.T(t,this.lineAtlas.image,o.R8),this.lineAtlas.uploaded=!0)}prepare(t,o,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!o||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let d=o.style.getBrightness();(this._lastUpdatedBrightness||d)&&(this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this.updateBuckets(o,this._lastUpdatedBrightness!==d),this._lastUpdatedBrightness=d))}queryRenderedFeatures(t,o,c,d,p,_){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};let x=function(b,M){let C=n.bn([],[.5*b.width,.5*-b.height,1]);return n.bo(C,C,[1,-1,0]),n.az(C,C,b.calculateProjMatrix(M.toUnwrapped())),Float32Array.from(C)}(p,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:o,pixelPosMatrix:x,transform:d,availableImages:c,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(t,o){let c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;let d=c.loadVTLayers(),p=o?o.sourceLayer:"",_=d._geojsonTileLayer||d[p];if(!_)return;let x=n.b3(o&&o.filter),{z:b,x:M,y:C}=this.tileID.canonical,z={z:b,x:M,y:C};for(let P=0;P<_.length;P++){let D=_.feature(P);if(x.needGeometry){let j=n.b4(D,!0);if(!x.filter(new n.aa(this.tileID.overscaledZ,{worldview:this.worldview}),j,this.tileID.canonical))continue}else if(!x.filter(new n.aa(this.tileID.overscaledZ,{worldview:this.worldview}),D))continue;let N=c.getId(D,p),F=new n.b5(D,b,M,C,N);F.tile=z,t.push(F)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){let o=this.expirationTime;if(t.cacheControl){let c=n.b6(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){let c=Date.now(),d=!1;if(this.expirationTime>c)d=!1;else if(o)if(this.expirationTime<o)d=!0;else{let p=this.expirationTime-o;p?this.expirationTime=c+Math.max(p,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,o){if(!this.latestFeatureIndex||!t.style)return;let c=this.latestFeatureIndex.loadVTLayers(),d=t.style.listImages(),p=t.style.getBrightness();for(let _ in this.buckets){if(!t.style.hasLayer(_))continue;let x=this.buckets[_],b=x.layers[0],M=b.sourceLayer||"_geojsonTileLayer",C=c[M],z=t.style.getLayerSourceCache(b),P={};z&&(P=z._state.getState(M,void 0));let D=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},N=Object.keys(P).length>0&&!o;N&&!x.stateDependentLayers.length&&!o||x.update(P,C,d,D,N?x.stateDependentLayers:x.layers,o,p),(x instanceof n.b7||x instanceof n.b8)&&t._terrain&&t._terrain.enabled&&z&&x.uploadPending()&&t._terrain._clearRenderCacheForTile(z.id,this.tileID);let F=t&&t.style&&t.style.getOwnLayer(_);F&&(this.queryPadding=Math.max(this.queryPadding,F.queryRadius(x)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<n.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=n.q.now()+t}setTexture(t,o){let c=o.context,d=c.gl;this.texture=this.texture||o.getTileTexture(t.width),this.texture&&this.texture instanceof n.T?this.texture.update(t):(this.texture=new n.T(c,t,d.RGBA8,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(t,o){let c={};for(let d of o)c[d]=!0;this.dependencies[t]=c}hasDependency(t,o){for(let c of t){let d=this.dependencies[c];if(d){for(let p of o)if(d[p])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,o){if(!o||o.name==="mercator"||this._tileDebugBuffer)return;let c=n.b9(gc,this.tileID.canonical,this.tileTransform)[0],d=new n.ba,p=new n.bb;for(let _=0;_<c.length;_++){let{x,y:b}=c[_];d.emplaceBack(x,b),p.emplaceBack(_)}p.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(p),this._tileDebugBuffer=t.createVertexBuffer(d,n.bc.members),this._tileDebugSegments=n.bd.simpleSegment(0,0,d.length,p.length)}_makeTileBoundsBuffers(t,o){if(this._tileBoundsBuffer||!o||o.name==="mercator")return;let c=n.b9(gc,this.tileID.canonical,this.tileTransform)[0],d,p;if(this.isRaster){let _=function(x,b){let M=n.aW(x,b),C=Math.pow(2,x.z);for(let j=0;j<zo;j++)for(let U=0;U<zo;U++){let Z=n.aX((x.x+(U+os(U))/fo)/C),Y=n.aY((x.y+(j+os(j))/fo)/C),Q=b.project(Z,Y),ne=j*zo+U;Xo[2*ne+0]=Math.round((Q.x*M.scale-M.x)*n.aj),Xo[2*ne+1]=Math.round((Q.y*M.scale-M.y)*n.aj)}As.fill(0),_c.fill(0);for(let j=2045;j>=0;j--){let U=4*j,Z=Is[U+0],Y=Is[U+1],Q=Is[U+2],ne=Is[U+3],he=Z+Q>>1,de=Y+ne>>1,oe=he+de-Y,se=de+Z-he,le=Y*zo+Z,Me=ne*zo+Q,_e=de*zo+he,Ve=Math.hypot((Xo[2*le+0]+Xo[2*Me+0])/2-Xo[2*_e+0],(Xo[2*le+1]+Xo[2*Me+1])/2-Xo[2*_e+1])>=16;As[_e]=As[_e]||(Ve?1:0),j<1022&&(As[_e]=As[_e]||As[(Y+se>>1)*zo+(Z+oe>>1)]||As[(ne+se>>1)*zo+(Q+oe>>1)])}let z=new n.aZ,P=new n.a_,D=0;function N(j,U){let Z=U*zo+j;return _c[Z]===0&&(z.emplaceBack(Xo[2*Z+0],Xo[2*Z+1],j*n.aj/fo,U*n.aj/fo),_c[Z]=++D),_c[Z]-1}function F(j,U,Z,Y,Q,ne){let he=j+Z>>1,de=U+Y>>1;if(Math.abs(j-Q)+Math.abs(U-ne)>1&&As[de*zo+he])F(Q,ne,j,U,he,de),F(Z,Y,Q,ne,he,de);else{let oe=N(j,U),se=N(Z,Y),le=N(Q,ne);P.emplaceBack(oe,se,le)}}return F(0,0,fo,fo,fo,0),F(fo,fo,0,0,0,fo),{vertices:z,indices:P}}(this.tileID.canonical,o);d=_.vertices,p=_.indices}else{d=new n.aZ,p=new n.a_;for(let{x,y:b}of c)d.emplaceBack(x,b,0,0);let _=n.be(d.int16.subarray(0,4*d.length),void 0,4);for(let x=0;x<_.length;x+=3)p.emplaceBack(_[x],_[x+1],_[x+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,n.bf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(p),this._tileBoundsSegments=n.bd.simpleSegment(0,0,d.length,p.length)}_makeGlobeTileDebugBuffers(t,o){let c=o.projection;if(!c||c.name!=="globe"||o.freezeTileCoverage)return;let d=this.tileID.canonical,p=n.bg(d,o),_=n.bh(p),x=n.ah(o.zoom),b;x>0&&(b=n.bi(new Float64Array(16),o.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,o,_,b,x),this._makeGlobeTileDebugTextBuffer(t,d,o,_,b,x)}_globePoint(t,o,c,d,p,_,x){let b=n.bj(t,o,c);if(_){let M=1<<c.z,C=n.aD(d.center.lng),z=n.aH(d.center.lat),P=(c.x+.5)/M-C,D=0;P>.5?D=-1:P<-.5&&(D=1);let N=(t/n.aj+c.x)/M+D,F=(o/n.aj+c.y)/M;N=(N-C)*d._pixelsPerMercatorPixel+C,F=(F-z)*d._pixelsPerMercatorPixel+z;let j=[N*d.worldSize,F*d.worldSize,0];n.ad(j,j,_),b=n.bk(b,j,x)}return n.ad(b,b,p)}_makeGlobeTileDebugBorderBuffer(t,o,c,d,p,_){let x=new n.ba,b=new n.bb,M=new n.bl,C=(P,D,N,F,j)=>{let U=(N-P)/(j-1),Z=(F-D)/(j-1),Y=x.length;for(let Q=0;Q<j;Q++){let ne=P+Q*U,he=D+Q*Z;x.emplaceBack(ne,he);let de=this._globePoint(ne,he,o,c,d,p,_);M.emplaceBack(de[0],de[1],de[2]),b.emplaceBack(Y+Q)}},z=n.aj;C(0,0,z,0,16),C(z,0,z,z,16),C(z,z,0,z,16),C(0,z,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(b),this._tileDebugBuffer=t.createVertexBuffer(x,n.bc.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(M,n.bm.members),this._tileDebugSegments=n.bd.simpleSegment(0,0,x.length,b.length)}_makeGlobeTileDebugTextBuffer(t,o,c,d,p,_){let x=n.aj/4,b=new n.ba,M=new n.a_,C=new n.bl,z=25;M.reserve(32),b.reserve(z),C.reserve(z);let P=(D,N)=>z*D+N;for(let D=0;D<z;D++){let N=D*x;for(let F=0;F<z;F++){let j=F*x;b.emplaceBack(j,N);let U=this._globePoint(j,N,o,c,d,p,_);C.emplaceBack(U[0],U[1],U[2])}}for(let D=0;D<4;D++)for(let N=0;N<4;N++){let F=P(D,N),j=P(D,N+1),U=P(D+1,N),Z=P(D+1,N+1);M.emplaceBack(F,j,U),M.emplaceBack(U,j,Z)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(M),this._tileDebugTextBuffer=t.createVertexBuffer(b,n.bc.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(C,n.bm.members),this._tileDebugTextSegments=n.bd.simpleSegment(0,0,z,32)}destroy(t=!1){for(let o in this.buckets)this.buckets[o].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof n.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}n.bp.setPbf(n.bq);class tl extends wa{constructor(t,o,c,d,p){super(t,o,c,d,p),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,o,c){let d=c.context,p=d.gl,_=this.texturePerLayer.get(t)||c.getTileTexture(o.width);_&&_ instanceof n.T?_.update(o,{premultiply:!1}):_=new n.T(d,o,p.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,_)}flushQueues(t){let o=this._workQueuePerLayer.get(t)||[],c=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()();for(;c.length;)c.pop()()}flushAllQueues(){for(let t of this._workQueuePerLayer.keys()){let o=this._workQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}for(let t of this._fetchQueuePerLayer.keys()){let o=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}}fetchHeader(t=16384,o){let c=this._mrt=new n.bp(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=n.br(d,(p,_,x,b)=>{if(p)o(p);else try{let M=c.getHeaderLength(_);if(M>t)return void(this.request=this.fetchHeader(M,o));c.parseHeader(_),this._isHeaderLoaded=!0;let C=0;for(let z of Object.values(c.layers))C=Math.max(C,z.dataIndex[z.dataIndex.length-1].lastByte);_.byteLength>=C&&(this.entireBuffer=_),o(null,this.entireBuffer||_,x,b)}catch(M){o(M)}}),this.request}fetchBand(t,o,c,d){let p=this._mrt;if(!this._isHeaderLoaded||!p)return void d(new Error("Tile header is not ready"));let _=this.actor;if(!_)return void d(new Error("Can't fetch tile band without an actor"));let x,b=(P,D)=>{if(x.complete(P,D),P)return void d(P);this.updateTextureDescriptor(t,o,c);let N=this.textureDescriptorPerLayer.get(o);d(null,N&&N.img)},M=(P,D)=>{if(P)return d(P);let N=_.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:D,task:x},b,void 0,!0),F=this._workQueuePerLayer.get(o)||[];F.push(()=>{N&&N.cancel(),x.cancel()}),this._workQueuePerLayer.has(o)||this._workQueuePerLayer.set(o,F)},C=p.getLayer(t);if(!C)return void d(new Error(`Unknown sourceLayer "${t}"`));if(C.hasDataForBand(c)){this.updateTextureDescriptor(t,o,c);let P=this.textureDescriptorPerLayer.get(o);return void d(null,P?P.img:null)}let z=C.getDataRange([c]);if(x=p.createDecodingTask(z),!x||x.tasks.length)if(this.flushQueues(o),this.entireBuffer)M(null,this.entireBuffer.slice(z.firstByte,z.lastByte+1));else{let P=Object.assign({},this.requestParams,{headers:{Range:`bytes=${z.firstByte}-${z.lastByte}`}}),D=n.br(P,M),N=this._fetchQueuePerLayer.get(o)||[];N.push(()=>{D.cancel(),x.cancel()}),this._fetchQueuePerLayer.has(o)||this._fetchQueuePerLayer.set(o,N)}else d(null)}updateNeeded(t,o){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==o)&&this.state!=="errored"}updateTextureDescriptor(t,o,c){if(!this._mrt)return;let d=this._mrt.getLayer(t);if(!d||!d.hasBand(c)||!d.hasDataForBand(c))return;let{bytes:p,tileSize:_,buffer:x,offset:b,scale:M}=d.getBandView(c),C=_+2*x,z=new n.r({width:C,height:C},p),P=this.texturePerLayer.get(o);P&&P instanceof n.T&&P.update(z,{premultiply:!1}),this.textureDescriptorPerLayer.set(o,{layer:t,band:c,img:z,buffer:x,offset:b,tileSize:_,format:d.pixelFormat,mix:[M,256*M,65536*M,16777216*M]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(let o of this.texturePerLayer.values())o&&o instanceof n.T&&o.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class hd{constructor(t,o){this.max=t,this.onRemove=o,this.reset()}reset(){for(let t in this.data)for(let o of this.data[t])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(t,o,c){let d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);let p={value:o,timeout:void 0};if(c!==void 0&&(p.timeout=setTimeout(()=>{this.remove(t,p)},c)),this.data[d].push(p),this.order.push(d),this.order.length>this.max){let _=this._getAndRemoveByKey(this.order[0]);_&&this.onRemove(_)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){let o=this.data[t].shift();return o.timeout&&clearTimeout(o.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),o.value}getByKey(t){let o=this.data[t];return o?o[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,o){if(!this.has(t))return this;let c=t.wrapped().key,d=o===void 0?0:this.data[c].indexOf(o),p=this.data[c][d];return this.data[c].splice(d,1),p.timeout&&clearTimeout(p.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(p.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){let o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(t){let o=[];for(let c in this.data)for(let d of this.data[c])t(d.value)||o.push(d);for(let c of o)this.remove(c.value.tileID,c)}}class ud{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,o,c){let d=String(o);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},n.h(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(let p in this.state[t])p!==d&&(this.deletedStates[t][p]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(let p in this.state[t][d])c[p]||(this.deletedStates[t][d][p]=null)}else for(let p in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][p]===null&&delete this.deletedStates[t][d][p]}removeFeatureState(t,o,c){if(this.deletedStates[t]===null)return;let d=String(o);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&o!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(o!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,o){let c=this.state[t]||{},d=this.stateChanges[t]||{},p=this.deletedStates[t];if(p===null)return{};if(o!==void 0){let x=String(o),b=n.h({},c[x],d[x]);if(p){let M=p[o];if(M===null)return{};for(let C in M)delete b[C]}return b}let _=n.h({},c,d);if(p)for(let x in p)delete _[x];return _}initializeTileState(t,o){t.refreshFeatureState(o)}coalesceChanges(t,o){let c={};for(let d in this.stateChanges){this.state[d]=this.state[d]||{};let p={};for(let _ in this.stateChanges[d])this.state[d][_]||(this.state[d][_]={}),n.h(this.state[d][_],this.stateChanges[d][_]),p[_]=this.state[d][_];c[d]=p}for(let d in this.deletedStates){this.state[d]=this.state[d]||{};let p={};if(this.deletedStates[d]===null)for(let _ in this.state[d])p[_]={},this.state[d][_]={};else for(let _ in this.deletedStates[d]){if(this.deletedStates[d][_]===null)this.state[d][_]={};else if(this.state[d][_])for(let x of Object.keys(this.deletedStates[d][_]))delete this.state[d][_][x];p[_]=this.state[d][_]}c[d]=c[d]||{},n.h(c[d],p)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(let d in t)t[d].refreshFeatureState(o)}}class Gn extends n.E{constructor(t,o,c){super(),this.id=t,this._onlySymbols=c,o.on("data",d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),o.on("error",()=>{this._sourceErrored=!0}),this._source=o,this._tiles={},this._cache=new hd(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=o.minTileCacheSize,this._maxTileCacheSize=o.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new ud,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,o){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,o)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let o in this._tiles){let c=this._tiles[o];c.upload(t),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(Ta).map(t=>t.key)}getRenderableIds(t,o){let c=[];for(let d in this._tiles)this._isIdRenderable(+d,t,o)&&c.push(this._tiles[d]);return t?c.sort((d,p)=>{let _=d.tileID,x=p.tileID,b=new n.P(_.canonical.x,_.canonical.y)._rotate(this.transform.angle),M=new n.P(x.canonical.x,x.canonical.y)._rotate(this.transform.angle);return _.overscaledZ-x.overscaledZ||M.y-b.y||M.x-b.x}).map(d=>d.tileID.key):c.map(d=>d.tileID).sort(Ta).map(d=>d.key)}hasRenderableParent(t){let o=this.findLoadedParent(t,0);return!!o&&this._isIdRenderable(o.tileID.key)}_isIdRenderable(t,o,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(o||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,o){let c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=o),this._loadTile(c,this._tileLoaded.bind(this,c,t,o)))}_tileLoaded(t,o,c,d){if(d)if(t.state="errored",d.status!==404)this._source.fire(new n.z(d,{tile:t}));else{if(this._source.fire(new n.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){let p=this.map.painter.terrain;this.update(this.transform,p.getScaledDemTileSize(),!0),p.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=n.q.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(o,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new n.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){let o=this.getRenderableIds();for(let d=0;d<o.length;d++){let p=o[d];if(t.neighboringTiles&&t.neighboringTiles[p]){let _=this.getTileByID(p);c(t,_),c(_,t)}}function c(d,p){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let _=p.tileID.canonical.x-d.tileID.canonical.x,x=p.tileID.canonical.y-d.tileID.canonical.y,b=Math.pow(2,d.tileID.canonical.z),M=p.tileID.key;_===0&&x===0||Math.abs(x)>1||(Math.abs(_)>1&&(Math.abs(_+b)===1?_+=b:Math.abs(_-b)===1&&(_-=b)),p.dem&&d.dem&&(d.dem.backfillBorder(p.dem,_,x),d.neighboringTiles&&d.neighboringTiles[M]&&(d.neighboringTiles[M].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,o,c,d){for(let p in this._tiles){let _=this._tiles[p];if(d[p]||!_.hasData()||_.tileID.overscaledZ<=o||_.tileID.overscaledZ>c)continue;let x=_.tileID;for(;_&&_.tileID.overscaledZ>o+1;){let M=_.tileID.scaledTo(_.tileID.overscaledZ-1);_=this._tiles[M.key],_&&_.hasData()&&(x=M)}let b=x;for(;b.overscaledZ>o;)if(b=b.scaledTo(b.overscaledZ-1),t[b.key]){d[x.key]=x;break}}}findLoadedParent(t,o){if(t.key in this._loadedParentTiles){let c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=o?c:null}for(let c=t.overscaledZ-1;c>=o;c--){let d=t.scaledTo(c),p=this._getLoadedTile(d);if(p)return p}}_getLoadedTile(t){let o=this._tiles[t.key];return o&&o.hasData()?o:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,o){o=o||this._source.tileSize;let c=Math.ceil(t.width/o)+1,d=Math.ceil(t.height/o)+1,p=Math.floor(c*d*5),_=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,p):p,x=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,_):_;this._cache.setMaxSize(x)}handleWrapJump(t){let o=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,o){let c={};for(let d in this._tiles){let p=this._tiles[d];p.tileID=p.tileID.unwrapTo(p.tileID.wrap+o),c[p.tileID.key]=p}this._tiles=c;for(let d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(let d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,o,c,d,p){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,o),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let _=this._source.type==="batched-model",x,b=this._source.maxzoom,M=this.map&&this.map.painter?this.map.painter._terrain:null;if(M&&M.sourceCache===this&&M.attenuationRange()){let P=M.attenuationRange()[0],D=Math.floor(P)-Math.log2(M.getDemUpscale());b>D&&(b=D)}if(this.used||this.usedForTerrain){if(this._source.tileID)x=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(P=>new n.aM(P.canonical.z,P.wrap,P.canonical.z,P.canonical.x,P.canonical.y));else if(this.tileCoverLift!==0){let P=t.clone();P.tileCoverLift=this.tileCoverLift,x=P.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:b,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:_}),this._source.minzoom<=1&&t.projection.name==="globe"&&(x.push(new n.aM(1,0,1,0,0)),x.push(new n.aM(1,0,1,1,0)),x.push(new n.aM(1,0,1,0,1)),x.push(new n.aM(1,0,1,1,1)))}else if(x=t.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:b,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:_}),this._source.hasTile){let P=this._source.hasTile.bind(this._source);x=x.filter(D=>P(D))}}else x=[];if(x.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!yc(this._source.type)){let P=t.coveringZoomLevel({tileSize:o||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),D=Math.min(P,this._source.maxzoom);if(_){let N=t.extendTileCover(x,D);for(let F of N)x.push(F)}else if(p){let N=t.extendTileCoverToNearPlane(x,this.transform.getFrustum(D),D);for(let F of N)x.push(F)}else if(this.castsShadows&&d){let N=t.extendTileCover(x,D,d);for(let F of N)this._shadowCasterTiles[F.key]=!0,x.push(F)}}let C=this._updateRetainedTiles(x);if(yc(this._source.type)&&x.length!==0){let P={},D={},N=Object.keys(C);for(let j of N){let U=C[j],Z=this._tiles[j];if(!Z||Z.fadeEndTime&&Z.fadeEndTime<=n.q.now())continue;let Y=this.findLoadedParent(U,Math.max(U.overscaledZ-Gn.maxOverzooming,this._source.minzoom));Y&&(this._addTile(Y.tileID),P[Y.tileID.key]=Y.tileID),D[j]=U}let F=x[x.length-1].overscaledZ;for(let j in this._tiles){let U=this._tiles[j];if(C[j]||!U.hasData())continue;let Z=U.tileID;for(;Z.overscaledZ>F;){Z=Z.scaledTo(Z.overscaledZ-1);let Y=this._tiles[Z.key];if(Y&&Y.hasData()&&D[Z.key]){C[j]=U.tileID;break}}}for(let j in P)C[j]||(this._coveredTiles[j]=!0,C[j]=P[j])}for(let P in C)this._tiles[P].clearFadeHold();let z=n.bs(this._tiles,C);for(let P of z){let D=this._tiles[P];D.hasSymbolBuckets&&!D.holdingForFade()?D.setHoldDuration(this.map._fadeDuration):D.hasSymbolBuckets&&!D.symbolFadeFinished()||this._removeTile(+P)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){let o={};if(t.length===0)return o;let c={},d=t.reduce((M,C)=>Math.min(M,C.overscaledZ),1/0),p=t[0].overscaledZ,_=Math.max(p-Gn.maxOverzooming,this._source.minzoom),x=Math.max(p+Gn.maxUnderzooming,this._source.minzoom),b={};for(let M of t){let C=this._addTile(M);o[M.key]=M,C.hasData()||d<this._source.maxzoom&&(b[M.key]=M)}this._retainLoadedChildren(b,d,x,o);for(let M of t){let C=this._tiles[M.key];if(C.hasData())continue;if(M.canonical.z>=this._source.maxzoom){let P=M.children(this._source.maxzoom)[0],D=this.getTile(P);if(D&&D.hasData()){o[P.key]=P;continue}}else{let P=M.children(this._source.maxzoom);if(o[P[0].key]&&o[P[1].key]&&o[P[2].key]&&o[P[3].key])continue}let z=C.wasRequested();for(let P=M.overscaledZ-1;P>=_;--P){let D=M.scaledTo(P);if(c[D.key]||(c[D.key]=!0,C=this.getTile(D),!C&&z&&(C=this._addTile(D)),C&&(o[D.key]=D,z=C.wasRequested(),C.hasData())))break}}return o}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let t in this._tiles){let o=[],c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}o.push(d.key);let p=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(p),c)break;d=p}for(let p of o)this._loadedParentTiles[p]=c}}_addTile(t){let o=this._tiles[t.key];if(o)return o.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),o;o=this._cache.getAndRemove(t),o&&(this._setTileReloadTimer(t.key,o),o.tileID=t,this._state.initializeTileState(o,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,o)));let c=!!o;if(!c){let d=this.map?this.map.painter:null,p=this._source.tileSize*t.overscaleFactor();o=this._source.type==="raster-array"?new tl(t,p,this.transform.tileZoom,d,this._isRaster):new wa(t,p,this.transform.tileZoom,d,this._isRaster,this._source.worldview),this._loadTile(o,this._tileLoaded.bind(this,o,t.key,o.state))}return o.uses++,this._tiles[t.key]=o,c||this._source.fire(new n.A("dataloading",{tile:o,coord:o.tileID,dataType:"source"})),o}_setTileReloadTimer(t,o){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);let c=o.getExpiryTimeout();c&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},c))}_removeTile(t){let o=this._tiles[t];o&&(o.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),o.uses>0||(o.hasData()&&o.state!=="reloading"||o.state==="empty"?this._cache.add(o.tileID,o,o.getExpiryTimeout()):(o.aborted=!0,this._abortTile(o),this._unloadTile(o))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,o,c){let d=[],p=this.transform;if(!p)return d;let _=p.projection.name==="globe",x=n.aD(p.center.lng);for(let b in this._tiles){let M=this._tiles[b];if(c&&M.clearQueryDebugViz(),M.holdingForFade())continue;let C;if(_){let z=M.tileID.canonical;if(z.z===0){let P=[Math.abs(n.ay(x,...il(z,-1))-x),Math.abs(n.ay(x,...il(z,1))-x)];C=[0,2*P.indexOf(Math.min(...P))-1]}else{let P=[Math.abs(n.ay(x,...il(z,-1))-x),Math.abs(n.ay(x,...il(z,0))-x),Math.abs(n.ay(x,...il(z,1))-x)];C=[P.indexOf(Math.min(...P))-1]}}else C=[0];for(let z of C){let P=t.containsTile(M,p,o,z);P&&d.push(P)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,o){let c=this.getRenderableIds(t,o).map(p=>this._tiles[p].tileID),d=this.transform.projection.name==="globe";for(let p of c)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped()),p.expandedProjMatrix=d?this.transform.calculateProjMatrix(p.toUnwrapped(),!1,!0):p.projMatrix;return c}sortCoordinatesByDistance(t){let o=t.slice(),c=this.transform._camera.position,d=this.transform._camera.forward(),p={};for(let _ of o){let x=1/(1<<_.canonical.z);p[_.key]=((_.canonical.x+.5)*x+_.wrap-c[0])*d[0]+((_.canonical.y+.5)*x-c[1])*d[1]-c[2]*d[2]}return o.sort((_,x)=>p[_.key]-p[x.key]),o}hasTransition(){if(this._source.hasTransition())return!0;if(yc(this._source.type))for(let t in this._tiles){let o=this._tiles[t];if(o.fadeEndTime!==void 0&&o.fadeEndTime>=n.q.now())return!0}return!1}setFeatureState(t,o,c){this._state.updateState(t=t||"_geojsonTileLayer",o,c)}removeFeatureState(t,o,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",o,c)}getFeatureState(t,o){return this._state.getState(t=t||"_geojsonTileLayer",o)}setDependencies(t,o,c){let d=this._tiles[t];d&&d.setDependencies(o,c)}reloadTilesForDependencies(t,o){for(let c in this._tiles)this._tiles[c].hasDependency(t,o)&&this._reloadTile(+c,"reloading");this._cache.filter(c=>!c.hasDependency(t,o))}_preloadTiles(t,o){if(!this._sourceLoaded){let b=()=>{this._sourceLoaded&&(this._source.off("data",b),this._preloadTiles(t,o))};return void this._source.on("data",b)}let c=new Map,d=Array.isArray(t)?t:[t],p=this.map.painter.terrain,_=this.usedForTerrain&&p?p.getScaledDemTileSize():this._source.tileSize;for(let b of d){let M=b.coveringTiles({tileSize:_,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let C of M)c.set(C.key,C);this.usedForTerrain&&b.updateElevation(!1)}let x=Array.from(c.values());n.bt(x,(b,M)=>{let C=new wa(b,this._source.tileSize*b.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(C,z=>{this._source.type==="raster-dem"&&C.dem&&this._backfillDEM(C),M(z,C)})},o)}}function Ta(l,t){let o=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-o||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function yc(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function il(l,t){let o=1<<l.z;return[l.x/o+t,(l.x+1)/o+t]}Gn.maxOverzooming=10,Gn.maxUnderzooming=3;class Rf{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];let t=!1,o=!1;for(let c in this.style._mergedLayers){let d=this.style._mergedLayers[c];if(d.type==="fill-extrusion"||d.type==="building")this.layers.push({layer:d,visible:t,visibilityChanged:o});else if(d.type==="model"){let p=this.style.getLayerSource(d);p&&p.type==="batched-model"&&this.layers.push({layer:d,visible:t,visibilityChanged:o})}}}onNewFrame(t){this.layersGotHidden=!1;for(let o of this.layers){let c=o.layer,d=!1;c.type==="fill-extrusion"?d=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="building"?d=!c.isHidden(t)&&c.paint.get("building-opacity")>0:c.type==="model"&&(d=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!d&&o.visible,o.visible=d}}updateZOffset(t,o){this.currentBuildingBuckets=[];for(let d of this.layers){let p=d.layer,_=this.style.getLayerSourceCache(p),x=1;p.type==="fill-extrusion"?x=d.visible?p.paint.get("fill-extrusion-vertical-scale"):0:p.type==="building"&&(x=d.visible?p.paint.get("building-vertical-scale"):0);let b=_?_.getTile(o):null;if(!b&&_)for(let M in _._tiles){let C=_._tiles[M];if(o.canonical.isChildOf(C.tileID.canonical)){b=C;break}}this.currentBuildingBuckets.push({bucket:b?b.getBucket(p):null,tileID:b?b.tileID:o,verticalScale:x})}t.hasAnyZOffset=!1;let c=!1;for(let d=0;d<t.symbolInstances.length;d++){let p=t.symbolInstances.get(d),_=p.zOffset,x=this._getHeightAtTileOffset(o,p.tileAnchorX,p.tileAnchorY);p.zOffset=x!==Number.NEGATIVE_INFINITY?x:_,c||_===p.zOffset||(c=!0),t.hasAnyZOffset||p.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,o,c,d){let p=o,_=c;if(t.canonical.z!==d.canonical.z){let x=d.canonical,b=1/(1<<t.canonical.z-x.z);p=(o+t.canonical.x*n.aj)*b-x.x*n.aj|0,_=(c+t.canonical.y*n.aj)*b-x.y*n.aj|0}return{tileX:p,tileY:_}}_getHeightAtTileOffset(t,o,c){let d,p;for(let _=0;_<this.layers.length;++_){let x=this.layers[_].layer;if(x.type!=="fill-extrusion"&&x.type!=="building")continue;let{bucket:b,tileID:M,verticalScale:C}=this.currentBuildingBuckets[_];if(!b)continue;let{tileX:z,tileY:P}=this._mapCoordToOverlappingTile(t,o,c,M),D=b.getHeightAtTileCoord(z,P);D&&D.height!==void 0&&(D.hidden?d=D.height:p=Math.max(D.height*C,p||0))}if(p!==void 0)return p;for(let _=0;_<this.layers.length;++_){let x=this.layers[_];if(x.layer.type!=="model"||!x.visible)continue;let{bucket:b,tileID:M}=this.currentBuildingBuckets[_];if(!b)continue;let{tileX:C,tileY:z}=this._mapCoordToOverlappingTile(t,o,c,M),P=b.getHeightAtTileCoord(C,z);if(P&&!P.hidden)return P.height===void 0&&d!==void 0?Math.min(P.maxHeight,d)*P.verticalScale:P.height?P.height*P.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Lf(l,t){let o={};for(let c in l)c!=="ref"&&(o[c]=l[c]);return n.bu.forEach(c=>{c in t&&(o[c]=t[c])}),o}function xc(l){l=l.slice();let t=Object.create(null);for(let o=0;o<l.length;o++)t[l[o].id]=l[o];for(let o=0;o<l.length;o++)"ref"in l[o]&&(l[o]=Lf(l[o],t[l[o].ref]));return l}let wi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Ch(l,t,o){o.push({command:wi.addSource,args:[l,t[l]]})}function rl(l,t,o){t.push({command:wi.removeSource,args:[l]}),o[l]=!0}function vc(l,t,o,c){rl(l,o,c),Ch(l,t,o)}function dg(l,t,o){let c;for(c in l[o])if(l[o].hasOwnProperty(c)&&c!=="data"&&!n.bv(l[o][c],t[o][c]))return!1;for(c in t[o])if(t[o].hasOwnProperty(c)&&c!=="data"&&!n.bv(l[o][c],t[o][c]))return!1;return!0}function bc(l,t,o,c,d,p){let _;for(_ in t=t||{},l=l||{})l.hasOwnProperty(_)&&(n.bv(l[_],t[_])||o.push({command:p,args:[c,_,t[_],d]}));for(_ in t)t.hasOwnProperty(_)&&!l.hasOwnProperty(_)&&(n.bv(l[_],t[_])||o.push({command:p,args:[c,_,t[_],d]}))}function Sa(l){return l.id}function qs(l,t){return l[t.id]=t,l}function wc(l,t,o){let c=t.createTileMatrix(l,l.worldSize,o.toUnwrapped());return n.az(new Float32Array(16),l.projMatrix,c)}function zf(l,t,o){if(t.projection.name===o.projection.name)return l.projMatrix;let c=o.clone();return c.setProjection(t.projection),wc(c,t.getProjection(),l)}function Ph(l,t,o){return t.name===o.projection.name?l.projMatrix:wc(o,t,l)}class Df{constructor(t,o){this.reset(t,o)}reset(t,o){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(o||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=n.ay(t,0,1);let o=1,c=this._distances[o],d=t*this.paddedLength+this.padding;for(;c<d&&o<this._distances.length;)c=this._distances[++o];let p=o-1,_=this._distances[p],x=c-_,b=x>0?(d-_)/x:0;return this.points[p].mult(1-b).add(this.points[o].mult(b))}}class nl{constructor(t,o,c){let d=this.boxCells=[],p=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(o/c);for(let _=0;_<this.xCellCount*this.yCellCount;_++)d.push([]),p.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=o,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/o,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,o,c,d,p){this._forEachCell(o,c,d,p,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(o),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(p)}insertCircle(t,o,c,d){this._forEachCell(o-d,c-d,o+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(o),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,o,c,d,p,_){this.boxCells[p].push(_)}_insertCircleCell(t,o,c,d,p,_){this.circleCells[p].push(_)}_query(t,o,c,d,p,_){if(c<0||t>this.width||d<0||o>this.height)return!p&&[];let x=[];if(t<=0&&o<=0&&this.width<=c&&this.height<=d){if(p)return!0;for(let b=0;b<this.boxKeys.length;b++)x.push({key:this.boxKeys[b],x1:this.bboxes[4*b],y1:this.bboxes[4*b+1],x2:this.bboxes[4*b+2],y2:this.bboxes[4*b+3]});for(let b=0;b<this.circleKeys.length;b++){let M=this.circles[3*b],C=this.circles[3*b+1],z=this.circles[3*b+2];x.push({key:this.circleKeys[b],x1:M-z,y1:C-z,x2:M+z,y2:C+z})}return _?x.filter(_):x}return this._forEachCell(t,o,c,d,this._queryCell,x,{hitTest:p,seenUids:{box:{},circle:{}}},_),p?x.length>0:x}_queryCircle(t,o,c,d,p){let _=t-c,x=t+c,b=o-c,M=o+c;if(x<0||_>this.width||M<0||b>this.height)return!d&&[];let C=[];return this._forEachCell(_,b,x,M,this._queryCellCircle,C,{hitTest:d,circle:{x:t,y:o,radius:c},seenUids:{box:{},circle:{}}},p),d?C.length>0:C}query(t,o,c,d,p){return this._query(t,o,c,d,!1,p)}hitTest(t,o,c,d,p){return this._query(t,o,c,d,!0,p)}hitTestCircle(t,o,c,d){return this._queryCircle(t,o,c,!0,d)}_queryCell(t,o,c,d,p,_,x,b){let M=x.seenUids,C=this.boxCells[p];if(C!==null){let P=this.bboxes;for(let D of C)if(!M.box[D]){M.box[D]=!0;let N=4*D;if(t<=P[N+2]&&o<=P[N+3]&&c>=P[N+0]&&d>=P[N+1]&&(!b||b(this.boxKeys[D]))){if(x.hitTest)return _.push(!0),!0;_.push({key:this.boxKeys[D],x1:P[N],y1:P[N+1],x2:P[N+2],y2:P[N+3]})}}}let z=this.circleCells[p];if(z!==null){let P=this.circles;for(let D of z)if(!M.circle[D]){M.circle[D]=!0;let N=3*D;if(this._circleAndRectCollide(P[N],P[N+1],P[N+2],t,o,c,d)&&(!b||b(this.circleKeys[D]))){if(x.hitTest)return _.push(!0),!0;{let F=P[N],j=P[N+1],U=P[N+2];_.push({key:this.circleKeys[D],x1:F-U,y1:j-U,x2:F+U,y2:j+U})}}}}}_queryCellCircle(t,o,c,d,p,_,x,b){let M=x.circle,C=x.seenUids,z=this.boxCells[p];if(z!==null){let D=this.bboxes;for(let N of z)if(!C.box[N]){C.box[N]=!0;let F=4*N;if(this._circleAndRectCollide(M.x,M.y,M.radius,D[F+0],D[F+1],D[F+2],D[F+3])&&(!b||b(this.boxKeys[N])))return _.push(!0),!0}}let P=this.circleCells[p];if(P!==null){let D=this.circles;for(let N of P)if(!C.circle[N]){C.circle[N]=!0;let F=3*N;if(this._circlesCollide(D[F],D[F+1],D[F+2],M.x,M.y,M.radius)&&(!b||b(this.circleKeys[N])))return _.push(!0),!0}}}_forEachCell(t,o,c,d,p,_,x,b){let M=this._convertToXCellCoord(t),C=this._convertToYCellCoord(o),z=this._convertToXCellCoord(c),P=this._convertToYCellCoord(d);for(let D=M;D<=z;D++)for(let N=C;N<=P;N++)if(p.call(this,t,o,c,d,this.xCellCount*N+D,_,x,b))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,o,c,d,p,_){let x=d-t,b=p-o,M=c+_;return M*M>x*x+b*b}_circleAndRectCollide(t,o,c,d,p,_,x){let b=(_-d)/2,M=Math.abs(t-(d+b));if(M>b+c)return!1;let C=(x-p)/2,z=Math.abs(o-(p+C));if(z>C+c)return!1;if(M<=b||z<=C)return!0;let P=M-b,D=z-C;return P*P+D*D<=c*c}}let Ea={unknown:0,flipRequired:1,flipNotRequired:2},Of=Math.tan(85*Math.PI/180);function Tc(l,t,o,c,d,p,_){let x=n.bz();if(o)if(p.name==="globe"){let b=n.bA(d,t);n.az(x,x,b)}else{let b=n.bB([],_);x[0]=b[0],x[1]=b[1],x[4]=b[2],x[5]=b[3],c||n.by(x,x,d.angle)}else n.az(x,d.labelPlaneMatrix,l);return x}function ol(l,t,o,c,d,p,_){let x=Tc(l,t,o,c,d,p,_);return p.name==="globe"&&o||(x[2]=x[6]=x[10]=x[14]=0),x}function Ms(l,t,o,c,d,p,_){if(o){if(p.name==="globe"){let x=Tc(l,t,o,c,d,p,_);return n.bi(x,x),n.az(x,l,x),x}{let x=n.bw(l),b=n.bx([]);return b[0]=_[0],b[1]=_[1],b[4]=_[2],b[5]=_[3],n.az(x,x,b),c||n.by(x,x,-d.angle),x}}return d.glCoordMatrix}function mo(l,t,o,c){let d=[l,t,o,1];o?n.aA(d,d,c):kf(d,d,c);let p=d[3];return d[0]/=p,d[1]/=p,d[2]/=p,d}function dd(l,t){return Math.min(.5+l/t*.5,1.5)}function pd(l,t){let o=l[0]/l[3],c=l[1]/l[3];return o>=-t[0]&&o<=t[0]&&c>=-t[1]&&c<=t[1]}function Ia(l,t,o,c,d,p,_,x,b,M){let C=o.transform,z=c?l.textSizeData:l.iconSizeData,P=n.bH(z,o.transform.zoom),D=C.projection.name==="globe",N=[256/o.width*2+1,256/o.height*2+1],F=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;F.clear();let j=null;D&&(j=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);let U=l.lineVertexArray,Z=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,Y=o.transform.width/o.transform.height,Q,ne=!1;for(let he=0;he<Z.length;he++){let de=Z.get(he),{numGlyphs:oe,writingMode:se}=de;if(se!==n.bI.vertical||ne||Q===n.bI.horizontal||(ne=!0),Q=se,(de.hidden||se===n.bI.vertical)&&!ne){sl(oe,F);continue}ne=!1;let le=new n.P(de.tileAnchorX,de.tileAnchorY),{x:Me,y:_e,z:Ve}=C.projection.projectTilePoint(le.x,le.y,M.canonical);if(b){let[Mt,Ot,yt]=b(le);Me+=Mt,_e+=Ot,Ve+=yt}let ze=[Me,_e,Ve,1];if(n.aA(ze,ze,t),!pd(ze,N)){sl(oe,F);continue}let je=ze[3],rt=dd(o.transform.getCameraToCenterDistance(C.projection),je),Ce=n.bJ(z,P,de),me=_?Ce/rt:Ce*rt,ke=mo(Me,_e,Ve,d);if(ke[3]<=0){sl(oe,F);continue}let Pe={},$e=n.al(l.layers[0].layout.get("text-max-angle")),Ze=Math.cos($e),Ye=_?null:b,ct=Rh(de,me,!1,x,t,d,p,l.glyphOffsetArray,U,F,j,ke,le,Pe,Y,Ye,C.projection,M,_,Ze);ne=ct.useVertical,Ye&&ct.needsFlipping&&(Pe={}),(ct.notEnoughRoom||ne||ct.needsFlipping&&Rh(de,me,!0,x,t,d,p,l.glyphOffsetArray,U,F,j,ke,le,Pe,Y,Ye,C.projection,M,_,Ze).notEnoughRoom)&&sl(oe,F)}c?(l.text.dynamicLayoutVertexBuffer.updateData(F),j&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(j)):(l.icon.dynamicLayoutVertexBuffer.updateData(F),j&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(j))}function Jn(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j){let{lineStartIndex:U,glyphStartIndex:Z,segment:Y}=x,Q=Z+x.numGlyphs,ne=U+x.lineLength,he=t.getoffsetX(Z),de=t.getoffsetX(Q-1),oe=Sc(l*he,o,c,d,p,_,Y,U,ne,b,M,C,z,P,!0,D,N,F,j);if(!oe)return null;let se=Sc(l*de,o,c,d,p,_,Y,U,ne,b,M,C,z,P,!0,D,N,F,j);return se?{first:oe,last:se}:null}function fd(l,t,o,c){return l===n.bI.horizontal&&Math.abs(c)>Math.abs(o)?{useVertical:!0}:l===n.bI.vertical?c>0?{needsFlipping:!0}:null:t!==Ea.unknown&&function(d,p){return d===0||Math.abs(p/d)>Of}(o,c)?t===Ea.flipRequired?{needsFlipping:!0}:null:o<0?{needsFlipping:!0}:null}function Rh(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y){let Q=t/24,ne=l.lineOffsetX*Q,he=l.lineOffsetY*Q,{lineStartIndex:de,glyphStartIndex:oe,numGlyphs:se,segment:le,writingMode:Me,flipState:_e}=l,Ve=de+l.lineLength,ze=je=>{if(C){let[ke,Pe,$e]=je.up,Ze=M.length;n.bK(C,Ze+0,ke,Pe,$e),n.bK(C,Ze+1,ke,Pe,$e),n.bK(C,Ze+2,ke,Pe,$e),n.bK(C,Ze+3,ke,Pe,$e)}let[rt,Ce,me]=je.point;n.bL(M,rt,Ce,me,je.angle)};if(se>1){let je=Jn(Q,x,ne,he,o,z,P,l,b,p,D,F,!1,j,U,Z,Y);if(!je)return{notEnoughRoom:!0};if(c&&!o){let[rt,Ce,me]=je.first.point,[ke,Pe,$e]=je.last.point;[rt,Ce]=mo(rt,Ce,me,_),[ke,Pe]=mo(ke,Pe,$e,_);let Ze=fd(Me,_e,(ke-rt)*N,Pe-Ce);if(l.flipState=Ze&&Ze.needsFlipping?Ea.flipRequired:Ea.flipNotRequired,Ze)return Ze}ze(je.first);for(let rt=oe+1;rt<oe+se-1;rt++){let Ce=Sc(Q*x.getoffsetX(rt),ne,he,o,z,P,le,de,Ve,b,p,D,F,!1,!1,j,U,Z,Y);if(!Ce)return M.length-=4*(rt-oe),{notEnoughRoom:!0};ze(Ce)}ze(je.last)}else{if(c&&!o){let rt=mo(P.x,P.y,0,d),Ce=de+le+1,me=new n.P(b.getx(Ce),b.gety(Ce)),ke=mo(me.x,me.y,0,d),Pe=ke[3]>0?ke:ki(P,me,rt,1,d,void 0,j,U.canonical),$e=fd(Me,_e,(Pe[0]-rt[0])*N,Pe[1]-rt[1]);if(l.flipState=$e&&$e.needsFlipping?Ea.flipRequired:Ea.flipNotRequired,$e)return $e}let je=Sc(Q*x.getoffsetX(oe),ne,he,o,z,P,le,de,Ve,b,p,D,F,!1,!1,j,U,Z,Y);if(!je)return{notEnoughRoom:!0};ze(je)}return{}}function md(l,t,o,c,d){let{x:p,y:_,z:x}=c.projectTilePoint(l.x,l.y,t);if(!d)return mo(p,_,x,o);let[b,M,C]=d(l);return mo(p+b,_+M,x+C,o)}function ki(l,t,o,c,d,p,_,x){let b=md(l.sub(t)._unit()._add(l),x,d,_,p);return n.at(b,o,b),n.au(b,b),n.bE(b,o,b,c)}function Sc(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z){let Y=c?l-t:l+t,Q=Y>0?1:-1,ne=0;c&&(Q*=-1,ne=Math.PI),Q<0&&(ne+=Math.PI);let he=x+_+(Q>0?0:1)|0,de=d,oe=d,se=0,le=0,Me=Math.abs(Y),_e=[],Ve=[],ze=p,je=ze,rt=n.bC([]),Ce=()=>ki(je,ze,oe,Me-se+1,C,P,F,j.canonical);for(;se+le<=Me;){if(he+=Q,he<x||he>=b)return null;if(oe=de,je=ze,_e.push(oe),D&&Ve.push(je),ze=new n.P(M.getx(he),M.gety(he)),de=z[he],!de){let yt=md(ze,j.canonical,C,F,P);de=yt[3]>0?z[he]=yt:Ce()}se+=le;let Mt=n.at([],de,oe),Ot=n.bD(oe,de);if(o&&Ot>0&&le>0&&n.bG(rt,Mt)/(le*Ot)<Z)return null;le=Ot,rt=Mt}N&&P&&(z[he]&&(de=Ce(),le=n.bD(oe,de),rt=n.at([],de,oe)),z[he]=de);let me=(Me-se)/le,ke=ze.sub(je)._mult(me)._add(je),Pe=n.bE([],oe,rt,me),$e=[0,0,1],Ze=rt[0],Ye=rt[1];if(U&&($e=F.upVector(j.canonical,ke.x,ke.y),$e[0]!==0||$e[1]!==0||$e[2]!==1)){let Mt=[$e[2],0,-$e[0]],Ot=n.bF([],$e,Mt);n.au(Mt,Mt),n.au(Ot,Ot),Ze=n.bG(rt,Mt),Ye=n.bG(rt,Ot)}if(o){let Mt=n.bF([],$e,rt);n.au(Mt,Mt),n.bE(Pe,Pe,Mt,o*Q)}let ct=ne+Math.atan2(Ye,Ze);return _e.push(Pe),D&&Ve.push(ke),{point:Pe,angle:ct,path:_e,tilePath:Ve,up:$e}}function sl(l,t){let o=t.length,c=o+4*l;t.resize(c),t.float32.fill(-1/0,4*o,4*c)}function kf(l,t,o){let c=t[0],d=t[1];return l[0]=o[0]*c+o[4]*d+o[12],l[1]=o[1]*c+o[5]*d+o[13],l[3]=o[3]*c+o[7]*d+o[15],l}let Bt=100;class Ff{constructor(t,o,c=new nl(t.width+200,t.height+200,25),d=new nl(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=d,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Bt,this.screenBottomBoundary=t.height+Bt,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=o}placeCollisionBox(t,o,c,d,p,_,x,b,M,C,z){let P=c.projectedAnchorX,D=c.projectedAnchorY,N=c.projectedAnchorZ,F=c.tileAnchorX,j=c.tileAnchorY,U=c.elevation,Z=c.tileID,Y=t.getProjection();if(U&&Z){let[Ve,ze,je]=Y.upVector(Z.canonical,c.tileAnchorX,c.tileAnchorY),rt=Y.upVectorScale(Z.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;P+=Ve*U*rt,D+=ze*U*rt,N+=je*U*rt}let Q=t.projection.name==="globe",ne=t.projection.name==="globe"?n.ah(this.transform.zoom):0;if(Z&&Q&&ne<1&&!_){let Ve=1<<Z.canonical.z,ze=n.bM(F,j);n.bN(ze,ze,1/n.aj),n.bO(ze,ze,n.bM(Z.canonical.x,Z.canonical.y)),n.bN(ze,ze,1/Ve),n.bP(ze,ze,n.bM(d[0],d[1])),ze[0]=n.bQ(ze[0],-.5,.5),n.bN(ze,ze,n.aj);let je=n.bR(ze[0],ze[1],n.aj/(2*Math.PI),1);n.aA(je,je,p),P=n.ai(P,je[0],ne),D=n.ai(D,je[1],ne),N=n.ai(N,je[2],ne)}let he=this.projectAndGetPerspectiveRatio(C,P,D,N,c.tileID,Y.name==="globe"||!!U||this.transform.pitch>0,Y),de=M*he.perspectiveRatio,oe=(c.x1*o+x.x-c.padding)*de+he.point.x,se=(c.y1*o+x.y-c.padding)*de+he.point.y,le=(c.x2*o+x.x+c.padding)*de+he.point.x,Me=(c.y2*o+x.y+c.padding)*de+he.point.y,_e=he.perspectiveRatio<=.55||he.occluded;return!this.isInsideGrid(oe,se,le,Me)||!b&&this.grid.hitTest(oe,se,le,Me,z)||_e?{box:[],offscreen:!1,occluded:he.occluded}:{box:[oe,se,le,Me],offscreen:this.isOffscreen(oe,se,le,Me),occluded:!1}}placeCollisionCircles(t,o,c,d,p,_,x,b,M,C,z,P,D,N,F){let j=[],U=this.transform.elevation,Z=t.getProjection(),Y=U?U.getAtTileOffsetFunc(F,this.transform.center.lat,this.transform.worldSize,Z):null,Q=new n.P(c.tileAnchorX,c.tileAnchorY),{x:ne,y:he,z:de}=Z.projectTilePoint(Q.x,Q.y,F.canonical);if(Y){let[$e,Ze,Ye]=Y(Q);ne+=$e,he+=Ze,de+=Ye}let oe=Z.name==="globe",se=this.projectAndGetPerspectiveRatio(x,ne,he,de,F,oe||!!U||this.transform.pitch>0,Z),{perspectiveRatio:le}=se,Me=(z?_/le:_*le)/n.bU,_e=mo(ne,he,de,b),Ve=c.lineOffsetX*Me,ze=c.lineOffsetY*Me,je=n.al(t.layers[0].layout.get("text-max-angle")),rt=Math.cos(je),Ce=se.signedDistanceFromCamera>0?Jn(Me,p,Ve,ze,!1,_e,Q,c,d,b,{},U&&!z?Y:null,z&&!!U,Z,F,z,rt):null,me=!1,ke=!1,Pe=!0;if(Ce&&!se.occluded){let $e=.5*D*le+N,Ze=new n.P(-100,-100),Ye=new n.P(this.screenRightBoundary,this.screenBottomBoundary),ct=new Df,{first:Mt,last:Ot}=Ce,yt=Mt.path.length,zt=[];for(let Jt=yt-1;Jt>=1;Jt--)zt.push(Mt.path[Jt]);for(let Jt=1;Jt<Ot.path.length;Jt++)zt.push(Ot.path[Jt]);let Rt=2.5*$e;M&&(zt=zt.map(([Jt,ai,Ti],Yt)=>(Y&&!oe&&(Ti=Y(Yt<yt-1?Mt.tilePath[yt-1-Yt]:Ot.tilePath[Yt-yt+2])[2]),mo(Jt,ai,Ti,M))),zt.some(Jt=>Jt[3]<=0)&&(zt=[]));let $t=[];if(zt.length>0){let Jt=1/0,ai=-1/0,Ti=1/0,Yt=-1/0;for(let Si of zt)Jt=Math.min(Jt,Si[0]),Ti=Math.min(Ti,Si[1]),ai=Math.max(ai,Si[0]),Yt=Math.max(Yt,Si[1]);ai>=Ze.x&&Jt<=Ye.x&&Yt>=Ze.y&&Ti<=Ye.y&&($t=[zt.map(Si=>new n.P(Si[0],Si[1]))],(Jt<Ze.x||ai>Ye.x||Ti<Ze.y||Yt>Ye.y)&&($t=n.bS($t,Ze.x,Ze.y,Ye.x,Ye.y)))}for(let Jt of $t){ct.reset(Jt,.25*$e);let ai=0;ai=ct.length<=.5*$e?1:Math.ceil(ct.paddedLength/Rt)+1;for(let Ti=0;Ti<ai;Ti++){let Yt=Ti/Math.max(ai-1,1),Si=ct.lerp(Yt),Mi=Si.x+Bt,Wi=Si.y+Bt;j.push(Mi,Wi,$e,0);let ni=Mi-$e,Ei=Wi-$e,Ii=Mi+$e,Ri=Wi+$e;if(Pe=Pe&&this.isOffscreen(ni,Ei,Ii,Ri),ke=ke||this.isInsideGrid(ni,Ei,Ii,Ri),!o&&this.grid.hitTestCircle(Mi,Wi,$e,P)&&(me=!0,!C))return{circles:[],offscreen:!1,collisionDetected:me,occluded:!1}}}}return{circles:!C&&me||!ke?[]:j,offscreen:Pe,collisionDetected:me,occluded:se.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let o=[],c=1/0,d=1/0,p=-1/0,_=-1/0;for(let C of t){let z=new n.P(C.x+Bt,C.y+Bt);c=Math.min(c,z.x),d=Math.min(d,z.y),p=Math.max(p,z.x),_=Math.max(_,z.y),o.push(z)}let x=this.grid.query(c,d,p,_).concat(this.ignoredGrid.query(c,d,p,_)),b={},M={};for(let C of x){let z=C.key;if(b[z.bucketInstanceId]===void 0&&(b[z.bucketInstanceId]={}),b[z.bucketInstanceId][z.featureIndex])continue;let P=[new n.P(C.x1,C.y1),new n.P(C.x2,C.y1),new n.P(C.x2,C.y2),new n.P(C.x1,C.y2)];n.bT(o,P)&&(b[z.bucketInstanceId][z.featureIndex]=!0,M[z.bucketInstanceId]===void 0&&(M[z.bucketInstanceId]=[]),M[z.bucketInstanceId].push(z.featureIndex))}return M}insertCollisionBox(t,o,c,d,p){(o?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:d,collisionGroupID:p},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,o,c,d,p){let _=o?this.ignoredGrid:this.grid,x={bucketInstanceId:c,featureIndex:d,collisionGroupID:p};for(let b=0;b<t.length;b+=4)_.insertCircle(x,t[b],t[b+1],t[b+2])}projectAndGetPerspectiveRatio(t,o,c,d,p,_,x){let b=[o,c,d,1],M=!1;d||this.transform.pitch>0?(n.aA(b,b,t),this.fogState&&p&&x.name!=="globe"&&(M=function(P,D,N,F,j,U){let Z=U.calculateFogTileMatrix(j),Y=[D,N,F];return n.ad(Y,Y,Z),kt(P,n.ae(Y),U.pitch,U._fov)}(this.fogState,o,c,d,p.toUnwrapped(),this.transform)>.9)):kf(b,b,t);let C=b[3];return{point:new n.P((b[0]/C+1)/2*this.transform.width+Bt,(-b[1]/C+1)/2*this.transform.height+Bt),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(x)/C*.5,1.5),signedDistanceFromCamera:C,occluded:_&&b[2]>C||M}}isOffscreen(t,o,c,d){return c<Bt||t>=this.screenRightBoundary||d<Bt||o>this.screenBottomBoundary}isInsideGrid(t,o,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&o<this.gridBottomBoundary}getViewportMatrix(){let t=n.bx([]);return n.bo(t,t,[-100,-100,0]),t}}class Ec{constructor(t,o,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?o:-o))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Aa{constructor(t,o,c,d,p,_=!1){this.text=new Ec(t?t.text:null,o,c,p),this.icon=new Ec(t?t.icon:null,o,d,p),this.clipped=_}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class _o{constructor(t,o,c,d=!1){this.text=t,this.icon=o,this.skipFade=c,this.clipped=d}}class _d{constructor(){this.invProjMatrix=n.bz(),this.viewportMatrix=n.bz(),this.circles=[]}}class al{constructor(t,o,c,d,p){this.bucketInstanceId=t,this.featureIndex=o,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=p}}class Dt{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){let o=++this.maxGroupID;this.collisionGroups[t]={ID:o,predicate:c=>c.collisionGroupID===o}}return this.collisionGroups[t]}}function zi(l,t,o,c,d){let{horizontalAlign:p,verticalAlign:_}=n.bZ(l),x=-(p-.5)*t,b=-(_-.5)*o,M=n.b_(l,c);return new n.P(x+M[0]*d,b+M[1]*d)}function Di(l,t,o,c,d){let p=new n.P(l,t);return o&&p._rotate(c?d:-d),p}class Qn{constructor(t,o,c,d,p,_){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Ff(this.transform,p),this.buildingIndex=_,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=o,this.retainedQueryData={},this.collisionGroups=new Dt(c),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,o,c,d,p=1){let _=c.getBucket(o),x=c.latestFeatureIndex;if(!_||!x||o.fqid!==_.layerIds[0])return;let b=_.layers[0].layout,M=_.layers[0].paint,C=c.collisionBoxArray,z=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),P=c.tileSize/n.aj,D=c.tileID.toUnwrapped();this.transform.setProjection(_.projection);let N=(F=c.tileID,j=_.getProjection(),U=this.transform,j.name===this.projection?U.calculateProjMatrix(F.toUnwrapped()):wc(U,j,F));var F,j,U;let Z=b.get("text-pitch-alignment")==="map",Y=b.get("text-rotation-alignment")==="map";o.compileFilter(o.options);let Q=o.dynamicFilter(),ne=o.dynamicFilterNeedsFeature(),he=this.transform.calculatePixelsToTileUnitsMatrix(c),de=ol(N,c.tileID.canonical,Z,Y,this.transform,_.getProjection(),he),oe=null,se=_.getProjection().createInversionMatrix(this.transform,c.tileID.canonical);if(Z){let me=Ms(N,c.tileID.canonical,Z,Y,this.transform,_.getProjection(),he);oe=n.az([],this.transform.labelPlaneMatrix,me)}let le=null;Q&&c.latestFeatureIndex&&(le={unwrappedTileID:D,dynamicFilter:Q,dynamicFilterNeedsFeature:ne}),this.retainedQueryData[_.bucketInstanceId]=new al(_.bucketInstanceId,x,_.sourceLayerIndex,_.index,c.tileID);let[Me,_e]=_.layers[0].layout.get("text-size-scale-range"),Ve=n.ay(p,Me,_e),[ze,je]=b.get("icon-size-scale-range"),rt=n.ay(p,ze,je),Ce={bucket:_,layout:b,paint:M,posMatrix:N,invMatrix:se,mercatorCenter:[n.aD(this.transform.center.lng),n.aH(this.transform.center.lat)],textLabelPlaneMatrix:de,labelToScreenMatrix:oe,clippingData:le,scale:z,textPixelRatio:P,holdingForFade:c.holdingForFade(),collisionBoxArray:C,partiallyEvaluatedTextSize:n.bH(_.textSizeData,this.transform.zoom,Ve),partiallyEvaluatedIconSize:n.bH(_.iconSizeData,this.transform.zoom,rt),collisionGroup:this.collisionGroups.get(_.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(d)for(let me of _.sortKeyRanges){let{sortKey:ke,symbolInstanceStart:Pe,symbolInstanceEnd:$e}=me;t.push({sortKey:ke,symbolInstanceStart:Pe,symbolInstanceEnd:$e,parameters:Ce})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:_.symbolInstances.length,parameters:Ce})}attemptAnchorPlacement(t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y,Q,ne){let{textOffset0:he,textOffset1:de,crossTileID:oe}=F,se=[he,de],le=zi(t,_,x,se,b),Me=this.collisionIndex.placeCollisionBox(U,b,o,c,d,p,Di(le.x,le.y,M,C,this.transform.angle),N,z,P,D.predicate);if(Y){let _e=U.getSymbolInstanceIconSize(ne,this.transform.zoom,F.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(U,_e,Y,c,d,p,Di(le.x,le.y,M,C,this.transform.angle),N,z,P,D.predicate).box.length===0)return}if(Me.box.length>0){let _e;return this.prevPlacement&&this.prevPlacement.variableOffsets[oe]&&this.prevPlacement.placements[oe]&&this.prevPlacement.placements[oe].text&&(_e=this.prevPlacement.variableOffsets[oe].anchor),this.variableOffsets[oe]={textOffset:se,width:_,height:x,anchor:t,textScale:b,prevAnchor:_e},this.markUsedJustification(U,t,F,Z),U.allowVerticalPlacement&&(this.markUsedOrientation(U,Z,F),this.placedOrientations[oe]=Z),{shift:le,placedGlyphBoxes:Me}}}placeLayerBucketPart(t,o,c,d,p=1){let{bucket:_,layout:x,paint:b,posMatrix:M,textLabelPlaneMatrix:C,labelToScreenMatrix:z,clippingData:P,textPixelRatio:D,mercatorCenter:N,invMatrix:F,holdingForFade:j,collisionBoxArray:U,partiallyEvaluatedTextSize:Z,partiallyEvaluatedIconSize:Y,collisionGroup:Q,latestFeatureIndex:ne}=t.parameters,he=x.get("text-optional"),de=x.get("icon-optional"),oe=x.get("text-allow-overlap"),se=x.get("icon-allow-overlap"),le=x.get("text-rotation-alignment")==="map",Me=x.get("icon-rotation-alignment")==="map",_e=x.get("text-pitch-alignment")==="map",Ve=b.get("symbol-z-offset"),ze=x.get("symbol-elevation-reference")==="sea",je=x.get("symbol-placement"),[rt,Ce]=x.get("text-size-scale-range"),[me,ke]=x.get("icon-size-scale-range"),Pe=n.ay(p,rt,Ce),$e=n.ay(p,me,ke),Ze=x.get("text-variable-anchor"),Ye=le&&je!=="point",ct=Me&&je!=="point",Mt=Ze&&_.hasTextData(),Ot=_.hasIconTextFit()&&Mt&&_.hasIconData();this.transform.setProjection(_.projection);let yt=Mt||Ye,zt=ct||Ot,Rt=oe&&(se||!_.hasIconData()||de),$t=se&&(oe||!_.hasTextData()||he),Jt=!Ve.isConstant();!_.collisionArrays&&U&&_.deserializeCollisionBoxes(U),c&&d&&_.updateCollisionDebugBuffers(this.transform.zoom,U,Pe,$e);let ai=(Yt,Si,Mi)=>{let{crossTileID:Wi,numVerticalGlyphVertices:ni}=Yt,Ei=null;if(P&&P.dynamicFilterNeedsFeature||Jt){let Cr=this.retainedQueryData[_.bucketInstanceId];Ei=ne.loadFeature({featureIndex:Yt.featureIndex,bucketIndex:Cr.bucketIndex,sourceLayerIndex:Cr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(P&&!(0,P.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Ei,this.retainedQueryData[_.bucketInstanceId].tileID.canonical,new n.P(Yt.tileAnchorX,Yt.tileAnchorY),this.transform.calculateDistanceTileData(P.unwrappedTileID)))return this.placements[Wi]=new _o(!1,!1,!1,!0),void o.add(Wi);let Ii=Ve.evaluate(Ei,{});if(o.has(Wi))return;if(j)return void(this.placements[Wi]=new _o(!1,!1,!1));let Ri=!1,li=!1,Vi=!0,Ci=!1,yr=!1,bi=null,Li={box:null,offscreen:null,occluded:null},$i={box:null},kr=null,Dr=null,Br=null,hn=0,Jo=0,kn=0;Mi.textFeatureIndex?hn=Mi.textFeatureIndex:Yt.useRuntimeCollisionCircles&&(hn=Yt.featureIndex),Mi.verticalTextFeatureIndex&&(Jo=Mi.verticalTextFeatureIndex);let to=Cr=>{Cr.tileID=this.retainedQueryData[_.bucketInstanceId].tileID;let Sr=this.transform.elevation;Cr.elevation=ze?Ii:Ii+(Sr?Sr.getAtTileOffset(Cr.tileID,Cr.tileAnchorX,Cr.tileAnchorY):0),Cr.elevation+=Yt.zOffset},yn=Mi.textBox;if(yn){to(yn);let Cr=Ki=>{let Wr=n.bI.horizontal;if(_.allowVerticalPlacement&&!Ki&&this.prevPlacement){let un=this.prevPlacement.placedOrientations[Wi];un&&(this.placedOrientations[Wi]=un,Wr=un,this.markUsedOrientation(_,Wr,Yt))}return Wr},Sr=(Ki,Wr)=>{if(_.allowVerticalPlacement&&ni>0&&Mi.verticalTextBox){for(let un of _.writingModes)if(un===n.bI.vertical?(Li=Wr(),$i=Li):Li=Ki(),Li&&Li.box&&Li.box.length)break}else Li=Ki()};if(Ze){let Ki=Ze;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Wi]){let Pr=this.prevPlacement.variableOffsets[Wi];Ki.indexOf(Pr.anchor)>0&&(Ki=Ki.filter(wo=>wo!==Pr.anchor),Ki.unshift(Pr.anchor))}let Wr=(Pr,wo,Va)=>{let ca=_.getSymbolInstanceTextSize(Z,Yt,this.transform.zoom,Si),kl=(Pr.x2-Pr.x1)*ca+2*Pr.padding,Fl=(Pr.y2-Pr.y1)*ca+2*Pr.padding,To=Yt.hasIconTextFit&&!se?wo:null;To&&to(To);let us={box:[],offscreen:!1,occluded:!1},Xr=oe?2*Ki.length:Ki.length;for(let So=0;So<Xr;++So){let Ua=this.attemptAnchorPlacement(Ki[So%Ki.length],Pr,N,F,yt,kl,Fl,ca,le,_e,D,M,Q,So>=Ki.length,Yt,Si,_,Va,To,Z,Y);if(Ua&&(us=Ua.placedGlyphBoxes,us&&us.box&&us.box.length)){Ri=!0,bi=Ua.shift;break}}return us};Sr(()=>Wr(yn,Mi.iconBox,n.bI.horizontal),()=>{let Pr=Mi.verticalTextBox;return Pr&&to(Pr),_.allowVerticalPlacement&&!(Li&&Li.box&&Li.box.length)&&ni>0&&Pr?Wr(Pr,Mi.verticalIconBox,n.bI.vertical):{box:null,offscreen:null,occluded:null}}),Li&&(Ri=Li.box,Vi=Li.offscreen,Ci=Li.occluded);let un=Cr(!(!Li||!Li.box));if(!Ri&&this.prevPlacement){let Pr=this.prevPlacement.variableOffsets[Wi];Pr&&(this.variableOffsets[Wi]=Pr,this.markUsedJustification(_,Pr.anchor,Yt,un))}}else{let Ki=(Wr,un)=>{let Pr=_.getSymbolInstanceTextSize(Z,Yt,this.transform.zoom,Si,p),wo=this.collisionIndex.placeCollisionBox(_,Pr,Wr,N,F,yt,new n.P(0,0),oe,D,M,Q.predicate);return wo&&wo.box&&wo.box.length&&(this.markUsedOrientation(_,un,Yt),this.placedOrientations[Wi]=un),wo};Sr(()=>Ki(yn,n.bI.horizontal),()=>{let Wr=Mi.verticalTextBox;return _.allowVerticalPlacement&&ni>0&&Wr?(to(Wr),Ki(Wr,n.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Cr(!!(Li&&Li.box&&Li.box.length))}}if(kr=Li,Ri=kr&&kr.box&&kr.box.length>0,Vi=kr&&kr.offscreen,Ci=kr&&kr.occluded,Yt.useRuntimeCollisionCircles){let Cr=_.text.placedSymbolArray.get(Yt.centerJustifiedTextSymbolIndex>=0?Yt.centerJustifiedTextSymbolIndex:Yt.verticalPlacedTextSymbolIndex),Sr=n.bJ(_.textSizeData,Z,Cr),Ki=x.get("text-padding");Dr=this.collisionIndex.placeCollisionCircles(_,oe,Cr,_.lineVertexArray,_.glyphOffsetArray,Sr,M,C,z,c,_e,Q.predicate,Yt.collisionCircleDiameter*Sr/n.bU,Ki,this.retainedQueryData[_.bucketInstanceId].tileID),Ri=oe||Dr.circles.length>0&&!Dr.collisionDetected,Vi=Vi&&Dr.offscreen,Ci=Dr.occluded}if(Mi.iconFeatureIndex&&(kn=Mi.iconFeatureIndex),Mi.iconBox){let Cr=Sr=>{to(Sr);let Ki=Yt.hasIconTextFit&&bi?Di(bi.x,bi.y,le,_e,this.transform.angle):new n.P(0,0),Wr=_.getSymbolInstanceIconSize(Y,this.transform.zoom,Yt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(_,Wr,Sr,N,F,zt,Ki,se,D,M,Q.predicate)};$i&&$i.box&&$i.box.length&&Mi.verticalIconBox?(Br=Cr(Mi.verticalIconBox),li=Br.box.length>0):(Br=Cr(Mi.iconBox),li=Br.box.length>0),Vi=Vi&&Br.offscreen,yr=Br.occluded}let bo=he||Yt.numHorizontalGlyphVertices===0&&ni===0,Vo=de||Yt.numIconVertices===0;if(bo||Vo?Vo?bo||(li=li&&Ri):Ri=li&&Ri:li=Ri=li&&Ri,Ri&&kr&&kr.box&&this.collisionIndex.insertCollisionBox(kr.box,x.get("text-ignore-placement"),_.bucketInstanceId,$i&&$i.box&&Jo?Jo:hn,Q.ID),li&&Br&&this.collisionIndex.insertCollisionBox(Br.box,x.get("icon-ignore-placement"),_.bucketInstanceId,kn,Q.ID),Dr&&(Ri&&this.collisionIndex.insertCollisionCircles(Dr.circles,x.get("text-ignore-placement"),_.bucketInstanceId,hn,Q.ID),c)){let Cr=_.bucketInstanceId,Sr=this.collisionCircleArrays[Cr];Sr===void 0&&(Sr=this.collisionCircleArrays[Cr]=new _d);for(let Ki=0;Ki<Dr.circles.length;Ki+=4)Sr.circles.push(Dr.circles[Ki+0]),Sr.circles.push(Dr.circles[Ki+1]),Sr.circles.push(Dr.circles[Ki+2]),Sr.circles.push(Dr.collisionDetected?1:0)}let xn=_.projection.name!=="globe";Rt=Rt&&(xn||!Ci),$t=$t&&(xn||!yr),this.placements[Wi]=new _o(Ri||Rt,li||$t,Vi||_.justReloaded),o.add(Wi)},Ti=this.retainedQueryData[_.bucketInstanceId].tileID;if(_.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(_,Ti),_.elevationType==="road"&&_.updateRoadElevation(Ti.canonical),_.updateZOffset(),_.sortFeaturesByY){let Yt=_.getSortedSymbolIndexes(this.transform.angle);for(let Si=Yt.length-1;Si>=0;--Si){let Mi=Yt[Si];ai(_.symbolInstances.get(Mi),Mi,_.collisionArrays[Mi])}_.hasAnyZOffset&&n.w(`${_.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(_.hasAnyZOffset){let Yt=_.getSortedIndexesByZOffset();for(let Si=0;Si<Yt.length;++Si){let Mi=Yt[Si];ai(_.symbolInstances.get(Mi),Mi,_.collisionArrays[Mi])}}else for(let Yt=t.symbolInstanceStart;Yt<t.symbolInstanceEnd;Yt++)ai(_.symbolInstances.get(Yt),Yt,_.collisionArrays[Yt]);if(c&&_.bucketInstanceId in this.collisionCircleArrays){let Yt=this.collisionCircleArrays[_.bucketInstanceId];n.bi(Yt.invProjMatrix,M),Yt.viewportMatrix=this.collisionIndex.getViewportMatrix()}_.justReloaded=!1}markUsedJustification(t,o,c,d){let{leftJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:_,rightJustifiedTextSymbolIndex:x,verticalPlacedTextSymbolIndex:b,crossTileID:M}=c,C=n.b$(o),z=d===n.bI.vertical?b:C==="left"?p:C==="center"?_:C==="right"?x:-1;p>=0&&(t.text.placedSymbolArray.get(p).crossTileID=z>=0&&p!==z?0:M),_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=z>=0&&_!==z?0:M),x>=0&&(t.text.placedSymbolArray.get(x).crossTileID=z>=0&&x!==z?0:M),b>=0&&(t.text.placedSymbolArray.get(b).crossTileID=z>=0&&b!==z?0:M)}markUsedOrientation(t,o,c){let d=o===n.bI.horizontal||o===n.bI.horizontalOnly?o:0,p=o===n.bI.vertical?o:0,{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:x,rightJustifiedTextSymbolIndex:b,verticalPlacedTextSymbolIndex:M}=c,C=t.text.placedSymbolArray;_>=0&&(C.get(_).placedOrientation=d),x>=0&&(C.get(x).placedOrientation=d),b>=0&&(C.get(b).placedOrientation=d),M>=0&&(C.get(M).placedOrientation=p)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;let o=this.prevPlacement,c=!1;this.prevZoomAdjustment=o?o.zoomAdjustment(this.transform.zoom):0;let d=o?o.symbolFadeChange(t):1,p=o?o.opacities:{},_=o?o.variableOffsets:{},x=o?o.placedOrientations:{};for(let b in this.placements){let M=this.placements[b],C=p[b];C?(this.opacities[b]=new Aa(C,d,M.text,M.icon,null,M.clipped),c=c||M.text!==C.text.placed||M.icon!==C.icon.placed):(this.opacities[b]=new Aa(null,d,M.text,M.icon,M.skipFade,M.clipped),c=c||M.text||M.icon)}for(let b in p){let M=p[b];if(!this.opacities[b]){let C=new Aa(M,d,!1,!1);C.isHidden()||(this.opacities[b]=C,c=c||M.text.placed||M.icon.placed)}}for(let b in _)this.variableOffsets[b]||!this.opacities[b]||this.opacities[b].isHidden()||(this.variableOffsets[b]=_[b]);for(let b in x)this.placedOrientations[b]||!this.opacities[b]||this.opacities[b].isHidden()||(this.placedOrientations[b]=x[b]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=o?o.lastPlacementChangeTime:t)}updateLayerOpacities(t,o,c,d){let p=new Set;for(let _ of o){let x=_.getBucket(t);x&&_.latestFeatureIndex&&t.fqid===x.layerIds[0]&&(this.updateBucketOpacities(x,p,_,_.collisionBoxArray,c,d,_.tileID,t.scope),x.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(x,_.tileID),x.elevationType==="road"&&x.updateRoadElevation(_.tileID.canonical),x.updateZOffset())}}updateBucketOpacities(t,o,c,d,p,_,x,b){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();let M=t.layers[0].layout,C=t.layers[0].paint,z=!!t.layers[0].dynamicFilter(),P=new Aa(null,0,!1,!1,!0),D=M.get("text-allow-overlap"),N=M.get("icon-allow-overlap"),F=M.get("text-variable-anchor"),j=M.get("text-rotation-alignment")==="map",U=M.get("text-pitch-alignment")==="map",Z=C.get("symbol-z-offset"),Y=M.get("symbol-elevation-reference")==="sea",Q=!Z.isConstant(),ne=new Aa(null,0,D&&(N||!t.hasIconData()||M.get("icon-optional")),N&&(D||!t.hasTextData()||M.get("text-optional")),!0);!t.collisionArrays&&d&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(d);let he=(oe,se,le)=>{for(let Me=0;Me<se/4;Me++)oe.opacityVertexArray.emplaceBack(le)},de=0;_&&t.updateReplacement(x,_);for(let oe=0;oe<t.symbolInstances.length;oe++){let se=t.symbolInstances.get(oe),{numHorizontalGlyphVertices:le,numVerticalGlyphVertices:Me,crossTileID:_e,numIconVertices:Ve,tileAnchorX:ze,tileAnchorY:je}=se,rt=null,Ce=this.retainedQueryData[t.bucketInstanceId];Q&&se&&Ce&&(rt=c.latestFeatureIndex.loadFeature({featureIndex:se.featureIndex,bucketIndex:Ce.bucketIndex,sourceLayerIndex:Ce.sourceLayerIndex,layoutVertexArrayOffset:0}));let me=Z.evaluate(rt,{}),ke=o.has(_e),Pe=this.opacities[_e];ke?Pe=P:Pe||(Pe=ne,this.opacities[_e]=Pe),o.add(_e);let $e=le>0||Me>0,Ze=Ve>0,Ye=this.placedOrientations[_e],ct=Ye===n.bI.vertical,Mt=Ye===n.bI.horizontal||Ye===n.bI.horizontalOnly;!$e&&!Ze||Pe.isHidden()||de++;let Ot=!1;if(($e||Ze)&&_)for(let yt of t.activeReplacements){if(n.bV(yt,p,n.bW.Symbol,b)||yt.min.x>ze||ze>yt.max.x||yt.min.y>je||je>yt.max.y)continue;let zt=n.bX(ze,je,x.canonical,yt.footprintTileId.canonical);if(Ot=n.bY(zt,yt.footprint),Ot)break}if($e){let yt=Ot?Hs:ll(Pe.text);he(t.text,le,ct?Hs:yt),he(t.text,Me,Mt?Hs:yt);let zt=Pe.text.isHidden(),{leftJustifiedTextSymbolIndex:Rt,centerJustifiedTextSymbolIndex:$t,rightJustifiedTextSymbolIndex:Jt,verticalPlacedTextSymbolIndex:ai}=se,Ti=t.text.placedSymbolArray,Yt=zt||ct?1:0;Rt>=0&&(Ti.get(Rt).hidden=Yt),$t>=0&&(Ti.get($t).hidden=Yt),Jt>=0&&(Ti.get(Jt).hidden=Yt),ai>=0&&(Ti.get(ai).hidden=zt||Mt?1:0);let Si=this.variableOffsets[_e];Si&&this.markUsedJustification(t,Si.anchor,se,Ye);let Mi=this.placedOrientations[_e];Mi&&(this.markUsedJustification(t,"left",se,Mi),this.markUsedOrientation(t,Mi,se))}if(Ze){let yt=Ot?Hs:ll(Pe.icon),{placedIconSymbolIndex:zt,verticalPlacedIconSymbolIndex:Rt}=se,$t=t.icon.placedSymbolArray,Jt=Pe.icon.isHidden()?1:0;zt>=0&&(he(t.icon,Ve,ct?Hs:yt),$t.get(zt).hidden=Jt),Rt>=0&&(he(t.icon,se.numVerticalIconVertices,Mt?Hs:yt),$t.get(Rt).hidden=Jt)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){let yt=t.collisionArrays[oe];if(yt){let zt=new n.P(0,0),Rt=!0;if(yt.textBox||yt.verticalTextBox){if(F){let Jt=this.variableOffsets[_e];Jt?(zt=zi(Jt.anchor,Jt.width,Jt.height,Jt.textOffset,Jt.textScale),j&&zt._rotate(U?this.transform.angle:-this.transform.angle)):Rt=!1}z&&(Rt=!Pe.clipped),yt.textBox&&Cs(t.textCollisionBox.collisionVertexArray,Pe.text.placed,!Rt||ct,me,Y,zt.x,zt.y),yt.verticalTextBox&&Cs(t.textCollisionBox.collisionVertexArray,Pe.text.placed,!Rt||Mt,me,Y,zt.x,zt.y)}let $t=Rt&&!!(!Mt&&yt.verticalIconBox);yt.iconBox&&Cs(t.iconCollisionBox.collisionVertexArray,Pe.icon.placed,$t,me,Y,se.hasIconTextFit?zt.x:0,se.hasIconTextFit?zt.y:0),yt.verticalIconBox&&Cs(t.iconCollisionBox.collisionVertexArray,Pe.icon.placed,!$t,me,Y,se.hasIconTextFit?zt.x:0,se.hasIconTextFit?zt.y:0)}}}if(t.fullyClipped=de===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){let oe=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=oe.invProjMatrix,t.placementViewportMatrix=oe.viewportMatrix,t.collisionCircleArray=oe.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,o){let c=this.zoomAtLastRecencyCheck===o?1-this.zoomAdjustment(o):1;return this.zoomAtLastRecencyCheck=o,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function Cs(l,t,o,c,d,p,_){l.emplaceBack(t?1:0,o?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,o?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,o?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,o?1:0,p||0,_||0,c,d?1:0)}let Fi=Math.pow(2,25),Lh=Math.pow(2,24),Ic=Math.pow(2,17),Ac=Math.pow(2,16),In=Math.pow(2,9),Zr=Math.pow(2,8),pg=Math.pow(2,1);function ll(l){if(l.opacity===0&&!l.placed)return 0;if(l.opacity===1&&l.placed)return 4294967295;let t=l.placed?1:0,o=Math.floor(127*l.opacity);return o*Fi+t*Lh+o*Ic+t*Ac+o*In+t*Zr+o*pg+t}let Hs=0;class Mc{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,o,c,d,p,_){let x=this._bucketParts;for(;this._currentTileIndex<t.length;)if(o.getBucketParts(x,d,t[this._currentTileIndex],this._sortAcrossTiles,_),this._currentTileIndex++,p())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,x.sort((b,M)=>b.sortKey-M.sortKey));this._currentPartIndex<x.length;){let b=x[this._currentPartIndex];if(o.placeLayerBucketPart(b,this._seenCrossTileIDs,c,b.symbolInstanceStart===0,_),this._currentPartIndex++,p())return!0}return!1}}class zh{constructor(t,o,c,d,p,_,x,b,M){this.placement=new Qn(t,p,_,x,b,M),this._currentPlacementIndex=o.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(t,o,c,d,p){let _=n.q.now(),x=()=>{let b=n.q.now()-_;return!this._forceFullPlacement&&b>2};for(;this._currentPlacementIndex>=0;){let b=o[t[this._currentPlacementIndex]],M=this.placement.collisionIndex.transform.zoom;if(b.type==="symbol"&&(!b.minzoom||b.minzoom<=M)&&(!b.maxzoom||b.maxzoom>M)){let C=b,z=C.layout.get("symbol-z-elevate"),P=C.layout.get("symbol-sort-key").constantOr(1)!==void 0,D=C.layout.get("symbol-z-order"),N=D==="viewport-y"||D==="auto"&&!(D!=="viewport-y"&&P),F=C.layout.get("text-allow-overlap")||C.layout.get("icon-allow-overlap")||C.layout.get("text-ignore-placement")||C.layout.get("icon-ignore-placement"),j=N&&F,U=this._inProgressLayer=this._inProgressLayer||new Mc(C),Z=n.C(b.source,b.scope);if(U.continuePlacement(z||j?d[Z]:c[Z],this.placement,this._showCollisionBoxes,b,x,p))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}let Cc=512/n.aj/2;class Dh{constructor(t,o,c){this.tileID=t,this.bucketInstanceId=c,this.index=new n.c0(o.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let d=t.canonical.x*n.aj,p=t.canonical.y*n.aj;for(let _=0;_<o.length;_++){let{key:x,crossTileID:b,tileAnchorX:M,tileAnchorY:C}=o.get(_),z=Math.floor((d+M)*Cc),P=Math.floor((p+C)*Cc);this.index.add(z,P),this.keys.push(x),this.crossTileIDs.push(b)}this.index.finish()}findMatches(t,o,c){let d=this.tileID.canonical.z<o.canonical.z?1:Math.pow(2,this.tileID.canonical.z-o.canonical.z),p=Cc/Math.pow(2,o.canonical.z-this.tileID.canonical.z),_=o.canonical.x*n.aj,x=o.canonical.y*n.aj;for(let b=0;b<t.length;b++){let M=t.get(b);if(M.crossTileID)continue;let{key:C,tileAnchorX:z,tileAnchorY:P}=M,D=Math.floor((_+z)*p),N=Math.floor((x+P)*p),F=this.index.range(D-d,N-d,D+d,N+d).sort((j,U)=>j-U);for(let j of F){let U=this.crossTileIDs[j];if(this.keys[j]===C&&!c.has(U)){c.add(U),M.crossTileID=U;break}}}}}class Ln{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Ps{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){let o=Math.round((t-this.lng)/360);if(o!==0)for(let c in this.indexes){let d=this.indexes[c],p={};for(let _ in d){let x=d[_];x.tileID=x.tileID.unwrapTo(x.tileID.wrap+o),p[x.tileID.key]=x}this.indexes[c]=p}this.lng=t}addBucket(t,o,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===o.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let p=0;p<o.symbolInstances.length;p++)o.symbolInstances.get(p).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);let d=this.usedCrossTileIDs[t.overscaledZ];for(let p in this.indexes){let _=this.indexes[p];if(Number(p)>t.overscaledZ)for(let x in _){let b=_[x];b.tileID.isChildOf(t)&&b.findMatches(o.symbolInstances,t,d)}else{let x=_[t.scaledTo(Number(p)).key];x&&x.findMatches(o.symbolInstances,t,d)}}for(let p=0;p<o.symbolInstances.length;p++){let _=o.symbolInstances.get(p);_.crossTileID||(_.crossTileID=c.generate(),d.add(_.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Dh(t,o.symbolInstances,o.bucketInstanceId),!0}removeBucketCrossTileIDs(t,o){for(let c of o.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let o=!1;for(let c in this.indexes){let d=this.indexes[c];for(let p in d)t[d[p].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[p]),delete d[p],o=!0)}return o}}class qn{constructor(){this.layerIndexes={},this.crossTileIDs=new Ln,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,o,c,d){let p=this.layerIndexes[t.fqid];p===void 0&&(p=this.layerIndexes[t.fqid]=new Ps);let _=!1,x={};d.name!=="globe"&&p.handleWrapJump(c);for(let b of o){let M=b.getBucket(t);M&&t.fqid===M.layerIds[0]&&(M.bucketInstanceId||(M.bucketInstanceId=++this.maxBucketInstanceId),p.addBucket(b.tileID,M,this.crossTileIDs)&&(_=!0),x[M.bucketInstanceId]=!0)}return p.removeStaleBuckets(x)&&(_=!0),_}pruneUnusedLayers(t){let o={};t.forEach(c=>{o[c]=!0});for(let c in this.layerIndexes)o[c]||delete this.layerIndexes[c]}}let Ma=771;class ti{constructor(t,o,c,d){this.blendFunction=t,this.blendColor=o.toNonPremultipliedRenderColor(null),this.mask=c,this.blendEquation=d}}ti.Replace=[1,0,1,0],ti.disabled=new ti(ti.Replace,n.am.transparent,[!1,!1,!1,!1]),ti.unblended=new ti(ti.Replace,n.am.transparent,[!0,!0,!0,!0]),ti.alphaBlended=new ti([1,Ma,1,Ma],n.am.transparent,[!0,!0,!0,!0]),ti.alphaBlendedNonPremultiplied=new ti([770,Ma,770,Ma],n.am.transparent,[!0,!0,!0,!0]),ti.multiply=new ti([774,0,774,0],n.am.transparent,[!0,!0,!0,!0]);class bt{constructor(t,o,c){this.func=t,this.mask=o,this.range=c}}bt.ReadOnly=!1,bt.ReadWrite=!0,bt.disabled=new bt(519,bt.ReadOnly,[0,1]);let Do=7680;class Gt{constructor(t,o,c,d,p,_){this.test=t,this.ref=o,this.mask=c,this.fail=d,this.depthFail=p,this.pass=_}}Gt.disabled=new Gt({func:519,mask:0},0,0,Do,Do,Do);let Ur=1029,Pc=2305;class Nt{constructor(t,o,c){this.enable=t,this.mode=o,this.frontFace=c}}function cl(l,t){let o=n.c6(l,3);n.c8(l,t),n.cc(l,3,o)}function hl(l,t){let o=n.c3([]);return n.c4(o,o,-t),n.c5(o,o,-l),o}function $s(l,t){let o=[l[0],l[1],0],c=[t[0],t[1],0];if(n.ae(o)>=1e-15){let _=n.au([],o);n.c1(c,_,n.bG(c,_)),t[0]=c[0],t[1]=c[1]}let d=n.bF([],t,l);if(n.c2(d)<1e-15)return null;let p=Math.atan2(-d[1],d[0]);return hl(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),p)}Nt.disabled=new Nt(!1,Ur,Pc),Nt.backCCW=new Nt(!0,Ur,Pc),Nt.backCW=new Nt(!0,Ur,2304),Nt.frontCW=new Nt(!0,1028,2304),Nt.frontCCW=new Nt(!0,1028,Pc);class Bf{constructor(t,o){this.position=t,this.orientation=o}get position(){return this._position}set position(t){if(t){let o=t instanceof n.ac?t:new n.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(o.x=n.bQ(o.x,0,1)),this._position=o}else this._position=null}lookAtPoint(t,o){if(this.orientation=null,!this.position)return;let c=this.position,d=this._elevation?this._elevation.getAtPointOrZero(n.ac.fromLngLat(t)):0,p=n.ac.fromLngLat(t,d),_=[p.x-c.x,p.y-c.y,p.z-c.z];o||(o=[0,0,1]),o[2]=Math.abs(o[2]),this.orientation=$s(_,o)}setPitchBearing(t,o){this.orientation=hl(n.al(t),n.al(-o))}}class Oo{constructor(t,o){this._transform=n.bx([]),this.orientation=o,this.position=t}get mercatorPosition(){let t=this.position;return new n.ac(t[0],t[1],t[2])}get position(){let t=n.c6(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var o;t&&n.cc(this._transform,3,[(o=t)[0],o[1],o[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||n.c3([]),t&&cl(this._transform,this._orientation)}getPitchBearing(){let t=this.forward(),o=this.right();return{bearing:Math.atan2(-o[1],o[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,o){this._orientation=hl(t,o),cl(this._transform,this._orientation)}forward(){let t=n.c6(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){let t=n.c6(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){let t=n.c6(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,o){let c=new Float64Array(16);return n.bi(c,this.getWorldToCamera(t,o)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,o,c){let d=this.position;n.c1(d,d,-t);let p=new Float64Array(16);return n.bn(p,[c,c,c]),n.bo(p,p,d),p[10]*=o,p}getWorldToCamera(t,o){let c=new Float64Array(16),d=new Float64Array(4),p=this.position;return n.c7(d,this._orientation),n.c1(p,p,-t),n.c8(c,d),n.bo(c,c,p),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=o,c[9]*=o,c[10]*=o,c[11]*=o,c}getCameraToClipPerspective(t,o,c,d){let p=new Float64Array(16);return n.c9(p,t,o,c,d),p}getCameraToClipOrthographic(t,o,c,d,p,_){let x=new Float64Array(16);return n.ca(x,t,o,c,d,p,_),x}getDistanceToElevation(t,o=!1){let c=t===0?0:n.cb(t,o?n.aY(this.position[1]):this.position[1]),d=this.forward();return(c-this.position[2])/d[2]}clone(){return new Oo([...this.position],[...this.orientation])}}let zn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Rc{constructor(t=0,o=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(o)||o<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=o,this.left=c,this.right=d}interpolate(t,o,c){return o.top!=null&&t.top!=null&&(this.top=n.ai(t.top,o.top,c)),o.bottom!=null&&t.bottom!=null&&(this.bottom=n.ai(t.bottom,o.bottom,c)),o.left!=null&&t.left!=null&&(this.left=n.ai(t.left,o.left,c)),o.right!=null&&t.right!=null&&(this.right=n.ai(t.right,o.right,c)),this}getCenter(t,o){let c=n.ay((this.left+t-this.right)/2,0,t),d=n.ay((this.top+o-this.bottom)/2,0,o);return new n.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Rc(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}let cn=15;class gd{constructor(t,o,c,d,p,_,x){this.tileSize=512,this._renderWorldCopies=p===void 0||p,this._minZoom=t||0,this._maxZoom=o||22,this._minPitch=c??0,this._maxPitch=d??60,this.setProjection(_),this.setMaxBounds(x),this.width=0,this.height=0,this._center=new n.ci(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Rc,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Oo,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){let t=new gd(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<cn}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,o=!1){let c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(o),this._calcMatrices()}getProjection(){return n.aF(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};let o=this.projection?this.getProjection():void 0;this.projection=n.cj(this.projectionOptions);let c=this.getProjection(),d=!n.bv(o,c);return d&&this._calcMatrices(),this.mercatorFromTransition=!1,d}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){let t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=n.cj({name:"mercator"});let o=t!==this.projection.name;return o&&this._calcMatrices(),o}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return n.cb(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new n.P(this.width,this.height)}get bearing(){return n.bQ(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){let o=-t*Math.PI/180;this.angle!==o&&(this._unmodified=!1,this.angle=o,this._calcMatrices(),this.rotationMatrix=n.ck(),n.cl(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){let o=n.ay(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==o&&(this._unmodified=!1,this._pitch=o,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=n.al(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){let t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){let o=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==o&&(this._unmodified=!1,this._setZoom(o),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){let t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,o=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!o||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let c=this._elevation;o||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;let t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;let t=this._elevation,o=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop(),d=0,p=0;for(let _=0;_<o.length;_++){let x=new n.P(o[_][0]*this.width,c+o[_][1]*(this.height-c)),b=t.pointCoordinate(x);if(!b)continue;let M=1/Math.hypot(b[0]-this._camera.position[0],b[1]-this._camera.position[1]);d+=b[3]*M,p+=M}return p===0?NaN:d/p}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;let t=this._seaLevelZoom,o=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*o,d=this._mercatorZfromZoom(t),p=this._mercatorZfromZoom(this._maxZoom),_=Math.max(d-c,p);this._setZoom(this._zoomFromMercatorZ(_))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){let o=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude())),c;c=t.z<this._camera.position[2]?[o.x,o.y,o.z]:[t.x,t.y,t.z];let d=n.ae(n.at([],this._camera.position,c));return n.ay(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let o=!1;if(t.orientation&&!n.cm(t.orientation,this._camera.orientation)&&(o=this._setCameraOrientation(t.orientation)),t.position){let c=[t.position.x,t.position.y,t.position.z];n.cn(c,this._camera.position)||(this._setCameraPosition(c),o=!0)}o&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let t=this._camera.position,o=new Bf;return o.position=new n.ac(t[0],t[1],t[2]),o.orientation=this._camera.orientation,o._elevation=this.elevation,o._renderWorldCopies=this.renderWorldCopies,o}_setCameraOrientation(t){if(!n.co(t))return!1;n.cp(t,t);let o=n.cq([],[0,0,-1],t),c=n.cq([],[0,-1,0],t);if(c[2]<0)return!1;let d=$s(o,c);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(t){let o=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;t[2]=n.ay(t[2],d/c,d/o),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,o,c){this._unmodified=!1,this._edgeInsets.interpolate(t,o,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){let o=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,o)}getVisibleUnwrappedCoordinates(t){let o=[new n.cr(0,t)];if(this.renderWorldCopies){let c=this.pointCoordinate(new n.P(0,0)),d=this.pointCoordinate(new n.P(this.width,0)),p=this.pointCoordinate(new n.P(this.width,this.height)),_=this.pointCoordinate(new n.P(0,this.height)),x=Math.floor(Math.min(c.x,d.x,p.x,_.x)),b=Math.floor(Math.max(c.x,d.x,p.x,_.x)),M=1;for(let C=x-M;C<=b+M;C++)C!==0&&o.push(new n.cr(C,t))}return o}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,o,c){let d=[],p=c!=null,_=!p;if(_&&this.zoom<o||p&&c[0]===0&&c[1]===0)return d;let x=new Set,b=(C,z,P,D,N)=>{let F=n.cV(z,C,P,D,N);x.has(F)||(d.push(new n.aM(C,z,P,D,N)),x.add(F))};for(let C=0;C<t.length;C++){let z=t[C];if(_&&z.canonical.z!==o)continue;let P=z.canonical,D=z.overscaledZ,N=z.wrap,F=1<<P.z,j=P.x+1<F,U=P.x>0,Z=P.y+1<F,Y=P.y>0,Q=z.wrap-(U?0:1),ne=z.wrap+(j?0:1),he=U?P.x-1:F-1,de=j?P.x+1:0;if(p)c[0]<0?(b(D,ne,P.z,de,P.y),c[1]<0&&Z&&(b(D,N,P.z,P.x,P.y+1),b(D,ne,P.z,de,P.y+1)),c[1]>0&&Y&&(b(D,N,P.z,P.x,P.y-1),b(D,ne,P.z,de,P.y-1))):c[0]>0?(b(D,Q,P.z,he,P.y),c[1]<0&&Z&&(b(D,N,P.z,P.x,P.y+1),b(D,Q,P.z,he,P.y+1)),c[1]>0&&Y&&(b(D,N,P.z,P.x,P.y-1),b(D,Q,P.z,he,P.y-1))):c[1]<0&&Z?b(D,N,P.z,P.x,P.y+1):Y&&b(D,N,P.z,P.x,P.y-1);else{let oe=z.visibleQuadrants;1&oe&&(b(D,Q,P.z,he,P.y),Y&&(b(D,N,P.z,P.x,P.y-1),b(D,Q,P.z,he,P.y-1))),2&oe&&(b(D,ne,P.z,de,P.y),Y&&(b(D,N,P.z,P.x,P.y-1),b(D,ne,P.z,de,P.y-1))),4&oe&&(b(D,Q,P.z,he,P.y),Z&&(b(D,N,P.z,P.x,P.y+1),b(D,Q,P.z,he,P.y+1))),8&oe&&(b(D,ne,P.z,de,P.y),Z&&(b(D,N,P.z,P.x,P.y+1),b(D,ne,P.z,de,P.y+1)))}}let M=[];for(let C of d)d.some(z=>C.isChildOf(z))||M.push(C);if(d=M.filter(C=>!t.some(z=>!!(C.overscaledZ<o&&z.isChildOf(C))||C.equals(z)||C.isChildOf(z))),_){let C=1<<o,z=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),P=[C*z.x,C*z.y],D=4,N=D*D;d=d.filter(F=>{let j=F.canonical.x+.5-P[0],U=F.canonical.y+.5-P[1];return j*j+U*U<N})}return d}extendTileCoverToNearPlane(t,o,c){let d=[],p=new Set;for(let Z of t)p.add(Z.key);let _=(Z,Y,Q,ne,he)=>{let de=n.cV(Y,Z,Q,ne,he);p.has(de)||(d.push(new n.aM(Z,Y,Q,ne,he)),p.add(de))},x=t.reduce((Z,Y)=>Math.max(Z,Y.overscaledZ),c),b=1<<c,M=[new n.P(0,0),new n.P(n.aj,0),new n.P(n.aj,n.aj),new n.P(0,n.aj)],C=new n.P(0,0),z=new n.P(0,0),P=(Z,Y)=>{let Q=Math.floor(Z[0]),ne=Math.floor(Z[1]),he=(Z[0]-Q)*n.aj,de=(Z[1]-ne)*n.aj,oe=Math.floor(Y[0]),se=Math.floor(Y[1]),le=(Y[0]-oe)*n.aj,Me=(Y[1]-se)*n.aj;for(let _e=-1;_e<=1;_e++){let Ve=Q+_e;if(!(Ve<0||Ve>=b)){C.x=he-_e*n.aj,z.x=le-(Ve-oe)*n.aj;for(let ze=-1;ze<=1;ze++){let je=ne+ze;C.y=de-ze*n.aj,z.y=Me-(je-se)*n.aj,n.cW(C,z,M)&&_(x,0,c,Ve,je)}}}},D=o.points,N=D[n.cs],F=D[n.ct],j=this._projectToGround(N,D[n.cu]),U=this._projectToGround(F,D[n.cv]);return P(N,j),P(F,U),d}_projectToGround(t,o){return n.cw(n.cx(),t,o,t[2]/(t[2]-o[2]))}coveringTiles(t){let o=this.coveringZoomLevel(t),c=o,d=this.elevation&&this.elevation.exaggeration(),p=d&&!t.isTerrainDEM,_=this.projection.name==="mercator";if(t.minzoom!==void 0&&o<t.minzoom)return[];t.maxzoom!==void 0&&o>t.maxzoom&&(o=t.maxzoom);let x=this.locationCoordinate(this.center),b=this.center.lat,M=1<<o,C=[M*x.x,M*x.y,0],z=this.projection.name==="globe",P=!z,D=n.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,o,P),N=z?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),F=M*n.cb(1,this.center.lat),j=this._camera.position[2]/n.cb(1,this.center.lat),U=[M*N.x,M*N.y,j*(P?1:F)],Z=z||d,Y=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),Q=this.isLODDisabled(!0)?o:0,ne;if(this._elevation&&t.isTerrainDEM)ne=1e4*this._elevation.exaggeration();else if(this._elevation){let me=this._elevation.getMinMaxForVisibleTiles();ne=me?me.max:this._centerAltitude}else ne=this._centerAltitude;let he=t.isTerrainDEM?-ne:this._elevation?this._elevation.getMinElevationBelowMSL():0,de=this.projection.isReprojectedInTileSpace?n.cz(this):1,oe=me=>{let Pe=new n.ac(me.x+25e-6,me.y,me.z),$e=new n.ac(me.x,me.y+25e-6,me.z),Ze=me.toLngLat(),Ye=Pe.toLngLat(),ct=$e.toLngLat(),Mt=this.locationCoordinate(Ze),Ot=this.locationCoordinate(Ye),yt=this.locationCoordinate(ct),zt=Math.hypot(Ot.x-Mt.x,Ot.y-Mt.y),Rt=Math.hypot(yt.x-Mt.x,yt.y-Mt.y);return Math.sqrt(zt*Rt)*de/25e-6},se=me=>{let ke=ne,Pe=he;return{aabb:n.cC(this,M,0,0,0,me,Pe,ke,this.projection),zoom:0,x:0,y:0,minZ:Pe,maxZ:ke,wrap:me,fullyVisible:!1}},le=[],Me=[],_e=o,Ve=t.reparseOverscaled?c:o,ze=(j-this._centerAltitude)*F,je=me=>{if(!this._elevation||!me.tileID||!_)return;let ke=this._elevation.getMinMaxForTile(me.tileID),Pe=me.aabb;ke?(Pe.min[2]=ke.min,Pe.max[2]=ke.max,Pe.center[2]=(Pe.min[2]+Pe.max[2])/2):(me.shouldSplit=Ce(me),me.shouldSplit||(Pe.min[2]=Pe.max[2]=Pe.center[2]=this._centerAltitude))},rt=(me,ke)=>{if(.707*ke<me)return 1;let Pe=ke/me;return Pe/(1.4144271570014144+(Math.pow(1.1,Pe-1.4144271570014144+1)-1)/(1.1-1)-1)},Ce=me=>{if(me.zoom<Q)return!0;if(me.zoom===_e)return!1;if(me.shouldSplit!=null)return me.shouldSplit;let ke=me.aabb.distanceX(U),Pe=me.aabb.distanceY(U),$e=ze,Ze=1;if(z){$e=me.aabb.distanceZ(U);let Rt=Math.pow(2,me.zoom),$t=n.aY((me.y+1)/Rt),Jt=n.aY(me.y/Rt),ai=Math.min(Math.max(b,$t),Jt),Ti=n.c_(ai)/n.c_(b);if(Ze=ai===b?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Ti/this._mercatorScaleRatio),this.zoom<=n.cX&&me.zoom===_e-1&&Ti>=.9)return!0}else if(p&&($e=me.aabb.distanceZ(U)*F),this.projection.isReprojectedInTileSpace&&c<=5){let Rt=Math.pow(2,me.zoom),$t=oe(new n.ac((me.x+.5)/Rt,(me.y+.5)/Rt));Ze=$t>.85?1:$t}if(!_){let Rt=Math.sqrt(ke*ke+Pe*Pe+$e*$e),$t=(1<<_e-me.zoom)*Y*Ze;return $t*=rt(Math.max($e,ze),Rt),Rt<$t}let Ye=Number.MAX_VALUE,ct=0,Mt=me.aabb.getCorners(),Ot=[];for(let Rt of Mt){n.at(Ot,Rt,U),z||(p?Ot[2]*=F:Ot[2]=ze);let $t=n.bG(Ot,this._camera.forward());$t<Ye&&(Ye=$t,ct=Math.abs(Ot[2]))}let yt=(1<<_e-me.zoom)*Y*Ze;if(yt*=rt(Math.max(ct,ze),Ye),Ye<yt)return!0;let zt=me.aabb.closestPoint(C);return zt[0]===C[0]&&zt[1]===C[1]};if(this.renderWorldCopies)for(let me=1;me<=3;me++)le.push(se(-me)),le.push(se(me));for(le.push(se(0));le.length>0;){let me=le.pop(),ke=me.x,Pe=me.y,$e=me.fullyVisible,Ze=()=>this.projection.name==="globe"&&(me.y===0||me.y===(1<<me.zoom)-1);if(!$e){let Ye=Z?me.aabb.intersects(D):me.aabb.intersectsFlat(D);if(Ye===0&&Ze()){let ct=new n.cA(me.zoom,ke,Pe);Ye=n.cB(this,M,ct,!0).intersects(D)}if(Ye===0)continue;$e=Ye===2}if(me.zoom!==_e&&Ce(me))for(let Ye=0;Ye<4;Ye++){let ct=(ke<<1)+Ye%2,Mt=(Pe<<1)+(Ye>>1),Ot={aabb:_?me.aabb.quadrant(Ye):n.cC(this,M,me.zoom+1,ct,Mt,me.wrap,me.minZ,me.maxZ,this.projection),zoom:me.zoom+1,x:ct,y:Mt,wrap:me.wrap,fullyVisible:$e,tileID:void 0,shouldSplit:void 0,minZ:me.minZ,maxZ:me.maxZ};p&&!z&&(Ot.tileID=new n.aM(me.zoom+1===_e?Ve:me.zoom+1,me.wrap,me.zoom+1,ct,Mt),je(Ot)),le.push(Ot)}else{let Ye=me.zoom===_e?Ve:me.zoom;if(t.minzoom&&t.minzoom>Ye)continue;let ct=0;if(!$e){let zt=Z?me.aabb.intersectsPrecise(D):me.aabb.intersectsPreciseFlat(D);if(zt===0&&Ze()){let Rt=new n.cA(me.zoom,ke,Pe);zt=n.cB(this,M,Rt,!0).intersectsPrecise(D)}if(zt===0)continue;if(t.calculateQuadrantVisibility)if(D.containsPoint(me.aabb.center))ct=15;else for(let Rt=0;Rt<4;Rt++)me.aabb.quadrant(Rt).intersects(D)!==0&&(ct|=1<<Rt)}let Mt=C[0]-(.5+ke+(me.wrap<<me.zoom))*(1<<o-me.zoom),Ot=C[1]-.5-Pe,yt=me.tileID?me.tileID:new n.aM(Ye,me.wrap,me.zoom,ke,Pe);t.calculateQuadrantVisibility&&(yt.visibleQuadrants=ct),Me.push({tileID:yt,distanceSq:Mt*Mt+Ot*Ot})}}if(this.fogCullDistSq){let me=this.fogCullDistSq,ke=this.horizonLineFromTop();Me=Me.filter(Pe=>{let $e=[0,0,0,1],Ze=[n.aj,n.aj,0,1],Ye=this.calculateFogTileMatrix(Pe.tileID.toUnwrapped());n.aA($e,$e,Ye),n.aA(Ze,Ze,Ye);let ct=n.cD([],$e,Ze),Mt=n.cE([],$e,Ze),Ot=n.cY(ct,Mt);if(Ot===0)return!0;let yt=!1,zt=this._elevation;if(zt&&Ot>me&&ke!==0){let Rt=this.calculateProjMatrix(Pe.tileID.toUnwrapped()),$t;t.isTerrainDEM||($t=zt.getMinMaxForTile(Pe.tileID)),$t||($t={min:he,max:ne});let Jt=n.cF(this.rotation),ai=[Jt[0]*n.aj,Jt[1]*n.aj,$t.max];n.ad(ai,ai,Rt),yt=(1-ai[1])*this.height*.5<ke}return Ot<me||yt})}return Me.sort((me,ke)=>me.distanceSq-ke.distanceSq).map(me=>me.tileID)}resize(t,o){this.width=t,this.height=o,this.pixelsToGLUnits=[2/t,-2/o],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){let o=n.ay(t.lat,-n.cG,n.cG),c=this.projection.project(t.lng,o);return new n.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/n.cb(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,o){let c,d,p=this.centerPoint;if(this.projection.name==="globe"){let x=this.worldSize;c=(o.x-p.x)/x,d=(o.y-p.y)/x}else{let x=this.pointCoordinate(o),b=this.pointCoordinate(p);c=x.x-b.x,d=x.y-b.y}let _=this.locationCoordinate(t);this.setLocation(new n.ac(_.x-c,_.y-d))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,o){return this.projection.locationPoint(this,t,o)}locationPoint3D(t,o){return this.projection.locationPoint(this,t,o,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,o){return this.coordinateLocation(this.pointCoordinate3D(t,o))}locationCoordinate(t,o){let c=o?n.cb(o,t.lat):void 0,d=this.projection.project(t.lng,t.lat);return new n.ac(d.x,d.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,o){let c=o??this._centerAltitude,d=[t.x,t.y,0,1],p=[t.x,t.y,1,1];n.aA(d,d,this.pixelMatrixInverse),n.aA(p,p,this.pixelMatrixInverse);let _=p[3];n.cH(d,d,1/d[3]),n.cH(p,p,1/_);let x=d[2],b=p[2];return{p0:d,p1:p,t:x===b?0:(c-x)/(b-x)}}screenPointToMercatorRay(t){let o=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return n.aA(o,o,this.pixelMatrixInverse),n.aA(c,c,this.pixelMatrixInverse),n.cH(o,o,1/o[3]),n.cH(c,c,1/c[3]),o[2]=n.cb(o[2],this._center.lat)*this.worldSize,c[2]=n.cb(c[2],this._center.lat)*this.worldSize,n.cH(o,o,1/this.worldSize),n.cH(c,c,1/this.worldSize),new n.av([o[0],o[1],o[2]],n.au([],n.at([],c,o)))}rayIntersectionCoordinate(t){let{p0:o,p1:c,t:d}=t,p=n.cb(o[2],this._center.lat),_=n.cb(c[2],this._center.lat);return new n.ac(n.ai(o[0],c[0],d)/this.worldSize,n.ai(o[1],c[1],d)/this.worldSize,n.ai(p,_,d))}pointCoordinate(t,o=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,o)}pointCoordinate3D(t,o){if(!this.elevation)return this.pointCoordinate(t,o);let c=this.projection.pointCoordinate3D(this,t.x,t.y);if(c)return new n.ac(c[0],c[1],c[2]);let d=0,p=this.horizonLineFromTop();if(t.y>p)return this.pointCoordinate(t,o);let _=.02*p,x=t.clone();for(let b=0;b<10&&p-d>_;b++){x.y=n.ai(d,p,.66);let M=this.projection.pointCoordinate3D(this,x.x,x.y);M?(p=x.y,c=M):d=x.y}return c?new n.ac(c[0],c[1],c[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=n.cI)return!this.isPointAboveHorizon(t);let o=this.pointCoordinate(t);return o.y>=0&&o.y<=1}_coordinatePoint(t,o){let c=o&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,d=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return n.aA(d,d,this.pixelMatrix),d[3]>0?new n.P(d[0]/d[3],d[1]/d[3]):new n.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:t,left:o}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,p=this.pointLocation3D(new n.P(o,t)),_=this.pointLocation3D(new n.P(d,t)),x=this.pointLocation3D(new n.P(d,c)),b=this.pointLocation3D(new n.P(o,c)),M=Math.min(p.lng,_.lng,x.lng,b.lng),C=Math.max(p.lng,_.lng,x.lng,b.lng),z=Math.min(p.lat,_.lat,x.lat,b.lat),P=Math.max(p.lat,_.lat,x.lat,b.lat),D=Math.pow(2,-this.zoom)/16*270,N=this.projection.name==="globe"?1:4,F=(j,U,Z,Y,Q)=>{let ne=(j+Z)/2,he=(U+Y)/2,de=new n.P(ne,he),{lng:oe,lat:se}=this.pointLocation3D(de),le=Math.max(0,M-oe,z-se,oe-C,se-P);M=Math.min(M,oe),C=Math.max(C,oe),z=Math.min(z,se),P=Math.max(P,se),(Q<N||le>D)&&(F(j,U,ne,he,Q+1),F(ne,he,Z,Y,Q+1))};if(F(o,t,d,t,1),F(d,t,d,c,1),F(d,c,o,c,1),F(o,c,o,t,1),this.projection.name==="globe"){let[j,U]=n.cJ(this);j?(P=90,C=180,M=-180):U&&(z=-90,C=180,M=-180)}return new n.aG(new n.ci(M,z),new n.ci(C,P))}_getBoundsRectangular(t,o){let{top:c,left:d}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,_=this.width-this._edgeInsets.right,x=new n.P(d,c),b=new n.P(_,c),M=new n.P(_,p),C=new n.P(d,p),z=this.pointCoordinate(x,t),P=this.pointCoordinate(b,t),D=this.pointCoordinate(M,o),N=this.pointCoordinate(C,o),F=(j,U)=>(U.y-j.y)/(U.x-j.x);return z.y>1&&P.y>=0?z=new n.ac((1-N.y)/F(N,z)+N.x,1):z.y<0&&P.y<=1&&(z=new n.ac(-N.y/F(N,z)+N.x,0)),P.y>1&&z.y>=0?P=new n.ac((1-D.y)/F(D,P)+D.x,1):P.y<0&&z.y<=1&&(P=new n.ac(-D.y/F(D,P)+D.x,0)),new n.aG().extend(this.coordinateLocation(z)).extend(this.coordinateLocation(P)).extend(this.coordinateLocation(N)).extend(this.coordinateLocation(D))}_getBoundsRectangularTerrain(){let t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);let o=t.visibleDemTiles.reduce((c,d)=>{if(d.dem){let p=d.dem.tree;c.min=Math.min(c.min,p.minimums[0]),c.max=Math.max(c.max,p.maximums[0])}return c},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(o.min*t.exaggeration(),o.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){let o=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-o*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-n.cG,this.maxLat=n.cG,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=n.aD(this.minLng)*this.tileSize,this.worldMaxX=n.aD(this.maxLng)*this.tileSize,this.worldMinY=n.aH(this.maxLat)*this.tileSize,this.worldMaxY=n.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,o){return this.projection.createTileMatrix(this,o,t)}calculateDistanceTileData(t){let o=t.key,c=this._distanceTileDataCache;if(c[o])return c[o];let d=t.canonical,p=1/this.height,_=this.cameraWorldSize,x=_/this.zoomScale(d.z),b=(d.x+Math.pow(2,d.z)*t.wrap)*x,M=d.y*x,C=this.point;C.x*=_/this.worldSize,C.y*=_/this.worldSize;let z=this.angle,P=Math.sin(-z),D=-Math.cos(-z);return c[o]={bearing:[P,D],center:[(C.x-b)*p,(C.y-M)*p],scale:x/n.aj*p},c[o]}calculateFogTileMatrix(t){let o=t.key,c=this._fogTileMatrixCache;if(c[o])return c[o];let d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return n.az(d,this.worldToFogMatrix,d),c[o]=new Float32Array(d),c[o]}calculateProjMatrix(t,o=!1,c=!1){let d=t.key,p;if(p=c?this._expandedProjMatrixCache:o?this._alignedProjMatrixCache:this._projMatrixCache,p[d])return p[d];let _=this.calculatePosMatrix(t,this.worldSize),x;return x=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:o?this.alignedProjMatrix:this.projMatrix,n.az(_,x,_),p[d]=new Float32Array(_),p[d]}calculatePixelsToTileUnitsMatrix(t){let o=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[o])return c[o];let d=n.cK(t,this);return c[o]=d,c[o]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){let t=1/this.worldSize,o=n.bn([],[t,t,t]);return n.az(o,o,this.globeMatrix),o}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;let t=this._elevation;this._updateCameraState();let o=n.cb(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(o),d=this._camera.forward(),p=n.cb(1,this._center.lat);c[2]/=p,d[2]/=p,n.au(d,d);let _=t.raycast(c,d,t.exaggeration());if(_){let x=n.bE([],c,d,_),b=new n.ac(x[0],x[1],n.cb(x[2],n.aY(x[1]))),M=(b.z+n.ae([b.x-c[0],b.y-c[1],b.z-c[2]*p]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(M),this._centerAltitude=b.toAltitude(),this._center=this.coordinateLocation(b),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;let o=this._elevation,c=n.cb(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(c),p=o.getAtPointOrZero(new n.ac(...d)),_=this.pixelsPerMeter/this.worldSize*p,x=this._minimumHeightOverTerrain(),b=d[2]-_;if(b<=x)if(b<0||t){let M=this.locationCoordinate(this._center,this._centerAltitude),C=[d[0],d[1],M.z-d[2]],z=n.ae(C);C[2]-=(x-b)/this._pixelsPerMercatorPixel;let P=n.ae(C);if(P===0)return;n.c1(C,C,z/P*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],M.z*this._pixelsPerMercatorPixel-C[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){let P=this.center;return P.lat=n.ay(P.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(P.lng=n.ay(P.lng,this.minLng,this.maxLng)),this.center=P,void(this._constraining=!1)}let o=this._unmodified,{x:c,y:d}=this.point,p=0,_=c,x=d,b=this.width/2,M=this.height/2,C=this.worldMinY*this.scale,z=this.worldMaxY*this.scale;if(d-M<C&&(x=C+M),d+M>z&&(x=z-M),z-C<this.height&&(p=Math.max(p,this.height/(z-C)),x=(z+C)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let P=this.worldMinX*this.scale,D=this.worldMaxX*this.scale,N=this.worldSize/2-(P+D)/2;_=(c+N+this.worldSize)%this.worldSize-N,_-b<P&&(_=P+b),_+b>D&&(_=D-b),D-P<this.width&&(p=Math.max(p,this.width/(D-P)),_=(D+P)/2)}_===c&&x===d||this._allowWorldUnderZoom||(this.center=this.unproject(new n.P(_,x))),p&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(p)),this._constrainCamera(),this._unmodified=o,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;let t=this.centerOffset,o=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=n.cb(1,this.center.lat)/n.cb(1,n.c$));let d=n.cL(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let p=this.projection.zAxisUnit==="meters"?c:1,_=this._camera.getWorldToCamera(this.worldSize,p),x,b=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(b[8]=2*-t.x/this.width,b[9]=2*t.y/this.height,this.isOrthographic){let se=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),le=se*this.aspect,Me=-le,_e=-se;le-=t.x,Me-=t.x,se+=t.y,_e+=t.y,x=this._camera.getCameraToClipOrthographic(Me,le,_e,se,this._nearZ,this._farZ),((Ve,ze,je,rt)=>{for(let Ce=0;Ce<16;Ce++)Ve[Ce]=n.ai(ze[Ce],je[Ce],rt)})(x,x,b,n.cZ(this.pitch>=cn?1:this.pitch/cn))}else x=b;let M=n.cM([],b,_),C=n.cM([],x,_);if(this.projection.isReprojectedInTileSpace){let se=this.locationCoordinate(this.center),le=n.bx([]);n.bo(le,le,[se.x*this.worldSize,se.y*this.worldSize,0]),n.az(le,le,n.cN(this)),n.bo(le,le,[-se.x*this.worldSize,-se.y*this.worldSize,0]),n.az(C,C,le),n.az(M,M,le),this.inverseAdjustmentMatrix=n.cO(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=n.cP([],C,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=C,this.invProjMatrix=n.bi(new Float64Array(16),this.projMatrix),o){let se=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);se[8]=2*-t.x/this.width,se[9]=2*t.y/this.height,this.expandedFarZProjMatrix=n.cM([],se,_)}else this.expandedFarZProjMatrix=this.projMatrix;let z=n.bi([],x);this.frustumCorners=n.cQ.fromInvProjectionMatrix(z,this.horizonLineFromTop(),this.height),this.cameraFrustum=n.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!o);let P=new Float32Array(16);n.bx(P),n.cP(P,P,[1,-1,1]),n.cR(P,P,this._pitch),n.by(P,P,this.angle);let D=n.c9(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=n.bw(D);let N=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;D[8]=2*-t.x/this.width,D[9]=2*(t.y+N)/this.height,this.skyboxMatrix=n.az(P,D,P);let F=this.point,j=F.x,U=F.y,Z=this.width%2/2,Y=this.height%2/2,Q=Math.cos(this.angle),ne=Math.sin(this.angle),he=j-Math.round(j)+Q*Z+ne*Y,de=U-Math.round(U)+Q*Y+ne*Z,oe=new Float64Array(C);if(n.bo(oe,oe,[he>.5?he-1:he,de>.5?de-1:de,0]),this.alignedProjMatrix=oe,C=n.bz(),n.cP(C,C,[this.width/2,-this.height/2,1]),n.bo(C,C,[1,-1,0]),this.labelPlaneMatrix=C,C=n.bz(),n.cP(C,C,[1,-1,1]),n.bo(C,C,[-1,-1,0]),n.cP(C,C,[2/this.width,2/this.height,1]),this.glCoordMatrix=C,this.pixelMatrix=n.az(new Float64Array(16),this.labelPlaneMatrix,M),this._calcFogMatrices(),this._distanceTileDataCache={},C=n.bi(new Float64Array(16),this.pixelMatrix),!C)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=C,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=n.cS(this);let se=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=n.ad(se,se,_),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=C;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let t=this.cameraWorldSizeForFog,o=this.cameraPixelsPerMeter,c=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,p=[t,t,o];n.c1(p,p,d),n.c1(c,c,-1),n.cT(c,c,p);let _=n.bz();n.bo(_,_,c),n.cP(_,_,p),this.mercatorFogMatrix=_,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,o,d)}_computeCameraPosition(t){let o=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),d=this.point,p=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*o-t/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-c[0]*p,d.y/this.worldSize-c[1]*p,t/this.worldSize*this._centerAltitude-c[2]*p]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){let o=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],d=t[2],p=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(p=Math.min((o-c)/d,1)),this._camera.position=n.bE([],this._camera.position,t,p),this._updateStateFromCamera()}_updateStateFromCamera(){let t=this._camera.position,o=this._camera.forward(),{pitch:c,bearing:d}=this._camera.getPitchBearing(),p=n.cb(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,_=this._mercatorZfromZoom(this._maxZoom)*Math.cos(n.al(this._maxPitch)),x=Math.max((t[2]-p)/Math.cos(c),_),b=this._zoomFromMercatorZ(x);n.bE(t,t,o,x),this._pitch=n.ay(c,n.al(this.minPitch),n.al(this.maxPitch)),this.angle=n.bQ(d,-Math.PI,Math.PI),this._setZoom(n.ay(b,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new n.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){let t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let o=0,c=n.cI,d=0,p=1/0;for(;c-o>1e-6&&c>o;){let _=o+.5*(c-o),x=this.tileSize*Math.pow(2,_),b=this.getCameraToCenterDistance(this.projection,_,x),M=this.scaleZoom(b/(Math.max(0,t)*this.tileSize)),C=Math.abs(_-M);C<p&&(p=C,d=_),_<M?o=_:c=_}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(n.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,o){let c=Math.min(t.x,o.x),d=Math.max(t.x,o.x),p=Math.min(t.y,o.y),_=Math.max(t.y,o.y);if(p<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;let x=[new n.P(c,p),new n.P(d,_),new n.P(c,_),new n.P(d,p)],b=this.renderWorldCopies?-3:0,M=this.renderWorldCopies?4:1;for(let C of x){let z=this.pointRayIntersection(C);if(z.t<0)return!0;let P=this.rayIntersectionCoordinate(z);if(P.x<b||P.y<0||P.x>M||P.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+n.cU(this.fovAboveCenter)>88||this.anyCornerOffEdge(new n.P(0,0),new n.P(this.width,this.height))}zoomDeltaToMovement(t,o){let c=n.ae(n.at([],this._camera.position,t)),d=this._zoomFromMercatorZ(c)+o;return c-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){let t=function([o,c,d],p){let _=[o,c,d,1];n.aA(_,_,p);let x=_[3]=Math.max(_[3],1e-6);return _[0]/=x,_[1]/=x,_[2]/=x,_}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new n.P(t[0],t[1])}{let t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new n.P(0,t))}}getCameraToCenterDistance(t,o=this.zoom,c=this.worldSize){let d=n.cL(t,o,this.width,this.height,1024),p=t.pixelSpaceConversion(this.center.lat,c,d),_=.5/Math.tan(.5*this._fov)*this.height*p;return this.isOrthographic&&(_=n.ai(1,_,n.cZ(this.pitch>=cn?1:this.pitch/cn))),_}getWorldToCameraMatrix(){let t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&n.az(t,t,this.globeMatrix),t}getFrustum(t){return n.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}let ss=(l,t)=>{if(t>0&&l.terrain&&n.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let o=l.transform,c=Math.max(Math.abs(o._zoom-(l.minCutoffZoom-1)),1),d=o.isLODDisabled(!1)?n.af(60,45,o.pitch):n.af(30,15,o.pitch),p=o._farZ-o._nearZ,_=t*o.height,x=((1-(b=d))*o.cameraToCenterDistance+b*(o._farZ+_))*c;var b;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[o._nearZ,o._farZ,(x-o._nearZ)/p,(x-_-o._nearZ)/p]}}},An={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Lc{constructor(t,o){this.aabb=t,this.lastCascade=o}}class fg{add(t,o){let c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],o.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],o.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],o.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],o.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],o.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],o.max[2])):this.receivers[t.key]=new Lc(o,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,o,c){let d=n.d6.fromPoints(t.points),p=0;for(let _ in this.receivers){let x=this.receivers[_];if(!x||!d.intersectsAabb(x.aabb))continue;x.aabb.min=d.closestPoint(x.aabb.min),x.aabb.max=d.closestPoint(x.aabb.max);let b=x.aabb.getCorners();for(let M=0;M<c.length;M++){let C=!0;for(let z of b){let P=[z[0]*o,z[1]*o,z[2]];if(n.ad(P,P,c[M].matrix),P[0]<-1||P[0]>1||P[1]<-1||P[1]>1){C=!1;break}}if(x.lastCascade=M,p=Math.max(p,M),C)break}}return p+1}}class mg{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new fg,this._depthMode=new bt(t.context.gl.LEQUAL,bt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(An,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(An,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(An,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,o){let c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!o||!o.properties)return;let d=o.properties.get("shadow-intensity");if(!o.shadowsEnabled()||d<=0||(this._shadowLayerCount=c.style.order.reduce((N,F)=>{let j=c.style._mergedLayers[F];return N+(j.hasShadowPass()&&!j.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let p=c.context,_=An.shadowMapResolution,x=An.shadowMapResolution;if(this._cascades.length===0||An.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let N=0;N<An.cascadeCount;++N){let F=c._shadowMapDebug,j=p.gl,U=p.createFramebuffer(_,x,F,"texture"),Z=new n.T(p,{width:_,height:x,data:null},j.DEPTH_COMPONENT16);if(U.depthAttachment.set(Z.texture),F){let Y=new n.T(p,{width:_,height:x,data:null},j.RGBA8);U.colorAttachment.set(Y.texture)}this._cascades.push({framebuffer:U,texture:Z,matrix:[],far:0,boundingSphereRadius:0,frustum:new n.cy,scale:0})}}this.shadowDirection=ul(o);let b=0;if(t.elevation){let N=t.elevation,F=[1e4,-1e4];N.visibleDemTiles.filter(j=>j.dem).forEach(j=>{let U=j.dem.tree;F[0]=Math.min(F[0],U.minimums[0]),F[1]=Math.max(F[1],U.maximums[0])}),F[0]!==1e4&&(b=(F[1]-F[0])*N.exaggeration())}let M=1.5*t.cameraToCenterDistance,C=3*M,z=new Float64Array(16);for(let N=0;N<this._cascades.length;++N){let F=this._cascades[N],j=t.height/50,U=1;An.cascadeCount===1?U=C:N===0?U=M:(j=M,U=C);let[Z,Y]=dl(t,this.shadowDirection,j,U,An.shadowMapResolution,b);F.scale=t.scale,F.matrix=Z,F.boundingSphereRadius=Y,n.bi(z,F.matrix),F.frustum=n.cy.fromInvProjectionMatrix(z,1,0,!0),F.far=U}let P=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[P].far,this._cascades[P].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/An.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=An.shadowMapResolution,this._uniformValues.u_shadowmap_0=zn.ShadowMap0,this._uniformValues.u_shadowmap_1=zn.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let D=c.transform.elevation;for(let N of this._groundShadowTiles){let F={min:0,max:0};if(D){let j=D.getMinMaxForTile(N);j&&(F=j)}this.addShadowReceiver(N.toUnwrapped(),F.min,F.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,o){if(!this.enabled)return;let c=this.painter,d=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),d.viewport.set([0,0,An.shadowMapResolution,An.shadowMapResolution]);for(let p=0;p<this._numCascadesToRender;++p){c.currentShadowCascade=p,d.bindFramebuffer.set(this._cascades[p].framebuffer.framebuffer),d.clear({color:n.am.white,depth:1});for(let _ of t.order){let x=t._mergedLayers[_];if(!x.hasShadowPass()||x.isHidden(c.transform.zoom))continue;let b=t.getLayerSourceCache(x),M=b?o[b.id]:void 0;(x.type==="model"||M&&M.length)&&c.renderLayer(c,b,x,M)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let t=this.painter,o=t.style,c=t.context,d=c.gl,p=o.directionalLight,_=o.ambientLight;if(!p||!_)return;let x=[],b=ss(t,t.longestCutoffRange);b.shouldRenderCutoff&&x.push("RENDER_CUTOFF"),x.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&x.push("NORMAL_OFFSET");let M=Ca(o,p,_),C=new bt(d.LEQUAL,bt.ReadOnly,t.depthRangeFor3D),z=new Gt({func:d.EQUAL,mask:255},0,255,d.KEEP,d.KEEP,d.KEEP);for(let P of this._groundShadowTiles){let D=P.toUnwrapped(),N=t.isTileAffectedByFog(P),F=t.getOrCreateProgram("groundShadow",{defines:x,overrideFog:N});this.setupShadows(D,F),t.uploadCommonUniforms(c,F,D,null,b);let j={u_matrix:t.transform.calculateProjMatrix(D),u_ground_shadow_factor:M};F.draw(t,d.TRIANGLES,C,z,ti.multiply,Nt.disabled,j,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ti.unblended:ti.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){let o=this.painter.transform,c=o.calculatePosMatrix(t,o.worldSize);return n.az(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){return n.az(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,o,c){if(!this.enabled)return;let d=this.painter.transform,p=this.painter.context,_=p.gl,x=this._uniformValues,b=new Float64Array(16),M=d.calculatePosMatrix(t,d.worldSize);for(let C=0;C<this._cascades.length;C++)n.az(b,this._cascades[C].matrix,M),x[C===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(b),p.activeTexture.set(_.TEXTURE0+zn.ShadowMap0+C),this._cascades[C].texture.bindExtraParam(_.LINEAR,_.LINEAR,_.CLAMP_TO_EDGE,_.CLAMP_TO_EDGE,_.GREATER);if(this.useNormalOffset=!!c,this.useNormalOffset){let C=n.d4(t.canonical),z=2/d.tileSize*n.aj/An.shadowMapResolution,P=z*this._cascades[0].boundingSphereRadius,D=z*this._cascades[this._cascades.length-1].boundingSphereRadius,N=(c==="vector-tile"?1:3)*function(F,j,U,Z,Y){let Q=n.ay((F-22)/-22,0,1);return .125*(1-Q)+4*Q}(d.zoom);x.u_shadow_normal_offset=[C,P*N,D*N],x.u_shadow_bias=[1e-4,.0012,.012]}else x.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(p,x)}setupShadowsFromMatrix(t,o,c=!1){if(!this.enabled)return;let d=this.painter.context,p=d.gl,_=this._uniformValues,x=new Float64Array(16);for(let b=0;b<An.cascadeCount;b++)n.az(x,this._cascades[b].matrix,t),_[b===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(x),d.activeTexture.set(p.TEXTURE0+zn.ShadowMap0+b),this._cascades[b].texture.bindExtraParam(p.LINEAR,p.LINEAR,p.CLAMP_TO_EDGE,p.CLAMP_TO_EDGE,p.GREATER);if(this.useNormalOffset=c,c){let b=An.normalOffset;_.u_shadow_normal_offset=[1,b,b],_.u_shadow_bias=[6e-5,.0012,.012]}else _.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(d,_)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,o,c,d){if(d[2]>=0)return{};let p=function(b,M,C){let z=C/(1<<b.canonical.z);return new n.d6([b.canonical.x*z+b.wrap*C,b.canonical.y*z+b.wrap*C,0],[(b.canonical.x+1)*z+b.wrap*C,(b.canonical.y+1)*z+b.wrap*C,M])}(t,o,c).getCorners(),_=o/-d[2];d[0]<0?(n.d5(p[0],p[0],[d[0]*_,0,0]),n.d5(p[3],p[3],[d[0]*_,0,0])):d[0]>0&&(n.d5(p[1],p[1],[d[0]*_,0,0]),n.d5(p[2],p[2],[d[0]*_,0,0])),d[1]<0?(n.d5(p[0],p[0],[0,d[1]*_,0]),n.d5(p[1],p[1],[0,d[1]*_,0])):d[1]>0&&(n.d5(p[2],p[2],[0,d[1]*_,0]),n.d5(p[3],p[3],[0,d[1]*_,0]));let x={};return x.vertices=p,x.planes=[Zs(p[1],p[0],p[4]),Zs(p[2],p[1],p[5]),Zs(p[3],p[2],p[6]),Zs(p[0],p[3],p[7])],x}addShadowReceiver(t,o,c){this._receivers.add(t,n.d6.fromTileIdAndHeight(t,o,c))}getMaxCascadeForTile(t){let o=this._receivers.get(t);return o&&o.lastCascade?o.lastCascade:0}}function Zs(l,t,o){let c=n.at([],o,t),d=n.at([],l,t),p=n.bF([],c,d),_=n.ae(p);return _===0?[0,0,1,0]:(n.c1(p,p,1/_),[p[0],p[1],p[2],-n.bG(p,t)])}function ul(l){let t=l.properties.get("direction"),o=n.d1(t.x,t.y,t.z);o[2]=n.ay(o[2],0,75);let c=n.d3([o[0],o[1],o[2]]);return n.d2(c.x,c.y,c.z)}function Ca(l,t,o){let c=t.properties.get("color-use-theme")==="none",d=t.properties.get("color"),p=t.properties.get("intensity"),_=t.properties.get("direction"),x=[_.x,_.y,_.z],b=o.properties.get("color-use-theme")==="none",M=o.properties.get("color"),C=o.properties.get("intensity"),z=Math.max(n.bG([0,0,1],x),0),P=[0,0,0];n.c1(P,M.toPremultipliedRenderColor(b?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),C);let D=[0,0,0];return n.c1(D,d.toPremultipliedRenderColor(c?null:l.getLut(o.scope)).toArray01Linear().slice(0,3),z*p),n.d8([P[0]>0?P[0]/(P[0]+D[0]):0,P[1]>0?P[1]/(P[1]+D[1]):0,P[2]>0?P[2]/(P[2]+D[2]):0])}function dl(l,t,o,c,d,p){let _=l.zoom,x=l.scale,b=l.worldSize,M=1/b,C=l.aspect,z=Math.sqrt(1+C*C)*Math.tan(.5*l.fovX),P=z*z,D=c-o,N=c+o,F,j;P>D/N?(F=c,j=c*z):(F=.5*N*(1+P),j=.5*Math.sqrt(D*D+2*(c*c+o*o)*P+N*N*P*P));let U=l.projection.pixelsPerMeter(l.center.lat,b),Z=l._camera.getCameraToWorldMercator(),Y=[0,0,-F*M];n.ad(Y,Y,Z);let Q=j*M,ne=l._edgeInsets;if(!(ne.left===0&&ne.top===0&&ne.right===0&&ne.bottom===0||ne.left===ne.right&&ne.top===ne.bottom)){let $e=l._camera.getWorldToCamera(l.worldSize,l.projection.zAxisUnit==="meters"?U:1),Ze=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,o,c);Ze[8]=2*-l.centerOffset.x/l.width,Ze[9]=2*l.centerOffset.y/l.height;let Ye=new Float64Array(16);n.cM(Ye,Ze,$e);let ct=new Float64Array(16);n.bi(ct,Ye);let Mt=n.cy.fromInvProjectionMatrix(ct,b,_,!0);for(let Ot of Mt.points){let yt=((he=Ot)[0]/=x,he[1]/=x,he[2]=n.cb(he[2],l._center.lat),he);Q=Math.max(Q,n.c2(n.d7([],Y,yt)))}}var he;Q*=d/(d-1);let de=Math.acos(t[2]),oe=Math.atan2(-t[0],-t[1]),se=new Oo;se.position=Y,se.setPitchBearing(de,oe);let le=se.getWorldToCamera(b,U),Me=Q*b,_e=Math.min(l._mercatorZfromZoom(17)*b*-2,-2*Me),Ve=se.getCameraToClipOrthographic(-Me,Me,-Me,Me,_e,(Me+p*U)/t[2]),ze=new Float64Array(16);n.az(ze,Ve,le);let je=n.d2(Math.floor(1e6*Y[0])/1e6*b,Math.floor(1e6*Y[1])/1e6*b,0),rt=.5*d,Ce=[0,0,0];n.ad(Ce,je,ze),n.c1(Ce,Ce,rt);let me=[Math.floor(Ce[0]),Math.floor(Ce[1]),Math.floor(Ce[2])],ke=[0,0,0];n.at(ke,Ce,me),n.c1(ke,ke,-1/rt);let Pe=new Float64Array(16);return n.bx(Pe),n.bo(Pe,Pe,ke),n.az(ze,Pe,ze),[ze,Me]}class Nf extends n.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,o){return n.aS(this.requestManager.transformRequest(o,n.R.Model).url).then(c=>{if(!c)return;let d=n.aT(c),p=new n.aU(t,void 0,void 0,d);return p.computeBoundsAndApplyParent(),p}).catch(c=>{if(c&&c.status===404)return null;this.fire(new n.z(new Error(`Could not load model ${t} from ${o}: ${c.message}`)))})}load(t,o,c={forceReload:!1}){this.models[o]||(this.models[o]={});let d=Object.keys(t),p=[],_=[];for(let x of d){let b=t[x];this.hasURLBeenRequested(b)&&!c.forceReload||(this.modelByURL[b]={modelId:x,scope:o},p.push(this.loadModel(x,b)),_.push(x)),this.models[o][x]||(this.models[o][x]={model:null,numReferences:1})}this.numModelsLoading[o]=(this.numModelsLoading[o]||0)+_.length,Promise.allSettled(p).then(x=>{for(let b=0;b<x.length;b++){let{status:M}=x[b];if(M==="rejected")continue;let{value:C}=x[b];this.models[o][_[b]]||(this.models[o][_[b]]={model:null,numReferences:1}),this.models[o][_[b]].model=C}this.numModelsLoading[o]-=_.length,this.fire(new n.A("data",{dataType:"style"}))}).catch(x=>{this.fire(new n.z(new Error(`Could not load models: ${x.message}`)))})}isLoaded(){for(let t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,o,c={exactIdMatch:!1}){return!!(c.exactIdMatch?this.getModel(t,o):this.getModelByURL(this.modelUris[o][t]))}getModel(t,o){return this.models[o]||(this.models[o]={}),this.models[o][t]?this.models[o][t].model:void 0}getModelByURL(t){if(!t)return null;let o=this.modelByURL[t];return o?this.models[o.scope][o.modelId].model:null}hasModelBeenAdded(t,o){return this.models[o]&&this.models[o][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,o,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});let d=this.requestManager.normalizeModelURL(o);if((this.hasModel(t,c,{exactIdMatch:!0})||this.hasModelBeenAdded(t,c))&&this.modelUris[c][t]===d)this.models[c][t].numReferences++;else if(this.hasURLBeenRequested(d)){let{scope:p,modelId:_}=this.modelByURL[d];this.models[p][_].numReferences++}else this.modelUris[c][t]=d,this.load({[t]:this.modelUris[c][t]},c)}addModelURLs(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let c=this.modelUris[o];for(let d in t)c[d]=this.requestManager.normalizeModelURL(t[d])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let c={};for(let d of t)this.hasModel(d,o,{exactIdMatch:!0})||this.hasURLBeenRequested(d)?this.models[o][d].numReferences++:this.modelUris[o][d]&&!this.hasURLBeenRequested(d)?c[d]=this.modelUris[o][d]:!this.hasURLBeenRequested(d)&&n.d9(d,!1)&&(this.modelUris[o][d]=this.requestManager.normalizeModelURL(d),c[d]=this.modelUris[o][d]);this.load(c,o)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,o,c=!1,d=!1){if(this.models[o]&&this.models[o][t]&&(this.models[o][t].numReferences--,this.models[o][t].numReferences===0||d)){let p=this.modelUris[o][t];c||delete this.modelUris[o][t],delete this.modelByURL[p];let _=this.models[o][t].model;if(!_)return;delete this.models[o][t],_.destroy()}}destroy(){for(let t of Object.keys(this.models))for(let o of Object.keys(this.models[t])){let c=this.models[t][o].model;delete this.models[t][o],c&&c.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,o){this.models[o]||(this.models[o]={});for(let c in this.models[o])this.models[o][c].model&&this.models[o][c].model.upload(t.context)}}let Oh=new n.a7({data:new n.a8(n.a5.colorTheme.data)});class yd{constructor(t){this._scope=t,this._buildingQueryParams={target:{featuresetId:"building-outline",importId:this._scope}},this._floorQueryParams={target:{featuresetId:"floor-outline",importId:this._scope}}}execute(t){let o=this._makeBuildingsQueryArea(t),c=this._makeFloorsQueryArea(t),d=t.queryRenderedFeatures(o,this._buildingQueryParams).filter(x=>x.properties.shape_type==="building").reduce((x,b)=>{let M=b.properties.id;return b.properties.shape_type!=="building"||x.some(C=>C.properties.id===M)||x.push(b),x},[]),p=t.queryRenderedFeatures(c,this._floorQueryParams).filter(x=>x.properties.shape_type==="floor").reduce((x,b)=>{let M=b.properties.id;return b.properties.shape_type!=="floor"||x.some(C=>C.properties.id===M)||x.push(b),x},[]),_=[t.getCenter().lng,t.getCenter().lat];return{floors:p,building:this._findBuildingAtCenter(_,d)||(d.length>0?d[0]:null)}}_makeBuildingsQueryArea(t){let o=t.transform.width,c=t.transform.height,d=Math.min(o,c),p=d*(1/8),_=d*(1/8),x=.5*(o-p),b=.5*(c-_);return[new n.P(x,b),new n.P(x+p,b+_)]}_makeFloorsQueryArea(t){let o=t.transform.width,c=t.transform.height,d=o*(2/3),p=c*(2/3),_=.5*(o-d),x=.5*(c-p);return[new n.P(_,x),new n.P(_+d,x+p)]}_findBuildingAtCenter(t,o){for(let c of o)if(c.geometry.type==="Polygon"&&this._pointInPolygon(t,c.geometry.coordinates[0]))return c;return null}_pointInPolygon(t,o){let c=!1;for(let d=0,p=o.length-1;d<o.length;p=d++){let _=o[d][0],x=o[d][1],b=o[p][1];x>t[1]!=b>t[1]&&t[0]<(o[p][0]-_)*(t[1]-x)/(b-x)+_&&(c=!c)}return c}}class Ws{constructor(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}setBuildingId(t){this._selectedBuildingId=t}setFloors(t){if(this._floors=t.filter(o=>o.properties.building_id===this._selectedBuildingId),!this._selectedFloorId||!this._floors.map(o=>o.properties.id).includes(this._selectedFloorId)){let o=this._floors.map(c=>({id:c.properties.id,level:c.properties.floor_level})).reduce((c,d)=>{let p=Math.abs(c.level-1),_=Math.abs(d.level-1);return _<p||_===p&&d.level>c.level?d:c});this._selectedFloorId=o.id}}setFloorId(t){this._selectedFloorId=t}getSelectedFloorId(){return this._selectedFloorId}getCurrentBuildingFloors(){return this._floors}reset(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}}let _g={"mbx-indoor-level-selected":{default:["literal",[]]}};function Vf(l){return l=l||{},Object.assign(l,_g)}class gg extends n.E{constructor(t){super(),n.aV(["_onLoad","_onMove"],this),this._map=t,this._floorSelectionState=new Ws,this._queryIndoor(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=null,this._floorSelectionState=null}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._indoorDataQuery?this.fire(new n.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._scope=t.scope,this._indoorDataQuery=new yd(this._scope)))}),this._map._addIndoorControl(),this._queryIndoor()}_onMove(){this._queryIndoor()}_queryIndoor(){if(!this._indoorDataQuery||!this._map.isStyleLoaded())return;if(this._map.transform.zoom<16)return void this._clearIndoorData();let t=this._indoorDataQuery.execute(this._map);t&&t.floors.length!==0?(this._floorSelectionState.getSelectedFloorId()||this._map._addIndoorControl(),this._selectFloors(t)):this._clearIndoorData()}_selectFloors(t){if(t.building)this._floorSelectionState.setBuildingId(t.building.properties.id),this._floorSelectionState.setFloors(t.floors),this._updateUI();else{let o=this._floorSelectionState.getSelectedFloorId();if(o&&t.floors.some(c=>c.properties.id===o))return;this._clearIndoorData()}}_clearIndoorData(){this._floorSelectionState.reset(),this._map._removeIndoorControl(),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[]])}_updateUI(){let t=this._floorSelectionState.getCurrentBuildingFloors().map(c=>({id:c.properties.id,name:c.properties.name,shortName:c.properties.floor_level,levelOrder:c.properties.floor_level})),o=this._floorSelectionState.getSelectedFloorId();o?(this._updateIndoorConfig(),this.fire(new n.A("indoorupdate",{selectedFloorId:o,floors:t}))):console.warn("IndoorManager: Selected floor is not set")}_updateIndoorConfig(){let t=this._floorSelectionState.getSelectedFloorId();t?this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[t]]):console.warn("IndoorManager: Selected floor is not set")}selectFloor(t){this._floorSelectionState.setFloorId(t),this._updateIndoorConfig()}}function Uf(l){if(!l.metadata||!l.metadata.content_area)return;let t=n.q.devicePixelRatio,{left:o,top:c,width:d,height:p}=l.metadata.content_area,_=o*t,x=c*t;return[_,x,_+d*t,x+p*t]}function jf(l){if(l)return l.map(([t,o])=>[t*n.q.devicePixelRatio,o*n.q.devicePixelRatio])}class xd{constructor(t,o,c){this.id=t,this.scope=o,this.sourceCache=c,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){let t=new Map;if(!this.sourceCache.loaded())return t;let o=this.sourceCache.getVisibleCoordinates();if(o.length===0)return t;let c=this.sourceCache.getSource();if(!(c instanceof Gs))return t;let d=o.map(_=>this.sourceCache.getTile(_)),p=c.getImages(d,Array.from(this.pendingRequests));for(let[_,x]of p)t.set(n.I.from({name:_,iconsetId:this.id}),x),this.pendingRequests.delete(_);for(let _ of this.pendingRequests)this.missingRequests.add(_);return this.pendingRequests.clear(),t}}let Xs=(l,t)=>re(l,t&&t.filter(o=>o.identifier!=="source.canvas")),Gf=n.aF(wi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),qf=n.aF(wi,["setCenter","setZoom","setBearing","setPitch"]),kh=new Set(["background","sky","slot","custom"]),Ys={version:8,layers:[],sources:{}},zc={duration:300,delay:0};class ko extends n.E{constructor(t,o={}){super(),this.map=t,this.scope=o.scope||"",this.globalId=null,this.fragments=[],this.importDepth=o.importDepth||0,this.importsCache=o.importsCache||new Map,this.resolvedImports=o.resolvedImports||new Set,this.transition=n.h({},zc),this._buildingIndex=new Rf(this),this.crossTileSymbolIndex=new qn,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=o.styleChanges||new oc,this.dispatcher=o.dispatcher?o.dispatcher:new n.D(n.db(),this),o.imageManager?this.imageManager=o.imageManager:(this.imageManager=new zr(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=o.glyphManager?o.glyphManager:new n.dc(t._requestManager,o.localFontFamily?n.dd.all:o.localIdeographFontFamily?n.dd.ideographs:n.dd.none,o.localFontFamily||o.localIdeographFontFamily),o.modelManager?this.modelManager=o.modelManager:(this.modelManager=new Nf(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=o.configOptions?o.configOptions:new Map,this._configDependentLayers=o.configDependentLayers?o.configDependentLayers:new Set,this._config=o.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:o.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=o.initialConfig,this.dispatcher.broadcast("setReferrer",n.de());let c=this;this._rtlTextPluginCallback=ko.registerForPluginStateChange(d=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},(p,_)=>{if(n.df(p),_&&_.every(x=>x))for(let x in c._sourceCaches){let b=c._sourceCaches[x],M=b.getSource().type;M!=="vector"&&M!=="geojson"||b.reload()}})}),this.on("data",d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;let p=this.getOwnSource(d.sourceId);if(p&&p.vectorLayerIds)for(let _ in this._layers){let x=this._layers[_];x.source===p.id&&this._validateLayer(x)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(n.j(t))return t;let o=n.dg(t);if(!o.startsWith("http"))try{return new URL(o,location.href).toString()}catch{return o}return o}return`json://${n.dh(JSON.stringify(t))}`}_diffStyle(t,o,c){this.globalId=this._getGlobalId(t);let d=(p,_)=>{try{_(null,this.setState(p,c))}catch(x){_(x,!1)}};if(typeof t=="string"){let p=this.map._requestManager.normalizeStyleURL(t),_=this.map._requestManager.transformRequest(p,n.R.Style);n.n(_,(x,b)=>{x?this.fire(new n.z(x)):b&&d(b,o)})}else typeof t=="object"&&d(t,o)}loadURL(t,o={}){this.fire(new n.A("dataloading",{dataType:"style"}));let c=typeof o.validate=="boolean"?o.validate:!n.j(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,o.accessToken),this.resolvedImports.add(t);let d=this.importsCache.get(t);if(d)return this._load(d,c);let p=this.map._requestManager.transformRequest(t,n.R.Style);this._request=n.n(p,(_,x)=>{if(this._request=null,_)this.fire(new n.z(_));else if(x)return this.importsCache.set(t,x),this._load(x,c)})}loadJSON(t,o={}){this.fire(new n.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=n.q.frame(()=>{this._request=null,this._load(t,o.validate!==!1)})}loadEmpty(){this.fire(new n.A("dataloading",{dataType:"style"})),this._load(Ys,!1)}_loadImports(t,o,c){if(this.importDepth>=4)return n.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let d=[];for(let p of t){let _=this._createFragmentStyle(p),x=new Promise(C=>{_.once("style.import.load",C),_.once("error",C)}).then(()=>this.mergeAll());if(d.push(x),this.resolvedImports.has(p.url)){_.loadEmpty();continue}let b=p.data||this.importsCache.get(p.url);b?(_.loadJSON(b,{validate:o}),this._isInternalStyle(b)&&(_.globalId=null)):p.url?_.loadURL(p.url,{validate:o}):_.loadEmpty();let M={style:_,id:p.id,config:p.config};if(c){let C=this.fragments.findIndex(({id:z})=>z===c);this.fragments=this.fragments.slice(0,C).concat(M).concat(this.fragments.slice(C))}else this.fragments.push(M)}return Promise.allSettled(d)}getImportGlobalIds(t=this,o=new Set){for(let c of t.fragments)c.style.globalId&&o.add(c.style.globalId),this.getImportGlobalIds(c.style,o);return[...o.values()]}_createFragmentStyle(t){let o=this.scope?n.C(t.id,this.scope):t.id,c,d=this._initialConfig&&this._initialConfig[o];(t.config||d)&&(c=n.h({},t.config,d));let p=new ko(this.map,{scope:o,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return p.setEventedParent(this.map,{style:p}),p}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,o){let c=t.indoor?Vf(t.schema):t.schema;if(this._isInternalStyle(t)){let _=n.h({},Ys,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(_,o)}if(this.updateConfig(this._config,c),o&&Xs(this,po(t)))return;this._loaded=!0,this.stylesheet=n.di(t);let d=()=>{for(let M in t.sources)this.addSource(M,t.sources[M],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(let M in t.iconsets)this.addIconset(M,t.iconsets[M]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);let _=xc(this.stylesheet.layers);if(this._order=_.map(M=>M.id),this.stylesheet.light&&n.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){let M=this.stylesheet.lights[0];this.light=new De(M.properties,M.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new De(this.stylesheet.light)),this._layers={};for(let M of _){let C=n.dn(M,this.scope,this._styleColorTheme.lut,this.options);C.configDependencies.size!==0&&this._configDependentLayers.add(C.fqid),C.setEventedParent(this,{layer:{id:C.id}}),this._layers[C.id]=C;let z=this.getOwnLayerSourceCache(C),P=!!this.directionalLight&&this.directionalLight.shadowsEnabled();z&&C.canCastShadows()&&P&&(z.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);let x=this.stylesheet.terrain;x&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(x,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new n.A("data",{dataType:"style"}));let b=this.isRootStyle();t.imports?this._loadImports(t.imports,o).then(()=>{this._reloadImports(),this.fire(new n.A(b?"style.load":"style.import.load"))}).catch(M=>{this.fire(new n.z(new Error("Failed to load imports",M))),this.fire(new n.A(b?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new n.A(b?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];let p=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(p){let _=this._evaluateColorThemeData(p);this._loadColorTheme(_).then(()=>{d()}).catch(x=>{n.w(`Couldn't load color theme from the stylesheet: ${x}`),d()})}else this._styleColorTheme.lut=null,d()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,o,c,d,p,_,x,b,M,C,z={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(P=>{if(P.stylesheet){if(P.light!=null&&(t=P.light),P.stylesheet.lights)for(let D of P.stylesheet.lights)D.type==="ambient"&&P.ambientLight!=null&&(o=P.ambientLight),D.type==="directional"&&P.directionalLight!=null&&(c=P.directionalLight);d=this._prioritizeTerrain(d,P.terrain,P.stylesheet.terrain),P.stylesheet.fog&&P.fog!=null&&(p=P.fog),P.stylesheet.snow&&P.snow!=null&&(_=P.snow),P.stylesheet.rain&&P.rain!=null&&(x=P.rain),P.stylesheet.camera!=null&&(C=P.stylesheet.camera),P.stylesheet.projection!=null&&(b=P.stylesheet.projection),P.stylesheet.transition!=null&&(M=P.stylesheet.transition),z[P.scope]=P._styleColorTheme}}),this.light=t,this.ambientLight=o,this.directionalLight=c,this.fog=p,this.snow=_,this.rain=x,this._styleColorThemeForScope=z,d===null?delete this.terrain:this.terrain=d,this.camera=C||{"camera-projection":"perspective"},this.projection=b||{name:"mercator"},this.transition=n.h({},zc,M),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){let o=c=>{for(let d of c.fragments)o(d.style);t(c)};o(this)}_prioritizeTerrain(t,o,c){let d=t&&t.drapeRenderMode===0;return c===null?o&&o.drapeRenderMode===0?o:d?t:null:o!=null&&(!t||d||o&&o.drapeRenderMode===1)?o:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(o=>{t=this._prioritizeTerrain(t,o.terrain,o.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(o=>{o.stylesheet.projection!=null&&(t=o.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){let t={},o={},c={};this.forEachFragmentStyle(d=>{for(let p in d._sourceCaches){let _=n.C(p,d.scope);t[_]=d._sourceCaches[p]}for(let p in d._otherSourceCaches){let _=n.C(p,d.scope);o[_]=d._otherSourceCaches[p]}for(let p in d._symbolSourceCaches){let _=n.C(p,d.scope);c[_]=d._symbolSourceCaches[p]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=o,this._mergedSymbolSourceCaches=c}mergeLayers(){let t={},o=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(p=>{for(let _ of p._order){let x=p._layers[_];if(x.type==="slot"){let b=n.dj(_);if(t[b])continue;t[b]=[]}x.slot&&t[x.slot]?t[x.slot].push(x):o.push(x)}}),this._mergedOrder=[];let d=(p=[])=>{for(let _ of p)if(_.type==="slot"){let x=n.dj(_.id);t[x]&&d(t[x]),this._mergedSlots.push(x)}else{let x=n.C(_.id,_.scope);this._mergedOrder.push(x),c[x]=_,_.is3D(!!this.terrain)&&(this._has3DLayers=!0),_.type==="circle"&&(this._hasCircleLayers=!0),_.type==="symbol"&&(this._hasSymbolLayers=!0),_.type==="clip"&&(this._clipLayerPresent=!0)}};d(o),this._mergedOrder.sort((p,_)=>{let x=c[p],b=c[_];return x.hasInitialOcclusionOpacityProperties?b.is3D(!!this.terrain)?1:0:x.is3D(!!this.terrain)&&b.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=n.h({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(o,c,d,p){let _=n.h({},c);for(let b of Object.keys(n.a5.colorTheme))_[b]===void 0&&(_[b]=n.a5.colorTheme[b].default);let x=new n.a6(Oh,o,new Map(d));return x.setTransitionOrValue(_,d),x.untransitioned().possiblyEvaluate(new n.aa(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let o=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((c,d)=>{let p="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let _=t;_.startsWith(p)||(_=p+_);let x=n.I.from("mapbox-reserved-lut"),b=new Image;b.src=_,b.onerror=()=>{this._styleColorTheme.lutLoading=!1,d(new Error("Failed to load image data"))},b.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==o)return void c();this._styleColorTheme.lutLoading=!1;let{width:M,height:C,data:z}=n.q.getImageData(b);if(C>32)return void d(new Error("The height of the image must be less than or equal to 32 pixels."));if(M!==C*C)return void d(new Error("The width of the image must be equal to the height squared."));this.getImage(x)&&this.removeImage(x),this.addImage(x,{data:new n.r({width:M,height:C},z),pixelRatio:1,sdf:!1,usvg:!1,version:0});let P=this.imageManager.getImage(x,this.scope);P?(this._styleColorTheme.lut={image:P.data,data:t},c()):d(new Error("Missing LUT image."))}})}getLut(t){let o=this._styleColorThemeForScope[t];return o?o.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(o,c,d){let p,_,x,b=n.q.devicePixelRatio>1?"@2x":"",M=n.n(c.transformRequest(c.normalizeSpriteURL(o,b,".json"),n.R.SpriteJSON),(P,D)=>{M=null,x||(x=P,p=D,z())}),C=n.o(c.transformRequest(c.normalizeSpriteURL(o,b,".png"),n.R.SpriteImage),(P,D)=>{C=null,x||(x=P,_=D,z())});function z(){if(x)d(x);else if(p&&_){let P=n.q.getImageData(_),D={};for(let N in p){let{width:F,height:j,x:U,y:Z,sdf:Y,pixelRatio:Q,stretchX:ne,stretchY:he,content:de}=p[N],oe=new n.r({width:F,height:j});n.r.copy(P,oe,{x:U,y:Z},{x:0,y:0},{width:F,height:j},null),D[N]={data:oe,pixelRatio:Q,sdf:Y,stretchX:ne,stretchY:he,content:de,usvg:!1}}d(null,D)}}return{cancel(){M&&(M.cancel(),M=null),C&&(C.cancel(),C=null)}}}(t,this.map._requestManager,(o,c)=>{if(this._spriteRequest=null,o)this.fire(new n.z(o));else if(c){let d=new Map;for(let p in c)d.set(n.I.from(p),c[p]);this.addImages(d)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new n.A("data",{dataType:"style"}))})}addIconset(t,o){if(o.type==="sprite")return void this._loadSprite(o.url);let c=this.getOwnSourceCache(o.source);if(!c)return void this.fire(new n.z(new Error(`Source "${o.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));let d=c.getSource();if(d.type!=="raster-array")return void this.fire(new n.z(new Error(`Source "${o.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));d.partial=!1;let p=new xd(t,this.scope,c);this.imageManager.addImageProvider(p,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!n.j(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);let o=this.map._spriteFormat==="auto";var c,d;this._spriteRequest=(d=(p,_)=>{if(this._spriteRequest=null,p)o?this._loadSprite(t):this.fire(new n.z(p));else if(_){let x=new Map;for(let b in _)x.set(n.I.from(b),_[b]);this.addImages(x)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new n.A("data",{dataType:"style"}))},n.br((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),n.R.Iconset),(p,_)=>{if(p)return void d(p);let x={},b=n.da(new n.bq(_));for(let M of b.icons){let C={version:1,pixelRatio:n.q.devicePixelRatio,content:Uf(M),stretchX:M.metadata?jf(M.metadata.stretch_x_areas):void 0,stretchY:M.metadata?jf(M.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:M};x[M.name]=C}d(null,x)}))}_validateLayer(t){let o=this.getOwnSource(t.source);if(!o)return;let c=t.sourceLayer;c&&(o.type==="geojson"||o.vectorLayerIds&&o.vectorLayerIds.indexOf(c)===-1)&&this.fire(new n.z(new Error(`Source layer "${c}" does not exist on source "${o.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,o)=>{let c=this.fragments[o];return c&&c.style&&(t.data=c.style.serialize()),t})}_serializeSources(){let t={};for(let o in this._sourceCaches){let c=this._sourceCaches[o].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){let o=[];for(let c of t){let d=this._layers[c];d&&d.type!=="custom"&&o.push(d.serialize())}return o}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(let t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(let t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){let o=this.getOwnLayer(t);if(o)return o;this.fire(new n.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){let o=this.getOwnSource(t);if(o)return o;this.fire(new n.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,o){let c=this.map.painter;if(c)for(let d=t.minzoom||0;d<(t.maxzoom||25.5);d++){let p=t.getProgramIds();if(p)for(let _ of p){let x=t.getDefaultProgramParams(_,o.zoom,this._styleColorTheme.lut);x&&(c.style=this,this.fog&&(c._fogVisible=!0,x.overrideFog=!0,c.getOrCreateProgram(_,x)),c._fogVisible=!1,x.overrideFog=!1,c.getOrCreateProgram(_,x),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(x.overrideRtt=!0,c.getOrCreateProgram(_,x)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);let o=this.calculateLightsBrightness();t.brightness=o||0,o!==this._brightness&&(this._brightness=o,this.dispatcher.broadcast("setBrightness",o)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));let c=this._changes.isDirty(),d=!1;if(this._changes.isDirty()){let x=this._changes.getLayerUpdatesByScope();for(let b in x){let{updatedIds:M,removedIds:C}=x[b];(M||C)&&(this._updateWorkerLayers(b,M,C),d=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}let p={};for(let x in this._mergedSourceCaches){let b=this._mergedSourceCaches[x];p[x]=b.used,b.used=!1,b.tileCoverLift=0}for(let x of this._mergedOrder){let b=this._mergedLayers[x];if(b.recalculate(t,this._availableImages),!b.isHidden(t.zoom)){let M=this.getLayerSourceCache(b);M&&(M.used=!0,M.tileCoverLift=Math.max(M.tileCoverLift,b.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(b,t)}):this.precompilePrograms(b,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&d&&this.mergeLayers();let _=this.imageManager.getPendingImageProviders();for(let x of _)x.sourceCache.used=!0;for(let x in p){let b=this._mergedSourceCaches[x];p[x]!==b.used&&b.getSource().fire(new n.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:b.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),c&&this.fire(new n.A("data",{dataType:"style"}))}updateImageProviders(){let t=this.imageManager.getPendingImageProviders();for(let o of t){let c=o.resolvePendingRequests(),d=this.getFragmentStyle(o.scope);d&&d.addImages(c)}}_updateTilesForChangedImages(){let t={};for(let o in this._mergedSourceCaches){let c=this._mergedSourceCaches[o].getSource().scope;t[c]=t[c]||this._changes.getUpdatedImages(c),t[c].length!==0&&this._mergedSourceCaches[o].reloadTilesForDependencies(["icons","patterns"],t[c])}for(let o in t)this._changes.resetUpdatedImages(o)}_updateWorkerLayers(t,o,c){let d=this.getFragmentStyle(t);d&&this.dispatcher.broadcast("updateLayers",{layers:o?d._serializeLayers(o):[],scope:t,removedIds:c||[],options:d.options})}setState(t,o){if(this._checkLoaded(),Xs(this,po(t)))return!1;(t=n.di(t)).layers=xc(t.layers);let c=function(_,x){if(!_)return[{command:wi.setStyle,args:[x]}];let b=[];try{if(!n.bv(_.version,x.version))return[{command:wi.setStyle,args:[x]}];if(n.bv(_.center,x.center)||b.push({command:wi.setCenter,args:[x.center]}),n.bv(_.zoom,x.zoom)||b.push({command:wi.setZoom,args:[x.zoom]}),n.bv(_.bearing,x.bearing)||b.push({command:wi.setBearing,args:[x.bearing]}),n.bv(_.pitch,x.pitch)||b.push({command:wi.setPitch,args:[x.pitch]}),n.bv(_.sprite,x.sprite)||b.push({command:wi.setSprite,args:[x.sprite]}),n.bv(_.glyphs,x.glyphs)||b.push({command:wi.setGlyphs,args:[x.glyphs]}),n.bv(_.imports,x.imports)||function(D=[],N=[],F){N=N||[];let j=(D=D||[]).map(Sa),U=N.map(Sa),Z=D.reduce(qs,{}),Y=N.reduce(qs,{}),Q=j.slice(),ne,he,de,oe;for(ne=0,he=0;ne<j.length;ne++)de=j[ne],Y.hasOwnProperty(de)?he++:(F.push({command:wi.removeImport,args:[de]}),Q.splice(Q.indexOf(de,he),1));for(ne=0,he=0;ne<U.length;ne++)de=U[U.length-1-ne],Q[Q.length-1-ne]!==de&&(Z.hasOwnProperty(de)?(F.push({command:wi.removeImport,args:[de]}),Q.splice(Q.lastIndexOf(de,Q.length-he),1)):he++,oe=Q[Q.length-ne],F.push({command:wi.addImport,args:[Y[de],oe]}),Q.splice(Q.length-ne,0,de));for(let se of N){let le=Z[se.id];le&&(delete le.data,n.bv(le,se)||F.push({command:wi.updateImport,args:[se.id,se]}))}}(_.imports,x.imports,b),n.bv(_.transition,x.transition)||b.push({command:wi.setTransition,args:[x.transition]}),n.bv(_.light,x.light)||b.push({command:wi.setLight,args:[x.light]}),n.bv(_.fog,x.fog)||b.push({command:wi.setFog,args:[x.fog]}),n.bv(_.snow,x.snow)||b.push({command:wi.setSnow,args:[x.snow]}),n.bv(_.rain,x.rain)||b.push({command:wi.setRain,args:[x.rain]}),n.bv(_.projection,x.projection)||b.push({command:wi.setProjection,args:[x.projection]}),n.bv(_.lights,x.lights)||b.push({command:wi.setLights,args:[x.lights]}),n.bv(_.camera,x.camera)||b.push({command:wi.setCamera,args:[x.camera]}),n.bv(_.iconsets,x.iconsets)||function(D,N,F){let j;for(j in N=N||{},D=D||{})D.hasOwnProperty(j)&&(N.hasOwnProperty(j)||F.push({command:wi.removeIconset,args:[j]}));for(j in N){if(!N.hasOwnProperty(j))continue;let U=N[j];D.hasOwnProperty(j)?n.bv(D[j],U)||(F.push({command:wi.removeIconset,args:[j]}),F.push({command:wi.addIconset,args:[j,U]})):F.push({command:wi.addIconset,args:[j,U]})}}(_.iconsets,x.iconsets,b),!n.bv(_["color-theme"],x["color-theme"]))return[{command:wi.setStyle,args:[x]}];let M={},C=[];(function(D,N,F,j){let U;for(U in N=N||{},D=D||{})D.hasOwnProperty(U)&&(N.hasOwnProperty(U)||rl(U,F,j));for(U in N){if(!N.hasOwnProperty(U))continue;let Z=N[U];D.hasOwnProperty(U)?n.bv(D[U],Z)||(D[U].type==="geojson"&&Z.type==="geojson"&&dg(D,N,U)?F.push({command:wi.setGeoJSONSourceData,args:[U,Z.data]}):vc(U,N,F,j)):Ch(U,N,F)}})(_.sources,x.sources,C,M);let z=[];_.layers&&_.layers.forEach(D=>{D.source&&M[D.source]?b.push({command:wi.removeLayer,args:[D.id]}):z.push(D)});let P=_.terrain;P&&M[P.source]&&(b.push({command:wi.setTerrain,args:[void 0]}),P=void 0),b=b.concat(C),n.bv(P,x.terrain)||b.push({command:wi.setTerrain,args:[x.terrain]}),function(D,N,F){N=N||[];let j=(D=D||[]).map(Sa),U=N.map(Sa),Z=D.reduce(qs,{}),Y=N.reduce(qs,{}),Q=j.slice(),ne=Object.create(null),he,de,oe,se,le,Me,_e;for(he=0,de=0;he<j.length;he++)oe=j[he],Y.hasOwnProperty(oe)?de++:(F.push({command:wi.removeLayer,args:[oe]}),Q.splice(Q.indexOf(oe,de),1));for(he=0,de=0;he<U.length;he++)oe=U[U.length-1-he],Q[Q.length-1-he]!==oe&&(Z.hasOwnProperty(oe)?(F.push({command:wi.removeLayer,args:[oe]}),Q.splice(Q.lastIndexOf(oe,Q.length-de),1)):de++,Me=Q[Q.length-he],F.push({command:wi.addLayer,args:[Y[oe],Me]}),Q.splice(Q.length-he,0,oe),ne[oe]=!0);for(he=0;he<U.length;he++)if(oe=U[he],se=Z[oe],le=Y[oe],!ne[oe]&&!n.bv(se,le))if(n.bv(se.source,le.source)&&n.bv(se["source-layer"],le["source-layer"])&&n.bv(se.type,le.type)){for(_e in bc(se.layout,le.layout,F,oe,null,wi.setLayoutProperty),bc(se.paint,le.paint,F,oe,null,wi.setPaintProperty),n.bv(se.slot,le.slot)||F.push({command:wi.setSlot,args:[oe,le.slot]}),n.bv(se.filter,le.filter)||F.push({command:wi.setFilter,args:[oe,le.filter]}),n.bv(se.minzoom,le.minzoom)&&n.bv(se.maxzoom,le.maxzoom)||F.push({command:wi.setLayerZoomRange,args:[oe,le.minzoom,le.maxzoom]}),se)se.hasOwnProperty(_e)&&_e!=="layout"&&_e!=="paint"&&_e!=="filter"&&_e!=="metadata"&&_e!=="minzoom"&&_e!=="maxzoom"&&_e!=="slot"&&(_e.indexOf("paint.")===0?bc(se[_e],le[_e],F,oe,_e.slice(6),wi.setPaintProperty):n.bv(se[_e],le[_e])||F.push({command:wi.setLayerProperty,args:[oe,_e,le[_e]]}));for(_e in le)le.hasOwnProperty(_e)&&!se.hasOwnProperty(_e)&&_e!=="layout"&&_e!=="paint"&&_e!=="filter"&&_e!=="metadata"&&_e!=="minzoom"&&_e!=="maxzoom"&&_e!=="slot"&&(_e.indexOf("paint.")===0?bc(se[_e],le[_e],F,oe,_e.slice(6),wi.setPaintProperty):n.bv(se[_e],le[_e])||F.push({command:wi.setLayerProperty,args:[oe,_e,le[_e]]}))}else F.push({command:wi.removeLayer,args:[oe]}),Me=Q[Q.lastIndexOf(oe)+1],F.push({command:wi.addLayer,args:[le,Me]})}(z,x.layers,b)}catch(M){console.warn("Unable to compute style diff:",M),b=[{command:wi.setStyle,args:[x]}]}return b}(this.serialize(),t).filter(_=>!(_.command in qf));if(c.length===0)return!1;let d=c.filter(_=>!(_.command in Gf));if(d.length>0)throw new Error(`Unimplemented: ${d.map(_=>_.command).join(", ")}.`);let p=[];return c.forEach(_=>{p.push(this[_.command](..._.args))}),o&&Promise.all(p).then(o).catch(o),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(let[o,c]of t.entries()){if(this.getImage(o))return this.fire(new n.z(new Error(`An image with the name "${o.name}" already exists.`)));this.imageManager.addImage(o,this.scope,c),this._changes.updateImage(o,this.scope)}return this._updateWorkerImages(),this.fire(new n.A("data",{dataType:"style"})),this}addImage(t,o){return this.getImage(t)?this.fire(new n.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,o),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new n.A("data",{dataType:"style"})),this)}updateImage(t,o,c=!1){this.imageManager.updateImage(t,this.scope,o),c&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new n.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new n.A("data",{dataType:"style"})),this):this.fire(new n.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new n.A("data",{dataType:"style"})),this}addModel(t,o,c={}){return this._checkLoaded(),this._validate(ie,`models.${t}`,o,null,c)||(this.modelManager.addModel(t,o,this.scope),this.fire(new n.A("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new n.A("data",{dataType:"style"})),this):this.fire(new n.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,o,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!o.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(o).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(o.type)>=0&&this._validate(hc,`sources.${t}`,o,null,c))return;this.map&&this.map._collectResourceTiming&&(o.collectResourceTiming=!0);let d=pc(t,o,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id}));let p=_=>{let x=(_?"symbol:":"other:")+d.id,b=n.C(x,this.scope),M=this._sourceCaches[x]=new Gn(b,d,_);(_?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=M,M.onAdd(this.map)};p(!1),o.type!=="vector"&&o.type!=="geojson"||p(!0),d.onAdd&&d.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();let o=this.getOwnSource(t);if(!o)throw new Error("There is no source with this ID");for(let d in this._layers)if(this._layers[d].source===t)return this.fire(new n.z(new Error(`Source "${t}" cannot be removed while layer "${d}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new n.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){let d=Object.entries(this.stylesheet.iconsets).find(([p,_])=>_.type==="source"&&_.source===t);if(d)return this.fire(new n.z(new Error(`Source "${t}" cannot be removed while iconset "${d[0]}" is using it.`)))}let c=this.getOwnSourceCaches(t);for(let d of c){let p=n.dj(d.id);delete this._sourceCaches[p],this._changes.discardSourceCacheUpdate(d.id),d.fire(new n.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),o.setEventedParent(null),o.onRemove&&o.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,o){this._checkLoaded(),this.getOwnSource(t).setData(o),this._changes.setDirty()}getOwnSource(t){let o=this.getOwnSourceCache(t);return o&&o.getSource()}getOwnSources(){let t=[];for(let o in this._otherSourceCaches){let c=this.getOwnSourceCache(o);c&&t.push(c.getSource())}return t}areTilesLoaded(){let t=this._mergedSourceCaches;for(let o in t){let c=t[o]._tiles;for(let d in c){let p=c[d];if(p.state!=="loaded"&&p.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;let o=this._getTransitionParameters();for(let p of t){if(this._validate(el,"lights",p))return;switch(p.type){case"ambient":if(this.ambientLight){let _=this.ambientLight;_.set(p),_.updateTransitions(o)}else this.ambientLight=new Hi(p,pi||(pi=new n.a7({color:new n.a8(n.a5.properties_light_ambient.color),"color-use-theme":new n.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new n.a8(n.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let _=this.directionalLight;_.set(p),_.updateTransitions(o)}else this.directionalLight=new Hi(p,Mr||(Mr=new n.a7({direction:new n.an(n.a5.properties_light_directional.direction),color:new n.a8(n.a5.properties_light_directional.color),"color-use-theme":new n.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new n.a8(n.a5.properties_light_directional.intensity),"cast-shadows":new n.a8(n.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new n.a8(n.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new n.a8(n.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let c=Object.assign(o,{worldview:this.map.getWorldview()}),d=new n.aa(this.z||0,c);this.ambientLight&&this.ambientLight.recalculate(d),this.directionalLight&&this.directionalLight.recalculate(d),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let t=this.directionalLight,o=this.ambientLight;if(!t||!o)return;let c=P=>.2126*(P[0]<=.03928?P[0]/12.92:Math.pow((P[0]+.055)/1.055,2.4))+.7152*(P[1]<=.03928?P[1]/12.92:Math.pow((P[1]+.055)/1.055,2.4))+.0722*(P[2]<=.03928?P[2]/12.92:Math.pow((P[2]+.055)/1.055,2.4)),d=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),p=t.properties.get("intensity"),_=t.properties.get("direction"),x=1-n.d1(_.x,_.y,_.z)[2]/90,b=c(d)*p*x,M=o.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),C=o.properties.get("intensity"),z=c(M)*C;return Number(((b+z)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(n.dk(t)){let o=n.dl(t),c=this.fragments.find(({id:p})=>p===o);if(!c)return;let d=n.dj(t);return c.style.getFragmentStyle(d)}{let o=this.fragments.find(({id:c})=>c===t);return o?o.style:void 0}}setFeaturesetSelectors(t){if(!t)return;let o={},c=(d,p="")=>`${d}::${p}`;this._featuresetSelectors={};for(let d in t){let p=this._featuresetSelectors[d]=[];for(let _ of t[d].selectors){if(_.featureNamespace){let b=this.getOwnLayer(_.layer);if(!b){n.w(`Layer is undefined for selector: ${_.layer}`);continue}let M=c(b.source,b.sourceLayer);if(M in o&&o[M]!==_.featureNamespace){n.w(`"featureNamespace ${_.featureNamespace} of featureset ${d}'s selector is not associated to the same source, skip this selector`);continue}o[M]=_.featureNamespace}let x;if(_.properties)for(let b in _.properties){let M=n.X(_.properties[b]);M.result==="success"&&(x=x||{},x[b]=M.value)}p.push({layerId:_.layer,namespace:_.featureNamespace,properties:x,uniqueFeatureID:_._uniqueFeatureID})}}}getFeaturesetDescriptors(t){let o=this.getFragmentStyle(t);if(!o||!o.stylesheet.featuresets)return[];let c=[];for(let d in o.stylesheet.featuresets)c.push({featuresetId:d,importId:o.scope?o.scope:void 0});return c}getFeaturesetLayers(t,o){let c=this.getFragmentStyle(o),d=c.stylesheet.featuresets;if(!d||!d[t])return this.fire(new n.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];let p=[];for(let _ of d[t].selectors){let x=c.getOwnLayer(_.layer);x&&p.push(x)}return p}getConfigProperty(t,o){let c=this.getFragmentStyle(t);if(!c)return null;let d=n.C(o,c.scope),p=c.options.get(d),_=p?p.value||p.default:null;return _?_.serialize():null}setConfigProperty(t,o,c){let d=this.getFragmentStyle(t);if(!d)return;let p=d.stylesheet.indoor?Vf(d.stylesheet.schema):d.stylesheet.schema;if(!p||!p[o])return;let _=n.X(c);if(_.result!=="success")return void Xs(this,_.value);let x=_.value.expression,b=n.C(o,d.scope),M=d.options.get(b);if(!M)return;let C,{minValue:z,maxValue:P,stepValue:D,type:N,values:F}=p[o],j=n.X(p[o].default);j.result==="success"&&(C=j.value.expression),C?(this.options.set(b,Object.assign({},M,{value:x,default:C,minValue:z,maxValue:P,stepValue:D,type:N,values:F})),this.updateConfigDependencies(o)):this.fire(new n.z(new Error(`No schema defined for the config option "${o}" in the "${t}" fragment.`)))}getConfig(t){let o=this.getFragmentStyle(t);if(!o)return null;let c=o.stylesheet.schema;if(!c)return null;let d={};for(let p in c){let _=n.C(p,o.scope),x=o.options.get(_),b=x?x.value||x.default:null;d[p]=b?b.serialize():null}return d}setConfig(t,o){let c=this.getFragmentStyle(t);c&&(c.updateConfig(o,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){let o=this.getFragmentStyle(t);return o?o.stylesheet.schema:null}setSchema(t,o){let c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=o,c.updateConfig(c._config,o),this.updateConfigDependencies())}updateConfig(t,o){if(this._config=t,t||o)if(o)for(let c in o){let d,p,_=n.X(o[c].default);if(_.result==="success"&&(d=_.value.expression),t&&t[c]!==void 0){let P=n.X(t[c]);P.result==="success"&&(p=P.value.expression)}let{minValue:x,maxValue:b,stepValue:M,type:C,values:z}=o[c];if(d){let P=n.C(c,this.scope);this.options.set(P,{default:d,value:p,minValue:x,maxValue:b,stepValue:M,type:C,values:z})}else this.fire(new n.z(new Error(`No schema defined for config option "${c}".`)))}else this.fire(new n.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(let o of this._configDependentLayers){let c=this.getLayer(o);if(c){if(t&&!c.configDependencies.has(t))continue;c.possiblyEvaluateVisibility(),this._updateLayer(c)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(o=>{let c=o._styleColorTheme.colorThemeOverride?o._styleColorTheme.colorThemeOverride:o._styleColorTheme.colorTheme;if(c){let d=o._evaluateColorThemeData(c);(!o._styleColorTheme.lut&&d!==""||o._styleColorTheme.lut&&d!==o._styleColorTheme.lut.data)&&o.setColorTheme(c)}}),this._changes.setDirty()}addLayer(t,o,c={}){this._checkLoaded();let d=t.id;if(this._layers[d])return void this.fire(new n.z(new Error(`Layer with id "${d}" already exists on this map`)));let p;if(t.type==="custom"){if(Xs(this,n.dm(t)))return;p=n.dn(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(d,t.source),t=n.di(t),t=n.h(t,{source:d})),this._validate(Ai,`layers.${d}`,t,{arrayIndex:-1},c))return;p=n.dn(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(p),p.setEventedParent(this,{layer:{id:d}})}p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid);let _=this._order.length;if(o){let C=this._order.indexOf(o);if(C===-1)return void this.fire(new n.z(new Error(`Layer with id "${o}" does not exist on this map.`)));p.slot===this._layers[o].slot?_=C:n.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(_,0,d),this._layerOrderChanged=!0,this._layers[d]=p;let x=this.getOwnLayerSourceCache(p),b=!!this.directionalLight&&this.directionalLight.shadowsEnabled();x&&p.canCastShadows()&&b&&(x.castsShadows=!0);let M=this._changes.getRemovedLayer(p);if(M&&p.source&&x&&p.type!=="custom"){this._changes.discardLayerRemoval(p);let C=n.C(p.source,p.scope);M.type!==p.type?this._changes.updateSourceCache(C,"clear"):(this._changes.updateSourceCache(C,"reload"),x.pause())}this._updateLayer(p),p.onAdd&&p.onAdd(this.map),p.scope=this.scope,this.mergeLayers()}moveLayer(t,o){this._checkLoaded();let c=this._checkLayer(t);if(!c||t===o)return;let d=this._order.indexOf(t);this._order.splice(d,1);let p=this._order.length;if(o){let _=this._order.indexOf(o);if(_===-1)return void this.fire(new n.z(new Error(`Layer with id "${o}" does not exist on this map.`)));c.slot===this._layers[o].slot?p=_:n.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(p,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();let o=this._checkLayer(t);if(!o)return;o.setEventedParent(null);let c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(o.fqid),this._changes.removeLayer(o);let d=this.getOwnLayerSourceCache(o);if(d&&d.castsShadows){let p=!1;for(let _ in this._layers)if(this._layers[_].source===o.source&&this._layers[_].canCastShadows()){p=!0;break}d.castsShadows=p}o.onRemove&&o.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(let o in this._layers)if(this._layers[o].type===t)return!0;return!1}setLayerZoomRange(t,o,c){this._checkLoaded();let d=this._checkLayer(t);d&&(d.minzoom===o&&d.maxzoom===c||(o!=null&&(d.minzoom=o),c!=null&&(d.maxzoom=c),this._updateLayer(d)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,o){this._checkLoaded();let c=this._checkLayer(t);c&&c.slot!==o&&(c.slot=o,this._updateLayer(c))}setFilter(t,o,c={}){this._checkLoaded();let d=this._checkLayer(t);if(d&&!n.bv(d.filter,o))return o==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(Re,`layers.${d.id}.filter`,o,{layerType:d.type},c)||(d.filter=n.di(o),this._updateLayer(d)))}getFilter(t){let o=this._checkLayer(t);if(o)return n.di(o.filter)}setLayoutProperty(t,o,c,d={}){this._checkLoaded();let p=this._checkLayer(t);if(p&&!n.bv(p.getLayoutProperty(o),c)){if(c!=null&&(!d||d.validate!==!1)&&Xs(p,$.call(po,{key:`layers.${t}.layout.${o}`,layerType:p.type,objectKey:o,value:c,styleSpec:n.a5,style:{glyphs:!0,sprite:!0}})))return;p.setLayoutProperty(o,c),p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),this._updateLayer(p)}}getLayoutProperty(t,o){let c=this._checkLayer(t);if(c)return c.getLayoutProperty(o)}setPaintProperty(t,o,c,d={}){this._checkLoaded();let p=this._checkLayer(t);if(!p||n.bv(p.getPaintProperty(o),c)||c!=null&&(!d||d.validate!==!1)&&Xs(p,q.call(po,{key:`layers.${t}.paint.${o}`,layerType:p.type,objectKey:o,value:c,styleSpec:n.a5})))return;let _=p.setPaintProperty(o,c);p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),_&&this._updateLayer(p),this._changes.updatePaintProperties(p)}getPaintProperty(t,o){let c=this._checkLayer(t);if(c)return c.getPaintProperty(o)}setFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:b,importId:M}=t.target,C=this.getFragmentStyle(M),z=C.getFeaturesetLayers(b);for(let{source:P,sourceLayer:D}of z)C.setFeatureState({id:t.id,source:P,sourceLayer:D},o)}else if("layerId"in t.target){let{layerId:b}=t.target,M=this.getLayer(b);this.setFeatureState({id:t.id,source:M.source,sourceLayer:M.sourceLayer},o)}return}let c=t.source,d=t.sourceLayer,p=this._checkSource(c);if(!p)return;let _=p.type;if(_==="geojson"&&d)return void this.fire(new n.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(_==="vector"&&!d)return void this.fire(new n.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new n.z(new Error("The feature id parameter must be provided.")));let x=this.getOwnSourceCaches(c);for(let b of x)b.setFeatureState(d,t.id,o)}removeFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:b,importId:M}=t.target,C=this.getFragmentStyle(M),z=C.getFeaturesetLayers(b);for(let{source:P,sourceLayer:D}of z)C.removeFeatureState({id:t.id,source:P,sourceLayer:D},o)}else if("layerId"in t.target){let{layerId:b}=t.target,M=this.getLayer(b);this.removeFeatureState({id:t.id,source:M.source,sourceLayer:M.sourceLayer},o)}return}let c=t.source,d=this._checkSource(c);if(!d)return;let p=d.type,_=p==="vector"?t.sourceLayer:void 0;if(p==="vector"&&!_)return void this.fire(new n.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(o&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new n.z(new Error("A feature id is required to remove its specific state property.")));let x=this.getOwnSourceCaches(c);for(let b of x)b.removeFeatureState(_,t.id,o)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let p;if("featuresetId"in t.target){let{featuresetId:_,importId:x}=t.target,b=this.getFragmentStyle(x),M=b.getFeaturesetLayers(_);for(let{source:C,sourceLayer:z}of M){let P=b.getFeatureState({id:t.id,source:C,sourceLayer:z});if(P&&!p)p=P;else if(!n.bv(p,P))return void this.fire(new n.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){let{layerId:_}=t.target,x=this.getLayer(_);p=this.getFeatureState({id:t.id,source:x.source,sourceLayer:x.sourceLayer})}return p}let o=t.source,c=t.sourceLayer,d=this._checkSource(o);if(d){if(d.type!=="vector"||c)return t.id===void 0&&this.fire(new n.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(o)[0].getFeatureState(c,t.id);this.fire(new n.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=n.h({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return n.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();let t=this.getTerrain(),o=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return n.dp({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:o,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},c=>c!==void 0)}_updateFilteredLayers(t){for(let o of Object.values(this._mergedLayers))t(o)&&this._updateLayer(o)}_updateLayer(t){this._changes.updateLayer(t);let o=this.getLayerSourceCache(t),c=n.C(t.source,t.scope),d=this._changes.getUpdatedSourceCaches();t.source&&!d[c]&&o&&o.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),o.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){let o=x=>this._mergedLayers[x].is3D(!!this.terrain),c=this.order,d={},p=[];for(let x=c.length-1;x>=0;x--){let b=c[x];if(o(b)){d[b]=x;for(let M of t){let C=M[b];if(C)for(let z of C)p.push(z)}}}p.sort((x,b)=>b.intersectionZ-x.intersectionZ);let _=[];for(let x=c.length-1;x>=0;x--){let b=c[x];if(o(b))for(let M=p.length-1;M>=0;M--){let C=p[M].feature;if(C.layer&&d[C.layer.id]<x)break;_.push(C),p.pop()}else for(let M of t){let C=M[b];if(C)for(let z of C)_.push(z.feature)}}return _}queryRenderedFeatures(t,o,c){let d;o&&!Array.isArray(o)&&o.filter&&(this._validate(Re,"queryRenderedFeatures.filter",o.filter,null,o),d=n.b3(o.filter));let p={},_=C=>{if(kh.has(C.type))return;let z=this.getOwnLayerSourceCache(C),P=p[z.id]=p[z.id]||{sourceCache:z,layers:{},has3DLayers:!1};C.is3D(!!this.terrain)&&(P.has3DLayers=!0),P.layers[C.fqid]=P.layers[C.fqid]||{styleLayer:C,targets:[]},P.layers[C.fqid].targets.push({filter:d})};if(o&&o.layers){if(!Array.isArray(o.layers))return this.fire(new n.z(new Error("parameters.layers must be an Array."))),[];for(let C of o.layers){let z=this._layers[C];if(!z)return this.fire(new n.z(new Error(`The layer '${C}' does not exist in the map's style and cannot be queried for features.`))),[];_(z)}}else for(let C in this._layers)_(this._layers[C]);let x=this._queryRenderedFeatures(t,p,c),b=this._flattenAndSortRenderedFeatures(x),M=[];for(let C of b)n.dq(C.layer.id)===this.scope&&M.push(C);return M}queryRenderedFeatureset(t,o,c){let d;o&&!Array.isArray(o)&&o.filter&&(this._validate(Re,"queryRenderedFeatures.filter",o.filter,null,o),d=n.b3(o.filter));let p="mock",_=[];if(o&&o.target)_.push(Object.assign({},o,{targetId:p,filter:d}));else{let C=this.getFeaturesetDescriptors();for(let z of C)_.push({targetId:p,filter:d,target:z});for(let{style:z}of this.fragments){let P=z.getFeaturesetDescriptors();for(let D of P)_.push({targetId:p,filter:d,target:D})}}let x=this.queryRenderedTargets(t,_,c),b=[],M=new Set;for(let C of x)for(let z of C.variants[p])Ih(z,C,M)||b.push(new n.dr(C,z));return b}queryRenderedTargets(t,o,c){let d={},p=(x,b,M,C)=>{let z=d[b.id]=d[b.id]||{sourceCache:b,layers:{},has3DLayers:!1};if(z.layers[x.fqid]=z.layers[x.fqid]||{styleLayer:x,targets:[]},x.is3D(!!this.terrain)&&(z.has3DLayers=!0),!C)return M.uniqueFeatureID=!1,void z.layers[x.fqid].targets.push(M);z.layers[x.fqid].targets.push(Object.assign({},M,{namespace:C.namespace,properties:C.properties,uniqueFeatureID:C.uniqueFeatureID}))};for(let x of o)if("featuresetId"in x.target){let{featuresetId:b,importId:M}=x.target,C=this.getFragmentStyle(M);if(!C||!C._featuresetSelectors)continue;let z=C._featuresetSelectors[b];if(!z){this.fire(new n.z(new Error(`The featureset '${b}' does not exist in the map's style and cannot be queried for features.`)));continue}for(let P of z){let D=C.getOwnLayer(P.layerId);D&&!kh.has(D.type)&&p(D,C.getOwnLayerSourceCache(D),x,P)}}else if("layerId"in x.target){let{layerId:b}=x.target,M=this.getLayer(b);if(!M||kh.has(M.type))continue;p(M,this.getLayerSourceCache(M),x)}let _=this._queryRenderedFeatures(t,d,c);return this._flattenAndSortRenderedFeatures(_)}_queryRenderedFeatures(t,o,c){let d=[],p=!!this.map._showQueryGeometry,_=Pi.createFromScreenPoints(t,c);for(let x in o){let b=Ah(_,o[x],this._availableImages,c,p);Object.keys(b).length&&d.push(b)}if(this.placement)for(let x in o){if(!o[x].sourceCache._onlySymbols)continue;let b=ba(_.screenGeometry,o[x],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(b).length&&d.push(b)}return d}querySourceFeatures(t,o){let c=o&&o.filter;c&&this._validate(Re,"querySourceFeatures.filter",c,null,o);let d=[],p=this.getOwnSourceCaches(t);for(let _ of p)d=d.concat(mc(_,o));return d}addSourceType(t,o,c){return ko.getSourceType(t)?c(new Error(`A source type called "${t}" already exists.`)):(ko.setSourceType(t,o),o.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:o.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,o,c={}){this._checkLoaded();let d=this.light.getLight(),p=!1;for(let x in t)if(!n.bv(t[x],d[x])){p=!0;break}if(!p)return;let _=this._getTransitionParameters();this.light.setLight(t,o,c),this.light.updateTransitions(_)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=n.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&n.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,o=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),o===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t,d=t.source==null;if(o===1){if(this.disableElevatedTerrain)return;if(typeof c.source=="object"){let x="terrain-dem-src";this.addSource(x,c.source),c=n.di(c),c=n.h(c,{source:x})}let p=n.h({},c),_={};if(this.terrain&&d){p.source=this.terrain.get().source;let x=this.terrain?this.getFragmentStyle(this.terrain.scope):null;x&&(_.style=x.serialize())}if(this._validate(Qe,"terrain",p,_))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&o!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,o),this.fire(new n.A("data",{dataType:"style"}))}else{let p=this.terrain,_=p.get();for(let x of Object.keys(n.a5.terrain))!c.hasOwnProperty(x)&&n.a5.terrain[x].default&&(c[x]=n.a5.terrain[x].default);for(let x in t)if(!n.bv(t[x],_[x])){p.set(t,this.options),this.stylesheet.terrain=t;let b=this._getTransitionParameters({duration:0});p.updateTransitions(b),this.fire(new n.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){let o=this.fog=new si(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}_createSnow(t){let o=this.snow=new Qr(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}_createRain(t){let o=this.rain=new $r(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(let t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let o=this.fog;if(!n.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.fog=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){let o=this.snow;if(!n.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.snow=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){let o=this.rain;if(!n.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.rain=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){let t=()=>{for(let d in this._layers)this._layers[d].lut=this._styleColorTheme.lut;for(let d in this._sourceCaches)this._sourceCaches[d].clearTiles()},o=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!o)return this._styleColorTheme.lut=null,void t();let c=this._evaluateColorThemeData(o);this._loadColorTheme(c).then(()=>{this.fire(new n.A("colorthemeset")),t()}).catch(d=>{n.w(`Couldn't set color theme: ${d}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&n.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,o){let c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=o,c._reloadColorTheme())}_getTransitionParameters(t){return{now:n.q.now(),transition:n.h(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;let t=[],o=[];for(let c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):o.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...o)}_createTerrain(t,o){let c=this.terrain=new be(t,o,this.scope,this.options,this.map.getWorldview());o===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let d=this._getTransitionParameters({duration:0});c.updateTransitions(d)}_force3DLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="fill-extrusion"&&this._updateLayer(o)}}_forceSymbolLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="symbol"&&this._updateLayer(o)}}_validate(t,o,c,d,p={}){if(p&&p.validate===!1)return!1;let _=n.h({},this.serialize());return Xs(this,t.call(po,n.h({key:o,style:_,value:c,styleSpec:n.a5},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),n.ds.off("pluginStateChange",this._rtlTextPluginCallback);for(let t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){let o=this.getSourceCaches(t);for(let c of o)c.clearTiles()}clearSources(){for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(let t in this._mergedLayers){let o=this._mergedLayers[t];o._clear&&o._clear()}}reloadSource(t){let o=this.getSourceCaches(t);for(let c of o)c.resume(),c.reload()}reloadSources(){for(let t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let o;this.directionalLight&&(o=ul(this.directionalLight));let c=new Set;for(let d in this._mergedLayers){let p=this._mergedLayers[d];p.hasElevation()&&!c.has(p.source)&&c.add(p.source)}for(let d in this._mergedSourceCaches){let p=this._mergedSourceCaches[d],_=c.has(p._source.id);p.update(t,void 0,void 0,o,_)}}_generateCollisionBoxes(){for(let t in this._sourceCaches){let o=this._sourceCaches[t];o.resume(),o.reload()}}_updatePlacement(t,o,c,d,p,_,x=!1){let b=!1,M=!1,C={},z={};for(let P of this._mergedOrder){let D=this._mergedLayers[P];if(D.type!=="symbol")continue;let N=n.C(D.source,D.scope),F=C[N];if(!F){let U=this.getLayerSourceCache(D);if(!U)continue;let Z=U.getRenderableIds(!0).map(Y=>U.getTileByID(Y));z[N]=Z.slice(),F=C[N]=Z.sort((Y,Q)=>Q.tileID.overscaledZ-Y.tileID.overscaledZ||(Y.tileID.isLessThan(Q.tileID)?-1:1))}let j=this.crossTileSymbolIndex.addLayer(D,F,o.center.lng,o.projection);b=b||j}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),x=x||this._layerOrderChanged||d===0,this._layerOrderChanged&&this.fire(new n.A("neworder")),(x||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(n.q.now(),o.zoom))&&(this.pauseablePlacement=new zh(o,this._mergedOrder,x,c,d,p,this.placement,this.fog&&o.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,C,z,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(n.q.now()),M=!0),b&&this.pauseablePlacement.placement.setStale()),M||b){this._buildingIndex.onNewFrame(o.zoom);for(let P=0;P<this._mergedOrder.length;P++){let D=this._mergedLayers[this._mergedOrder[P]];if(D.type!=="symbol")continue;let N=this.isLayerClipped(D);this.placement.updateLayerOpacities(D,C[n.C(D.source,D.scope)],P,N?_:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(n.q.now())}}_releaseSymbolFadeTiles(){for(let t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,o){this._checkLoaded();let c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex(({id:p})=>p===t.id)!==-1)return void this.fire(new n.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!o)return c.push(t),this._loadImports([t],!0);let d=c.findIndex(({id:p})=>p===o);return d===-1&&this.fire(new n.z(new Error(`Import with id "${o}" does not exist on this map.`))),this.stylesheet.imports=c.slice(0,d).concat(t).concat(c.slice(d)),this._loadImports([t],!0,o)}updateImport(t,o){this._checkLoaded();let c=this.stylesheet.imports||[],d=this.getImportIndex(t);return d===-1?this:typeof o=="string"?(this.setImportUrl(t,o),this):(o.url&&o.url!==c[d].url&&this.setImportUrl(t,o.url),n.bv(o.config,c[d].config)||this.setImportConfig(t,o.config,o.data.schema),n.bv(o.data,c[d].data)||this.setImportData(t,o.data),this)}moveImport(t,o){this._checkLoaded();let c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;let p=this.getImportIndex(o);if(p===-1)return this;let _=c[d],x=this.fragments[d];return c=c.filter(({id:b})=>b!==t),this.fragments=this.fragments.filter(({id:b})=>b!==t),this.stylesheet.imports=c.slice(0,p).concat(_).concat(c.slice(p)),this.fragments=this.fragments.slice(0,p).concat(x).concat(this.fragments.slice(p)),this.mergeLayers(),this}setImportUrl(t,o){this._checkLoaded();let c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;c[d].url=o;let p=this.fragments[d];return p.style=this._createFragmentStyle(c[d]),p.style.on("style.import.load",()=>this.mergeAll()),p.style.loadURL(o),this}setImportData(t,o){this._checkLoaded();let c=this.getImportIndex(t),d=this.stylesheet.imports||[];return c===-1?this:o?(this.fragments[c].style.setState(o),this._reloadImports(),this):(delete d[c].data,this.setImportUrl(t,d[c].url))}setImportConfig(t,o,c){this._checkLoaded();let d=this.getImportIndex(t),p=this.stylesheet.imports||[];if(d===-1)return this;o?p[d].config=o:delete p[d].config;let _=this.fragments[d];c&&_.style.stylesheet&&(_.style.stylesheet.schema=c);let x=_.style.stylesheet&&_.style.stylesheet.schema;return _.config=o,_.style.updateConfig(o,x),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();let o=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(o.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){let o=(this.stylesheet.imports||[]).findIndex(c=>c.id===t);return o===-1&&this.fire(new n.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),o}getLayer(t){return this._mergedLayers[t]}getSources(){let t=[];for(let o in this._mergedOtherSourceCaches){let c=this._mergedOtherSourceCaches[o];c&&t.push(c.getSource())}return t}getSource(t,o){let c=this.getSourceCache(t,o);return c&&c.getSource()}getLayerSource(t){let o=this.getLayerSourceCache(t);return o&&o.getSource()}getSourceCache(t,o){let c=n.C(t,o);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){let o=n.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[o]:this._mergedOtherSourceCaches[o]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);let o=[];return this._mergedOtherSourceCaches[t]&&o.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&o.push(this._mergedSymbolSourceCaches[t]),o}updateSourceCaches(){let t=this._changes.getUpdatedSourceCaches();for(let o in t){let c=t[o];c==="reload"?this.reloadSource(o):c==="clear"&&this.clearSource(o)}}updateLayers(t){let o=this._changes.getUpdatedPaintProperties();for(let c of o){let d=this.getLayer(c);d&&d.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,o,c){this.imageManager.getImages(o.images,o.scope,c),this._updateTilesForChangedImages();let d=_=>{if(_){let x=o.images.map(b=>n.I.toString(b));_.setDependencies(o.tileID.key,o.type,x)}},p=n.C(o.source,o.scope);d(this._mergedOtherSourceCaches[p]),d(this._mergedSymbolSourceCaches[p]),o.images.some(_=>_.iconsetId)&&this.fire(new n.A("data",{dataType:"style"}))}rasterizeImages(t,o,c){this.imageManager.rasterizeImages(o,c)}getGlyphs(t,o,c){this.glyphManager.getGlyphs(o.stacks,c)}getResource(t,o,c){return n.dt(o,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){let o=[];return this._otherSourceCaches[t]&&o.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&o.push(this._symbolSourceCaches[t]),o}_isSourceCacheLoaded(t){let o=this.getOwnSourceCaches(t);return o.length===0?(this.fire(new n.z(new Error(`There is no source with ID '${t}'`))),!1):o.every(c=>c.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,o){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;let c=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),d=t.type==="building";if(t.is3D(!!this.terrain)){if(c||d||o&&o.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}ko.getSourceType=function(l){return Eh[l]},ko.setSourceType=function(l,t){Eh[l]=t},ko.registerForPluginStateChange=n.du;var vd=`
=======
        `)}let u=null,f=null;if(s!=="background"&&s!=="sky"&&s!=="slot"){f=Se[`filter_${s}`];let w=Da(h,f,e,i);if(w.result==="error")throw new Error(w.value.map(E=>`${E.key}: ${E.message}`).join(", "));u=(E,I,R)=>w.value.evaluate(E,I,{},R)}let g=null,y=null;if(h!==a){let w=Da(a,f,e,i);if(w.result==="error")throw new Error(w.value.map(E=>`${E.key}: ${E.message}`).join(", "));g=(E,I,R,L,k)=>w.value.evaluate(E,I,{},R,void 0,void 0,L,k),y=!fl(w.value.expression)}return{filter:u,dynamicFilter:g||void 0,needGeometry:tp(h),needFeature:!!y}}function ep(r){if(!Array.isArray(r))return r;let e=function(i){if(ls.has(i[0])){for(let s=1;s<i.length;s++)if(Tl(i[s]))return!0}return i}(r);return e===!0?e:e.map(i=>ep(i))}function du(r){let e=!1,i=[];if(r[0]==="case"){for(let s=1;s<r.length-1;s+=2)e=e||Tl(r[s]),i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="match"){e=e||Tl(r[1]);for(let s=2;s<r.length-1;s+=2)i.push(r[s+1]);i.push(r[r.length-1])}else if(r[0]==="step"){e=e||Tl(r[1]);for(let s=1;s<r.length-1;s+=2)i.push(r[s+1])}e&&(r.length=0,r.push("any",...i));for(let s=1;s<r.length;s++)du(r[s])}function Tl(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<r.length;i++)if(Tl(r[i]))return!0;return!1}let ls=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function zg(r,e){return r<e?-1:r>e?1:0}function tp(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(tp(r[e]))return!0;return!1}function pu(r){if(!r)return!0;let e=r[0];return r.length<=1?e!=="any":e==="=="?ip(r[1],r[2],"=="):e==="!="?fu(ip(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?ip(r[1],r[2],e):e==="any"?(i=r.slice(1),["any"].concat(i.map(pu))):e==="all"?["all"].concat(r.slice(1).map(pu)):e==="none"?["all"].concat(r.slice(1).map(pu).map(fu)):e==="in"?xm(r[1],r.slice(2)):e==="!in"?fu(xm(r[1],r.slice(2))):e==="has"?vm(r[1]):e!=="!has"||fu(vm(r[1]));var i}function ip(r,e,i){switch(r){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,r,e]}}function xm(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",r,["literal",e.sort(zg)]]:["filter-in-small",r,["literal",e]]}}function vm(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function fu(r){return["!",r]}let Hc="";function Sl(r,e){return e?`${r}${Hc}${e}`:r}let bm="-transition",Dg=new Set(["fill","line","background","hillshade","raster"]);class Mn extends Ea{constructor(e,i,s,a,h){if(super(),this.id=e.id,this.fqid=Sl(this.id,s),this.type=e.type,this.scope=s,this.lut=a,this.options=h,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;let u=Da(this.filter,Se[`filter_${e.type}`]);u.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...u.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new na(i.layout,this.scope,h),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new jc(i.paint,this.scope,h);for(let u in e.paint)this.setPaintProperty(u,e.paint[u]);for(let u in e.layout)this.setLayoutProperty(u,e.layout[u]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ko(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Dg.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);let s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(bm)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){let s=this._transitionablePaint,a=s._properties.properties;if(e.endsWith(bm)){let E=e.slice(0,-11);return a[E]&&s.setTransition(E,i||void 0),!1}if(!a[e])return!1;let h=s._values[e],u=h.value.isDataDriven(),f=h.value;s.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);let g=s._values[e].value,y=g.isDataDriven(),w=e.endsWith("pattern")||e==="line-dasharray";return y||u||w||this._handleOverridablePaintPropertyUpdate(e,f,g)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,s){return null}_handleOverridablePaintPropertyUpdate(e,i,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return ui({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,i)=>!(e===void 0||i==="layout"&&!Object.keys(e).length||i==="paint"&&!Object.keys(e).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(let e in this.paint._values){let i=this.paint.get(e);if(i instanceof ka&&ru(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=wl(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,s,a,h,u,f,g,y){}}let Og={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class $c{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class sr{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){let i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function gi(r,e=1){let i=0,s=0;return{members:r.map(a=>{let h=Og[a.type].BYTES_PER_ELEMENT,u=i=rp(i,Math.max(e,h)),f=a.components||1;return s=Math.max(s,h),i+=h*f,{name:a.name,type:a.type,components:f,offset:u}}),size:rp(i,Math.max(s,e)),alignment:e}}function rp(r,e){return Math.ceil(r/e)*e}class $n extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){let s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){let a=2*e;return this.int16[a+0]=i,this.int16[a+1]=s,e}}$n.prototype.bytesPerElement=4,Tt($n,"StructArrayLayout2i4");class El extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=3*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.int16[h+2]=a,e}}El.prototype.bytesPerElement=6,Tt(El,"StructArrayLayout3i6");class Il extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){let h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a)}emplace(e,i,s,a,h){let u=4*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=a,this.int16[u+3]=h,e}}Il.prototype.bytesPerElement=8,Tt(Il,"StructArrayLayout4i8");class Fa extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}Fa.prototype.bytesPerElement=4,Tt(Fa,"StructArrayLayout1f4");class np extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=4*e,u=2*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.float32[u+1]=a,e}}np.prototype.bytesPerElement=8,Tt(np,"StructArrayLayout2i1f8");class op extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=4*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.int16[h+2]=a,e}}op.prototype.bytesPerElement=8,Tt(op,"StructArrayLayout3i8");class mu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h){let u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a,h)}emplace(e,i,s,a,h,u){let f=5*e;return this.int16[f+0]=i,this.int16[f+1]=s,this.int16[f+2]=a,this.int16[f+3]=h,this.int16[f+4]=u,e}}mu.prototype.bytesPerElement=10,Tt(mu,"StructArrayLayout5i10");class _u extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f){let g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,h,u,f)}emplace(e,i,s,a,h,u,f,g){let y=6*e,w=12*e,E=3*e;return this.int16[y+0]=i,this.int16[y+1]=s,this.uint8[w+4]=a,this.uint8[w+5]=h,this.uint8[w+6]=u,this.uint8[w+7]=f,this.float32[E+2]=g,e}}_u.prototype.bytesPerElement=12,Tt(_u,"StructArrayLayout2i4ub1f12");class yo extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=3*e;return this.float32[h+0]=i,this.float32[h+1]=s,this.float32[h+2]=a,e}}yo.prototype.bytesPerElement=12,Tt(yo,"StructArrayLayout3f12");class oa extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h){let u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a,h)}emplace(e,i,s,a,h,u){let f=6*e,g=3*e;return this.uint16[f+0]=i,this.uint16[f+1]=s,this.uint16[f+2]=a,this.uint16[f+3]=h,this.float32[g+2]=u,e}}oa.prototype.bytesPerElement=12,Tt(oa,"StructArrayLayout4ui1f12");class Al extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){let h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a)}emplace(e,i,s,a,h){let u=4*e;return this.uint16[u+0]=i,this.uint16[u+1]=s,this.uint16[u+2]=a,this.uint16[u+3]=h,e}}Al.prototype.bytesPerElement=8,Tt(Al,"StructArrayLayout4ui8");class gu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u){let f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,h,u)}emplace(e,i,s,a,h,u,f){let g=6*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.int16[g+2]=a,this.int16[g+3]=h,this.int16[g+4]=u,this.int16[g+5]=f,e}}gu.prototype.bytesPerElement=12,Tt(gu,"StructArrayLayout6i12");class yu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,w,E,I){let R=this.length;return this.resize(R+1),this.emplace(R,e,i,s,a,h,u,f,g,y,w,E,I)}emplace(e,i,s,a,h,u,f,g,y,w,E,I,R){let L=12*e;return this.int16[L+0]=i,this.int16[L+1]=s,this.int16[L+2]=a,this.int16[L+3]=h,this.uint16[L+4]=u,this.uint16[L+5]=f,this.uint16[L+6]=g,this.uint16[L+7]=y,this.int16[L+8]=w,this.int16[L+9]=E,this.int16[L+10]=I,this.int16[L+11]=R,e}}yu.prototype.bytesPerElement=24,Tt(yu,"StructArrayLayout4i4ui4i24");class Ml extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u){let f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,h,u)}emplace(e,i,s,a,h,u,f){let g=10*e,y=5*e;return this.int16[g+0]=i,this.int16[g+1]=s,this.int16[g+2]=a,this.float32[y+2]=h,this.float32[y+3]=u,this.float32[y+4]=f,e}}Ml.prototype.bytesPerElement=20,Tt(Ml,"StructArrayLayout3i3f20");class sa extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a){let h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a)}emplace(e,i,s,a,h){let u=4*e;return this.float32[u+0]=i,this.float32[u+1]=s,this.float32[u+2]=a,this.float32[u+3]=h,e}}sa.prototype.bytesPerElement=16,Tt(sa,"StructArrayLayout4f16");class sp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}sp.prototype.bytesPerElement=4,Tt(sp,"StructArrayLayout1ul4");class cs extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){let s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){let a=2*e;return this.uint16[a+0]=i,this.uint16[a+1]=s,e}}cs.prototype.bytesPerElement=4,Tt(cs,"StructArrayLayout2ui4");class ap extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,w,E,I,R){let L=this.length;return this.resize(L+1),this.emplace(L,e,i,s,a,h,u,f,g,y,w,E,I,R)}emplace(e,i,s,a,h,u,f,g,y,w,E,I,R,L){let k=20*e,B=10*e;return this.int16[k+0]=i,this.int16[k+1]=s,this.int16[k+2]=a,this.int16[k+3]=h,this.int16[k+4]=u,this.float32[B+3]=f,this.float32[B+4]=g,this.float32[B+5]=y,this.float32[B+6]=w,this.int16[k+14]=E,this.uint32[B+8]=I,this.uint16[k+18]=R,this.uint16[k+19]=L,e}}ap.prototype.bytesPerElement=40,Tt(ap,"StructArrayLayout5i4f1i1ul2ui40");class xu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f){let g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,h,u,f)}emplace(e,i,s,a,h,u,f,g){let y=8*e;return this.int16[y+0]=i,this.int16[y+1]=s,this.int16[y+2]=a,this.int16[y+4]=h,this.int16[y+5]=u,this.int16[y+6]=f,this.int16[y+7]=g,e}}xu.prototype.bytesPerElement=16,Tt(xu,"StructArrayLayout3i2i2i16");class Cl extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h){let u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a,h)}emplace(e,i,s,a,h,u){let f=4*e,g=8*e;return this.float32[f+0]=i,this.float32[f+1]=s,this.float32[f+2]=a,this.int16[g+6]=h,this.int16[g+7]=u,e}}Cl.prototype.bytesPerElement=16,Tt(Cl,"StructArrayLayout2f1f2i16");class Pl extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u){let f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,h,u)}emplace(e,i,s,a,h,u,f){let g=20*e,y=5*e;return this.uint8[g+0]=i,this.uint8[g+1]=s,this.float32[y+1]=a,this.float32[y+2]=h,this.float32[y+3]=u,this.float32[y+4]=f,e}}Pl.prototype.bytesPerElement=20,Tt(Pl,"StructArrayLayout2ub4f20");class ur extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s){let a=this.length;return this.resize(a+1),this.emplace(a,e,i,s)}emplace(e,i,s,a){let h=3*e;return this.uint16[h+0]=i,this.uint16[h+1]=s,this.uint16[h+2]=a,e}}ur.prototype.bytesPerElement=6,Tt(ur,"StructArrayLayout3ui6");class Rl extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G,X,W,K,pe){let ce=this.length;return this.resize(ce+1),this.emplace(ce,e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G,X,W,K,pe)}emplace(e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G,X,W,K,pe,ce){let ue=30*e,ge=15*e,ve=60*e;return this.int16[ue+0]=i,this.int16[ue+1]=s,this.int16[ue+2]=a,this.float32[ge+2]=h,this.float32[ge+3]=u,this.uint16[ue+8]=f,this.uint16[ue+9]=g,this.uint32[ge+5]=y,this.uint32[ge+6]=w,this.uint32[ge+7]=E,this.uint16[ue+16]=I,this.uint16[ue+17]=R,this.uint16[ue+18]=L,this.float32[ge+10]=k,this.float32[ge+11]=B,this.uint8[ve+48]=G,this.uint8[ve+49]=X,this.uint8[ve+50]=W,this.uint32[ge+13]=K,this.int16[ue+28]=pe,this.uint8[ve+58]=ce,e}}Rl.prototype.bytesPerElement=60,Tt(Rl,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class lp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G,X,W,K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe,Ke,it,Fe){let Je=this.length;return this.resize(Je+1),this.emplace(Je,e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G,X,W,K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe,Ke,it,Fe)}emplace(e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G,X,W,K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe,Ke,it,Fe,Je){let Ie=20*e,Be=40*e,at=80*e;return this.float32[Ie+0]=i,this.float32[Ie+1]=s,this.int16[Be+4]=a,this.int16[Be+5]=h,this.int16[Be+6]=u,this.int16[Be+7]=f,this.int16[Be+8]=g,this.int16[Be+9]=y,this.int16[Be+10]=w,this.int16[Be+11]=E,this.int16[Be+12]=I,this.uint16[Be+13]=R,this.uint16[Be+14]=L,this.uint16[Be+15]=k,this.uint16[Be+16]=B,this.uint16[Be+17]=G,this.uint16[Be+18]=X,this.uint16[Be+19]=W,this.uint16[Be+20]=K,this.uint16[Be+21]=pe,this.uint16[Be+22]=ce,this.uint16[Be+23]=ue,this.uint16[Be+24]=ge,this.uint16[Be+25]=ve,this.uint16[Be+26]=Ne,this.uint16[Be+27]=Ee,this.uint32[Ie+14]=Ue,this.float32[Ie+15]=nt,this.float32[Ie+16]=qe,this.float32[Ie+17]=Ke,this.float32[Ie+18]=it,this.uint8[at+76]=Fe,this.uint16[Be+39]=Je,e}}lp.prototype.bytesPerElement=80,Tt(lp,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class cp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u){let f=this.length;return this.resize(f+1),this.emplace(f,e,i,s,a,h,u)}emplace(e,i,s,a,h,u,f){let g=6*e;return this.float32[g+0]=i,this.float32[g+1]=s,this.float32[g+2]=a,this.float32[g+3]=h,this.float32[g+4]=u,this.float32[g+5]=f,e}}cp.prototype.bytesPerElement=24,Tt(cp,"StructArrayLayout6f24");class Ba extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h){let u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,a,h)}emplace(e,i,s,a,h,u){let f=5*e;return this.float32[f+0]=i,this.float32[f+1]=s,this.float32[f+2]=a,this.float32[f+3]=h,this.float32[f+4]=u,e}}Ba.prototype.bytesPerElement=20,Tt(Ba,"StructArrayLayout5f20");class hp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f){let g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,h,u,f)}emplace(e,i,s,a,h,u,f,g){let y=7*e;return this.float32[y+0]=i,this.float32[y+1]=s,this.float32[y+2]=a,this.float32[y+3]=h,this.float32[y+4]=u,this.float32[y+5]=f,this.float32[y+6]=g,e}}hp.prototype.bytesPerElement=28,Tt(hp,"StructArrayLayout7f28");class Zc extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,w,E){let I=this.length;return this.resize(I+1),this.emplace(I,e,i,s,a,h,u,f,g,y,w,E)}emplace(e,i,s,a,h,u,f,g,y,w,E,I){let R=11*e;return this.float32[R+0]=i,this.float32[R+1]=s,this.float32[R+2]=a,this.float32[R+3]=h,this.float32[R+4]=u,this.float32[R+5]=f,this.float32[R+6]=g,this.float32[R+7]=y,this.float32[R+8]=w,this.float32[R+9]=E,this.float32[R+10]=I,e}}Zc.prototype.bytesPerElement=44,Tt(Zc,"StructArrayLayout11f44");class up extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y){let w=this.length;return this.resize(w+1),this.emplace(w,e,i,s,a,h,u,f,g,y)}emplace(e,i,s,a,h,u,f,g,y,w){let E=9*e;return this.float32[E+0]=i,this.float32[E+1]=s,this.float32[E+2]=a,this.float32[E+3]=h,this.float32[E+4]=u,this.float32[E+5]=f,this.float32[E+6]=g,this.float32[E+7]=y,this.float32[E+8]=w,e}}up.prototype.bytesPerElement=36,Tt(up,"StructArrayLayout9f36");class aa extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){let s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){let a=2*e;return this.float32[a+0]=i,this.float32[a+1]=s,e}}aa.prototype.bytesPerElement=8,Tt(aa,"StructArrayLayout2f8");class dp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,a){let h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,a)}emplace(e,i,s,a,h){let u=6*e;return this.uint32[3*e+0]=i,this.uint16[u+2]=s,this.uint16[u+3]=a,this.uint16[u+4]=h,e}}dp.prototype.bytesPerElement=12,Tt(dp,"StructArrayLayout1ul3ui12");class pp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}pp.prototype.bytesPerElement=2,Tt(pp,"StructArrayLayout1ui2");class vu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B){let G=this.length;return this.resize(G+1),this.emplace(G,e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B)}emplace(e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G){let X=16*e;return this.float32[X+0]=i,this.float32[X+1]=s,this.float32[X+2]=a,this.float32[X+3]=h,this.float32[X+4]=u,this.float32[X+5]=f,this.float32[X+6]=g,this.float32[X+7]=y,this.float32[X+8]=w,this.float32[X+9]=E,this.float32[X+10]=I,this.float32[X+11]=R,this.float32[X+12]=L,this.float32[X+13]=k,this.float32[X+14]=B,this.float32[X+15]=G,e}}vu.prototype.bytesPerElement=64,Tt(vu,"StructArrayLayout16f64");class Ll extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,a,h,u,f){let g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,a,h,u,f)}emplace(e,i,s,a,h,u,f,g){let y=10*e,w=5*e;return this.uint16[y+0]=i,this.uint16[y+1]=s,this.uint16[y+2]=a,this.uint16[y+3]=h,this.float32[w+2]=u,this.float32[w+3]=f,this.float32[w+4]=g,e}}Ll.prototype.bytesPerElement=20,Tt(Ll,"StructArrayLayout4ui3f20");class fp extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}fp.prototype.bytesPerElement=2,Tt(fp,"StructArrayLayout1i2");class bu extends sr{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){let i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}bu.prototype.bytesPerElement=1,Tt(bu,"StructArrayLayout1ub1");class mp extends $c{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}mp.prototype.size=40;class wm extends ap{get(e){return new mp(this,e)}}Tt(wm,"CollisionBoxArray");class wu extends $c{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}wu.prototype.size=60;class Wc extends Rl{get(e){return new wu(this,e)}}Tt(Wc,"PlacedSymbolArray");class _p extends $c{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}_p.prototype.size=80;class Tm extends lp{get(e){return new _p(this,e)}}Tt(Tm,"SymbolInstanceArray");class gp extends Fa{getoffsetX(e){return this.float32[1*e+0]}}Tt(gp,"GlyphOffsetArray");class Sm extends $n{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Tt(Sm,"SymbolLineVertexArray");class Tu extends $c{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Tu.prototype.size=12;class Em extends dp{get(e){return new Tu(this,e)}}Tt(Em,"FeatureIndexArray");class Im extends cs{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Tt(Im,"FillExtrusionCentroidArray");class Am extends $c{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Am.prototype.size=6;class Mm extends El{get(e){return new Am(this,e)}}Tt(Mm,"FillExtrusionWallArray");let Cm=gi([{name:"a_pos",components:2,type:"Int16"}],4),kg=gi([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),Fg=gi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class gr{constructor(e=[]){this.segments=e}_prepareSegment(e,i,s,a){let h=this.segments[this.segments.length-1];return e>gr.MAX_VERTEX_ARRAY_LENGTH&&pi(`Max vertices per segment is ${gr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!h||h.vertexLength+e>gr.MAX_VERTEX_ARRAY_LENGTH||h.sortKey!==a)&&(h={vertexOffset:i,primitiveOffset:s,vertexLength:0,primitiveLength:0},a!==void 0&&(h.sortKey=a),this.segments.push(h)),h}prepareSegment(e,i,s,a){return this._prepareSegment(e,i.length,s.length,a)}get(){return this.segments}destroy(){for(let e of this.segments)for(let i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,s,a){return new gr([{vertexOffset:e,primitiveOffset:i,vertexLength:s,primitiveLength:a,vaos:{},sortKey:0}])}}function Pm(r,e){return 256*(r=re(Math.floor(r),0,255))+re(Math.floor(e),0,255)}gr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Tt(gr,"SegmentVector");let Bg=gi([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),yp=gi([{name:"a_pattern_b",components:4,type:"Uint16"}]),Ng=gi([{name:"a_dash",components:4,type:"Uint16"}]);class Xc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,s,a){this.ids.push(Yc(e)),this.positions.push(i,s,a)}eachPosition(e,i){let s=Yc(e),a=0,h=this.ids.length-1;for(;a<h;){let u=a+h>>1;this.ids[u]>=s?h=u:a=u+1}for(;this.ids[a]===s;)i(this.positions[3*a],this.positions[3*a+1],this.positions[3*a+2]),a++}static serialize(e,i){let s=new Float64Array(e.ids),a=new Uint32Array(e.positions);return xp(s,a,0,s.length-1),i&&(i.add(s.buffer),i.add(a.buffer)),{ids:s,positions:a}}static deserialize(e){let i=new Xc,s;i.ids=e.ids,i.positions=e.positions;for(let a of i.ids)a!==s&&i.uniqueIds.push(a),s=a;return i.indexed=!0,i}}function Yc(r){let e=+r;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:nl(String(r))}function xp(r,e,i,s){for(;i<s;){let a=r[i+s>>1],h=i-1,u=s+1;for(;;){do h++;while(r[h]<a);do u--;while(r[u]>a);if(h>=u)break;Su(r,h,u),Su(e,3*h,3*u),Su(e,3*h+1,3*u+1),Su(e,3*h+2,3*u+2)}u-i<s-u?(xp(r,e,i,u),i=u+1):(xp(r,e,u+1,s),s=u)}}function Su(r,e,i){let s=r[e];r[e]=r[i],r[i]=s}Tt(Xc,"FeaturePositionMap");class Bo{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Eu extends Bo{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class Or extends Bo{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class hs extends Bo{constructor(e){super(e),this.current=[0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class zl extends Bo{constructor(e){super(e),this.current=[0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class Kc extends Bo{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class vp extends Bo{constructor(e){super(e),this.current=ki.transparent.toPremultipliedRenderColor(null)}set(e,i,s){this.fetchUniformLocation(e,i)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}let Rm=new Float32Array(16);class Jc extends Bo{constructor(e){super(e),this.current=Rm}set(e,i,s){if(this.fetchUniformLocation(e,i)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let a=1;a<16;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}let Vg=new Float32Array(9),Lm=new Float32Array(4);class bp extends Bo{constructor(e){super(e),this.current=Lm}set(e,i,s){if(this.fetchUniformLocation(e,i)){for(let a=0;a<4;a++)if(s[a]!==this.current[a]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function wp(r){return[Pm(255*r.r,255*r.g),Pm(255*r.b,255*r.a)]}class Qc{constructor(e,i,s,a){this.value=e,this.uniformNames=i.map(h=>`u_${h}`),this.type=s,this.context=a}setUniform(e,i,s,a,h){let u=a.constantOr(this.value);i.set(e,h,u instanceof ki?u.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):u)}getBinding(e,i){return this.type==="color"?new vp(e):new Or(e)}}class Dl{constructor(e,i){this.uniformNames=i.map(s=>`u_${s}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,s,a,h){let u=null;h!=="u_pattern"&&h!=="u_dash"||(u=this.pattern),h==="u_pattern_b"&&(u=this.patternTransition),h==="u_pixel_ratio"&&(u=this.pixelRatio),u&&i.set(e,h,u)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new Kc(e):new Or(e)}}class Rs{constructor(e,i,s,a){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=i.map(h=>({name:`a_${h}`,type:"Float32",components:s==="color"?2:1,offset:0})),this.paintVertexArray=new a}populatePaintArray(e,i,s,a,h,u,f,g){let y=this.paintVertexArray.length,w=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new ji(0,{brightness:u,worldview:g}),i,{},h,a,f):this.expression.kind==="constant"&&this.expression.value,E=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ji(0,{brightness:u,worldview:g}),i,{},h,a,f):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(y,e,w,E?null:this.context.lut)}updatePaintArray(e,i,s,a,h,u,f,g){let y=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:f,worldview:g},s,a,void 0,h):this.expression.kind==="constant"&&this.expression.value,w=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ji(0,{brightness:f,worldview:g}),s,a,void 0,h):this.lutExpression.value)==="none";this._setPaintValue(e,i,y,w?null:this.context.lut)}_setPaintValue(e,i,s,a){if(this.type==="color"){let h=wp(s.toPremultipliedRenderColor(a));for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,h[0],h[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class No{constructor(e,i,s,a,h,u){this.expression=e,this.uniformNames=i.map(f=>`u_${f}_t`),this.type=s,this.useIntegerZoom=a,this.context=h,this.maxValue=0,this.paintVertexAttributes=i.map(f=>({name:`a_${f}`,type:"Float32",components:s==="color"?4:2,offset:0})),this.paintVertexArray=new u}populatePaintArray(e,i,s,a,h,u,f,g){let y=this.expression.evaluate(new ji(this.context.zoom,{brightness:u,worldview:g}),i,{},h,a,f),w=this.expression.evaluate(new ji(this.context.zoom+1,{brightness:u,worldview:g}),i,{},h,a,f),E=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ji(0,{brightness:u,worldview:g}),i,{},h,a,f):this.lutExpression.value)==="none",I=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(I,e,y,w,E?null:this.context.lut)}updatePaintArray(e,i,s,a,h,u,f,g){let y=this.expression.evaluate({zoom:this.context.zoom,brightness:f,worldview:g},s,a,void 0,h),w=this.expression.evaluate({zoom:this.context.zoom+1,brightness:f,worldview:g},s,a,void 0,h),E=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new ji(0,{brightness:f,worldview:g}),s,a,void 0,h):this.lutExpression.value)==="none";this._setPaintValue(e,i,y,w,E?null:this.context.lut)}_setPaintValue(e,i,s,a,h){if(this.type==="color"){let u=wp(s.toPremultipliedRenderColor(h)),f=wp(s.toPremultipliedRenderColor(h));for(let g=e;g<i;g++)this.paintVertexArray.emplace(g,u[0],u[1],f[0],f[1])}else{for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,s,a);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,s,a,h){let u=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,f=re(this.expression.interpolationFactor(u,this.context.zoom,this.context.zoom+1),0,1);i.set(e,h,f)}getBinding(e,i){return new Or(e)}}class xo{constructor(e,i,s,a,h){this.expression=e,this.layerId=h,this.paintVertexAttributes=(s==="array"?Ng:Bg).members;for(let u=0;u<i.length;++u);this.paintVertexArray=new a,this.paintTransitionVertexArray=new Al}populatePaintArray(e,i,s,a){let h=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(h,e,i.patterns&&i.patterns[this.layerId],s)}updatePaintArray(e,i,s,a,h,u,f){this._setPaintValues(e,i,s.patterns&&s.patterns[this.layerId],u)}_setPaintValues(e,i,s,a){if(!a||!s)return;let h=a[s[0]],u=a[s[1]];if(h){if(h){let{tl:f,br:g,pixelRatio:y}=h;for(let w=e;w<i;w++)this.paintVertexArray.emplace(w,f[0],f[1],g[0],g[1],y)}if(u){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);let{tl:f,br:g}=u;for(let y=e;y<i;y++)this.paintTransitionVertexArray.emplace(y,f[0],f[1],g[0],g[1])}}}upload(e){let i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,yp.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class On{constructor(e,i,s=()=>!0){this.binders={},this._buffers=[],this.context=i;let a=[];for(let h in e.paint._values){let u=e.paint.get(h);if(h.endsWith("-use-theme")||!s(h)||!(u instanceof ka&&ru(u.property.specification)))continue;let f=jg(h,e.type),g=u.value,y=u.property.specification.type,w=!!u.property.useIntegerZoom,E=h==="line-dasharray"||h.endsWith("pattern"),I=e.paint.get(`${h}-use-theme`),R=h==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||I&&I.value.kind!=="constant";if(g.kind!=="constant"||R)if(g.kind==="source"||R||E){let L=zm(h,y,"source");this.binders[h]=E?new xo(g,f,y,L,e.id):new Rs(g,f,y,L),a.push(`/a_${h}`)}else{let L=zm(h,y,"composite");this.binders[h]=new No(g,f,y,w,i,L),a.push(`/z_${h}`)}else this.binders[h]=E?new Dl(g.value,f):new Qc(g.value,f,y,i),a.push(`/u_${h}`);I&&(this.binders[h].lutExpression=I.value)}this.cacheKey=a.sort().join("")}getMaxValue(e){let i=this.binders[e];return i instanceof Rs||i instanceof No?i.maxValue:0}populatePaintArrays(e,i,s,a,h,u,f,g){for(let y in this.binders){let w=this.binders[y];w.context=this.context,(w instanceof Rs||w instanceof No||w instanceof xo)&&w.populatePaintArray(e,i,s,a,h,u,f,g)}}setConstantPatternPositions(e,i){for(let s in this.binders){let a=this.binders[s];a instanceof Dl&&a.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){let i=this.binders[e];return i instanceof xo?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,s,a,h,u,f,g,y,w){let E=!1,I=Object.keys(e),R=I.length!==0&&!g,L=R?I:i.uniqueIds;this.context.lut=h.lut;for(let k in this.binders){let B=this.binders[k];if(B.context=this.context,(B instanceof Rs||B instanceof No||B instanceof xo)&&B.expression&&B.expression.kind&&B.expression.kind!=="constant"&&(B.expression.isStateDependent===!0||B.expression.isLightConstant===!1)){let G=h.paint.get(k);B.expression=G.value;for(let X of L){let W=e[X.toString()];i.eachPosition(X,(K,pe,ce)=>{let ue=a.feature(K);B.updatePaintArray(pe,ce,ue,W,u,f,y,w)})}if(!R)for(let X of s.uniqueIds){let W=e[X.toString()];s.eachPosition(X,(K,pe,ce)=>{let ue=a.feature(K);B.updatePaintArray(pe,ce,ue,W,u,f,y,w)})}E=!0}}return E}defines(){let e=[];for(let i in this.binders){let s=this.binders[i];(s instanceof Qc||s instanceof Dl)&&e.push(...s.uniformNames.map(a=>`#define HAS_UNIFORM_${a}`))}return e}getBinderAttributes(){let e=[];for(let i in this.binders){let s=this.binders[i];if(s instanceof Rs||s instanceof No||s instanceof xo)for(let a=0;a<s.paintVertexAttributes.length;a++)e.push(s.paintVertexAttributes[a].name);if(s instanceof xo)for(let a=0;a<yp.members.length;a++)e.push(yp.members[a].name)}return e}getBinderUniforms(){let e=[];for(let i in this.binders){let s=this.binders[i];if(s instanceof Qc||s instanceof Dl||s instanceof No)for(let a of s.uniformNames)e.push(a)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){let i=[];for(let s in this.binders){let a=this.binders[s];if(a instanceof Qc||a instanceof Dl||a instanceof No)for(let h of a.uniformNames)i.push({name:h,property:s,binding:a.getBinding(e,h)})}return i}setUniforms(e,i,s,a,h){for(let{name:u,property:f,binding:g}of s)this.binders[f].setUniform(e,g,h,a.get(f),u)}updatePaintBuffers(){this._buffers=[];for(let e in this.binders){let i=this.binders[e];(i instanceof Rs||i instanceof No||i instanceof xo)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof xo&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(let i in this.binders){let s=this.binders[i];(s instanceof Rs||s instanceof No||s instanceof xo)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(let e in this.binders){let i=this.binders[e];(i instanceof Rs||i instanceof No||i instanceof xo)&&i.destroy()}}}class vo{constructor(e,i,s=()=>!0){this.programConfigurations={};for(let a of e)this.programConfigurations[a.id]=new On(a,i,s);this.needsUpload=!1,this._featureMap=new Xc,this._featureMapWithoutIds=new Xc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,s,a,h,u,f,g,y){for(let w in this.programConfigurations)this.programConfigurations[w].populatePaintArrays(e,i,a,h,u,f,g,y);i.id!==void 0?this._featureMap.add(i.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,s,a,h,u,f,g){for(let y of s)this.needsUpload=this.programConfigurations[y.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,y,a,h,u,f||0,g)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(let i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(let e in this.programConfigurations)this.programConfigurations[e].destroy()}}let Ug={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function jg(r,e){return Ug[r]||[r.replace(`${e}-`,"").replace(/-/g,"_")]}let Gg={"line-pattern":{source:oa,composite:oa},"fill-pattern":{source:oa,composite:oa},"fill-extrusion-pattern":{source:oa,composite:oa},"line-dasharray":{source:Al,composite:Al}},qg={color:{source:aa,composite:sa},number:{source:Fa,composite:aa}};function zm(r,e,i){let s=Gg[r];return s&&s[i]||qg[e][i]}Tt(Qc,"ConstantBinder"),Tt(Dl,"PatternConstantBinder"),Tt(Rs,"SourceExpressionBinder"),Tt(xo,"PatternCompositeBinder"),Tt(No,"CompositeExpressionBinder"),Tt(On,"ProgramConfiguration",{omit:["_buffers"]}),Tt(vo,"ProgramConfigurationSet");let Cn=ht/Math.PI/2,Dm=5,l=6,t=16383,o=64,c=[o,32,16],d=-Cn,p=Cn;function _(r,e,i,s=Cn){return i=Ai(i),[r*Math.sin(i)*s,-e*s,r*Math.cos(i)*s]}function x(r,e,i){return _(Math.cos(Ai(r)),Math.sin(Ai(r)),e,i)}let b=63710088e-1,M=2*Math.PI*b;class C{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new C(De(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){let i=Math.PI/180,s=this.lat*i,a=e.lat*i,h=Math.sin(s)*Math.sin(a)+Math.cos(s)*Math.cos(a)*Math.cos((e.lng-this.lng)*i);return b*Math.acos(Math.min(h,1))}toBounds(e=0){let i=360*e/40075017,s=i/Math.cos(Math.PI/180*this.lat);return new z({lng:this.lng-s,lat:this.lat-i},{lng:this.lng+s,lat:this.lat+i})}toEcef(e){return x(this.lat,this.lng,Cn+e*Cn/b)}static convert(e){if(e instanceof C)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new C(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new C(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class z{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(e.length===4){let s=e;this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]])}else{let s=e;this.setSouthWest(s[0]).setNorthEast(s[1])}}setNorthEast(e){return this._ne=e instanceof C?new C(e.lng,e.lat):C.convert(e),this}setSouthWest(e){return this._sw=e instanceof C?new C(e.lng,e.lat):C.convert(e),this}extend(e){let i=this._sw,s=this._ne,a,h;if(e instanceof C)a=e,h=e;else{if(!(e instanceof z))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(z.convert(e)):this.extend(C.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(C.convert(e)):this;if(a=e._sw,h=e._ne,!a||!h)return this}return i||s?(i.lng=Math.min(a.lng,i.lng),i.lat=Math.min(a.lat,i.lat),s.lng=Math.max(h.lng,s.lng),s.lat=Math.max(h.lat,s.lat)):(this._sw=new C(a.lng,a.lat),this._ne=new C(h.lng,h.lat)),this}getCenter(){return new C((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new C(this.getWest(),this.getNorth())}getSouthEast(){return new C(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){let{lng:i,lat:s}=C.convert(e),a=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(a=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&a}static convert(e){if(e)return e instanceof z?e:new z(e)}}let P=0,D=25.5;function N(r){return M*Math.cos(r*Math.PI/180)}function F(r){return(180+r)/360}function j(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function U(r,e){return r/N(e)}function Z(r){return 360*r-180}function Y(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Q(r,e){return r*N(Y(e))}let ne=85.051129;function he(r){return Math.cos(Ai(re(r,-ne,ne)))}function de(r,e){let i=re(e,P,D),s=Math.pow(2,i);return he(r)*M/(512*s)}function oe(r){return 1/Math.cos(r*Math.PI/180)}function se(r,e=0){let i=Math.exp(Math.PI*(1-(r.y+e/ht)/(1<<r.z)*2));return 80150034*i/(i*i+1)/ht/(1<<r.z)}class le{constructor(e,i,s=0){this.x=+e,this.y=+i,this.z=+s}static fromLngLat(e,i=0){let s=C.convert(e);return new le(F(s.lng),j(s.lat),U(i,s.lat))}toLngLat(){return new C(Z(this.x),Y(this.y))}toAltitude(){return Q(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/M*oe(Y(this.y))}}function Me(r,e,i,s,a,h,u,f,g){let y=(e+s)/2,w=(i+a)/2,E=new Qe(y,w);f(E),function(I,R,L,k,B,G){let X=L-B,W=k-G;return Math.abs((k-R)*X-(L-I)*W)/Math.hypot(X,W)}(E.x,E.y,h.x,h.y,u.x,u.y)>=g?(Me(r,e,i,y,w,h,E,f,g),Me(r,y,w,s,a,E,u,f,g)):r.push(u)}function _e(r,e,i){let s=r[0],a=s.x,h=s.y;e(s);let u=[s];for(let f=1;f<r.length;f++){let g=r[f],{x:y,y:w}=g;e(g),Me(u,a,h,y,w,s,g,e,i),a=y,h=w,s=g}return u}function Ve(r,e,i,s){if(s(e,i)){let a=e.add(i)._mult(.5);Ve(r,e,a,s),Ve(r,a,i,s)}else r.push(i)}function ze(r,e){let i=r[0],s=[i];for(let a=1;a<r.length;a++){let h=r[a];Ve(s,i,h,e),i=h}return s}let je=Math.pow(2,14)-1,rt=-je-1;function Ce(r,e){let i=Math.round(r.x*e),s=Math.round(r.y*e);return r.x=re(i,rt,je),r.y=re(s,rt,je),(i<r.x||i>r.x+1||s<r.y||s>r.y+1)&&pi("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function me(r,e,i){let s=r.loadGeometry(),a=r.extent,h=ht/a;if(e&&i&&i.projection.isReprojectedInTileSpace){let u=1<<e.z,{scale:f,x:g,y,projection:w}=i,E=I=>{let R=Z((e.x+I.x/a)/u),L=Y((e.y+I.y/a)/u),k=w.project(R,L);I.x=(k.x*f-g)*a,I.y=(k.y*f-y)*a};for(let I=0;I<s.length;I++)if(r.type!==1)s[I]=_e(s[I],E,1);else{let R=[];for(let L of s[I])L.x<0||L.x>=a||L.y<0||L.y>=a||(E(L),R.push(L));s[I]=R}}for(let u of s)for(let f of u)Ce(f,h);return s}function ke(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?me(r):[]}}class Pe{constructor(e,i,s,a,h){this.properties={},this.extent=s,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=a,this._values=h,e.readFields($e,this,i)}loadGeometry(){let e=this._pbf;e.pos=this._geometry;let i=e.readVarint()+e.pos,s=[],a,h=1,u=0,f=0,g=0;for(;e.pos<i;){if(u<=0){let y=e.readVarint();h=7&y,u=y>>3}if(u--,h===1||h===2)f+=e.readSVarint(),g+=e.readSVarint(),h===1&&(a&&s.push(a),a=[]),a&&a.push(new Qe(f,g));else{if(h!==7)throw new Error(`unknown command ${h}`);a&&a.push(a[0].clone())}}return a&&s.push(a),s}bbox(){let e=this._pbf;e.pos=this._geometry;let i=e.readVarint()+e.pos,s=1,a=0,h=0,u=0,f=1/0,g=-1/0,y=1/0,w=-1/0;for(;e.pos<i;){if(a<=0){let E=e.readVarint();s=7&E,a=E>>3}if(a--,s===1||s===2)h+=e.readSVarint(),u+=e.readSVarint(),h<f&&(f=h),h>g&&(g=h),u<y&&(y=u),u>w&&(w=u);else if(s!==7)throw new Error(`unknown command ${s}`)}return[f,y,g,w]}toGeoJSON(e,i,s){let a=this.extent*Math.pow(2,s),h=this.extent*e,u=this.extent*i,f=this.loadGeometry();function g(I){return[360*(I.x+h)/a-180,360/Math.PI*Math.atan(Math.exp((1-2*(I.y+u)/a)*Math.PI))-90]}function y(I){return I.map(g)}let w;if(this.type===1){let I=[];for(let L of f)I.push(L[0]);let R=y(I);w=I.length===1?{type:"Point",coordinates:R[0]}:{type:"MultiPoint",coordinates:R}}else if(this.type===2){let I=f.map(y);w=I.length===1?{type:"LineString",coordinates:I[0]}:{type:"MultiLineString",coordinates:I}}else{if(this.type!==3)throw new Error("unknown feature type");{let I=function(L){let k=L.length;if(k<=1)return[L];let B=[],G,X;for(let W=0;W<k;W++){let K=Ze(L[W]);K!==0&&(X===void 0&&(X=K<0),X===K<0?(G&&B.push(G),G=[L[W]]):G&&G.push(L[W]))}return G&&B.push(G),B}(f),R=[];for(let L of I)R.push(L.map(y));w=R.length===1?{type:"Polygon",coordinates:R[0]}:{type:"MultiPolygon",coordinates:R}}}let E={type:"Feature",geometry:w,properties:this.properties};return this.id!=null&&(E.id=this.id),E}}function $e(r,e,i){r===1?e.id=i.readVarint():r===2?function(s,a){let h=s.readVarint()+s.pos;for(;s.pos<h;){let u=a._keys[s.readVarint()],f=a._values[s.readVarint()];a.properties[u]=f}}(i,e):r===3?e.type=i.readVarint():r===4&&(e._geometry=i.pos)}function Ze(r){let e=0;for(let i,s,a=0,h=r.length,u=h-1;a<h;u=a++)i=r[a],s=r[u],e+=(s.x-i.x)*(i.y+s.y);return e}Pe.types=["Unknown","Point","LineString","Polygon"];class Ye{constructor(e,i){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(ct,this,i),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];let i=this._pbf.readVarint()+this._pbf.pos;return new Pe(this._pbf,i,this.extent,this._keys,this._values)}}function ct(r,e,i){r===15?e.version=i.readVarint():r===1?e.name=i.readString():r===5?e.extent=i.readVarint():r===2?e._features.push(i.pos):r===3?e._keys.push(i.readString()):r===4&&e._values.push(function(s){let a=null,h=s.readVarint()+s.pos;for(;s.pos<h;){let u=s.readVarint()>>3;a=u===1?s.readString():u===2?s.readFloat():u===3?s.readDouble():u===4?s.readVarint64():u===5?s.readVarint():u===6?s.readSVarint():u===7?s.readBoolean():null}if(a==null)throw new Error("unknown feature value");return a}(i))}class Mt{constructor(e,i){this.layers=e.readFields(Ot,{},i)}}function Ot(r,e,i){if(r===3){let s=new Ye(i,i.readVarint()+i.pos);s.length&&(e[s.name]=s)}}let yt="3d_elevation_id",zt="level";class Rt{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,s){return this.get(e,!0,i,s)}optional(e,i,s){return this.get(e,!1,i,s)}success(){return this._valid}get(e,i,s,a){let h=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&h!==void 0&&!Number.isNaN(h)?s(a?a(h):h):i&&(this._valid=!1),this}}class $t{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,s){return this.featureFunc(e,i,s)}parseVertex(e,i,s){return this.vertexFunc(e,i,s)}}let Jt=new $t((r,e,i)=>r.reset(e).require(yt,s=>{i.id=s}).optional("fixed_height_relative",s=>{i.constantHeight=s},Ti.decodeRelativeHeight).geometry(s=>{i.bounds=s},gd).success(),(r,e,i)=>r.reset(e).require(yt,s=>{i.id=s}).require("elevation_idx",s=>{i.idx=s}).require("extent",s=>{i.extent=s}).require("height_relative",s=>{i.height=s},Ti.decodeRelativeHeight).geometry(s=>{i.position=s},Ti.getPoint).success()),ai=new $t((r,e,i)=>r.reset(e).require(yt,s=>{i.id=s}).optional("fixed_height",s=>{i.constantHeight=s},Ti.decodeMetricHeight).geometry(s=>{i.bounds=s},gd).success(),(r,e,i)=>r.reset(e).require(yt,s=>{i.id=s}).require("elevation_idx",s=>{i.idx=s}).require("extent",s=>{i.extent=s}).require("height",s=>{i.height=s},Ti.decodeMetricHeight).geometry(s=>{i.position=s},Ti.getPoint).success());class Ti{static getPoint(e){return uo(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){let i=[],s=[],a=e.length,h=new Rt;for(let f=0;f<a;f++){let g=e.feature(f),y=g.properties.version,w=(u=y)?u==="1.0.1"?ai:void 0:Jt;if(w===void 0){pi(`Unknown elevation feature version number ${y||"(unknown)"}`);continue}let E=g.properties.hasOwnProperty("type")?g.properties.type:void 0;if(E){if(Pe.types[g.type]==="Point"&&E==="curve_point"){let I={};w.parseVertex(h,g,I)&&i.push(I)}else if(Pe.types[g.type]==="Polygon"&&E==="curve_meta"){let I={};w.parseFeature(h,g,I)&&s.push(I)}}}var u;return{vertices:i,features:s}}}class Yt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){let a=hr(i,this.dir);if(Math.abs(a)<1e-6)return!1;let h=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/a;return s[0]=this.pos[0]+this.dir[0]*h,s[1]=this.pos[1]+this.dir[1]*h,!0}}class Si{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){let a=or(i,this.dir);if(Math.abs(a)<1e-6)return!1;let h=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/a;return s[0]=this.pos[0]+this.dir[0]*h,s[1]=this.pos[1]+this.dir[1]*h,s[2]=this.pos[2]+this.dir[2]*h,!0}closestPointOnSphere(e,i,s){if(function(R,L){var k=R[0],B=R[1],G=R[2],X=L[0],W=L[1],K=L[2];return Math.abs(k-X)<=O*Math.max(1,Math.abs(k),Math.abs(X))&&Math.abs(B-W)<=O*Math.max(1,Math.abs(B),Math.abs(W))&&Math.abs(G-K)<=O*Math.max(1,Math.abs(G),Math.abs(K))}(this.pos,e)||i===0)return s[0]=s[1]=s[2]=0,!1;let[a,h,u]=this.dir,f=this.pos[0]-e[0],g=this.pos[1]-e[1],y=this.pos[2]-e[2],w=a*a+h*h+u*u,E=2*(f*a+g*h+y*u),I=E*E-4*w*(f*f+g*g+y*y-i*i);if(I<0){let R=Math.max(-E/2,0),L=f+a*R,k=g+h*R,B=y+u*R,G=Math.hypot(L,k,B);return s[0]=L*i/G,s[1]=k*i/G,s[2]=B*i/G,!1}{let R=(-E-Math.sqrt(I))/(2*w);if(R<0){let L=Math.hypot(f,g,y);return s[0]=f*i/L,s[1]=g*i/L,s[2]=y*i/L,!1}return s[0]=f+a*R,s[1]=g+h*R,s[2]=y+u*R,!0}}}class Mi{constructor(e,i,s,a,h){this.TL=e,this.TR=i,this.BR=s,this.BL=a,this.horizon=h}static fromInvProjectionMatrix(e,i,s){let a=[-1,1,1],h=[1,1,1],u=[1,-1,1],f=[-1,-1,1],g=Lr(a,a,e),y=Lr(h,h,e),w=Lr(u,u,e),E=Lr(f,f,e);return new Mi(g,y,w,E,i/s)}}function Wi(r,e,i){let s=1/0,a=-1/0,h=[];for(let u of r){zr(h,u,e);let f=or(h,i);s=Math.min(s,f),a=Math.max(a,f)}return[s,a]}function ni(r,e){let i=!0;for(let s=0;s<r.planes.length;s++){let a=r.planes[s],h=0;for(let u=0;u<e.length;u++)h+=or(a,e[u])+a[3]>=0;if(h===0)return 0;h!==e.length&&(i=!1)}return i?2:1}function Ei(r,e){for(let i of r.projections){let s=Wi(e,r.points[0],i.axis);if(i.projection[1]<s[0]||i.projection[0]>s[1])return 0}return 1}function Ii(r,e){let i=0,s=[0,0,0,0];for(let u=0;u<r.length;u++)s[0]=r[u][0],s[1]=r[u][1],s[2]=r[u][2],s[3]=1,(a=s)[0]*(h=e)[0]+a[1]*h[1]+a[2]*h[2]+a[3]*h[3]>=0&&i++;var a,h;return i}class Ri{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=li.fromPoints(this.points),this.projections=[],this.frustumEdges=[zr([],this.points[2],this.points[3]),zr([],this.points[0],this.points[3]),zr([],this.points[4],this.points[0]),zr([],this.points[5],this.points[1]),zr([],this.points[6],this.points[2]),zr([],this.points[7],this.points[3])];for(let s of this.frustumEdges){let a=[0,-s[2],s[1]],h=[s[2],0,-s[0]];this.projections.push({axis:a,projection:Wi(this.points,this.points[0],a)}),this.projections.push({axis:h,projection:Wi(this.points,this.points[0],h)})}}static fromInvProjectionMatrix(e,i,s,a){let h=Math.pow(2,s),u=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(y=>{let w=Yn([],y,e),E=1/w[3]/i*h;return(I=w)[0]=(R=w)[0]*(L=[E,E,a?1/w[3]:E,E])[0],I[1]=R[1]*L[1],I[2]=R[2]*L[2],I[3]=R[3]*L[3],I;var I,R,L}),f=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(y=>{let w=Oi([],Vr([],zr([],u[y[0]],u[y[1]]),zr([],u[y[2]],u[y[1]]))),E=-or(w,u[y[1]]);return w.concat(E)}),g=[];for(let y=0;y<u.length;y++)g.push([u[y][0],u[y][1],u[y][2]]);return new Ri(g,f)}intersectsPrecise(e,i,s){for(let a=0;a<i.length;a++)if(!Ii(e,i[a]))return 0;for(let a=0;a<this.planes.length;a++)if(!Ii(e,this.planes[a]))return 0;for(let a of s)for(let h of this.frustumEdges){let u=Vr([],a,h),f=Ni(u);if(f===0)continue;Xi(u,u,1/f);let g=Wi(this.points,this.points[0],u),y=Wi(e,this.points[0],u);if(g[0]>y[1]||y[0]>g[1])return 0}return 1}containsPoint(e){for(let i of this.planes){let s=i[3];if(or([i[0],i[1],i[2]],e)+s<0)return!1}return!0}}class li{static fromPoints(e){let i=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(let a of e)Rr(i,i,a),Hr(s,s,a);return new li(i,s)}static fromTileIdAndHeight(e,i,s){let a=1<<e.canonical.z,h=e.canonical.x,u=e.canonical.y;return new li([h/a,u/a,i],[(h+1)/a,(u+1)/a,s])}static applyTransform(e,i){let s=e.getCorners();for(let a=0;a<s.length;++a)Lr(s[a],s[a],i);return li.fromPoints(s)}static applyTransformFast(e,i){let s=[i[12],i[13],i[14]],a=[...s];for(let h=0;h<3;h++)for(let u=0;u<3;u++){let f=i[4*u+h],g=f*e.min[u],y=f*e.max[u];s[h]+=Math.min(g,y),a[h]+=Math.max(g,y)}return new li(s,a)}static projectAabbCorners(e,i){let s=e.getCorners();for(let a=0;a<s.length;++a)Lr(s[a],s[a],i);return s}constructor(e,i){this.min=e,this.max=i,this.center=Xi([],vi([],this.min,this.max),.5)}quadrant(e){let i=[e%2==0,e<2],s=er(this.min),a=er(this.max);for(let h=0;h<i.length;h++)s[h]=i[h]?this.min[h]:this.center[h],a[h]=i[h]?this.center[h]:this.max[h];return a[2]=this.max[2],new li(s,a)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){let e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?ni(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?ni(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?Ei(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?Ei(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}Tt(li,"Aabb");class Vi{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){let e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,s=i[1],a=-i[0],h=(e.extent+1)*this.metersToTile;return[new Qe(Math.trunc(e.position[0]+s*h),Math.trunc(e.position[1]+a*h)),new Qe(Math.trunc(e.position[0]-s*h),Math.trunc(e.position[1]-a*h))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Ci{constructor(e,i,s,a,h,u){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:s,max:s},this.safeArea=i,this.constantHeight=s,this.constantHeight==null&&(this.constantHeight!=null||a.length!==0)){this.vertices=a,this.edges=h,this.edges=this.edges.filter(f=>{return f.a<this.vertices.length&&f.b<this.vertices.length&&!((g=this.vertices[f.a].position)[0]===(y=this.vertices[f.b].position)[0]&&g[1]===y[1]);var g,y}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let f of this.vertices)this.vertexProps.push({dir:uo(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,f.height),this.heightRange.max=Math.max(this.heightRange.max,f.height);for(let f of this.edges){let g=this.vertices[f.a].position,y=this.vertices[f.b].position,w=Ts(Sn(),y,g),E=Us(w),I=Vs(Sn(),w,1/E);this.edgeProps.push({vec:w,dir:I,len:E});let R=this.vertexProps[f.a].dir,L=this.vertexProps[f.b].dir;Ns(R,R,I),Ns(L,L,I)}for(let f of this.vertexProps)f.dir[0]===0&&f.dir[1]===0||Ja(f.dir,f.dir);this.tessellate(u)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;let i=this.getClosestEdge(e);if(i==null)return 0;let[s,a]=i;return Bt(this.vertices[this.edges[s].a].height,this.vertices[this.edges[s].b].height,a)}computeSlopeNormal(e,i){let s=this.getClosestEdge(e);if(!s)return yi(0,0,1);let a=s[0],h=this.edges[a],u=this.edgeProps[a].vec,f=yi(u[0],u[1],(this.vertices[h.b].height-this.vertices[h.a].height)*i),g=yi(f[1],-f[0],0);Vr(g,g,f);let y=Ni(g);return y>0?Xi(g,g,1/y):yi(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,s=Number.POSITIVE_INFINITY,a=0,h=uo(e.x,e.y);for(let u=0;u<this.edges.length;u++){let f=this.edges[u],g=this.edgeProps[u].dir,y=new Yt(h,this.edgeProps[u].dir),w=this.vertices[f.a].position,E=this.vertices[f.b].position,I=Sn(),R=Sn(),L=y.intersectsPlane(w,this.vertexProps[f.a].dir,I),k=y.intersectsPlane(E,this.vertexProps[f.b].dir,R);if(!L||!k)continue;let B=Ts(Sn(),R,I),G=Ts(Sn(),h,I),X=hr(B,B),W=X>0?hr(G,B)/X:0,K=re(W,0,1),pe=Math.abs((W-K)*this.edgeProps[u].len),ce=Ts(Sn(),h,w),ue=pe+Math.abs(hr(ce,uo(g[1],-g[0])));ue<s&&(i=u,s=ue,a=K)}return[i,a]}tessellate(e){for(let i=this.edges.length-1;i>=0;--i){let s=this.edges[i].a,a=this.edges[i].b,{position:h,height:u,extent:f}=this.vertices[s],{position:g,height:y,extent:w}=this.vertices[a],E=this.vertexProps[s].dir,I=this.vertexProps[a].dir,R=yi(h[0]/e,h[1]/e,u),L=yi(g[0]/e,g[1]/e,y),k=yi(E[1],-E[0],0);Xi(k,k,f);let B=yi(I[1],-I[0],0);if(Xi(B,B,w),this.distSqLines(yi(R[0]+.5*k[0],R[1]+.5*k[1],R[2]+.5*k[2]),yi(L[0]-.5*B[0],L[1]-.5*B[1],L[2]-.5*B[2]),yi(R[0]-.5*k[0],R[1]-.5*k[1],R[2]-.5*k[2]),yi(L[0]+.5*B[0],L[1]+.5*B[1],L[2]+.5*B[2]))<=.0025000000000000005)continue;let G=this.vertices.length,X=Ns(Sn(),h,g);this.vertices.push({position:Vs(X,X,.5),height:.5*(u+y),extent:.5*(f+w)});let W=Ns(Sn(),E,I);this.vertexProps.push({dir:Ja(W,W)}),this.edges.splice(i,1),this.edgeProps.splice(i,1),this.edges.push({a:s,b:G}),this.edges.push({a:G,b:a});let K=Ts(Sn(),this.vertices[G].position,h),pe=Us(K),ce={vec:K,dir:Vs(Sn(),K,1/pe),len:pe};this.edgeProps.push(ce),this.edgeProps.push(ce)}}distSqLines(e,i,s,a){let h=mr(mt(),i,e),u=mr(mt(),a,s),f=mr(mt(),e,s),g=or(h,h),y=or(h,u),w=or(h,f),E=or(u,u),I=or(u,f),R=g*E-y*y;if(R===0){let B=or(f,u)/or(u,u);return Po(Bn(mt(),s,a,B),e)}let L=(y*I-w*E)/R,k=(g*I-y*w)/R;return Po(Bn(mt(),e,i,L),Bn(mt(),s,a,k))}}class yr{static parseFrom(e,i){let s=Ti.parse(e);if(!s)return[];let{vertices:a,features:h}=s,u=1/se(i);h.sort((w,E)=>w.id-E.id),a.sort((w,E)=>w.id-E.id||w.idx-E.idx),a=a.filter((w,E,I)=>E===I.findIndex(R=>R.id===w.id&&R.idx===w.idx));let f=new Array,g=0,y=a.length;for(let w of h){if(w.constantHeight){f.push(new Ci(w.id,w.bounds,w.constantHeight));continue}for(;g!==y&&a[g].id<w.id;)g++;if(g===y||a[g].id!==w.id)continue;let E=new Array,I=new Array,R=g;for(;g!==y&&a[g].id===w.id;){let L=a[g];if(E.push({position:L.position,height:L.height,extent:L.extent}),g!==R&&a[g-1].idx===L.idx-1){let k=g-R;I.push({a:k-1,b:k})}g++}f.push(new Ci(w.id,w.bounds,void 0,E,I,u))}return f}static getElevationFeature(e,i){if(!i)return;let s=+e.properties[yt];return Number.isNaN(s)?void 0:i.find(a=>a.id===s)}}class bi{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*ht,this.yOffset=(e.y*this.zScale-i.y)*ht)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,s){let a=this.constantElevation(i,s);return a??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),s))}computeBiasedHeight(e,i){return i<=0?e:e+i*ye(0,i,e>=0?e:Math.abs(.5*e))}}Tt(Ci,"ElevationFeature");class Li{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new $n,this.indexArray=new ur,this.segments=new gr,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Fa),this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){let h=this.layers[0],u=[],f=null;h.type==="circle"&&(f=h.layout.get("circle-sort-key"));for(let{feature:y,id:w,index:E,sourceLayerIndex:I}of e){let R=this.layers[0]._featureFilter.needGeometry,L=ke(y,R);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),L,s))continue;let k=f?f.evaluate(L,{},s):void 0,B={id:w,properties:y.properties,type:y.type,sourceLayerIndex:I,index:E,geometry:R?L.geometry:me(y,s,a),patterns:{},sortKey:k};u.push(B)}f&&u.sort((y,w)=>y.sortKey-w.sortKey);let g=null;a.projection.name==="globe"&&(this.globeExtVertexArray=new gu,g=a.projection);for(let y of u){let{geometry:w,index:E,sourceLayerIndex:I}=y,R=e[E].feature;this.addFeature(y,w,E,i.availableImages,s,g,i.brightness,i.elevationFeatures),i.featureIndex.insert(R,w,E,I,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,s,a,h,u,f){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Cm.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,Fg.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,kg.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,s,a,h,u,f,g){let y;this.elevationMode!=="none"&&(y=yr.getElevationFeature(e,g));for(let w of i)for(let E of w){let I=E.x,R=E.y;if(I<0||I>=ht||R<0||R>=ht)continue;if(u){let B=u.projectTilePoint(I,R,h),G=u.upVector(h,I,R);this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G),this.addGlobeExtVertex(B,G)}let L=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),k=L.vertexLength;if(this.addCircleVertex(I,R,-1,-1),this.addCircleVertex(I,R,1,-1),this.addCircleVertex(I,R,1,1),this.addCircleVertex(I,R,-1,1),this.elevationMode!=="none"){let B=y?y.pointElevation(new Qe(I,R)):0;this.hasElevation=this.hasElevation||B!==0;for(let G=0;G<4;G++)this.elevatedLayoutVertexArray.emplaceBack(B)}this.indexArray.emplaceBack(k,k+1,k+2),this.indexArray.emplaceBack(k,k+2,k+3),L.vertexLength+=4,L.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},a,h,f,void 0,this.worldview)}addCircleVertex(e,i,s,a){this.layoutVertexArray.emplaceBack(2*e+(s+1)/2,2*i+(a+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function $i(r,e){for(let i=0;i<r.length;i++)if(xn(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(xn(r,e[i]))return!0;return!!hn(r,e)}function kr(r,e,i){return!!xn(r,e)||!!yn(e,r,i)}function Dr(r,e){if(r.length===1)return Vo(e,r[0]);for(let i=0;i<e.length;i++){let s=e[i];for(let a=0;a<s.length;a++)if(xn(r,s[a]))return!0}for(let i=0;i<r.length;i++)if(Vo(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(hn(r,e[i]))return!0;return!1}function Br(r,e,i){if(r.length>1){if(hn(r,e))return!0;for(let s=0;s<e.length;s++)if(yn(e[s],r,i))return!0}for(let s=0;s<r.length;s++)if(yn(r[s],e,i))return!0;return!1}function hn(r,e){if(r.length===0||e.length===0)return!1;for(let i=0;i<r.length-1;i++){let s=r[i],a=r[i+1];for(let h=0;h<e.length-1;h++)if(Jo(s,a,e[h],e[h+1]))return!0}return!1}function Jo(r,e,i,s){return Mr(r,i,s)!==Mr(e,i,s)&&Mr(r,e,i)!==Mr(r,e,s)}function kn(r,e,i){return(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x)}function eo(r,e,i,s){let a=kn(r,e,s),h=kn(r,e,i);if(Math.sign(a)===Math.sign(h))return;let u=kn(i,s,r),f=u+h-a;return Math.sign(u)!==Math.sign(f)?[u/(u-f),h/(h-a)]:void 0}function yn(r,e,i){let s=i*i;if(e.length===1)return r.distSqr(e[0])<s;for(let a=1;a<e.length;a++)if(bo(r,e[a-1],e[a])<s)return!0;return!1}function bo(r,e,i){let s=e.distSqr(i);if(s===0)return r.distSqr(e);let a=((r.x-e.x)*(i.x-e.x)+(r.y-e.y)*(i.y-e.y))/s;return r.distSqr(a<0?e:a>1?i:i.sub(e)._mult(a)._add(e))}function Vo(r,e){let i,s,a,h=!1;for(let u=0;u<r.length;u++){i=r[u];for(let f=0,g=i.length-1;f<i.length;g=f++)s=i[f],a=i[g],s.y>e.y!=a.y>e.y&&e.x<(a.x-s.x)*(e.y-s.y)/(a.y-s.y)+s.x&&(h=!h)}return h}function xn(r,e){let i=!1;for(let s=0,a=r.length-1;s<r.length;a=s++){let h=r[s],u=r[a];h.y>e.y!=u.y>e.y&&e.x<(u.x-h.x)*(e.y-h.y)/(u.y-h.y)+h.x&&(i=!i)}return i}function Cr(r,e,i,s,a){for(let u of r)if(e<=u.x&&i<=u.y&&s>=u.x&&a>=u.y)return!0;let h=[new Qe(e,i),new Qe(e,a),new Qe(s,a),new Qe(s,i)];if(r.length>2){for(let u of h)if(xn(r,u))return!0}for(let u=0;u<r.length-1;u++)if(Sr(r[u],r[u+1],h))return!0;return!1}function Sr(r,e,i){let s=i[0],a=i[2];if(r.x<s.x&&e.x<s.x||r.x>a.x&&e.x>a.x||r.y<s.y&&e.y<s.y||r.y>a.y&&e.y>a.y)return!1;let h=Mr(r,e,i[0]);return h!==Mr(r,e,i[1])||h!==Mr(r,e,i[2])||h!==Mr(r,e,i[3])}function Ki(r,e,i,s,a,h){let u=e.y-r.y,f=r.x-e.x;if(h=h||0){let g=u*u+f*f;if(g===0)return!0;let y=Math.sqrt(g);u/=y,f/=y}return!((i.x-r.x)*u+(i.y-r.y)*f-h<0||(s.x-r.x)*u+(s.y-r.y)*f-h<0||(a.x-r.x)*u+(a.y-r.y)*f-h<0)}function Wr(r,e,i,s,a,h,u){return!(Ki(r,e,s,a,h,u)||Ki(e,i,s,a,h,u)||Ki(i,r,s,a,h,u)||Ki(s,a,r,e,i,u)||Ki(a,h,r,e,i,u)||Ki(h,s,r,e,i,u))}function un(r,e,i){let s=e.paint.get(r).value;return s.kind==="constant"?s.value:i.programConfigurations.get(e.id).getMaxValue(r)}function Pr(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function wo(r,e,i,s,a){if(!e[0]&&!e[1])return r;let h=Qe.convert(e)._mult(a);i==="viewport"&&h._rotate(-s);let u=[];for(let f=0;f<r.length;f++)u.push(r[f].sub(h));return u}function Na(r,e,i,s){let a=Qe.convert(r)._mult(s);return e==="viewport"&&a._rotate(-i),a}let la,Ol;function kl(r,e,i){var s=2*Math.PI*6378137/256/Math.pow(2,i);return[r*s-2*Math.PI*6378137/2,e*s-2*Math.PI*6378137/2]}Tt(Li,"CircleBucket",{omit:["layers"]});class To{constructor(e,i,s){this.z=e,this.x=i,this.y=s,this.key=So(0,e,e,i,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){let i=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>i&&e.y===this.y>>i}url(e,i){let s=function(h,u,f){var g=kl(256*h,256*(u=Math.pow(2,f)-u-1),f),y=kl(256*(h+1),256*(u+1),f);return g[0]+","+g[1]+","+y[0]+","+y[1]}(this.x,this.y,this.z),a=function(h,u,f){let g,y="";for(let w=h;w>0;w--)g=1<<w-1,y+=(u&g?1:0)+(f&g?2:0);return y}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",a).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class us{constructor(e,i){this.wrap=e,this.canonical=i,this.key=So(e,i.z,i.z,i.x,i.y)}}class Xr{constructor(e,i,s,a,h){this.overscaledZ=e,this.wrap=i,this.canonical=new To(s,+a,+h),this.key=i===0&&e===s?this.canonical.key:So(i,e,s,a,h)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){let i=this.canonical.z-e;return e>this.canonical.z?new Xr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Xr(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return So(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{let s=this.canonical.z-e;return So(this.wrap*+i,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;let i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new Xr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let i=this.canonical.z+1,s=2*this.canonical.x,a=2*this.canonical.y;return[new Xr(i,this.wrap,i,s,a),new Xr(i,this.wrap,i,s+1,a),new Xr(i,this.wrap,i,s,a+1),new Xr(i,this.wrap,i,s+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Xr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Xr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new us(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function So(r,e,i,s,a){let h=1<<Math.min(i,22),u=h*(a%h)+s%h;return r&&i<22&&(u+=h*h*((r<0?-2*r-1:2*r)%(1<<2*(22-i)))),16*(32*u+i)+(e-i)}let Va=[r=>{let e=r.canonical.x-1,i=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,i--),new Xr(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,i=r.wrap;return e===1<<r.canonical.z&&(e=0,i++),new Xr(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>new Xr(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new Xr(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];Tt(To,"CanonicalTileID"),Tt(Xr,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let IE=gi([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Om}=IE,AE=gi([{name:"a_pos_3",components:3,type:"Int16"}]);var Dx=gi([{name:"a_pos",type:"Int16",components:2}]);function km(r){return r*Cn/b}let ME=[new li([d,d,d],[p,p,p]),new li([d,d,d],[0,0,p]),new li([0,d,d],[p,0,p]),new li([d,0,d],[0,p,p]),new li([0,0,d],[p,p,p])];function Ox(r,e,i,s=!0){let a=Xi([],r._camera.position,r.worldSize),h=[e,i,1,1];Yn(h,h,r.pixelMatrixInverse),xs(h,h,1/h[3]);let u=Oi([],zr([],h,a)),f=r.globeMatrix,g=[f[12],f[13],f[14]],y=zr([],g,a),w=Ni(y),E=Oi([],y),I=r.worldSize/(2*Math.PI),R=or(E,u),L=Math.asin(I/w);if(L<Math.acos(R)){if(!s)return null;let Ne=[],Ee=[];Xi(Ne,u,w/R),Oi(Ee,zr(Ee,Ne,y)),Oi(u,vi(u,y,Xi(u,Ee,Math.tan(L)*w)))}let k=[];new Si(a,u).closestPointOnSphere(g,I,k);let B=Oi([],wr(f,0)),G=Oi([],wr(f,1)),X=Oi([],wr(f,2)),W=or(B,k),K=or(G,k),pe=or(X,k),ce=Re(Math.asin(-K/I)),ue=Re(Math.atan2(W,pe));ue=r.center.lng+function(Ne,Ee){let Ue=(Ee-Ne+180)%360-180;return Ue<-180?Ue+360:Ue}(r.center.lng,ue);let ge=F(ue),ve=re(j(ce),0,1);return new le(ge,ve)}class CE{constructor(e,i,s){this.a=zr([],e,s),this.b=zr([],i,s),this.center=s;let a=Oi([],this.a),h=Oi([],this.b);this.angle=Math.acos(or(a,h))}}function Hg(r,e){if(r.angle===0)return null;let i;return i=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),i<0||i>1?null:function(s,a,h,u){let f=Math.sin(h);return s*(Math.sin((1-u)*h)/f)+a*(Math.sin(u*h)/f)}(r.a[e],r.b[e],r.angle,re(i,0,1))+r.center[e]}function ca(r){if(r.z<=1)return ME[r.z+2*r.y+r.x];let e=$g(Fm(r));return li.fromPoints(e)}function Ua(r,e,i){return Xi(r,r,1-i),tn(r,r,e,i)}function kx(r,e,i){for(let s of r)Lr(s,s,e),Xi(s,s,i)}function Fx(r,e,i,s){let a=e/r.worldSize,h=r.globeMatrix;if(i.z<=1){let ve=ca(i).getCorners();return kx(ve,h,a),li.fromPoints(ve)}let u=Fm(i,s),f=$g(u,Cn+km(r._tileCoverLift));kx(f,h,a);let g=Number.MAX_VALUE,y=[-g,-g,-g],w=[g,g,g];if(u.contains(r.center)){for(let Ee of f)Rr(w,w,Ee),Hr(y,y,Ee);y[2]=0;let ve=r.point,Ne=[ve.x*a,ve.y*a,0];return Rr(w,w,Ne),Hr(y,y,Ne),new li(w,y)}if(r._tileCoverLift>0){for(let ve of f)Rr(w,w,ve),Hr(y,y,ve);return new li(w,y)}let E=[h[12]*a,h[13]*a,h[14]*a],I=u.getCenter(),R=re(r.center.lat,-ne,ne),L=re(I.lat,-ne,ne),k=F(r.center.lng),B=j(R),G=k-F(I.lng),X=B-j(L);G>.5?G-=1:G<-.5&&(G+=1);let W=0;Math.abs(G)>Math.abs(X)?W=G>=0?1:3:(W=X>=0?0:2,tn(E,E,[h[4]*a,h[5]*a,h[6]*a],-Math.sin(Ai(X>=0?u.getSouth():u.getNorth()))*Cn));let K=f[W],pe=f[(W+1)%4],ce=new CE(K,pe,E),ue=[Hg(ce,0)||K[0],Hg(ce,1)||K[1],Hg(ce,2)||K[2]],ge=Fl(r.zoom);if(ge>0){let ve=function({x:Ee,y:Ue,z:nt},qe,Ke,it,Fe){let Je=1/(1<<nt),Ie=Ee*Je,Be=Ie+Je,at=Ue*Je,et=at+Je,Lt=0,St=(Ie+Be)/2-it;return St>.5?Lt=-1:St<-.5&&(Lt=1),Ie=((Ie+Lt)*qe-(it*=qe))*Ke+it,Be=((Be+Lt)*qe-it)*Ke+it,at=(at*qe-(Fe*=qe))*Ke+Fe,et=(et*qe-Fe)*Ke+Fe,[[Ie,et,0],[Be,et,0],[Be,at,0],[Ie,at,0]]}(i,e,r._pixelsPerMercatorPixel,k,B);for(let Ee=0;Ee<f.length;Ee++)Ua(f[Ee],ve[Ee],ge);let Ne=vi([],ve[W],ve[(W+1)%4]);Xi(Ne,Ne,.5),Ua(ue,Ne,ge)}for(let ve of f)Rr(w,w,ve),Hr(y,y,ve);return w[2]=Math.min(K[2],pe[2]),Rr(w,w,ue),Hr(y,y,ue),new li(w,y)}function Fm({x:r,y:e,z:i},s=!1){let a=1/(1<<i),h=new C(Z(r*a),e===(1<<i)-1&&s?-90:Y((e+1)*a)),u=new C(Z((r+1)*a),e===0&&s?90:Y(e*a));return new z(h,u)}function $g(r,e=Cn){let i=Ai(r.getNorth()),s=Ai(r.getSouth()),a=Math.cos(i),h=Math.cos(s),u=Math.sin(i),f=Math.sin(s),g=r.getWest(),y=r.getEast();return[_(h,f,g,e),_(h,f,y,e),_(a,u,y,e),_(a,u,g,e)]}function Tp(r,e,i,s){let a=1<<i.z,h=(r/ht+i.x)/a;return x(Y((e/ht+i.y)/a),Z(h),s)}function Bm({min:r,max:e}){return t/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}let Bx=new Float64Array(16);function Nm(r){let e=Bm(r),i=wt(Bx,[e,e,e]);return We(i,i,Zo([],r.min))}function Zg(r){let e=(s=r.min,(i=Bx)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=s[0],i[13]=s[1],i[14]=s[2],i[15]=1,i);var i,s;let a=1/Bm(r);return ft(e,e,[a,a,a])}function Wg(r){let e=ht/(2*Math.PI);return r/(2*Math.PI)/e}function Nx(r,e){return ht/(512*Math.pow(2,r))*Bm(ca(e))}function Vx(r,e,i,s,a){let h=Wg(i),u=[r,e,-i/(2*Math.PI)],f=xe(new Float64Array(16));return We(f,f,u),ft(f,f,[h,h,h]),_t(f,f,Ai(-a)),Pt(f,f,Ai(-s)),f}function Fl(r){return ye(Dm,l,r)}function Ux(r,e){let i=x(e.lat,e.lng),s=function(L){let k=x(L._center.lat,L._center.lng),B=Vr([],yi(0,1,0),k),G=Ct([],-L.angle,k);B=Lr(B,B,G),Ct(G,-L._pitch,B);let X=Oi([],k);return Xi(X,X,km(L.cameraToCenterDistance/L.pixelsPerMeter)),Lr(X,X,G),vi([],k,X)}(r);return u=(a=mr([],s,i))[0],f=a[1],g=a[2],y=(h=i)[0],w=h[1],E=h[2],R=(I=Math.sqrt(u*u+f*f+g*g)*Math.sqrt(y*y+w*w+E*E))&&or(a,h)/I,Math.acos(Math.min(Math.max(R,-1),1));var a,h,u,f,g,y,w,E,I,R}function Xg(r,e){return Ux(r,e)>Math.PI/2*1.01}let jx=Ai(85),PE=Math.cos(jx),RE=Math.sin(jx),LE=Ae(),Gx=r=>{let e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function qx(r,e,i,s,a,h,u,f,g){if(h&&r.queryGeometry.isAboveHorizon)return!1;h&&(g*=r.pixelToTileUnitsFactor);let y=r.tileID.canonical,w=i.projection.upVectorScale(y,i.center.lat,i.worldSize).metersToTile;for(let E of e)for(let I of E){let R=I.add(f),L=a&&i.elevation?i.elevation.exaggeration()*a.getElevationAt(R.x,R.y,!0):0,k=i.projection.projectTilePoint(R.x,R.y,y);if(L>0){let W=i.projection.upVector(y,R.x,R.y);k.x+=W[0]*w*L,k.y+=W[1]*w*L,k.z+=W[2]*w*L}let B=h?R:zE(k.x,k.y,k.z,s),G=h?r.tilespaceRays.map(W=>OE(W,L)):r.queryGeometry.screenGeometry,X=Yn([],[k.x,k.y,k.z,1],s);if(!u&&h?g*=X[3]/i.cameraToCenterDistance:u&&!h&&(g*=i.cameraToCenterDistance/X[3]),h){let W=Y((I.y/ht+y.y)/(1<<y.z));g/=i.projection.pixelsPerMeter(W,1)/U(1,W)}if(kr(G,B,g))return!0}return!1}function zE(r,e,i,s){let a=Yn([],[r,e,i,1],s);return new Qe(a[0]/a[3],a[1]/a[3])}let Hx=yi(0,0,0),DE=yi(0,0,1);function OE(r,e){let i=mt();return Hx[2]=e,r.intersectsPlane(Hx,DE,i),new Qe(i[0],i[1])}class $x extends Li{}let Zx,Wx,Xx,Yx;function Kx(r,{width:e,height:i},s,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*i*s)throw new RangeError("mismatched image size")}else a=new Uint8Array(e*i*s);return r.width=e,r.height=i,r.data=a,r}function Jx(r,e,i){let{width:s,height:a}=e;s===r.width&&a===r.height||(Yg(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,s),height:Math.min(r.height,a)},i,null),r.width=s,r.height=a,r.data=e.data)}function Yg(r,e,i,s,a,h,u,f){if(a.width===0||a.height===0)return e;if(a.width>r.width||a.height>r.height||i.x>r.width-a.width||i.y>r.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||s.x>e.width-a.width||s.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");let g=r.data,y=e.data,w=h===4&&f;for(let E=0;E<a.height;E++){let I=((i.y+E)*r.width+i.x)*h,R=((s.y+E)*e.width+s.x)*h;if(w)for(let L=0;L<a.width;L++){let k=I+L*h+3,B=R+L*h;y[B+0]=255,y[B+1]=255,y[B+2]=255,y[B+3]=g[k]}else if(u)for(let L=0;L<a.width;L++){let k=I+L*h,B=R+L*h,G=new ki(g[k+0]/255,g[k+1]/255,g[k+2]/255,g[k+3]).toNonPremultipliedRenderColor(u).toArray();y[B+0]=G[0],y[B+1]=G[1],y[B+2]=G[2],y[B+3]=G[3]}else for(let L=0;L<a.width*h;L++)y[R+L]=g[I+L]}return e}Tt($x,"HeatmapBucket",{omit:["layers"]});class Bl{constructor(e,i){Kx(this,e,1,i)}resize(e){Jx(this,new Bl(e),1)}clone(){return new Bl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,h){Yg(e,i,s,a,h,1,null)}}class vn{constructor(e,i){Kx(this,e,4,i)}resize(e){Jx(this,new vn(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new vn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,a,h,u,f){Yg(e,i,s,a,h,4,u,f)}}class Qx{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function Sp(r){let e={},i=r.resolution||256,s=r.clips?r.clips.length:1,a=r.image||new vn({width:i,height:s}),h=(u,f,g)=>{e[r.evaluationKey]=g;let y=r.expression.evaluate(e),w=y?y.toNonPremultipliedRenderColor(null):null;w&&(a.data[u+f+0]=Math.floor(255*w.r),a.data[u+f+1]=Math.floor(255*w.g),a.data[u+f+2]=Math.floor(255*w.b),a.data[u+f+3]=Math.floor(255*w.a))};if(r.clips)for(let u=0,f=0;u<s;++u,f+=4*i)for(let g=0,y=0;g<i;g++,y+=4){let w=g/(i-1),{start:E,end:I}=r.clips[u];h(f,y,E*(1-w)+I*w)}else for(let u=0,f=0;u<i;u++,f+=4)h(0,f,u/(i-1));return a}Tt(Bl,"AlphaImage"),Tt(vn,"RGBAImage");let kE=gi([{name:"a_pos",components:2,type:"Int16"}],4),FE=gi([{name:"a_road_z_offset",components:1,type:"Float32"}],4),BE=gi([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),NE=gi([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Iu(r,e,i=2){let s=e&&e.length,a=s?e[0]*i:r.length,h=ev(r,0,a,i,!0),u=[];if(!h||h.next===h.prev)return u;let f,g,y;if(s&&(h=function(w,E,I,R){let L=[];for(let k=0,B=E.length;k<B;k++){let G=ev(w,E[k]*R,k<B-1?E[k+1]*R:w.length,R,!1);G===G.next&&(G.steiner=!0),L.push(ZE(G))}L.sort(qE);for(let k=0;k<L.length;k++)I=HE(L[k],I);return I}(r,e,h,i)),r.length>80*i){f=r[0],g=r[1];let w=f,E=g;for(let I=i;I<a;I+=i){let R=r[I],L=r[I+1];R<f&&(f=R),L<g&&(g=L),R>w&&(w=R),L>E&&(E=L)}y=Math.max(w-f,E-g),y=y!==0?32767/y:0}return Ep(h,u,i,f,g,y,0),u}function ev(r,e,i,s,a){let h;if(a===function(u,f,g,y){let w=0;for(let E=f,I=g-y;E<g;E+=y)w+=(u[I]-u[E])*(u[E+1]+u[I+1]),I=E;return w}(r,e,i,s)>0)for(let u=e;u<i;u+=s)h=nv(u/s|0,r[u],r[u+1],h);else for(let u=i-s;u>=e;u-=s)h=nv(u/s|0,r[u],r[u+1],h);return h&&Au(h,h.next)&&(Mp(h),h=h.next),h}function eh(r,e){if(!r)return r;e||(e=r);let i,s=r;do if(i=!1,s.steiner||!Au(s,s.next)&&on(s.prev,s,s.next)!==0)s=s.next;else{if(Mp(s),s=e=s.prev,s===s.next)break;i=!0}while(i||s!==e);return e}function Ep(r,e,i,s,a,h,u){if(!r)return;!u&&h&&function(g,y,w,E){let I=g;do I.z===0&&(I.z=Kg(I.x,I.y,y,w,E)),I.prevZ=I.prev,I.nextZ=I.next,I=I.next;while(I!==g);I.prevZ.nextZ=null,I.prevZ=null,function(R){let L,k=1;do{let B,G=R;R=null;let X=null;for(L=0;G;){L++;let W=G,K=0;for(let ce=0;ce<k&&(K++,W=W.nextZ,W);ce++);let pe=k;for(;K>0||pe>0&&W;)K!==0&&(pe===0||!W||G.z<=W.z)?(B=G,G=G.nextZ,K--):(B=W,W=W.nextZ,pe--),X?X.nextZ=B:R=B,B.prevZ=X,X=B;G=W}X.nextZ=null,k*=2}while(L>1)}(I)}(r,s,a,h);let f=r;for(;r.prev!==r.next;){let g=r.prev,y=r.next;if(h?UE(r,s,a,h):VE(r))e.push(g.i,r.i,y.i),Mp(r),r=y.next,f=y.next;else if((r=y)===f){u?u===1?Ep(r=jE(eh(r),e),e,i,s,a,h,2):u===2&&GE(r,e,i,s,a,h):Ep(eh(r),e,i,s,a,h,1);break}}}function VE(r){let e=r.prev,i=r,s=r.next;if(on(e,i,s)>=0)return!1;let a=e.x,h=i.x,u=s.x,f=e.y,g=i.y,y=s.y,w=Math.min(a,h,u),E=Math.min(f,g,y),I=Math.max(a,h,u),R=Math.max(f,g,y),L=s.next;for(;L!==e;){if(L.x>=w&&L.x<=I&&L.y>=E&&L.y<=R&&Ip(a,f,h,g,u,y,L.x,L.y)&&on(L.prev,L,L.next)>=0)return!1;L=L.next}return!0}function UE(r,e,i,s){let a=r.prev,h=r,u=r.next;if(on(a,h,u)>=0)return!1;let f=a.x,g=h.x,y=u.x,w=a.y,E=h.y,I=u.y,R=Math.min(f,g,y),L=Math.min(w,E,I),k=Math.max(f,g,y),B=Math.max(w,E,I),G=Kg(R,L,e,i,s),X=Kg(k,B,e,i,s),W=r.prevZ,K=r.nextZ;for(;W&&W.z>=G&&K&&K.z<=X;){if(W.x>=R&&W.x<=k&&W.y>=L&&W.y<=B&&W!==a&&W!==u&&Ip(f,w,g,E,y,I,W.x,W.y)&&on(W.prev,W,W.next)>=0||(W=W.prevZ,K.x>=R&&K.x<=k&&K.y>=L&&K.y<=B&&K!==a&&K!==u&&Ip(f,w,g,E,y,I,K.x,K.y)&&on(K.prev,K,K.next)>=0))return!1;K=K.nextZ}for(;W&&W.z>=G;){if(W.x>=R&&W.x<=k&&W.y>=L&&W.y<=B&&W!==a&&W!==u&&Ip(f,w,g,E,y,I,W.x,W.y)&&on(W.prev,W,W.next)>=0)return!1;W=W.prevZ}for(;K&&K.z<=X;){if(K.x>=R&&K.x<=k&&K.y>=L&&K.y<=B&&K!==a&&K!==u&&Ip(f,w,g,E,y,I,K.x,K.y)&&on(K.prev,K,K.next)>=0)return!1;K=K.nextZ}return!0}function jE(r,e){let i=r;do{let s=i.prev,a=i.next.next;!Au(s,a)&&iv(s,i,i.next,a)&&Ap(s,a)&&Ap(a,s)&&(e.push(s.i,i.i,a.i),Mp(i),Mp(i.next),i=r=a),i=i.next}while(i!==r);return eh(i)}function GE(r,e,i,s,a,h){let u=r;do{let f=u.next.next;for(;f!==u.prev;){if(u.i!==f.i&&WE(u,f)){let g=rv(u,f);return u=eh(u,u.next),g=eh(g,g.next),Ep(u,e,i,s,a,h,0),void Ep(g,e,i,s,a,h,0)}f=f.next}u=u.next}while(u!==r)}function qE(r,e){let i=r.x-e.x;return i===0&&(i=r.y-e.y,i===0)&&(i=(r.next.y-r.y)/(r.next.x-r.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function HE(r,e){let i=function(a,h){let u=h,f=a.x,g=a.y,y,w=-1/0;if(Au(a,u))return u;do{if(Au(a,u.next))return u.next;if(g<=u.y&&g>=u.next.y&&u.next.y!==u.y){let k=u.x+(g-u.y)*(u.next.x-u.x)/(u.next.y-u.y);if(k<=f&&k>w&&(w=k,y=u.x<u.next.x?u:u.next,k===f))return y}u=u.next}while(u!==h);if(!y)return null;let E=y,I=y.x,R=y.y,L=1/0;u=y;do{if(f>=u.x&&u.x>=I&&f!==u.x&&tv(g<R?f:w,g,I,R,g<R?w:f,g,u.x,u.y)){let k=Math.abs(g-u.y)/(f-u.x);Ap(u,a)&&(k<L||k===L&&(u.x>y.x||u.x===y.x&&$E(y,u)))&&(y=u,L=k)}u=u.next}while(u!==E);return y}(r,e);if(!i)return e;let s=rv(i,r);return eh(s,s.next),eh(i,i.next)}function $E(r,e){return on(r.prev,r,e.prev)<0&&on(e.next,r,r.next)<0}function Kg(r,e,i,s,a){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-i)*a|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function ZE(r){let e=r,i=r;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==r);return i}function tv(r,e,i,s,a,h,u,f){return(a-u)*(e-f)>=(r-u)*(h-f)&&(r-u)*(s-f)>=(i-u)*(e-f)&&(i-u)*(h-f)>=(a-u)*(s-f)}function Ip(r,e,i,s,a,h,u,f){return!(r===u&&e===f)&&tv(r,e,i,s,a,h,u,f)}function WE(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!function(i,s){let a=i;do{if(a.i!==i.i&&a.next.i!==i.i&&a.i!==s.i&&a.next.i!==s.i&&iv(a,a.next,i,s))return!0;a=a.next}while(a!==i);return!1}(r,e)&&(Ap(r,e)&&Ap(e,r)&&function(i,s){let a=i,h=!1,u=(i.x+s.x)/2,f=(i.y+s.y)/2;do a.y>f!=a.next.y>f&&a.next.y!==a.y&&u<(a.next.x-a.x)*(f-a.y)/(a.next.y-a.y)+a.x&&(h=!h),a=a.next;while(a!==i);return h}(r,e)&&(on(r.prev,r,e.prev)||on(r,e.prev,e))||Au(r,e)&&on(r.prev,r,r.next)>0&&on(e.prev,e,e.next)>0)}function on(r,e,i){return(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y)}function Au(r,e){return r.x===e.x&&r.y===e.y}function iv(r,e,i,s){let a=Um(on(r,e,i)),h=Um(on(r,e,s)),u=Um(on(i,s,r)),f=Um(on(i,s,e));return a!==h&&u!==f||!(a!==0||!Vm(r,i,e))||!(h!==0||!Vm(r,s,e))||!(u!==0||!Vm(i,r,s))||!(f!==0||!Vm(i,e,s))}function Vm(r,e,i){return e.x<=Math.max(r.x,i.x)&&e.x>=Math.min(r.x,i.x)&&e.y<=Math.max(r.y,i.y)&&e.y>=Math.min(r.y,i.y)}function Um(r){return r>0?1:r<0?-1:0}function Ap(r,e){return on(r.prev,r,r.next)<0?on(r,e,r.next)>=0&&on(r,r.prev,e)>=0:on(r,e,r.prev)<0||on(r,r.next,e)<0}function rv(r,e){let i=Jg(r.i,r.x,r.y),s=Jg(e.i,e.x,e.y),a=r.next,h=e.prev;return r.next=e,e.prev=r,i.next=a,a.prev=i,s.next=i,i.prev=s,h.next=s,s.prev=h,s}function nv(r,e,i,s){let a=Jg(r,e,i);return s?(a.next=s.next,a.prev=s,s.next.prev=a,s.next=a):(a.prev=a,a.next=a),a}function Mp(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Jg(r,e,i){return{i:r,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Cp(r,e){let i=r.length;if(i<=1)return[r];let s=[],a,h;for(let u=0;u<i;u++){let f=Qr(r[u]);f!==0&&(r[u].area=Math.abs(f),h===void 0&&(h=f<0),h===f<0?(a&&s.push(a),a=[r[u]]):a.push(r[u]))}if(a&&s.push(a),e>1)for(let u=0;u<s.length;u++)s[u].length<=e||(An(s[u],e,1,s[u].length-1,XE),s[u]=s[u].slice(0,e));return s}function XE(r,e){return e.area-r.area}function ov(r,e,i=1){if(!r)return null;let s=typeof r=="string"?Gn.from(r).getPrimary():r.getPrimary(),a=typeof r=="string"?null:r.getSecondary();for(let h of[s,a]){if(!h)continue;let u=h.id.toString();e.has(u)||e.set(u,[]),h.scaleSelf(i),e.get(u).push(h)}return{primary:s.toString(),secondary:a?a.toString():null}}function Qg(r,e,i,s){let a=s.patternDependencies,h=!1;for(let u of e){let f=u.paint.get(`${r}-pattern`);f.isConstant()||(h=!0),ov(f.constantOr(null),a,i)&&(h=!0)}return h}function ey(r,e,i,s,a,h){let u=h.patternDependencies;for(let f of e){let g=f.paint.get(`${r}-pattern`).value;if(g.kind!=="constant"){let y=g.evaluate({zoom:s},i,{},h.availableImages);y=y&&y.name?y.name:y;let w=ov(y,u,a);if(!w)continue;let{primary:E,secondary:I}=w;E&&(i.patterns[f.id]=[E,I].filter(Boolean))}}return i}class sv{constructor(){this.polygons=new Map}add(e,...i){this.polygons.has(e)?this.polygons.get(e).push(...i):this.polygons.set(e,i)}merge(e){for(let[i,s]of e.polygons)this.add(i,...s)}}class th{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new th;let i=[];for(let y of e)i.push(...y.portals);if(i.length===0)return new th;let s=(y,w)=>y<=0&&w<=0||y>=ht&&w>=ht;for(let y of i){let w=y.va,E=y.vb;(s(w.x,E.x)||s(w.y,E.y))&&(y.type="border")}let a=i.filter(y=>y.type!=="unevaluated"),h=i.filter(y=>y.type==="unevaluated");if(h.length===0)return new th;h.sort((y,w)=>y.hash===w.hash?y.isTunnel===w.isTunnel?0:y.isTunnel?-1:1:y.hash<w.hash?1:-1),i=a.concat(h);let u=a.length,f=u,g=u;do if(f++,f===i.length||i[u].hash!==i[f].hash){if(f-u==2){g<u&&(i[g]=i[u],i[u]=null);let y=i[g],w=i[f-1];y.type=y.isTunnel!==w.isTunnel?"tunnel":"polygon",y.connection={a:y.connection.a,b:w.connection.a},g++}u=f}while(u!==i.length);return i.splice(g),i.sort((y,w)=>y.hash<w.hash?1:-1),{portals:i}}}Tt(th,"ElevationPortalGraph"),Tt(sv,"ElevationPolygons");class YE{constructor(e,i,s){this.outPositions=e,this.outNormals=i,this.outIndices=s,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,i,s){let a=e[2];s!=null&&(a*=s);let h=this.getVec3Bits(e)<<96n|this.getVec3Bits(i),u=this.vertexLookup.get(h);if(u!=null)return u;let f=this.outPositions.length;this.vertexLookup.set(h,f);let g=Math.trunc(16384*i[0]),y=Math.trunc(16384*i[1]),w=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],a),this.outNormals.emplaceBack(g,y,w),f}addTriangle(e,i,s){this.outIndices.emplaceBack(e,i,s)}addTriangles(e,i,s){if(e.length===0)return;let a=s.length===1,h=mt(),u=mt();for(let f=0;f<e.length;f+=3){let g=i[e[f+0]],y=i[e[f+1]],w=i[e[f+2]],E=a?s[0]:s[e[f+1]],I=a?s[0]:s[e[f+2]];mi(h,g.x,g.y,a?s[0]:s[e[f+0]]);let R=this.addVertex(h,u);mi(h,y.x,y.y,E);let L=this.addVertex(h,u);mi(h,w.x,w.y,I);let k=this.addVertex(h,u);this.outIndices.emplaceBack(R,L,k)}}addQuad(e,i,s,a,h,u){let f=this.addVertex(e,h,u),g=this.addVertex(i,h,u),y=this.addVertex(s,h,u),w=this.addVertex(a,h,u);this.addTriangle(f,g,y),this.addTriangle(y,w,f)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class Eo{constructor(e,i,s,a){this.unevaluatedPortals=new th,this.portalPolygons=new sv,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new np,this.vertexNormals=new op,this.indexArray=new ur,this.tileToMeters=se(e),this.bridgeProgramConfigurations=new vo(i,{zoom:s,lut:a},h=>h!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new vo(i,{zoom:s,lut:a},h=>h!=="fill-bridge-guard-rail-color")}addVertices(e,i){let s=this.unevalVertices.length;for(let a=0;a<e.length;a++)this.unevalVertices.push(e[a]),this.unevalHeights.push(i[a]);return s}addTriangles(e,i,s){let a=s?this.unevalTunnelTriangles:this.unevalTriangles;for(let h of e)a.push(h+i)}addRenderableRing(e,i,s,a,h,u){let f=[new Qe(h.min.x,h.min.y),new Qe(h.max.x,h.min.y),new Qe(h.max.x,h.max.y),new Qe(h.min.x,h.max.y)];for(let g=0;g<s-1;g++){let y=i+g,w=y+1,E=this.unevalVertices[y],I=this.unevalVertices[w];if(!(E.x>=h.min.x&&E.x<=h.max.x&&E.y>=h.min.y&&E.y<=h.max.y||I.x>=h.min.x&&I.x<=h.max.x&&I.y>=h.min.y&&I.y<=h.max.y||Sr(E,I,f))||this.isOnBorder(E.x,I.x)||this.isOnBorder(E.y,I.y))continue;let R=Eo.computeEdgeHash(this.unevalVertices[y],this.unevalVertices[w]),L,k=this.vertexHashLookup.get(Eo.computePosHash(E));k!=null?L=k.next:(k=this.vertexHashLookup.get(Eo.computePosHash(I)),L=k!=null?k.prev:R),this.unevalEdges.push({polygonIdx:e,a:y,b:w,hash:R,portalHash:L,isTunnel:a,type:"unevaluated",featureInfo:u})}}addPortalCandidates(e,i,s,a,h){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:h});let u=i[0];this.vertexHashLookup.clear();let f=Eo.computeEdgeHash(u[u.length-2],u[u.length-1]);for(let g=0;g<u.length-1;g++){let y=u[g+0],w=u[g+1],E=uo(w.x-y.x,w.y-y.y),I=Us(E);if(I===0)continue;let R="unevaluated",L=a.pointElevation(y),k=a.pointElevation(w);Math.abs(L)<.01&&Math.abs(k)<.01?R="entrance":(this.isOnBorder(y.x,w.x)||this.isOnBorder(y.y,w.y))&&(R="border");let B=Eo.computeEdgeHash(y,w);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:y,vb:w,vab:E,length:I,hash:B,isTunnel:s,type:R});let G=Eo.computePosHash(y);this.vertexHashLookup.set(G,{prev:f,next:B}),f=B}}construct(e){if(this.unevalVertices.length===0)return;let i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),s=I=>{I.primitiveLength=this.indexArray.length-I.primitiveOffset},a=new YE(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);let h=i(),u=i(),f=i(),g=(I,R)=>{I.sort((k,B)=>k.type===R&&B.type!==R?-1:k.type!==R&&B.type===R?1:0);let L=I.findIndex(k=>k.type!==R);return L>=0?L:I.length},y=0;this.unevalEdges.length>0&&(y=g(this.unevalEdges,"none"),this.constructBridgeStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:y},this.tileToMeters)),s(f);let w=i(),E=i();if(this.unevalEdges.length>0){let I=this.unevalEdges.splice(y),R=g(I,"tunnel")+y;this.unevalEdges.push(...I),this.constructTunnelStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:y},{min:y,max:R})}s(w),a.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),s(E),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),s(u),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),s(h),this.maskSegments=gr.simpleSegment(0,E.primitiveOffset,0,E.primitiveLength),this.depthSegments=gr.simpleSegment(0,u.primitiveOffset,0,u.primitiveLength),this.renderableBridgeSegments=gr.simpleSegment(0,f.primitiveOffset,0,f.primitiveLength),this.renderableTunnelSegments=gr.simpleSegment(0,w.primitiveOffset,0,w.primitiveLength),this.shadowCasterSegments=gr.simpleSegment(0,h.primitiveOffset,0,h.primitiveLength)}update(e,i,s,a,h,u,f,g){this.bridgeProgramConfigurations.updatePaintArrays(e,i,h,s,a,u,f,g),this.tunnelProgramConfigurations.updatePaintArrays(e,i,h,s,a,u,f,g)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,BE.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,NE.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,s,a,h){let u=(f,g)=>{for(let y=0;y<g.length-1;y++){let w=g[y].featureIndex,E=g[y+1].vertexStart,I=e.feature(w);f.populatePaintArrays(E,I,w,{},s,i,a,void 0,h)}};u(this.bridgeProgramConfigurations,this.bridgeFeatureSections),u(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,s,a,h){let u=new Map;for(let f=a;f<h;f++){let g=s[f],y=g.a,w=g.b,E=Eo.computePosHash(e[y]),I=Eo.computePosHash(e[w]),R=u.get(E);R||(R={},u.set(E,R));let L=u.get(I);L||(L={},u.set(I,L)),i[y]<=0&&i[w]<=0||(R.to=w,L.from=y)}return u}isTerminalVertex(e,i){let s=Eo.computePosHash(this.unevalVertices[e]),a=i.get(s);return!a||!a.from||!a.to}constructBridgeStructures(e,i,s,a,h,u){e.clearVertexLookup();let f=this.computeVertexConnections(i,s,a,h.min,h.max),g=1/u,y=.5*g,w=(Ke,it)=>mi(Ke,i[it].x,i[it].y,s[it]*g),E=mt(),I=mt(),R=mt(),L=mt(),k=mt(),B=(Ke,it)=>{let Fe=f.get(Eo.computePosHash(i[it])),Je=Fe.from,Ie=Fe.to;if(!Je||!Ie)return;w(E,Je),w(I,it),w(R,Ie),nc(L),Lo(E,I)||(zr(k,I,E),Oi(L,k)),Lo(R,I)||(zr(k,R,I),vi(L,L,Oi(k,k)));let Be=Bs(L);return Be>0?Xi(Ke,L,1/Be):void 0},G=Number.POSITIVE_INFINITY;this.sortSubarray(a,h.min,h.max,(Ke,it)=>Ke.featureInfo.featureIndex-it.featureInfo.featureIndex);let X=mt(),W=mt(),K=mt(),pe=mt(),ce=mt(),ue=mt(),ge=mt(),ve=mt(),Ne=mt(),Ee=[mt(),mt(),mt(),mt()],Ue=[mt(),mt(),mt(),mt()],nt=[{coord:new Qe(0,0),height:0},{coord:new Qe(0,0),height:0}],qe=(Ke,it)=>Ke>it;for(let Ke=h.min;Ke<h.max;Ke++){let it=a[Ke];if(!it.featureInfo.guardRailEnabled||!this.prepareEdgePoints(nt,i,s,it,qe))continue;let[Fe,Je]=nt;if(mi(X,Fe.coord.x,Fe.coord.y,g*Fe.height),mi(W,Je.coord.x,Je.coord.y,g*Je.height),Lo(X,W))continue;zr(K,W,X),Oi(K,K);let Ie=B(ve,it.a)||K,Be=B(Ne,it.b)||K;mi(pe,Ie[1],-Ie[0],0),Oi(pe,pe),mi(ce,Be[1],-Be[0],0),Oi(ce,ce),Vr(ve,pe,Ie),Oi(ue,ve),Vr(ve,ce,Be),Oi(ge,ve),vi(Ee[0],X,Xi(ve,zr(ve,pe,ue),y)),vi(Ee[1],X,Xi(ve,vi(ve,pe,ue),y)),vi(Ee[2],X,Xi(ve,ue,y)),Ee[3]=X,vi(Ue[0],W,Xi(ve,zr(ve,ce,ge),y)),vi(Ue[1],W,Xi(ve,vi(ve,ce,ge),y)),vi(Ue[2],W,Xi(ve,ge,y)),Ue[3]=W,G=this.addFeatureSection(it.featureInfo.featureIndex,G,this.bridgeFeatureSections,e);let at=e.addVertex(Ee[0],pe,u),et=e.addVertex(Ee[1],pe,u),Lt=e.addVertex(Ue[0],ce,u),St=e.addVertex(Ue[1],ce,u);e.addTriangle(at,et,Lt),e.addTriangle(et,St,Lt);let Xe=e.addVertex(Ee[1],ue,u),tt=e.addVertex(Ee[2],ue,u),It=e.addVertex(Ue[1],ge,u),xt=e.addVertex(Ue[2],ge,u);e.addTriangle(Xe,tt,It),e.addTriangle(tt,xt,It),Zo(pe,pe),Zo(ce,ce);let ut=e.addVertex(Ee[2],pe,u),vt=e.addVertex(Ee[3],pe,u),Vt=e.addVertex(Ue[2],ce,u),Zt=e.addVertex(Ue[3],ce,u);e.addTriangle(ut,vt,Vt),e.addTriangle(vt,Zt,Vt);let Qt=this.isTerminalVertex(it.a,f),Kt=this.isTerminalVertex(it.b,f);Fe.height<.01&&Qt&&e.addQuad(Ee[3],Ee[2],Ee[1],Ee[0],Zo(Ie,Ie),u),Je.height<.01&&Kt&&e.addQuad(Ue[0],Ue[1],Ue[2],Ue[3],Be,u)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,s,a,h,u){e.clearVertexLookup();let f=Number.POSITIVE_INFINITY,g=(G,X)=>G.featureInfo.featureIndex-X.featureInfo.featureIndex;this.sortSubarray(a,h.min,h.max,g),this.sortSubarray(a,u.min,u.max,g);let y=G=>Oi(G,G),w=[{coord:new Qe(0,0),height:0},{coord:new Qe(0,0),height:0}],E=(G,X)=>G<X,I=mt(),R=mt(),L=mt(),k=mt(),B=mt();for(let G=h.min;G<h.max;G++){if(!this.prepareEdgePoints(w,i,s,a[G],E))continue;let[X,W]=w,K=y(mi(B,-(W.coord.y-X.coord.y),W.coord.x-X.coord.x,0));f=this.addFeatureSection(a[G].featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(mi(I,X.coord.x,X.coord.y,X.height),mi(R,W.coord.x,W.coord.y,W.height),mi(L,W.coord.x,W.coord.y,a[G].isTunnel?-.1:0),mi(k,X.coord.x,X.coord.y,a[G].isTunnel?-.1:0),K)}for(let G=u.min;G<u.max;G++){let X=a[G];X.isTunnel&&([X.a,X.b]=[X.b,X.a]);let W=i[X.a],K=i[X.b],pe=y(mi(B,-(K.y-W.y),K.x-W.x,0));f=this.addFeatureSection(X.featureInfo.featureIndex,f,this.tunnelFeatureSections,e),e.addQuad(mi(I,K.x,K.y,0),mi(R,W.x,W.y,0),mi(L,W.x,W.y,s[X.a]+4),mi(k,K.x,K.y,s[X.b]+4),pe),e.addQuad(mi(I,W.x,W.y,0),mi(R,K.x,K.y,0),mi(L,K.x,K.y,s[X.b]+4),mi(k,W.x,W.y,s[X.a]+4),pe)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,i,s,a){e.coord.x=i,e.coord.y=s,e.height=a}prepareEdgePoints(e,i,s,a,h){let u=i[a.a].x,f=i[a.a].y,g=i[a.b].x,y=i[a.b].y,w=s[a.a],E=s[a.b],I=h(w,0),R=h(E,0);if(I&&R)return this.setElevatedPoint(e[0],u,f,w),this.setElevatedPoint(e[1],g,y,E),!0;if(!I&&!R)return!1;if(I){if(!R){let L=E/(E-w);g=Bt(g,u,L),y=Bt(y,f,L),E=Bt(E,w,L)}}else{let L=w/(w-E);u=Bt(u,g,L),f=Bt(f,y,L),w=Bt(w,E,L)}return this.setElevatedPoint(e[0],u,f,w),this.setElevatedPoint(e[1],g,y,E),!0}prepareEdges(e,i){if(i.length===0)return;i.sort((f,g)=>f.hash===g.hash?g.polygonIdx-f.polygonIdx:g.hash>f.hash?1:-1);let s=0,a=0,h=0,u=i[s].polygonIdx;do a++,(a===i.length||i[s].hash!==i[a].hash)&&((a-s==1||i[a-1].polygonIdx!==u)&&(h<s&&(i[h]=i[s],i[s]=null),i[h].type="none",h++),s=a,s!==i.length&&(u=i[s].polygonIdx));while(s!==i.length);if(i.splice(h),i.length!==0&&e.length!==0){i.sort((y,w)=>y.portalHash<w.portalHash?1:-1);let f=0,g=0;for(;f!==i.length&&g!==e.length;){let y=i[f],w=e[g];y.portalHash>w.hash?f++:w.hash>y.portalHash?g++:(y.type=w.type,f++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=ht&&i>=ht}addFeatureSection(e,i,s,a){return e!==i&&(i=e,s.push({featureIndex:e,vertexStart:a.getVertexCount()}),a.clearVertexLookup()),i}sortSubarray(e,i,s,a){let h=e.slice(i,s);h.sort(a),e.splice(i,h.length,...h)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(Eo.computePosHash(e))<<32n|BigInt(Eo.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var av,lv={exports:{}},cv=(av||(av=1,function(r,e){(function(i){function s(ee,te){return ee>te?1:ee<te?-1:0}var a=function(ee,te){ee===void 0&&(ee=s),te===void 0&&(te=!1),this._compare=ee,this._root=null,this._size=0,this._noDuplicates=!!te},h={size:{configurable:!0}};function u(ee,te,Oe,lt,pt){var dt=pt-lt;if(dt>0){var Et=lt+Math.floor(dt/2),qt={key:te[Et],data:Oe[Et],parent:ee};return qt.left=u(qt,te,Oe,lt,Et),qt.right=u(qt,te,Oe,Et+1,pt),qt}return null}function f(ee,te,Oe,lt,pt){if(!(Oe>=lt)){for(var dt=ee[Oe+lt>>1],Et=Oe-1,qt=lt+1;;){do Et++;while(pt(ee[Et],dt)<0);do qt--;while(pt(ee[qt],dt)>0);if(Et>=qt)break;var ci=ee[Et];ee[Et]=ee[qt],ee[qt]=ci,ci=te[Et],te[Et]=te[qt],te[qt]=ci}f(ee,te,Oe,qt,pt),f(ee,te,qt+1,lt,pt)}}a.prototype.rotateLeft=function(ee){var te=ee.right;te&&(ee.right=te.left,te.left&&(te.left.parent=ee),te.parent=ee.parent),ee.parent?ee===ee.parent.left?ee.parent.left=te:ee.parent.right=te:this._root=te,te&&(te.left=ee),ee.parent=te},a.prototype.rotateRight=function(ee){var te=ee.left;te&&(ee.left=te.right,te.right&&(te.right.parent=ee),te.parent=ee.parent),ee.parent?ee===ee.parent.left?ee.parent.left=te:ee.parent.right=te:this._root=te,te&&(te.right=ee),ee.parent=te},a.prototype._splay=function(ee){for(;ee.parent;){var te=ee.parent;te.parent?te.left===ee&&te.parent.left===te?(this.rotateRight(te.parent),this.rotateRight(te)):te.right===ee&&te.parent.right===te?(this.rotateLeft(te.parent),this.rotateLeft(te)):te.left===ee&&te.parent.right===te?(this.rotateRight(te),this.rotateLeft(te)):(this.rotateLeft(te),this.rotateRight(te)):te.left===ee?this.rotateRight(te):this.rotateLeft(te)}},a.prototype.splay=function(ee){for(var te,Oe,lt,pt,dt;ee.parent;)(Oe=(te=ee.parent).parent)&&Oe.parent?((lt=Oe.parent).left===Oe?lt.left=ee:lt.right=ee,ee.parent=lt):(ee.parent=null,this._root=ee),pt=ee.left,dt=ee.right,ee===te.left?(Oe&&(Oe.left===te?(te.right?(Oe.left=te.right,Oe.left.parent=Oe):Oe.left=null,te.right=Oe,Oe.parent=te):(pt?(Oe.right=pt,pt.parent=Oe):Oe.right=null,ee.left=Oe,Oe.parent=ee)),dt?(te.left=dt,dt.parent=te):te.left=null,ee.right=te,te.parent=ee):(Oe&&(Oe.right===te?(te.left?(Oe.right=te.left,Oe.right.parent=Oe):Oe.right=null,te.left=Oe,Oe.parent=te):(dt?(Oe.left=dt,dt.parent=Oe):Oe.left=null,ee.right=Oe,Oe.parent=ee)),pt?(te.right=pt,pt.parent=te):te.right=null,ee.left=te,te.parent=ee)},a.prototype.replace=function(ee,te){ee.parent?ee===ee.parent.left?ee.parent.left=te:ee.parent.right=te:this._root=te,te&&(te.parent=ee.parent)},a.prototype.minNode=function(ee){if(ee===void 0&&(ee=this._root),ee)for(;ee.left;)ee=ee.left;return ee},a.prototype.maxNode=function(ee){if(ee===void 0&&(ee=this._root),ee)for(;ee.right;)ee=ee.right;return ee},a.prototype.insert=function(ee,te){var Oe=this._root,lt=null,pt=this._compare;if(this._noDuplicates)for(;Oe;){if(lt=Oe,pt(Oe.key,ee)===0)return;Oe=pt(Oe.key,ee)<0?Oe.right:Oe.left}else for(;Oe;)lt=Oe,Oe=pt(Oe.key,ee)<0?Oe.right:Oe.left;return Oe={key:ee,data:te,left:null,right:null,parent:lt},lt?pt(lt.key,Oe.key)<0?lt.right=Oe:lt.left=Oe:this._root=Oe,this.splay(Oe),this._size++,Oe},a.prototype.find=function(ee){for(var te=this._root,Oe=this._compare;te;){var lt=Oe(te.key,ee);if(lt<0)te=te.right;else{if(!(lt>0))return te;te=te.left}}return null},a.prototype.contains=function(ee){for(var te=this._root,Oe=this._compare;te;){var lt=Oe(ee,te.key);if(lt===0)return!0;te=lt<0?te.left:te.right}return!1},a.prototype.remove=function(ee){var te=this.find(ee);if(!te)return!1;if(this.splay(te),te.left)if(te.right){var Oe=this.minNode(te.right);Oe.parent!==te&&(this.replace(Oe,Oe.right),Oe.right=te.right,Oe.right.parent=Oe),this.replace(te,Oe),Oe.left=te.left,Oe.left.parent=Oe}else this.replace(te,te.left);else this.replace(te,te.right);return this._size--,!0},a.prototype.removeNode=function(ee){if(!ee)return!1;if(this.splay(ee),ee.left)if(ee.right){var te=this.minNode(ee.right);te.parent!==ee&&(this.replace(te,te.right),te.right=ee.right,te.right.parent=te),this.replace(ee,te),te.left=ee.left,te.left.parent=te}else this.replace(ee,ee.left);else this.replace(ee,ee.right);return this._size--,!0},a.prototype.erase=function(ee){var te=this.find(ee);if(te){this.splay(te);var Oe=te.left,lt=te.right,pt=null;Oe&&(Oe.parent=null,pt=this.maxNode(Oe),this.splay(pt),this._root=pt),lt&&(Oe?pt.right=lt:this._root=lt,lt.parent=pt),this._size--}},a.prototype.pop=function(){var ee=this._root,te=null;if(ee){for(;ee.left;)ee=ee.left;te={key:ee.key,data:ee.data},this.remove(ee.key)}return te},a.prototype.next=function(ee){var te=ee;if(te)if(te.right)for(te=te.right;te&&te.left;)te=te.left;else for(te=ee.parent;te&&te.right===ee;)ee=te,te=te.parent;return te},a.prototype.prev=function(ee){var te=ee;if(te)if(te.left)for(te=te.left;te&&te.right;)te=te.right;else for(te=ee.parent;te&&te.left===ee;)ee=te,te=te.parent;return te},a.prototype.forEach=function(ee){for(var te=this._root,Oe=[],lt=!1,pt=0;!lt;)te?(Oe.push(te),te=te.left):Oe.length>0?(ee(te=Oe.pop(),pt++),te=te.right):lt=!0;return this},a.prototype.range=function(ee,te,Oe,lt){for(var pt=[],dt=this._compare,Et=this._root;pt.length!==0||Et;)if(Et)pt.push(Et),Et=Et.left;else{if(dt((Et=pt.pop()).key,te)>0)break;if(dt(Et.key,ee)>=0&&Oe.call(lt,Et))return this;Et=Et.right}return this},a.prototype.keys=function(){for(var ee=this._root,te=[],Oe=[],lt=!1;!lt;)ee?(te.push(ee),ee=ee.left):te.length>0?(ee=te.pop(),Oe.push(ee.key),ee=ee.right):lt=!0;return Oe},a.prototype.values=function(){for(var ee=this._root,te=[],Oe=[],lt=!1;!lt;)ee?(te.push(ee),ee=ee.left):te.length>0?(ee=te.pop(),Oe.push(ee.data),ee=ee.right):lt=!0;return Oe},a.prototype.at=function(ee){for(var te=this._root,Oe=[],lt=!1,pt=0;!lt;)if(te)Oe.push(te),te=te.left;else if(Oe.length>0){if(te=Oe.pop(),pt===ee)return te;pt++,te=te.right}else lt=!0;return null},a.prototype.load=function(ee,te,Oe){if(ee===void 0&&(ee=[]),te===void 0&&(te=[]),Oe===void 0&&(Oe=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var lt=ee.length;return Oe&&f(ee,te,0,lt-1,this._compare),this._root=u(null,ee,te,0,lt),this._size=lt,this},a.prototype.min=function(){var ee=this.minNode(this._root);return ee?ee.key:null},a.prototype.max=function(){var ee=this.maxNode(this._root);return ee?ee.key:null},a.prototype.isEmpty=function(){return this._root===null},h.size.get=function(){return this._size},a.createTree=function(ee,te,Oe,lt,pt){return new a(Oe,pt).load(ee,te,lt)},Object.defineProperties(a.prototype,h);var g=0,y=1,w=2,E=3,I=0,R=1,L=2,k=3;function B(ee,te,Oe){te===null?(ee.inOut=!1,ee.otherInOut=!0):(ee.isSubject===te.isSubject?(ee.inOut=!te.inOut,ee.otherInOut=te.otherInOut):(ee.inOut=!te.otherInOut,ee.otherInOut=te.isVertical()?!te.inOut:te.inOut),te&&(ee.prevInResult=!G(te,Oe)||te.isVertical()?te.prevInResult:te));var lt=G(ee,Oe);ee.resultTransition=lt?function(pt,dt){var Et,qt=!pt.inOut,ci=!pt.otherInOut;switch(dt){case I:Et=qt&&ci;break;case R:Et=qt||ci;break;case k:Et=qt^ci;break;case L:Et=pt.isSubject?qt&&!ci:ci&&!qt}return Et?1:-1}(ee,Oe):0}function G(ee,te){switch(ee.type){case g:switch(te){case I:return!ee.otherInOut;case R:return ee.otherInOut;case L:return ee.isSubject&&ee.otherInOut||!ee.isSubject&&!ee.otherInOut;case k:return!0}break;case w:return te===I||te===R;case E:return te===L;case y:return!1}return!1}var X=function(ee,te,Oe,lt,pt){this.left=te,this.point=ee,this.otherEvent=Oe,this.isSubject=lt,this.type=pt||g,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},W={inResult:{configurable:!0}};function K(ee,te){return ee[0]===te[0]&&ee[1]===te[1]}X.prototype.isBelow=function(ee){var te=this.point,Oe=this.otherEvent.point;return this.left?(te[0]-ee[0])*(Oe[1]-ee[1])-(Oe[0]-ee[0])*(te[1]-ee[1])>0:(Oe[0]-ee[0])*(te[1]-ee[1])-(te[0]-ee[0])*(Oe[1]-ee[1])>0},X.prototype.isAbove=function(ee){return!this.isBelow(ee)},X.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},W.inResult.get=function(){return this.resultTransition!==0},X.prototype.clone=function(){var ee=new X(this.point,this.left,this.otherEvent,this.isSubject,this.type);return ee.contourId=this.contourId,ee.resultTransition=this.resultTransition,ee.prevInResult=this.prevInResult,ee.isExteriorRing=this.isExteriorRing,ee.inOut=this.inOut,ee.otherInOut=this.otherInOut,ee},Object.defineProperties(X.prototype,W);var pe=11102230246251565e-32,ce=134217729,ue=(3+8*pe)*pe;function ge(ee,te,Oe,lt,pt){var dt,Et,qt,ci,hi=te[0],ii=lt[0],Gi=0,Tr=0;ii>hi==ii>-hi?(dt=hi,hi=te[++Gi]):(dt=ii,ii=lt[++Tr]);var ei=0;if(Gi<ee&&Tr<Oe)for(ii>hi==ii>-hi?(qt=dt-((Et=hi+dt)-hi),hi=te[++Gi]):(qt=dt-((Et=ii+dt)-ii),ii=lt[++Tr]),dt=Et,qt!==0&&(pt[ei++]=qt);Gi<ee&&Tr<Oe;)ii>hi==ii>-hi?(qt=dt-((Et=dt+hi)-(ci=Et-dt))+(hi-ci),hi=te[++Gi]):(qt=dt-((Et=dt+ii)-(ci=Et-dt))+(ii-ci),ii=lt[++Tr]),dt=Et,qt!==0&&(pt[ei++]=qt);for(;Gi<ee;)qt=dt-((Et=dt+hi)-(ci=Et-dt))+(hi-ci),hi=te[++Gi],dt=Et,qt!==0&&(pt[ei++]=qt);for(;Tr<Oe;)qt=dt-((Et=dt+ii)-(ci=Et-dt))+(ii-ci),ii=lt[++Tr],dt=Et,qt!==0&&(pt[ei++]=qt);return dt===0&&ei!==0||(pt[ei++]=dt),ei}function ve(ee){return new Float64Array(ee)}var Ne=33306690738754716e-32,Ee=22204460492503146e-32,Ue=11093356479670487e-47,nt=ve(4),qe=ve(8),Ke=ve(12),it=ve(16),Fe=ve(4);function Je(ee,te,Oe){var lt=function(pt,dt,Et,qt,ci,hi){var ii=(dt-hi)*(Et-ci),Gi=(pt-ci)*(qt-hi),Tr=ii-Gi;if(ii===0||Gi===0||ii>0!=Gi>0)return Tr;var ei=Math.abs(ii+Gi);return Math.abs(Tr)>=Ne*ei?Tr:-function(ar,Ji,Bi,xr,rr,Qi,tr){var Ui,ri,qi,vr,jt,xi,nr,Er,lr,Yr,Zi,jr,to,bn,_n,io,da,Kr,rn=ar-rr,wn=Bi-rr,Fn=Ji-Qi,Pn=xr-Qi;nt[0]=(_n=(Er=rn-(nr=(xi=ce*rn)-(xi-rn)))*(Yr=Pn-(lr=(xi=ce*Pn)-(xi-Pn)))-((bn=rn*Pn)-nr*lr-Er*lr-nr*Yr))-((Zi=_n-(da=(Er=Fn-(nr=(xi=ce*Fn)-(xi-Fn)))*(Yr=wn-(lr=(xi=ce*wn)-(xi-wn)))-((io=Fn*wn)-nr*lr-Er*lr-nr*Yr)))+(jt=_n-Zi))+(jt-da),nt[1]=(to=bn-((jr=bn+Zi)-(jt=jr-bn))+(Zi-jt))-((Zi=to-io)+(jt=to-Zi))+(jt-io),nt[2]=jr-((Kr=jr+Zi)-(jt=Kr-jr))+(Zi-jt),nt[3]=Kr;var Hl=function(wz,bw){for(var ww=bw[0],o0=1;o0<4;o0++)ww+=bw[o0];return ww}(0,nt),af=Ee*tr;if(Hl>=af||-Hl>=af||(Ui=ar-(rn+(jt=ar-rn))+(jt-rr),qi=Bi-(wn+(jt=Bi-wn))+(jt-rr),ri=Ji-(Fn+(jt=Ji-Fn))+(jt-Qi),vr=xr-(Pn+(jt=xr-Pn))+(jt-Qi),Ui===0&&ri===0&&qi===0&&vr===0)||(af=Ue*tr+ue*Math.abs(Hl),(Hl+=rn*vr+Pn*Ui-(Fn*qi+wn*ri))>=af||-Hl>=af))return Hl;Fe[0]=(_n=(Er=Ui-(nr=(xi=ce*Ui)-(xi-Ui)))*(Yr=Pn-(lr=(xi=ce*Pn)-(xi-Pn)))-((bn=Ui*Pn)-nr*lr-Er*lr-nr*Yr))-((Zi=_n-(da=(Er=ri-(nr=(xi=ce*ri)-(xi-ri)))*(Yr=wn-(lr=(xi=ce*wn)-(xi-wn)))-((io=ri*wn)-nr*lr-Er*lr-nr*Yr)))+(jt=_n-Zi))+(jt-da),Fe[1]=(to=bn-((jr=bn+Zi)-(jt=jr-bn))+(Zi-jt))-((Zi=to-io)+(jt=to-Zi))+(jt-io),Fe[2]=jr-((Kr=jr+Zi)-(jt=Kr-jr))+(Zi-jt),Fe[3]=Kr;var YM=ge(4,nt,4,Fe,qe);Fe[0]=(_n=(Er=rn-(nr=(xi=ce*rn)-(xi-rn)))*(Yr=vr-(lr=(xi=ce*vr)-(xi-vr)))-((bn=rn*vr)-nr*lr-Er*lr-nr*Yr))-((Zi=_n-(da=(Er=Fn-(nr=(xi=ce*Fn)-(xi-Fn)))*(Yr=qi-(lr=(xi=ce*qi)-(xi-qi)))-((io=Fn*qi)-nr*lr-Er*lr-nr*Yr)))+(jt=_n-Zi))+(jt-da),Fe[1]=(to=bn-((jr=bn+Zi)-(jt=jr-bn))+(Zi-jt))-((Zi=to-io)+(jt=to-Zi))+(jt-io),Fe[2]=jr-((Kr=jr+Zi)-(jt=Kr-jr))+(Zi-jt),Fe[3]=Kr;var KM=ge(YM,qe,4,Fe,Ke);Fe[0]=(_n=(Er=Ui-(nr=(xi=ce*Ui)-(xi-Ui)))*(Yr=vr-(lr=(xi=ce*vr)-(xi-vr)))-((bn=Ui*vr)-nr*lr-Er*lr-nr*Yr))-((Zi=_n-(da=(Er=ri-(nr=(xi=ce*ri)-(xi-ri)))*(Yr=qi-(lr=(xi=ce*qi)-(xi-qi)))-((io=ri*qi)-nr*lr-Er*lr-nr*Yr)))+(jt=_n-Zi))+(jt-da),Fe[1]=(to=bn-((jr=bn+Zi)-(jt=jr-bn))+(Zi-jt))-((Zi=to-io)+(jt=to-Zi))+(jt-io),Fe[2]=jr-((Kr=jr+Zi)-(jt=Kr-jr))+(Zi-jt),Fe[3]=Kr;var JM=ge(KM,Ke,4,Fe,it);return it[JM-1]}(pt,dt,Et,qt,ci,hi,ei)}(ee[0],ee[1],te[0],te[1],Oe[0],Oe[1]);return lt>0?-1:lt<0?1:0}function Ie(ee,te){var Oe=ee.point,lt=te.point;return Oe[0]>lt[0]?1:Oe[0]<lt[0]?-1:Oe[1]!==lt[1]?Oe[1]>lt[1]?1:-1:function(pt,dt,Et,qt){return pt.left!==dt.left?pt.left?1:-1:Je(Et,pt.otherEvent.point,dt.otherEvent.point)!==0?pt.isBelow(dt.otherEvent.point)?-1:1:!pt.isSubject&&dt.isSubject?1:-1}(ee,te,Oe)}function Be(ee,te,Oe){var lt=new X(te,!1,ee,ee.isSubject),pt=new X(te,!0,ee.otherEvent,ee.isSubject);return K(ee.point,ee.otherEvent.point)&&console.warn("what is that, a collapsed segment?",ee),lt.contourId=pt.contourId=ee.contourId,Ie(pt,ee.otherEvent)>0&&(ee.otherEvent.left=!0,pt.left=!1),ee.otherEvent.otherEvent=pt,ee.otherEvent=lt,Oe.push(pt),Oe.push(lt),Oe}function at(ee,te){return ee[0]*te[1]-ee[1]*te[0]}function et(ee,te){return ee[0]*te[0]+ee[1]*te[1]}function Lt(ee,te,Oe){var lt=function(ci,hi,ii,Gi,Tr){var ei=[hi[0]-ci[0],hi[1]-ci[1]],ar=[Gi[0]-ii[0],Gi[1]-ii[1]];function Ji(xi,nr,Er){return[xi[0]+nr*Er[0],xi[1]+nr*Er[1]]}var Bi=[ii[0]-ci[0],ii[1]-ci[1]],xr=at(ei,ar),rr=xr*xr,Qi=et(ei,ei);if(rr>0){var tr=at(Bi,ar)/xr;if(tr<0||tr>1)return null;var Ui=at(Bi,ei)/xr;return Ui<0||Ui>1?null:tr===0||tr===1?[Ji(ci,tr,ei)]:Ui===0||Ui===1?[Ji(ii,Ui,ar)]:[Ji(ci,tr,ei)]}if((rr=(xr=at(Bi,ei))*xr)>0)return null;var ri=et(ei,Bi)/Qi,qi=ri+et(ei,ar)/Qi,vr=Math.min(ri,qi),jt=Math.max(ri,qi);return vr<=1&&jt>=0?vr===1?[Ji(ci,vr>0?vr:0,ei)]:jt===0?[Ji(ci,jt<1?jt:1,ei)]:[Ji(ci,vr>0?vr:0,ei),Ji(ci,jt<1?jt:1,ei)]:null}(ee.point,ee.otherEvent.point,te.point,te.otherEvent.point),pt=lt?lt.length:0;if(pt===0||pt===1&&(K(ee.point,te.point)||K(ee.otherEvent.point,te.otherEvent.point))||pt===2&&ee.isSubject===te.isSubject)return 0;if(pt===1)return K(ee.point,lt[0])||K(ee.otherEvent.point,lt[0])||Be(ee,lt[0],Oe),K(te.point,lt[0])||K(te.otherEvent.point,lt[0])||Be(te,lt[0],Oe),1;var dt=[],Et=!1,qt=!1;return K(ee.point,te.point)?Et=!0:Ie(ee,te)===1?dt.push(te,ee):dt.push(ee,te),K(ee.otherEvent.point,te.otherEvent.point)?qt=!0:Ie(ee.otherEvent,te.otherEvent)===1?dt.push(te.otherEvent,ee.otherEvent):dt.push(ee.otherEvent,te.otherEvent),Et&&qt||Et?(te.type=y,ee.type=te.inOut===ee.inOut?w:E,Et&&!qt&&Be(dt[1].otherEvent,dt[0].point,Oe),2):qt?(Be(dt[0],dt[1].point,Oe),3):dt[0]!==dt[3].otherEvent?(Be(dt[0],dt[1].point,Oe),Be(dt[1],dt[2].point,Oe),3):(Be(dt[0],dt[1].point,Oe),Be(dt[3].otherEvent,dt[2].point,Oe),3)}function St(ee,te){if(ee===te)return 0;if(Je(ee.point,ee.otherEvent.point,te.point)!==0||Je(ee.point,ee.otherEvent.point,te.otherEvent.point)!==0)return K(ee.point,te.point)?ee.isBelow(te.otherEvent.point)?-1:1:ee.point[0]===te.point[0]?ee.point[1]<te.point[1]?-1:1:Ie(ee,te)===1?te.isAbove(ee.point)?-1:1:ee.isBelow(te.point)?-1:1;if(ee.isSubject!==te.isSubject)return ee.isSubject?-1:1;var Oe=ee.point,lt=te.point;return Oe[0]===lt[0]&&Oe[1]===lt[1]?(Oe=ee.otherEvent.point)[0]===(lt=te.otherEvent.point)[0]&&Oe[1]===lt[1]?0:ee.contourId>te.contourId?1:-1:Ie(ee,te)===1?1:-1}var Xe=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function tt(ee,te,Oe,lt){var pt,dt=ee+1,Et=te[ee].point,qt=te.length;for(dt<qt&&(pt=te[dt].point);dt<qt&&pt[0]===Et[0]&&pt[1]===Et[1];){if(!Oe[dt])return dt;++dt<qt&&(pt=te[dt].point)}for(dt=ee-1;Oe[dt]&&dt>lt;)dt--;return dt}Xe.prototype.isExterior=function(){return this.holeOf==null};var It=ut,xt=ut;function ut(ee,te){if(!(this instanceof ut))return new ut(ee,te);if(this.data=ee||[],this.length=this.data.length,this.compare=te||vt,this.length>0)for(var Oe=(this.length>>1)-1;Oe>=0;Oe--)this._down(Oe)}function vt(ee,te){return ee<te?-1:ee>te?1:0}ut.prototype={push:function(ee){this.data.push(ee),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var ee=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),ee}},peek:function(){return this.data[0]},_up:function(ee){for(var te=this.data,Oe=this.compare,lt=te[ee];ee>0;){var pt=ee-1>>1,dt=te[pt];if(Oe(lt,dt)>=0)break;te[ee]=dt,ee=pt}te[ee]=lt},_down:function(ee){for(var te=this.data,Oe=this.compare,lt=this.length>>1,pt=te[ee];ee<lt;){var dt=1+(ee<<1),Et=dt+1,qt=te[dt];if(Et<this.length&&Oe(te[Et],qt)<0&&(dt=Et,qt=te[Et]),Oe(qt,pt)>=0)break;te[ee]=qt,ee=dt}te[ee]=pt}},It.default=xt;var Vt=Math.max,Zt=Math.min,Qt=0;function Kt(ee,te,Oe,lt,pt,dt){var Et,qt,ci,hi,ii,Gi;for(Et=0,qt=ee.length-1;Et<qt;Et++)if(hi=ee[Et+1],ii=new X(ci=ee[Et],!1,void 0,te),Gi=new X(hi,!1,ii,te),ii.otherEvent=Gi,ci[0]!==hi[0]||ci[1]!==hi[1]){ii.contourId=Gi.contourId=Oe,dt||(ii.isExteriorRing=!1,Gi.isExteriorRing=!1),Ie(ii,Gi)>0?Gi.left=!0:ii.left=!0;var Tr=ci[0],ei=ci[1];pt[0]=Zt(pt[0],Tr),pt[1]=Zt(pt[1],ei),pt[2]=Vt(pt[2],Tr),pt[3]=Vt(pt[3],ei),lt.push(ii),lt.push(Gi)}}var fi=[];function oi(ee,te,Oe){typeof ee[0][0][0]=="number"&&(ee=[ee]),typeof te[0][0][0]=="number"&&(te=[te]);var lt=function(ei,ar,Ji){var Bi=null;return ei.length*ar.length==0&&(Ji===I?Bi=fi:Ji===L?Bi=ei:Ji!==R&&Ji!==k||(Bi=ei.length===0?ar:ei)),Bi}(ee,te,Oe);if(lt)return lt===fi?null:lt;var pt=[1/0,1/0,-1/0,-1/0],dt=[1/0,1/0,-1/0,-1/0],Et=function(ei,ar,Ji,Bi,xr){var rr,Qi,tr,Ui,ri,qi,vr=new It(null,Ie);for(tr=0,Ui=ei.length;tr<Ui;tr++)for(ri=0,qi=(rr=ei[tr]).length;ri<qi;ri++)(Qi=ri===0)&&Qt++,Kt(rr[ri],!0,Qt,vr,Ji,Qi);for(tr=0,Ui=ar.length;tr<Ui;tr++)for(ri=0,qi=(rr=ar[tr]).length;ri<qi;ri++)Qi=ri===0,xr===L&&(Qi=!1),Qi&&Qt++,Kt(rr[ri],!1,Qt,vr,Bi,Qi);return vr}(ee,te,pt,dt,Oe);if(lt=function(ei,ar,Ji,Bi,xr){var rr=null;return(Ji[0]>Bi[2]||Bi[0]>Ji[2]||Ji[1]>Bi[3]||Bi[1]>Ji[3])&&(xr===I?rr=fi:xr===L?rr=ei:xr!==R&&xr!==k||(rr=ei.concat(ar))),rr}(ee,te,pt,dt,Oe))return lt===fi?null:lt;for(var qt=function(ei){var ar,Ji,Bi=function(tr){var Ui,ri,qi,vr,jt=[];for(ri=0,qi=tr.length;ri<qi;ri++)((Ui=tr[ri]).left&&Ui.inResult||!Ui.left&&Ui.otherEvent.inResult)&&jt.push(Ui);for(var xi=!1;!xi;)for(xi=!0,ri=0,qi=jt.length;ri<qi;ri++)ri+1<qi&&Ie(jt[ri],jt[ri+1])===1&&(vr=jt[ri],jt[ri]=jt[ri+1],jt[ri+1]=vr,xi=!1);for(ri=0,qi=jt.length;ri<qi;ri++)(Ui=jt[ri]).otherPos=ri;for(ri=0,qi=jt.length;ri<qi;ri++)(Ui=jt[ri]).left||(vr=Ui.otherPos,Ui.otherPos=Ui.otherEvent.otherPos,Ui.otherEvent.otherPos=vr);return jt}(ei),xr={},rr=[],Qi=function(){if(!xr[ar]){var tr=rr.length,Ui=function(jt,xi,nr){var Er=new Xe;if(jt.prevInResult!=null){var lr=jt.prevInResult,Yr=lr.outputContourId;if(lr.resultTransition>0){var Zi=xi[Yr];if(Zi.holeOf!=null){var jr=Zi.holeOf;xi[jr].holeIds.push(nr),Er.holeOf=jr,Er.depth=xi[Yr].depth}else xi[Yr].holeIds.push(nr),Er.holeOf=Yr,Er.depth=xi[Yr].depth+1}else Er.holeOf=null,Er.depth=xi[Yr].depth}else Er.holeOf=null,Er.depth=0;return Er}(Bi[ar],rr,tr),ri=function(jt){xr[jt]=!0,jt<Bi.length&&Bi[jt]&&(Bi[jt].outputContourId=tr)},qi=ar,vr=ar;for(Ui.points.push(Bi[ar].point);ri(qi),ri(qi=Bi[qi].otherPos),Ui.points.push(Bi[qi].point),!((qi=tt(qi,Bi,xr,vr))==vr||qi>=Bi.length)&&Bi[qi];);rr.push(Ui)}};for(ar=0,Ji=Bi.length;ar<Ji;ar++)Qi();return rr}(function(ei,ar,Ji,Bi,xr,rr){for(var Qi,tr,Ui,ri=new a(St),qi=[],vr=Math.min(Bi[2],xr[2]);ei.length!==0;){var jt=ei.pop();if(qi.push(jt),rr===I&&jt.point[0]>vr||rr===L&&jt.point[0]>Bi[2])break;if(jt.left){tr=Qi=ri.insert(jt),Qi=Qi!==(Ui=ri.minNode())?ri.prev(Qi):null,tr=ri.next(tr);var xi=Qi?Qi.key:null;if(B(jt,xi,rr),tr&&Lt(jt,tr.key,ei)===2&&(B(jt,xi,rr),B(tr.key,jt,rr)),Qi&&Lt(Qi.key,jt,ei)===2){var nr=Qi;B(xi,(nr=nr!==Ui?ri.prev(nr):null)?nr.key:null,rr),B(jt,xi,rr)}}else tr=Qi=ri.find(jt=jt.otherEvent),Qi&&tr&&(Qi=Qi!==Ui?ri.prev(Qi):null,tr=ri.next(tr),ri.remove(jt),tr&&Qi&&Lt(Qi.key,tr.key,ei))}return qi}(Et,0,0,pt,dt,Oe)),ci=[],hi=0;hi<qt.length;hi++){var ii=qt[hi];if(ii.isExterior()){for(var Gi=[ii.points],Tr=0;Tr<ii.holeIds.length;Tr++)Gi.push(qt[ii.holeIds[Tr]].points);ci.push(Gi)}}return ci}var ir={UNION:R,DIFFERENCE:L,INTERSECTION:I,XOR:k};i.diff=function(ee,te){return oi(ee,te,L)},i.intersection=function(ee,te){return oi(ee,te,I)},i.operations=ir,i.union=function(ee,te){return oi(ee,te,R)},i.xor=function(ee,te){return oi(ee,te,k)},Object.defineProperty(i,"__esModule",{value:!0})})(e)}(0,lv.exports)),lv.exports);function jm(r,e,i,s){let a=[],h=s===0?(u,f,g,y,w,E)=>{u.push(new Qe(E,g+(E-f)/(y-f)*(w-g)))}:(u,f,g,y,w,E)=>{u.push(new Qe(f+(E-g)/(w-g)*(y-f),E))};for(let u of r){let f=[];for(let g of u){if(g.length<=2)continue;let y=[];for(let I=0;I<g.length-1;I++){let R=g[I].x,L=g[I].y,k=g[I+1].x,B=g[I+1].y,G=s===0?R:L,X=s===0?k:B;G<e?X>e&&h(y,R,L,k,B,e):G>i?X<i&&h(y,R,L,k,B,i):y.push(g[I]),X<e&&G>=e&&h(y,R,L,k,B,e),X>i&&G<=i&&h(y,R,L,k,B,i)}let w=g[g.length-1],E=s===0?w.x:w.y;E>=e&&E<=i&&y.push(w),y.length&&(w=y[y.length-1],y[0].x===w.x&&y[0].y===w.y||y.push(y[0]),f.push(y))}f.length&&a.push(f)}return a}function KE(r,e){let i=ty(r),s=ty([e]),a=cv.intersection(i,s);return a==null?[]:hv(a)}function JE(r,e){let s=ty(r,65536);for(;e.valid();e.next()){let[a,h]=e.get(),u=a.x*65536,f=a.y*65536,g=h.x*65536,y=h.y*65536,w=g-u,E=y-f,I=Math.hypot(w,E),R=Math.trunc(E/I*3),L=-Math.trunc(w/I*3);s=cv.diff(s,[[[u,f],[g,y],[g+R,y+L],[u+R,f+L],[u,f]]])}return hv(s,1/65536)}function ty(r,e=1){return[r.map(i=>i.map(s=>[s.x*e,s.y*e]))]}function hv(r,e=1){return r.map(i=>i.map((s,a)=>{let h=s.map(u=>new Qe(u[0]*e,u[1]*e).round());return a>0&&h.reverse(),h}))}class iy{constructor(e,i){this.layoutVertexArray=new $n,this.indexArray=new ur,this.lineIndexArray=new cs,this.triangleSegments=new gr,this.lineSegments=new gr,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new Fa)}update(e,i,s,a,h,u,f,g){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,g)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,kE.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,FE.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,s,a,h,u,f){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,s,a,h,u,void 0,f)}}class ry{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new iy(e,!1),this.elevationBufferData=new iy(e,!0),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.hasPattern=Qg("fill",this.layers,this.pixelRatio,i);let h=this.layers[0].layout.get("fill-sort-key"),u=[];for(let{feature:f,id:g,index:y,sourceLayerIndex:w}of e){let E=this.layers[0]._featureFilter.needGeometry,I=ke(f,E);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),I,s))continue;let R=h?h.evaluate(I,{},s,i.availableImages):void 0,L={id:g,properties:f.properties,type:f.type,sourceLayerIndex:w,index:y,geometry:E?I.geometry:me(f,s,a),patterns:{},sortKey:R};u.push(L)}h&&u.sort((f,g)=>f.sortKey-g.sortKey);for(let f of u){let{geometry:g,index:y,sourceLayerIndex:w}=f;if(this.hasPattern){let E=ey("fill",this.layers,f,this.zoom,this.pixelRatio,i);this.patternFeatures.push(E)}else this.addFeature(f,g,y,s,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[y].feature,g,y,w,this.index)}}update(e,i,s,a,h,u,f){this.bufferData.update(e,i,s,a,h,u,f,this.worldview),this.elevationBufferData.update(e,i,s,a,h,u,f,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,s,a,h,u,f,this.worldview)}addFeatures(e,i,s,a,h,u){for(let f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,s,a,u,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,s,a,h,u=[],f,g){let y=Cp(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,y,a,s,g):this.addGeometry(y,this.bufferData),this.bufferData.populatePaintArrays(e,s,h,u,a,f,this.worldview),this.elevationBufferData.populatePaintArrays(e,s,h,u,a,f,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,s,a,h){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,s,a,h,this.worldview))}addElevatedRoadFeature(e,i,s,a,h){let u=new Array,f=yr.getElevationFeature(e,h);if(!f)return void this.addGeometry(i,this.bufferData);{let y=this.clipPolygonsToTile(i,1);y.length>0&&u.push({polygons:y,elevationFeature:f,elevationTileID:s})}let g={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},s),featureIndex:a};for(let y of u)if(y.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Eo(y.elevationTileID,this.layers,this.zoom,this.lut));let E=y.elevationFeature.isTunnel(),I=0;e.properties.hasOwnProperty(zt)&&(I=+e.properties[zt]);for(let R of y.polygons)this.elevatedStructures.addPortalCandidates(y.elevationFeature.id,R,E,y.elevationFeature,I)}y.elevationFeature.constantHeight==null&&(y.polygons=this.prepareElevatedPolygons(y.polygons,y.elevationFeature,y.elevationTileID));let w=new bi(s,y.elevationTileID);this.addElevatedGeometry(y.polygons,w,y.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,a,g)}}addElevatedGeometry(e,i,s,a,h,u){let f={elevation:s,elevationSampler:i,bias:a,index:h,featureInfo:u},[g,y]=this.addGeometry(e,this.elevationBufferData,f);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:g,max:y}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,g),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,y))}addGeometry(e,i,s){let a=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,u=null;s&&(u=s.elevationSampler.constantElevation(s.elevation,s.bias),u!=null&&(a=u,h=u));let f=(g,y,w)=>{if(s!=null)if(y.push(g),u!=null)i.elevatedLayoutVertexArray.emplaceBack(u),w.push(u);else{let E=s.elevationSampler.pointElevation(g,s.elevation,s.bias);i.elevatedLayoutVertexArray.emplaceBack(E),w.push(E),a=Math.min(a,E),h=Math.max(h,E)}};for(let g of e){let y=0;for(let W of g)y+=W.length;let w=i.triangleSegments.prepareSegment(y,i.layoutVertexArray,i.indexArray),E=w.vertexLength,I=[],R=[],L=[],k=[],B=[],G=i.layoutVertexArray.length;for(let W of g){if(W.length===0)continue;W!==g[0]&&R.push(I.length/2);let K=i.lineSegments.prepareSegment(W.length,i.layoutVertexArray,i.lineIndexArray),pe=K.vertexLength;s&&B.push(i.layoutVertexArray.length-G),f(W[0],L,k),i.layoutVertexArray.emplaceBack(W[0].x,W[0].y),i.lineIndexArray.emplaceBack(pe+W.length-1,pe),I.push(W[0].x),I.push(W[0].y);for(let ce=1;ce<W.length;ce++)f(W[ce],L,k),i.layoutVertexArray.emplaceBack(W[ce].x,W[ce].y),i.lineIndexArray.emplaceBack(pe+ce-1,pe+ce),I.push(W[ce].x),I.push(W[ce].y);K.vertexLength+=W.length,K.primitiveLength+=W.length}let X=Iu(I,R);for(let W=0;W<X.length;W+=3)i.indexArray.emplaceBack(E+X[W],E+X[W+1],E+X[W+2]);if(X.length>0&&s&&this.elevationMode==="hd-road-base"){let W=s.elevation.isTunnel(),K=s.elevation.safeArea,pe=this.elevatedStructures.addVertices(L,k);this.elevatedStructures.addTriangles(X,pe,W);let ce=B.length;if(ce>0){for(let ue=0;ue<ce-1;ue++)this.elevatedStructures.addRenderableRing(s.index,B[ue]+pe,B[ue+1]-B[ue],W,K,s.featureInfo);this.elevatedStructures.addRenderableRing(s.index,B[ce-1]+pe,L.length-B[ce-1],W,K,s.featureInfo)}}w.vertexLength+=y,w.primitiveLength+=X.length/3}return[a,h]}prepareElevatedPolygons(e,i,s){let a=1/se(s),h=[];for(let u of e){let f=JE(u,new Vi(i,a));h.push(...f)}return h}clipPolygonsToTile(e,i){let s=-i,a=-i,h=ht+i,u=ht+i,f=0,g=[],y=[];for(;f<e.length;f++){let I=e[f],R=gd(I);(R.min.x>=s&&R.max.x<=h&&R.min.y>=a&&R.max.y<=u?g:y).push(I)}if(g.length===e.length)return e;let w=[new Qe(s,a),new Qe(h,a),new Qe(h,u),new Qe(s,u),new Qe(s,a)],E=g;for(let I of y)E.push(...KE(I,w));return E}}let uv,dv,pv,fv;Tt(ry,"FillBucket",{omit:["layers","patternFeatures"]}),Tt(iy,"FillBufferData"),Tt(Eo,"ElevatedStructures");class Gm{constructor(e,i,s,a){if(this.triangleCount=i.length/3,this.min=new Qe(0,0),this.max=new Qe(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;let[h,u]=[e[0].clone(),e[0].clone()];for(let E=1;E<e.length;++E){let I=e[E];h.x=Math.min(h.x,I.x),h.y=Math.min(h.y,I.y),u.x=Math.max(u.x,I.x),u.y=Math.max(u.y,I.y)}if(a){let E=Math.ceil(Math.max(u.x-h.x,u.y-h.y)/a);s=Math.max(s,E)}if(s===0)return;this.min=h,this.max=u;let f=this.max.sub(this.min);f.x=Math.max(f.x,1),f.y=Math.max(f.y,1);let g=Math.max(f.x,f.y)/s;this.cellsX=Math.max(1,Math.ceil(f.x/g)),this.cellsY=Math.max(1,Math.ceil(f.y/g)),this.xScale=1/g,this.yScale=1/g;let y=[];for(let E=0;E<this.triangleCount;E++){let I=e[i[3*E+0]].sub(this.min),R=e[i[3*E+1]].sub(this.min),L=e[i[3*E+2]].sub(this.min),k=ha(Math.floor(Math.min(I.x,R.x,L.x)),this.xScale,this.cellsX),B=ha(Math.floor(Math.max(I.x,R.x,L.x)),this.xScale,this.cellsX),G=ha(Math.floor(Math.min(I.y,R.y,L.y)),this.yScale,this.cellsY),X=ha(Math.floor(Math.max(I.y,R.y,L.y)),this.yScale,this.cellsY),W=new Qe(0,0),K=new Qe(0,0),pe=new Qe(0,0),ce=new Qe(0,0);for(let ue=G;ue<=X;++ue){W.y=K.y=ue*g,pe.y=ce.y=(ue+1)*g;for(let ge=k;ge<=B;++ge)W.x=pe.x=ge*g,K.x=ce.x=(ge+1)*g,(Wr(I,R,L,W,K,ce)||Wr(I,R,L,W,ce,pe))&&y.push({cellIdx:ue*this.cellsX+ge,triIdx:E})}}if(y.length===0)return;y.sort((E,I)=>E.cellIdx-I.cellIdx||E.triIdx-I.triIdx);let w=0;for(;w<y.length;){let E=y[w].cellIdx,I={start:this.payload.length,len:0};for(;w<y.length&&y[w].cellIdx===E;)++I.len,this.payload.push(y[w++].triIdx);this.cells[E]=I}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;let s=ha(e.x-this.min.x,this.xScale,this.cellsX),a=ha(e.y-this.min.y,this.yScale,this.cellsY),h=this.cells[a*this.cellsX+s];if(h){this._lazyInitLookup();for(let u=0;u<h.len;u++){let f=this.payload[h.start+u],g=Math.floor(f/8),y=1<<f%8;if(!(this.lookup[g]&y)&&(this.lookup[g]|=y,i.push(f),i.length===this.triangleCount))return}}}query(e,i,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();let a=ha(e.x-this.min.x,this.xScale,this.cellsX),h=ha(i.x-this.min.x,this.xScale,this.cellsX),u=ha(e.y-this.min.y,this.yScale,this.cellsY),f=ha(i.y-this.min.y,this.yScale,this.cellsY);for(let g=u;g<=f;g++)for(let y=a;y<=h;y++){let w=this.cells[g*this.cellsX+y];if(w)for(let E=0;E<w.len;E++){let I=this.payload[w.start+E],R=Math.floor(I/8),L=1<<I%8;if(!(this.lookup[R]&L)&&(this.lookup[R]|=L,s.push(I),s.length===this.triangleCount))return}}}}function ha(r,e,i){return Math.max(0,Math.min(i-1,Math.floor(r*e)))}Tt(Gm,"TriangleGridIndex");class mv{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,i){for(let s of this.footprints)i.push({footprint:s,id:e})}populate(e,i,s,a){let h=[];for(let{feature:u,id:f,index:g,sourceLayerIndex:y}of e){let w=this.layers[0]._featureFilter.needGeometry,E=ke(u,w);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),E,s))continue;let I={id:f,properties:u.properties,type:u.type,sourceLayerIndex:y,index:g,geometry:w?E.geometry:me(u,s,a),patterns:{}};h.push(I)}for(let u of h){let{geometry:f,index:g,sourceLayerIndex:y}=u;this.addFeature(u,f,g,s,{},i.availableImages,i.brightness),i.featureIndex.insert(e[g].feature,f,g,y,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,s,a,h,u,f){}destroy(){}addFeature(e,i,s,a,h,u=[],f){for(let g of Cp(i,2)){let y=[],w=[],E=[],I=new Qe(1/0,1/0),R=new Qe(-1/0,-1/0);for(let B of g)if(B.length!==0){B!==g[0]&&E.push(w.length/2);for(let G=0;G<B.length;G++)w.push(B[G].x),w.push(B[G].y),y.push(B[G]),I.x=Math.min(I.x,B[G].x),I.y=Math.min(I.y,B[G].y),R.x=Math.max(R.x,B[G].x),R.y=Math.max(R.y,B[G].y)}let L=Iu(w,E),k=new Gm(y,L,8,256);this.footprints.push({vertices:y,indices:L,grid:k,min:I,max:R})}}}Tt(mv,"ClipBucket",{omit:["layers"]});let QE=gi([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),eI=gi([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),tI=gi([{name:"a_centroid_pos",components:2,type:"Uint16"}]),iI=gi([{name:"a_join_normal_inside",components:3,type:"Int16"}]),rI=gi([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),nI=gi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:oI}=QE,Pp=Number.MAX_SAFE_INTEGER,_v=Pp-1;function gv(r,e,i,s){return r.order<e||r.order===Pp||!(r.clipMask&i)||function(a,h){return h.length!==0&&h.find(u=>u===a)===void 0}(s,r.clipScope)}function qm(r,e){return r.x-e.x||r.y-e.y}function yv(r,e){return qm(r.min,e.min)===0&&qm(r.max,e.max)===0}function ny(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function Hm(r,e){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(r[i].sourceId!==e[i].sourceId||!yv(r[i],e[i])||r[i].order!==e[i].order||r[i].clipMask!==e[i].clipMask||!Ss(r[i].clipScope,e[i].clipScope))return!1;return!0}function xv(r,e,i){let s=1/ht,a=1/(1<<i.canonical.z),h=(e.x*s+i.canonical.x)*a+i.wrap,u=(e.y*s+i.canonical.y)*a;return{min:new Qe((r.x*s+i.canonical.x)*a+i.wrap,(r.y*s+i.canonical.y)*a),max:new Qe(h,u)}}function sI(r,e,i){let s=1<<i.canonical.z,a=((e.x-i.wrap)*s-i.canonical.x)*ht,h=(e.y*s-i.canonical.y)*ht;return{min:new Qe(((r.x-i.wrap)*s-i.canonical.x)*ht,(r.y*s-i.canonical.y)*ht),max:new Qe(a,h)}}function oy(r,e,i,s,a,h,u){let f=r.indices,g=r.vertices,y=[];for(let w=s;w<s+a;w+=3){let E=e[i[w+0]+h],I=e[i[w+1]+h],R=e[i[w+2]+h],L=Math.min(E.x,I.x,R.x),k=Math.max(E.x,I.x,R.x),B=Math.min(E.y,I.y,R.y),G=Math.max(E.y,I.y,R.y);y.length=0,r.grid.query(new Qe(L,B),new Qe(k,G),y);for(let X=0;X<y.length;X++){let W=y[X];if(Wr(g[f[3*W+0]],g[f[3*W+1]],g[f[3*W+2]],E,I,R,u))return!0}}return!1}function vv(r,e,i,s){if(!r||!i)return!1;let a=r.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(i.vertices.length<r.vertices.length)return vv(i,s,r,e);let h=e.canonical,u=s.canonical,f=Math.pow(2,u.z-h.z);a=r.vertices.map(g=>new Qe((g.x+h.x*ht)*f-u.x*ht,(g.y+h.y*ht)*f-u.y*ht))}return oy(i,a,r.indices,0,r.indices.length,0,0)}function bv(r,e,i,s){let a=Math.pow(2,s.z-i.z);return new Qe((r+i.x*ht)*a-s.x*ht,(e+i.y*ht)*a-s.y*ht)}function sy(r,e){let i=[];e.grid.queryPoint(r,i);let s=e.indices,a=e.vertices;for(let h=0;h<i.length;h++){let u=i[h];if(xn([a[s[3*u+0]],a[s[3*u+1]],a[s[3*u+2]]],r))return!0}return!1}let ay=[new Qe(0,0),new Qe(ht,0),new Qe(ht,ht),new Qe(0,ht)];function wv(r,e){let i=[],s=[];if(!e||r.length<2)return[r];if(r.length===2)return Sr(r[0],r[1],ay)?[r]:[];for(let a=0;a<r.length+2;a++){let h=r[a%r.length],u=r[(a+1)%r.length],f=Sr(a===0?r[r.length-1]:r[(a-1)%r.length],h,ay),g=Sr(h,u,ay),y=f||g;y&&s.push(h),y&&g||s.length>0&&(s.length>1&&i.push(s),s=[])}return s.length>1&&i.push(s),i}let ly=Pe.types,aI=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],lI=["fill-extrusion-flood-light-ground-radius"],cI=Math.pow(2,13),hI=Math.pow(2,15)-1,Tv=new Qe(0,1),Nl=2147483648;function Rp(r,e,i,s,a,h,u,f){r.emplaceBack((e<<1)+u,(i<<1)+h,(Math.floor(s*cI)<<1)+a,Math.round(f))}function Lp(r,e,i){r.emplaceBack(e.x*ht,e.y*ht,i?1:0)}function $m(r,e,i,s,a,h){r.emplaceBack(e.x,e.y,(i.x<<1)+s,(i.y<<1)+a,h)}function zp(r,e,i){r.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class Sv{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Ev{constructor(){this.centroidXY=new Qe(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Qe(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Qe(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Qe(this.max.x-this.min.x,this.max.y-this.min.y)}}class Iv{constructor(){this.acc=new Qe(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,s){this.accCount++,this.acc._add(i);let a=!!this.borders;i.x<e.min.x?(e.min.x=i.x,a=!0):i.x>e.max.x&&(e.max.x=i.x,a=!0),i.y<e.min.y?(e.min.y=i.y,a=!0):i.y>e.max.y&&(e.max.y=i.y,a=!0),((i.x===0||i.x===ht)&&i.x===s.x)!=((i.y===0||i.y===ht)&&i.y===s.y)&&this.processBorderOverlap(i,s),a&&this.checkBorderIntersection(i,s)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Bt(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>ht!=e.x>ht&&this.addBorderIntersection(1,Bt(i.y,e.y,(ht-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Bt(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>ht!=e.y>ht&&this.addBorderIntersection(3,Bt(i.x,e.x,(ht-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let s=this.borders[e];i<s[0]&&(s[0]=i),i>s[1]&&(s[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;let s=e.x===0?0:1;this.addBorderIntersection(s,i.y),this.addBorderIntersection(s,e.y)}else{let s=e.y===0?2:3;this.addBorderIntersection(s,i.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new Qe(0,0):new Qe(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function Av(r,e){let i=r.add(e)._unit(),s=re(r.x*i.x+r.y*i.y,-1,1);var a,h,u;return a=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(a)))/4*hI*((h=r).x*(u=e).y-h.y*u.x<0?-1:1)}let uI=[r=>r.x<0,r=>r.x>ht,r=>r.y<0,r=>r.y>ht];function dI(r,e,i,s){let a=[4];if(s===0)return a;i._mult(s);let h=r.sub(i),u=e.sub(i),f=[r,e,h,u];for(let g=0;g<4;g++)for(let y of f)if(uI[g](y)){a.push(g);break}return a}class cy{constructor(e){this.vertexArray=new mu,this.indexArray=new ur,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut},i=>lI.includes(i)),this._segments=new gr,this.hiddenByLandmarkVertexArray=new bu,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new gr}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,s,a=!1){let h=e.length;if(h>2){let u=Math.max(0,this._segments.get().length-1),f=this._segments._prepareSegment(4*h,this.vertexArray.length,2*this._segmentToGroundQuads[u].length),g;u!==this._segments.get().length-1&&(u++,this._segmentToGroundQuads[u]=[],this._segmentToRegionTriCounts[u]=[0,0,0,0,0]);{let y=e[0],w=e[1];g=Av(y.sub(e[h-1])._perp()._unit(),w.sub(y)._perp()._unit())}for(let y=0;y<h;y++){let w=y===h-1?0:y+1,E=e[y],I=e[w],R=e[w===h-1?0:w+1],L=I.sub(E)._perp()._unit(),k=Av(L,R.sub(I)._perp()._unit()),B=g,G=k;if(hy(E,I,i)||a&&Pv(E,i)&&Pv(I,i)){g=k;continue}let X=f.vertexLength;$m(this.vertexArray,E,I,1,1,B),$m(this.vertexArray,E,I,1,0,B),$m(this.vertexArray,E,I,0,1,G),$m(this.vertexArray,E,I,0,0,G),f.vertexLength+=4;let W=dI(E,I,L,s);for(let K of W)this._segmentToGroundQuads[u].push({id:X,region:K}),this._segmentToRegionTriCounts[u][K]+=2,f.primitiveLength+=2;g=k}}}prepareBorderSegments(){if(!this.hasData())return;let e=this._segments.get(),i=e.length;for(let s=0;s<i;s++)this._segmentToGroundQuads[s].sort((a,h)=>a.region-h.region);for(let s=0;s<i;s++){let a=this._segmentToGroundQuads[s],h=e[s],u=this._segmentToRegionTriCounts[s];u.reduce((g,y)=>g+y,0);let f=0;for(let g=0;g<=4;g++){let y=u[g];if(y!==0){let w=this.regionSegments[g];w||(w=this.regionSegments[g]=new gr);let E={vertexOffset:h.vertexOffset,primitiveOffset:h.primitiveOffset+f,vertexLength:h.vertexLength,primitiveLength:y};w.get().push(E)}f+=y}for(let g=0;g<a.length;g++){let y=a[g].id;this.indexArray.emplaceBack(y,y+1,y+3),this.indexArray.emplaceBack(y,y+3,y+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,s,a,h,u,f){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,s,a,h,u,void 0,f)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,eI.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,s,a,h,u,f,g){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,s,a,h,u,f,g)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Nl))}updateHiddenByLandmarkRange(e,i,s){if(!this.hasData())return;let a=i+e;if(i!==0){for(let h=e;h<a;++h)this.hiddenByLandmarkVertexArray.emplace(h,s?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,rI.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){let i=this.regionSegments[e];i&&i.destroy()}}}}class Zm{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ur,this.footprintVertices=new $n,this.footprintSegments=[],this.layoutVertexArray=new Il,this.centroidVertexArray=new Im,this.wallVertexArray=new Mm,this.indexArray=new ur,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut},i=>aI.includes(i)),this.segments=new gr,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new cy(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.features=[],this.hasPattern=Qg("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=se(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(let{feature:h,id:u,index:f,sourceLayerIndex:g}of e){let y=this.layers[0]._featureFilter.needGeometry,w=ke(h,y);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),w,s))continue;let E={id:u,sourceLayerIndex:g,index:f,geometry:y?w.geometry:me(h,s,a),properties:h.properties,type:h.type,patterns:{}},I=this.layoutVertexArray.length,R=ly[E.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:h.id,feature:ey("fill-extrusion",this.layers,E,this.zoom,this.pixelRatio,i)});else if(this.wallMode)for(let L of E.geometry)for(let k of wv(L,R))this.addFeature(h.id,E,[k],f,s,{},i.availableImages,a,i.brightness);else this.addFeature(h.id,E,E.geometry,f,s,{},i.availableImages,a,i.brightness);i.featureIndex.insert(h,E.geometry,f,g,this.index,I)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,s,a,h,u){for(let{featureId:f,feature:g}of this.features){let y=ly[g.type]==="Polygon",{geometry:w}=g;if(this.wallMode)for(let E of w)for(let I of wv(E,y))this.addFeature(f,g,[I],g.index,i,s,a,h,u);else this.addFeature(f,g,w,g.index,i,s,a,h,u)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,s,a,h,u,f){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,this.worldview),this.groundEffect.update(e,i,h,s,a,u,f,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,oI),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,iI.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,nI.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,tI.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,s,a,h,u,f,g,y){let w=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(i,{})/this.tileToMeter,E=[new Qe(0,0),new Qe(ht,ht)],I=g.projection,R=I.name==="globe",L=this.wallMode||ly[i.type]==="Polygon",k=new Iv;k.centroidDataIndex=this.centroidData.length;let B=new Ev;B.buildingId=e,i.properties&&i.properties.hasOwnProperty("building_id")&&(B.buildingId=i.properties.building_id);let G=this.layers[0].paint.get("fill-extrusion-base").evaluate(i,{},h)<=0,X=this.layers[0].paint.get("fill-extrusion-height").evaluate(i,{},h),W;if(B.height=X,B.vertexArrayOffset=this.layoutVertexArray.length,B.groundVertexArrayOffset=this.groundEffect.vertexArray.length,R&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new gu),this.wallMode){if(R)return void pi("Non zero fill-extrusion-line-width is not yet supported on globe.");if(s.length!==1)return;W=function(Ee){let Ue=Ee[0].x===Ee[Ee.length-1].x&&Ee[0].y===Ee[Ee.length-1].y;(function(tt){let It=0,xt=tt.length;for(let ut=0;ut<xt;ut++)It+=(tt[(ut+1)%xt].x-tt[ut].x)*(tt[(ut+1)%xt].y+tt[ut].y);return It>=0})(Ee)||(Ee=Ee.reverse());let qe={geometry:[],joinNormals:[],indices:[]},Ke=[],it=[],Fe=[],Je=Ee.length;for(;Je>=2&&Ee[Je-1].equals(Ee[Je-2]);)Je--;if(Je<(Ue?3:2))return qe;let Ie,Be,at,et,Lt,St=0;for(;St<Je-1&&Ee[St].equals(Ee[St+1]);)St++;Ue&&(Ie=Ee[Je-2],Lt=Ee[St].sub(Ie)._unit()._perp());for(let tt=St;tt<Je;tt++){if(at=tt===Je-1?Ue?Ee[St+1]:void 0:Ee[tt+1],at&&Ee[tt].equals(at))continue;Lt&&(et=Lt),Ie&&(Be=Ie),Ie=Ee[tt],Lt=at?at.sub(Ie)._unit()._perp():et,et=et||Lt;let It=et.add(Lt);It.x===0&&It.y===0||It._unit();let xt=It.x*Lt.x+It.y*Lt.y,ut=xt!==0?1/xt:1/0,vt=et.x*Lt.y-et.y*Lt.x>0,Vt="miter",Zt=2;Vt==="miter"&&ut>Zt&&(Vt="bevel"),Vt==="bevel"&&(ut>100&&(Vt="flipbevel"),ut<Zt&&(Vt="miter"));let Qt=(Kt,fi,oi,ir)=>{let ee=new Qe(Kt.x,Kt.y),te=new Qe(Kt.x,Kt.y);ee.x+=fi.x*ir,ee.y+=fi.y*ir,te.x-=fi.x*Math.max(oi,1),te.y-=fi.y*Math.max(oi,1),Fe.push(fi),Ke.push(ee),it.push(te)};if(Vt==="miter")It._mult(ut),Qt(Ie,It,0,0);else if(Vt==="flipbevel")It=Lt.mult(-1),Qt(Ie,It,0,0),Qt(Ie,It.mult(-1),0,0);else{let Kt=-Math.sqrt(ut*ut-1),fi=vt?Kt:0,oi=vt?0:Kt;Be&&Qt(Ie,et,fi,oi),at&&Qt(Ie,Lt,fi,oi)}}qe.geometry=[...Ke,...it.reverse(),Ke[0]],qe.joinNormals=[...Fe,...Fe.reverse(),Fe[Fe.length-1]];let Xe=qe.geometry.length-1;for(let tt=0;tt<Xe/2;tt++)if(tt+1<Xe/2){let It=tt,xt=tt+1,ut=Xe-1-tt,vt=Xe-2-tt;It=It===0?Xe-1:It-1,xt=xt===0?Xe-1:xt-1,ut=ut===0?Xe-1:ut-1,vt=vt===0?Xe-1:vt-1,qe.indices.push(ut),qe.indices.push(xt),qe.indices.push(It),qe.indices.push(ut),qe.indices.push(vt),qe.indices.push(xt)}return qe}(s[0]),s=[W.geometry]}let K=(Ee,Ue)=>Ee<(Ue.length-1)/2||Ee===Ue.length-1,pe=this.wallMode?[s]:Cp(s,500);for(let Ee=pe.length-1;Ee>=0;Ee--){let Ue=pe[Ee];(Ue.length===0||(ce=Ue[0]).every(nt=>nt.x<=0)||ce.every(nt=>nt.x>=ht)||ce.every(nt=>nt.y<=0)||ce.every(nt=>nt.y>=ht))&&pe.splice(Ee,1)}var ce;let ue;if(R)ue=Dv(pe,E,h);else{ue=[];for(let Ee of pe)ue.push({polygon:Ee,bounds:E})}let ge=L?this.edgeRadius:0,ve=ge>0&&this.zoom<17,Ne=(Ee,Ue)=>{if(Ee.length===0)return!1;let nt=Ee[Ee.length-1];return Ue.x===nt.x&&Ue.y===nt.y};for(let{polygon:Ee,bounds:Ue}of ue){let nt=0,qe=0;for(let Je of Ee)L&&!Je[0].equals(Je[Je.length-1])&&Je.push(Je[0]),qe+=L?Je.length-1:Je.length;let Ke=this.segments.prepareSegment((L?5:4)*qe,this.layoutVertexArray,this.indexArray);B.footprintSegIdx<0&&(B.footprintSegIdx=this.footprintSegments.length),B.polygonSegIdx<0&&(B.polygonSegIdx=this.polygonSegments.length);let it={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Fe=new Sv;if(Fe.vertexOffset=this.footprintVertices.length,Fe.indexOffset=3*this.footprintIndices.length,Fe.ringIndices=[],L){let Je=[],Ie=[];nt=Ke.vertexLength;for(let at=0;at<Ee.length;at++){let et=Ee[at];et.length&&at!==0&&Ie.push(Je.length/2);let Lt=[],St,Xe;St=et[1].sub(et[0])._perp()._unit(),Fe.ringIndices.push(et.length-1);for(let tt=1;tt<et.length;tt++){let It=et[tt],xt=et[tt===et.length-1?1:tt+1],ut=It.clone();if(ge){Xe=xt.sub(It)._perp()._unit();let vt=St.add(Xe)._unit(),Vt=ge*Math.min(4,1/(St.x*vt.x+St.y*vt.y));ut.x+=Vt*vt.x,ut.y+=Vt*vt.y,ut.x=Math.round(ut.x),ut.y=Math.round(ut.y),St=Xe}if(!G||ge!==0&&!ve||Ne(Lt,ut)||Lt.push(ut),Rp(this.layoutVertexArray,ut.x,ut.y,0,0,1,1,0),this.wallMode){let vt=K(tt,et);Lp(this.wallVertexArray,W.joinNormals[tt],!vt)}Ke.vertexLength++,this.footprintVertices.emplaceBack(It.x,It.y),Je.push(It.x,It.y),R&&zp(this.layoutVertexExtArray,I.projectTilePoint(ut.x,ut.y,h),I.upVector(h,ut.x,ut.y))}G&&(ge===0||ve)&&(Lt.length!==0&&Ne(Lt,Lt[0])&&Lt.pop(),this.groundEffect.addData(Lt,Ue,w))}let Be=this.wallMode?W.indices:Iu(Je,Ie);for(let at=0;at<Be.length;at+=3)this.footprintIndices.emplaceBack(Fe.vertexOffset+Be[at+0],Fe.vertexOffset+Be[at+1],Fe.vertexOffset+Be[at+2]),this.indexArray.emplaceBack(nt+Be[at],nt+Be[at+2],nt+Be[at+1]),Ke.primitiveLength++;Fe.indexCount+=Be.length,Fe.vertexCount+=this.footprintVertices.length-Fe.vertexOffset}for(let Je=0;Je<Ee.length;Je++){let Ie=Ee[Je];k.startRing(B,Ie[0]);let Be=Ie.length>4&&Rv(Ie[Ie.length-2],Ie[0],Ie[1]),at=ge?pI(Ie[Ie.length-2],Ie[0],Ie[1],ge):0,et=[],Lt,St,Xe;St=Ie[1].sub(Ie[0])._perp()._unit();let tt=!0;for(let It=1,xt=0;It<Ie.length;It++){let ut=Ie[It-1],vt=Ie[It],Vt=Ie[It===Ie.length-1?1:It+1];if(k.appendEdge(B,vt,ut),hy(vt,ut,Ue)){ge&&(St=Vt.sub(vt)._perp()._unit(),tt=!tt);continue}let Zt=vt.sub(ut)._perp(),Qt=Zt.x/(Math.abs(Zt.x)+Math.abs(Zt.y)),Kt=Zt.y>0?1:0,fi=ut.dist(vt);if(xt+fi>32768&&(xt=0),ge){Xe=Vt.sub(vt)._perp()._unit();let te=Cv(ut,vt,Vt,Mv(St,Xe),ge);isNaN(te)&&(te=0);let Oe=vt.sub(ut)._unit();ut=ut.add(Oe.mult(at))._round(),vt=vt.add(Oe.mult(-te))._round(),at=te,St=Xe,G&&this.zoom>=17&&(Ne(et,ut)||et.push(ut),Ne(et,vt)||et.push(vt))}let oi=Ke.vertexLength,ir=Ie.length>4&&Rv(ut,vt,Vt),ee=Lv(xt,Be,tt);if(Rp(this.layoutVertexArray,ut.x,ut.y,Qt,Kt,0,0,ee),Rp(this.layoutVertexArray,ut.x,ut.y,Qt,Kt,0,1,ee),this.wallMode){let te=K(It-1,Ie),Oe=W.joinNormals[It-1];Lp(this.wallVertexArray,Oe,te),Lp(this.wallVertexArray,Oe,te)}if(xt+=fi,ee=Lv(xt,ir,!tt),Be=ir,Rp(this.layoutVertexArray,vt.x,vt.y,Qt,Kt,0,0,ee),Rp(this.layoutVertexArray,vt.x,vt.y,Qt,Kt,0,1,ee),this.wallMode){let te=K(It,Ie),Oe=W.joinNormals[It];Lp(this.wallVertexArray,Oe,te),Lp(this.wallVertexArray,Oe,te)}if(Ke.vertexLength+=4,this.indexArray.emplaceBack(oi+0,oi+1,oi+2),this.indexArray.emplaceBack(oi+1,oi+3,oi+2),Ke.primitiveLength+=2,ge){let te=nt+(It===1?Ie.length-2:It-2),Oe=It===1?nt:te+1;if(this.indexArray.emplaceBack(oi+1,te,oi+3),this.indexArray.emplaceBack(te,Oe,oi+3),Ke.primitiveLength+=2,Lt===void 0&&(Lt=oi),!hy(Vt,Ie[It],Ue)){let lt=It===Ie.length-1?Lt:Ke.vertexLength;this.indexArray.emplaceBack(oi+2,oi+3,lt),this.indexArray.emplaceBack(oi+3,lt+1,lt),this.indexArray.emplaceBack(oi+3,Oe,lt+1),Ke.primitiveLength+=3}tt=!tt}if(R){let te=this.layoutVertexExtArray,Oe=I.projectTilePoint(ut.x,ut.y,h),lt=I.projectTilePoint(vt.x,vt.y,h),pt=I.upVector(h,ut.x,ut.y),dt=I.upVector(h,vt.x,vt.y);zp(te,Oe,pt),zp(te,Oe,pt),zp(te,lt,dt),zp(te,lt,dt)}}L&&(nt+=Ie.length-1),G&&ge&&this.zoom>=17&&(et.length!==0&&Ne(et,et[0])&&et.pop(),this.groundEffect.addData(et,Ue,w,ge>0))}this.footprintSegments.push(Fe),it.triangleCount=this.indexArray.length-it.triangleArrayOffset,this.polygonSegments.push(it),++B.footprintSegLen,++B.polygonSegLen}if(B.vertexCount=this.layoutVertexArray.length-B.vertexArrayOffset,B.groundVertexCount=this.groundEffect.vertexArray.length-B.groundVertexArrayOffset,B.vertexCount!==0){if(B.centroidXY=k.borders?Tv:this.encodeCentroid(k,B),this.centroidData.push(B),k.borders){this.featuresOnBorder.push(k);let Ee=this.featuresOnBorder.length-1;for(let Ue=0;Ue<k.borders.length;Ue++)k.borders[Ue][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Ue].push(Ee)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,a,u,f,h,y,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(i,a,u,f,h,y,this.worldview),this.maxHeight=Math.max(this.maxHeight,X)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,s)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}splitToSubtiles(){let e=[];for(let f=0;f<this.centroidData.length;f++){let g=this.centroidData[f],y=+(g.min.y+g.max.y>ht),w=2*y+(+(g.min.x+g.max.x>ht)^y);for(let E=0;E<g.polygonSegLen;E++){let I=g.polygonSegIdx+E;e.push({centroidIdx:f,subtile:w,polygonSegmentIdx:I,triangleSegmentIdx:this.polygonSegments[I].triangleSegIdx})}}let i=new ur;e.sort((f,g)=>f.triangleSegmentIdx===g.triangleSegmentIdx?f.subtile-g.subtile:f.triangleSegmentIdx-g.triangleSegmentIdx);let s=0,a=0,h=0;for(let f of e){if(f.triangleSegmentIdx!==s)break;h++}let u=e.length;for(;a!==e.length;){s=e[a].triangleSegmentIdx;let f=0,g=a,y=a;for(let w=g;w<h&&e[w].subtile===f;w++)y++;for(;g!==h;){let w=e[g];f=w.subtile;let E=this.centroidData[w.centroidIdx].min.clone(),I=this.centroidData[w.centroidIdx].max.clone(),R={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let L=g;L<y;L++){let k=e[L],B=this.polygonSegments[k.polygonSegmentIdx],G=this.centroidData[k.centroidIdx].min,X=this.centroidData[k.centroidIdx].max,W=this.indexArray.uint16;for(let K=B.triangleArrayOffset;K<B.triangleArrayOffset+B.triangleCount;K++)i.emplaceBack(W[3*K],W[3*K+1],W[3*K+2]);R.primitiveLength+=B.triangleCount,E.x=Math.min(E.x,G.x),E.y=Math.min(E.y,G.y),I.x=Math.max(I.x,X.x),I.y=Math.max(I.y,X.y)}R.primitiveLength>0&&this.triangleSubSegments.push({segment:R,min:E,max:I}),g=y;for(let L=g;L<h&&e[L].subtile===e[g].subtile;L++)y++}a=h;for(let w=a;w<u&&e[w].triangleSegmentIdx===e[a].triangleSegmentIdx;w++)h++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,s){let a=new gr;if(this.wallMode){for(let k of this.triangleSubSegments)a.segments.push(k.segment);return a}let h=0,u=0,f=1<<e.canonical.z;if(i){let k=i.getMinMaxForTile(e);k&&(h=k.min,u=k.max)}u+=this.maxHeight;let g=e.toUnwrapped(),y,w=[g.canonical.x/f+g.wrap,g.canonical.y/f],E=[(g.canonical.x+1)/f+g.wrap,(g.canonical.y+1)/f],I=(k,B,G)=>[k[0]*(1-G[0])+B[0]*G[0],k[1]*(1-G[1])+B[1]*G[1]],R=[],L=[];for(let k of this.triangleSubSegments){R[0]=k.min.x/ht,R[1]=k.min.y/ht,L[0]=k.max.x/ht,L[1]=k.max.y/ht;let B=I(w,E,R),G=I(w,E,L);if(new li([B[0],B[1],h],[G[0],G[1],u]).intersectsPrecise(s)===0){y&&(a.segments.push(y),y=void 0);continue}let X=k.segment;y&&y.vertexOffset!==X.vertexOffset&&(a.segments.push(y),y=void 0),y?(y.vertexLength+=X.vertexLength,y.primitiveLength+=X.primitiveLength):y={vertexOffset:X.vertexOffset,primitiveLength:X.primitiveLength,vertexLength:X.vertexLength,primitiveOffset:X.primitiveOffset,sortKey:void 0,vaos:{}}}return y&&a.segments.push(y),a}encodeCentroid(e,i){let s=e.centroid(),a=i.span(),h=Math.min(7,Math.round(a.x*this.tileToMeter/10)),u=Math.min(7,Math.round(a.y*this.tileToMeter/10));return new Qe(re(s.x,1,ht-1)<<3|h,re(s.y,1,ht-1)<<3|u)}encodeBorderCentroid(e){if(!e.borders)return new Qe(0,0);let i=e.borders,s=Number.MAX_VALUE;if(i[0][0]!==s||i[1][0]!==s){let a=i[0][0]!==s?0:1;return new Qe(6|(i[0][0]!==s?0:65528),(i[a][0]+i[a][1])/2<<3|6)}{let a=i[2][0]!==s?2:3;return new Qe((i[a][0]+i[a][1])/2<<3|6,6|(i[2][0]!==s?0:65528))}}showCentroid(e){let i=this.centroidData[e.centroidDataIndex];i.flags&=2147483647,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);let i=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,a=e.flags&Nl?Tv:e.centroidXY,h=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==a.y||h!==a.x){for(let u=i;u<s;++u)this.centroidVertexArray.emplace(u,a.x,a.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;let a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Hm(this.activeReplacements,a))return;if(this.activeReplacements=a,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(let u of this.centroidData)u.flags&=2147483647;let h=[];for(let u of this.activeReplacements){if(u.order<s)continue;let f=Math.max(1,Math.pow(2,u.footprintTileId.canonical.z-e.canonical.z));if(u.footprint.buildingId){let g=u.footprint.buildingId;for(let y of this.centroidData)y.buildingId===g&&(y.flags|=Nl)}else for(let g of this.centroidData)if(!(g.flags&Nl||u.min.x>g.max.x||g.min.x>u.max.x||u.min.y>g.max.y||g.min.y>u.max.y))for(let y=0;y<g.footprintSegLen;y++){let w=this.footprintSegments[g.footprintSegIdx+y];if(h.length=0,fI(this.footprintVertices,w.vertexOffset,w.vertexCount,u.footprintTileId.canonical,e.canonical,h),oy(u.footprint,h,this.footprintIndices.uint16,w.indexOffset,w.indexCount,-w.vertexOffset,-f)){g.flags|=Nl;break}}}for(let u of this.centroidData)this.writeCentroidToBuffer(u);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,s){let a=!1;for(let h=0;h<s.footprintSegLen;h++){let u=this.footprintSegments[s.footprintSegIdx+h],f=0;for(let g of u.ringIndices){for(let y=f,w=g+f-1;y<g+f;w=y++){let E=this.footprintVertices.int16[2*(y+u.vertexOffset)+0],I=this.footprintVertices.int16[2*(y+u.vertexOffset)+1],R=this.footprintVertices.int16[2*(w+u.vertexOffset)+1];I>i!=R>i&&e<(this.footprintVertices.int16[2*(w+u.vertexOffset)+0]-E)*(i-I)/(R-I)+E&&(a=!a)}f=g}}return a}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0,h=4*(e+ht)*ht+(i+ht);if(this.partLookup.hasOwnProperty(h)){let u=this.partLookup[h];return u?{height:u.height,hidden:!!(u.flags&Nl)}:void 0}for(let u of this.centroidData)e>u.max.x||u.min.x>e||i>u.max.y||u.min.y>i||u.height<=s||this.footprintContainsPoint(e,i,u)&&(s=u.height,this.partLookup[h]=u,a=!!(u.flags&Nl));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.partLookup[h]=void 0}}function Mv(r,e){let i=r.add(e)._unit();return r.x*i.x+r.y*i.y}function pI(r,e,i,s){let a=e.sub(r)._perp()._unit(),h=i.sub(e)._perp()._unit();return Cv(r,e,i,Mv(a,h),s)}function Cv(r,e,i,s,a){let h=Math.sqrt(1-s*s);return Math.min(r.dist(e)/3,e.dist(i)/3,a*h/s)}function hy(r,e,i){return r.x<i[0].x&&e.x<i[0].x||r.x>i[1].x&&e.x>i[1].x||r.y<i[0].y&&e.y<i[0].y||r.y>i[1].y&&e.y>i[1].y}function Pv(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function Rv(r,e,i){if(r.x<0||r.x>=ht||e.x<0||e.x>=ht||i.x<0||i.x>=ht)return!1;let s=i.sub(e),a=s.perp(),h=r.sub(e);return(s.x*h.x+s.y*h.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(h.x*h.x+h.y*h.y))>-.866&&a.x*h.x+a.y*h.y<0}function Lv(r,e,i){let s=e?2|r:-3&r;return i?1|s:-2&s}function zv(){let r=Math.PI/32,e=Math.tan(r),i=b;return i*Math.sqrt(1+2*e*e)-i}function Dv(r,e,i){let s=1<<i.z,a=Z(i.x/s),h=Z((i.x+1)/s),u=Y(i.y/s),f=Y((i.y+1)/s);return function(g,y,w,E,I=0,R){let L=[];if(!g.length||!w||!E)return L;let k=(ce,ue)=>{for(let ge of ce)L.push({polygon:ge,bounds:ue})},B=Math.ceil(Math.log2(w)),G=Math.ceil(Math.log2(E)),X=B-G,W=[];for(let ce=0;ce<Math.abs(X);ce++)W.push(X>0?0:1);for(let ce=0;ce<Math.min(B,G);ce++)W.push(0),W.push(1);let K=g;if(K=jm(K,y[0].y-I,y[1].y+I,1),K=jm(K,y[0].x-I,y[1].x+I,0),!K.length)return L;let pe=[];for(W.length?pe.push({polygons:K,bounds:y,depth:0}):k(K,y);pe.length;){let ce=pe.pop(),ue=ce.depth,ge=W[ue],ve=ce.bounds[0],Ne=ce.bounds[1],Ee=ge===0?ve.x:ve.y,Ue=ge===0?Ne.x:Ne.y,nt=R?R(ge,Ee,Ue):.5*(Ee+Ue),qe=jm(ce.polygons,Ee-I,nt+I,ge),Ke=jm(ce.polygons,nt-I,Ue+I,ge);if(qe.length){let it=[ve,new Qe(ge===0?nt:Ne.x,ge===1?nt:Ne.y)];W.length>ue+1?pe.push({polygons:qe,bounds:it,depth:ue+1}):k(qe,it)}if(Ke.length){let it=[new Qe(ge===0?nt:ve.x,ge===1?nt:ve.y),Ne];W.length>ue+1?pe.push({polygons:Ke,bounds:it,depth:ue+1}):k(Ke,it)}}return L}(r,e,Math.ceil((h-a)/11.25),Math.ceil((u-f)/11.25),1,(g,y,w)=>{if(g===0)return .5*(y+w);{let E=Y((i.y+y/ht)/s);return(j(.5*(Y((i.y+w/ht)/s)+E))*s-i.y)*ht}})}function fI(r,e,i,s,a,h){let u=Math.pow(2,s.z-a.z);for(let f=0;f<i;f++){let g=r.int16[2*(f+e)+0],y=r.int16[2*(f+e)+1];g=(g+a.x*ht)*u-s.x*ht,y=(y+a.y*ht)*u-s.y*ht,h.push(new Qe(g,y))}}let Ov,kv;Tt(Zm,"FillExtrusionBucket",{omit:["layers","features"]}),Tt(Ev,"PartData"),Tt(Sv,"FootprintSegment"),Tt(Iv,"BorderCentroidData"),Tt(cy,"GroundEffect");class ih extends Qe{constructor(e,i,s){super(e,i),this.z=s}}class Fv extends ih{constructor(e,i,s,a){super(e,i,s),this.w=a}}function Bv(r,e,i,s){let a=i==="x"?"y":"x",h=(s-r[i])/(e[i]-r[i]);r[a]=Math.round(r[a]+(e[a]-r[a])*h),r[i]=s,r.hasOwnProperty("z")&&(r.z=Bt(r.z,e.z,h)),r.hasOwnProperty("w")&&(r.w=Bt(r.w,e.w,h))}function Nv(r,e,i,s){let a=i,h=s;for(let u of["x","y"]){let f=r,g=e;f[u]>=g[u]&&(f=e,g=r),f[u]<a&&g[u]>a&&Bv(f,g,u,a),f[u]<h&&g[u]>h&&Bv(g,f,u,h)}}function Wm(r,e,i,s,a,h){let u=[];for(let f=0;f<r.length;f++){let g=r[f],y,w=u.length,E=0;for(let I=0;I<g.length-1;I++){let R=g[I],L=g[I+1],k=0,B=E,G,X;h&&(k=Math.hypot(L.x-R.x,L.y-R.y),E+=k,G=R,X=L),R.x<e&&L.x<e||(R.x<e?R=new Qe(e,R.y+(e-R.x)/(L.x-R.x)*(L.y-R.y))._round():L.x<e&&(L=new Qe(e,R.y+(e-R.x)/(L.x-R.x)*(L.y-R.y))._round()),R.y<i&&L.y<i||(R.y<i?R=new Qe(R.x+(i-R.y)/(L.y-R.y)*(L.x-R.x),i)._round():L.y<i&&(L=new Qe(R.x+(i-R.y)/(L.y-R.y)*(L.x-R.x),i)._round()),R.x>=s&&L.x>=s||(R.x>=s?R=new Qe(s,R.y+(s-R.x)/(L.x-R.x)*(L.y-R.y))._round():L.x>=s&&(L=new Qe(s,R.y+(s-R.x)/(L.x-R.x)*(L.y-R.y))._round()),R.y>=a&&L.y>=a||(R.y>=a?R=new Qe(R.x+(a-R.y)/(L.y-R.y)*(L.x-R.x),a)._round():L.y>=a&&(L=new Qe(R.x+(a-R.y)/(L.y-R.y)*(L.x-R.x),a)._round()),y&&R.equals(y[y.length-1])||(y=[R],u.push(y),h&&h.push({progress:{min:B+Vv(G,X,R)*k,max:1},parentIndex:f,prevPoint:G,nextPoint:X})),y.push(L),h&&(h[h.length-1].progress.max=B+Vv(G,X,L)*k,h[h.length-1].nextPoint=X)))))}if(h&&E>0)for(let I=w;I<u.length;I++)h[I].progress.min/=E,h[I].progress.max/=E}return u}function mI(r,e,i,s,a){if(r.length<2)return void s.push(r);let h=[];for(;e.valid();){let[y,w]=e.get();for(let E=0;E<r.length-1;E++){let I=r[E],R=r[E+1],L=eo(I,R,y,w);if(L){let[k]=L,B=new Qe(Bt(I.x,R.x,k),Bt(I.y,R.y,k));h.push({t:E+k,distance:0,point:B})}}e.next()}if(h.length===0)return void s.push(r);h.sort((y,w)=>y.t-w.t);let u=0,f=0,g=[];for(s.push(g);u!==r.length;){if(f===h.length){for(;u!==r.length;)g.length!==0&&g[g.length-1].equals(r[u])||g.push(r[u]),u++;break}h[f].t<=u?(g.length!==0&&g[g.length-1].equals(h[f].point)||g.push(h[f].point),Math.trunc(h[f].t),f++):(g.length!==0&&g[g.length-1].equals(r[u])||g.push(r[u]),u++)}}function Vv(r,e,i){return r.x!==e.x?(i.x-r.x)/(e.x-r.x):r.y!==e.y?(i.y-r.y)/(e.y-r.y):0}function Dp(r,e){return r.x*e.x+r.y*e.y}function Uv(r,e){if(r.length===1){let i=0,s=e[i++],a;for(;!a||s.equals(a);)if(a=e[i++],!a)return 1/0;for(;i<e.length;i++){let h=e[i],u=r[0],f=a.sub(s),g=h.sub(s),y=u.sub(s),w=Dp(f,f),E=Dp(f,g),I=Dp(g,g),R=Dp(y,f),L=Dp(y,g),k=w*I-E*E,B=(I*R-E*L)/k,G=(w*L-E*R)/k,X=s.z*(1-B-G)+a.z*B+h.z*G;if(isFinite(X))return X}return 1/0}{let i=1/0;for(let s of e)i=Math.min(i,s.z);return i}}function jv(r,e,i,s,a,h,u,f){let g=u*a.getElevationAt(r,e,!0,!0),y=h[0]!==0,w=y?h[1]===0?u*(h[0]/7-450):u*function(E,I,R){let L=Math.floor(I[0]/8),k=Math.floor(I[1]/8),B=10*(I[0]-8*L),G=10*(I[1]-8*k),X=E.getElevationAt(L,k,!0,!0),W=E.getMeterToDEM(R),K=Math.floor(.5*(B*W-1)),pe=Math.floor(.5*(G*W-1)),ce=E.tileCoordToPixel(L,k),ue=2*K+1,ge=2*pe+1,ve=function(Ke,it,Fe,Je,Ie){return[Ke.getElevationAtPixel(it,Fe,!0),Ke.getElevationAtPixel(it+Ie,Fe,!0),Ke.getElevationAtPixel(it,Fe+Ie,!0),Ke.getElevationAtPixel(it+Je,Fe+Ie,!0)]}(E,ce.x-K,ce.y-pe,ue,ge),Ne=Math.abs(ve[0]-ve[1]),Ee=Math.abs(ve[2]-ve[3]),Ue=Math.abs(ve[0]-ve[2])+Math.abs(ve[1]-ve[3]),nt=Math.min(.25,.5*W*(Ne+Ee)/ue),qe=Math.min(.25,.5*W*Ue/ge);return X+Math.max(nt*B,qe*G)}(a,h,f):g;return{base:g+(i===0?-1:i),top:y?Math.max(w+s,g+i+2):g+s}}class _I{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class gI{constructor(){this.tasks={},this.taskQueue=[],Ht(["process"],this),this.invoker=new _I(this.process),this.nextId=0}add(e,i){let s=this.nextId++,a=function({type:h,isSymbolTile:u,zoom:f}){return f=f||0,h==="message"?0:h!=="maybePrepare"||u?h!=="parseTile"||u?h==="parseTile"&&u?300-f:h==="maybePrepare"&&u?400-f:500:200-f:100-f}(i);if(a===0){try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:i,priority:a,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;let e=this.pick();if(e===null)return;let i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let a=0;a<this.taskQueue.length;a++){let h=this.tasks[this.taskQueue[a]];h.priority<i&&(i=h.priority,e=a)}if(e===null)return null;let s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class Gv{constructor(e,i,s){this.target=e,this.parent=i,this.mapId=s,this.callbacks={},this.cancelCallbacks={},Ht(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new gI}send(e,i,s,a,h=!1,u){let f=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=u,this.callbacks[f]=s);let g=new Set;return this.target.postMessage({id:f,type:e,hasCallback:!!s,targetMapId:a,mustQueue:h,sourceMapId:this.mapId,data:Ps(i,g)},g),{cancel:()=>{s&&delete this.callbacks[f],this.target.postMessage({id:f,type:"<cancel>",targetMapId:a,sourceMapId:this.mapId})}}}receive(e){let i=e.data;if(!i)return;let s=i.id;if(s&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){let a=this.cancelCallbacks[s];delete this.cancelCallbacks[s],a&&a.cancel()}else if(i.mustQueue||Hi(self)){let a=this.callbacks[s],h=this.scheduler.add(()=>this.processTask(s,i),a&&a.metadata||{type:"message"});h&&(this.cancelCallbacks[s]=h)}else this.processTask(s,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){let s=this.callbacks[e];delete this.callbacks[e],s&&(i.error?s(Hn(i.error)):s(null,Hn(i.data)))}else{let s=new Set,a=i.hasCallback?(u,f)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:u?Ps(u):null,data:Ps(f,s)},s)}:()=>{},h=Hn(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,h,a);else if(this.parent.getWorkerSource){let u=i.type.split("."),{source:f,scope:g}=h;this.parent.getWorkerSource(i.sourceMapId,u[0],f,g)[u[1]](h,a)}else a(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Op={workerUrl:"",workerClass:null,workerParams:void 0};let uy="mapboxgl_preloaded_worker_pool";class rh{constructor(){this.active={}}acquire(e,i=rh.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(Op.workerClass!=null?new Op.workerClass:new self.Worker(Op.workerUrl,Op.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[uy]}numActive(){return Object.keys(this.active).length}}rh.workerCount=2;class Mu{constructor(e,i,s="Worker",a=rh.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=He();let h=this.workerPool.acquire(this.id,a);for(let u=0;u<h.length;u++){let f=new Mu.Actor(h[u],i,this.id);f.name=`${s} ${u}`,this.actors.push(f)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,s){be(this.actors,(a,h)=>{a.send(e,i,h)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let kp,dy;function Xm(){return kp||(kp=new rh),kp}Mu.Actor=Gv;class yI{constructor(e){this.module=e}createIntArray(e){let i=new Int32Array(e),s=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heap32.set(i,s/i.BYTES_PER_ELEMENT),s}createFloatArray(e){let i=new Float32Array(e),s=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heapF32.set(i,s/i.BYTES_PER_ELEMENT),s}createStringBuffer(e){let i=this.module.malloc(e.length+1);for(let s=0;s<e.length;++s)this.module.heapU8[i+s]=e.charCodeAt(s);return this.module.heapU8[i+e.length]=0,i}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){let i=e.entranceColorRgb,s=e.facadeGlazingColorRgb,a=e.roofColorRgb,h=e.wallColorRgb,u=e.normalScale;this.module.setStyle(i[0],i[1],i[2],s[0],s[1],s[2],a[0],a[1],a[2],h[0],h[1],h[2],u[0],u[1],u[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,i){this.module.setFacadeOptions(e,i?1:0)}setFauxFacadeOptions(e,i,s){this.module.setFauxFacadeOptions(e?1:0,i?1:0,s)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,i){for(let f of e){let g=this.createStringBuffer(f.roofType),y=[0],w=[];for(let R of f.coordinates)if(Array.isArray(R)){for(let L of R)w.push(L.x),w.push(L.y);y.push(w.length)}let E=this.createIntArray(y),I=this.createFloatArray(w);this.module.addFeature(f.id,f.sourceId,f.minHeight,f.height,g,f.roofType.length,I,E,y.length-1),this.module.free(g),this.module.free(E),this.module.free(I)}for(let f of i){let g;g=f.entrances?JSON.parse(f.entrances):[];let y=this.createFloatArray(g),w=[];for(let I of f.coordinates)w.push(I.x),w.push(I.y);let E=this.createFloatArray(w);this.module.addFacade(f.sourceId,f.crossPerc,f.distanceToRoad,y,g.length,E,w.length),this.module.free(y),this.module.free(E)}if(!this.module.generateMesh()){let f=this.module.getLastError();return this.readStringBuffer(f)}let s=this.module.getMeshCount(),a=new Array(s);for(let f=0;f<s;f++){let g=this.module.getPositionsPtr(f),y=this.module.getPositionsLength(f),w=new Float32Array(this.module.heapF32.buffer,g,y),E=this.module.getNormalsPtr(f),I=this.module.getNormalsLength(f),R=new Float32Array(this.module.heapF32.buffer,E,I),L=this.module.getColorsPtr(f),k=this.module.getColorsLength(f),B=new Uint8Array(this.module.heapU8.buffer,L,k),G=this.module.getAOPtr(f),X=this.module.getAOLength(f),W=new Float32Array(this.module.heapF32.buffer,G,X),K=this.module.getUVPtr(f),pe=this.module.getUVLength(f),ce=new Float32Array(this.module.heapF32.buffer,K,pe),ue=this.module.getFauxFacadePtr(f),ge=this.module.getFauxFacadeLength(f),ve=new Uint8Array(this.module.heapU8.buffer,ue,ge),Ne=this.module.getIndicesPtr(f),Ee=this.module.getIndicesLength(f),Ue=new Int32Array(this.module.heap32.buffer,Ne,Ee),nt=this.module.getBuildingPart(f),qe=this.readStringBuffer(nt);a[f]={positions:w,normals:R,colors:B,ao:W,uv:ce,isFauxFacade:ve,indices:Ue,buildingPart:qe}}let h=this.module.getRingCount(),u=[];for(let f=0;f<h;f++){let g=this.module.getRingPtr(f),y=this.module.getRingLength(f),w=new Float32Array(this.module.heapF32.buffer,g,y);u.push(w)}return{meshes:a,modifiedPolygonRings:u}}}let Fp,py,Ls,Cu,fy,Pu=null,Ru=null,qv=null,Ym=null;function Hv(){return Hi(self)&&self.worker.dracoUrl?self.worker.dracoUrl:py||mn.DRACO_URL}function $v(){if(Hi(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Cu)return Cu;let r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Cu=WebAssembly.validate(r)?mn.MESHOPT_SIMD_URL:mn.MESHOPT_URL,Cu}function xI(){return Ym}let Km={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},vI={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Bp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Zv(r,e,i){let s=i.json.bufferViews.length,a=i.buffers.length;e.bufferView=s,i.json.bufferViews[s]={buffer:a,byteLength:r.byteLength},i.buffers[a]=r}let my="KHR_draco_mesh_compression";function bI(r,e){let i=r.extensions&&r.extensions[my];if(!i)return;let s=new Ls.Decoder,a=Kv(e,i.bufferView),h=new Ls.Mesh;if(!s.DecodeArrayToMesh(a,a.byteLength,h))throw new Error("Failed to decode Draco mesh");let u=e.json.accessors[r.indices],f=Km[u.componentType],g=u.count*f.BYTES_PER_ELEMENT,y=Ls._malloc(g);f===Uint16Array?s.GetTrianglesUInt16Array(h,g,y):s.GetTrianglesUInt32Array(h,g,y),Zv(Ls.memory.buffer.slice(y,y+g),u,e),Ls._free(y);for(let w of Object.keys(i.attributes)){let E=s.GetAttributeByUniqueId(h,i.attributes[w]),I=e.json.accessors[r.attributes[w]],R=vI[I.componentType],L=I.count*Bp[I.type]*Km[I.componentType].BYTES_PER_ELEMENT,k=Ls._malloc(L);s.GetAttributeDataArrayForAllPoints(h,E,Ls[R],L,k),Zv(Ls.memory.buffer.slice(k,k+L),I,e),Ls._free(k)}s.destroy(),h.destroy(),delete r.extensions[my]}let Jm="EXT_meshopt_compression";function wI(r,e){if(!r.extensions||!r.extensions[Jm])return;let i=r.extensions[Jm],s=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),a=new Uint8Array(i.count*i.byteStride);fy.decodeGltfBuffer(a,i.count,i.byteStride,s,i.mode,i.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=a.buffer,delete r.extensions[Jm]}let Wv=1179937895,Xv=new TextDecoder("utf8");function Yv(r,e){return new URL(r,e).href}function TI(r,e,i,s){return fetch(Yv(r.uri,s)).then(a=>a.arrayBuffer()).then(a=>{e.buffers[i]=a})}function Kv(r,e){let i=r.json.bufferViews[e];return new Uint8Array(r.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function SI(r,e,i,s){if(r.uri){let a=Yv(r.uri,s);return fetch(a).then(h=>h.blob()).then(h=>createImageBitmap(h)).then(h=>{e.images[i]=h})}if(r.bufferView!==void 0){let a=Kv(e,r.bufferView),h=new Blob([a],{type:r.mimeType});return createImageBitmap(h).then(u=>{e.images[i]=u})}}function Jv(r,e=0,i){let s={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===Wv){let w=new Uint32Array(r,e),E=2,I=(w[E++]>>2)-3,R=w[E++]>>2;if(E++,s.json=JSON.parse(Xv.decode(w.subarray(E,E+R))),E+=R,E<I){let L=w[E++];E++;let k=e+(E<<2);s.buffers[0]=r.slice(k,k+L)}}else s.json=JSON.parse(Xv.decode(new Uint8Array(r,e)));let{buffers:a,images:h,meshes:u,extensionsUsed:f,bufferViews:g}=s.json,y=Promise.resolve();if(a){let w=[];for(let E=0;E<a.length;E++){let I=a[E];I.uri?w.push(TI(I,s,E,i)):s.buffers[E]||(s.buffers[E]=null)}y=Promise.all(w)}return y.then(()=>{let w=[],E=f&&f.includes(my),I=f&&f.includes(Jm);if(E&&w.push(function(){if(!Ls)return Fp??(Fp=function(R){let L,k=null;function B(){L=new Uint8Array(k.buffer)}function G(){throw new Error("Unexpected Draco error.")}let X={a:{a:G,d:function(W,K,pe){return L.copyWithin(W,K,K+pe)},c:function(W){let K=L.length,pe=Math.max(W>>>0,Math.ceil(1.2*K)),ce=Math.ceil((pe-K)/65536);try{return k.grow(ce),B(),!0}catch{return!1}},b:G}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(R,X):R.then(W=>W.arrayBuffer()).then(W=>WebAssembly.instantiate(W,X))).then(W=>{let{Rb:K,Qb:pe,P:ce,T:ue,X:ge,Ja:ve,La:Ne,Qa:Ee,Va:Ue,Wa:nt,eb:qe,jb:Ke,f:it,e:Fe,yb:Je,zb:Ie,Ab:Be,Bb:at,Db:et,Gb:Lt}=W.instance.exports;k=Fe;let St=(()=>{let Xe=0,tt=0,It=0,xt=0;return ut=>{It&&(K(xt),K(Xe),tt+=It,It=Xe=0),Xe||(tt+=128,Xe=pe(tt));let vt=ut.length+7&-8,Vt=Xe;vt>=tt&&(It=vt,Vt=xt=pe(vt));for(let Zt=0;Zt<ut.length;Zt++)L[Vt+Zt]=ut[Zt];return Vt}})();return B(),it(),{memory:Fe,_free:K,_malloc:pe,Mesh:class{constructor(){this.ptr=ce()}destroy(){ue(this.ptr)}},Decoder:class{constructor(){this.ptr=ve()}destroy(){Ke(this.ptr)}DecodeArrayToMesh(Xe,tt,It){let xt=St(Xe),ut=Ne(this.ptr,xt,tt,It.ptr);return!!ge(ut)}GetAttributeByUniqueId(Xe,tt){return{ptr:Ee(this.ptr,Xe.ptr,tt)}}GetTrianglesUInt16Array(Xe,tt,It){Ue(this.ptr,Xe.ptr,tt,It)}GetTrianglesUInt32Array(Xe,tt,It){nt(this.ptr,Xe.ptr,tt,It)}GetAttributeDataArrayForAllPoints(Xe,tt,It,xt,ut){qe(this.ptr,Xe.ptr,tt.ptr,It,xt,ut)}},DT_INT8:Je(),DT_UINT8:Ie(),DT_INT16:Be(),DT_UINT16:at(),DT_UINT32:et(),DT_FLOAT32:Lt()}})}(fetch(Hv())),Fp.then(R=>{Ls=R,Fp=void 0}))}()),I&&w.push(function(){if(fy)return;let R=function(L){let k,B=WebAssembly.instantiateStreaming(L,{}).then(W=>{k=W.instance,k.exports.__wasm_call_ctors()}),G={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},X={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:B,supported:!0,decodeGltfBuffer(W,K,pe,ce,ue,ge){(function(ve,Ne,Ee,Ue,nt,qe,Ke){let it=ve.exports.sbrk,Fe=Ue+3&-4,Je=it(Fe*nt),Ie=it(qe.length),Be=new Uint8Array(ve.exports.memory.buffer);Be.set(qe,Ie);let at=Ne(Je,Ue,nt,Ie,qe.length);if(at===0&&Ke&&Ke(Je,Fe,nt),Ee.set(Be.subarray(Je,Je+Ue*nt)),it(Je-it(0)),at!==0)throw new Error(`Malformed buffer data: ${at}`)})(k,k.exports[X[ue]],W,K,pe,ce,k.exports[G[ge]])}}}(fetch($v()));return R.ready.then(()=>{fy=R})}()),h)for(let R=0;R<h.length;R++)w.push(SI(h[R],s,R,i));return(w.length?Promise.all(w):Promise.resolve()).then(()=>{if(E&&u)for(let{primitives:R}of u)for(let L of R)bI(L,s);if(I&&u&&g)for(let R of g)wI(R,s);return s})})}function _y(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function gy(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class yy{constructor(e,i,s,a){this.context=e,this.format=s,this.useMipmap=a&&a.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:a&&a.premultiply})}update(e,i){let s=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,a=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:h}=this,{gl:u}=h,{x:f,y:g}=i&&i.position?i.position:{x:0,y:0},y=f+s,w=g+a;!this.size||this.size[0]===y&&this.size[1]===w||(u.bindTexture(u.TEXTURE_2D,null),u.deleteTexture(this.texture),this.texture=u.createTexture(),this.size=null),u.bindTexture(u.TEXTURE_2D,this.texture),h.pixelStoreUnpackFlipY.set(!1),h.pixelStoreUnpack.set(1),h.pixelStoreUnpackPremultiplyAlpha.set(this.format===u.RGBA8&&(!i||i.premultiply!==!1));let E=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&y>0&&w>0){let I=this.useMipmap?Math.floor(Math.log2(Math.max(y,w)))+1:1;u.texStorage2D(u.TEXTURE_2D,I,this.format,y,w),this.size=[y,w]}if(this.size)if(E)u.texSubImage2D(u.TEXTURE_2D,0,f,g,_y(this.format),gy(this.format),e);else{let I=e.data;I&&u.texSubImage2D(u.TEXTURE_2D,0,f,g,s,a,_y(this.format),gy(this.format),I)}this.useMipmap&&u.generateMipmap(u.TEXTURE_2D)}bind(e,i,s=!1){let{context:a}=this,{gl:h}=a;h.bindTexture(h.TEXTURE_2D,this.texture),e!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===h.NEAREST?h.NEAREST_MIPMAP_NEAREST:h.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,s,a,h){let{context:u}=this,{gl:f}=u;f.bindTexture(f.TEXTURE_2D,this.texture),i!==this.magFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,this.useMipmap?e===f.NEAREST?f.NEAREST_MIPMAP_NEAREST:f.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,s),this.wrapS=s),a!==this.wrapT&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,a),this.wrapT=a),h!==this.compareMode&&(h?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.COMPARE_REF_TO_TEXTURE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_FUNC,h)):f.texParameteri(f.TEXTURE_2D,f.TEXTURE_COMPARE_MODE,f.NONE),this.compareMode=h)}destroy(){let{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Np{constructor(e,i){this.context=e,this.texture=i}bind(e,i){let{context:s}=this,{gl:a}=s;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}}let EI=gi([{name:"a_pos_3f",components:3,type:"Float32"}]),II=gi([{name:"a_color_3f",components:3,type:"Float32"}]),AI=gi([{name:"a_color_4f",components:4,type:"Float32"}]),MI=gi([{name:"a_uv_2f",components:2,type:"Float32"}]),CI=gi([{name:"a_normal_3f",components:3,type:"Float32"}]),PI=gi([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),RI=gi([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function Qv(r,e){let i=Qm(r.projection,r.zoom,r.width,r.height),s=function(h,u,f,g,y){let w=new C(f.lng-180*Vl,f.lat),E=new C(f.lng+180*Vl,f.lat),I=h.project(w.lng,w.lat),R=h.project(E.lng,E.lat),L=-Math.atan2(R.y-I.y,R.x-I.x),k=le.fromLngLat(f);k.y=re(k.y,-1+Vl,1-Vl);let B=k.toLngLat(),G=h.project(B.lng,B.lat),X=le.fromLngLat(B);X.x+=Vl;let W=X.toLngLat(),K=h.project(W.lng,W.lat),pe=t1(K.x-G.x,K.y-G.y,L),ce=le.fromLngLat(B);ce.y+=Vl;let ue=ce.toLngLat(),ge=h.project(ue.lng,ue.lat),ve=t1(ge.x-G.x,ge.y-G.y,L),Ne=Math.abs(pe.x)/Math.abs(ve.y),Ee=xe([]);At(Ee,Ee,-L*(1-(y?0:g)));let Ue=xe([]);return ft(Ue,Ue,[1,1-(1-Ne)*g,1]),Ue[4]=-ve.x/ve.y*g,At(Ue,Ue,L),Te(Ue,Ee,Ue),Ue}(r.projection,0,r.center,i,e),a=e1(r);return ft(s,s,[a,a,1]),s}function e1(r){let e=r.projection,i=Qm(r.projection,r.zoom,r.width,r.height),s=xy(e,r.center),a=xy(e,C.convert(e.center));return Math.pow(2,s*i+(1-i)*a)}function Qm(r,e,i,s,a=1/0){let h=r.range;if(!h)return 0;let u=Math.min(a,Math.max(i,s)),f=Math.log(u/1024)/Math.LN2;return ye(h[0]+f,h[1]+f,e)}let Vl=1/4e4;function xy(r,e){let i=re(e.lat,-ne,ne),s=new C(e.lng-180*Vl,i),a=new C(e.lng+180*Vl,i),h=r.project(s.lng,i),u=r.project(a.lng,i),f=le.fromLngLat(s),g=le.fromLngLat(a),y=u.x-h.x,w=u.y-h.y,E=g.x-f.x,I=g.y-f.y,R=Math.sqrt((E*E+I*I)/(y*y+w*w));return Math.log(R)/Math.LN2}function t1(r,e,i){let s=Math.cos(i),a=Math.sin(i);return{x:r*s-e*a,y:r*a+e*s}}function i1(r,e,i){xe(r),At(r,r,Ai(e[2])),_t(r,r,Ai(e[0])),Pt(r,r,Ai(e[1])),ft(r,r,i),Te(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function e_(r,e,i,s,a,h,u,f){let g=[i[0]-e[0],i[1]-e[1],0],y=[s[0]-e[0],s[1]-e[1],0];if(Ni(g)<1e-12||Ni(y)<1e-12)return bs(r);let w=Vr([],g,y);Oi(w,w),mr(y,s,e),g[2]=(h-a)*f,y[2]=(u-a)*f;let E=g;return Vr(E,g,y),Oi(E,E),Ka(r,w,E)}function vy(r,e,i=!1){let s=Fl(e.zoom),a=function(h,u,f){let g=u.worldSize,y=[h[12],h[13],h[14]],w=Y(y[1]/g),E=Z(y[0]/g),I=xe([]),R=U(1,w)*g,L=U(1,0)*g*de(w,u.zoom),k=1/Wg(g),B=L*k;if(f){let K=Qm(u.projection,u.zoom,u.width,u.height,1024);B=k*u.projection.pixelSpaceConversion(u.center.lat,g,K)}let G=x(w,E);vi(G,G,Xi([],Oi([],G),R*B*y[2]));let X=function(K){let pe=[K[0],K[1],K[2]],ce=[0,1,0],ue=Vr([],ce,pe);return Vr(ce,pe,ue),Ro(ce)===0&&(ce=[0,1,0],Vr(ue,pe,ce)),Oi(ue,ue),Oi(ce,ce),Oi(pe,pe),[ue[0],ue[1],ue[2],0,ce[0],ce[1],ce[2],0,pe[0],pe[1],pe[2],0,K[0],K[1],K[2],1]}(G);ft(I,I,[B,B,B*R]),We(I,I,[-y[0],-y[1],-y[2]]);let W=Te([],u.globeMatrix,X);return Te(W,W,I),Te(W,W,h),W}(r,e,i);if(s>0){let h=function(u,f){let g=f.worldSize,y=U(1,0)*g*de(f.center.lat,f.zoom)/Wg(g),w=U(1,f.center.lat)*g,E=xe([]);return Pt(E,E,Ai(f.center.lng)),_t(E,E,Ai(f.center.lat)),We(E,E,[0,0,Cn]),ft(E,E,[y,y,y*w]),We(E,E,[f.point.x-.5*g,f.point.y-.5*g,0]),Te(E,E,u),Te(E,f.globeMatrix,E)}(r,e);return function(u,f,g){let y=(L,k,B)=>{let G=Ni(L),X=Ni(k),W=Ua(L,k,B);return Xi(W,W,1/Ni(W)*Bt(G,X,B))},w=y([u[0],u[1],u[2]],[f[0],f[1],f[2]],g),E=y([u[4],u[5],u[6]],[f[4],f[5],f[6]],g),I=y([u[8],u[9],u[10]],[f[8],f[9],f[10]],g),R=Ua([u[12],u[13],u[14]],[f[12],f[13],f[14]],g);return[w[0],w[1],w[2],0,E[0],E[1],E[2],0,I[0],I[1],I[2],0,R[0],R[1],R[2],1]}(a,h,s)}return a}function r1(r,e,i,s){let a=li.projectAabbCorners(s,i),h=Number.MAX_VALUE,u=-1;for(let y=0;y<a.length;++y){let w=a[y];w[0]=(.5*w[0]+.5)*e.width,w[1]=(.5-.5*w[1])*e.height,w[2]<h&&(u=y,h=w[2])}let f=y=>new Qe(a[y][0],a[y][1]),g;switch(u){case 0:case 6:g=[f(1),f(5),f(4),f(7),f(3),f(2),f(1)];break;case 1:case 7:g=[f(0),f(4),f(5),f(6),f(2),f(3),f(0)];break;case 3:case 5:g=[f(1),f(0),f(4),f(7),f(6),f(2),f(1)];break;default:g=[f(1),f(5),f(6),f(7),f(3),f(0),f(1)]}if($i(r,g))return h}let nh=64,Lu={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function n1(r,e,i,s,a,h,u,f,g,y=!1){let w=i.zoom,E=i.project(s),I=de(s.lat,w),R=1/I;xe(r),We(r,r,[E.x+u[0]*R,E.y+u[1]*R,u[2]]);let L=1,k=1,B=i.worldSize;if(y){if(i.projection.name==="mercator"){let K=0;i.elevation&&(K=i.elevation.getAtPointOrZero(new le(E.x/B,E.y/B),0));let pe=Yn([],[E.x,E.y,K,1],i.projMatrix)[3]/i.cameraToCenterDistance;L=pe,k=pe*de(i.center.lat,w)}else if(i.projection.name==="globe"){let K=vy(r,i),pe=[0,0,0,1];Yn(pe,pe,Te([],i.projMatrix,K));let ce=pe[3]/i.cameraToCenterDistance,ue=Fl(w),ge=i.projection.pixelsPerMeter(s.lat,B)*de(s.lat,w),ve=i.projection.pixelsPerMeter(i.center.lat,B)*de(i.center.lat,w);L=ce/Bt(ge,he(i.center.lat),ue),k=ce*I/ge,L*=ve,k*=ve}}else L=R;ft(r,r,[L,L,k]);let G=[...r],X=e.orientation,W=[];if(i1(W,[X[0]+a[0],X[1]+a[1],X[2]+a[2]],h),Te(r,G,W),f&&i.elevation){let K=0,pe=[];if(g&&i.elevation){K=function(ue,ge,ve,Ne,Ee){let Ue=ge.elevation;if(!Ue)return 0;let nt=li.projectAabbCorners(ve,Ne),qe=U(1,Ee.lat)*ge.worldSize,Ke=function(tt,It){let xt=[0,0,1],ut=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let vt of ut){let Vt=tt[vt.corners[0]],Zt=tt[vt.corners[1]],Qt=tt[vt.corners[2]],Kt=[Zt[0]-Vt[0],Zt[1]-Vt[1],It*(Zt[2]-Vt[2])],fi=Vr(Kt,Kt,[Qt[0]-Vt[0],Qt[1]-Vt[1],It*(Qt[2]-Vt[2])]);Oi(fi,fi),vt.dotProductWithUp=or(fi,xt)}return ut.sort((vt,Vt)=>vt.dotProductWithUp-Vt.dotProductWithUp),ut[0].corners}(nt,qe),it=nt[Ke[0]],Fe=nt[Ke[1]],Je=nt[Ke[2]],Ie=nt[Ke[3]],Be=Ue.getAtPointOrZero(new le(it[0]/ge.worldSize,it[1]/ge.worldSize),0),at=Ue.getAtPointOrZero(new le(Fe[0]/ge.worldSize,Fe[1]/ge.worldSize),0),et=Ue.getAtPointOrZero(new le(Je[0]/ge.worldSize,Je[1]/ge.worldSize),0),Lt=Ue.getAtPointOrZero(new le(Ie[0]/ge.worldSize,Ie[1]/ge.worldSize),0),St=(Be+Lt)/2,Xe=(at+et)/2;return St>Xe?at<et?e_(ue,Fe,Ie,it,at,Lt,Be,qe):e_(ue,Je,it,Ie,et,Be,Lt,qe):Be<Lt?e_(ue,it,Fe,Je,Be,at,et,qe):e_(ue,Ie,Je,Fe,Lt,et,at,qe),Math.max(St,Xe)}(pe,i,e.aabb,r,s);let ce=Te([],Ft([],pe),W);Te(r,G,ce)}else K=i.elevation.getAtPointOrZero(new le(E.x/B,E.y/B),0);K!==0&&(r[14]+=K)}}function Vp(r,e,i=!1){r.uploaded||(r.gfxTexture=new yy(e,r.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function LI(r,e,i){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,EI.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,CI.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,MI.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?II:AI).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,RI.members,!0)),r.segments=gr.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);let s=r.material;s.pbrMetallicRoughness.baseColorTexture&&Vp(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&Vp(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&Vp(s.normalTexture,e),s.occlusionTexture&&Vp(s.occlusionTexture,e,i),s.emissionTexture&&Vp(s.emissionTexture,e)}function by(r,e,i){if(r.meshes)for(let s of r.meshes)LI(s,e,i);if(r.children)for(let s of r.children)by(s,e,i)}function t_(r){if(r.meshes)for(let e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(let e of r.children)t_(e)}function wy(r){if(r.meshes)for(let i of r.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(let i of r.children)wy(i)}function oh(r,e){let i=r.json.bufferViews[e.bufferView],s=Km[e.componentType];return new s(r.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==Bp[e.type]*s.BYTES_PER_ELEMENT?i.byteStride/s.BYTES_PER_ELEMENT:Bp[e.type]))}function Ty(r,e,i,s){let a=Km[e.componentType],h=function(w){switch(w){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(a),u=r.json.bufferViews[e.bufferView],f=u.byteStride?u.byteStride/a.BYTES_PER_ELEMENT:Bp[e.type],g=i.float32,y=g.length/i.capacity;for(let w=0,E=0;w<e.count*f;w+=f,E+=y)for(let I=0;I<y;I++)g[E+I]=s[w+I]*h;i._trim()}function zI(r,e,i){let s=r.indices,a=r.attributes,h={};h.indexArray=new ur;let u=e.json.accessors[s],f=u.count/3;h.indexArray.reserve(f);let g=oh(e,u);for(let I=0;I<f;I++)h.indexArray.emplaceBack(g[3*I],g[3*I+1],g[3*I+2]);h.indexArray._trim(),h.vertexArray=new yo;let y=e.json.accessors[a.POSITION];h.vertexArray.reserve(y.count);let w=oh(e,y);for(let I=0;I<y.count;I++)h.vertexArray.emplaceBack(w[3*I],w[3*I+1],w[3*I+2]);if(h.vertexArray._trim(),h.aabb=new li(y.min,y.max),h.centroid=function(I,R){let L=[0,0,0],k=I.length;if(k>0){for(let B=0;B<k;B++){let G=3*I[B];L[0]+=R[G],L[1]+=R[G+1],L[2]+=R[G+2]}L[0]/=k,L[1]/=k,L[2]/=k}return L}(g,w),a.COLOR_0!==void 0){let I=e.json.accessors[a.COLOR_0],R=Bp[I.type],L=oh(e,I);h.colorArray=R===3?new yo:new sa,h.colorArray.resize(I.count),Ty(e,I,h.colorArray,L)}if(a.NORMAL!==void 0){h.normalArray=new yo;let I=e.json.accessors[a.NORMAL];h.normalArray.resize(I.count);let R=oh(e,I);Ty(e,I,h.normalArray,R)}if(a.TEXCOORD_0!==void 0&&i.length>0){h.texcoordArray=new aa;let I=e.json.accessors[a.TEXCOORD_0];h.texcoordArray.resize(I.count);let R=oh(e,I);Ty(e,I,h.texcoordArray,R)}if(a._FEATURE_ID_RGBA4444!==void 0){let I=e.json.accessors[a._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(h.featureData=oh(e,I))}a._FEATURE_RGBA4444!==void 0&&(h.featureData=new Uint32Array(oh(e,e.json.accessors[a._FEATURE_RGBA4444]).buffer));let E=r.material;return h.material=function(I,R){let{emissiveFactor:L=[0,0,0],alphaMode:k="OPAQUE",alphaCutoff:B=.5,normalTexture:G,occlusionTexture:X,emissiveTexture:W,doubleSided:K}=I,{baseColorFactor:pe=[1,1,1,1],metallicFactor:ce=1,roughnessFactor:ue=1,baseColorTexture:ge,metallicRoughnessTexture:ve}=I.pbrMetallicRoughness||{},Ne=X?R[X.index]:void 0;if(X&&X.extensions&&X.extensions.KHR_texture_transform&&Ne){let Ee=X.extensions.KHR_texture_transform;Ne.offsetScale=[Ee.offset[0],Ee.offset[1],Ee.scale[0],Ee.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new ki(...pe),metallicFactor:ce,roughnessFactor:ue,baseColorTexture:ge?R[ge.index]:void 0,metallicRoughnessTexture:ve?R[ve.index]:void 0},doubleSided:K,emissiveFactor:new ki(...L),alphaMode:k,alphaCutoff:B,normalTexture:G?R[G.index]:void 0,occlusionTexture:Ne,emissionTexture:W?R[W.index]:void 0,defined:I.defined===void 0}}(E!==void 0?e.json.materials[E]:{defined:!1},i),h}function o1(r,e,i){let{matrix:s,rotation:a,translation:h,scale:u,mesh:f,extras:g,children:y}=r,w={};if(w.matrix=s||function(E,I,R,L){var k=I[0],B=I[1],G=I[2],X=I[3],W=k+k,K=B+B,pe=G+G,ce=k*W,ue=k*K,ge=k*pe,ve=B*K,Ne=B*pe,Ee=G*pe,Ue=X*W,nt=X*K,qe=X*pe,Ke=L[0],it=L[1],Fe=L[2];return E[0]=(1-(ve+Ee))*Ke,E[1]=(ue+qe)*Ke,E[2]=(ge-nt)*Ke,E[3]=0,E[4]=(ue-qe)*it,E[5]=(1-(ce+Ee))*it,E[6]=(Ne+Ue)*it,E[7]=0,E[8]=(ge+nt)*Fe,E[9]=(Ne-Ue)*Fe,E[10]=(1-(ce+ve))*Fe,E[11]=0,E[12]=R[0],E[13]=R[1],E[14]=R[2],E[15]=1,E}([],a||[0,0,0,1],h||[0,0,0],u||[1,1,1]),f!==void 0){w.meshes=i[f];let E=w.anchor=[0,0];for(let I of w.meshes){let{min:R,max:L}=I.aabb;E[0]+=R[0]+L[0],E[1]+=R[1]+L[1]}E[0]=Math.floor(E[0]/w.meshes.length/2),E[1]=Math.floor(E[1]/w.meshes.length/2)}if(g&&(g.id&&(w.id=g.id),g.lights&&(w.lights=function(E){if(!E.length)return[];let I=function(G){let X=atob(G),W=new Uint8Array(X.length);for(let K=0;K<X.length;K++)W[K]=X.codePointAt(K);return W}(E),R=[],L=I.length/24,k=new Uint16Array(I.buffer),B=new Float32Array(I.buffer);for(let G=0;G<L;G++){let X=k[2*G*6]/30,W=k[2*G*6+1]/30,K=k[2*G*6+10]/100,pe=B[6*G+1],ce=B[6*G+2],ue=B[6*G+3],ge=B[6*G+4],ve=ue-pe,Ne=ge-ce,Ee=Math.hypot(ve,Ne);R.push({pos:[pe+.5*ve,ce+.5*Ne,W],normal:[Ne/Ee,-ve/Ee,0],width:Ee,height:X,depth:K,points:[pe,ce,ue,ge]})}return R}(g.lights))),y){let E=[];for(let I of y)E.push(o1(e.json.nodes[I],e,i));w.children=E}return w}function DI(r){if(r.vertices.length===0||r.indices.length===0)return null;let e=new Gm(r.vertices,r.indices,8,256),[i,s]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:i,max:s}}function OI(r){if(!r.extras||!r.extras.ground)return null;let e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;let i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;let s=[];for(let u of i){if(!Array.isArray(u)||u.length!==2)continue;let f=u[0],g=u[1];typeof f=="number"&&typeof g=="number"&&s.push(new Qe(f,g))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let a=0;for(let u=0;u<s.length;u++){let f=s[u],g=s[(u+1)%s.length],y=s[(u+2)%s.length];a+=(f.x-g.x)*(y.y-g.y)-(y.x-g.x)*(f.y-g.y)}a>0&&s.reverse();let h=Iu(s.flatMap(u=>[u.x,u.y]),[]);return h.length===0?null:{vertices:s,indices:h}}function kI(r,e){let i=[],s=[],a=0,h=[];for(let u of r){a=i.length;let f=u.vertexArray.float32,g=u.indexArray.uint16;for(let y=0;y<u.vertexArray.length;y++)h[0]=f[3*y+0],h[1]=f[3*y+1],h[2]=f[3*y+2],Lr(h,h,e),i.push(new Qe(h[0],h[1]));for(let y=0;y<3*u.indexArray.length;y++)s.push(g[y]+a)}if(s.length%3!=0)return null;for(let u=0;u<s.length;u+=3){let f=i[s[u+0]],g=i[s[u+1]],y=i[s[u+2]];(f.x-g.x)*(y.y-g.y)-(y.x-g.x)*(f.y-g.y)>0&&([s[u+1],s[u+2]]=[s[u+2],s[u+1]])}return{vertices:i,indices:s}}function s1(r){let e=function(g,y){let w=[],E=WebGL2RenderingContext;if(g.json.textures)for(let I of g.json.textures){let R={magFilter:E.LINEAR,minFilter:E.NEAREST,wrapS:E.REPEAT,wrapT:E.REPEAT};I.sampler!==void 0&&Object.assign(R,g.json.samplers[I.sampler]),w.push({image:y[I.source],sampler:R,uploaded:!1})}return w}(r,r.images),i=function(g,y){let w=[];for(let E of g.json.meshes){let I=[];for(let R of E.primitives)I.push(zI(R,g,y));w.push(I)}return w}(r,e),{scenes:s,scene:a,nodes:h}=r.json,u=s?s[a||0].nodes:h,f=[];for(let g of u)f.push(o1(h[g],r,i));return function(g,y,w){let E={},I=new Set;for(let R=0;R<g.length;R++){let L=w[y[R]];if(!L.extras)continue;let k=L.extras["mapbox:footprint:version"],B=L.extras["mapbox:footprint:id"];(k||B)&&I.add(R),k==="1.0.0"&&B&&(E[B]=R)}for(let R=0;R<g.length;R++){if(I.has(R))continue;let L=g[R],k=w[y[R]];if(!k.extras)continue;let B=null;L.id in E&&(B=kI(g[E[L.id]].meshes,L.matrix)),B||(B=OI(k)),B&&(L.footprint=DI(B))}if(I.size>0){let R=Array.from(I.values()).sort((L,k)=>L-k);for(let L=R.length-1;L>=0;L--)g.splice(R[L],1)}}(f,u,r.json.nodes),f}function FI(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);let e=r.vertexArray.float32,i=r.aabb.min[0]-1,s=r.aabb.min[1]-1,a=nh/(r.aabb.max[0]-i+2),h=nh/(r.aabb.max[1]-s+2);for(let u=0;u<e.length;u+=3){let f=e[u+2],g=(e[u+0]-i)*a|0,y=(e[u+1]-s)*h|0;f>r.heightmap[y*nh+g]&&(r.heightmap[y*nh+g]=f)}}function a1(r,e,i,s,a){i.reserve(i.length+4*r.length),s.reserve(s.length+10*r.length),a.reserve(a.length+10*r.length);let h=s.length;for(let u of r){let f=Math.min(10,Math.max(4,1.3*u.height))*e,g=[-u.normal[1],u.normal[0],0],y=Math.min(.29,.1*u.width/u.depth),w=u.width-2*u.depth*e*(y+.01),E=tn([],u.pos,g,w/2),I=tn([],u.pos,g,-w/2),R=[E[0],E[1],E[2]+u.height],L=[I[0],I[1],I[2]+u.height],k=tn([],u.normal,g,y);Xi(k,k,f);let B=tn([],u.normal,g,-y);Xi(B,B,f),vi(k,E,k),vi(B,I,B),E[2]+=.1,I[2]+=.1,s.emplaceBack(k[0],k[1],k[2]),s.emplaceBack(B[0],B[1],B[2]),s.emplaceBack(E[0],E[1],E[2]),s.emplaceBack(I[0],I[1],I[2]),s.emplaceBack(R[0],R[1],R[2]),s.emplaceBack(L[0],L[1],L[2]),s.emplaceBack(E[0],E[1],E[2]),s.emplaceBack(I[0],I[1],I[2]),s.emplaceBack(k[0],k[1],k[2]),s.emplaceBack(B[0],B[1],B[2]);let G=w/f/2;a.emplaceBack(-G-y,-1,G,.8),a.emplaceBack(G+y,-1,G,.8),a.emplaceBack(-G,0,G,1.3),a.emplaceBack(G,0,G,1.3),a.emplaceBack(G+y,-.8,G,.7),a.emplaceBack(G+y,-.8,G,.7),a.emplaceBack(0,0,G,1.3),a.emplaceBack(0,0,G,1.3),a.emplaceBack(G+y,-1.2,G,.8),a.emplaceBack(G+y,-1.2,G,.8),i.emplaceBack(6+h,4+h,8+h),i.emplaceBack(7+h,9+h,5+h),i.emplaceBack(0+h,1+h,2+h),i.emplaceBack(1+h,3+h,2+h),h+=10}}function BI(r,e){let i={};i.indexArray=new ur,i.vertexArray=new yo,i.colorArray=new sa,a1(r,e,i.indexArray,i.vertexArray,i.colorArray);let s={defined:!0};s.emissiveFactor=ki.black;let a={};return a.baseColorFactor=ki.white,s.pbrMetallicRoughness=a,i.material=s,i.aabb=new li([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}let l1=gi([{name:"a_pos_3f",components:3,type:"Float32"}]),NI=gi([{name:"a_normal_3",components:3,type:"Int16"}]),c1=gi([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),VI=gi([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),h1=Pe.types,Sy=32767;function UI(r,e){let i=ht+e;for(let s of r)for(let a of s)if(a.x<-e||a.x>i||a.y<-e||a.y>i)return!1;return!0}class u1{constructor(e){this.layoutAOArray=[],this.indexArrayForConflationUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.layoutVertexArray=new yo,this.layoutNormalArray=new El,this.layoutColorArray=new cs,this.indexArray=new ur,this.indexArrayForConflation=new ur,this.entranceBloom={layoutVertexArray:new yo,layoutVertexBuffer:null,layoutAttenuationArray:new sa,layoutAttenuationBuffer:null,layoutColorArray:new cs,layoutColorBuffer:null,indexArray:new ur,indexArrayForConflation:new ur,indexBuffer:null,segmentsBucket:new gr},this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segmentsBucket=new gr,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection,this.groundEffect=new cy(e)}get segments(){return this.segmentsBucket}get bloomGeometry(){return this.entranceBloom}updateFootprints(e,i){for(let s of this.footprints)i.push({footprint:s,id:e})}prepare(){return function(){if(Ym!=null||qv!=null)return null;if(Ru!=null)return Ru;let e=fetch(mn.BUILDING_GEN_URL);return Ru=function(i){let s,a,h,u;function f(){s=new Uint8Array(u.buffer),a=new Int32Array(u.buffer),h=new Float32Array(u.buffer)}function g(){throw new Error("Unexpected BuildingGen error.")}let y=()=>{},w={a:{a:g,f:function(E){let I=s.length,R=Math.max(E>>>0,Math.ceil(1.2*I)),L=Math.ceil((R-I)/65536);try{return u.grow(L),f(),!0}catch{return!1}},g,b:y,c:y,d:y,e:y}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,w):i.then(E=>E.arrayBuffer()).then(E=>WebAssembly.instantiate(E,w))).then(E=>{let I=E.instance.exports;return(0,I.g)(),u=I.f,f(),new yI({setStyle:I.h,setAOOptions:I.i,setMetricOptions:I.j,setStructuralOptions:I.k,setFacadeOptions:I.l,setFauxFacadeOptions:I.m,setFacadeClassifierOptions:I.n,addFeature:I.o,addFacade:I.p,generateMesh:I.q,getLastError:I.r,getMeshCount:I.s,getPositionsPtr:I.t,getPositionsLength:I.u,getNormalsPtr:I.v,getNormalsLength:I.w,getColorsPtr:I.x,getColorsLength:I.y,getAOPtr:I.z,getAOLength:I.A,getUVPtr:I.B,getUVLength:I.C,getFauxFacadePtr:I.D,getFauxFacadeLength:I.E,getIndicesPtr:I.F,getIndicesLength:I.G,getBuildingPart:I.H,getRingCount:I.I,getRingPtr:I.J,getRingLength:I.K,free:I.L,malloc:I.M,heapU8:s,heap32:a,heapF32:h})})}(e).then(i=>(Ru=null,Ym=i,Ym)).catch(i=>{pi("Could not load building-gen"),Ru=null,qv=i}),Ru}()}populate(e,i,s,a){let h=xI();if(!h)return;let u=se(s);this.tileToMeter=u,this.brightness=i.brightness,h.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,u],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:u,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),h.setAOOptions(!1,.3),h.setMetricOptions(!1,16),h.setStructuralOptions(!0),h.setFacadeOptions(4,!0),h.setFauxFacadeOptions(!1,!1,1),h.setFacadeClassifierOptions(3);let f=new Map;for(let{feature:g}of e){if(h1[g.type]!=="LineString")continue;let y=this.layers[0]._featureFilter.needGeometry,w=ke(g,y);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),w,s))continue;let E=y?w.geometry:me(g,s,a),I=[];for(let B of E)for(let G of B)I.push({x:G.x,y:G.y});let R={coordinates:I,crossPerc:g.properties.cross_perc,distanceToRoad:g.properties.distance_to_road,entrances:g.properties.entrances,sourceId:0},L=g.properties.source_id,k=f.get(L);k||(k=[],f.set(L,k)),k.push(R)}this.maxHeight=0;for(let{feature:g,index:y}of e){if(h1[g.type]==="LineString")continue;let w=this.layers[0]._featureFilter.needGeometry,E=ke(g,w);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom),E,s))continue;let I=w?E.geometry:me(g,s,a),R=Cp(I,500);if(!UI(I,163))continue;let L=this.layers[0],k=L.layout.get("building-base").evaluate(g,{},s),B=L.layout.get("building-height").evaluate(g,{},s),G=L.layout.get("building-roof-shape").evaluate(g,{},s),X=L.paint.get("building-ambient-occlusion-intensity"),W=L.paint.get("building-ambient-occlusion-ground-radius")/this.tileToMeter;if(G==="flat")continue;let K=g.properties.source_id,pe;pe=f.has(K)?f.get(K):[];let ce=[],ue=new Qe(1/0,1/0),ge=new Qe(-1/0,-1/0);for(let Xe of R)if(Xe.length>0){let tt=[];for(let It of Xe){let xt=[];for(let ut=It.length-1;ut>=0;ut--){let vt=It[ut];xt.push({x:vt.x,y:vt.y}),ue.x=Math.min(ue.x,vt.x),ue.y=Math.min(ue.y,vt.y),ge.x=Math.max(ge.x,vt.x),ge.y=Math.max(ge.y,vt.y)}tt.push(xt)}ce.push({id:g.id,height:B,minHeight:k,sourceId:0,roofType:G,coordinates:tt})}let ve=h.generateMesh(ce,pe);if(typeof ve=="string"||ve.meshes.length===0||ve.modifiedPolygonRings.length===0)continue;let Ne=0;for(let Xe of ve.meshes)Ne+=Xe.positions.length/3;let Ee=this.segmentsBucket.prepareSegment(Ne,this.layoutVertexArray,this.indexArray),Ue=[],nt=null,qe=0,Ke=-1,it=this.indexArray.length,Fe=0;for(let Xe of ve.meshes){let tt=this.layoutVertexArray.length;if(Xe.buildingPart==="entrance"){let xt=new Array;for(let Zt=0;Zt<Xe.indices.length;Zt+=12){let Qt=Xe.positions[Zt+0],Kt=Xe.positions[Zt+1],fi=Xe.positions[Zt+3],oi=Xe.positions[Zt+4],ir=Xe.positions[Zt+2],ee=Xe.positions[Zt+8]-ir,te=1,Oe=fi-Qt,lt=oi-Kt,pt=Math.hypot(Oe,lt);xt.push({pos:[Qt+.5*Oe,Kt+.5*lt,ir],normal:[lt/pt,-Oe/pt,0],width:pt,height:ee,depth:te,points:[Qt,Kt,fi,oi]})}let ut=this.entranceBloom.segmentsBucket.prepareSegment(10*xt.length,this.entranceBloom.layoutVertexArray,this.entranceBloom.indexArray),vt=this.entranceBloom.layoutVertexArray.length;qe=this.entranceBloom.indexArray.length,a1(xt,.5/this.tileToMeter,this.entranceBloom.indexArray,this.entranceBloom.layoutVertexArray,this.entranceBloom.layoutAttenuationArray);let Vt=this.entranceBloom.layoutVertexArray.length-vt;Ke=this.entranceBloom.indexArray.length-qe;for(let Zt=0;Zt<Vt;Zt++)this.entranceBloom.layoutColorArray.emplaceBack(65535,65535);ut.vertexLength+=Vt,ut.primitiveLength+=Ke,nt={part:Xe.buildingPart,vertexOffset:vt,vertexLength:Vt}}for(let xt=0;xt<Xe.positions.length;xt+=3)Fe=Math.max(Fe,Xe.positions[xt+2]),this.layoutVertexArray.emplaceBack(Xe.positions[xt],Xe.positions[xt+1],Xe.positions[xt+2]);for(let xt=0;xt<Xe.normals.length;xt+=3)this.layoutNormalArray.emplaceBack(Xe.normals[xt+0]*Sy,Xe.normals[xt+1]*Sy,Xe.normals[xt+2]*Sy);for(let xt=0;xt<Xe.ao.length;xt++)this.layoutAOArray.push(Xe.ao[xt]);for(let xt=0;xt<Xe.colors.length;xt+=3){let ut=1+(Xe.ao[xt/3]-1)*X;this.layoutColorArray.emplaceBack(Xe.colors[xt]*ut<<8|Xe.colors[xt+1]*ut,Xe.colors[xt+2]*ut<<8)}let It=Ee.vertexLength;for(let xt=0;xt<Xe.indices.length;xt+=3)this.indexArray.emplaceBack(It+Xe.indices[xt],It+Xe.indices[xt+1],It+Xe.indices[xt+2]);Ee.vertexLength+=Xe.positions.length/3,Ee.primitiveLength+=Xe.indices.length/3,(Xe.buildingPart==="roof"||Xe.buildingPart==="wall"||Xe.buildingPart==="facade_glazing"||Xe.buildingPart==="entrance")&&Ue.push({part:Xe.buildingPart,vertexOffset:tt,vertexLength:Xe.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Fe),this.buildingFeatures.push({feature:E,segment:Ee,parts:Ue,buildingBloom:nt});let Je=this.indexArray.length-it,Ie=[],Be=[],at=new Qe(1/0,1/0),et=new Qe(-1/0,-1/0),Lt=this.groundEffect.vertexArray.length;for(let Xe of ve.modifiedPolygonRings){let tt=[],It=new Qe(1/0,1/0),xt=new Qe(-1/0,-1/0);for(let ut=0;ut<Xe.length;ut+=2){let vt=Xe.length-ut-2;It.x=Math.min(It.x,Xe[vt]),It.y=Math.min(It.y,Xe[vt+1]),xt.x=Math.max(xt.x,Xe[vt]),xt.y=Math.max(xt.y,Xe[vt+1]);let Vt=new Qe(Xe[vt],Xe[vt+1]);tt.push(Vt),Ie.push(Vt.x,Vt.y),Be.push(Vt.clone())}at.x=Math.min(at.x,It.x),at.y=Math.min(at.y,It.y),et.x=Math.max(et.x,xt.x),et.y=Math.max(et.y,xt.y),this.groundEffect.addData(tt,[It,xt],W)}let St=this.groundEffect.vertexArray.length-Lt;(ue.x<0||ge.x>ht||ue.y<0||ge.y>ht)&&this.featuresOnBorder.push({featureId:g.id,footprintIndex:this.footprints.length});{let Xe=Iu(Ie,null,2),tt=new Gm(Be,Xe,8,256),It=g.id;g.properties&&g.properties.hasOwnProperty("building_id")&&(It=g.properties.building_id),this.footprints.push({vertices:Be,indices:Xe,grid:tt,min:at,max:et,buildingId:It,hiddenFlags:0,indicesOffset:it,indicesLength:Je,bloomIndicesOffset:qe,bloomIndicesLength:Ke,groundEffectVertexOffset:Lt,groundEffectVertexLength:St,segment:Ee,height:Fe})}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,g,y,{},i.availableImages,s,i.brightness),this.groundEffect.addPaintPropertiesData(g,y,{},i.availableImages,s,i.brightness)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0])}update(e,i,s,a,h,u,f){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f),this.groundEffect.update(e,i,h,s,a,u,f)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,l1.members),this.layoutNormalBuffer=e.createVertexBuffer(this.layoutNormalArray,NI.members),this.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(this.entranceBloom.layoutVertexArray,l1.members),this.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(this.entranceBloom.layoutAttenuationArray,VI.members),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.layoutNormalBuffer.destroy(),this.layoutColorBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segmentsBucket.destroy(),this.entranceBloom.layoutVertexBuffer.destroy(),this.entranceBloom.layoutColorBuffer.destroy(),this.entranceBloom.layoutAttenuationBuffer.destroy(),this.entranceBloom.indexBuffer.destroy(),this.entranceBloom.segmentsBucket.destroy())}updateFootprintHiddenFlags(e,i,s=!0){let a=!1,h=s?i:0,u=0|(s?-1:~i);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let f of e){let g=this.footprints[f],y=g.hiddenFlags&u|h;g.hiddenFlags!==y&&(g.hiddenFlags=y,a=!0,this.groundEffect.updateHiddenByLandmarkRange(g.groundEffectVertexOffset,g.groundEffectVertexLength,g.hiddenFlags!==0))}return a&&(this.indexArrayForConflationUploaded=!1),a}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),!this.indexArrayForConflationUploaded&&this.indexArray.length!==0){this.indexArrayForConflation.resize(this.indexArray.length),this.indexArrayForConflation.uint16.set(this.indexArray.uint16),this.entranceBloom.indexArrayForConflation.resize(this.entranceBloom.indexArray.length),this.entranceBloom.indexArrayForConflation.uint16.set(this.entranceBloom.indexArray.uint16);for(let i of this.footprints){let s=i.indicesOffset+i.indicesLength;if(i.hiddenFlags!==0){for(let h=i.indicesOffset;h<s;h++)this.indexArrayForConflation.uint16[3*h+0]=0,this.indexArrayForConflation.uint16[3*h+1]=0,this.indexArrayForConflation.uint16[3*h+2]=0;let a=i.bloomIndicesOffset+i.bloomIndicesLength;for(let h=i.bloomIndicesOffset;h<a;h++)this.entranceBloom.indexArrayForConflation.uint16[3*h+0]=0,this.entranceBloom.indexArrayForConflation.uint16[3*h+1]=0,this.entranceBloom.indexArrayForConflation.uint16[3*h+2]=0}}this.indexBuffer?this.indexBuffer.updateData(this.indexArrayForConflation):this.indexBuffer=e.createIndexBuffer(this.indexArrayForConflation,!0),this.entranceBloom.indexBuffer?this.entranceBloom.indexBuffer.updateData(this.entranceBloom.indexArrayForConflation):this.entranceBloom.indexBuffer=e.createIndexBuffer(this.entranceBloom.indexArrayForConflation,!0),this.indexArrayForConflationUploaded=!0}}uploadUpdatedColorBuffer(e){this.layoutColorBuffer?this.layoutColorBuffer.updateData(this.layoutColorArray):this.layoutColorBuffer=e.createVertexBuffer(this.layoutColorArray,c1.members,!0),this.entranceBloom.layoutColorBuffer?this.entranceBloom.layoutColorBuffer.updateData(this.entranceBloom.layoutColorArray):this.entranceBloom.layoutColorBuffer=e.createVertexBuffer(this.entranceBloom.layoutColorArray,c1.members,!0)}evaluate(e){let i=e.paint.get("building-ambient-occlusion-intensity");for(let s of this.buildingFeatures){let a=s.feature;a.properties["building-part"]="roof";let h=e.paint.get("building-color").evaluate(a,{},this.canonical),u=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="wall";let f=e.paint.get("building-color").evaluate(a,{},this.canonical),g=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="window";let y=e.paint.get("building-color").evaluate(a,{},this.canonical),w=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="door";let E=e.paint.get("building-color").evaluate(a,{},this.canonical),I=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);for(let L of s.parts){let k,B=h;L.part==="roof"?(B=h,k=u):L.part==="wall"?(B=f,k=g):L.part==="facade_glazing"?(B=y,k=w):L.part==="entrance"&&(B=E,k=I),k=re(k,0,1);for(let G=0;G<L.vertexLength;G++){let X=L.vertexOffset+G,W=1+(this.layoutAOArray[X]-1)*i;this.layoutColorArray.emplace(X,B.r*W*255<<8|B.g*W*255,B.b*W*255<<8|255*k)}}let R=s.buildingBloom;if(R)for(let L=0;L<R.vertexLength;L++)this.bloomGeometry.layoutColorArray.emplace(R.vertexOffset+L,255*E.r<<8|255*E.g,255*E.b<<8|51*I)}}needsEvaluation(e,i){let s=e.transform.projectionOptions,a=e.style.getBrightness();return!(this.uploaded&&s.name===this.projection.name&&this.brightness===a||(this.projection=s,this.brightness=a,0))}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;let a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Hm(this.activeReplacements,a))return;this.activeReplacements=a;for(let u of this.footprints)u.hiddenFlags&=-2;let h=[];for(let u of this.activeReplacements){if(u.order<=_v)continue;let f=Math.max(1,Math.pow(2,u.footprintTileId.canonical.z-e.canonical.z));for(let g of this.footprints)g.min.x>u.max.x||g.max.x<u.min.x||g.min.y>u.max.y||g.max.y<u.min.y||(h.length=0,jI(g.vertices,0,g.vertices.length,u.footprintTileId.canonical,e.canonical,h),oy(u.footprint,h,g.indices,0,g.indices.length,0,-f)&&(g.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let u of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(u.groundEffectVertexOffset,u.groundEffectVertexLength,u.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,a=!0,h=4*(e+ht)*ht+(i+ht);if(this.footprintLookup.hasOwnProperty(h)){let f=this.footprintLookup[h];return f?{height:f.height,hidden:f.hiddenFlags!==0}:void 0}let u=new Qe(e,i);for(let f of this.footprints)e>f.max.x||f.min.x>e||i>f.max.y||f.min.y>i||f.height<=s||sy(u,f)&&(s=f.height,this.footprintLookup[h]=f,a=f.hiddenFlags!==0);if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:a};this.footprintLookup[h]=void 0}}function jI(r,e,i,s,a,h){let u=Math.pow(2,s.z-a.z);for(let f=0;f<i;f++){let g=r[f+e].x,y=r[f+e].y;g=(g+a.x*ht)*u-s.x*ht,y=(y+a.y*ht)*u-s.y*ht,h.push(new Qe(g,y))}}let d1,p1;Tt(u1,"BuildingBucket",{omit:["layers"]});let GI=gi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),qI=gi([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:HI}=GI,$I=gi([{name:"a_packed",components:3,type:"Float32"}]),{members:ZI}=$I,WI=gi([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:XI}=WI;class f1{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new Bl({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){let s=this.getKey(e,i);return this.positions[s]}trim(){let e=this.width,i=this.height=kt(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,s){let a=[],h=e.length%2==1?-e[e.length-1]*s:0,u=e[0]*s,f=!0;a.push({left:h,right:u,isDash:f,zeroLength:e[0]===0});let g=e[0];for(let y=1;y<e.length;y++){f=!f;let w=e[y];h=g*s,g+=w,u=g*s,a.push({left:h,right:u,isDash:f,zeroLength:w===0})}return a}addRoundDash(e,i,s){let a=i/2;for(let h=-s;h<=s;h++){let u=this.width*(this.nextRow+s+h),f=0,g=e[f];for(let y=0;y<this.width;y++){y/g.right>1&&(g=e[++f]);let w=Math.abs(y-g.left),E=Math.abs(y-g.right),I=Math.min(w,E),R,L=h/s*(a+1);if(g.isDash){let k=a-Math.abs(L);R=Math.sqrt(I*I+k*k)}else R=a-Math.sqrt(I*I+L*L);this.image.data[u+y]=Math.max(0,Math.min(255,R+128))}}}addRegularDash(e,i){for(let g=e.length-1;g>=0;--g){let y=e[g],w=e[g+1];y.zeroLength?e.splice(g,1):w&&w.isDash===y.isDash&&(w.left=y.left,e.splice(g,1))}let s=e[0],a=e[e.length-1];s.isDash===a.isDash&&(s.left=a.left-this.width,a.right=s.right+this.width);let h=this.width*this.nextRow,u=0,f=e[u];for(let g=0;g<this.width;g++){g/f.right>1&&(f=e[++u]);let y=Math.abs(g-f.left),w=Math.abs(g-f.right),E=Math.min(y,w);this.image.data[h+g]=Math.max(0,Math.min(255,(f.isDash?E:-E)+i+128))}}addDash(e,i){let s=this.getKey(e,i);if(this.positions[s])return this.positions[s];let a=i==="round",h=a?7:0,u=2*h+1;if(this.nextRow+u>this.height)return pi("LineAtlas out of space"),null;e.length===0&&e.push(1);let f=0;for(let w=0;w<e.length;w++)e[w]<0&&(pi("Negative value is found in line dasharray, replacing values with 0"),e[w]=0),f+=e[w];if(f!==0){let w=this.width/f,E=this.getDashRanges(e,this.width,w);a?this.addRoundDash(E,w,h):this.addRegularDash(E,i==="square"?.5*w:0)}let g=this.nextRow+h;this.nextRow+=u;let y={tl:[g,h],br:[f,0]};return this.positions[s]=y,y}}Tt(f1,"LineAtlas");let YI=Pe.types,KI=Math.cos(Math.PI/180*37.5),JI=Math.cos(Math.PI/180*5);class Ey{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new _u,this.layoutVertexArray2=new yo,this.patternVertexArray=new yo,this.indexArray=new ur,this.programConfigurations=new vo(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new gr,this.maxLineLength=0,this.zOffsetVertexArray=new yo,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:ht/64,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,s,a){this.hasPattern=Qg("line",this.layers,this.pixelRatio,i);let h=this.layers[0].layout.get("line-sort-key");this.tileToMeter=se(s);let u=this.layers[0].layout.get("line-elevation-reference");if(u==="hd-road-markup")this.elevationType="road";else{let I=this.layers[0].layout.get("line-z-offset"),R=I.isConstant()&&!I.constantOr(0);this.elevationType=u!=="sea"&&u!=="ground"&&R?"none":"offset",this.elevationType==="offset"&&u==="none"&&pi(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}let f=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&f!==void 0;let g=[];for(let{feature:I,id:R,index:L,sourceLayerIndex:k}of e){let B=this.layers[0]._featureFilter.needGeometry,G=ke(I,B);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),G,s))continue;let X=h?h.evaluate(G,{},s):void 0,W={id:R,properties:I.properties,type:I.type,sourceLayerIndex:k,index:L,geometry:B?G.geometry:me(I,s,a),patterns:{},sortKey:X};g.push(W)}h&&g.sort((I,R)=>I.sortKey-R.sortKey);let{lineAtlas:y,featureIndex:w}=i,E=this.addConstantDashes(y);for(let I of g){let{geometry:R,index:L,sourceLayerIndex:k}=I;if(E&&this.addFeatureDashes(I,y),this.hasPattern){let B=ey("line",this.layers,I,this.zoom,this.pixelRatio,i);this.patternFeatures.push(B)}else this.addFeature(I,R,L,s,y.positions,i.availableImages,i.brightness,i.elevationFeatures);w.insert(e[L].feature,R,L,k,this.index)}}addConstantDashes(e){let i=!1;for(let s of this.layers){let a=s.paint.get("line-dasharray").value,h=s.layout.get("line-cap").value;if(a.kind!=="constant"||h.kind!=="constant")i=!0;else{let u=h.value,f=a.value;if(!f)continue;e.addDash(f,u)}}return i}addFeatureDashes(e,i){let s=this.zoom;for(let a of this.layers){let h=a.paint.get("line-dasharray").value,u=a.layout.get("line-cap").value;if(h.kind==="constant"&&u.kind==="constant")continue;let f,g;if(h.kind==="constant"){if(f=h.value,!f)continue}else f=h.evaluate({zoom:s},e);g=u.kind==="constant"?u.value:u.evaluate({zoom:s},e),i.addDash(f,g),e.patterns[a.id]=[i.getKey(f,g)]}}update(e,i,s,a,h,u,f,g){this.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,g)}addFeatures(e,i,s,a,h,u){for(let f of this.patternFeatures)this.addFeature(f,f.geometry,f.index,i,s,a,u)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,ZI)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,XI)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,qI.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,HI),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,s,a,h,u,f,g){let y=this.layers[0].layout,w=y.get("line-join").evaluate(e,{}),E=y.get("line-cap").evaluate(e,{}),I=y.get("line-miter-limit"),R=y.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=y.get("line-z-offset").value;let L=this.layers[0].paint.get("line-width").value;if(L.kind!=="constant"&&L.isLineProgressConstant===!1&&(this.variableWidthValue=L),this.elevationType==="road"){let k=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,a,g,w,E,I,R)){let[B,G]=this.clipRuntimeLinesToTile(i,1);for(let X=0;X<B.length;X++){let W=B[X],K=G[X],pe={progress:{min:K.progress.min,max:K.progress.max},nextDir:this.computeSegNextDir(K,W),prevDir:this.computeSegPrevDir(K,W)};this.addLine(W,e,a,w,E,I,R,pe)}this.fillNonElevatedRoadSegment(k)}}else for(let k of i)this.addLine(k,e,a,w,E,I,R);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,h,u,a,f,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return Wm(e,-i,-i,ht+i,ht+i)}clipRuntimeLinesToTile(e,i){let s=[];return[Wm(e,-i,-i,ht+i,ht+i,s),s]}addElevatedRoadFeature(e,i,s,a,h,u,f,g){let y=[],w=yr.getElevationFeature(e,a);if(w){let E=this.clipLinesToTile(i,1),I=this.prepareElevatedLines(E,w,s);for(let R of I)y.push({geometry:R,elevation:w,elevationTileID:s,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(y.length===0)return!1;for(let E of y){let I=this.layoutVertexArray.length;this.addLine(E.geometry,e,s,h,u,f,g);let R=new bi(s,E.elevationTileID);if(E.elevation)for(let L=I;L<this.layoutVertexArray.length;L++){let k=new Qe(this.layoutVertexArray.int16[6*L]>>1,this.layoutVertexArray.int16[6*L+1]>>1),B=R.pointElevation(k,E.elevation,.05);this.updateHeightRange(B),this.zOffsetVertexArray.emplaceBack(B,0,0)}else this.fillNonElevatedRoadSegment(I)}return!0}prepareElevatedLines(e,i,s){if(i.constantHeight!=null)return e;let a=[],h=1/se(s);for(let u of e)mI(u,new Vi(i,h),0,a);return a}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,s,a,h,u,f,g){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;let y=a==="none";this.patternJoinNone=this.hasPattern&&y,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];let w=g&&g.progress.min>0,E=g&&g.progress.max<1;if(this.lineClips){let ge={min:this.lineClips.start,max:this.lineClips.end},ve=1;if(g){let Ue=this.lineClips.end-this.lineClips.start;ge=function(nt,qe,Ke){return{min:uc(nt.min,qe,Ke),max:uc(nt.max,qe,Ke)}}(g.progress,{min:0,max:1},ge),Ue>0&&(ve=(ge.max-ge.min)/Ue)}let Ne=+i.properties.mapbox_clip_feature_len,Ee=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(Ne)||Number.isNaN(Ee)){for(let nt=0;nt<e.length-1;nt++)this.totalDistance+=e[nt].dist(e[nt+1]);let Ue=this.totalDistance/(ge.max-ge.min);this.totalFeatureLength=Number.isFinite(Ue)?Ue:0,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Ne,this.distance=Ee*ve,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}let I=YI[i.type]==="Polygon",R=e.length;for(;R>=2&&e[R-1].equals(e[R-2]);)R--;let L=0;for(;L<R-1&&e[L].equals(e[L+1]);)L++;if(R<(I?3:2))return;a==="bevel"&&(u=1.05);let k=this.segments.prepareSegment(10*R,this.layoutVertexArray,this.indexArray),B,G,X,W,K,pe,ce,ue;g&&g.prevDir&&(pe=g.prevDir.perp()),g&&g.nextDir&&(ce=g.nextDir.perp()),this.e1=this.e2=-1,I&&(B=e[R-2],K=e[L].sub(B)._unit()._perp());for(let ge=L;ge<R;ge++){if(X=ge===R-1?I?e[L+1]:void 0:e[ge+1],X&&e[ge].equals(X))continue;K&&(W=K),B&&(G=B),B=e[ge],ue=this.evaluateLineProgressFeatures(G?G.dist(B):0),K=X?X.sub(B)._unit()._perp():W,W=W||K;let ve=G&&X,Ne=ve?a:I||y?"butt":h,Ee=W.x*K.x+W.y*K.y;if(y){let Ie=function(Be){if(Be.patternJoinNone){let at=Be.segmentPoints.length/2,et=Be.lineSoFar-Be.segmentStart;for(let Lt=0;Lt<at;++Lt){let St=Be.segmentPoints[2*Lt+1],Xe=Math.round(Be.segmentPoints[2*Lt])+.5+.25*St;Be.patternVertexArray.emplaceBack(Xe,et,Be.segmentStart),Be.patternVertexArray.emplaceBack(Xe,et,Be.segmentStart)}Be.segmentPoints.length=0}Be.e1=Be.e2=-1};if(ve&&Ee<JI){this.updateDistance(G,B),this.addCurrentVertex(B,W,1,1,k,ue),Ie(this),this.addCurrentVertex(B,K,-1,-1,k,ue);continue}if(G){if(!X){this.updateDistance(G,B),this.addCurrentVertex(B,W,1,1,k,ue),Ie(this);continue}Ne="miter"}}let Ue=W.add(K);Ue.x===0&&Ue.y===0||Ue._unit();let nt=Ue.x*K.x+Ue.y*K.y,qe=nt!==0?1/nt:1/0,Ke=2*Math.sqrt(2-2*nt),it=nt<KI&&G&&X,Fe=W.x*K.y-W.y*K.x>0,Je=this.overscaling<=16?15*ht/(512*this.overscaling):0;if(ve&&Ne==="round"){if(qe<f)Ne="miter";else if(qe<=2){let Ie=Iy(B,-10,ht+10);Ne=this.elevationType==="offset"&&(Ie||this.hasCrossSlope)?"miter":"fakeround"}}if(Ne==="miter"&&qe>u&&(Ne="bevel"),Ne==="bevel"&&(qe>2&&(Ne="flipbevel"),qe<u&&(Ne="miter")),G&&!(Ne==="miter"&&it)&&this.updateDistance(G,B),Ne==="miter")if(it){let Ie=B.dist(G);if(Ie>2*Je){let at=B.sub(B.sub(G)._mult(Je/Ie)._round());this.updateDistance(G,at),this.addCurrentVertex(at,W,0,0,k,ue),G=at}this.updateDistance(G,B),Ue._mult(qe),this.addCurrentVertex(B,Ue,0,0,k,ue);let Be=B.dist(X);if(Be>2*Je){let at=B.add(X.sub(B)._mult(Je/Be)._round());this.updateDistance(B,at),this.addCurrentVertex(at,K,0,0,k,ue),B=at}}else Ue._mult(qe),this.addCurrentVertex(B,Ue,0,0,k,ue);else if(Ne==="flipbevel"){if(qe>100)Ue=K.mult(-1);else{let Ie=qe*W.add(K).mag()/W.sub(K).mag();Ue._perp()._mult(Ie*(Fe?-1:1))}this.addCurrentVertex(B,Ue,0,0,k,ue),this.addCurrentVertex(B,Ue.mult(-1),0,0,k,ue)}else if(Ne==="bevel"||Ne==="fakeround"){ue!=null&&G&&this.addCurrentVertex(B,ce||W,-1,-1,k,ue);let Ie=B.dist(G)<=2*Je&&Ne!=="bevel",Be=Ue.mult(Fe?1:-1);Be._mult(qe);let at=K.mult(Fe?-1:1),et=W.mult(Fe?-1:1),Lt=this.evaluateLineProgressFeatures(this.distance);if(ue==null&&(this.addHalfVertex(B,Be.x,Be.y,!1,!Fe,0,k,Lt),Ie||this.addHalfVertex(B,Be.x+2*et.x,Be.y+2*et.y,!1,Fe,0,k,Lt)),Ne==="fakeround"){let St=Math.round(180*Ke/Math.PI/20);this.addHalfVertex(B,et.x,et.y,!1,Fe,0,k,Lt);for(let Xe=0;Xe<St;Xe++){let tt=Xe/St;if(tt!==.5){let xt=tt-.5;tt+=tt*xt*(tt-1)*((1.0904+Ee*(Ee*(3.55645-1.43519*Ee)-3.2452))*xt*xt+(.848013+Ee*(.215638*Ee-1.06021)))}let It=at.sub(et)._mult(tt)._add(et)._unit();this.addHalfVertex(B,It.x,It.y,!1,Fe,0,k,Lt)}this.addHalfVertex(B,at.x,at.y,!1,Fe,0,k,Lt)}Ie||ue!=null||this.addHalfVertex(B,Be.x+2*at.x,Be.y+2*at.y,!1,Fe,0,k,Lt),ue!=null&&X&&this.addCurrentVertex(B,pe||K,1,1,k,ue)}else if(Ne==="butt")this.addCurrentVertex(B,Ue,0,0,k,ue);else if(Ne==="square"){if(!G){let Ie=w?0:-1;this.addCurrentVertex(B,Ue,Ie,Ie,k,ue)}if(this.addCurrentVertex(B,Ue,0,0,k,ue),G){let Ie=E?0:1;this.addCurrentVertex(B,Ue,Ie,Ie,k,ue)}}else if(Ne==="round"){if(G){let Ie=!ve&&ce?ce:W;this.addCurrentVertex(B,Ie,0,0,k,ue),!ve&&E||this.addCurrentVertex(B,Ie,1,1,k,ue,!0)}if(X){let Ie=!ve&&pe?pe:K;!ve&&w||this.addCurrentVertex(B,Ie,-1,-1,k,ue,!0),this.addCurrentVertex(B,Ie,0,0,k,ue)}}}}addVerticesTo(e,i,s,a,h,u,f,g,y,w){let E=(i.w-e.w)/this.tessellationStep|0,I=0,R=this.scaledDistance;if(E>1){this.lineSoFar=e.w;let k=(i.x-e.x)/E,B=(i.y-e.y)/E,G=(i.z-e.z)/E,X=(i.w-e.w)/E;for(let W=1;W<E;++W){e.x+=k,e.y+=B,e.z+=G,this.lineSoFar+=X,I+=X;let K=this.evaluateLineProgressFeatures(this.prevDistance+I);this.scaledDistance=(this.prevDistance+I)/this.totalDistance,this.addHalfVertex(e,s,a,w,!1,f,y,K),this.addHalfVertex(e,h,u,w,!0,-g,y,K)}}this.lineSoFar=i.w,this.scaledDistance=R;let L=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,s,a,w,!1,f,y,L),this.addHalfVertex(i,h,u,w,!0,-g,y,L)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):pi(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,s,a,h,u,f=!1){let g=i.x+i.y*s,y=i.y-i.x*s,w=i.y*a-i.x,E=-i.y-i.x*a;if(u!=null){let I=this.elevationType==="offset",R=-10,L=ht+10,k=u.zOffset,B=new Fv(e.x,e.y,k,this.lineSoFar),G=!!I&&Iy(e,R,L),X=this.lineSoFar,W=this.distance;if(this.currentVertex)if(G){let K=this.currentVertexIsOutside,pe=this.currentVertex,ce=new Fv(e.x,e.y,k,this.lineSoFar);if(Nv(pe,ce,R,L),!Iy(ce,R,L)){if(K){this.e1=this.e2=-1,this.distance-=pe.dist(B),this.lineSoFar=pe.w;let ue=this.evaluateLineProgressFeatures(pe.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(pe,g,y,f,!1,s,h,ue),this.addHalfVertex(pe,w,E,f,!0,-a,h,ue),this.prevDistance=this.distance}this.distance=this.prevDistance+pe.dist(ce),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(pe,ce,g,y,w,E,s,a,h,f),this.distance=W,this.scaledDistance=this.distance/this.totalDistance}}else{let K=this.currentVertex;if(this.currentVertexIsOutside){Nv(K,B,R,L),this.e1=this.e2=-1,this.distance-=K.dist(B),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=K.w;let pe=this.evaluateLineProgressFeatures(K.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(K,g,y,f,!1,s,h,pe),this.addHalfVertex(K,w,E,f,!0,-a,h,pe),this.prevDistance=this.distance,this.distance=W,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(K,B,g,y,w,E,s,a,h,f)}else G||(this.addHalfVertex(e,g,y,f,!1,s,h,u),this.addHalfVertex(e,w,E,f,!0,-a,h,u));this.currentVertex=B,this.currentVertexIsOutside=G,this.lineSoFar=X}else this.addHalfVertex(e,g,y,f,!1,s,h,u),this.addHalfVertex(e,w,E,f,!0,-a,h,u)}addHalfVertex({x:e,y:i},s,a,h,u,f,g,y){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),u||this.segmentPoints.push(this.lineSoFar-this.segmentStart,f)),this.layoutVertexArray.emplaceBack((e<<1)+(h?1:0),(i<<1)+(u?1:0),Math.round(63*s)+128,Math.round(63*a)+128,1+(f===0?0:f<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){let E=Bt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,E)}let w=g.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,w),g.primitiveLength++),u?this.e2=w:this.e1=w,y!=null&&this.zOffsetVertexArray.emplaceBack(y.zOffset,y.variableWidth,y.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function Iy(r,e,i){return r.x<e||r.x>i||r.y<e||r.y>i}let m1,_1;function g1(r,e,i){return e*(ht/(r.tileSize*Math.pow(2,i-r.tileID.overscaledZ)))}Tt(Ey,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let y1=(r,e,i)=>(1-i)*r+i*e;function x1(r,e){return 1/g1(r,1,e.tileZoom)}function v1(r,e,i,s){return r.translatePosMatrix(s||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}let b1=r=>{let e=[];w1(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");let i=r.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");let s=r.layout.get("line-join").constantOr("miter")==="none",a=!!r.paint.get("line-pattern").constantOr(1);return s&&a&&e.push("LINE_JOIN_NONE"),e};function w1(r){let e=r.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let Ay,T1=()=>Ay||(Ay={layout:m1||(m1=new Ar({"line-cap":new gt(Se.layout_line["line-cap"]),"line-join":new gt(Se.layout_line["line-join"]),"line-miter-limit":new ot(Se.layout_line["line-miter-limit"]),"line-round-limit":new ot(Se.layout_line["line-round-limit"]),"line-sort-key":new gt(Se.layout_line["line-sort-key"]),"line-z-offset":new gt(Se.layout_line["line-z-offset"]),"line-elevation-reference":new ot(Se.layout_line["line-elevation-reference"]),"line-cross-slope":new ot(Se.layout_line["line-cross-slope"]),visibility:new ot(Se.layout_line.visibility),"line-width-unit":new ot(Se.layout_line["line-width-unit"])})),paint:_1||(_1=new Ar({"line-opacity":new gt(Se.paint_line["line-opacity"]),"line-color":new gt(Se.paint_line["line-color"]),"line-translate":new ot(Se.paint_line["line-translate"]),"line-translate-anchor":new ot(Se.paint_line["line-translate-anchor"]),"line-width":new gt(Se.paint_line["line-width"]),"line-gap-width":new gt(Se.paint_line["line-gap-width"]),"line-offset":new gt(Se.paint_line["line-offset"]),"line-blur":new gt(Se.paint_line["line-blur"]),"line-dasharray":new gt(Se.paint_line["line-dasharray"]),"line-pattern":new gt(Se.paint_line["line-pattern"]),"line-pattern-cross-fade":new ot(Se.paint_line["line-pattern-cross-fade"]),"line-gradient":new bl(Se.paint_line["line-gradient"]),"line-trim-offset":new ot(Se.paint_line["line-trim-offset"]),"line-trim-fade-range":new ot(Se.paint_line["line-trim-fade-range"]),"line-trim-color":new ot(Se.paint_line["line-trim-color"]),"line-emissive-strength":new ot(Se.paint_line["line-emissive-strength"]),"line-border-width":new gt(Se.paint_line["line-border-width"]),"line-border-color":new gt(Se.paint_line["line-border-color"]),"line-occlusion-opacity":new ot(Se.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},Ay);class QI extends gt{possiblyEvaluate(e,i){return i=new ji(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,s,a){return i=Le({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,s,a)}}let Up;function S1(r,e){return e>0?e+2*r:r}let eA=gi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),tA=gi([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),iA=gi([{name:"a_projected_pos",components:4,type:"Float32"}],4);gi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let rA=gi([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),nA=gi([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),oA=gi([{name:"a_texb",components:2,type:"Uint16"}]),sA=gi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),aA=gi([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);gi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let E1=gi([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),lA=gi([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);gi([{name:"triangle",components:3,type:"Uint16"}]),gi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),gi([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),gi([{type:"Float32",name:"offsetX"}]),gi([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var dn=24;function cA(r,e,i){return r.sections.forEach(s=>{s.text=function(a,h,u){let f=h.layout.get("text-transform").evaluate(u,{});return f==="uppercase"?a=a.toLocaleUpperCase():f==="lowercase"&&(a=a.toLocaleLowerCase()),as.applyArabicShaping&&(a=as.applyArabicShaping(a)),a}(s.text,e,i)}),r}let jp={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42","\u2190":"\u2191","\u2192":"\u2193"};function hA(r){return r==="\uFE36"||r==="\uFE48"||r==="\uFE38"||r==="\uFE44"||r==="\uFE42"||r==="\uFE3E"||r==="\uFE3C"||r==="\uFE3A"||r==="\uFE18"||r==="\uFE40"||r==="\uFE10"||r==="\uFE13"||r==="\uFE14"||r==="\uFF40"||r==="\uFFE3"||r==="\uFE11"||r==="\uFE12"}function uA(r){return r==="\uFE35"||r==="\uFE47"||r==="\uFE37"||r==="\uFE43"||r==="\uFE41"||r==="\uFE3D"||r==="\uFE3B"||r==="\uFE39"||r==="\uFE17"||r==="\uFE3F"}let My=4294967296,I1=1/My,A1=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),i_=class{constructor(r=new Uint8Array(16)){this.buf=ArrayBuffer.isView(r)?r:new Uint8Array(r),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(r,e,i=this.length){for(;this.pos<i;){let s=this.readVarint(),a=s>>3,h=this.pos;this.type=7&s,r(a,e,this),this.pos===h&&this.skip(s)}return e}readMessage(r,e){return this.readFields(r,e,this.readVarint()+this.pos)}readFixed32(){let r=this.dataView.getUint32(this.pos,!0);return this.pos+=4,r}readSFixed32(){let r=this.dataView.getInt32(this.pos,!0);return this.pos+=4,r}readFixed64(){let r=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*My;return this.pos+=8,r}readSFixed64(){let r=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*My;return this.pos+=8,r}readFloat(){let r=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,r}readDouble(){let r=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,r}readVarint(r){let e=this.buf,i,s;return s=e[this.pos++],i=127&s,s<128?i:(s=e[this.pos++],i|=(127&s)<<7,s<128?i:(s=e[this.pos++],i|=(127&s)<<14,s<128?i:(s=e[this.pos++],i|=(127&s)<<21,s<128?i:(s=e[this.pos],i|=(15&s)<<28,function(a,h,u){let f=u.buf,g,y;if(y=f[u.pos++],g=(112&y)>>4,y<128||(y=f[u.pos++],g|=(127&y)<<3,y<128)||(y=f[u.pos++],g|=(127&y)<<10,y<128)||(y=f[u.pos++],g|=(127&y)<<17,y<128)||(y=f[u.pos++],g|=(127&y)<<24,y<128)||(y=f[u.pos++],g|=(1&y)<<31,y<128))return zu(a,g,h);throw new Error("Expected varint not more than 10 bytes")}(i,r,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){let r=this.readVarint();return r%2==1?(r+1)/-2:r/2}readBoolean(){return!!this.readVarint()}readString(){let r=this.readVarint()+this.pos,e=this.pos;return this.pos=r,r-e>=12&&A1?A1.decode(this.buf.subarray(e,r)):function(i,s,a){let h="",u=s;for(;u<a;){let f=i[u],g,y,w,E=null,I=f>239?4:f>223?3:f>191?2:1;if(u+I>a)break;I===1?f<128&&(E=f):I===2?(g=i[u+1],(192&g)==128&&(E=(31&f)<<6|63&g,E<=127&&(E=null))):I===3?(g=i[u+1],y=i[u+2],(192&g)==128&&(192&y)==128&&(E=(15&f)<<12|(63&g)<<6|63&y,(E<=2047||E>=55296&&E<=57343)&&(E=null))):I===4&&(g=i[u+1],y=i[u+2],w=i[u+3],(192&g)==128&&(192&y)==128&&(192&w)==128&&(E=(15&f)<<18|(63&g)<<12|(63&y)<<6|63&w,(E<=65535||E>=1114112)&&(E=null))),E===null?(E=65533,I=1):E>65535&&(E-=65536,h+=String.fromCharCode(E>>>10&1023|55296),E=56320|1023&E),h+=String.fromCharCode(E),u+=I}return h}(this.buf,e,r)}readBytes(){let r=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,r);return this.pos=r,e}readPackedVarint(r=[],e){let i=this.readPackedEnd();for(;this.pos<i;)r.push(this.readVarint(e));return r}readPackedSVarint(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSVarint());return r}readPackedBoolean(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readBoolean());return r}readPackedFloat(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFloat());return r}readPackedDouble(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readDouble());return r}readPackedFixed32(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed32());return r}readPackedSFixed32(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed32());return r}readPackedFixed64(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed64());return r}readPackedSFixed64(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed64());return r}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(r){let e=7&r;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(r,e){this.writeVarint(r<<3|e)}realloc(r){let e=this.length||16;for(;e<this.pos+r;)e*=2;if(e!==this.length){let i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeSFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*I1),!0),this.pos+=8}writeSFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*I1),!0),this.pos+=8}writeVarint(r){(r=+r||0)>268435455||r<0?function(e,i){let s,a;if(e>=0?(s=e%4294967296|0,a=e/4294967296|0):(s=~(-e%4294967296),a=~(-e/4294967296),4294967295^s?s=s+1|0:(s=0,a=a+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),function(h,u,f){f.buf[f.pos++]=127&h|128,h>>>=7,f.buf[f.pos++]=127&h|128,h>>>=7,f.buf[f.pos++]=127&h|128,h>>>=7,f.buf[f.pos++]=127&h|128,f.buf[f.pos]=127&(h>>>=7)}(s,0,i),function(h,u){let f=(7&h)<<4;u.buf[u.pos++]|=f|((h>>>=3)?128:0),h&&(u.buf[u.pos++]=127&h|((h>>>=7)?128:0),h&&(u.buf[u.pos++]=127&h|((h>>>=7)?128:0),h&&(u.buf[u.pos++]=127&h|((h>>>=7)?128:0),h&&(u.buf[u.pos++]=127&h|((h>>>=7)?128:0),h&&(u.buf[u.pos++]=127&h)))))}(a,i)}(r,this):(this.realloc(4),this.buf[this.pos++]=127&r|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=r>>>7&127))))}writeSVarint(r){this.writeVarint(r<0?2*-r-1:2*r)}writeBoolean(r){this.writeVarint(+r)}writeString(r){r=String(r),this.realloc(4*r.length),this.pos++;let e=this.pos;this.pos=function(s,a,h){for(let u,f,g=0;g<a.length;g++){if(u=a.charCodeAt(g),u>55295&&u<57344){if(!f){u>56319||g+1===a.length?(s[h++]=239,s[h++]=191,s[h++]=189):f=u;continue}if(u<56320){s[h++]=239,s[h++]=191,s[h++]=189,f=u;continue}u=f-55296<<10|u-56320|65536,f=null}else f&&(s[h++]=239,s[h++]=191,s[h++]=189,f=null);u<128?s[h++]=u:(u<2048?s[h++]=u>>6|192:(u<65536?s[h++]=u>>12|224:(s[h++]=u>>18|240,s[h++]=u>>12&63|128),s[h++]=u>>6&63|128),s[h++]=63&u|128)}return h}(this.buf,r,this.pos);let i=this.pos-e;i>=128&&M1(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i}writeFloat(r){this.realloc(4),this.dataView.setFloat32(this.pos,r,!0),this.pos+=4}writeDouble(r){this.realloc(8),this.dataView.setFloat64(this.pos,r,!0),this.pos+=8}writeBytes(r){let e=r.length;this.writeVarint(e),this.realloc(e);for(let i=0;i<e;i++)this.buf[this.pos++]=r[i]}writeRawMessage(r,e){this.pos++;let i=this.pos;r(e,this);let s=this.pos-i;s>=128&&M1(i,s,this),this.pos=i-1,this.writeVarint(s),this.pos+=s}writeMessage(r,e,i){this.writeTag(r,2),this.writeRawMessage(e,i)}writePackedVarint(r,e){e.length&&this.writeMessage(r,dA,e)}writePackedSVarint(r,e){e.length&&this.writeMessage(r,pA,e)}writePackedBoolean(r,e){e.length&&this.writeMessage(r,_A,e)}writePackedFloat(r,e){e.length&&this.writeMessage(r,fA,e)}writePackedDouble(r,e){e.length&&this.writeMessage(r,mA,e)}writePackedFixed32(r,e){e.length&&this.writeMessage(r,gA,e)}writePackedSFixed32(r,e){e.length&&this.writeMessage(r,yA,e)}writePackedFixed64(r,e){e.length&&this.writeMessage(r,xA,e)}writePackedSFixed64(r,e){e.length&&this.writeMessage(r,vA,e)}writeBytesField(r,e){this.writeTag(r,2),this.writeBytes(e)}writeFixed32Field(r,e){this.writeTag(r,5),this.writeFixed32(e)}writeSFixed32Field(r,e){this.writeTag(r,5),this.writeSFixed32(e)}writeFixed64Field(r,e){this.writeTag(r,1),this.writeFixed64(e)}writeSFixed64Field(r,e){this.writeTag(r,1),this.writeSFixed64(e)}writeVarintField(r,e){this.writeTag(r,0),this.writeVarint(e)}writeSVarintField(r,e){this.writeTag(r,0),this.writeSVarint(e)}writeStringField(r,e){this.writeTag(r,2),this.writeString(e)}writeFloatField(r,e){this.writeTag(r,5),this.writeFloat(e)}writeDoubleField(r,e){this.writeTag(r,1),this.writeDouble(e)}writeBooleanField(r,e){this.writeVarintField(r,+e)}};function zu(r,e,i){return i?4294967296*e+(r>>>0):4294967296*(e>>>0)+(r>>>0)}function M1(r,e,i){let s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(s);for(let a=i.pos-1;a>=r;a--)i.buf[a+s]=i.buf[a]}function dA(r,e){for(let i=0;i<r.length;i++)e.writeVarint(r[i])}function pA(r,e){for(let i=0;i<r.length;i++)e.writeSVarint(r[i])}function fA(r,e){for(let i=0;i<r.length;i++)e.writeFloat(r[i])}function mA(r,e){for(let i=0;i<r.length;i++)e.writeDouble(r[i])}function _A(r,e){for(let i=0;i<r.length;i++)e.writeBoolean(r[i])}function gA(r,e){for(let i=0;i<r.length;i++)e.writeFixed32(r[i])}function yA(r,e){for(let i=0;i<r.length;i++)e.writeSFixed32(r[i])}function xA(r,e){for(let i=0;i<r.length;i++)e.writeFixed64(r[i])}function vA(r,e){for(let i=0;i<r.length;i++)e.writeSFixed64(r[i])}let Cy=3;function bA(r,e,i){e.glyphs=[],r===1&&i.readMessage(wA,e)}function wA(r,e,i){if(r===3){let{id:s,bitmap:a,width:h,height:u,left:f,top:g,advance:y}=i.readMessage(TA,{});e.glyphs.push({id:s,bitmap:new Bl({width:h+2*Cy,height:u+2*Cy},a),metrics:{width:h,height:u,left:f,top:g,advance:y}})}else r===4?e.ascender=i.readSVarint():r===5&&(e.descender=i.readSVarint())}function TA(r,e,i){r===1?e.id=i.readVarint():r===2?e.bitmap=i.readBytes():r===3?e.width=i.readVarint():r===4?e.height=i.readVarint():r===5?e.left=i.readSVarint():r===6?e.top=i.readSVarint():r===7&&(e.advance=i.readVarint())}let C1=Cy,Io={horizontal:1,vertical:2,horizontalOnly:3};class Gp{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){let s=new Gp;return s.scale=e||1,s.fontStack=i,s}static forImage(e){let i=new Gp;return i.image=e,i}}class Du{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,s){let a=new Du;for(let h=0;h<e.sections.length;h++){let u=e.sections[h];u.image?a.addImageSection(u,s):a.addTextSection(u,i)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,s){let a="";for(let h=0;h<i.length;h++){let u=i.charCodeAt(h+1)||null,f=i.charCodeAt(h-1)||null;a+=!s&&(u&&cu(u)&&!jp[i[h+1]]||f&&cu(f)&&!jp[i[h-1]])||!jp[i[h]]?i[h]:jp[i[h]]}return a}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&r_[this.text.charCodeAt(s)];s++)e++;let i=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&r_[this.text.charCodeAt(s)];s--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){let s=new Du;return s.text=this.text.substring(e,i),s.sectionIndex=this.sectionIndex.slice(e,i),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(Gp.forText(e.scale,e.fontStack||i));let s=this.sections.length-1;for(let a=0;a<e.text.length;++a)this.sectionIndex.push(s)}addImageSection(e,i){let s=e.image?e.image.getPrimary():null;if(!s)return void pi("Can't add FormattedSection with an empty image.");s.scaleSelf(i);let a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCodePoint(a),this.sections.push(Gp.forImage(s)),this.sectionIndex.push(this.sections.length-1)):pi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Py(r,e,i,s,a,h,u,f,g,y,w,E,I,R,L,k=1){let B=Du.fromFeature(r,a,k);E===Io.vertical&&B.verticalizePunctuation(I);let G=[],X=function(ue,ge,ve,Ne,Ee,Ue){if(!ue)return[];let nt=[],qe=function(Je,Ie,Be,at,et,Lt){let St=0;for(let Xe=0;Xe<Je.length();Xe++){let tt=Je.getSection(Xe);St+=P1(Je.getCodePoint(Xe),tt,at,et,Ie,Lt)}return St/Math.max(1,Math.ceil(St/Be))}(ue,ge,ve,Ne,Ee,Ue),Ke=ue.text.indexOf("\u200B")>=0,it=0;for(let Je=0;Je<ue.length();Je++){let Ie=ue.getSection(Je),Be=ue.getCodePoint(Je);if(r_[Be]||(it+=P1(Be,Ie,Ne,Ee,ge,Ue)),Je<ue.length()-1){let at=!((Fe=Be)<11904||!(Ut["Bopomofo Extended"](Fe)||Ut.Bopomofo(Fe)||Ut["CJK Compatibility Forms"](Fe)||Ut["CJK Compatibility Ideographs"](Fe)||Ut["CJK Compatibility"](Fe)||Ut["CJK Radicals Supplement"](Fe)||Ut["CJK Strokes"](Fe)||Ut["CJK Symbols and Punctuation"](Fe)||Ut["CJK Unified Ideographs Extension A"](Fe)||Ut["CJK Unified Ideographs"](Fe)||Ut["Enclosed CJK Letters and Months"](Fe)||Ut["Halfwidth and Fullwidth Forms"](Fe)||Ut.Hiragana(Fe)||Ut["Ideographic Description Characters"](Fe)||Ut["Kangxi Radicals"](Fe)||Ut["Katakana Phonetic Extensions"](Fe)||Ut.Katakana(Fe)||Ut["Vertical Forms"](Fe)||Ut["Yi Radicals"](Fe)||Ut["Yi Syllables"](Fe)));(SA[Be]||at||Ie.image)&&nt.push(L1(Je+1,it,qe,nt,EA(Be,ue.getCodePoint(Je+1),at&&Ke),!1))}}var Fe;return z1(L1(ue.length(),it,qe,nt,0,!0))}(B,y,h,e,s,R),{processBidirectionalText:W,processStyledBidirectionalText:K}=as;if(W&&B.sections.length===1){let ue=W(B.toString(),X);for(let ge of ue){let ve=new Du;ve.text=ge,ve.sections=B.sections;for(let Ne=0;Ne<ge.length;Ne++)ve.sectionIndex.push(0);G.push(ve)}}else if(K){let ue=K(B.text,B.sectionIndex,X);for(let ge of ue){let ve=new Du;ve.text=ge[0],ve.sectionIndex=ge[1],ve.sections=B.sections,G.push(ve)}}else G=function(ue,ge){let ve=[],Ne=ue.text,Ee=0;for(let Ue of ge)ve.push(ue.substring(Ee,Ue)),Ee=Ue;return Ee<Ne.length&&ve.push(ue.substring(Ee,Ne.length)),ve}(B,X);let pe=[],ce={positionedLines:pe,text:B.toString(),top:w[1],bottom:w[1],left:w[0],right:w[0],writingMode:E,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(ue,ge,ve,Ne,Ee,Ue,nt,qe,Ke,it,Fe,Je){let Ie=0,Be=0,at=0,et=qe==="right"?1:qe==="left"?0:.5,Lt=!1;for(let ut of Ee){let vt=ut.getSections();for(let Vt of vt){if(Vt.image)continue;let Zt=ge[Vt.fontStack];if(Zt&&(Lt=Zt.ascender!==void 0&&Zt.descender!==void 0,!Lt))break}if(!Lt)break}let St=0;for(let ut of Ee){ut.trim();let vt=ut.getMaxScale(),Vt=(vt-1)*dn,Zt={positionedGlyphs:[],lineOffset:0};ue.positionedLines[St]=Zt;let Qt=Zt.positionedGlyphs,Kt=0;if(!ut.length()){Be+=Ue,++St;continue}let fi=0,oi=0;for(let ee=0;ee<ut.length();ee++){let te=ut.getSection(ee),Oe=ut.getSectionIndex(ee),lt=ut.getCodePoint(ee),pt=te.scale,dt=null,Et=null,qt=null,ci=dn,hi=0,ii=Ke;ii===Io.vertical&&((Xe=lt)===12312||Xe===12313||Xe===12316||Xe===12540||Xe===12448)&&(ii=Io.horizontal);let Gi=!(ii===Io.horizontal||!Fe&&!lu(lt)||Fe&&(r_[lt]||pm(lt)));if(te.image){let Tr=Ne.get(te.image.toString());if(!Tr)continue;qt=te.image,ue.iconsInText=ue.iconsInText||!0,Et=Tr.paddedRect;let ei=Tr.displaySize;pt=pt*dn/Je,dt={width:ei[0],height:ei[1],left:0,top:-C1,advance:Gi?ei[1]:ei[0],localGlyph:!1},hi=Lt?-dt.height*pt:vt*dn-17-ei[1]*pt,ci=dt.advance;let ar=(Gi?ei[0]:ei[1])*pt-dn*vt;ar>0&&ar>Kt&&(Kt=ar)}else{let Tr=ve[te.fontStack];if(!Tr)continue;Tr[lt]&&(Et=Tr[lt]);let ei=ge[te.fontStack];if(!ei)continue;let ar=ei.glyphs[lt];if(!ar)continue;if(dt=ar.metrics,ci=lt!==8203?dn:0,Lt){let Ji=ei.ascender!==void 0?Math.abs(ei.ascender):0,Bi=ei.descender!==void 0?Math.abs(ei.descender):0,xr=(Ji+Bi)*pt;fi<xr&&(fi=xr,oi=(Ji-Bi)/2*pt),hi=-Ji*pt}else hi=(vt-pt)*dn-17}Gi?(ue.verticalizable=!0,Qt.push({glyph:lt,image:qt,x:Ie,y:Be+hi,vertical:Gi,scale:pt,localGlyph:dt.localGlyph,fontStack:te.fontStack,sectionIndex:Oe,metrics:dt,rect:Et}),Ie+=ci*pt+it):(Qt.push({glyph:lt,image:qt,x:Ie,y:Be+hi,vertical:Gi,scale:pt,localGlyph:dt.localGlyph,fontStack:te.fontStack,sectionIndex:Oe,metrics:dt,rect:Et}),Ie+=dt.advance*pt+it)}Qt.length!==0&&(at=Math.max(Ie-it,at),Lt?D1(Qt,et,Kt,oi,Ue*vt/2):D1(Qt,et,Kt,0,Ue/2)),Ie=0;let ir=Ue*vt+Kt;Zt.lineOffset=Math.max(Kt,Vt),Be+=ir,++St}var Xe;let tt=Be,{horizontalAlign:It,verticalAlign:xt}=Ry(nt);(function(ut,vt,Vt,Zt,Qt,Kt){let fi=(vt-Vt)*Qt,oi=-Kt*Zt;for(let ir of ut)for(let ee of ir.positionedGlyphs)ee.x+=fi,ee.y+=oi})(ue.positionedLines,et,It,xt,at,tt),ue.top+=-xt*tt,ue.bottom=ue.top+tt,ue.left+=-It*at,ue.right=ue.left+at,ue.hasBaseline=Lt}(ce,e,i,s,G,u,f,g,E,y,I,L),!function(ue){for(let ge of ue)if(ge.positionedGlyphs.length!==0)return!1;return!0}(pe))return ce}let r_={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},SA={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function P1(r,e,i,s,a,h){if(e.image){let u=s.get(e.image.toString());return u?u.displaySize[0]*e.scale*dn/h+a:0}{let u=i[e.fontStack],f=u&&u.glyphs[r];return f?f.metrics.advance*e.scale+a:0}}function R1(r,e,i,s){let a=Math.pow(r-e,2);return s?r<e?a/2:2*a:a+Math.abs(i)*i}function EA(r,e,i){let s=0;return r===10&&(s-=1e4),i&&(s+=150),r!==40&&r!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function L1(r,e,i,s,a,h){let u=null,f=R1(e,i,a,h);for(let g of s){let y=R1(e-g.x,i,a,h)+g.badness;y<=f&&(u=g,f=y)}return{index:r,x:e,priorBreak:u,badness:f}}function z1(r){return r?z1(r.priorBreak).concat(r.index):[]}function Ry(r){let e=.5,i=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function D1(r,e,i,s,a){if(!(e||i||s||a))return;let h=r.length-1,u=r[h],f=(u.x+u.metrics.advance*u.scale)*e;for(let g=0;g<=h;g++)r[g].x-=f,r[g].y+=i+s+a}function O1(r){return r.imagePrimary!==void 0&&r.top!==void 0&&r.bottom!==void 0&&r.left!==void 0&&r.right!==void 0}function IA(r,e,i,s){let{horizontalAlign:a,verticalAlign:h}=Ry(s),u=i[0]-r.displaySize[0]*a,f=i[1]-r.displaySize[1]*h;return{imagePrimary:r,imageSecondary:e,top:f,bottom:f+r.displaySize[1],left:u,right:u+r.displaySize[0]}}function k1(r,e,i,s,a,h){let u=r.imagePrimary,f;if(u.content){let B=u.content,G=u.pixelRatio||1;f=[B[0]/G,B[1]/G,u.displaySize[0]-B[2]/G,u.displaySize[1]-B[3]/G]}let g=e.left*h,y=e.right*h,w,E,I,R;i==="width"||i==="both"?(R=a[0]+g-s[3],E=a[0]+y+s[1]):(R=a[0]+(g+y-u.displaySize[0])/2,E=R+u.displaySize[0]);let L=e.top*h,k=e.bottom*h;return i==="height"||i==="both"?(w=a[1]+L-s[0],I=a[1]+k+s[2]):(w=a[1]+(L+k-u.displaySize[1])/2,I=w+u.displaySize[1]),{imagePrimary:u,imageSecondary:void 0,top:w,right:E,bottom:I,left:R,collisionPadding:f}}function F1(r){return!r.imagePrimary.stretchX}function B1(r){return!r.imagePrimary.stretchY}function N1(r){return{width:r.right-r.left,height:r.bottom-r.top}}let ua=128;function V1(r,e,i){let{expression:s}=e;if(s.kind==="constant")return{kind:"constant",layoutSize:s.evaluate(new ji(r+1,{worldview:i}))};if(s.kind==="source")return{kind:"source"};{let{zoomStops:a,interpolationType:h}=s,u=0;for(;u<a.length&&a[u]<=r;)u++;u=Math.max(0,u-1);let f=u;for(;f<a.length&&a[f]<r+1;)f++;f=Math.min(a.length-1,f);let g=a[u],y=a[f];return s.kind==="composite"?{kind:"composite",minZoom:g,maxZoom:y,interpolationType:h}:{kind:"camera",minZoom:g,maxZoom:y,minSize:s.evaluate(new ji(g,{worldview:i})),maxSize:s.evaluate(new ji(y,{worldview:i})),interpolationType:h}}}function Ly(r,{uSize:e,uSizeT:i},{lowerSize:s,upperSize:a}){return r.kind==="source"?s/ua:r.kind==="composite"?Bt(s/ua,a/ua,i):e}function qp(r,e,i=1){let s=0,a=0;if(r.kind==="constant")a=r.layoutSize*i;else if(r.kind!=="source"){let{interpolationType:h,minZoom:u,maxZoom:f}=r,g=h?re(qn.interpolationFactor(h,e,u,f),0,1):0;r.kind==="camera"?a=Bt(r.minSize,r.maxSize,g)*i:s=g*i}return{uSizeT:s,uSize:a}}class ja extends Qe{constructor(e,i,s,a,h){super(e,i),this.angle=a,this.z=s,h!==void 0&&(this.segment=h)}clone(){return new ja(this.x,this.y,this.z,this.angle,this.segment)}}function U1(r,e,i,s,a){if(e.segment===void 0)return!0;let h=e,u=e.segment+1,f=0;for(;f>-i/2;){if(u--,u<0)return!1;f-=r[u].dist(h),h=r[u]}f+=r[u].dist(r[u+1]),u++;let g=[],y=0;for(;f<i/2;){let w=r[u],E=r[u+1];if(!E)return!1;let I=r[u-1].angleTo(w)-w.angleTo(E);for(I=Math.abs((I+3*Math.PI)%(2*Math.PI)-Math.PI),g.push({distance:f,angleDelta:I}),y+=I;f-g[0].distance>s;)y-=g.shift().angleDelta;if(y>a)return!1;u++,f+=w.dist(E)}return!0}function j1(r){let e=0;for(let i=0;i<r.length-1;i++)e+=r[i].dist(r[i+1]);return e}function G1(r,e,i){return r?.6*e*i:0}function q1(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function AA(r,e,i,s,a,h){let u=G1(i,a,h),f=q1(i,s)*h,g=0,y=j1(r)/2;for(let w=0;w<r.length-1;w++){let E=r[w],I=r[w+1],R=E.dist(I);if(g+R>y){let L=(y-g)/R,k=Bt(E.x,I.x,L),B=Bt(E.y,I.y,L),G=new ja(k,B,0,I.angleTo(E),w);return!u||U1(r,G,f,u,e)?G:void 0}g+=R}}function MA(r,e,i,s,a,h,u,f,g){let y=G1(s,h,u),w=q1(s,a),E=w*u,I=r[0].x===0||r[0].x===g||r[0].y===0||r[0].y===g;return e-E<e/4&&(e=E+e/4),H1(r,I?e/2*f%e:(w/2+2*h)*u*f%e,e,y,i,E,I,!1,g)}function H1(r,e,i,s,a,h,u,f,g){let y=h/2,w=j1(r),E=0,I=e-i,R=[];for(let L=0;L<r.length-1;L++){let k=r[L],B=r[L+1],G=k.dist(B),X=B.angleTo(k);for(;I+i<E+G;){I+=i;let W=(I-E)/G,K=Bt(k.x,B.x,W),pe=Bt(k.y,B.y,W);if(K>=0&&K<g&&pe>=0&&pe<g&&I-y>=0&&I+y<=w){let ce=new ja(K,pe,0,X,L);s&&!U1(r,ce,h,s,a)||R.push(ce)}}E+=G}return f||R.length||u||(R=H1(r,E/2,i,s,a,h,u,!0,g)),R}function $1(r){let e=0,i=0;for(let u of r)e+=u.w*u.h,i=Math.max(i,u.w);r.sort((u,f)=>f.h-u.h);let s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}],a=0,h=0;for(let u of r)for(let f=s.length-1;f>=0;f--){let g=s[f];if(!(u.w>g.w||u.h>g.h)){if(u.x=g.x,u.y=g.y,h=Math.max(h,u.y+u.h),a=Math.max(a,u.x+u.w),u.w===g.w&&u.h===g.h){let y=s.pop();y&&f<s.length&&(s[f]=y)}else u.h===g.h?(g.x+=u.w,g.w-=u.w):u.w===g.w?(g.y+=u.h,g.h-=u.h):(s.push({x:g.x+u.w,y:g.y,w:g.w-u.w,h:u.h}),g.y+=u.h,g.h-=u.h);break}}return{w:a,h,fill:e/(a*h)||0}}Tt(ja,"Anchor");let sh=1;class Hp{static getImagePositionScale(e,i,s){if(i&&e&&e.options&&e.options.transform){let a=e.options.transform;return{x:a.a,y:a.d}}return{x:s,y:s}}constructor(e,i,s,a){this.paddedRect=e;let{pixelRatio:h,version:u,stretchX:f,stretchY:g,content:y,sdf:w,usvg:E}=i;this.pixelRatio=h,this.stretchX=f,this.stretchY=g,this.content=y,this.version=u,this.padding=s,this.sdf=w,this.usvg=E,this.scale=Hp.getImagePositionScale(a,E,h)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function zy(r,e,i){let s=Cs.parse(r),a=function(h,u,f=[1,1]){return{x:0,y:0,w:(h.data?h.data.width:h.width*f[0])+2*u,h:(h.data?h.data.height:h.height*f[1])+2*u}}(e,i,[s.options.transform.a,s.options.transform.d]);return{bin:a,imagePosition:new Hp(a,e,i,s),imageVariant:s}}class Z1{constructor(e,i,s){let a=new Map,h=new Map;this.haveRenderCallbacks=[];let u=[];this.addImages(e,a,sh,u),this.addImages(i,h,2,u);let{w:f,h:g}=$1(u),y=new vn({width:f||1,height:g||1});for(let[w,E]of e.entries()){let I=a.get(w).paddedRect;vn.copy(E.data,y,{x:0,y:0},{x:I.x+sh,y:I.y+sh},E.data,s,E.sdf)}for(let[w,E]of i.entries()){let I=h.get(w),R=I.paddedRect,L=I.padding,k=R.x+L,B=R.y+L,G=E.data.width,X=E.data.height;L=L>1?L-1:L,vn.copy(E.data,y,{x:0,y:0},{x:k,y:B},E.data,s),vn.copy(E.data,y,{x:0,y:X-L},{x:k,y:B-L},{width:G,height:L},s),vn.copy(E.data,y,{x:0,y:0},{x:k,y:B+X},{width:G,height:L},s),vn.copy(E.data,y,{x:G-L,y:0},{x:k-L,y:B},{width:L,height:X},s),vn.copy(E.data,y,{x:0,y:0},{x:k+G,y:B},{width:L,height:X},s),vn.copy(E.data,y,{x:G-L,y:X-L},{x:k-L,y:B-L},{width:L,height:L},s),vn.copy(E.data,y,{x:0,y:X-L},{x:k+G,y:B-L},{width:L,height:L},s),vn.copy(E.data,y,{x:0,y:0},{x:k+G,y:B+X},{width:L,height:L},s),vn.copy(E.data,y,{x:G-L,y:0},{x:k-L,y:B+X},{width:L,height:L},s)}this.lut=s,this.image=y,this.iconPositions=a,this.patternPositions=h}addImages(e,i,s,a){for(let[h,u]of e.entries()){let{bin:f,imagePosition:g,imageVariant:y}=zy(h,u,s);i.set(h,g),a.push(f),u.hasRenderCallback&&this.haveRenderCallbacks.push(y.id)}}patchUpdatedImages(e,i,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(a=>e.hasImage(a,s)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(let a of e.getUpdatedImages(s)){for(let h of this.iconPositions.keys()){let u=Cs.parse(h);if(Kn.isEqual(u.id,a)){let f=e.getImage(a,s);this.patchUpdatedImage(this.iconPositions.get(h),f,i)}}for(let h of this.patternPositions.keys()){let u=Cs.parse(h);if(Kn.isEqual(u.id,a)){let f=e.getImage(a,s);this.patchUpdatedImage(this.patternPositions.get(h),f,i)}}}}patchUpdatedImage(e,i,s){if(!e||!i||e.version===i.version)return;e.version=i.version;let[a,h]=e.tl,u=e.sdf;if(this.lut||u){let f={width:i.data.width,height:i.data.height},g=new vn(f);vn.copy(i.data,g,{x:0,y:0},{x:0,y:0},f,this.lut,u),s.update(g,{position:{x:a,y:h}})}else s.update(i.data,{position:{x:a,y:h}})}}Tt(Hp,"ImagePosition"),Tt(Z1,"ImageAtlas");let $p=1e20;function W1(r,e,i,s,a,h,u,f,g){for(let y=e;y<e+s;y++)X1(r,i*h+y,h,a,u,f,g);for(let y=i;y<i+a;y++)X1(r,y*h+e,1,s,u,f,g)}function X1(r,e,i,s,a,h,u){h[0]=0,u[0]=-$p,u[1]=$p,a[0]=r[e];for(let f=1,g=0,y=0;f<s;f++){a[f]=r[e+f*i];let w=f*f;do{let E=h[g];y=(a[f]-a[E]+w-E*E)/(f-E)/2}while(y<=u[g]&&--g>-1);g++,h[g]=f,u[g]=y,u[g+1]=$p}for(let f=0,g=0;f<s;f++){for(;u[g+1]<f;)g++;let y=h[g],w=f-y;r[e+f*i]=a[y]+w*w}}let zs=2,Dy={none:0,ideographs:1,all:2};class Ou{constructor(e,i,s){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=s,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,i){let s=[],a=this.url||mn.GLYPHS_URL;for(let h in e)for(let u of e[h])s.push({stack:h,id:u});be(s,({stack:h,id:u},f)=>{let g=this.entries[h];g||(g=this.entries[h]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let y=g.glyphs[u];if(y!==void 0)return void f(null,{stack:h,id:u,glyph:y});if(y=this._tinySDF(g,h,u),y)return g.glyphs[u]=y,void f(null,{stack:h,id:u,glyph:y});let w=Math.floor(u/256);if(256*w>65535)return pi("glyphs > 65535 not supported"),void f(null,{stack:h,id:u,glyph:y});if(g.ranges[w])return void f(null,{stack:h,id:u,glyph:y});let E=g.requests[w];E||(E=g.requests[w]=[],Ou.loadGlyphRange(h,w,a,this.requestManager,(I,R)=>{if(R){g.ascender=R.ascender,g.descender=R.descender;for(let L in R.glyphs)this._doesCharSupportLocalGlyph(+L)||(g.glyphs[+L]=R.glyphs[+L]);g.ranges[w]=!0}for(let L of E)L(I,R);delete g.requests[w]})),E.push((I,R)=>{I?f(I):R&&f(null,{stack:h,id:u,glyph:R.glyphs[u]||null})})},(h,u)=>{if(h)i(h);else if(u){let f={};for(let{stack:g,id:y,glyph:w}of u)f[g]===void 0&&(f[g]={}),f[g].glyphs===void 0&&(f[g].glyphs={}),f[g].glyphs[y]=w&&{id:w.id,bitmap:w.bitmap.clone(),metrics:w.metrics},f[g].ascender=this.entries[g].ascender,f[g].descender=this.entries[g].descender;i(null,f)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Dy.none&&(this.localGlyphMode===Dy.all?!!this.localFontFamily:!!this.localFontFamily&&(Ut["CJK Unified Ideographs"](e)||Ut["Hangul Syllables"](e)||Ut.Hiragana(e)||Ut.Katakana(e)||Ut["CJK Symbols and Punctuation"](e)||Ut["CJK Unified Ideographs Extension A"](e)||Ut["CJK Unified Ideographs Extension B"](e)||Ut.Osage(e)))}_tinySDF(e,i,s){let a=this.localFontFamily;if(!a||!this._doesCharSupportLocalGlyph(s))return;let h=e.tinySDF;if(!h){let k="400";/bold/i.test(i)?k="900":/medium/i.test(i)?k="500":/light/i.test(i)&&(k="200"),h=e.tinySDF=new Ou.TinySDF({fontFamily:a,fontWeight:k,fontSize:24*zs,buffer:3*zs,radius:8*zs}),h.fontWeight=k}if(this.localGlyphs[h.fontWeight][s])return this.localGlyphs[h.fontWeight][s];let u=String.fromCodePoint(s),{data:f,width:g,height:y,glyphWidth:w,glyphHeight:E,glyphLeft:I,glyphTop:R,glyphAdvance:L}=h.draw(u);return this.localGlyphs[h.fontWeight][s]={id:s,bitmap:new Bl({width:g,height:y},f),metrics:{width:w/zs,height:E/zs,left:I/zs,top:R/zs-27,advance:L/zs,localGlyph:!0}}}}Ou.loadGlyphRange=function(r,e,i,s,a){let h=256*e,u=h+255,f=s.transformRequest(s.normalizeGlyphsURL(i).replace("{fontstack}",r).replace("{range}",`${h}-${u}`),yc.Glyphs);xc(f,(g,y)=>{if(g)a(g);else if(y){let w={},E=function(I){return new i_(I).readFields(bA,{})}(y);for(let I of E.glyphs)w[I.id]=I;a(null,{glyphs:w,ascender:E.ascender,descender:E.descender})}})},Ou.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:i=8,cutoff:s=.25,fontFamily:a="sans-serif",fontWeight:h="normal",fontStyle:u="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=i;let f=this.size=r+4*e,g=this._createCanvas(f),y=this.ctx=g.getContext("2d",{willReadFrequently:!0});y.font=`${u} ${h} ${r}px ${a}`,y.textBaseline="alphabetic",y.textAlign="left",y.fillStyle="black",this.gridOuter=new Float64Array(f*f),this.gridInner=new Float64Array(f*f),this.f=new Float64Array(f),this.z=new Float64Array(f+1),this.v=new Uint16Array(f)}_createCanvas(r){let e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){let{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:s,actualBoundingBoxLeft:a,actualBoundingBoxRight:h}=this.ctx.measureText(r),u=Math.ceil(i),f=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(h-a))),g=Math.min(this.size-this.buffer,u+Math.ceil(s)),y=f+2*this.buffer,w=g+2*this.buffer,E=Math.max(y*w,0),I=new Uint8ClampedArray(E),R={data:I,width:y,height:w,glyphWidth:f,glyphHeight:g,glyphTop:u,glyphLeft:0,glyphAdvance:e};if(f===0||g===0)return R;let{ctx:L,buffer:k,gridInner:B,gridOuter:G}=this;L.clearRect(k,k,f,g),L.fillText(r,k,k+u);let X=L.getImageData(k,k,f,g);G.fill($p,0,E),B.fill(0,0,E);for(let W=0;W<g;W++)for(let K=0;K<f;K++){let pe=X.data[4*(W*f+K)+3]/255;if(pe===0)continue;let ce=(W+k)*y+K+k;if(pe===1)G[ce]=0,B[ce]=$p;else{let ue=.5-pe;G[ce]=ue>0?ue*ue:0,B[ce]=ue<0?ue*ue:0}}W1(G,0,0,y,w,y,this.f,this.v,this.z),W1(B,k,k,f,g,y,this.f,this.v,this.z);for(let W=0;W<E;W++){let K=Math.sqrt(G[W])-Math.sqrt(B[W]);I[W]=Math.round(255-255*(K/this.radius+this.cutoff))}return R}};let Ul=sh;function Y1(r,e){return r+e[1]-e[0]}function K1(r,e,i,s,a=1){let h=[],u=r.imagePrimary,f=u.pixelRatio,g=u.paddedRect.w-2*Ul,y=u.paddedRect.h-2*Ul,w=(r.right-r.left)*a,E=(r.bottom-r.top)*a,I=u.stretchX||[[0,g]],R=u.stretchY||[[0,y]],L=I.reduce(Y1,0),k=R.reduce(Y1,0),B=g-L,G=y-k,X=0,W=L,K=0,pe=k,ce=0,ue=B,ge=0,ve=G;if(u.content&&s){let Ee=u.content;X=n_(I,0,Ee[0]),K=n_(R,0,Ee[1]),W=n_(I,Ee[0],Ee[2]),pe=n_(R,Ee[1],Ee[3]),ce=Ee[0]-X,ge=Ee[1]-K,ue=Ee[2]-Ee[0]-W,ve=Ee[3]-Ee[1]-pe}let Ne=(Ee,Ue,nt,qe)=>{let Ke=o_(Ee.stretch-X,W,w,r.left*a),it=s_(Ee.fixed-ce,ue,Ee.stretch,L),Fe=o_(Ue.stretch-K,pe,E,r.top*a),Je=s_(Ue.fixed-ge,ve,Ue.stretch,k),Ie=o_(nt.stretch-X,W,w,r.left*a),Be=s_(nt.fixed-ce,ue,nt.stretch,L),at=o_(qe.stretch-K,pe,E,r.top*a),et=s_(qe.fixed-ge,ve,qe.stretch,k),Lt=new Qe(Ke,Fe),St=new Qe(Ie,Fe),Xe=new Qe(Ie,at),tt=new Qe(Ke,at),It=new Qe(it/f,Je/f),xt=new Qe(Be/f,et/f),ut=e*Math.PI/180;if(ut){let fi=Math.sin(ut),oi=Math.cos(ut),ir=[oi,-fi,fi,oi];Lt._matMult(ir),St._matMult(ir),tt._matMult(ir),Xe._matMult(ir)}let vt=Ee.stretch+Ee.fixed,Vt=nt.stretch+nt.fixed,Zt=Ue.stretch+Ue.fixed,Qt=qe.stretch+qe.fixed,Kt=r.imageSecondary;return{tl:Lt,tr:St,bl:tt,br:Xe,texPrimary:{x:u.paddedRect.x+Ul+vt,y:u.paddedRect.y+Ul+Zt,w:Vt-vt,h:Qt-Zt},texSecondary:Kt?{x:Kt.paddedRect.x+Ul+vt,y:Kt.paddedRect.y+Ul+Zt,w:Vt-vt,h:Qt-Zt}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:It,pixelOffsetBR:xt,minFontScaleX:ue/f/w,minFontScaleY:ve/f/E,isSDF:i}};if(s&&(u.stretchX||u.stretchY)){let Ee=J1(I,B,L),Ue=J1(R,G,k);for(let nt=0;nt<Ee.length-1;nt++){let qe=Ee[nt],Ke=Ee[nt+1];for(let it=0;it<Ue.length-1;it++)h.push(Ne(qe,Ue[it],Ke,Ue[it+1]))}}else h.push(Ne({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:g+1},{fixed:0,stretch:y+1}));return h}function n_(r,e,i){let s=0;for(let a of r)s+=Math.max(e,Math.min(i,a[1]))-Math.max(e,Math.min(i,a[0]));return s}function J1(r,e,i){let s=[{fixed:-Ul,stretch:0}];for(let[a,h]of r){let u=s[s.length-1];s.push({fixed:a-u.stretch,stretch:u.stretch}),s.push({fixed:a-u.stretch,stretch:u.stretch+(h-a)})}return s.push({fixed:e+Ul,stretch:i}),s}function o_(r,e,i,s){return r/e*i+s}function s_(r,e,i,s){return r-e*i/s}function CA(r,e,i,s){let a=e+r.positionedLines[s].lineOffset;return s===0?i+a/2:i+(a+(e+r.positionedLines[s-1].lineOffset))/2}function PA(r,e=1,i=!1){let s=1/0,a=1/0,h=-1/0,u=-1/0,f=r[0];for(let R=0;R<f.length;R++){let L=f[R];(!R||L.x<s)&&(s=L.x),(!R||L.y<a)&&(a=L.y),(!R||L.x>h)&&(h=L.x),(!R||L.y>u)&&(u=L.y)}let g=Math.min(h-s,u-a),y=g/2,w=new Fh([],RA);if(g===0)return new Qe(s,a);for(let R=s;R<h;R+=g)for(let L=a;L<u;L+=g)w.push(new ku(R+y,L+y,y,r));let E=function(R){let L=0,k=0,B=0,G=R[0];for(let X=0,W=G.length,K=W-1;X<W;K=X++){let pe=G[X],ce=G[K],ue=pe.x*ce.y-ce.x*pe.y;k+=(pe.x+ce.x)*ue,B+=(pe.y+ce.y)*ue,L+=3*ue}return new ku(k/L,B/L,0,R)}(r),I=w.length;for(;w.length;){let R=w.pop();(R.d>E.d||!E.d)&&(E=R,i&&console.log("found best %d after %d probes",Math.round(1e4*R.d)/1e4,I)),R.max-E.d<=e||(y=R.h/2,w.push(new ku(R.p.x-y,R.p.y-y,y,r)),w.push(new ku(R.p.x+y,R.p.y-y,y,r)),w.push(new ku(R.p.x-y,R.p.y+y,y,r)),w.push(new ku(R.p.x+y,R.p.y+y,y,r)),I+=4)}return i&&(console.log(`num probes: ${I}`),console.log(`best distance: ${E.d}`)),E.p}function RA(r,e){return e.max-r.max}class ku{constructor(e,i,s,a){this.p=new Qe(e,i),this.h=s,this.d=function(h,u){let f=!1,g=1/0;for(let y=0;y<u.length;y++){let w=u[y];for(let E=0,I=w.length,R=I-1;E<I;R=E++){let L=w[E],k=w[R];L.y>h.y!=k.y>h.y&&h.x<(k.x-L.x)*(h.y-L.y)/(k.y-L.y)+L.x&&(f=!f),g=Math.min(g,bo(h,L,k))}}return(f?1:-1)*Math.sqrt(g)}(this.p,a),this.max=this.d+this.h*Math.SQRT2}}let LA=Object.keys,Oy=Number.POSITIVE_INFINITY,zA=Math.sqrt(2);function Q1(r,[e,i]){let s=0,a=0;if(i===Oy){e<0&&(e=0);let h=e/zA;switch(r){case"top-right":case"top-left":a=h-7;break;case"bottom-right":case"bottom-left":a=7-h;break;case"bottom":a=7-e;break;case"top":a=e-7}switch(r){case"top-right":case"bottom-right":s=-h;break;case"top-left":case"bottom-left":s=h;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),r){case"top-right":case"top-left":case"top":a=i-7;break;case"bottom-right":case"bottom-left":case"bottom":a=7-i}switch(r){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,a]}function a_(r,e,i,s,a,h,u,f,g){if(!e||!e.usvg)return;let y=N1(s),w=N1(a),E=h!=="both"&&h!=="width"||!F1(s)?1:w.width/y.width,I=h!=="both"&&h!=="height"||!B1(s)?1:w.height/y.height;i.scaleSelf(E,I);let R=i.toString();u.set(R,i),f.set(R,e);let{imagePosition:L}=zy(R,e,sh);g.set(R,L)}function eb(r,e,i,s,a,h,u,f,g){if(!r)return;let y=function(w,E,I,R,L,k){if(w.kind==="camera")return w.maxSize;if(w.kind==="composite"){let B=E.possiblyEvaluate(new ji(w.maxZoom,{worldview:k}),I).evaluate(L,{},I),G=E.possiblyEvaluate(new ji(w.minZoom,{worldview:k}),I).evaluate(L,{},I);return Math.max(B,G)}return E.possiblyEvaluate(new ji(R,{worldview:k})).evaluate(L,{},I)}(e,i,s,a,h,g);return r.scaleSelf(y*f*u)}function tb(r,e,i,s,a,h,u,f,g){return{iconPrimary:eb(r.getPrimary(),e,i,s,a,h,u,f,g),iconSecondary:eb(r.getSecondary(),e,i,s,a,h,u,f,g)}}function DA(r,e,i){if(!e)return;let s=i.get(r.toString()),a=i.get(e.toString());a&&(s.paddedRect.w===a.paddedRect.w&&s.paddedRect.h===a.paddedRect.h||pi(`Mismatch in icon variant sizes: ${r.toString()} and ${e.toString()}`),s.usvg!==a.usvg&&pi(`Mismatch in icon variant image types: ${r.id} and ${e.id}`))}function ib(r,e,i,s){if(!r)return;let a=e.get(i.toString());if(r.imagePrimary=a,s){let h=e.get(s.toString());r.imageSecondary=h}}function OA(r,e){for(let i in r.horizontal)rb(r.horizontal[i],e);rb(r.vertical,e)}function rb(r,e){if(r){for(let i of r.positionedLines)for(let s of i.positionedGlyphs)if(s.image!==null){let a=s.image.toString();s.rect=e.get(a).paddedRect}}}function ky(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function kA(r,e,i,s,a,h,u,f,g){let y=Fy(h.horizontal)||h.vertical,w=i.get("icon-text-fit-padding").evaluate(s,{},a),E,I=e;return e&&g!=="none"&&(r.allowVerticalPlacement&&h.vertical&&(E=k1(e,h.vertical,g,w,f,u)),y&&(I=k1(e,y,g,w,f,u))),{defaultShapedIcon:I,verticallyShapedIcon:E}}function FA(r,e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G,X,W){let K=u.textMaxSize.evaluate(e,{},I);K===void 0?K=f*u.textScaleFactor:K*=u.textScaleFactor;let pe=r.layers[0].layout,ce=Fy(i.horizontal)||i.vertical,ue=R.name==="globe",ge=dn,ve=r.tilePixelRatio*K/ge,Ne=(it=r.overscaling,r.zoom>18&&it>2&&(it>>=1),Math.max(ht/(512*it),1)*pe.get("symbol-spacing")),Ee=pe.get("text-padding")*r.tilePixelRatio,Ue=pe.get("icon-padding")*r.tilePixelRatio,nt=Ai(pe.get("text-max-angle")),qe=pe.get("icon-rotation-alignment")==="map"&&W!=="point",Ke=Ne/2;var it;r.hasAnyIconTextFit===!1&&B!=="none"&&(r.hasAnyIconTextFit=!0);let Fe=e.properties?+e.properties[yt]:null,Je=Fe&&r.elevationFeatureIdToIndex?r.elevationFeatureIdToIndex.get(Fe):65535,Ie=(Be,at,et)=>{if(at.x<0||at.x>=ht||at.y<0||at.y>=ht)return;let Lt=null;if(ue){let{x:St,y:Xe,z:tt}=R.projectTilePoint(at.x,at.y,et);Lt={anchor:new ja(St,Xe,tt,0,void 0),up:R.upVector(et,at.x,at.y)}}(function(St,Xe,tt,It,xt,ut,vt,Vt,Zt,Qt,Kt,fi,oi,ir,ee,te,Oe,lt,pt,dt,Et,qt,ci,hi,ii,Gi,Tr,ei,ar){let Ji=St.addToLineVertexArray(Xe,It),Bi,xr,rr,Qi,tr,Ui,ri,qi=0,vr=0,jt=0,xi=0,nr=-1,Er=-1,lr={},Yr=nl(""),Zi=tt?tt.anchor:Xe,jr=ei!=="none",to=0,bn=0;if(Zt._unevaluatedLayout.getValue("text-radial-offset")===void 0){let Kr=Zt.layout.get("text-offset").evaluate(Et,{},ii);to=Kr[0]*dn,bn=Kr[1]*dn}else to=Zt.layout.get("text-radial-offset").evaluate(Et,{},ii)*dn,bn=Oy;if(St.allowVerticalPlacement&&xt.vertical){let Kr=xt.vertical;if(ee)Ui=By(Kr),Vt&&(ri=By(Vt));else{let rn=Zt.layout.get("text-rotate").evaluate(Et,{},ii)+90;rr=l_(Qt,Zi,Xe,Kt,fi,oi,Kr,ir,rn,te),Vt&&(Qi=l_(Qt,Zi,Xe,Kt,fi,oi,Vt,lt,rn))}}if(ut){let Kr=St.iconSizeData,rn=Zt.layout.get("icon-rotate").evaluate(Et,{},ii),wn=K1(ut,rn,ci,jr,qt.iconScaleFactor),Fn=Vt?K1(Vt,rn,ci,jr,qt.iconScaleFactor):void 0;xr=l_(Qt,Zi,Xe,Kt,fi,oi,ut,lt,rn,null),qi=4*wn.length;let Pn=null;Kr.kind==="source"?(Pn=[ua*Zt.layout.get("icon-size").evaluate(Et,{},ii)*qt.iconScaleFactor],Pn[0]>jl&&pi(`${St.layerIds[0]}: Value for "icon-size" is >= ${Zp}. Reduce your "icon-size".`)):Kr.kind==="composite"&&(Pn=[ua*qt.compositeIconSizes[0].evaluate(Et,{},ii)*qt.iconScaleFactor,ua*qt.compositeIconSizes[1].evaluate(Et,{},ii)*qt.iconScaleFactor],(Pn[0]>jl||Pn[1]>jl)&&pi(`${St.layerIds[0]}: Value for "icon-size" is >= ${Zp}. Reduce your "icon-size".`)),St.addSymbols(St.icon,wn,Pn,dt,pt,Et,void 0,tt,Xe,Ji.lineStartIndex,Ji.lineLength,-1,hi,ii,Gi,Tr),nr=St.icon.placedSymbolArray.length-1,Fn&&(vr=4*Fn.length,St.addSymbols(St.icon,Fn,Pn,dt,pt,Et,Io.vertical,tt,Xe,Ji.lineStartIndex,Ji.lineLength,-1,hi,ii,Gi,Tr),Er=St.icon.placedSymbolArray.length-1)}for(let Kr in xt.horizontal){let rn=Kr,wn=xt.horizontal[rn];Bi||(Yr=nl(wn.text),ee?tr=By(wn):Bi=l_(Qt,Zi,Xe,Kt,fi,oi,wn,ir,Zt.layout.get("text-rotate").evaluate(Et,{},ii),te));let Fn=wn.positionedLines.length===1;if(jt+=nb(St,tt,Xe,wn,vt,Zt,ee,Et,te,Ji,xt.vertical?Io.horizontal:Io.horizontalOnly,Fn?LA(xt.horizontal):[rn],lr,nr,qt,hi,ii,Gi),Fn)break}xt.vertical&&(xi+=nb(St,tt,Xe,xt.vertical,vt,Zt,ee,Et,te,Ji,Io.vertical,["vertical"],lr,Er,qt,hi,ii,Gi));let _n=-1,io=(Kr,rn)=>Kr?Math.max(Kr,rn):rn;_n=io(tr,_n),_n=io(Ui,_n),_n=io(ri,_n);let da=_n>-1?1:0;St.glyphOffsetArray.length>=65535&&pi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Et.sortKey!==void 0&&St.addToSortKeyRanges(St.symbolInstances.length,Et.sortKey),St.symbolInstances.emplaceBack(Xe.x,Xe.y,Zi.x,Zi.y,Zi.z,lr.right>=0?lr.right:-1,lr.center>=0?lr.center:-1,lr.left>=0?lr.left:-1,lr.vertical>=0?lr.vertical:-1,nr,Er,Yr,Bi!==void 0?Bi:St.collisionBoxArray.length,Bi!==void 0?Bi+1:St.collisionBoxArray.length,rr!==void 0?rr:St.collisionBoxArray.length,rr!==void 0?rr+1:St.collisionBoxArray.length,xr!==void 0?xr:St.collisionBoxArray.length,xr!==void 0?xr+1:St.collisionBoxArray.length,Qi||St.collisionBoxArray.length,Qi?Qi+1:St.collisionBoxArray.length,Kt,jt,xi,qi,vr,da,0,to,bn,_n,0,jr?1:0,ar)})(r,at,Lt,Be,i,s,h,a,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,Ee,X,y,0,Ue,qe,G,e,u,w,E,I,L,k,B,Je)};if(W==="line")for(let Be of Wm(e.geometry,0,0,ht,ht)){let at=MA(Be,Ne,nt,i.vertical||ce,s,ge,ve,r.overscaling,ht);for(let et of at)ce&&BA(r,ce.text,Ke,et)||Ie(Be,et,I)}else if(W==="line-center"){for(let Be of e.geometry)if(Be.length>1){let at=AA(Be,nt,i.vertical||ce,s,ge,ve);at&&Ie(Be,at,I)}}else if(e.type==="Polygon")for(let Be of Cp(e.geometry,0)){let at=PA(Be,16);Ie(Be[0],new ja(at.x,at.y,0,0,void 0),I)}else if(e.type==="LineString")for(let Be of e.geometry)Ie(Be,new ja(Be[0].x,Be[0].y,0,0,void 0),I);else if(e.type==="Point")for(let Be of e.geometry)for(let at of Be)Ie([at],new ja(at.x,at.y,0,0,void 0),I)}let Zp=255,jl=Zp*ua;function nb(r,e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B,G){let X=function(pe,ce,ue,ge,ve,Ne,Ee,Ue){let nt=[];if(ce.positionedLines.length===0)return nt;let qe=ge.layout.get("text-rotate").evaluate(Ne,{})*Math.PI/180,Ke=function(Be){let at=Be[0],et=Be[1],Lt=at*et;return Lt>0?[at,-et]:Lt<0?[-at,et]:at===0?[et,at]:[et,-at]}(ue),it=Math.abs(ce.top-ce.bottom);for(let Be of ce.positionedLines)it-=Be.lineOffset;let Fe=ce.positionedLines.length,Je=it/Fe,Ie=ce.top-ue[1];for(let Be=0;Be<Fe;++Be){let at=ce.positionedLines[Be];Ie=CA(ce,Je,Ie,Be);for(let et of at.positionedGlyphs){if(!et.rect)continue;let Lt=et.rect||{},St=C1+1,Xe=!0,tt=1,It=0;if(et.image){let Et=Ee.get(et.image.toString());if(!Et)continue;if(Et.sdf){pi("SDF images are not supported in formatted text and will be ignored.");continue}Xe=!1,tt=Et.pixelRatio,St=sh/tt}let xt=(ve||Ue)&&et.vertical,ut=et.metrics.advance*et.scale/2,vt=et.metrics,Vt=et.rect;if(Vt===null)continue;Ue&&ce.verticalizable&&(It=et.image?ut-et.metrics.width*et.scale/2:0);let Zt=ve?[et.x+ut,et.y]:[0,0],Qt=[0,0],Kt=[0,0],fi=!1;ve||(xt?(Kt=[et.x+ut+Ke[0],et.y+Ke[1]-It],fi=!0):Qt=[et.x+ut+ue[0],et.y+ue[1]-It]);let oi=Vt.w*et.scale/(tt*(et.localGlyph?zs:1)),ir=Vt.h*et.scale/(tt*(et.localGlyph?zs:1)),ee,te,Oe,lt;if(xt){let Et=et.y-Ie,qt=new Qe(-ut,ut-Et),ci=-Math.PI/2,hi=new Qe(...Kt);ee=new Qe(-ut+Qt[0],Qt[1]),ee._rotateAround(ci,qt)._add(hi),ee.x+=-Et+ut,ee.y-=(vt.left-St)*et.scale;let ii=et.image?vt.advance*et.scale:dn*et.scale,Gi=String.fromCodePoint(et.glyph);hA(Gi)?ee.x+=(1-St)*et.scale:uA(Gi)?ee.x+=ii-vt.height*et.scale+(-St-1)*et.scale:ee.x+=et.image||vt.width+2*St===Vt.w&&vt.height+2*St===Vt.h?(ii-ir)/2:(ii-(vt.height+2*St)*et.scale)/2,te=new Qe(ee.x,ee.y-oi),Oe=new Qe(ee.x+ir,ee.y),lt=new Qe(ee.x+ir,ee.y-oi)}else{let Et=(vt.left-St)*et.scale-ut+Qt[0],qt=(-vt.top-St)*et.scale+Qt[1],ci=Et+oi,hi=qt+ir;ee=new Qe(Et,qt),te=new Qe(ci,qt),Oe=new Qe(Et,hi),lt=new Qe(ci,hi)}if(qe){let Et;Et=ve?new Qe(0,0):fi?new Qe(Ke[0],Ke[1]):new Qe(ue[0],ue[1]),ee._rotateAround(qe,Et),te._rotateAround(qe,Et),Oe._rotateAround(qe,Et),lt._rotateAround(qe,Et)}let pt=new Qe(0,0),dt=new Qe(0,0);nt.push({tl:ee,tr:te,bl:Oe,br:lt,texPrimary:Lt,texSecondary:void 0,writingMode:ce.writingMode,glyphOffset:Zt,sectionIndex:et.sectionIndex,isSDF:Xe,pixelOffsetTL:pt,pixelOffsetBR:dt,minFontScaleX:0,minFontScaleY:0})}}return nt}(0,s,g,h,u,f,a,r.allowVerticalPlacement),W=r.textSizeData,K=null;W.kind==="source"?(K=[ua*h.layout.get("text-size").evaluate(f,{},B)*L.textScaleFactor],K[0]>jl&&pi(`${r.layerIds[0]}: Value for "text-size" is >= ${Zp}. Reduce your "text-size".`)):W.kind==="composite"&&(K=[ua*L.compositeTextSizes[0].evaluate(f,{},B)*L.textScaleFactor,ua*L.compositeTextSizes[1].evaluate(f,{},B)*L.textScaleFactor],(K[0]>jl||K[1]>jl)&&pi(`${r.layerIds[0]}: Value for "text-size" is >= ${Zp}. Reduce your "text-size".`)),r.addSymbols(r.text,X,K,g,u,f,w,e,i,y.lineStartIndex,y.lineLength,R,k,B,G,!1);for(let pe of E)I[pe]=r.text.placedSymbolArray.length-1;return 4*X.length}function Fy(r){for(let e in r)return r[e];return null}function l_(r,e,i,s,a,h,u,f,g,y){let w=u.top,E=u.bottom,I=u.left,R=u.right;if(O1(u)&&u.collisionPadding){let L=u.collisionPadding;I-=L[0],w-=L[1],R+=L[2],E+=L[3]}if(g){let L=new Qe(I,w),k=new Qe(R,w),B=new Qe(I,E),G=new Qe(R,E),X=Ai(g),W=new Qe(0,0);y&&(W=new Qe(y[0],y[1])),L._rotateAround(X,W),k._rotateAround(X,W),B._rotateAround(X,W),G._rotateAround(X,W),I=Math.min(L.x,k.x,B.x,G.x),R=Math.max(L.x,k.x,B.x,G.x),w=Math.min(L.y,k.y,B.y,G.y),E=Math.max(L.y,k.y,B.y,G.y)}return r.emplaceBack(e.x,e.y,e.z,i.x,i.y,I,w,R,E,f,s,a,h),r.length-1}function By(r){O1(r)&&r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);let e=r.bottom-r.top;return e>0?Math.max(10,e):null}function BA(r,e,i,s){let a=r.compareText;if(e in a){let h=a[e];for(let u=h.length-1;u>=0;u--)if(s.dist(h[u])<i)return!0}else a[e]=[];return a[e].push(s),!1}function ob(r,e){let i=r.fovAboveCenter,s=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,a=(r._camera.position[2]*r.worldSize-s)/Math.cos(r._pitch),h=Math.sin(i)*a/Math.sin(Math.max(Math.PI/2-r._pitch-i,.01)),u=Math.sin(r._pitch)*h+a,f=a*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let g=Math.max(r.zoom-17,0);r.isOrthographic&&(g/=10),u*=1+g}return Math.min(1.01*u,f)}function Wp(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};let i=Math.pow(2,-r.z),s=r.x*i,a=(r.x+1)*i,h=r.y*i,u=(r.y+1)*i,f=Z(s),g=Z(a),y=Y(h),w=Y(u),E=e.project(f,y),I=e.project(g,y),R=e.project(g,w),L=e.project(f,w),k=Math.min(E.x,I.x,R.x,L.x),B=Math.min(E.y,I.y,R.y,L.y),G=Math.max(E.x,I.x,R.x,L.x),X=Math.max(E.y,I.y,R.y,L.y),W=i/16;function K(ce,ue,ge,ve,Ne,Ee){let Ue=(ge+Ne)/2,nt=(ve+Ee)/2,qe=e.project(Z(Ue),Y(nt)),Ke=Math.max(0,k-qe.x,B-qe.y,qe.x-G,qe.y-X);k=Math.min(k,qe.x),G=Math.max(G,qe.x),B=Math.min(B,qe.y),X=Math.max(X,qe.y),Ke>W&&(K(ce,qe,ge,ve,Ue,nt),K(qe,ue,Ue,nt,Ne,Ee))}K(E,I,s,h,a,h),K(I,R,a,h,a,u),K(R,L,a,u,s,u),K(L,E,s,u,s,h),k-=W,B-=W,G+=W,X+=W;let pe=1/Math.max(G-k,X-B);return{scale:pe,x:k*pe,y:B*pe,x2:G*pe,y2:X*pe,projection:e}}function sb(r,{x:e,y:i},s=0){return new Qe(((e-s)*r.scale-r.x)*ht,(i*r.scale-r.y)*ht)}let NA=xe(new Float32Array(16));class Gl{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new C(0,0)}projectTilePoint(e,i,s){return{x:e,y:i,z:0}}locationPoint(e,i,s,a=!0){return e._coordinatePoint(e.locationCoordinate(i,s),a)}pixelsPerMeter(e,i){return U(1,e)*i}pixelSpaceConversion(e,i,s){return 1}farthestPixelDistance(e){return ob(e,e.pixelsPerMeter)}pointCoordinate(e,i,s,a){let h=e.horizonLineFromTop(!1),u=new Qe(i,Math.max(h,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(u,a))}pointCoordinate3D(e,i,s){let a=new Qe(i,s);if(e.elevation)return e.elevation.pointCoordinate(a);{let h=this.pointCoordinate(e,a.x,a.y,0);return[h.x,h.y,h.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);let s=e.horizonLineFromTop();return i.y<s}createInversionMatrix(e,i){return NA}createTileMatrix(e,i,s){let a,h,u,f=s.canonical,g=xe(new Float64Array(16));if(this.isReprojectedInTileSpace){let y=Wp(f,this);a=1,h=y.x+s.wrap*y.scale,u=y.y,ft(g,g,[a/y.scale,a/y.scale,e.pixelsPerMeter/i])}else a=i/e.zoomScale(f.z),h=(f.x+Math.pow(2,f.z)*s.wrap)*a,u=f.y*a;return We(g,g,[h,u,0]),ft(g,g,[a/ht,a/ht,1]),g}upVector(e,i,s){return[0,0,1]}upVectorScale(e,i,s){return{metersToTile:1}}}class VA extends Gl{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];let[i,s]=this.parallels=e.parallels||[29.5,45.5],a=Math.sin(Ai(i));this.n=(a+Math.sin(Ai(s)))/2,this.c=1+a*(2*this.n-a),this.r0=Math.sqrt(this.c)/this.n}project(e,i){let{n:s,c:a,r0:h}=this,u=Ai(e-this.center[0]),f=Ai(i),g=Math.sqrt(a-2*s*Math.sin(f))/s;return{x:g*Math.sin(u*s),y:g*Math.cos(u*s)-h,z:0}}unproject(e,i){let{n:s,c:a,r0:h}=this,u=h+i,f=Math.atan2(e,Math.abs(u))*Math.sign(u);u*s<0&&(f-=Math.PI*Math.sign(e)*Math.sign(u));let g=Ai(this.center[0])*s;f=De(f,-Math.PI-g,Math.PI-g);let y=re(Re(f/s)+this.center[0],-180,180),w=Math.asin(re((a-(e*e+u*u)*s*s)/(2*s),-1,1)),E=re(Re(w),-ne,ne);return new C(y,E)}}let Xp=1.340264,Yp=-.081106,Kp=893e-6,Jp=.003796,c_=Math.sqrt(3)/2;class UA extends Gl{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;let s=Math.asin(c_*Math.sin(i)),a=s*s,h=a*a*a;return{x:.5*(e*Math.cos(s)/(c_*(Xp+3*Yp*a+h*(7*Kp+9*Jp*a)))/Math.PI+.5),y:1-.5*(s*(Xp+Yp*a+h*(Kp+Jp*a))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=s*s,h=a*a*a;for(let w,E,I,R=0;R<12&&(E=s*(Xp+Yp*a+h*(Kp+Jp*a))-i,I=Xp+3*Yp*a+h*(7*Kp+9*Jp*a),w=E/I,s=re(s-w,-Math.PI/3,Math.PI/3),a=s*s,h=a*a*a,!(Math.abs(w)<1e-12));++R);let u=c_*e*(Xp+3*Yp*a+h*(7*Kp+9*Jp*a))/Math.cos(s),f=Math.asin(Math.sin(s)/c_),g=re(180*u/Math.PI,-180,180),y=re(180*f/Math.PI,-ne,ne);return new C(g,y)}}class jA extends Gl{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){let s=360*(e-.5),a=re(360*(.5-i),-ne,ne);return new C(s,a)}}let Fu=Math.PI/2;function h_(r){return Math.tan((Fu+r)/2)}class GA extends Gl{constructor(e){super(e),this.center=e.center||[0,30];let[i,s]=this.parallels=e.parallels||[30,30],a=Ai(i),h=Ai(s);this.southernCenter=a+h<0,this.southernCenter&&(a=-a,h=-h);let u=Math.cos(a),f=h_(a);this.n=a===h?Math.sin(a):Math.log(u/Math.cos(h))/Math.log(h_(h)/f),this.f=u*Math.pow(h_(a),this.n)/this.n}project(e,i){i=Ai(i),this.southernCenter&&(i=-i),e=Ai(e-this.center[0]);let s=1e-6,{n:a,f:h}=this;h>0?i<-Fu+s&&(i=-Fu+s):i>Fu-s&&(i=Fu-s);let u=h/Math.pow(h_(i),a),f=u*Math.sin(a*e),g=h-u*Math.cos(a*e);return f=.5*(f/Math.PI+.5),g=.5*(g/Math.PI+.5),{x:f,y:this.southernCenter?g:1-g,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;let{n:s,f:a}=this,h=a-i,u=Math.sign(h),f=Math.sign(s)*Math.sqrt(e*e+h*h),g=Math.atan2(e,Math.abs(h))*u;h*s<0&&(g-=Math.PI*Math.sign(e)*u);let y=re(Re(g/s)+this.center[0],-180,180),w=re(Re(2*Math.atan(Math.pow(a/f,1/s))-Fu),-ne,ne);return new C(y,this.southernCenter?-w:w)}}class ab extends Gl{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:F(e),y:j(i),z:0}}unproject(e,i){let s=Z(e),a=Y(i);return new C(s,a)}}let lb=Ai(ne);class qA extends Gl{project(e,i){let s=(i=Ai(i))*i,a=s*s;return{x:.5*((e=Ai(e))*(.8707-.131979*s+a*(a*(.003971*s-.001529*a)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+s*(.015085+a*(.028874*s-.044475-.005916*a)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,a=25,h=0,u=s*s;do{u=s*s;let y=u*u;h=(s*(1.007226+u*(.015085+y*(.028874*u-.044475-.005916*y)))-i)/(1.007226+u*(.045255+y*(.259866*u-.311325-.005916*11*y))),s=re(s-h,-lb,lb)}while(Math.abs(h)>1e-6&&--a>0);u=s*s;let f=re(Re(e/(.8707+u*(u*(u*u*u*(.003971-.001529*u)-.013791)-.131979))),-180,180),g=Re(s);return new C(f,g)}}let cb=Ai(ne);class HA extends Gl{project(e,i){i=Ai(i),e=Ai(e);let s=Math.cos(i),a=2/Math.PI,h=Math.acos(s*Math.cos(e/2)),u=Math.sin(h)/h,f=.5*(e*a+2*s*Math.sin(e/2)/u)||0,g=.5*(i+Math.sin(i)/u)||0;return{x:.5*(f/Math.PI+.5),y:1-.5*(g/Math.PI+1),z:0}}unproject(e,i){let s=e=(2*e-.5)*Math.PI,a=i=(2*(1-i)-1)*Math.PI,h=25,u=1e-6,f=0,g=0;do{let y=Math.cos(a),w=Math.sin(a),E=2*w*y,I=w*w,R=y*y,L=Math.cos(s/2),k=Math.sin(s/2),B=2*L*k,G=k*k,X=1-R*L*L,W=X?1/X:0,K=X?Math.acos(y*L)*Math.sqrt(1/X):0,pe=.5*(2*K*y*k+2*s/Math.PI)-e,ce=.5*(K*w+a)-i,ue=.5*W*(R*G+K*y*L*I)+1/Math.PI,ge=W*(B*E/4-K*w*k),ve=.125*W*(E*k-K*w*R*B),Ne=.5*W*(I*L+K*G*y)+.5,Ee=ge*ve-Ne*ue;f=(ce*ge-pe*Ne)/Ee,g=(pe*ve-ce*ue)/Ee,s=re(s-f,-Math.PI,Math.PI),a=re(a-g,-cb,cb)}while((Math.abs(f)>u||Math.abs(g)>u)&&--h>0);return new C(Re(s),Re(a))}}class hb extends Gl{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Ai(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){let{scale:s,cosPhi:a}=this;return{x:Ai(e)*a*s+.5,y:-Math.sin(Ai(i))/a*s+.5,z:0}}unproject(e,i){let{scale:s,cosPhi:a}=this,h=-(i-.5)/s,u=re(Re((e-.5)/s)/a,-180,180),f=Math.asin(re(h*a,-1,1)),g=re(Re(f),-ne,ne);return new C(u,g)}}class $A extends ab{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,s){let a=Tp(e,i,s);return Lr(a,a,Nm(ca(s))),{x:a[0],y:a[1],z:a[2]}}locationPoint(e,i,s){let a=x(i.lat,i.lng),h=Oi([],a),u=s?e._centerAltitude+s:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;tn(a,a,h,U(1,0)*ht*u);let f=xe(new Float64Array(16));return Te(f,e.pixelMatrix,e.globeMatrix),Lr(a,a,f),new Qe(a[0],a[1])}pixelsPerMeter(e,i){return U(1,0)*i}pixelSpaceConversion(e,i,s){let a=U(1,e)*i,h=Bt(U(1,45)*i,a,s);return this.pixelsPerMeter(e,i)/h}createTileMatrix(e,i,s){let a=Zg(ca(s.canonical));return Te(new Float64Array(16),e.globeMatrix,a)}createInversionMatrix(e,i){let{center:s}=e,a=Nm(ca(i));return Pt(a,a,Ai(s.lng)),_t(a,a,Ai(s.lat)),ft(a,a,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(a)}pointCoordinate(e,i,s,a){return Ox(e,i,s,!0)||new le(0,0)}pointCoordinate3D(e,i,s){let a=this.pointCoordinate(e,i,s,0);return[a.x,a.y,a.z]}isPointAboveHorizon(e,i){return!Ox(e,i.x,i.y,!1)}farthestPixelDistance(e){let i=function(a,h){let u=a.cameraToCenterDistance,f=a._centerAltitude*h,g=a._camera,y=a._camera.forward(),w=vi([],Xi([],y,-u),[0,0,f]),E=a.worldSize/(2*Math.PI),I=[0,0,-E],R=a.width/a.height,L=Math.tan(a.fovAboveCenter),k=Xi([],g.up(),L),B=Xi([],g.right(),L*R),G=Oi([],vi([],vi([],y,k),B)),X=[],W;if(new Si(w,G).closestPointOnSphere(I,E,X)){let K=vi([],X,I),pe=zr([],K,w);W=Math.cos(a.fovAboveCenter)*Ni(pe)}else{let K=zr([],w,I),pe=zr([],I,w);Oi(pe,pe);let ce=Ni(K)-E;W=Math.sqrt(ce*(ce+2*E));let ue=Math.acos(W/(E+ce))-Math.acos(or(y,pe));W*=Math.cos(ue)}return 1.01*W}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Fl(e.zoom);if(s>0){let a=ob(e,U(1,e.center.lat)*e.worldSize),h=e.worldSize/(2*Math.PI),u=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Bt(i,a+h*(1-Math.cos(u)),Math.pow(s,10))}return i}upVector(e,i,s){return Tp(i,s,e,1)}upVectorScale(e){return{metersToTile:km(Bm(ca(e)))}}}function ub(r){let e=r.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new ab(r);case"equirectangular":return new jA(r);case"naturalEarth":return new qA(r);case"equalEarth":return new UA(r);case"winkelTripel":return new HA(r);case"albers":return i?new hb(r):new VA(r);case"lambertConformalConic":return i?new hb(r):new GA(r);case"globe":return new $A(r)}throw new Error(`Invalid projection name: ${r.name}`)}let ZA=Pe.types,WA=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function u_(r,e,i,s,a,h,u,f,g,y,w,E,I){let R=f?Math.min(jl,Math.round(f[0])):0,L=f?Math.min(jl,Math.round(f[1])):0;r.emplaceBack(e,i,Math.round(32*s),Math.round(32*a),h,u,(R<<1)+(g?1:0),L,16*y,16*w,256*E,256*I)}function d_(r,e,i){r.emplaceBack(e,i)}function p_(r,e,i,s,a,h,u){r.emplaceBack(e,i,s,a,h,u)}let f_=(r,e,i,s)=>{for(let a=0;a<e;a++)r.emplaceBack(i[0],i[1],i[2],s[0],s[1],s[2])};function m_(r,e,i,s,a){r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a),r.emplaceBack(e,i,s,a)}function XA(r){for(let e of r.sections)if(Lg(e.text))return!0;return!1}class Ny{constructor(e){this.layoutVertexArray=new yu,this.indexArray=new ur,this.programConfigurations=e,this.segments=new gr,this.dynamicLayoutVertexArray=new sa,this.opacityVertexArray=new sp,this.placedSymbolArray=new Wc,this.iconTransitioningVertexArray=new cs,this.globeExtVertexArray=new Ml,this.zOffsetVertexArray=new Fa,this.orientationVertexArray=new cp}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,s,a,h){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,eA.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,iA.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,WA,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,oA.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,tA.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||h)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,rA.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,nA.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Tt(Ny,"SymbolBuffers");class Vy{constructor(e,i,s){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new s,this.segments=new gr,this.collisionVertexArray=new Pl,this.collisionVertexArrayExt=new sa}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,sA.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,aA.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Tt(Vy,"CollisionBuffers");class __{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(u=>u.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=xe([]),this.placementViewportMatrix=xe([]);let i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=V1(this.zoom,i["text-size"],this.worldview),this.iconSizeData=V1(this.zoom,i["icon-size"],this.worldview);let s=this.layers[0].layout,a=s.get("symbol-sort-key"),h=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=h!=="viewport-y"&&a.constantOr(1)!==void 0,this.sortFeaturesByY=(h==="viewport-y"||h==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(u=>Io[u]),this.stateDependentLayerIds=this.layers.filter(u=>u.isStateDependent()).map(u=>u.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1}createArrays(){this.text=new Ny(new vo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new Ny(new vo(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new gp,this.lineVertexArray=new Sm,this.symbolInstances=new Tm}calculateGlyphDependencies(e,i,s,a,h){for(let u of e){let f=u.codePointAt(0);if(f===void 0)break;if(i[f]=!0,a&&h&&f<=65535){let g=jp[u];g&&(i[g.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;let s=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Hm(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}populate(e,i,s,a){let h=this.layers[0],u=h.layout,f=this.projection.name==="globe",g=u.get("text-font"),y=u.get("text-field"),w=u.get("icon-image"),[E,I]=u.get("icon-size-scale-range"),R=re(i.scaleFactor||1,E,I),L=(y.value.kind!=="constant"||y.value.value instanceof Ln&&!y.value.value.isEmpty()||y.value.value.toString().length>0)&&(g.value.kind!=="constant"||g.value.value.length>0),k=w.value.kind!=="constant"||!!w.value.value||Object.keys(w.parameters).length>0,B=u.get("symbol-sort-key");if(this.features=[],!L&&!k)return;let G=i.iconDependencies,X=i.glyphDependencies,W=i.availableImages,K=new ji(this.zoom,{worldview:this.worldview});for(let{feature:pe,id:ce,index:ue,sourceLayerIndex:ge}of e){let ve=h._featureFilter.needGeometry,Ne=ke(pe,ve);if(!h._featureFilter.filter(K,Ne,s))continue;if(ve||(Ne.geometry=me(pe,s,a)),f&&pe.type!==1&&s.z<=5){let Ke=Ne.geometry,it=.98078528056,Fe=(Je,Ie)=>or(Tp(Je.x,Je.y,s,1),Tp(Ie.x,Ie.y,s,1))<it;for(let Je=0;Je<Ke.length;Je++)Ke[Je]=ze(Ke[Je],Fe)}let Ee,Ue;if(L){let Ke=h.getValueAndResolveTokens("text-field",Ne,s,W),it=Ln.factory(Ke);XA(it)&&(this.hasRTLText=!0),(!this.hasRTLText||Qd()==="unavailable"||this.hasRTLText&&as.isParsed())&&(Ee=cA(it,h,Ne))}if(k){let Ke=h.getValueAndResolveTokens("icon-image",Ne,s,W);Ue=typeof Ke=="string"?Gn.build(Ke):Ke}if(!Ee&&!Ue)continue;let nt=this.sortFeaturesByKey?B.evaluate(Ne,{},s):void 0,qe={id:ce,text:Ee,icon:Ue,index:ue,sourceLayerIndex:ge,geometry:Ne.geometry,properties:pe.properties,type:ZA[pe.type],sortKey:nt};if(this.features.push(qe),Ue){let Ke=this.layers[0]._unevaluatedLayout._values,{iconPrimary:it,iconSecondary:Fe}=tb(Ue,this.iconSizeData,Ke["icon-size"],s,this.zoom,qe,this.pixelRatio,R,this.worldview),Je=it.id.toString();if(G.has(Je)?G.get(Je).push(it):G.set(Je,[it]),Fe){this.hasAnySecondaryIcon=!0;let Ie=Fe.id.toString();G.has(Ie)?G.get(Ie).push(Fe):G.set(Ie,[Fe])}}if(Ee){let Ke=g.evaluate(Ne,{},s).join(","),it=u.get("text-rotation-alignment")==="map"&&u.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Io.vertical)>=0;for(let Fe of Ee.sections)if(Fe.image){let Je=Fe.image.getPrimary().scaleSelf(this.pixelRatio),Ie=Je.id.toString(),Be=G.get(Ie)||[];Be.push(Je),G.set(Ie,Be)}else{let Je=Xd(Ee.toString()),Ie=Fe.fontStack||Ke,Be=X[Ie]=X[Ie]||{};this.calculateGlyphDependencies(Fe.text,Be,it,this.allowVerticalPlacement,Je)}}}if(u.get("symbol-placement")==="line"&&(this.features=function(pe){let ce={},ue={},ge=[],ve=0;function Ne(qe){ge.push(pe[qe]),ve++}function Ee(qe,Ke,it){let Fe=ue[qe];return delete ue[qe],ue[Ke]=Fe,ge[Fe].geometry[0].pop(),ge[Fe].geometry[0]=ge[Fe].geometry[0].concat(it[0]),Fe}function Ue(qe,Ke,it){let Fe=ce[Ke];return delete ce[Ke],ce[qe]=Fe,ge[Fe].geometry[0].shift(),ge[Fe].geometry[0]=it[0].concat(ge[Fe].geometry[0]),Fe}function nt(qe,Ke,it){let Fe=it?Ke[0][Ke[0].length-1]:Ke[0][0];return`${qe}:${Fe.x}:${Fe.y}`}for(let qe=0;qe<pe.length;qe++){let Ke=pe[qe],it=Ke.geometry,Fe=Ke.text?Ke.text.toString():null;if(!Fe){Ne(qe);continue}let Je=nt(Fe,it),Ie=nt(Fe,it,!0);if(Je in ue&&Ie in ce&&ue[Je]!==ce[Ie]){let Be=Ue(Je,Ie,it),at=Ee(Je,Ie,ge[Be].geometry);delete ce[Je],delete ue[Ie],ue[nt(Fe,ge[at].geometry,!0)]=at,ge[Be].geometry=null}else Je in ue?Ee(Je,Ie,it):Ie in ce?Ue(Je,Ie,it):(Ne(qe),ce[Je]=ve-1,ue[Ie]=ve-1)}return ge.filter(qe=>qe.geometry)}(this.features)),u.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(let pe of i.elevationFeatures)this.elevationFeatureIdToIndex.set(pe.id,this.elevationFeatures.length),this.elevationFeatures.push(pe)}}else u.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((pe,ce)=>pe.sortKey-ce.sortKey)}update(e,i,s,a,h,u,f){this.text.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,h,s,a,u,f,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1,s=se(e),a=1/s,h=!1,u=!1;for(let f=0;f<this.symbolInstances.length;f++){let g=this.symbolInstances.get(f),y=yi(1,0,0),w=yi(0,1,0),{numHorizontalGlyphVertices:E,numVerticalGlyphVertices:I,numIconVertices:R,numVerticalIconVertices:L}=g,k=E>0||I>0,B=R>0,G=this.elevationFeatures[g.elevationFeatureIndex];if(G){let X=new Qe(g.tileAnchorX,g.tileAnchorY),W=.075+G.pointElevation(X);g.zOffset!==W&&(i=!0,g.zOffset=W);let K=G.computeSlopeNormal(X,a),pe=Ka(vs(),yi(0,0,1),K);Fs(y,y,pe),Fs(w,w,pe),y[2]*=s,w[2]*=s,y[0]===1&&y[1]===0&&y[2]===0&&w[0]===0&&w[1]===1&&w[2]===0||(h=h||k,u=u||B)}if(k&&(f_(this.text.orientationVertexArray,E,y,w),f_(this.text.orientationVertexArray,I,y,w)),B){let{placedIconSymbolIndex:X,verticalPlacedIconSymbolIndex:W}=g;X>=0&&f_(this.icon.orientationVertexArray,R,y,w),W>=0&&f_(this.icon.orientationVertexArray,L,y,w)}}h||(this.text.orientationVertexArray=void 0),u||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){let e=(h,u,f)=>{s+=u,s>h.length&&h.resize(s);for(let g=-u;g<0;g++)h.emplace(g+s,f)},i=(h,u,f)=>{a+=u,a>h.length&&h.resize(a);for(let g=-u;g<0;g++)h.emplace(g+a,f)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,a=0;for(let h=0;h<this.symbolInstances.length;h++){let u=this.symbolInstances.get(h),{numHorizontalGlyphVertices:f,numVerticalGlyphVertices:g,numIconVertices:y}=u,w=u.zOffset,E=y>0;if((f>0||g>0)&&(e(this.text.zOffsetVertexArray,f,w),e(this.text.zOffsetVertexArray,g,w)),E){let{placedIconSymbolIndex:I,verticalPlacedIconSymbolIndex:R}=u;I>=0&&i(this.icon.zOffsetVertexArray,y,w),R>=0&&i(this.icon.zOffsetVertexArray,u.numVerticalIconVertices,w)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=ub(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){let s=this.lineVertexArray.length;if(e.segment!==void 0)for(let{x:a,y:h}of i)this.lineVertexArray.emplaceBack(a,h);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,i,s,a,h,u,f,g,y,w,E,I,R,L,k,B){let G=e.indexArray,X=e.layoutVertexArray,W=e.globeExtVertexArray,K=e.segments.prepareSegment(4*i.length,X,G,this.canOverlap?u.sortKey:void 0),pe=this.glyphOffsetArray.length,ce=K.vertexLength,ue=this.allowVerticalPlacement&&f===Io.vertical?Math.PI/2:0,ge=u.text&&u.text.sections;for(let Ne=0;Ne<i.length;Ne++){let{tl:Ee,tr:Ue,bl:nt,br:qe,texPrimary:Ke,texSecondary:it,pixelOffsetTL:Fe,pixelOffsetBR:Je,minFontScaleX:Ie,minFontScaleY:Be,glyphOffset:at,isSDF:et,sectionIndex:Lt}=i[Ne],St=K.vertexLength,Xe=at[1];if(u_(X,y.x,y.y,Ee.x,Xe+Ee.y,Ke.x,Ke.y,s,et,Fe.x,Fe.y,Ie,Be),u_(X,y.x,y.y,Ue.x,Xe+Ue.y,Ke.x+Ke.w,Ke.y,s,et,Je.x,Fe.y,Ie,Be),u_(X,y.x,y.y,nt.x,Xe+nt.y,Ke.x,Ke.y+Ke.h,s,et,Fe.x,Je.y,Ie,Be),u_(X,y.x,y.y,qe.x,Xe+qe.y,Ke.x+Ke.w,Ke.y+Ke.h,s,et,Je.x,Je.y,Ie,Be),g){let{x:tt,y:It,z:xt}=g.anchor,[ut,vt,Vt]=g.up;p_(W,tt,It,xt,ut,vt,Vt),p_(W,tt,It,xt,ut,vt,Vt),p_(W,tt,It,xt,ut,vt,Vt),p_(W,tt,It,xt,ut,vt,Vt),m_(e.dynamicLayoutVertexArray,tt,It,xt,ue)}else m_(e.dynamicLayoutVertexArray,y.x,y.y,y.z,ue);if(B){let tt=it||Ke;d_(e.iconTransitioningVertexArray,tt.x,tt.y),d_(e.iconTransitioningVertexArray,tt.x+tt.w,tt.y),d_(e.iconTransitioningVertexArray,tt.x,tt.y+tt.h),d_(e.iconTransitioningVertexArray,tt.x+tt.w,tt.y+tt.h)}G.emplaceBack(St,St+1,St+2),G.emplaceBack(St+1,St+2,St+3),K.vertexLength+=4,K.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(at[0]),Ne!==i.length-1&&Lt===i[Ne+1].sectionIndex||e.programConfigurations.populatePaintArrays(X.length,u,u.index,{},R,L,k,ge&&ge[Lt],this.worldview)}let ve=g?g.anchor:y;e.placedSymbolArray.emplaceBack(ve.x,ve.y,ve.z,y.x,y.y,pe,this.glyphOffsetArray.length-pe,ce,w,E,y.segment,s?s[0]:0,s?s[1]:0,a[0],a[1],f,0,0,0,I,0)}_commitLayoutVertex(e,i,s,a,h,u,f){e.emplaceBack(i,s,a,h,u,Math.round(f.x),Math.round(f.y))}_addCollisionDebugVertices(e,i,s,a,h,u,f){let g=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),y=g.vertexLength,w=f.tileAnchorX,E=f.tileAnchorY;for(let R=0;R<4;R++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,i,e.padding,f.zOffset),this._commitLayoutVertex(s.layoutVertexArray,a,h,u,w,E,new Qe(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,h,u,w,E,new Qe(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,a,h,u,w,E,new Qe(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,a,h,u,w,E,new Qe(e.x1,e.y2)),g.vertexLength+=4;let I=s.indexArray;I.emplaceBack(y,y+1),I.emplaceBack(y+1,y+2),I.emplaceBack(y+2,y+3),I.emplaceBack(y+3,y),g.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,s,a,h,u){for(let f=a;f<h;f++){let g=s.get(f),y=this.getSymbolInstanceTextSize(e,u,i,f);this._addCollisionDebugVertices(g,y,this.textCollisionBox,g.projectedAnchorX,g.projectedAnchorY,g.projectedAnchorZ,u)}}_addIconDebugCollisionBoxes(e,i,s,a,h,u){for(let f=a;f<h;f++){let g=s.get(f),y=this.getSymbolInstanceIconSize(e,i,u.placedIconSymbolIndex);this._addCollisionDebugVertices(g,y,this.iconCollisionBox,g.projectedAnchorX,g.projectedAnchorY,g.projectedAnchorZ,u)}}generateCollisionDebugBuffers(e,i,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Vy(xu,E1.members,cs),this.iconCollisionBox=new Vy(xu,E1.members,cs);let a=qp(this.iconSizeData,e),h=qp(this.textSizeData,e,s);for(let u=0;u<this.symbolInstances.length;u++){let f=this.symbolInstances.get(u);this._addTextDebugCollisionBoxes(h,e,i,f.textBoxStartIndex,f.textBoxEndIndex,f),this._addTextDebugCollisionBoxes(h,e,i,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.iconBoxStartIndex,f.iconBoxEndIndex,f),this._addIconDebugCollisionBoxes(a,e,i,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex,f)}}getSymbolInstanceTextSize(e,i,s,a){let h=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:a),u=Ly(this.textSizeData,e,h)/dn;return this.tilePixelRatio*u}getSymbolInstanceIconSize(e,i,s){let a=this.icon.placedSymbolArray.get(s),h=Ly(this.iconSizeData,e,a);return this.tilePixelRatio*h}_commitDebugCollisionVertexUpdate(e,i,s,a){e.emplaceBack(i,-s,-s,a),e.emplaceBack(i,s,-s,a),e.emplaceBack(i,s,s,a),e.emplaceBack(i,-s,s,a)}_updateTextDebugCollisionBoxes(e,i,s,a,h,u,f){for(let g=a;g<h;g++){let y=s.get(g),w=this.getSymbolInstanceTextSize(e,u,i,g);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,w,y.padding,u.zOffset)}}_updateIconDebugCollisionBoxes(e,i,s,a,h,u,f){for(let g=a;g<h;g++){let y=s.get(g),w=this.getSymbolInstanceIconSize(e,i,u.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,w,y.padding,u.zOffset)}}updateCollisionDebugBuffers(e,i,s,a){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let h=qp(this.iconSizeData,e,a),u=qp(this.textSizeData,e,s);for(let f=0;f<this.symbolInstances.length;f++){let g=this.symbolInstances.get(f);this._updateTextDebugCollisionBoxes(u,e,i,g.textBoxStartIndex,g.textBoxEndIndex,g,s),this._updateTextDebugCollisionBoxes(u,e,i,g.verticalTextBoxStartIndex,g.verticalTextBoxEndIndex,g,s),this._updateIconDebugCollisionBoxes(h,e,i,g.iconBoxStartIndex,g.iconBoxEndIndex,g,a),this._updateIconDebugCollisionBoxes(h,e,i,g.verticalIconBoxStartIndex,g.verticalIconBoxEndIndex,g,a)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,s,a,h,u,f,g,y){let w={};if(i<s){let{x1:E,y1:I,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K,featureIndex:pe}=e.get(i);w.textBox={x1:E,y1:I,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K},w.textFeatureIndex=pe}if(a<h){let{x1:E,y1:I,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K,featureIndex:pe}=e.get(a);w.verticalTextBox={x1:E,y1:I,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K},w.verticalTextFeatureIndex=pe}if(u<f){let{x1:E,y1:I,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K,featureIndex:pe}=e.get(u);w.iconBox={x1:E,y1:I,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K},w.iconFeatureIndex=pe}if(g<y){let{x1:E,y1:I,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K,featureIndex:pe}=e.get(g);w.verticalIconBox={x1:E,y1:I,x2:R,y2:L,padding:k,projectedAnchorX:B,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:W,tileAnchorY:K},w.verticalIconFeatureIndex=pe}return w}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){let s=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){let s=e.placedSymbolArray.get(i),a=s.vertexStartIndex+4*s.numGlyphs;for(let h=s.vertexStartIndex;h<a;h+=4)e.indexArray.emplaceBack(h,h+1,h+2),e.indexArray.emplaceBack(h+1,h+2,h+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let i=Math.sin(e),s=Math.cos(e),a=[],h=[],u=[];for(let f=0;f<this.symbolInstances.length;++f){u.push(f);let g=this.symbolInstances.get(f);a.push(0|Math.round(i*g.tileAnchorX+s*g.tileAnchorY)),h.push(g.featureIndex)}return u.sort((f,g)=>a[f]-a[g]||h[g]-h[f]),u}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){let s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===i?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let i of this.symbolInstanceIndexes){let s=this.symbolInstances.get(i);this.featureSortOrder.push(s.featureIndex);let{rightJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:h,leftJustifiedTextSymbolIndex:u,verticalPlacedTextSymbolIndex:f,placedIconSymbolIndex:g,verticalPlacedIconSymbolIndex:y}=s;a>=0&&this.addIndicesForPlacedSymbol(this.text,a),h>=0&&h!==a&&this.addIndicesForPlacedSymbol(this.text,h),u>=0&&u!==h&&u!==a&&this.addIndicesForPlacedSymbol(this.text,u),f>=0&&this.addIndicesForPlacedSymbol(this.text,f),g>=0&&this.addIndicesForPlacedSymbol(this.icon,g),y>=0&&this.addIndicesForPlacedSymbol(this.icon,y)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let db,pb,Uy;Tt(__,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),__.addDynamicAttributes=m_;class fb{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:sl,this.defaultValue=e}evaluate(e){if(e.formattedSection){let i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Tt(fb,"FormatSectionOverride",{omit:["defaultValue"]});let jy=()=>Uy||(Uy={layout:db||(db=new Ar({"symbol-placement":new ot(Se.layout_symbol["symbol-placement"]),"symbol-spacing":new ot(Se.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ot(Se.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new gt(Se.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ot(Se.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ot(Se.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new ot(Se.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new ot(Se.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ot(Se.layout_symbol["icon-ignore-placement"]),"icon-optional":new ot(Se.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ot(Se.layout_symbol["icon-rotation-alignment"]),"icon-size":new gt(Se.layout_symbol["icon-size"]),"icon-size-scale-range":new ot(Se.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new gt(Se.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new gt(Se.layout_symbol["icon-text-fit-padding"]),"icon-image":new gt(Se.layout_symbol["icon-image"]),"icon-rotate":new gt(Se.layout_symbol["icon-rotate"]),"icon-padding":new ot(Se.layout_symbol["icon-padding"]),"icon-keep-upright":new ot(Se.layout_symbol["icon-keep-upright"]),"icon-offset":new gt(Se.layout_symbol["icon-offset"]),"icon-anchor":new gt(Se.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ot(Se.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ot(Se.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ot(Se.layout_symbol["text-rotation-alignment"]),"text-field":new gt(Se.layout_symbol["text-field"]),"text-font":new gt(Se.layout_symbol["text-font"]),"text-size":new gt(Se.layout_symbol["text-size"]),"text-size-scale-range":new ot(Se.layout_symbol["text-size-scale-range"]),"text-max-width":new gt(Se.layout_symbol["text-max-width"]),"text-line-height":new gt(Se.layout_symbol["text-line-height"]),"text-letter-spacing":new gt(Se.layout_symbol["text-letter-spacing"]),"text-justify":new gt(Se.layout_symbol["text-justify"]),"text-radial-offset":new gt(Se.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ot(Se.layout_symbol["text-variable-anchor"]),"text-anchor":new gt(Se.layout_symbol["text-anchor"]),"text-max-angle":new ot(Se.layout_symbol["text-max-angle"]),"text-writing-mode":new ot(Se.layout_symbol["text-writing-mode"]),"text-rotate":new gt(Se.layout_symbol["text-rotate"]),"text-padding":new ot(Se.layout_symbol["text-padding"]),"text-keep-upright":new ot(Se.layout_symbol["text-keep-upright"]),"text-transform":new gt(Se.layout_symbol["text-transform"]),"text-offset":new gt(Se.layout_symbol["text-offset"]),"text-allow-overlap":new ot(Se.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ot(Se.layout_symbol["text-ignore-placement"]),"text-optional":new ot(Se.layout_symbol["text-optional"]),visibility:new ot(Se.layout_symbol.visibility)})),paint:pb||(pb=new Ar({"icon-opacity":new gt(Se.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new gt(Se.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new gt(Se.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new gt(Se.paint_symbol["text-emissive-strength"]),"icon-color":new gt(Se.paint_symbol["icon-color"]),"icon-halo-color":new gt(Se.paint_symbol["icon-halo-color"]),"icon-halo-width":new gt(Se.paint_symbol["icon-halo-width"]),"icon-halo-blur":new gt(Se.paint_symbol["icon-halo-blur"]),"icon-translate":new ot(Se.paint_symbol["icon-translate"]),"icon-translate-anchor":new ot(Se.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new ot(Se.paint_symbol["icon-image-cross-fade"]),"text-opacity":new gt(Se.paint_symbol["text-opacity"]),"text-occlusion-opacity":new gt(Se.paint_symbol["text-occlusion-opacity"]),"text-color":new gt(Se.paint_symbol["text-color"],{runtimeType:Jn,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new gt(Se.paint_symbol["text-halo-color"]),"text-halo-width":new gt(Se.paint_symbol["text-halo-width"]),"text-halo-blur":new gt(Se.paint_symbol["text-halo-blur"]),"text-translate":new ot(Se.paint_symbol["text-translate"]),"text-translate-anchor":new ot(Se.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new ot(Se.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new ot(Se.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new ot(Se.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new ot(Se.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new gt(Se.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},Uy);class g_ extends Mn{constructor(e,i,s,a){super(e,jy(),i,s,a),this._colorAdjustmentMatrix=xe([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let s=this.layout.get("text-writing-mode");if(s){let a=[];for(let h of s)a.indexOf(h)<0&&a.push(h);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,s,a){return this._saturation===e&&this._contrast===i&&this._brightnessMin===s&&this._brightnessMax===a||(this._colorAdjustmentMatrix=function(h,u,f,g){h=En(h),u=Un(u);let y=Ae(),w=h/3,E=1-2*w,I=[E,w,w,0,w,E,w,0,w,w,E,0,0,0,0,1],R=.5-.5*u,L=g-f;return Te(y,[L,0,0,0,0,L,0,0,0,0,L,0,f,f,f,1],[u,0,0,0,0,u,0,0,0,0,u,0,R,R,R,1]),Te(y,y,I),y}(e,i,s,a),this._saturation=e,this._contrast=i,this._brightnessMin=s,this._brightnessMax=a),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,s,a){let h=this.layout.get(e).evaluate(i,{},s,a),u=this._unevaluatedLayout._values[e];return u.isDataDriven()||Hd(u.value)||!h?h:function(f,g){return g.replace(/{([^{}]+)}/g,(y,w)=>w in f?String(f[w]):"")}(i.properties,h)}createBucket(e){return new __(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let e of jy().paint.overridableProperties){if(!g_.hasPaintOverride(this.layout,e))continue;let i=this.paint.get(e),s=new fb(i),a=new qd(s,i.property.specification,this.scope,this.options),h=null;h=i.value.kind==="constant"||i.value.kind==="source"?new su("source",a):new ta("composite",a,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new ka(i.property,h,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,s){return!(!this.layout||i.isDataDriven()||s.isDataDriven())&&g_.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){let s=e.get("text-field"),a=jy().paint.properties[i],h=!1,u=f=>{for(let g of f)if(a.overrides&&a.overrides.hasOverride(g))return void(h=!0)};if(s.value.kind==="constant"&&s.value.value instanceof Ln)u(s.value.value.sections);else if(s.value.kind==="source"){let f=y=>{h||(y instanceof Gt&&bt(y.value)===Ec?u(y.value.sections):y instanceof ll?u(y.sections):y.eachChild(f))},g=s.value;g._styleExpression&&f(g._styleExpression.expression)}return h}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,s){return{config:new On(this,{zoom:i,lut:s}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let mb,_b,gb,yb;var Gy=gi([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function y_(r,e,i,s,a,h,u,f){let g=[r,e,1,i,s,1,a,h,1],y=[u,f,1],w=ae([],g),[E,I,R]=ks(y,y,w);return we(g,g,[E,0,0,0,I,0,0,0,R])}function xb(r,e,i,s,a,h,u,f){let g=function(y,w,E,I,R,L,k,B){let G=y_(0,0,1,0,1,1,0,1),X=y_(y,w,E,I,R,L,k,B);return we(X,X,ae([],G))}(r,e,i,s,a,h,u,f);return[g[2]/g[8]/ht,g[5]/g[8]/ht]}function x_(r){return[r[0],Math.min(Math.max(r[1],-ne),ne)]}class vb extends Ea{constructor(e,i,s,a){super(),this.id=e,this.dispatcher=s,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(a),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new As("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=bc(this.map._requestManager.transformRequest(this.url,yc.Image),(s,a)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new mo(s)):a&&(this.image=a instanceof HTMLImageElement?Wo.getImageData(a):a,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Np(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new As("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Np||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],s=e[0][1];for(let h of e)h[1]>s&&(s=h[1]),h[1]<i&&(i=h[1]);let a=(s+i)/2;if(a>ne?this.onNorthPole=!0:a<-ne&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let h=e.map(le.fromLngLat);this.tileID=function(u){let f=1/0,g=1/0,y=-1/0,w=-1/0;for(let k of u)f=Math.min(f,k.x),g=Math.min(g,k.y),y=Math.max(y,k.x),w=Math.max(w,k.y);let E=Math.max(y-f,w-g),I=Math.max(0,Math.floor(-Math.log(E)/Math.LN2)),R=Math.pow(2,I),L=Math.floor((f+y)/2*R);return L>1&&(L-=1),new To(I,L,Math.floor((g+w)/2*R))}(h),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new As("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Np||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(let G in this.tiles){let X=this.tiles[G];X.state!=="loaded"&&(X.state="loaded",X.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let i=Wp(new To(0,0,0),this.map.transform.projection),s=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(G){let X=G[1].x-G[0].x,W=G[1].y-G[0].y,K=G[2].x-G[1].x,pe=G[2].y-G[1].y,ce=G[3].x-G[2].x,ue=G[3].y-G[2].y,ge=G[0].x-G[3].x,ve=G[0].y-G[3].y,Ne=X*pe-K*W,Ee=K*ue-ce*pe,Ue=ce*ve-ge*ue,nt=ge*W-X*ve;return Ne>0&&Ee>0&&Ue>0&&nt>0||Ne<0&&Ee<0&&Ue<0&&nt<0}(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let a=Wp(this.tileID,this.map.transform.projection),[h,u,f,g]=this.coordinates.map(G=>{let X=a.projection.project(G[0],G[1]);return sb(a,X)._round()});this.perspectiveTransform=xb(h.x,h.y,u.x,u.y,f.x,f.y,g.x,g.y);let y=this._boundsArray=new Il;y.emplaceBack(h.x,h.y,0,0),y.emplaceBack(u.x,u.y,ht,0),y.emplaceBack(g.x,g.y,0,ht),y.emplaceBack(f.x,f.y,ht,ht),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(y,Gy.members),this.boundsSegments=gr.simpleSegment(0,0,4,2);let w=[],E=[x_((I=this.coordinates)[0]),x_(I[1]),x_(I[2]),x_(I[3])];var I;let[R,L,k,B]=function(G){let X=G[0][0],W=X,K=G[0][1],pe=K;for(let ce=1;ce<G.length;ce++)G[ce][0]<X?X=G[ce][0]:G[ce][0]>W&&(W=G[ce][0]),G[ce][1]<K?K=G[ce][1]:G[ce][1]>pe&&(pe=G[ce][1]);return[X,K,W-X,pe-K]}(E);{let G=new Il,[X,W,K,pe]=function(Fe){let Je=Fe[0].x,Ie=Je,Be=Fe[0].y,at=Be;for(let et=1;et<Fe.length;et++)Fe[et].x<Je?Je=Fe[et].x:Fe[et].x>Ie&&(Ie=Fe[et].x),Fe[et].y<Be?Be=Fe[et].y:Fe[et].y>at&&(at=Fe[et].y);return[Je,Be,Ie-Je,at-Be]}(s),ce=Fe=>[(Fe.x-X)/K,(Fe.y-W)/pe],[ue,ge,ve,Ne]=s.map(ce),Ee=function(Fe,Je,Ie,Be,at,et,Lt,St){let Xe=y_(0,0,1,0,1,1,0,1);return we(Xe,Xe,ae([],y_(Fe,Je,Ie,Be,at,et,Lt,St)))}(ue[0],ue[1],ge[0],ge[1],ve[0],ve[1],Ne[0],Ne[1]);this.elevatedGlobePerspectiveTransform=xb(ue[0],ue[1],ge[0],ge[1],ve[0],ve[1],Ne[0],Ne[1]);let Ue=(Fe,Je)=>{w.push(Fe.lng);let Ie=Math.round((Fe.lng-R)/k*ht),Be=Math.round((Fe.lat-L)/B*ht),at=ce(Je),et=ks([],[at[0],at[1],1],Ee),Lt=Math.round(et[0]/et[2]*ht),St=Math.round(et[1]/et[2]*ht);G.emplaceBack(Ie,Be,Lt,St)},nt=s[3].x-s[0].x,qe=s[3].y-s[0].y,Ke=s[2].x-s[1].x,it=s[2].y-s[1].y;for(let Fe=0;Fe<65;Fe++){let Je=Fe/64,Ie=[s[0].x+Je*nt,s[0].y+Je*qe],Be=[s[1].x+Je*Ke,s[1].y+Je*it],at=Be[0]-Ie[0],et=Be[1]-Ie[1];for(let Lt=0;Lt<65;Lt++){let St=Lt/64,Xe={x:Ie[0]+at*St,y:Ie[1]+et*St};Ue(i.projection.unproject(Xe.x,Xe.y),Xe)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(G,Gy.members)}{this.maxLongitudeTriangleSize=0;let G=[],X=new ur,W=(K,pe,ce)=>{X.emplaceBack(K,pe,ce);let ue=w[K],ge=w[pe],ve=w[ce],Ne=Math.min(Math.min(ue,ge),ve),Ee=Math.max(Math.max(ue,ge),ve)-Ne;Ee>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Ee),G.push(Ne+Ee/2)};for(let K=0;K<64;K++)for(let pe=0;pe<64;pe++){let ce=65*K+pe,ue=ce+1,ge=ce+65,ve=ge+1;W(ce,ge,ue),W(ue,ge,ve)}[G,X]=function(K,pe){let ce=Array.from({length:K.length},(ve,Ne)=>Ne);ce.sort((ve,Ne)=>K[ve]-K[Ne]);let ue=[],ge=new ur;for(let ve=0;ve<ce.length;ve++){let Ne=ce[ve];ue.push(K[Ne]);let Ee=3*Ne,Ue=Ee+1;ge.emplaceBack(pe.uint16[Ee],pe.uint16[Ue],pe.uint16[Ue+1])}return[ue,ge]}(G,X),this.elevatedGlobeTrianglesCenterLongitudes=G,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(X)}this.elevatedGlobeSegments=gr.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,k/ht,0,B/ht,0,0,L,R,0])}prepare(){let e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;let i=this.map.painter.context,s=i.gl;!this._dirty||this.texture instanceof Np||(this.texture?this.texture.update(this.image):(this.texture=new yy(i,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){let i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;let s=this.elevatedGlobeTrianglesCenterLongitudes,a=(h=e+180)+360*Math.round((s[0]-h)/360);var h;let u=new gr,f=(E,I)=>{u.segments.push({vertexOffset:0,primitiveOffset:E,vertexLength:i.segments[0].vertexLength,primitiveLength:I,sortKey:void 0,vaos:{}})},g=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-a)<=g){let E=ln(s,0,s.length,a+g);return E===s.length||f(E,_r(s,E+1,s.length,a+360-g)-E),u}a<s[0]&&(a+=360);let y=_r(s,0,s.length,a-g);if(y===s.length)return f(0,s.length),u;f(0,y-0);let w=ln(s,y+1,s.length,a+g);return w!==s.length&&f(w,s.length-w),u}}let YA=(Math.pow(256,2)-1)/16907520;class bb extends Mn{constructor(e,i,s,a){super(e,{layout:gb||(gb=new Ar({visibility:new ot(Se.layout_raster.visibility)})),paint:yb||(yb=new Ar({"raster-opacity":new ot(Se.paint_raster["raster-opacity"]),"raster-color":new bl(Se.paint_raster["raster-color"]),"raster-color-mix":new ot(Se.paint_raster["raster-color-mix"]),"raster-color-range":new ot(Se.paint_raster["raster-color-range"]),"raster-hue-rotate":new ot(Se.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ot(Se.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ot(Se.paint_raster["raster-brightness-max"]),"raster-saturation":new ot(Se.paint_raster["raster-saturation"]),"raster-contrast":new ot(Se.paint_raster["raster-contrast"]),"raster-resampling":new ot(Se.paint_raster["raster-resampling"]),"raster-fade-duration":new ot(Se.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new ot(Se.paint_raster["raster-emissive-strength"]),"raster-array-band":new ot(Se.paint_raster["raster-array-band"]),"raster-elevation":new ot(Se.paint_raster["raster-elevation"]),"raster-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof vb&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;let i=this._transitionablePaint._values["raster-color"].value.expression,[s,a]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(a)||s===this._curRampRange[0]&&a===this._curRampRange[1]||(this.colorRamp=Sp({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:a}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,a])}}let wb,Tb,Sb,Eb,Ib;class Ab extends Mn{constructor(e,i,s,a){super(e,{layout:wb||(wb=new Ar({visibility:new ot(Se["layout_raster-particle"].visibility)})),paint:Tb||(Tb=new Ar({"raster-particle-array-band":new ot(Se["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new ot(Se["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new bl(Se["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new ot(Se["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new ot(Se["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new ot(Se["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new ot(Se["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new ot(Se["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},i,s,a),this._updateColorRamp(),this.lastInvalidatedAt=Wo.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Sp({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Wo.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class KA extends Mn{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function qy(r,e,i){let s=[0,0,1],a=bs([]);return Ya(a,a,i?-Ai(r)+Math.PI:Ai(r)),xa(a,a,-Ai(e)),Fs(s,s,a),Oi(s,s)}let Mb={None:0,Model:1,Symbol:2,FillExtrusion:4};class v_{constructor(e,i,s,a){this.message=(e?`${e}: `:"")+s,a&&(this.identifier=a),i!=null&&i.__line__&&(this.line=i.__line__)}}function Hy(r,e){let i=r.indexOf("://")===-1;try{return new URL(r,i&&e?"http://example.com":void 0),!0}catch{return!1}}class Cb{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Pb{constructor(){this.instancedDataArray=new vu,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class $y{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,i){}populate(e,i,s,a){this.tileToMeter=se(s);let h=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(let{feature:u,id:f,index:g,sourceLayerIndex:y}of e){let w=f??(u.properties&&u.properties.hasOwnProperty("id")?u.properties.id:void 0),E=ke(u,h);if(!this.layers[0]._featureFilter.filter(new ji(this.zoom,{worldview:this.worldview}),E,s))continue;let I={id:w,sourceLayerIndex:y,index:g,geometry:h?E.geometry:me(u,s,a),properties:u.properties,type:u.type,patterns:{}},R=this.addFeature(I,I.geometry,E);R&&i.featureIndex.insert(u,I.geometry,g,y,this.index,this.instancesPerModel[R].instancedDataArray.length,ht/32)}this.lookup=null}update(e,i,s,a){for(let h in this.instancesPerModel){let u=this.instancesPerModel[h];for(let f in e)u.idToFeaturesIndex.hasOwnProperty(f)&&(this.evaluate(u.features[u.idToFeaturesIndex[f]],e[f],u,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(let i in this.instancesPerModel){let s=this.instancesPerModel[i];for(let a of s.features){let h=this.layers[0],u=a.feature,f=this.canonical,g=h.paint.get("model-rotation").evaluate(u,{},f),y=h.paint.get("model-scale").evaluate(u,{},f),w=h.paint.get("model-translation").evaluate(u,{},f);Lo(a.rotation,g)&&Lo(a.scale,y)&&Lo(a.translation,w)||(this.evaluate(a,a.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,i,s,a){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;let h=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Hm(this.activeReplacements,h))return!1;this.activeReplacements=h;let u=!1;for(let f in this.instancesPerModel){let g=this.instancesPerModel[f],y=g.instancedDataArray;for(let w of g.features){let E=w.instancedDataOffset,I=w.instancedDataCount;for(let R=0;R<I;R++){let L=16*(R+E),k=y.float32[L+0],B=k>ht;k=B?k-ht:k;let G=Math.floor(k),X=y.float32[L+1],W=!1;for(let K of this.activeReplacements)if(!gv(K,s,Mb.Model,a)&&!(K.min.x>G||G>K.max.x||K.min.y>X||X>K.max.y)&&(W=sy(bv(G,X,e.canonical,K.footprintTileId.canonical),K.footprint),W))break;y.float32[L]=W?k+ht:k,u=u||W!==B}}}return u}isEmpty(){for(let e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(let i in this.instancesPerModel){let s=this.instancesPerModel[i];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,PI.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let i in this.instancesPerModel){let s=this.instancesPerModel[i];s.instancedDataArray.length!==0&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}let e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(let i of this.modelUris)e.removeModel(i,"",!0)}addFeature(e,i,s){let a=this.layers[0],h=a.layout.get("model-id").evaluate(s,{},this.canonical);if(!h)return pi(`modelId is not evaluated for layer ${a.id} and it is not going to get rendered.`),h;(Hy(h,!1)||this.styleDefinedModelURLs[h]!==void 0)&&(this.modelUris.includes(h)||this.modelUris.push(h)),this.instancesPerModel[h]||(this.instancesPerModel[h]=new Pb);let u=this.instancesPerModel[h],f=u.instancedDataArray,g=new Cb(s,f.length);for(let y of i)for(let w of y){if(w.x<0||w.x>=ht||w.y<0||w.y>=ht)continue;let E=(this.lookupDim-1)/ht,I=this.lookupDim*(w.y*E|0)+w.x*E|0;if(this.lookup){if(this.lookup[I]!==0)continue;this.lookup[I]=1}this.instanceCount++;let R=f.length;f.resize(R+1),u.instancesEvaluatedElevation.push(0),f.float32[16*R]=w.x,f.float32[16*R+1]=w.y}return g.instancedDataCount=u.instancedDataArray.length-g.instancedDataOffset,g.instancedDataCount>0&&(e.id&&(u.idToFeaturesIndex[e.id]=u.features.length),u.features.push(g),this.evaluate(g,{},u,!1)),h}getModelUris(){return this.modelUris}evaluate(e,i,s,a){let h=this.layers[0],u=e.feature,f=this.canonical,g=e.rotation=h.paint.get("model-rotation").evaluate(u,i,f),y=e.scale=h.paint.get("model-scale").evaluate(u,i,f),w=e.translation=h.paint.get("model-translation").evaluate(u,i,f),E=h.paint.get("model-color").evaluate(u,i,f);E.a=h.paint.get("model-color-mix-intensity").evaluate(u,i,f);let I=[];this.maxVerticalOffset<w[2]&&(this.maxVerticalOffset=w[2]),this.maxScale=Math.max(Math.max(this.maxScale,y[0]),Math.max(y[1],y[2])),i1(I,g,y);let R=Math.round(100*E.a)+E.b/1.05;for(let L=0;L<e.instancedDataCount;++L){let k=e.instancedDataOffset+L,B=16*k,G=s.instancedDataArray.float32,X=0;a&&(X=G[B+6]-s.instancesEvaluatedElevation[k]);let W=0|G[B+1];G[B]=(0|G[B])+E.r/1.05,G[B+1]=W+E.g/1.05,G[B+2]=R,G[B+3]=1/(f.z>10?this.tileToMeter:se(f,W)),G[B+4]=w[0],G[B+5]=w[1],G[B+6]=w[2]+X,G[B+7]=I[0],G[B+8]=I[1],G[B+9]=I[2],G[B+10]=I[4],G[B+11]=I[5],G[B+12]=I[6],G[B+13]=I[8],G[B+14]=I[9],G[B+15]=I[10],s.instancesEvaluatedElevation[k]=w[2]}}}let Rb,Lb;Tt($y,"ModelBucket",{omit:["layers"]}),Tt(Pb,"PerModelAttributes"),Tt(Cb,"ModelFeature");class Bu{constructor(e,i,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=s}static create(e,i,s){let a=s||e.findDEMTileFor(i);if(!a||!a.dem)return;let h=a.dem,u=a.tileID,f=1<<i.canonical.z-u.canonical.z;return new Bu(a,h.dim/ht/f,[(i.canonical.x/f-u.canonical.x)*h.dim,(i.canonical.y/f-u.canonical.y)*h.dim])}tileCoordToPixel(e,i){let s=i*this._scale+this._offset[1];return new Qe(Math.floor(e*this._scale+this._offset[0]),Math.floor(s))}getElevationAt(e,i,s,a){let h=e*this._scale+this._offset[0],u=i*this._scale+this._offset[1],f=Math.floor(h),g=Math.floor(u),y=this._dem;return a=!!a,s?Bt(Bt(y.get(f,g,a),y.get(f,g+1,a),u-g),Bt(y.get(f+1,g,a),y.get(f+1,g+1,a),u-g),h-f):y.get(f,g,a)}getElevationAtPixel(e,i,s){return this._dem.get(e,i,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*U(1,e)*this._dem.stride}}let Zy=new Float32Array(262144),ah=new Uint8Array(262144);function zb(r){let e=0;if(r.meshes)for(let i of r.meshes)e=Math.max(e,i.aabb.max[2]);if(r.children)for(let i of r.children)e=Math.max(e,zb(i));return e}function Db(r,e,i){if(r.meshes)for(let s of r.meshes){if(s.aabb.min[0]===1/0)continue;let a=li.applyTransform(s.aabb,r.matrix);i.insert(e,a.min[0],a.min[1],a.max[0],a.max[1])}if(r.children)for(let s of r.children)Db(s,e,i)}let Ob=["","wall","door","roof","window","lamp","logo"];class kb{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:zb(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new li([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0,i=new li([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=li.applyTransformFast(s.aabb,this.node.matrix),i.encapsulate(s.transformedAabb)),e++;this.aabb=i}return this.aabb}}class b_{constructor(e,i,s,a,h,u,f,g){this.id=s,this.layers=e,this.layerIds=this.layers.map(y=>y.fqid),this.stateDependentLayerIds=this.layers.filter(y=>y.isStateDependent()).map(y=>y.id),this.modelTraits|=Lu.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,a&&(this.modelTraits|=Lu.HasMapboxMeshFeatures),h&&(this.modelTraits|=Lu.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=u,this.worldview=g,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(let y of i)this.nodesInfo.push(new kb(y)),Db(y,f.featureIndexArray.length,f.grid),f.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,f.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(let s of this.getNodesInfo()){let a=s.node;a.footprint&&i.push({footprint:a.footprint,id:e})}}update(e){let i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;let s=i?this.stateDependentLayers:this.layers;if(!Ss(e,this.states))for(let a of s)this.evaluate(a,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;let i=this.getNodesInfo();for(let s of i){let a=s.node;this.uploaded?this.updatePbrBuffer(a):by(a,e,!0)}for(let s of i)t_(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(let s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),i=!0);return i}needsReEvaluation(e,i,s){let a=e.transform.projectionOptions,h=e.style.getBrightness(),u=this.brightness!==h;if(!this.uploaded||this.dirty||a.name!==this.projection.name||Qp(s.paint.get("model-color").value,u)||Qp(s.paint.get("model-color-mix-intensity").value,u)||Qp(s.paint.get("model-roughness").value,u)||Qp(s.paint.get("model-emissive-strength").value,u)||Qp(s.paint.get("model-height-based-emissive-strength-multiplier").value,u)){this.projection=a,this.brightness=h;let f=this.getNodesInfo();for(let g of f)g.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;let s=this.getNodesInfo(),a=this.id.canonical;for(let h of s){let u=h.feature;h.evaluatedTranslation=i.paint.get("model-translation").evaluate(u,{},a),h.evaluatedScale=i.paint.get("model-scale").evaluate(u,{},a)}}evaluate(e,i){let s=this.getNodesInfo();for(let a of s){if(!a.node.meshes)continue;let h=a.feature,u=i&&i[h.id];if(Ss(u,a.state))continue;a.state=structuredClone(u);let f=a.node.meshes&&a.node.meshes[0].featureData,g=a.evaluatedColor[2],y=a.evaluatedRMEA[2],w=this.id.canonical;if(a.hasTranslucentParts=!1,f){for(let E=0;E<Ob.length;E++){let I=Ob[E];I.length&&(h.properties.part=I);let R=e.paint.get("model-color").evaluate(h,u,w).toPremultipliedRenderColor(null),L=e.paint.get("model-color-mix-intensity").evaluate(h,u,w);a.evaluatedColor[E]=[R.r,R.g,R.b,L],a.evaluatedRMEA[E][0]=e.paint.get("model-roughness").evaluate(h,u,w),a.evaluatedRMEA[E][2]=e.paint.get("model-emissive-strength").evaluate(h,u,w),a.evaluatedRMEA[E][3]=R.a,a.emissionHeightBasedParams[E]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(h,u,w),!a.hasTranslucentParts&&R.a<1&&(a.hasTranslucentParts=!0)}delete h.properties.part,QA(a,g!==a.evaluatedColor[2]||y!==a.evaluatedRMEA[2],this.modelTraits)}else a.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(h,u,w);a.evaluatedTranslation=e.paint.get("model-translation").evaluate(h,u,w),a.evaluatedScale=e.paint.get("model-scale").evaluate(h,u,w),this.updatePbrBuffer(a.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,s,a){let h=e.findDEMTileFor(s);if(h&&(h.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(h.dem&&h.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=h.tileID.overscaledZ;let u=Bu.create(e,s,h);if(!u)return;this.modelTraits&Lu.HasMapboxMeshFeatures&&this.updateDEM(e,u,s,a);for(let f of this.getNodesInfo()){let g=f.node;if(!g.footprint||!g.footprint.vertices||!g.footprint.vertices.length)continue;let y=g.footprint.vertices,w=u.getElevationAt(y[0].x,y[0].y,!0,!0);for(let E=1;E<y.length;E++)w=Math.min(w,u.getElevationAt(y[E].x,y[E].y,!0,!0));g.elevation=w}}this.terrainTile=h.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,s,a){let h=i._dem._modifiedForSources[a];if(h===void 0&&(i._dem._modifiedForSources[a]=[],h=i._dem._modifiedForSources[a]),h.includes(s.canonical))return;let u=i._dem.dim;h.push(s.canonical);let f=!1;for(let g of this.getNodesInfo()){let y=g.node;if(!y.footprint||!y.footprint.grid)continue;let w=y.footprint.grid,E=i.tileCoordToPixel(w.min.x,w.min.y),I=i.tileCoordToPixel(w.max.x,w.max.y),R=Math.min(Math.min(u-I.y,E.x),Math.min(E.y,u-I.x));if(R<0)continue;let L=re(R,2,5),k=Math.max(0,E.x-L),B=Math.max(0,E.y-L),G=Math.min(I.x+L,u-1),X=Math.min(I.y+L,u-1);for(let ce=B;ce<=X;++ce)for(let ue=k;ue<=G;++ue)ah[ce*u+ue]=255;let W=0,K=0;for(let ce=0;ce<w.cellsY;++ce)for(let ue=0;ue<w.cellsX;++ue){if(!w.cells[ce*w.cellsX+ue])continue;let ge=i.tileCoordToPixel(w.min.x+ue/w.xScale,w.min.y+ce/w.yScale),ve=i.tileCoordToPixel(w.min.x+(ue+1)/w.xScale,w.min.y+(ce+1)/w.yScale);for(let Ne=ge.y;Ne<=Math.min(ve.y+1,u-1);++Ne)for(let Ee=ge.x;Ee<=Math.min(ve.x+1,u-1);++Ee)ah[Ne*u+Ee]===255&&(ah[Ne*u+Ee]=0,W+=i.getElevationAtPixel(Ee,Ne),K++)}let pe=W/K;k=Math.max(1,E.x-L),B=Math.max(1,E.y-L),G=Math.min(I.x+L,u-2),X=Math.min(I.y+L,u-2),f=!0;for(let ce=B;ce<=X;++ce)for(let ue=k;ue<=G;++ue)ah[ce*u+ue]===0&&(Zy[ce*u+ue]=i._dem.set(ue,ce,pe));for(let ce=1;ce<L;++ce){k=Math.max(1,E.x-ce),B=Math.max(1,E.y-ce),G=Math.min(I.x+ce,u-2),X=Math.min(I.y+ce,u-2);for(let ue=B;ue<=X;++ue)for(let ge=k;ge<=G;++ge){let ve=ue*u+ge;if(ah[ve]===255){let Ne=0,Ee=0,Ue=-1,nt=-1;for(let qe=-1;qe<=1;++qe)for(let Ke=-1;Ke<=1;++Ke){let it=(ue+qe)*u+ge+Ke;if(ah[it]>=ce)continue;let Fe=Zy[it],Je=Math.abs(Fe);Je>Ee&&(Ne=Fe,Ee=Je,Ue=Ke,nt=qe)}if(Ee>.1){let qe=1-(ce+.5*Math.abs(Ue*nt))/L,Ke=i._dem.get(ge,ue)+Ne*qe,it=i._dem.get(ge+Ue,ue+nt),Fe=i._dem.get(ge-Ue,ue-nt,!0);(Ke-it)*(Ke-Fe)>0&&(Ke=(it+Fe)/2),Zy[ve]=i._dem.set(ge,ue,Ke),ah[ve]=ce}}}}}f&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=Wo.now())}setFilter(e){this.filter=e?wl(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new ji(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){let e=this.getNodesInfo();for(let i of e)t_(i.node),wy(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;let s=i.getReplacementRegionsForTile(e.toUnwrapped());for(let a of this.getNodesInfo()){let h=a.node.footprint;a.hiddenByReplacement=!!h&&!s.find(u=>u.footprint===h)}}getHeightAtTileCoord(e,i){let s=[],a=[0,0,0],h=xe([]);for(let u of this.getNodesInfo()){let f=u.node.meshes[0],g=f.transformedAabb;if(e<g.min[0]||i<g.min[1]||e>g.max[0]||i>g.max[1])continue;if(u.node.hidden===!0)return{height:1/0,maxHeight:u.feature.properties.height,hidden:!1,verticalScale:u.evaluatedScale[2]};Ge(h,u.node.matrix),a[0]=e,a[1]=i,Lr(a,a,h);let y=(a[0]-f.aabb.min[0])/(f.aabb.max[0]-f.aabb.min[0])*nh|0,w=Math.min(63,(a[1]-f.aabb.min[1])/(f.aabb.max[1]-f.aabb.min[1])*nh|0)*nh+Math.min(63,y),E=f.heightmap[w];if(!(E<0&&u.node.footprint))return u.hiddenByReplacement?void 0:{height:E,maxHeight:u.feature.properties.height,hidden:!1,verticalScale:u.evaluatedScale[2]};if(u.node.footprint.grid.query(new Qe(e,i),new Qe(e,i),s),s.length>0)return{height:void 0,maxHeight:u.feature.properties.height,hidden:u.hiddenByReplacement,verticalScale:u.evaluatedScale[2]}}}}function Qp(r,e){return r instanceof su&&!r.isLightConstant&&e}function JA(r,e,i,s,a,h,u,f){let g=(61440&e|(61440&e)>>4)>>8,y=(3840&e|(3840&e)>>4)>>4,w=240&e|(240&e)>>4;i[3]>0&&(g=Bt(g,255*i[0],i[3]),y=Bt(y,255*i[1],i[3]),w=Bt(w,255*i[2],i[3]));let E=g<<8|y,I=w<<8|Math.floor(255*s[3]),R=function(ce){let ue=re(ce,0,2);return Math.min(Math.round(.5*ue*255),255)}(s[2])<<8|15*s[0]<<4|15*s[1],L=re(a[0],0,1),k=re(a[1],0,1),B=re(a[2],0,1),G=re(a[3],0,1),X,W,K,pe;if(L!==k&&u!==h&&k!==L){let ce=u-h;W=1/(ce*(k-L)),K=-(h+ce*L)/(ce*(k-L));let ue=re(a[4],-1,1);pe=Math.pow(10,ue),X=255*B<<8|255*G}else X=65535,W=0,K=1,pe=1;if(r.emplaceBack(E,I,R,X,W,K,pe),f){let ce=f.length;f.clear();for(let ue=0;ue<ce;ue++)f.emplaceBack(E,I,R,X,W,K,pe)}}function QA(r,e,i){let s=r.node,a=0,h=i&Lu.HasMeshoptCompression;for(let u of s.meshes){if(s.lights&&s.lightMeshIndex===a||!u.featureData)continue;u.featureArray=new Ll,u.featureArray.reserve(u.featureData.length);let f=e;for(let g of u.featureData){let y=h?65535&g:g>>16&65535,w=h?g>>16&65535:65535&g,E=(15&w)<8?15&w:0,I=r.evaluatedRMEA[E],R=r.evaluatedColor[E],L=r.emissionHeightBasedParams[E],k;if(f&&E===2&&s.lights&&(k=new Ll,k.resize(10*s.lights.length)),JA(u.featureArray,y,R,I,L,u.aabb.min[2],u.aabb.max[2],k),k&&f){f=!1;let B=s.meshes[s.lightMeshIndex];B.featureArray=k,B.featureArray._trim()}}u.featureArray._trim(),a++}}function Fb(r,e,i,s){let a=1<<r.z;e.lat=Y((s/ht+r.y)/a),e.lng=Z((i/ht+r.x)/a)}function eM(r,e,i,s){let a=r.getNodesInfo()[e];if(!a||a.hiddenByReplacement||!a.node.meshes)return;let h=Number.MAX_VALUE,u=a.node,f=i.tile,g=s.calculatePosMatrix(f.tileID.toUnwrapped(),s.worldSize),y=a.evaluatedScale,w=0;s.elevation&&u.elevation&&(w=u.elevation*s.elevation.exaggeration()),We(g,g,[(u.anchor?u.anchor[0]:0)*(y[0]-1),(u.anchor?u.anchor[1]:0)*(y[1]-1),w]),ft(g,g,y);let E=i.queryGeometry,I=E.isPointQuery()?E.screenBounds:E.screenGeometry,R=function(k){let B=Te([],g,k.matrix);Te(B,s.expandedFarZProjMatrix,B);for(let G=0;G<k.meshes.length;++G){let X=k.meshes[G];if(G===k.lightMeshIndex)continue;let W=r1(I,s,B,X.aabb);W!=null&&(h=Math.min(W,h))}if(k.children)for(let G of k.children)R(G)};if(R(u),h===Number.MAX_VALUE)return;let L=new C(0,0);return Fb(f.tileID.canonical,L,a.node.anchor[0],a.node.anchor[1]),{intersectionZ:h,position:L,feature:a.feature}}Tt(b_,"Tiled3dModelBucket",{omit:["layers"]}),Tt(kb,"Tiled3dModelFeature");let tM={circle:class extends Mn{constructor(r,e,i,s){super(r,{layout:la||(la=new Ar({"circle-sort-key":new gt(Se.layout_circle["circle-sort-key"]),"circle-elevation-reference":new ot(Se.layout_circle["circle-elevation-reference"]),visibility:new ot(Se.layout_circle.visibility)})),paint:Ol||(Ol=new Ar({"circle-radius":new gt(Se.paint_circle["circle-radius"]),"circle-color":new gt(Se.paint_circle["circle-color"]),"circle-blur":new gt(Se.paint_circle["circle-blur"]),"circle-opacity":new gt(Se.paint_circle["circle-opacity"]),"circle-translate":new ot(Se.paint_circle["circle-translate"]),"circle-translate-anchor":new ot(Se.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ot(Se.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ot(Se.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new gt(Se.paint_circle["circle-stroke-width"]),"circle-stroke-color":new gt(Se.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new gt(Se.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ot(Se.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}createBucket(r){return new Li(r)}queryRadius(r){let e=r;return un("circle-radius",this,e)+un("circle-stroke-width",this,e)+Pr(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,i,s,a,h,u,f){let g=Na(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),h.angle,r.pixelToTileUnitsFactor),y=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return qx(r,s,h,u,f,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",g,y)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,i){let s=Gx(this);return{config:new On(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}is3D(r){return!r&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends Mn{createBucket(r){return new $x(r)}constructor(r,e,i,s){super(r,{layout:Zx||(Zx=new Ar({visibility:new ot(Se.layout_heatmap.visibility)})),paint:Wx||(Wx=new Ar({"heatmap-radius":new gt(Se.paint_heatmap["heatmap-radius"]),"heatmap-weight":new gt(Se.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ot(Se.paint_heatmap["heatmap-intensity"]),"heatmap-color":new bl(Se.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ot(Se.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Sp({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(r){return un("heatmap-radius",this,r)}queryIntersectsFeature(r,e,i,s,a,h,u,f){let g=this.paint.get("heatmap-radius").evaluate(e,i);return qx(r,s,h,u,f,!0,!0,new Qe(0,0),g)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,i){return r==="heatmap"?{config:new On(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends Mn{constructor(r,e,i,s){super(r,{layout:Xx||(Xx=new Ar({visibility:new ot(Se.layout_hillshade.visibility)})),paint:Yx||(Yx=new Ar({"hillshade-illumination-direction":new ot(Se.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ot(Se.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ot(Se.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ot(Se.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ot(Se.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ot(Se.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ot(Se.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}},fill:class extends Mn{constructor(r,e,i,s){super(r,{layout:uv||(uv=new Ar({"fill-sort-key":new gt(Se.layout_fill["fill-sort-key"]),visibility:new ot(Se.layout_fill.visibility),"fill-elevation-reference":new ot(Se.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new gt(Se.layout_fill["fill-construct-bridge-guard-rail"])})),paint:dv||(dv=new Ar({"fill-antialias":new ot(Se.paint_fill["fill-antialias"]),"fill-opacity":new gt(Se.paint_fill["fill-opacity"]),"fill-color":new gt(Se.paint_fill["fill-color"]),"fill-outline-color":new gt(Se.paint_fill["fill-outline-color"]),"fill-translate":new ot(Se.paint_fill["fill-translate"]),"fill-translate-anchor":new ot(Se.paint_fill["fill-translate-anchor"]),"fill-pattern":new gt(Se.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new ot(Se.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new ot(Se.paint_fill["fill-emissive-strength"]),"fill-z-offset":new gt(Se.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new gt(Se.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new gt(Se.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){let r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(r,e,i){return{config:new On(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);let i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new ry(r)}queryRadius(){return Pr(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,i,s,a,h){return!r.queryGeometry.isAboveHorizon&&Dr(wo(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),h.angle,r.pixelToTileUnitsFactor),s)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(r){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;let e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return r!=null?e&&!r:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends Mn{constructor(r,e,i,s){super(r,{layout:Ov||(Ov=new Ar({visibility:new ot(Se["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ot(Se["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:kv||(kv=new Ar({"fill-extrusion-opacity":new ot(Se["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new gt(Se["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ot(Se["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ot(Se["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new gt(Se["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new ot(Se["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new gt(Se["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new gt(Se["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new ot(Se["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new ot(Se["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new ot(Se["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ot(Se["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ot(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ot(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new gt(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new gt(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ot(Se["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ot(Se["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ot(Se["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ot(Se["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new gt(Se["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new gt(Se["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new ot(Se["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Zm(r)}queryRadius(){return Pr(this.paint.get("fill-extrusion-translate"))}is3D(r){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,i,s,a,h,u,f,g){let y=Na(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),h.angle,r.pixelToTileUnitsFactor),w=this.paint.get("fill-extrusion-height").evaluate(e,i),E=this.paint.get("fill-extrusion-base").evaluate(e,i),I=[0,0],R=f&&h.elevation,L=h.elevation?h.elevation.exaggeration():1,k=r.tile.getBucket(this);if(R&&k instanceof Zm){let K=k.centroidVertexArray,pe=g+1;pe<K.length&&(I[0]=K.geta_centroid_pos0(pe),I[1]=K.geta_centroid_pos1(pe))}if(I[0]===0&&I[1]===1)return!1;h.projection.name==="globe"&&(s=Dv([s],[new Qe(0,0),new Qe(ht,ht)],r.tileID.canonical).map(K=>K.polygon).flat());let B=R?f:null,[G,X]=function(K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe){return K.projection.name==="globe"?function(Ke,it,Fe,Je,Ie,Be,at,et,Lt,St,Xe){let tt=[],It=[],xt=Ke.projection.upVectorScale(Xe,Ke.center.lat,Ke.worldSize).metersToTile,ut=[0,0,0,1],vt=[0,0,0,1],Vt=(Qt,Kt,fi,oi)=>{Qt[0]=Kt,Qt[1]=fi,Qt[2]=oi,Qt[3]=1},Zt=zv();Fe>0&&(Fe+=Zt),Je+=Zt;for(let Qt of it){let Kt=[],fi=[];for(let oi of Qt){let ir=oi.x+Ie.x,ee=oi.y+Ie.y,te=Ke.projection.projectTilePoint(ir,ee,Xe),Oe=Ke.projection.upVector(Xe,oi.x,oi.y),lt=Fe,pt=Je;if(at){let dt=jv(ir,ee,Fe,Je,at,et,Lt,St);lt+=dt.base,pt+=dt.top}Fe!==0?Vt(ut,te.x+Oe[0]*xt*lt,te.y+Oe[1]*xt*lt,te.z+Oe[2]*xt*lt):Vt(ut,te.x,te.y,te.z),Vt(vt,te.x+Oe[0]*xt*pt,te.y+Oe[1]*xt*pt,te.z+Oe[2]*xt*pt),Lr(ut,ut,Be),Lr(vt,vt,Be),Kt.push(new ih(ut[0],ut[1],ut[2])),fi.push(new ih(vt[0],vt[1],vt[2]))}tt.push(Kt),It.push(fi)}return[tt,It]}(K,pe,ce,ue,ge,ve,Ne,Ee,Ue,nt,qe):Ne?function(Ke,it,Fe,Je,Ie,Be,at,et,Lt){let St=[],Xe=[],tt=[0,0,0,1];for(let It of Ke){let xt=[],ut=[];for(let vt of It){let Vt=vt.x+Je.x,Zt=vt.y+Je.y,Qt=jv(Vt,Zt,it,Fe,Be,at,et,Lt);tt[0]=Vt,tt[1]=Zt,tt[2]=Qt.base,tt[3]=1,Yn(tt,tt,Ie),tt[3]=Math.max(tt[3],1e-5);let Kt=new ih(tt[0]/tt[3],tt[1]/tt[3],tt[2]/tt[3]);tt[0]=Vt,tt[1]=Zt,tt[2]=Qt.top,tt[3]=1,Yn(tt,tt,Ie),tt[3]=Math.max(tt[3],1e-5);let fi=new ih(tt[0]/tt[3],tt[1]/tt[3],tt[2]/tt[3]);xt.push(Kt),ut.push(fi)}St.push(xt),Xe.push(ut)}return[St,Xe]}(pe,ce,ue,ge,ve,Ne,Ee,Ue,nt):function(Ke,it,Fe,Je,Ie){let Be=[],at=[],et=Ie[8]*it,Lt=Ie[9]*it,St=Ie[10]*it,Xe=Ie[11]*it,tt=Ie[8]*Fe,It=Ie[9]*Fe,xt=Ie[10]*Fe,ut=Ie[11]*Fe;for(let vt of Ke){let Vt=[],Zt=[];for(let Qt of vt){let Kt=Qt.x+Je.x,fi=Qt.y+Je.y,oi=Ie[0]*Kt+Ie[4]*fi+Ie[12],ir=Ie[1]*Kt+Ie[5]*fi+Ie[13],ee=Ie[2]*Kt+Ie[6]*fi+Ie[14],te=Ie[3]*Kt+Ie[7]*fi+Ie[15],Oe=oi+et,lt=ir+Lt,pt=ee+St,dt=Math.max(te+Xe,1e-5),Et=oi+tt,qt=ir+It,ci=ee+xt,hi=Math.max(te+ut,1e-5);Vt.push(new ih(Oe/dt,lt/dt,pt/dt)),Zt.push(new ih(Et/hi,qt/hi,ci/hi))}Be.push(Vt),at.push(Zt)}return[Be,at]}(pe,ce,ue,ge,ve)}(h,s,E,w,y,u,B,I,L,h.center.lat,r.tileID.canonical),W=r.queryGeometry;return function(K,pe,ce){let ue=1/0;Dr(ce,pe)&&(ue=Uv(ce,pe[0]));for(let ge=0;ge<pe.length;ge++){let ve=pe[ge],Ne=K[ge];for(let Ee=0;Ee<ve.length-1;Ee++){let Ue=ve[Ee],nt=[Ue,ve[Ee+1],Ne[Ee+1],Ne[Ee],Ue];$i(ce,nt)&&(ue=Math.min(ue,Uv(ce,nt)))}}return ue!==1/0&&ue}(G,X,W.isPointQuery()?W.screenBounds:W.screenGeometry)}},building:class extends Mn{constructor(r,e,i,s){super(r,{layout:d1||(d1=new Ar({visibility:new ot(Se.layout_building.visibility),"building-facade":new gt(Se.layout_building["building-facade"]),"building-facade-floors":new gt(Se.layout_building["building-facade-floors"]),"building-facade-window":new gt(Se.layout_building["building-facade-window"]),"building-roof-shape":new gt(Se.layout_building["building-roof-shape"]),"building-height":new gt(Se.layout_building["building-height"]),"building-base":new gt(Se.layout_building["building-base"])})),paint:p1||(p1=new Ar({"building-opacity":new ot(Se.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new ot(Se.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new ot(Se.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new ot(Se.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new ot(Se.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new ot(Se.paint_building["building-vertical-scale"]),"building-cast-shadows":new ot(Se.paint_building["building-cast-shadows"]),"building-color":new gt(Se.paint_building["building-color"]),"building-emissive-strength":new gt(Se.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new ot(Se.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new ot(Se.paint_building["building-cutoff-fade-range"]),"building-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new u1(r)}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(r){return!0}},line:class extends Mn{constructor(r,e,i,s){let a=T1();super(r,a,e,i,s),a.layout&&(this.layout=new Ko(a.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){let e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Oc,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(Up)return Up;let i=T1();return Up=new QI(i.paint.properties["line-width"].specification),Up.useIntegerZoom=!0,Up})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new Ey(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,i){let s=b1(this);return{config:new On(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}queryRadius(r){let e=r,i=S1(un("line-width",this,e),un("line-gap-width",this,e)),s=un("line-offset",this,e);return i/2+Math.abs(s)+Pr(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,i,s,a,h){if(r.queryGeometry.isAboveHorizon)return!1;let u=wo(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),h.angle,r.pixelToTileUnitsFactor),f=r.pixelToTileUnitsFactor/2*S1(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),g=this.paint.get("line-offset").evaluate(e,i);return g&&(s=function(y,w){let E=[],I=new Qe(0,0);for(let R=0;R<y.length;R++){let L=y[R],k=[];for(let B=0;B<L.length;B++){let G=L[B],X=L[B+1],W=B===0?I:G.sub(L[B-1])._unit()._perp(),K=B===L.length-1?I:X.sub(G)._unit()._perp(),pe=W._add(K)._unit();pe._mult(1/(pe.x*K.x+pe.y*K.y)),k.push(pe._mult(w)._add(G))}E.push(k)}return E}(s,g*r.pixelToTileUnitsFactor)),function(y,w,E){for(let I=0;I<w.length;I++){let R=w[I];if(y.length>=3){for(let L=0;L<R.length;L++)if(xn(y,R[L]))return!0}if(Br(y,R,E))return!0}return!1}(u,s,f)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(r){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:g_,background:class extends Mn{constructor(r,e,i,s){super(r,{layout:mb||(mb=new Ar({visibility:new ot(Se.layout_background.visibility)})),paint:_b||(_b=new Ar({"background-pitch-alignment":new ot(Se.paint_background["background-pitch-alignment"]),"background-color":new ot(Se.paint_background["background-color"]),"background-pattern":new ot(Se.paint_background["background-pattern"]),"background-opacity":new ot(Se.paint_background["background-opacity"]),"background-emissive-strength":new ot(Se.paint_background["background-emissive-strength"]),"background-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}is3D(r){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:bb,"raster-particle":Ab,sky:class extends Mn{constructor(r,e,i,s){super(r,{layout:Sb||(Sb=new Ar({visibility:new ot(Se.layout_sky.visibility)})),paint:Eb||(Eb=new Ar({"sky-type":new ot(Se.paint_sky["sky-type"]),"sky-atmosphere-sun":new ot(Se.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ot(Se.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ot(Se.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ot(Se.paint_sky["sky-gradient-radius"]),"sky-gradient":new bl(Se.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ot(Se.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ot(Se.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ot(Se.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Sp({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){let s=this.paint.get("sky-atmosphere-sun"),a=!s,h=r.style.light,u=h.properties.get("position");return a&&h.properties.get("anchor")==="viewport"&&pi("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),a?qy(u.azimuthal,90-u.polar,e):qy(s[0],90-s[1],e)}let i=this.paint.get("sky-gradient-center");return qy(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends Mn{constructor(r,e,i,s){super(r,{paint:Ib||(Ib=new Ar({}))},e,null)}},model:class extends Mn{constructor(r,e,i,s){super(r,{layout:Rb||(Rb=new Ar({visibility:new ot(Se.layout_model.visibility),"model-id":new gt(Se.layout_model["model-id"])})),paint:Lb||(Lb=new Ar({"model-opacity":new gt(Se.paint_model["model-opacity"]),"model-rotation":new gt(Se.paint_model["model-rotation"]),"model-scale":new gt(Se.paint_model["model-scale"]),"model-translation":new gt(Se.paint_model["model-translation"]),"model-color":new gt(Se.paint_model["model-color"]),"model-color-mix-intensity":new gt(Se.paint_model["model-color-mix-intensity"]),"model-type":new ot(Se.paint_model["model-type"]),"model-cast-shadows":new ot(Se.paint_model["model-cast-shadows"]),"model-receive-shadows":new ot(Se.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ot(Se.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new gt(Se.paint_model["model-emissive-strength"]),"model-roughness":new gt(Se.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new gt(Se.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ot(Se.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new ot(Se.paint_model["model-front-cutoff"]),"model-color-use-theme":new gt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new $y(r)}getProgramIds(){return["model"]}is3D(r){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof b_?ht-1:0}queryIntersectsFeature(r,e,i,s,a,h){if(!this.modelManager)return!1;let u=this.modelManager,f=r.tile.getBucket(this);if(!(f&&f instanceof $y))return!1;for(let g in f.instancesPerModel){let y=f.instancesPerModel[g],w=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(y.idToFeaturesIndex.hasOwnProperty(w)){let E=y.features[y.idToFeaturesIndex[w]],I=u.getModel(g,this.scope);if(!I)return!1;let R=Ae(),L=new C(0,0),k=f.canonical,B=Number.MAX_VALUE;for(let G=0;G<E.instancedDataCount;++G){let X=16*(E.instancedDataOffset+G),W=y.instancedDataArray.float32,K=[W[X+4],W[X+5],W[X+6]];Fb(k,L,W[X],0|W[X+1]),n1(R,I,h,L,E.rotation,E.scale,K,!1,!1,!1),h.projection.name==="globe"&&(R=vy(R,h));let pe=Te([],h.projMatrix,R),ce=r.queryGeometry,ue=r1(ce.isPointQuery()?ce.screenBounds:ce.screenGeometry,h,pe,I.aabb);ue!=null&&(B=Math.min(ue,B))}return B!==Number.MAX_VALUE&&B}}return!1}_handleOverridablePaintPropertyUpdate(r,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){let e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof ta}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Mn{constructor(r,e,i,s){super(r,{layout:pv||(pv=new Ar({"clip-layer-types":new ot(Se.layout_clip["clip-layer-types"]),"clip-layer-scope":new ot(Se.layout_clip["clip-layer-scope"])})),paint:fv||(fv=new Ar({}))},e,i,s)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new mv(r)}is3D(r){return!0}}},Wy=new ki(0,0,0),Xy={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},Yy={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},w_={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},iM={PAINT_ORDER_FILL_AND_STROKE:1},ef={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},Bb={MASK_TYPE_LUMINANCE:1};function rM(r,e,i){r===1&&e.icons.push(function(s,a){return function(h){if(h.usvg_tree.height||(h.usvg_tree.height=h.usvg_tree.width),!h.metadata)return h;let{metadata:u}=h;if(u.content_area){let{content_area:f}=u;f.top==null&&(f.top=f.left),f.width==null&&(f.width=h.usvg_tree.width),f.height==null&&(f.height=f.width)}return u.stretch_x&&u.stretch_x.length&&Nb(u,"x"),u.stretch_y&&u.stretch_y.length&&Nb(u,"y"),h}(s.readFields(nM,{name:void 0},a))}(i,i.readVarint()+i.pos))}function Nb(r,e){let i=[],s=r[`stretch_${e}`],a=null;for(let h=0;h<s.length;h++)a===null?a=i.length===0?s[0]:i[i.length-1][1]+s[h]:(i.push([a,a+s[h]]),a=null);r[`stretch_${e}_areas`]=i}function nM(r,e,i){r===1?e.name=i.readString():r===2?e.metadata=function(s,a){return s.readFields(oM,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},a)}(i,i.readVarint()+i.pos):r===3&&(e.usvg_tree=function(s,a){return s.readFields(lM,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},a)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function oM(r,e,i){r===1?e.stretch_x=i.readPackedVarint():r===2?e.stretch_y=i.readPackedVarint():r===3?e.content_area=function(s,a){return s.readFields(sM,{left:0},a)}(i,i.readVarint()+i.pos):r===4&&e.variables.push(function(s,a){return s.readFields(aM,{name:void 0},a)}(i,i.readVarint()+i.pos))}function sM(r,e,i){r===1?e.left=i.readVarint():r===2?e.width=i.readVarint():r===3?e.top=i.readVarint():r===4&&(e.height=i.readVarint())}function aM(r,e,i){r===1?e.name=i.readString():r===2&&(e.rgb_color=E_(i.readVarint()),e.value="rgb_color")}function lM(r,e,i){r===1?e.width=e.height=i.readVarint():r===2?e.height=i.readVarint():r===3?e.children.push(T_(i,i.readVarint()+i.pos)):r===4?e.linear_gradients.push(function(s,a){return s.readFields(mM,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},a)}(i,i.readVarint()+i.pos)):r===5?e.radial_gradients.push(function(s,a){return s.readFields(gM,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},a)}(i,i.readVarint()+i.pos)):r===7?e.clip_paths.push(function(s,a){return s.readFields(yM,{children:[]},a)}(i,i.readVarint()+i.pos)):r===8&&e.masks.push(function(s,a){let h=s.readFields(xM,{left:0,width:20,mask_type:Bb.MASK_TYPE_LUMINANCE,children:[]},a);return h.height==null&&(h.height=h.width),h.top==null&&(h.top=h.left),h}(i,i.readVarint()+i.pos))}function T_(r,e){return r.readFields(cM,{},e)}function cM(r,e,i){r===1?(e.group=function(s,a){return s.readFields(hM,{opacity:255,children:[]},a)}(i,i.readVarint()+i.pos),e.node="group"):r===2&&(e.path=function(s,a){return s.readFields(dM,{paint_order:1,commands:[],step:1,diffs:[],rule:Xy.PATH_RULE_NON_ZERO},a)}(i,i.readVarint()+i.pos),e.node="path")}function hM(r,e,i){r===1?e.transform=S_(i,i.readVarint()+i.pos):r===2?e.opacity=i.readVarint():r===5?e.clip_path_idx=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(T_(i,i.readVarint()+i.pos))}function S_(r,e){return r.readFields(uM,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function uM(r,e,i){r===1?e.sx=i.readFloat():r===2?e.ky=i.readFloat():r===3?e.kx=i.readFloat():r===4?e.sy=i.readFloat():r===5?e.tx=i.readFloat():r===6&&(e.ty=i.readFloat())}function dM(r,e,i){r===1?e.fill=function(s,a){return s.readFields(pM,{rgb_color:Wy,paint:"rgb_color",opacity:255},a)}(i,i.readVarint()+i.pos):r===2?e.stroke=function(s,a){return s.readFields(fM,{rgb_color:Wy,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},a)}(i,i.readVarint()+i.pos):r===3?e.paint_order=i.readVarint():r===5?i.readPackedVarint(e.commands):r===6?e.step=i.readFloat():r===7?i.readPackedSVarint(e.diffs):r===8&&(e.rule=i.readVarint())}function pM(r,e,i){r===1?(e.rgb_color=E_(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=i.readVarint())}function E_(r){return new ki((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function fM(r,e,i){r===1?(e.rgb_color=E_(i.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):r===5?i.readPackedFloat(e.dasharray):r===6?e.dashoffset=i.readFloat():r===7?e.miterlimit=i.readFloat():r===8?e.opacity=i.readVarint():r===9?e.width=i.readFloat():r===10?e.linecap=i.readVarint():r===11&&(e.linejoin=i.readVarint())}function mM(r,e,i){r===1?e.transform=S_(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(Vb(i,i.readVarint()+i.pos)):r===4?e.x1=i.readFloat():r===5?e.y1=i.readFloat():r===6?e.x2=i.readFloat():r===7&&(e.y2=i.readFloat())}function Vb(r,e){return r.readFields(_M,{offset:0,opacity:255,rgb_color:Wy},e)}function _M(r,e,i){r===1?e.offset=i.readFloat():r===2?e.opacity=i.readVarint():r===3&&(e.rgb_color=E_(i.readVarint()))}function gM(r,e,i){r===1?e.transform=S_(i,i.readVarint()+i.pos):r===2?e.spread_method=i.readVarint():r===3?e.stops.push(Vb(i,i.readVarint()+i.pos)):r===4?e.cx=i.readFloat():r===5?e.cy=i.readFloat():r===6?e.r=i.readFloat():r===7?e.fx=i.readFloat():r===8?e.fy=i.readFloat():r===9&&(e.fr=i.readFloat())}function yM(r,e,i){r===1?e.transform=S_(i,i.readVarint()+i.pos):r===2?e.clip_path_idx=i.readVarint():r===3&&e.children.push(T_(i,i.readVarint()+i.pos))}function xM(r,e,i){r===1?e.left=e.top=i.readFloat():r===2?e.width=e.height=i.readFloat():r===3?e.top=i.readFloat():r===4?e.height=i.readFloat():r===5?e.mask_type=i.readVarint():r===6?e.mask_idx=i.readVarint():r===7&&e.children.push(T_(i,i.readVarint()+i.pos))}class vM{static calculate(e={},i=[]){let s=new Map,a=new Map;if(Object.keys(e).length===0)return s;i.forEach(h=>{a.set(h.name,h.rgb_color||new ki(0,0,0))});for(let[h,u]of Object.entries(e))a.has(h)?s.set(a.get(h).toString(),u):console.warn(`Ignoring unknown image variable "${h}"`);return s}}function Nu(r,e=255,i){let s=e/255,a=r.toString(),h=i.has(a)?i.get(a).clone():r.clone();return h.a*=s,h.toString()}function tf(r,e){if(!Ah()){let i=document.createElement("canvas");return i.width=r,i.height=e,i}return new OffscreenCanvas(r,e)}function bM(r,e){let i=vM.calculate(e.params,r.metadata?r.metadata.variables:[]),s=r.usvg_tree,a=s.width,h=s.height,u=e.transform?e.transform:new DOMMatrix,f=Math.max(1,Math.round(a*u.a)),g=Math.max(1,Math.round(h*u.d)),y=new DOMMatrix([f/a,0,0,g/h,0,0]),w=tf(f,g).getContext("2d");return Ky(w,y,s,s,i),w.getImageData(0,0,f,g)}function Ky(r,e,i,s,a){for(let h of s.children)Ub(r,e,i,h,a)}function Ub(r,e,i,s,a){s.group?(r.save(),function(h,u,f,g,y){let w=g.mask_idx!=null?f.masks[g.mask_idx]:null,E=g.clip_path_idx!=null?f.clip_paths[g.clip_path_idx]:null;if(g.transform&&(u=Vu(g.transform).preMultiplySelf(u)),!function(L,k,B){return L.opacity!==255||k||B}(g,E!=null,w!=null))return void Ky(h,u,f,g,y);let I=tf(h.canvas.width,h.canvas.height),R=I.getContext("2d");Ky(R,u,f,g,y),E&&Wb(R,u,f,E),w&&Xb(R,u,f,w,y),h.globalAlpha=g.opacity/255,h.drawImage(I,0,0)}(r,e,i,s.group,a),r.restore()):s.path&&(r.save(),function(h,u,f,g,y){h.setTransform(u),g.paint_order===iM.PAINT_ORDER_FILL_AND_STROKE?(jb(h,f,g,y),qb(h,f,g,y)):(qb(h,f,g,y),jb(h,f,g,y))}(r,e,i,s.path,a),r.restore())}function jb(r,e,i,s){let a=i.fill;if(!a)return;let h=a.opacity/255;switch(r.save(),r.beginPath(),Yb(i,r),a.paint){case"rgb_color":r.fillStyle=Nu(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":{let u=e.linear_gradients[a.linear_gradient_idx];u.transform&&r.setTransform(Vu(u.transform).preMultiplySelf(r.getTransform())),r.fillStyle=Hb(r,u,h,s);break}case"radial_gradient_idx":{let u=e.radial_gradients[a.radial_gradient_idx];u.transform&&r.setTransform(Vu(u.transform).preMultiplySelf(r.getTransform())),r.fillStyle=$b(r,u,h,s)}}r.fill(Gb(i)),r.restore()}function Gb(r){return r.rule===Xy.PATH_RULE_NON_ZERO?"nonzero":r.rule===Xy.PATH_RULE_EVEN_ODD?"evenodd":void 0}function qb(r,e,i,s){let a=i.stroke;if(!a)return;let h=Kb(i);r.lineWidth=a.width,r.miterLimit=a.miterlimit,r.setLineDash(a.dasharray),r.lineDashOffset=a.dashoffset;let u=a.opacity/255;switch(a.paint){case"rgb_color":r.strokeStyle=Nu(a.rgb_color,a.opacity,s);break;case"linear_gradient_idx":r.strokeStyle=Hb(r,e.linear_gradients[a.linear_gradient_idx],u,s,!0);break;case"radial_gradient_idx":r.strokeStyle=$b(r,e.radial_gradients[a.radial_gradient_idx],u,s,!0)}switch(a.linejoin){case w_.LINE_JOIN_MITER_CLIP:case w_.LINE_JOIN_MITER:r.lineJoin="miter";break;case w_.LINE_JOIN_ROUND:r.lineJoin="round";break;case w_.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(a.linecap){case Yy.LINE_CAP_BUTT:r.lineCap="butt";break;case Yy.LINE_CAP_ROUND:r.lineCap="round";break;case Yy.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(h)}function Hb(r,e,i,s,a=!1){if(e.stops.length===1){let I=e.stops[0];return Nu(I.rgb_color,I.opacity*i,s)}let{x1:h,y1:u,x2:f,y2:g}=e,y=new DOMPoint(h,u),w=new DOMPoint(f,g);if(a){let I=Vu(e.transform);y=I.transformPoint(y),w=I.transformPoint(w)}let E=r.createLinearGradient(y.x,y.y,w.x,w.y);for(let I of e.stops)E.addColorStop(I.offset,Nu(I.rgb_color,I.opacity*i,s));return E}function $b(r,e,i,s,a=!1){if(e.stops.length===1){let G=e.stops[0];return Nu(G.rgb_color,G.opacity*i,s)}let h=Vu(e.transform),{fx:u,fy:f,fr:g,cx:y,cy:w,r:E}=e,I=new DOMPoint(u,f),R=new DOMPoint(y,w),L=g,k=E;if(a){I=h.transformPoint(I),R=h.transformPoint(R);let G=(h.a+h.d)/2;L=g*G,k=e.r*G}let B=r.createRadialGradient(I.x,I.y,L,R.x,R.y,k);for(let G of e.stops)B.addColorStop(G.offset,Nu(G.rgb_color,G.opacity*i,s));return B}function Zb(r,e,i,s){let a=s.transform?Vu(s.transform).preMultiplySelf(e):e,h=tf(r.canvas.width,r.canvas.height),u=h.getContext("2d");for(let g of s.children)if(g.group)Zb(u,a,i,g.group);else if(g.path){let y=g.path,w=new Path2D;w.addPath(Kb(y),a),u.fill(w,Gb(y))}let f=s.clip_path_idx!=null?i.clip_paths[s.clip_path_idx]:null;f&&Wb(u,a,i,f),r.globalCompositeOperation="source-over",r.drawImage(h,0,0)}function Wb(r,e,i,s){let a=tf(r.canvas.width,r.canvas.height);Zb(a.getContext("2d"),e,i,s),r.globalCompositeOperation="destination-in",r.drawImage(a,0,0)}function Xb(r,e,i,s,a){if(s.children.length===0)return;let h=s.mask_idx!=null?i.masks[s.mask_idx]:null;h&&Xb(r,e,i,h,a);let u=r.canvas.width,f=r.canvas.height,g=tf(u,f),y=g.getContext("2d"),w=s.width,E=s.height,I=s.left,R=s.top,L=new Path2D,k=new Path2D;k.rect(I,R,w,E),L.addPath(k,e),y.clip(L);for(let X of s.children)Ub(y,e,i,X,a);let B=y.getImageData(0,0,u,f),G=B.data;if(s.mask_type===Bb.MASK_TYPE_LUMINANCE)for(let X=0;X<G.length;X+=4)G[X+3]=G[X+3]/255*(.2126*G[X]+.7152*G[X+1]+.0722*G[X+2]);y.putImageData(B,0,0),r.globalCompositeOperation="destination-in",r.drawImage(g,0,0)}function Vu(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function Yb(r,e){let i=r.step,s=r.diffs[0]*i,a=r.diffs[1]*i;e.moveTo(s,a);for(let h=0,u=2;h<r.commands.length;h++)switch(r.commands[h]){case ef.PATH_COMMAND_MOVE:s+=r.diffs[u++]*i,a+=r.diffs[u++]*i,e.moveTo(s,a);break;case ef.PATH_COMMAND_LINE:s+=r.diffs[u++]*i,a+=r.diffs[u++]*i,e.lineTo(s,a);break;case ef.PATH_COMMAND_QUAD:{let f=s+r.diffs[u++]*i,g=a+r.diffs[u++]*i;s=f+r.diffs[u++]*i,a=g+r.diffs[u++]*i,e.quadraticCurveTo(f,g,s,a);break}case ef.PATH_COMMAND_CUBIC:{let f=s+r.diffs[u++]*i,g=a+r.diffs[u++]*i,y=f+r.diffs[u++]*i,w=g+r.diffs[u++]*i;s=y+r.diffs[u++]*i,a=w+r.diffs[u++]*i,e.bezierCurveTo(f,g,y,w,s,a);break}case ef.PATH_COMMAND_CLOSE:e.closePath()}return e}function Kb(r){return Yb(r,new Path2D)}class I_{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}Tt(I_,"LRUCache");class Jy{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new vn(e,e.data)}getFromCache(e,i,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new I_(150)),this.cacheMap.get(s).get(Sl(e.toString(),i))}setInCache(e,i,s,a){this.cacheDependenciesMap.has(a)||this.cacheDependenciesMap.set(a,new Map),this.cacheMap.has(a)||this.cacheMap.set(a,new I_(150));let h=this.cacheDependenciesMap.get(a),u=Sl(e.id.toString(),s);h.get(u)||h.set(u,new Set);let f=this.cacheMap.get(a),g=e.toString();h.get(u).add(g),f.put(Sl(e.toString(),s),i)}removeImagesFromCacheByIds(e,i,s=0){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;let a=this.cacheMap.get(s),h=this.cacheDependenciesMap.get(s);for(let u of e){let f=Sl(u.toString(),i);if(h.has(f)){for(let g of h.get(f))a.delete(g);h.delete(f)}}}rasterize(e,i,s,a,h=bM){let u=this.getFromCache(e,s,a);if(u)return u.clone();let f=h(i.icon,e.options),g=Jy._getImage(f);return this.setInCache(e,g,s,a),g.clone()}}class Jb{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){let s=this.toIdx(e,i);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function Qb(r,e,i,s){let a=0,h=Number.MAX_VALUE;for(let u=0;u<3;u++)if(Math.abs(s[u])<1e-15){if(i[u]<r[u]||i[u]>e[u])return null}else{let f=1/s[u],g=(r[u]-i[u])*f,y=(e[u]-i[u])*f;if(g>y){let w=g;g=y,y=w}if(g>a&&(a=g),y<h&&(h=y),a>h)return null}return a}function ew(r,e,i,s,a,h,u,f,g,y,w){let E=s-r,I=a-e,R=h-i,L=u-r,k=f-e,B=g-i,G=w[1]*B-w[2]*k,X=w[2]*L-w[0]*B,W=w[0]*k-w[1]*L,K=E*G+I*X+R*W;if(Math.abs(K)<1e-15)return null;let pe=1/K,ce=y[0]-r,ue=y[1]-e,ge=y[2]-i,ve=(ce*G+ue*X+ge*W)*pe;if(ve<0||ve>1)return null;let Ne=ue*R-ge*I,Ee=ge*E-ce*R,Ue=ce*I-ue*E,nt=(w[0]*Ne+w[1]*Ee+w[2]*Ue)*pe;return nt<0||ve+nt>1?null:(L*Ne+k*Ee+B*Ue)*pe}function tw(r,e,i){return(r-e)/(i-e)}function iw(r,e,i,s,a,h,u,f,g){let y=1<<i,w=h-s,E=u-a,I=(r+1)/y*w+s,R=(e+0)/y*E+a,L=(e+1)/y*E+a;f[0]=(r+0)/y*w+s,f[1]=R,g[0]=I,g[1]=L}class rw{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let i=function(h){let u=Math.ceil(Math.log2(h.dim/8)),f=[],g=Math.ceil(Math.pow(2,u)),y=1/g,w=(R,L,k,B,G)=>{let X=B?1:0,W=(R+1)*k-X,K=L*k,pe=(L+1)*k-X;G[0]=R*k,G[1]=K,G[2]=W,G[3]=pe},E=new Jb(g),I=[];for(let R=0;R<g*g;R++){w(R%g,Math.floor(R/g),y,!1,I);let L=ql(I[0],I[1],h),k=ql(I[2],I[1],h),B=ql(I[2],I[3],h),G=ql(I[0],I[3],h);E.minimums.push(Math.min(L,k,B,G)),E.maximums.push(Math.max(L,k,B,G)),E.leaves.push(1)}for(f.push(E),g/=2;g>=1;g/=2){let R=f[f.length-1];E=new Jb(g);for(let L=0;L<g*g;L++){w(L%g,Math.floor(L/g),2,!0,I);let k=R.getElevation(I[0],I[1]),B=R.getElevation(I[2],I[1]),G=R.getElevation(I[2],I[3]),X=R.getElevation(I[0],I[3]),W=R.isLeaf(I[0],I[1]),K=R.isLeaf(I[2],I[1]),pe=R.isLeaf(I[2],I[3]),ce=R.isLeaf(I[0],I[3]),ue=Math.min(k.min,B.min,G.min,X.min),ge=Math.max(k.max,B.max,G.max,X.max),ve=W&&K&&pe&&ce;E.maximums.push(ge),E.minimums.push(ue),E.leaves.push(ge-ue<=5&&ve?1:0)}f.push(E)}return f}(this.dem),s=i.length-1,a=i[s];this._addNode(a.minimums[0],a.maximums[0],a.leaves[0]),this._construct(i,0,0,s,0)}raycastRoot(e,i,s,a,h,u,f=1){return Qb([e,i,-100],[s,a,this.maximums[0]*f],h,u)}raycast(e,i,s,a,h,u,f=1){if(!this.nodeCount)return null;let g=this.raycastRoot(e,i,s,a,h,u,f);if(g==null)return null;let y=[],w=[],E=[],I=[],R=[{idx:0,t:g,nodex:0,nodey:0,depth:0}];for(;R.length>0;){let{idx:L,t:k,nodex:B,nodey:G,depth:X}=R.pop();if(this.leaves[L]){iw(B,G,X,e,i,s,a,E,I);let K=1<<X,pe=(B+0)/K,ce=(B+1)/K,ue=(G+0)/K,ge=(G+1)/K,ve=ql(pe,ue,this.dem)*f,Ne=ql(ce,ue,this.dem)*f,Ee=ql(ce,ge,this.dem)*f,Ue=ql(pe,ge,this.dem)*f,nt=ew(E[0],E[1],ve,I[0],E[1],Ne,I[0],I[1],Ee,h,u),qe=ew(I[0],I[1],Ee,E[0],I[1],Ue,E[0],E[1],ve,h,u),Ke=Math.min(nt!==null?nt:Number.MAX_VALUE,qe!==null?qe:Number.MAX_VALUE);if(Ke!==Number.MAX_VALUE)return Ke;{let it=tn([],h,u,k);if(nw(ve,Ne,Ue,Ee,tw(it[0],E[0],I[0]),tw(it[1],E[1],I[1]))>=it[2])return k}continue}let W=0;for(let K=0;K<this._siblingOffset.length;K++){iw((B<<1)+this._siblingOffset[K][0],(G<<1)+this._siblingOffset[K][1],X+1,e,i,s,a,E,I),E[2]=-100,I[2]=this.maximums[this.childOffsets[L]+K]*f;let pe=Qb(E,I,h,u);if(pe!=null){let ce=pe;y[K]=ce;let ue=!1;for(let ge=0;ge<W&&!ue;ge++)ce>=y[w[ge]]&&(w.splice(ge,0,K),ue=!0);ue||(w[W]=K),W++}}for(let K=0;K<W;K++){let pe=w[K];R.push({idx:this.childOffsets[L]+pe,t:y[pe],nodex:(B<<1)+this._siblingOffset[pe][0],nodey:(G<<1)+this._siblingOffset[pe][1],depth:X+1})}}return null}_addNode(e,i,s){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,s,a,h){if(e[a].isLeaf(i,s)===1)return;this.childOffsets[h]||(this.childOffsets[h]=this.nodeCount);let u=a-1,f=e[u],g=0,y=0;for(let w=0;w<this._siblingOffset.length;w++){let E=2*i+this._siblingOffset[w][0],I=2*s+this._siblingOffset[w][1],R=f.getElevation(E,I),L=f.isLeaf(E,I),k=this._addNode(R.min,R.max,L);L&&(g|=1<<w),y||(y=k)}for(let w=0;w<this._siblingOffset.length;w++)g&1<<w||this._construct(e,2*i+this._siblingOffset[w][0],2*s+this._siblingOffset[w][1],u,y+w)}}function nw(r,e,i,s,a,h){return Bt(Bt(r,i,h),Bt(e,s,h),a)}function ql(r,e,i){let s=i.dim,a=re(r*s-.5,0,s-1),h=re(e*s-.5,0,s-1),u=Math.floor(a),f=Math.floor(h),g=Math.min(u+1,s-1),y=Math.min(f+1,s-1);return nw(i.get(u,f),i.get(g,f),i.get(u,y),i.get(g,y),a-u,h-f)}let wM={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function TM(r,e,i){return(256*r*256+256*e+i)/10-1e4}function SM(r,e,i){return 256*r+e+i/256-32768}class A_{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,s,a=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return void pi(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;let h=this.dim=i.height-2,u=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=a,this._modifiedForSources={},!a){for(let g=0;g<h;g++)u[this._idx(-1,g)]=u[this._idx(0,g)],u[this._idx(h,g)]=u[this._idx(h-1,g)],u[this._idx(g,-1)]=u[this._idx(g,0)],u[this._idx(g,h)]=u[this._idx(g,h-1)];u[this._idx(-1,-1)]=u[this._idx(0,0)],u[this._idx(h,-1)]=u[this._idx(h-1,0)],u[this._idx(-1,h)]=u[this._idx(0,h-1)],u[this._idx(h,h)]=u[this._idx(h-1,h-1)]}let f=s==="terrarium"?SM:TM;for(let g=0;g<u.length;++g){let y=4*g;this.floatView[g]=f(this.pixels[y],this.pixels[y+1],this.pixels[y+2])}this._timestamp=Wo.now()}_buildQuadTree(){this._tree=new rw(this)}get(e,i,s=!1){s&&(e=re(e,-1,this.dim),i=re(i,-1,this.dim));let a=this._idx(e,i);return this.floatView[a]}set(e,i,s){let a=this._idx(e,i),h=this.floatView[a];return this.floatView[a]=s,s-h}static getUnpackVector(e){return wM[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){let s=[0,0,0,0],a=A_.getUnpackVector(i),h=Math.floor((e+a[3])/a[2]);return s[2]=h%256,h=Math.floor(h/256),s[1]=h%256,h=Math.floor(h/256),s[0]=h,s}getPixels(){return new Qx({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=i*this.dim,h=i*this.dim+this.dim,u=s*this.dim,f=s*this.dim+this.dim;switch(i){case-1:a=h-1;break;case 1:h=a+1}switch(s){case-1:u=f-1;break;case 1:f=u+1}let g=-i*this.dim,y=-s*this.dim;for(let w=u;w<f;w++)for(let E=a;E<h;E++){let I=4*this._idx(E,w),R=4*this._idx(E+g,w+y);this.pixels[I+0]=e.pixels[R+0],this.pixels[I+1]=e.pixels[R+1],this.pixels[I+2]=e.pixels[R+2],this.pixels[I+3]=e.pixels[R+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function EM(r,e,i){r===1?e.headerLength=i.readFixed32():r===2?e.x=i.readVarint():r===3?e.y=i.readVarint():r===4?e.z=i.readVarint():r===5&&e.layers.push(function(s,a){return s.readFields(PM,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},a)}(i,i.readVarint()+i.pos))}function IM(r,e,i){r===1?(e.delta_filter=function(s,a){return s.readFields(AM,{blockSize:0},a)}(i,i.readVarint()+i.pos),e.filter="delta_filter"):r===2?(i.readVarint(),e.filter="zigzag_filter"):r===3?(i.readVarint(),e.filter="bitshuffle_filter"):r===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function AM(r,e,i){r===1&&(e.blockSize=i.readVarint())}function MM(r,e,i){r===1?(i.readVarint(),e.codec="gzip_data"):r===2?(i.readVarint(),e.codec="jpeg_image"):r===3?(i.readVarint(),e.codec="webp_image"):r===4&&(i.readVarint(),e.codec="png_image")}function CM(r,e,i){let s=0,a=0;r===1?e.firstByte=i.readFixed64():r===2?e.lastByte=i.readFixed64():r===3?e.filters.push(function(h,u){return h.readFields(IM,{},u)}(i,i.readVarint()+i.pos)):r===4?e.codec=function(h,u){return h.readFields(MM,{},u)}(i,i.readVarint()+i.pos):r===5?a=i.readFloat():r===6?s=i.readFloat():r===7?e.bands.push(i.readString()):r===8?e.offset=i.readDouble():r===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=a),e.scale===0&&(e.scale=s)}function PM(r,e,i){r===1?e.version=i.readVarint():r===2?e.name=i.readString():r===3?e.units=i.readString():r===4?e.tileSize=i.readVarint():r===5?e.buffer=i.readVarint():r===6?e.pixelFormat=i.readVarint():r===7&&e.dataIndex.push(function(s,a){return s.readFields(CM,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},a)}(i,i.readVarint()+i.pos))}function RM(r,e,i){if(r===2)(function(s,a,h){s.readFields(LM,h,a)})(i,i.readVarint()+i.pos,e);else if(r===3)throw new Error("Not implemented")}function LM(r,e,i){if(r===1){let s=0,a=i.readVarint()+i.pos;for(;i.pos<a;)e[s++]=i.readVarint()}}function zM(r,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let s=2;s>=1;s--){let a=s===1?1:0,h=s===2?1:0;for(let u=0;u<e[0];u++){let f=e[1]*u;for(let g=a;g<e[1];g++){let y=e[2]*(g+f);for(let w=h;w<e[2];w++){let E=e[3]*(w+y);for(let I=0;I<e[3];I++){let R=E+I;r[R]+=r[R-i]}}}}i*=e[s]}return r}function DM(r){for(let e=0,i=r.length;e<i;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function OM(r,e){switch(e){case"uint32":return r;case"uint16":for(let i=0;i<r.length;i+=2){let s=r[i],a=r[i+1];r[i]=(240&s)>>4|(61440&s)>>8|(240&a)<<4|61440&a,r[i+1]=15&s|(3840&s)>>4|(15&a)<<8|(3840&a)<<4}return r;case"uint8":for(let i=0;i<r.length;i+=4){let s=r[i],a=r[i+1],h=r[i+2],u=r[i+3];r[i+0]=(192&s)>>6|(192&a)>>4|(192&h)>>2|192&u,r[i+1]=(48&s)>>4|(48&a)>>2|48&h|(48&u)<<2,r[i+2]=(12&s)>>2|12&a|(12&h)<<2|(12&u)<<4,r[i+3]=3&s|(3&a)<<2|(3&h)<<4|(3&u)<<6}return r;default:throw new Error(`Invalid pixel format, "${e}"`)}}Tt(A_,"DEMData"),Tt(rw,"DemMinMaxQuadTree",{omit:["dem"]});var Qo=Uint8Array,rf=Uint16Array,kM=Int32Array,ow=new Qo([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),sw=new Qo([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),FM=new Qo([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),aw=function(r,e){for(var i=new rf(31),s=0;s<31;++s)i[s]=e+=1<<r[s-1];var a=new kM(i[30]);for(s=1;s<30;++s)for(var h=i[s];h<i[s+1];++h)a[h]=h-i[s]<<5|s;return{b:i,r:a}},lw=aw(ow,2),cw=lw.b,BM=lw.r;cw[28]=258,BM[258]=28;for(var NM=aw(sw,0).b,hw=new rf(32768),en=0;en<32768;++en){var Uu=(43690&en)>>1|(21845&en)<<1;hw[en]=((65280&(Uu=(61680&(Uu=(52428&Uu)>>2|(13107&Uu)<<2))>>4|(3855&Uu)<<4))>>8|(255&Uu)<<8)>>1}var nf=function(r,e,i){for(var s=r.length,a=0,h=new rf(e);a<s;++a)r[a]&&++h[r[a]-1];var u,f=new rf(e);for(a=1;a<e;++a)f[a]=f[a-1]+h[a-1]<<1;u=new rf(1<<e);var g=15-e;for(a=0;a<s;++a)if(r[a])for(var y=a<<4|r[a],w=e-r[a],E=f[r[a]-1]++<<w,I=E|(1<<w)-1;E<=I;++E)u[hw[E]>>g]=y;return u},of=new Qo(288);for(en=0;en<144;++en)of[en]=8;for(en=144;en<256;++en)of[en]=9;for(en=256;en<280;++en)of[en]=7;for(en=280;en<288;++en)of[en]=8;var uw=new Qo(32);for(en=0;en<32;++en)uw[en]=5;var VM=nf(of,9),UM=nf(uw,5),Qy=function(r){for(var e=r[0],i=1;i<r.length;++i)r[i]>e&&(e=r[i]);return e},Ds=function(r,e,i){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(7&e)&i},e0=function(r,e){var i=e/8|0;return(r[i]|r[i+1]<<8|r[i+2]<<16)>>(7&e)},jM=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Os=function(r,e,i){var s=new Error(e||jM[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,Os),!i)throw s;return s},GM=new Qo(0),qM=typeof TextDecoder<"u"&&new TextDecoder;try{qM.decode(GM,{stream:!0})}catch{}let HM={gzip_data:"gzip"};class ds extends Error{constructor(e){super(e),this.name="MRTError"}}let $M={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},dw={uint32:1,uint16:2,uint8:4},ZM={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},t0;class M_{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){let i=this.layers[e];if(!i)throw new ds(`Layer '${e}' not found`);return i}getHeaderLength(e){let i=new Uint8Array(e),s=new DataView(e);if(i[0]!==13)throw new ds("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){let i=new Uint8Array(e),s=this.getHeaderLength(e);if(i.length<s)throw new ds(`Expected header with length >= ${s} but got buffer of length ${i.length}`);let a=new t0(i.subarray(0,s)).readFields(EM,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==a.x||this.y!==a.y||this.z!==a.z))throw new ds(`Invalid attempt to parse header ${a.z}/${a.x}/${a.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=a.x,this.y=a.y,this.z=a.z;for(let h of a.layers)this.layers[h.name]=new pw(h,{cacheSize:this._cacheSize});return this}createDecodingTask(e){let i=[],s=this.getLayer(e.layerName);for(let a of e.blockIndices){let h=s.dataIndex[a],u=h.firstByte-e.firstByte,f=h.lastByte-e.firstByte;if(s._blocksInProgress.has(a))continue;let g={layerName:s.name,firstByte:u,lastByte:f,pixelFormat:s.pixelFormat,blockIndex:a,blockShape:[h.bands.length].concat(s.bandShape),buffer:s.buffer,codec:h.codec.codec,filters:h.filters.map(y=>y.filter)};s._blocksInProgress.add(a),i.push(g)}return new fw(i,()=>{i.forEach(a=>s._blocksInProgress.delete(a.blockIndex))},(a,h)=>{if(i.forEach(u=>s._blocksInProgress.delete(u.blockIndex)),a)throw a;h.forEach(u=>{this.getLayer(u.layerName).processDecodedData(u)})})}}class pw{constructor({version:e,name:i,units:s,tileSize:a,pixelFormat:h,buffer:u,dataIndex:f},g){if(this.version=e,this.version!==1)throw new ds(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=s,this.tileSize=a,this.buffer=u,this.pixelFormat=$M[h],this.dataIndex=f,this.bandShape=[a+2*u,a+2*u,dw[this.pixelFormat]],this._decodedBlocks=new I_(g?g.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return dw[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){let i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(let[s,a]of this.dataIndex.entries()){for(let[h,u]of a.bands.entries())if(u===e)return{bandIndex:i+h,blockIndex:s,blockBandIndex:h};i+=a.bands.length}break;case"number":for(let[s,a]of this.dataIndex.entries()){if(e>=i&&e<i+a.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-i};i+=a.bands.length}break;default:throw new ds(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,s=-1/0,a=[],h=new Set;for(let u of e){let{blockIndex:f}=this.getBlockForBand(u);if(f<0)throw new ds(`Invalid band: ${JSON.stringify(u)}`);let g=this.dataIndex[f];a.includes(f)||a.push(f),h.add(f),i=Math.min(i,g.firstByte),s=Math.max(s,g.lastByte)}if(h.size>this.cacheSize)throw new ds(`Number of blocks to decode (${h.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:s,blockIndices:a}}hasBand(e){let{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){let{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){let{blockIndex:i,blockBandIndex:s}=this.getBlockForBand(e);if(i<0)throw new ds(`Band not found: ${JSON.stringify(e)}`);let a=this._decodedBlocks.get(i.toString());if(!a)throw new ds(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);let h=this.dataIndex[i],u=this.bandShape.reduce((y,w)=>y*w,1),f=s*u,g=a.subarray(f,f+u);return{data:g,bytes:new Uint8Array(g.buffer).subarray(g.byteOffset,g.byteOffset+g.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:h.offset,scale:h.scale}}}M_.setPbf=function(r){t0=r};class fw{constructor(e,i,s){this.tasks=e,this._onCancel=i,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}M_.performDecoding=function(r,e){let i=new Uint8Array(r);return Promise.all(e.tasks.map(s=>{let{layerName:a,firstByte:h,lastByte:u,pixelFormat:f,blockShape:g,blockIndex:y,filters:w,codec:E}=s,I=i.subarray(h,u+1),R=new Uint32Array(g[0]*g[1]*g[2]),L;if(E!=="gzip_data")throw new ds(`Unhandled codec: ${E}`);return L=function(k,B){if(!globalThis.DecompressionStream&&B==="gzip_data")return Promise.resolve(((K=function(ue){ue[0]==31&&ue[1]==139&&ue[2]==8||Os(6,"invalid gzip data");var ge=ue[3],ve=10;4&ge&&(ve+=2+(ue[10]|ue[11]<<8));for(var Ne=(ge>>3&1)+(ge>>4&1);Ne>0;Ne-=!ue[ve++]);return ve+(2&ge)}(W=k))+8>W.length&&Os(6,"invalid gzip data"),function(ue,ge,ve,Ne){var Ee=ue.length;if(!Ee||ge.f&&!ge.l)return ve||new Qo(0);var Ue=!ve,nt=Ue||ge.i!=2,qe=ge.i;Ue&&(ve=new Qo(3*Ee));var Ke,it,Fe=function(xr){var rr=ve.length;if(xr>rr){var Qi=new Qo(Math.max(2*rr,xr));Qi.set(ve),ve=Qi}},Je=ge.f||0,Ie=ge.p||0,Be=ge.b||0,at=ge.l,et=ge.d,Lt=ge.m,St=ge.n,Xe=8*Ee;do{if(!at){Je=Ds(ue,Ie,1);var tt=Ds(ue,Ie+1,3);if(Ie+=3,!tt){var It=ue[(ee=4+((Ie+7)/8|0))-4]|ue[ee-3]<<8,xt=ee+It;if(xt>Ee){qe&&Os(0);break}nt&&Fe(Be+It),ve.set(ue.subarray(ee,xt),Be),ge.b=Be+=It,ge.p=Ie=8*xt,ge.f=Je;continue}if(tt==1)at=VM,et=UM,Lt=9,St=5;else if(tt==2){var ut=Ds(ue,Ie,31)+257,vt=Ds(ue,Ie+10,15)+4,Vt=ut+Ds(ue,Ie+5,31)+1;Ie+=14;for(var Zt=new Qo(Vt),Qt=new Qo(19),Kt=0;Kt<vt;++Kt)Qt[FM[Kt]]=Ds(ue,Ie+3*Kt,7);Ie+=3*vt;var fi=Qy(Qt),oi=(1<<fi)-1,ir=nf(Qt,fi);for(Kt=0;Kt<Vt;){var ee,te=ir[Ds(ue,Ie,oi)];if(Ie+=15&te,(ee=te>>4)<16)Zt[Kt++]=ee;else{var Oe=0,lt=0;for(ee==16?(lt=3+Ds(ue,Ie,3),Ie+=2,Oe=Zt[Kt-1]):ee==17?(lt=3+Ds(ue,Ie,7),Ie+=3):ee==18&&(lt=11+Ds(ue,Ie,127),Ie+=7);lt--;)Zt[Kt++]=Oe}}var pt=Zt.subarray(0,ut),dt=Zt.subarray(ut);Lt=Qy(pt),St=Qy(dt),at=nf(pt,Lt),et=nf(dt,St)}else Os(1);if(Ie>Xe){qe&&Os(0);break}}nt&&Fe(Be+131072);for(var Et=(1<<Lt)-1,qt=(1<<St)-1,ci=Ie;;ci=Ie){var hi=(Oe=at[e0(ue,Ie)&Et])>>4;if((Ie+=15&Oe)>Xe){qe&&Os(0);break}if(Oe||Os(2),hi<256)ve[Be++]=hi;else{if(hi==256){ci=Ie,at=null;break}var ii=hi-254;hi>264&&(ii=Ds(ue,Ie,(1<<(ei=ow[Kt=hi-257]))-1)+cw[Kt],Ie+=ei);var Gi=et[e0(ue,Ie)&qt],Tr=Gi>>4;if(Gi||Os(3),Ie+=15&Gi,dt=NM[Tr],Tr>3){var ei=sw[Tr];dt+=e0(ue,Ie)&(1<<ei)-1,Ie+=ei}if(Ie>Xe){qe&&Os(0);break}nt&&Fe(Be+131072);var ar=Be+ii;if(Be<dt){var Ji=0-dt,Bi=Math.min(dt,ar);for(Ji+Be<0&&Os(3);Be<Bi;++Be)ve[Be]=(void 0)[Ji+Be]}for(;Be<ar;++Be)ve[Be]=ve[Be-dt]}}ge.l=at,ge.p=ci,ge.b=Be,ge.f=Je,at&&(Je=1,ge.m=Lt,ge.d=et,ge.n=St)}while(!Je);return Be!=ve.length&&Ue?(Ke=ve,((it=Be)==null||it>Ke.length)&&(it=Ke.length),new Qo(Ke.subarray(0,it))):ve.subarray(0,Be)}(W.subarray(K,-8),{i:2},new Qo(((G=W)[(X=G.length)-4]|G[X-3]<<8|G[X-2]<<16|G[X-1]<<24)>>>0))));var G,X,W,K;let pe=HM[B];if(!pe)throw new Error(`Unhandled codec: ${B}`);let ce=new globalThis.DecompressionStream(pe);return new Response(new Blob([k]).stream().pipeThrough(ce)).arrayBuffer().then(ue=>new Uint8Array(ue))}(I,E).then(k=>(function(B,G){B.readFields(RM,G)}(new t0(k),R),new ZM[f](R.buffer))),L.then(k=>{for(let B=w.length-1;B>=0;B--)switch(w[B]){case"delta_filter":zM(k,g);break;case"zigzag_filter":DM(k);break;case"bitshuffle_filter":OM(k,f);break;default:throw new ds(`Unhandled filter "${w[B]}"`)}return{layerName:a,blockIndex:y,data:k}}).catch(k=>{throw k})}))},Tt(fw,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Tt(M_,"MapboxRasterTile"),Tt(pw,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class mw{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){let s=e[i];this._stringToNumber[s]=i,this._numberToString[i]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}let WM=["id","tile","layer","source","sourceLayer","state"];class ju{constructor(e,i,s,a,h){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=s,this._y=a,this.properties=e.properties,this.id=h}clone(){let e=new ju(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){let e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let i of WM)this[i]!==void 0&&(e[i]=this[i]);return e}}class _w{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new ia(ht,16,0),this.featureIndexArray=new Em,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,s,a,h,u=0,f=0){let g=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,a,h,u);let y=this.grid;for(let w=0;w<i.length;w++){let E=i[w],I=[1/0,1/0,-1/0,-1/0];for(let R=0;R<E.length;R++){let L=E[R];I[0]=Math.min(I[0],L.x),I[1]=Math.min(I[1],L.y),I[2]=Math.max(I[2],L.x),I[3]=Math.max(I[3],L.y)}f!==0&&(I[0]-=f,I[1]-=f,I[2]+=f,I[3]+=f),I[0]<ht&&I[1]<ht&&I[2]>=0&&I[3]>=0&&y.insert(g,I[0],I[1],I[2],I[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Mt(new i_(this.rawTileData)).layers,this.sourceLayerCoder=new mw(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(let e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){let{tilespaceGeometry:s,transform:a,tileTransform:h,pixelPosMatrix:u,availableImages:f,worldview:g}=i;this.loadVTLayers(),this.serializedLayersCache.clear();let y=s.bufferedTilespaceBounds,w=this.grid.query(y.min.x,y.min.y,y.max.x,y.max.y,(L,k,B,G)=>Cr(s.bufferedTilespaceGeometry,L,k,B,G));w.sort(XM);let E=null;a.elevation&&w.length>0&&(E=Bu.create(a.elevation,this.tileID));let I={},R;for(let L=0;L<w.length;L++){let k=w[L];if(k===R)continue;R=k;let B=this.featureIndexArray.get(k),G=null;this.is3DTile?this.loadMatchingModelFeature(I,B,e,s,a,g):this.loadMatchingFeature(I,B,e,f,g,(X,W,K,pe=0)=>(G||(G=me(X,this.tileID.canonical,h)),W.queryIntersectsFeature(s,X,K,G,this.z,a,u,E,pe)))}return I}loadMatchingFeature(e,i,s,a,h,u){let{featureIndex:f,bucketIndex:g,sourceLayerIndex:y,layoutVertexArrayOffset:w}=i,E=this.bucketLayerIDs[g],I=s.layers,R=Object.keys(I);if(R.length&&!di(R,E))return;let L=s.sourceCache,k=this.sourceLayerCoder.decode(y),B=this.vtLayers[k].feature(f),G=this.getId(B,k);for(let X=0;X<E.length;X++){let W=E[X];if(!I[W])continue;let{styleLayer:K,targets:pe}=I[W],ce={};G!==void 0&&(ce=L.getFeatureState(K.sourceLayer,G));let ue=!u||u(B,K,ce,w);if(!ue)continue;let ge=new ju(B,this.z,this.x,this.y,G);ge.tile=this.tileID.canonical,ge.state=ce;let ve=this.serializedLayersCache.get(W);ve||(ve=K.serialize(),ve.id=W,this.serializedLayersCache.set(W,ve)),ge.source=ve.source,ge.sourceLayer=ve["source-layer"],ge.layer=Le({},ve),ge.layer.paint=gw(ve.paint,K.paint,B,ce,a),ge.layer.layout=gw(ve.layout,K.layout,B,ce,a);let Ne=!1;for(let Ee of pe){this.updateFeatureProperties(ge,Ee);let{filter:Ue}=Ee;if(Ue){if(B.properties=ge.properties,Ue.needGeometry){let nt=ke(B,!0);if(!Ue.filter(new ji(this.tileID.overscaledZ,{worldview:h}),nt,this.tileID.canonical))continue}else if(!Ue.filter(new ji(this.tileID.overscaledZ,{worldview:h}),B))continue}Ne=!0,Ee.targetId&&this.addFeatureVariant(ge,Ee)}Ne&&this.appendToResult(e,W,f,ge,ue)}}loadMatchingModelFeature(e,i,s,a,h,u){let{featureIndex:f,bucketIndex:g}=i,y=this.bucketLayerIDs[g],w=s.layers,E=Object.keys(w);if(!E.length||di(E,y))for(let I=0;I<y.length;I++){let R=y[I],{styleLayer:L,targets:k}=w[R];if(L.type!=="model")continue;let B=a.tile,G=B.getBucket(L);if(!(G&&G instanceof b_))continue;let X=eM(G,f,a,h);if(!X)continue;let{z:W,x:K,y:pe}=B.tileID.canonical,{feature:ce,intersectionZ:ue,position:ge}=X,ve={};ce.id!==void 0&&(ve=s.sourceCache.getFeatureState(L.sourceLayer,ce.id));let Ne=new ju({},W,K,pe,ce.id);Ne.tile=this.tileID.canonical,Ne.state=ve,Ne.properties=ce.properties,Ne.geometry={type:"Point",coordinates:[ge.lng,ge.lat]};let Ee=this.serializedLayersCache.get(R);Ee||(Ee=L.serialize(),Ee.id=R,this.serializedLayersCache.set(R,Ee)),Ne.source=Ee.source,Ne.sourceLayer=Ee["source-layer"],Ne.layer=Le({},Ee);let Ue=!1;for(let nt of k){this.updateFeatureProperties(Ne,nt);let{filter:qe}=nt;if(qe){if(ce.properties=Ne.properties,qe.needGeometry){if(!qe.filter(new ji(this.tileID.overscaledZ,{worldview:u}),ce,this.tileID.canonical))continue}else if(!qe.filter(new ji(this.tileID.overscaledZ,{worldview:u}),ce))continue}Ue=!0,nt.targetId&&this.addFeatureVariant(Ne,nt)}Ue&&this.appendToResult(e,R,f,Ne,ue)}}updateFeatureProperties(e,i,s){if(i.properties){let a={};for(let h in i.properties){let u=i.properties[h].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);u!=null&&(a[h]=u)}e.properties=a}}addFeatureVariant(e,i,s){let a={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(a.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(a)}appendToResult(e,i,s,a,h){let u=e[i];u===void 0&&(u=e[i]=[]),u.push({featureIndex:s,feature:a,intersectionZ:h})}lookupSymbolFeatures(e,i,s,a,h,u){let f={};this.loadVTLayers();for(let g of e)this.loadMatchingFeature(f,{bucketIndex:i,sourceLayerIndex:s,featureIndex:g,layoutVertexArrayOffset:0},a,h,u);return f}loadFeature(e){let{featureIndex:i,sourceLayerIndex:s}=e;this.loadVTLayers();let a=this.sourceLayerCoder.decode(s),h=this.vtFeatures[a];if(h[i])return h[i];let u=this.vtLayers[a].feature(i);return h[i]=u,u}hasLayer(e){for(let i of this.bucketLayerIDs)for(let s of i)if(e===s)return!0;return!1}getId(e,i){let s=e.id;if(this.promoteId){let a=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(a!=null)if(Array.isArray(a)){if(!this.promoteIdExpression){let h=Da(a);if(h.result!=="success"){let u=h.value.map(f=>`${f.key}: ${f.message}`).join(", ");return void pi(`Failed to create expression for promoteId: ${u}`)}this.promoteIdExpression=h.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Pc),s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[a];typeof s=="boolean"&&(s=Number(s))}return s}}function gw(r,e,i,s,a){return Xt(r,(h,u)=>{let f=e instanceof Ko?e.get(u):null;return f&&f.evaluate?f.evaluate(i,s,void 0,a):f})}function XM(r,e){return e-r}Tt(_w,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let yw=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class i0{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[i,s]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");let a=s>>4;if(a!==1)throw new Error(`Got v${a} data when expected v1.`);let h=yw[15&s];if(!h)throw new Error("Unrecognized array type.");let[u]=new Uint16Array(e,2,1),[f]=new Uint32Array(e,4,1);return new i0(f,u,h,e)}constructor(e,i=64,s=Float64Array,a){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;let h=yw.indexOf(this.ArrayType),u=2*e*this.ArrayType.BYTES_PER_ELEMENT,f=e*this.IndexArrayType.BYTES_PER_ELEMENT,g=(8-f%8)%8;if(h<0)throw new Error(`Unexpected typed array class: ${s}.`);a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+g,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+u+f+g),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+f+g,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+h]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){let s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=i,s}finish(){let e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return r0(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,s,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:h,coords:u,nodeSize:f}=this,g=[0,h.length-1,0],y=[];for(;g.length;){let w=g.pop()||0,E=g.pop()||0,I=g.pop()||0;if(E-I<=f){for(let B=I;B<=E;B++){let G=u[2*B],X=u[2*B+1];G>=e&&G<=s&&X>=i&&X<=a&&y.push(h[B])}continue}let R=I+E>>1,L=u[2*R],k=u[2*R+1];L>=e&&L<=s&&k>=i&&k<=a&&y.push(h[R]),(w===0?e<=L:i<=k)&&(g.push(I),g.push(R-1),g.push(1-w)),(w===0?s>=L:a>=k)&&(g.push(R+1),g.push(E),g.push(1-w))}return y}within(e,i,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:a,coords:h,nodeSize:u}=this,f=[0,a.length-1,0],g=[],y=s*s;for(;f.length;){let w=f.pop()||0,E=f.pop()||0,I=f.pop()||0;if(E-I<=u){for(let B=I;B<=E;B++)vw(h[2*B],h[2*B+1],e,i)<=y&&g.push(a[B]);continue}let R=I+E>>1,L=h[2*R],k=h[2*R+1];vw(L,k,e,i)<=y&&g.push(a[R]),(w===0?e-s<=L:i-s<=k)&&(f.push(I),f.push(R-1),f.push(1-w)),(w===0?e+s>=L:i+s>=k)&&(f.push(R+1),f.push(E),f.push(1-w))}return g}}function r0(r,e,i,s,a,h){if(a-s<=i)return;let u=s+a>>1;xw(r,e,u,s,a,h),r0(r,e,i,s,u-1,1-h),r0(r,e,i,u+1,a,1-h)}function xw(r,e,i,s,a,h){for(;a>s;){if(a-s>600){let y=a-s+1,w=i-s+1,E=Math.log(y),I=.5*Math.exp(2*E/3),R=.5*Math.sqrt(E*I*(y-I)/y)*(w-y/2<0?-1:1);xw(r,e,i,Math.max(s,Math.floor(i-w*I/y+R)),Math.min(a,Math.floor(i+(y-w)*I/y+R)),h)}let u=e[2*i+h],f=s,g=a;for(sf(r,e,s,i),e[2*a+h]>u&&sf(r,e,s,a);f<g;){for(sf(r,e,f,g),f++,g--;e[2*f+h]<u;)f++;for(;e[2*g+h]>u;)g--}e[2*s+h]===u?sf(r,e,s,g):(g++,sf(r,e,g,a)),g<=i&&(s=g+1),i<=g&&(a=g-1)}}function sf(r,e,i,s){n0(r,i,s),n0(e,2*i,2*s),n0(e,2*i+1,2*s+1)}function n0(r,e,i){let s=r[e];r[e]=r[i],r[i]=s}function vw(r,e,i,s){let a=r-i,h=e-s;return a*a+h*h}n.$=cn,n.A=As,n.B=Cs,n.C=Sl,n.D=Mu,n.E=Ea,n.F=2,n.G=Hp,n.H=$1,n.I=Kn,n.J=Hs,n.K=class extends v_{},n.L=Ia,n.M=ym,n.N=nu,n.O=ru,n.P=Qe,n.Q=lm,n.R=yc,n.S=Hd,n.T=yy,n.U=Gc,n.V=v_,n.W=$d,n.X=Da,n.Y=Gh,n.Z=ml,n._=fl,n.a=function(r){return mn.API_CDN_URL_REGEX.test(r)},n.a$=He,n.a0=fd,n.a1=qc,n.a2=ou,n.a3=am,n.a4=function(r){let e=r.value,i=[];if(!e)return i;let s=Hs(e);return s!=="string"?(i=i.concat([new v_(r.key,e,`string expected, "${s}" found`)]),i):(Hy(e,!0)||(i=i.concat([new v_(r.key,e,`invalid url "${e}"`)])),i)},n.a5=Se,n.a6=jc,n.a7=Ar,n.a8=ot,n.a9=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return $r(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Bt(r.x,e.x,i),y:Bt(r.y,e.y,i),z:Bt(r.z,e.z,i),azimuthal:Bt(r.azimuthal,e.azimuthal,i),polar:Bt(r.polar,e.polar,i)}}},n.aA=Yn,n.aB=Cn,n.aC=xn,n.aD=F,n.aE=_e,n.aF=function(r,e){let i={};for(let s=0;s<e.length;s++){let a=e[s];a in r&&(i[a]=r[a])}return i},n.aG=z,n.aH=j,n.aI=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,i,s){let a=this.entries[r]=this.entries[r]||{callbacks:[]};if(a.result){let[h,u]=a.result;return this.scheduler?this.scheduler.add(()=>{s(h,u)},e):s(h,u),()=>{}}return a.callbacks.push(s),a.cancel||(a.cancel=i((h,u)=>{a.result=[h,u];for(let f of a.callbacks)this.scheduler?this.scheduler.add(()=>{f(h,u)},e):f(h,u);setTimeout(()=>delete this.entries[r],3e3)})),()=>{a.result||(a.callbacks=a.callbacks.filter(h=>h!==s),a.callbacks.length||(a.cancel(),delete this.entries[r]))}}},n.aJ=function(r,e,i){let s=JSON.stringify(r.request);return r.data&&(this.deduped.entries[s]={result:[null,r.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},a=>{let h=xc(r.request,(u,f,g,y)=>{u?a(u):f&&a(null,{vectorTile:i?void 0:new Mt(new i_(f)),rawData:f,cacheControl:g,expires:y})});return()=>{h.cancel(),a()}},e)},n.aK=function(r){cd++,cd>Is&&(r.getActor().send("enforceCacheSizeLimit",Xo),cd=0)},n.aL=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log(r)/Math.LN2))},n.aM=Xr,n.aN=bb,n.aO=Ab,n.aP=vb,n.aQ=function(r,e){let i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let s=0;s<r.length;s++){let a=document.createElement("source");ug(r[s])||(i.crossOrigin="Anonymous"),a.src=r[s],i.appendChild(a)}return{cancel:()=>{}}},n.aR=Np,n.aS=function(r){return fetch(r).then(e=>e.arrayBuffer()).then(e=>Jv(e,0,r))},n.aT=s1,n.aU=class{constructor(r,e,i,s){this.id=r,this.position=e!=null?new C(e[0],e[1]):new C(0,0),this.orientation=i??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new li([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(r,e){if(Te(r.matrix,e,r.matrix),r.meshes)for(let i of r.meshes){let s=li.applyTransformFast(i.aabb,r.matrix);this.aabb.encapsulate(s)}if(r.children)for(let i of r.children)this._applyTransformations(i,r.matrix)}computeBoundsAndApplyParent(){let r=xe([]);for(let e of this.nodes)this._applyTransformations(e,r)}computeModelMatrix(r,e,i,s,a,h,u=!1){n1(this.matrix,this,r.transform,this.position,e,i,s,a,h,u)}upload(r){if(!this.uploaded){for(let e of this.nodes)by(e,r);for(let e of this.nodes)t_(e);this.uploaded=!0}}destroy(){for(let r of this.nodes)wy(r)}},n.aV=Ht,n.aW=Wp,n.aX=Z,n.aY=Y,n.aZ=Il,n.a_=ur,n.aa=ji,n.ab=ta,n.ac=le,n.ad=Lr,n.ae=Ni,n.af=ye,n.ag=Ko,n.ah=Fl,n.ai=Bt,n.aj=ht,n.ak=kf,n.al=Ai,n.am=ki,n.an=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return function([i,s]){let a=$r([1,i,s]);return{x:a.x,y:a.y,z:a.z}}(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Bt(r.x,e.x,i),y:Bt(r.y,e.y,i),z:Bt(r.z,e.z,i)}}},n.ao=function(r,e,i=0,s=!0){let a=new Qe(i,i),h=r.sub(a),u=e.add(a),f=[h,new Qe(u.x,h.y),u,new Qe(h.x,u.y)];return s&&f.push(h.clone()),f},n.ap=function(r,e){let i=[];for(let s=0;s<r.length;s++){let a=De(s-1,-1,r.length-1),h=De(s+1,-1,r.length-1),u=r[s],f=r[h],g=r[a].sub(u).unit(),y=f.sub(u).unit(),w=y.angleWithSep(g.x,g.y),E=g.add(y).unit().mult(-1*e/Math.sin(w/2));i.push(u.add(E))}return i},n.aq=sb,n.ar=Cr,n.as=function(r,e,i=0){return yi(((e.x-i)*r.scale-r.x)*ht,(e.y*r.scale-r.y)*ht,Q(e.z,e.y))},n.at=zr,n.au=Oi,n.av=Si,n.aw=g1,n.ax=function(r){let e=1/0,i=1/0,s=-1/0,a=-1/0;for(let h of r)e=Math.min(e,h.x),i=Math.min(i,h.y),s=Math.max(s,h.x),a=Math.max(a,h.y);return{min:new Qe(e,i),max:new Qe(s,a)}},n.ay=re,n.az=Te,n.b=function(r){return mn.API_FONTS_REGEX.test(r)},n.b$=ky,n.b0=wm,n.b1=__,n.b2=function(){as.isLoading()||as.isLoaded()||Qd()!=="deferred"||mm()},n.b3=wl,n.b4=ke,n.b5=ju,n.b6=Pi,n.b7=Ey,n.b8=ry,n.b9=me,n.bA=function(r,e){let{x:i,y:s}=r.point,a=Vx(i,s,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Te(a,a,Zg(ca(e)))},n.bB=H,n.bC=nc,n.bD=function(r,e){return Math.hypot(e[0]-r[0],e[1]-r[1],e[2]-r[2])},n.bE=tn,n.bF=Vr,n.bG=or,n.bH=qp,n.bI=Io,n.bJ=Ly,n.bK=function(r,e,i,s,a){let h=5*e+2;r.float32[h+0]=i,r.float32[h+1]=s,r.float32[h+2]=a},n.bL=m_,n.bM=uo,n.bN=Vs,n.bO=Ns,n.bP=po,n.bQ=De,n.bR=function(r,e,i,s){var a=new V(4);return a[0]=r,a[1]=e,a[2]=i,a[3]=s,a},n.bS=Wm,n.bT=$i,n.bU=dn,n.bV=gv,n.bW=Mb,n.bX=bv,n.bY=sy,n.bZ=Ry,n.b_=Q1,n.ba=$n,n.bb=pp,n.bc=Dx,n.bd=gr,n.be=Iu,n.bf=Gy,n.bg=function(r,e){let i=Fl(e.zoom);if(i===0)return ca(r);let s=Fm(r),a=$g(s),h=F(s.getWest())*e.worldSize,u=F(s.getEast())*e.worldSize,f=j(s.getNorth())*e.worldSize,g=j(s.getSouth())*e.worldSize,y=[h,f,0],w=[u,f,0],E=[h,g,0],I=[u,g,0],R=Ge([],e.globeMatrix);return Lr(y,y,R),Lr(w,w,R),Lr(E,E,R),Lr(I,I,R),a[0]=Ua(a[0],E,i),a[1]=Ua(a[1],I,i),a[2]=Ua(a[2],w,i),a[3]=Ua(a[3],y,i),li.fromPoints(a)},n.bh=Nm,n.bi=Ge,n.bj=Tp,n.bk=Ua,n.bl=El,n.bm=AE,n.bn=wt,n.bo=We,n.bp=M_,n.bq=i_,n.br=xc,n.bs=function(r,e){let i=[];for(let s in r)s in e||i.push(s);return i},n.bt=be,n.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],n.bv=Ss,n.bw=function(r){var e=new V(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e},n.bx=xe,n.by=At,n.bz=Ae,n.c=Sh,n.c$=45,n.c0=i0,n.c1=Xi,n.c2=Bs,n.c3=bs,n.c4=function(r,e,i){i*=.5;var s=e[0],a=e[1],h=e[2],u=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+a*f,r[1]=a*g-s*f,r[2]=h*g+u*f,r[3]=u*g-h*f,r},n.c5=xa,n.c6=wr,n.c7=function(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r},n.c8=Ft,n.c9=function(r,e,i,s,a){var h,u=1/Math.tan(e/2);return r[0]=u/i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=u,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,a!=null&&a!==1/0?(r[10]=(a+s)*(h=1/(s-a)),r[14]=2*a*s*h):(r[10]=-1,r[14]=-2*s),r},n.cA=To,n.cB=Fx,n.cC=function(r,e,i,s,a,h,u,f,g){if(g.name==="globe")return Fx(r,e,new To(i,s,a),!1);let y=Wp({z:i,x:s,y:a},g);return new li([(h+y.x/y.scale)*e,e*(y.y/y.scale),u],[(h+y.x2/y.scale)*e,e*(y.y2/y.scale),f])},n.cD=function(r,e,i){return r[0]=Math.min(e[0],i[0]),r[1]=Math.min(e[1],i[1]),r[2]=Math.min(e[2],i[2]),r[3]=Math.min(e[3],i[3]),r},n.cE=function(r,e,i){return r[0]=Math.max(e[0],i[0]),r[1]=Math.max(e[1],i[1]),r[2]=Math.max(e[2],i[2]),r[3]=Math.max(e[3],i[3]),r},n.cF=function(r){let e=Math.round((r+45+360)%360/90)%4;return q[e]},n.cG=ne,n.cH=xs,n.cI=l,n.cJ=function(r){let e=xe(new Float64Array(16));Te(e,r.pixelMatrix,r.globeMatrix);let i=[0,d,0],s=[0,p,0];return Lr(i,i,e),Lr(s,s,e),[i[0]>0&&i[0]<=r.width&&i[1]>0&&i[1]<=r.height&&!Xg(r,new C(r.center.lat,90)),s[0]>0&&s[0]<=r.width&&s[1]>0&&s[1]<=r.height&&!Xg(r,new C(r.center.lat,-90))]},n.cK=function(r,e){let{scale:i}=r.tileTransform,s=i*ht/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return function(a,h,u){var f=h[1],g=h[2],y=h[3],w=u[0],E=u[1];return a[0]=h[0]*w,a[1]=f*w,a[2]=g*E,a[3]=y*E,a}(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},n.cL=Qm,n.cM=Wt,n.cN=Qv,n.cO=function(r){let e=Qv(r,!0);return H([],[e[0],e[1],e[4],e[5]])},n.cP=ft,n.cQ=Mi,n.cR=_t,n.cS=function(r){let{x:e,y:i}=r.point,{lng:s,lat:a}=r._center;return Vx(e,i,r.worldSize,s,a)},n.cT=Fr,n.cU=Re,n.cV=So,n.cW=Sr,n.cX=Dm,n.cY=function(r,e,i){let s=0;for(let a=0;a<2;++a)r[a]>0&&(s+=(r[a]-0)*(r[a]-0)),e[a]<0&&(s+=(0-e[a])*(0-e[a]));return s},n.cZ=function(r){return r*r*r*r*r},n.c_=N,n.ca=function(r,e,i,s,a,h,u){var f=1/(e-i),g=1/(s-a),y=1/(h-u);return r[0]=-2*f,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*g,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*y,r[11]=0,r[12]=(e+i)*f,r[13]=(a+s)*g,r[14]=(u+h)*y,r[15]=1,r},n.cb=U,n.cc=function(r,e,i){r[4*e+0]=i[0],r[4*e+1]=i[1],r[4*e+2]=i[2],r[4*e+3]=i[3]},n.cd=Eu,n.ce=zl,n.cf=Or,n.cg=hs,n.ch=Jc,n.ci=C,n.cj=ub,n.ck=function(){var r=new V(4);return V!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r},n.cl=function(r,e,i){var s=e[0],a=e[1],h=e[2],u=e[3],f=Math.sin(i),g=Math.cos(i);return r[0]=s*g+h*f,r[1]=a*g+u*f,r[2]=s*-f+h*g,r[3]=a*-f+u*g,r},n.cm=function(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]},n.cn=Lo,n.co=function(r){return Math.hypot(r[0],r[1],r[2],r[3])},n.cp=ws,n.cq=Fs,n.cr=us,n.cs=3,n.ct=2,n.cu=7,n.cv=6,n.cw=Bn,n.cx=mt,n.cy=Ri,n.cz=e1,n.d=function(r){return mn.API_TILEJSON_REGEX.test(r)},n.d$=(r,e,i,s,a,h,u,f,g,y)=>{let w=r.transform,E=w.calculatePixelsToTileUnitsMatrix(e),I=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",R=w.pitch<15?y1(.07,.7,re((14-w.zoom)/5,0,1)):.07;return{u_matrix:v1(r,e,i,s),u_pixels_to_tile_units:E,u_device_pixel_ratio:h,u_width_scale:u,u_floor_width_scale:f,u_units_to_pixels:[1/w.pixelsToGLUnits[0],1/w.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:w1(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:x1(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:g,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(I?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:R,u_tile_to_meter:se(e.tileID.canonical,0),u_ground_shadow_factor:y}},n.d0=Kc,n.d1=function(r,e,i){let s=Math.sqrt(r*r+e*e+i*i),a=s>0?Math.acos(i/s)*hc:0,h=r!==0||e!==0?Math.atan2(-e,-r)*hc+90:0;return h<0&&(h+=360),[s,h,a]},n.d2=yi,n.d3=$r,n.d4=se,n.d5=vi,n.d6=li,n.d7=mr,n.d8=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},n.d9=Hy,n.dA=Fm,n.dB=function(r){let e=ne-5;r=re(r,-e,e)/e*90;let i=Math.pow(Math.abs(Math.sin(Ai(r))),3);return Math.round(i*(c.length-1))},n.dC=function(r,e,i,s){let a=e.getNorth(),h=e.getSouth(),u=e.getWest(),f=e.getEast(),g=1<<r.z,y=f-u,w=a-h,E=y/o,I=-w/c[i],R=[0,E,0,I,0,0,a,u,0];if(r.z>0){let L=180/s;we(R,R,[L/y+1,0,0,0,L/w+1,0,-.5*L/E,.5*L/I,1])}return R[2]=g,R[5]=r.x,R[8]=r.y,R},n.dD=ca,n.dE=function(r,e,i){let s=xe(new Float64Array(16)),a=(e/(1<<r)-.5)*Math.PI*2;return Pt(s,i.globeMatrix,a),Float32Array.from(s)},n.dF=class{isDataAvailableAtPoint(r){let e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;let i=e.getSource().maxzoom,s=1<<i,a=Math.floor(r.x),h=Math.floor((r.x-a)*s),u=Math.floor(r.y*s),f=this.findDEMTileFor(new Xr(i,a,i,h,u));return!(!f||!f.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);let s=this._source();if(!s||r.y<0||r.y>1)return e;let a=s.getSource().maxzoom,h=1<<a,u=Math.floor(r.x),f=r.x-u,g=new Xr(a,u,a,Math.floor(f*h),Math.floor(r.y*h)),y=this.findDEMTileFor(g);if(!y||!y.dem)return e;let w=y.dem,E=1<<y.tileID.canonical.z,I=(f*E-y.tileID.canonical.x)*w.dim,R=(r.y*E-y.tileID.canonical.y)*w.dim,L=Math.floor(I),k=Math.floor(R);return(i?this.exaggeration():1)*Bt(Bt(w.get(L,k),w.get(L,k+1),R-k),Bt(w.get(L+1,k),w.get(L+1,k+1),R-k),I-L)}getAtTileOffset(r,e,i){let s=1<<r.canonical.z;return this.getAtPointOrZero(new le(r.wrap+(r.canonical.x+e/ht)/s,(r.canonical.y+i/ht)/s))}getAtTileOffsetFunc(r,e,i,s){return a=>{let h=this.getAtTileOffset(r,a.x,a.y),u=s.upVector(r.canonical,a.x,a.y);return Xi(u,u,h*s.upVectorScale(r.canonical,e,i).metersToTile),u}}getForTilePoints(r,e,i,s){if(this.isUsingMockSource())return!1;let a=Bu.create(this,r,s);return!!a&&(e.forEach(h=>{h[2]=this.exaggeration()*a.getElevationAt(h[0],h[1],i)}),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;let e=this.findDEMTileFor(r);if(!e||!e.dem)return null;let i=e.dem.tree,s=e.tileID,a=1<<r.canonical.z-s.canonical.z,h=r.canonical.x/a-s.canonical.x,u=r.canonical.y/a-s.canonical.y,f=0;for(let g=0;g<r.canonical.z-s.canonical.z&&!i.leaves[f];g++){h*=2,u*=2;let y=2*Math.floor(u)+Math.floor(h);f=i.childOffsets[f]+y,h%=1,u%=1}return{min:this.exaggeration()*i.minimums[f],max:this.exaggeration()*i.maximums[f]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(let a of r){let h=this.getMinMaxForTile(a.tileID);h&&(i=Math.min(i,h.min),s=Math.max(s,h.max),e=!0)}return e?{min:i,max:s}:null}},n.dG=Qx,n.dH=km,n.dI=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},n.dJ=J,n.dK=function(r,e){var i=Math.sin(e),s=Math.cos(e);return r[0]=s,r[1]=i,r[2]=0,r[3]=-i,r[4]=s,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},n.dL=ks,n.dM=Nx,n.dN=Un,n.dO=En,n.dP=256,n.dQ=function(r,e){let i=[0,0,0];return Lr(i,i,Nm(ca(e.canonical))),Lr(i,i,r),i},n.dR=r=>({u_matrix:new Jc(r),u_texsize:new hs(r),u_pixels_to_tile_units:new bp(r),u_device_pixel_ratio:new Or(r),u_width_scale:new Or(r),u_floor_width_scale:new Or(r),u_image:new Eu(r),u_units_to_pixels:new hs(r),u_tile_units_to_pixels:new Or(r),u_alpha_discard_threshold:new Or(r),u_trim_offset:new hs(r),u_trim_fade_range:new hs(r),u_trim_color:new Kc(r),u_emissive_strength:new Or(r),u_zbias_factor:new Or(r),u_tile_to_meter:new Or(r),u_ground_shadow_factor:new zl(r),u_pattern_transition:new Or(r)}),n.dS=r=>({u_matrix:new Jc(r),u_pixels_to_tile_units:new bp(r),u_device_pixel_ratio:new Or(r),u_width_scale:new Or(r),u_floor_width_scale:new Or(r),u_units_to_pixels:new hs(r),u_dash_image:new Eu(r),u_gradient_image:new Eu(r),u_image_height:new Or(r),u_texsize:new hs(r),u_tile_units_to_pixels:new Or(r),u_alpha_discard_threshold:new Or(r),u_trim_offset:new hs(r),u_trim_fade_range:new hs(r),u_trim_color:new Kc(r),u_emissive_strength:new Or(r),u_zbias_factor:new Or(r),u_tile_to_meter:new Or(r),u_ground_shadow_factor:new zl(r)}),n.dT=r=>({u_camera_to_center_distance:new Or(r),u_extrude_scale:new bp(r),u_device_pixel_ratio:new Or(r),u_matrix:new Jc(r),u_inv_rot_matrix:new Jc(r),u_merc_center:new hs(r),u_tile_id:new zl(r),u_zoom_transition:new Or(r),u_up_dir:new zl(r),u_emissive_strength:new Or(r)}),n.dU=Cl,n.dV=lA,n.dW=Gx,n.dX=(r,e,i,s,a,h)=>{let u=r.transform,f=u.projection.name==="globe",g;if(h.paint.get("circle-pitch-alignment")==="map")if(f){let w=Nx(u.zoom,e.canonical)*u._pixelsPerMercatorPixel;g=Float32Array.from([w,0,0,w])}else g=u.calculatePixelsToTileUnitsMatrix(i);else g=new Float32Array([u.pixelsToGLUnits[0],0,0,u.pixelsToGLUnits[1]]);let y={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(u.projection),u_matrix:r.translatePosMatrix(e.projMatrix,i,h.paint.get("circle-translate"),h.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Wo.devicePixelRatio,u_extrude_scale:g,u_inv_rot_matrix:LE,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:h.paint.get("circle-emissive-strength")};if(f){y.u_inv_rot_matrix=s,y.u_merc_center=a,y.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],y.u_zoom_transition=Fl(u.zoom);let w=a[0]*ht,E=a[1]*ht;y.u_up_dir=u.projection.upVector(new To(0,0,0),w,E)}return y},n.dY=b1,n.dZ=Gn,n.d_=(r,e,i,s,a,h,u,f,g,y)=>{let w=r.transform,E=w.pitch<15?y1(.07,.7,re((14-w.zoom)/5,0,1)):.07,I=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:v1(r,e,i,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:w.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:a,u_width_scale:h,u_floor_width_scale:u,u_image:0,u_tile_units_to_pixels:x1(e,w),u_units_to_pixels:[1/w.pixelsToGLUnits[0],1/w.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:f,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(I?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:E,u_tile_to_meter:se(e.tileID.canonical,0),u_ground_shadow_factor:g,u_pattern_transition:y}},n.da=function(r,e){return r.readFields(rM,{icons:[]},e)},n.db=Xm,n.dc=Ou,n.dd=Dy,n.de=Mh,n.df=fm,n.dg=zo,n.dh=nl,n.di=si,n.dj=function(r){let e=r.indexOf(Hc);return e>=0?r.slice(0,e):r},n.dk=function(r){return r.indexOf(Hc)>=0},n.dl=function(r){let e=r.lastIndexOf(Hc);return e>=0?r.slice(e+1):""},n.dm=function(r){let e=[],i=r.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),r.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},n.dn=function(r,e,i,s){return r.type==="custom"?new KA(r,e):new tM[r.type](r,e,i,s)},n.dp=ui,n.dq=function(r){let e=r.indexOf(Hc);return e>=0?r.slice(e+1):""},n.dr=class extends ju{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){let r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},n.ds=Jd,n.dt=il,n.du=function(r){return r({pluginStatus:Dn,pluginURL:ra}),Jd.on("pluginStateChange",r),r},n.dv=vp,n.dw=class extends Bo{constructor(r){super(r),this.current=Vg}set(r,e,i){if(this.fetchUniformLocation(r,e)){for(let s=0;s<9;s++)if(i[s]!==this.current[s]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},n.dx=$,n.dy=function(r,e,i){let s=Fl(i.zoom),a=r.style.map._antialias,h=r.terrain&&r.terrain.exaggeration()>0;return s===0&&!a&&!h},n.dz=function(r){let e=r.pixelsPerMeter,i=e/U(1,r.center.lat),s=xe(new Float64Array(16));return We(s,s,[r.point.x,r.point.y,0]),ft(s,s,[i,i,e]),Float32Array.from(s)},n.e=mn,n.e$=Qd,n.e0=kt,n.e1=Sp,n.e2=Q,n.e3=Va,n.e4=Zm,n.e5=zv,n.e6=Nl,n.e7=450,n.e8=7,n.e9=de,n.eA=function(r,e,i,s,a,h,u,f,g,y,w,E,I,R,L,k){var B=new V(16);return B[0]=r,B[1]=e,B[2]=i,B[3]=s,B[4]=a,B[5]=h,B[6]=u,B[7]=f,B[8]=g,B[9]=y,B[10]=w,B[11]=E,B[12]=I,B[13]=R,B[14]=L,B[15]=k,B},n.eB=b,n.eC=up,n.eD=Zc,n.eE=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Qe(1/0,1/0),max:new Qe(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){let i=xv(new Qe(0,0),new Qe(ht,ht),r),s=[];if(e&&!ny(i,this._globalClipBounds))return s;for(let a of this._activeRegions){if(a.hiddenByOverlap||!ny(i,a))continue;let h=sI(a.min,a.max,r);s.push({min:h.min,max:h.max,sourceId:this._sourceIds[a.priority],footprint:a.footprint,footprintTileId:a.tileId,order:a.order,clipMask:a.clipMask,clipScope:a.clipScope})}return s}setSources(r){this._setSources(r.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{let i=[];for(let s of e.cache.getVisibleCoordinates()){let a=e.cache.getTile(s).buckets[e.layer];a&&a.updateFootprints(s.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(r){let e=r.getFootprints();if(e.length===0)return;let i=r.getOrder(),s=r.getClipMask(),a=r.getClipScope();for(let h of e){if(!h.footprint)continue;let u=xv(h.footprint.min,h.footprint.max,h.id);this._activeRegions.push({min:u.min,max:u.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:h.id,footprint:h.footprint,order:i,clipMask:s,clipScope:a})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||qm(e.min,i.min)||qm(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(s,a){let h=(u,f)=>u+f;return s.length-a.length||s.reduce(h,"").localeCompare(a.reduce(h,""))}(e.clipScope,i.clipScope));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){let i=this._activeRegions[e],s=this._prevRegions[e];r=i.priority!==s.priority||!yv(i,s)||i.order!==s.order||i.clipMask!==s.clipMask||!Ss(i.clipScope,s.clipScope),++e}}if(r){++this._updateTime;for(let i of this._activeRegions)i.order!==Pp&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));let e=i=>{let s=this._activeRegions;if(i>=s.length)return i;let a=s[i].priority;for(;i<s.length&&s[i].priority===a;)++i;return i};if(this._sourceIds.length>1){let i=0,s=e(i);for(;i!==s;){let a=i,h=i;for(;a!==s;){let u=this._activeRegions[a];u.hiddenByOverlap=!1;for(let f=0;f<h;f++){let g=this._activeRegions[f];if(!g.hiddenByOverlap&&u.order===Pp&&ny(u,g)&&(u.hiddenByOverlap=vv(u.footprint,u.tileId,g.footprint,g.tileId),u.hiddenByOverlap))break}++a}i=s,s=e(i)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},n.eF=Pp,n.eG=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(let r of this._poleSegments)r.destroy();for(let r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){let i=new $n,s=new ur,a=[],h=r+1+2,u=e[0]+1,f=e[0]+1+(1+e.length),g=(y,w,E)=>{let I=y===h-1?y-2:y===0?y:y-1;return I+=E?24575:0,[I,w]};for(let y=0;y<h;++y)i.emplaceBack(...g(y,0,!0));for(let y=0;y<u;++y)for(let w=0;w<h;++w)i.emplaceBack(...g(w,y,(w===0||w===h-1)&&!0));for(let y=0;y<e.length;++y){let w=e[y];for(let E=0;E<h;++E)i.emplaceBack(...g(E,w,!0))}for(let y=0;y<e.length;++y){let w=s.length,E=e[y]+1+2,I=new ur;for(let k=0;k<E-1;k++){let B=k===E-2,G=B?h*(f-e.length+y-k):h;for(let X=0;X<h-1;X++){let W=k*h+X;k===0||B||X===0||X===h-2?(I.emplaceBack(W+1,W,W+G),I.emplaceBack(W+G,W+G+1,W+1)):(s.emplaceBack(W+1,W,W+G),s.emplaceBack(W+G,W+G+1,W+1))}}let R=gr.simpleSegment(0,w,i.length,s.length-w);for(let k=0;k<I.uint16.length;k+=3)s.emplaceBack(I.uint16[k],I.uint16[k+1],I.uint16[k+2]);let L=gr.simpleSegment(0,w,i.length,s.length-w);a.push({withoutSkirts:R,withSkirts:L})}return{vertices:i,indices:s,segments:a}}_createGrid(r){let e=this._fillGridMeshWithLods(o,c);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,Dx.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){let e=new ur;for(let u=0;u<=o;u++)e.emplaceBack(0,u+1,u+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);let i=new Ba,s=new Ba,a=new Ba,h=new Ba;this._poleSegments=[];for(let u=0,f=0;u<Dm;u++){let g=360/(1<<u);i.emplaceBack(0,-Cn,0,.5,0),s.emplaceBack(0,-Cn,0,.5,1),a.emplaceBack(0,-Cn,0,.5,.5),h.emplaceBack(0,-Cn,0,.5,.5);for(let y=0;y<=o;y++){let w=y/o,E=0,I=Bt(0,g,w),[R,L,k]=_(PE,RE,I,Cn);i.emplaceBack(R,L,k,w,E),s.emplaceBack(R,L,k,w,1-E);let B=Ai(I);w=.5+.5*Math.sin(B),E=.5+.5*Math.cos(B),a.emplaceBack(R,L,k,w,E),h.emplaceBack(R,L,k,w,1-E)}this._poleSegments.push(gr.simpleSegment(f,0,66,64)),f+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(i,Om,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(s,Om,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(a,Om,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(h,Om,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},n.eH=_v,n.eI=ie,n.eJ=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},n.eK=fe,n.eL=oe,n.eM=function(r,e,i){return r[0]=e[0]/i[0],r[1]=e[1]/i[1],r[2]=e[2]/i[2],r},n.eN=Nn,n.eO=x,n.eP=Ro,n.eQ=mi,n.eR=function([r,e,i]){let s=Math.hypot(r,e,i),a=Math.atan2(r,i),h=.5*Math.PI-Math.acos(-e/s);return new C(Re(a),Re(h))},n.eS=co,n.eT=xy,n.eU=function(r){let e=r.navigator?r.navigator.userAgent:null;return!!function(i){if(Ir==null){let s=i.navigator?i.navigator.userAgent:null;Ir=!!i.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Ir}(r)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},n.eV=function(r,e){Xo=r,Is=e},n.eW=Xg,n.eX=Ux,n.eY=function(r){let e=[0,0,0],i=xe(new Float64Array(16));return Te(i,r.pixelMatrix,r.globeMatrix),Lr(e,e,i),new Qe(e[0],e[1])},n.eZ=function(){let r=kp;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(uy),kp=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},n.e_=function(){Xm().acquire(uy)},n.ea=function(r,e){if(r===e){var i=e[1],s=e[2],a=e[3],h=e[6],u=e[7],f=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=i,r[6]=e[9],r[7]=e[13],r[8]=s,r[9]=h,r[11]=e[14],r[12]=a,r[13]=u,r[14]=f}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r},n.eb=YA,n.ec=gi,n.ed=fp,n.ee=256,n.ef=Zg,n.eg=yo,n.eh=Pt,n.ei=function(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],r},n.ej=Ba,n.ek=hp,n.el=nm,n.em=function(r,e,i,s,a){return re((r-e)/(i-e)*(a-s)+s,s,a)},n.en=Ya,n.eo=function(r,e){var i=e[0],s=e[1],a=e[2],h=e[3],u=e[4],f=e[5],g=e[6],y=e[7],w=e[8],E=w*u-f*y,I=-w*h+f*g,R=y*h-u*g,L=i*E+s*I+a*R;return L?(r[0]=E*(L=1/L),r[1]=(-w*s+a*y)*L,r[2]=(f*s-a*u)*L,r[3]=I*L,r[4]=(w*i-a*g)*L,r[5]=(-f*i+a*h)*L,r[6]=R*L,r[7]=(-y*i+s*g)*L,r[8]=(u*i-s*h)*L,r):null},n.ep=2,n.eq=Zo,n.er=vy,n.es=[1,1,1],n.et=class{constructor(r,e,i,s){this.context=r,this.format=s,this.size=i,this.texture=r.gl.createTexture();let[a,h,u]=this.size,{gl:f}=r;f.bindTexture(f.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),f.texImage3D(f.TEXTURE_3D,0,this.format,a,h,u,0,_y(this.format),gy(this.format),e.data)}bind(r,e){let{context:i}=this,{gl:s}=i;s.bindTexture(s.TEXTURE_3D,this.texture),r!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){let{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},n.eu=Bu,n.ev=oc,n.ew=function(r,e,i,s){var a=e[0],h=e[1],u=e[2],f=e[3];return r[0]=a+s*(i[0]-a),r[1]=h+s*(i[1]-h),r[2]=u+s*(i[2]-u),r[3]=f+s*(i[3]-f),r},n.ex=Lu,n.ey=cs,n.ez=aa,n.f=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},n.f0=function(r,e,i=!1){if(Dn===Qn.deferred||Dn===Qn.loading||Dn===Qn.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");ra=Wo.resolveURL(r),Dn=Qn.deferred,Yd=e,Kd(),i||mm()},n.f1=function(r){Cu=Wo.resolveURL(r),Pu||(Pu=new Mu(Xm(),new Ea)),Pu.broadcast("setMeshoptUrl",Cu)},n.f2=$v,n.f3=function(r){py=Wo.resolveURL(r),Pu||(Pu=new Mu(Xm(),new Ea)),Pu.broadcast("setDracoUrl",py)},n.f4=Hv,n.f5=Op,n.f6=function(r){let e=ba();if(!e)return;let i=e.delete(Es);r&&i.then(()=>r()).catch(r)},n.f7=rh,n.f8=Tt,n.f9=Bl,n.fa=zs,n.fb=mw,n.fc=_w,n.fd=f1,n.fe=yt,n.ff="hd_road_elevation",n.fg=yr,n.fh=Xt,n.fi=th,n.fj=zy,n.fk=sh,n.fl=function(r,e,i,s,a,h,u,f=1,g,y,w){r.createArrays(),r.tilePixelRatio=ht/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;let E=r.layers[0].layout,I=r.layers[0]._unevaluatedLayout._values,R={};R.scaleFactor=f,R.textSizeScaleRange=E.get("text-size-scale-range"),R.iconSizeScaleRange=E.get("icon-size-scale-range");let[L,k]=R.textSizeScaleRange,[B,G]=R.iconSizeScaleRange;R.textScaleFactor=re(R.scaleFactor,L,k),R.iconScaleFactor=re(R.scaleFactor,B,G);let X=I["text-size"],W=I["icon-size"];if(r.textSizeData.kind==="composite"){let{minZoom:ve,maxZoom:Ne}=r.textSizeData;R.compositeTextSizes=[X.possiblyEvaluate(new ji(ve,{worldview:w}),h),X.possiblyEvaluate(new ji(Ne,{worldview:w}),h)]}if(r.iconSizeData.kind==="composite"){let{minZoom:ve,maxZoom:Ne}=r.iconSizeData;R.compositeIconSizes=[W.possiblyEvaluate(new ji(ve,{worldview:w}),h),W.possiblyEvaluate(new ji(Ne,{worldview:w}),h)]}R.layoutTextSize=X.possiblyEvaluate(new ji(u+1,{worldview:w}),h),R.layoutIconSize=W.possiblyEvaluate(new ji(u+1,{worldview:w}),h),R.textMaxSize=X.possiblyEvaluate(new ji(18,{worldview:w}),h);let K=E.get("symbol-placement"),pe=E.get("text-rotation-alignment")==="map"&&K!=="point",ce=E.get("text-size"),ue=!1,ge=[];for(let ve of r.features){let Ne=E.get("text-font").evaluate(ve,{},h).join(","),Ee=ce.evaluate(ve,{},h)*R.textScaleFactor,Ue=R.layoutTextSize.evaluate(ve,{},h)*R.textScaleFactor,nt=R.layoutIconSize.evaluate(ve,{},h)*R.iconScaleFactor,qe={horizontal:{},vertical:void 0},Ke=ve.text,it,Fe=[0,0];if(Ke){let vt=Ke.toString(),Vt=E.get("text-letter-spacing").evaluate(ve,{},h)*dn,Zt=E.get("text-line-height").evaluate(ve,{},h)*dn,Qt=Cg(vt)?Vt:0,Kt=E.get("text-anchor").evaluate(ve,{},h),fi=E.get("text-variable-anchor");if(!fi){let Oe=E.get("text-radial-offset").evaluate(ve,{},h);if(Oe)Fe=Q1(Kt,[Oe*dn,Oy]);else{let lt=E.get("text-offset").evaluate(ve,{},h);Fe=[lt[0]*dn,lt[1]*dn]}}let oi=pe?"center":E.get("text-justify").evaluate(ve,{},h),ir=K==="point",ee=ir?E.get("text-max-width").evaluate(ve,{},h)*dn:1/0,te=Oe=>{r.allowVerticalPlacement&&Xd(vt)&&(qe.vertical=Py(Ke,e,i,a,Ne,ee,Zt,Kt,Oe,Qt,Fe,Io.vertical,!0,Ue,Ee,g))};if(!pe&&fi){let Oe=oi==="auto"?fi.map(pt=>ky(pt)):[oi],lt=!1;for(let pt=0;pt<Oe.length;pt++){let dt=Oe[pt];if(!qe.horizontal[dt])if(lt)qe.horizontal[dt]=qe.horizontal[0];else{let Et=Py(Ke,e,i,a,Ne,ee,Zt,"center",dt,Qt,Fe,Io.horizontal,!1,Ue,Ee,g);Et&&(qe.horizontal[dt]=Et,lt=Et.positionedLines.length===1)}}te("left")}else{if(oi==="auto"&&(oi=ky(Kt)),ir||E.get("text-writing-mode").indexOf("horizontal")>=0||!Xd(vt)){let Oe=Py(Ke,e,i,a,Ne,ee,Zt,Kt,oi,Qt,Fe,Io.horizontal,!1,Ue,Ee,g);Oe&&(qe.horizontal[oi]=Oe)}te(ir?"left":oi)}}let Je,Ie,Be,at,et,Lt,St=!1,Xe=E.get("icon-text-fit").evaluate(ve,{},h);if(ve.icon&&ve.icon.hasPrimary()){let vt=tb(ve.icon,r.iconSizeData,I["icon-size"],h,r.zoom,ve,g,R.iconScaleFactor,w);Je=vt.iconPrimary,Be=vt.iconSecondary;let Vt=Je.toString();if(Ie=s.get(Vt),Ie&&(et=E.get("icon-offset").evaluate(ve,{},h),Lt=E.get("icon-anchor").evaluate(ve,{},h),it=IA(a.get(Vt),Be?a.get(Be.toString()):void 0,et,Lt),St=Ie.sdf,r.sdfIcons===void 0?r.sdfIcons=Ie.sdf:r.sdfIcons!==Ie.sdf&&pi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ie.pixelRatio!==r.pixelRatio||E.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0)),Be){let Zt=Be.toString();at=s.get(Zt)}}ue=ue||!(!ve.icon||!ve.icon.hasSecondary());let tt=Fy(qe.horizontal)||qe.vertical;r.iconsInText||(r.iconsInText=!!tt&&tt.iconsInText);let It=Ue*R.textScaleFactor/dn,{defaultShapedIcon:xt,verticallyShapedIcon:ut}=kA(r,it,E,ve,h,qe,It,et,Xe);Xe!=="none"&&it&&(F1(it)||B1(it))&&(a_(0,Ie,Je,it,xt,Xe,y,s,a),a_(0,at,Be,it,xt,Xe,y,s,a),ut&&(a_(0,Ie,Je,it,ut,Xe,y,s,a),a_(0,at,Be,it,ut,Xe,y,s,a))),it=xt,ge.push({feature:ve,shapedTextOrientations:qe,shapedText:tt,shapedIcon:it,iconPrimary:Je,iconSecondary:Be,iconOffset:et,iconAnchor:Lt,verticallyShapedIcon:ut,layoutTextSize:Ue,layoutIconSize:nt,textOffset:Fe,isSDFIcon:St,iconTextFit:Xe})}return{featureData:ge,sizes:R,hasAnySecondaryIcon:ue,textAlongLine:pe,symbolPlacement:K}},n.fm=Z1,n.fn=function(r,e,i,s,a,h,u,f,g,y){let{featureData:w,hasAnySecondaryIcon:E,sizes:I,textAlongLine:R,symbolPlacement:L}=e;for(let k of w){let{shapedIcon:B,verticallyShapedIcon:G,feature:X,shapedTextOrientations:W,shapedText:K,layoutTextSize:pe,textOffset:ce,isSDFIcon:ue,iconPrimary:ge,iconSecondary:ve,iconTextFit:Ne,iconOffset:Ee}=k;ib(B,y.iconPositions,ge,ve),ib(G,y.iconPositions,ge,ve),OA(W,y.iconPositions),DA(ge,ve,y.iconPositions),(K||B)&&FA(r,X,W,B,G,g,I,pe,0,ce,ue,s,a,u,f,E,Ne,Ee,R,L)}i&&r.generateCollisionDebugBuffers(h,r.collisionBoxArray,I.textScaleFactor)},n.fo=Mt,n.fp=A_,n.fq=Pe,n.fr=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==Wv){let i=new Uint32Array(r,0,7),[,,s,a,h,u]=i;e=i.byteLength+a+h+u+h,(s!==r.byteLength||e>=r.byteLength)&&pi("Invalid b3dm header information.")}return Jv(r,e)},n.fs=function(r,e){let i=s1(r);for(let s of i){for(let a of s.meshes)FI(a);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(BI(s.lights,e)))}return i},n.ft=b_,n.fu=Hi,n.fv=Gv,n.fw=as,n.fx=Qn,n.fy=function(r){el(),os?.then(e=>{e.keys().then(i=>{for(let s=0;s<i.length-r;s++)e.delete(i[s]).catch(a=>pi(a.message))}).catch(i=>pi(i.message))}).catch(e=>pi(e.message))},n.g=function(r,e){return il(Le(r,{method:"GET"}),e)},n.h=Le,n.i=function(r){return mn.API_STYLE_REGEX.test(r)&&!Sh(r)},n.j=function(r){return r.indexOf("mapbox:")===0},n.k=js,n.l=hd,n.m=function(r){return decodeURIComponent(atob(r).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},n.n=function(r,e){return il(Le(r,{type:"json"}),e)},n.o=bc,n.p=function(r,e){return il(Le(r,{method:"POST"}),e)},n.q=Wo,n.r=vn,n.s=function(r){try{let e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},n.t=Ah,n.u=function(){return function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)}()},n.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},n.w=pi,n.x=function(){return dy||(dy=new rh),dy},n.y=Jy,n.z=mo}),T(["./shared"],function(n){function O(Re){let q=Re?Re.url.toString():void 0;return q?performance.getEntriesByName(q):[]}function V(Re){if(typeof Re=="number"||typeof Re=="boolean"||typeof Re=="string"||Re==null)return JSON.stringify(Re);if(Array.isArray(Re)){let $="[";for(let ie of Re)$+=`${V(ie)},`;return`${$}]`}let q="{";for(let $ of Object.keys(Re).sort())q+=`${$}:${V(Re[$])},`;return`${q}}`}function H(Re){let q="";for(let $ of n.bu)q+=`/${V(Re[$])}`;return q}class J{constructor(q){this.keyCache={},this._layers={},this._layerConfigs={},q&&this.replace(q)}replace(q,$){this._layerConfigs={},this._layers={},this.update(q,[],$)}update(q,$,ie){this._options=ie;for(let re of q)this._layerConfigs[re.id]=re,(this._layers[re.id]=n.dn(re,this.scope,null,this._options)).compileFilter(ie),this.keyCache[re.id]&&delete this.keyCache[re.id];for(let re of $)delete this.keyCache[re],delete this._layerConfigs[re],delete this._layers[re];this.familiesBySource={};let fe=function(re,ye){let De={};for(let Le=0;Le<re.length;Le++){let st=re[Le],He=ye&&ye[st.id];He||(st.type==="symbol"?He=st.id:(He=H(st),st.type==="line"&&st.paint&&function Ht(Xt){return typeof Xt=="string"&&Xt==="line-progress"||(Array.isArray(Xt)?Xt.some(Ht):!(!Xt||typeof Xt!="object")&&Object.values(Xt).some(Ht))}(st.paint["line-width"])&&(He+=`/${V(st.paint["line-width"])}`))),ye&&(ye[st.id]=He);let kt=De[He];kt||(kt=De[He]=[]),kt.push(st)}let be=[];for(let Le in De)be.push(De[Le]);return be}(Object.values(this._layerConfigs),this.keyCache);for(let re of fe){let ye=re.map(kt=>this._layers[kt.id]),De=ye[0];if(De.visibility==="none")continue;let be=De.source||"",Le=this.familiesBySource[be];Le||(Le=this.familiesBySource[be]={});let st=De.sourceLayer||"_geojsonTileLayer",He=Le[st];He||(He=Le[st]=[]),He.push(ye)}}}let ae=1*n.fa;class we{constructor(q){let $={},ie=[];for(let De in q){let be=q[De],Le=$[De]={};for(let st in be.glyphs){let He=be.glyphs[+st];if(!He||He.bitmap.width===0||He.bitmap.height===0)continue;let kt=He.metrics.localGlyph?ae:1,Ht={x:0,y:0,w:He.bitmap.width+2*kt,h:He.bitmap.height+2*kt};ie.push(Ht),Le[st]=Ht}}let{w:fe,h:re}=n.H(ie),ye=new n.f9({width:fe||1,height:re||1});for(let De in q){let be=q[De];for(let Le in be.glyphs){let st=be.glyphs[+Le];if(!st||st.bitmap.width===0||st.bitmap.height===0)continue;let He=$[De][Le],kt=st.metrics.localGlyph?ae:1;n.f9.copy(st.bitmap,ye,{x:0,y:0},{x:He.x+kt,y:He.y+kt},st.bitmap)}}this.image=ye,this.positions=$}}n.f8(we,"GlyphAtlas");class Ae{constructor(q){this.tileID=new n.aM(q.tileID.overscaledZ,q.tileID.wrap,q.tileID.canonical.z,q.tileID.canonical.x,q.tileID.canonical.y),this.tileZoom=q.tileZoom,this.uid=q.uid,this.zoom=q.zoom,this.lut=q.lut,this.canonical=q.tileID.canonical,this.pixelRatio=q.pixelRatio,this.tileSize=q.tileSize,this.source=q.source,this.scope=q.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=q.showCollisionBoxes,this.collectResourceTiming=!!q.request&&q.request.collectResourceTiming,this.promoteId=q.promoteId,this.isSymbolTile=q.isSymbolTile,this.tileTransform=n.aW(q.tileID.canonical,q.projection),this.projection=q.projection,this.worldview=q.worldview,this.localizableLayerIds=q.localizableLayerIds,this.brightness=q.brightness,this.extraShadowCaster=!!q.extraShadowCaster,this.tessellationStep=q.tessellationStep,this.scaleFactor=q.scaleFactor,this.worldview=q.worldview}parse(q,$,ie,fe,re,ye){this.status="parsing",this.data=q,this.collisionBoxArray=new n.b0;let De=new n.fb(Object.keys(q.layers).sort()),be=new n.fc(this.tileID,this.promoteId);be.bucketLayerIDs=[];let Le={},st=new n.fd(256,256),He={featureIndex:be,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:st,availableImages:ie,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},kt=[],Ht=$.familiesBySource[this.source];for(let ui in Ht){let si=q.layers[ui];if(!si)continue;let di=!1,Yi=!1,pi=!1;for(let Hi of Ht[ui])Hi[0].type==="symbol"?di=!0:Yi=!0,Hi[0].is3D()&&Hi[0].type!=="model"&&(pi=!0);if(this.extraShadowCaster&&!pi||this.isSymbolTile===!0&&!di||this.isSymbolTile===!1&&!Yi)continue;si.version===1&&n.w(`Vector tile source "${this.source}" layer "${ui}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let Mr=De.encode(ui),Qr=[],$r=!1;for(let Hi=0,Pi=0;Hi<si.length;Hi++){let Ir=si.feature(Hi),wr=be.getId(Ir,ui);if(this.localizableLayerIds&&this.localizableLayerIds.has(ui)){let _r=Ir.properties?Ir.properties.worldview:null;if(this.worldview&&typeof _r=="string")if(_r==="all")Ir.properties.$localized=!0;else{if(!_r.split(",").includes(this.worldview))continue;Ir.properties.$localized=!0,Ir.properties.worldview=this.worldview}}!$r&&Ir.properties&&Ir.properties.hasOwnProperty(n.fe)&&($r=!0),Qr.push({feature:Ir,id:wr,index:Pi,sourceLayerIndex:Mr}),Pi++}$r&&!He.elevationFeatures&&q.layers.hasOwnProperty(n.ff)&&(He.elevationFeatures=n.fg.parseFrom(q.layers[n.ff],this.canonical));for(let Hi of Ht[ui]){let Pi=Hi[0];if(this.extraShadowCaster&&(!Pi.is3D()||Pi.type==="model")||this.isSymbolTile!==void 0&&Pi.type==="symbol"!==this.isSymbolTile||Pi.minzoom&&this.zoom<Math.floor(Pi.minzoom)||Pi.maxzoom&&this.zoom>=Pi.maxzoom||Pi.visibility==="none")continue;xe(Hi,this.zoom,He.brightness,ie,this.worldview);let Ir=Le[Pi.id]=Pi.createBucket({index:be.bucketLayerIDs.length,layers:Hi,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Mr,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:fe,worldview:this.worldview});be.bucketLayerIDs.push(Hi.map(_r=>n.C(_r.id,_r.scope)));let wr=Ir.prepare?Ir.prepare():null;wr!=null?(wr=wr.then(()=>Ir.populate(Qr,He,this.tileID.canonical,this.tileTransform)),kt.push(wr)):Ir.populate(Qr,He,this.tileID.canonical,this.tileTransform)}}let Xt=()=>{let ui,si,di,Yi,pi,Mr;st.trim();let Qr={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},$r=()=>{if(ui)return this.status="done",ye(ui);if(this.extraShadowCaster)this.status="done",ye(null,{buckets:Object.values(Le).filter(Pi=>!Pi.isEmpty()),featureIndex:be,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:He.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(si&&di&&Yi){let Pi=new we(si),Ir=new Map;for(let[ln,Un]of di.entries()){let{imagePosition:En}=n.fj(ln,Un,n.fk);Ir.set(ln,En)}let wr={};for(let ln in Le){let Un=Le[ln];Un instanceof n.b1&&(xe(Un.layers,this.zoom,He.brightness,ie,this.worldview),wr[ln]=n.fl(Un,si,Pi.positions,di,Ir,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,pi,this.worldview))}let _r={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(re,di,pi,()=>{_r.iconsPending=!1,Hi(wr,Pi,_r)}),this.rasterizeIfNeeded(re,Yi,Mr,()=>{_r.patternsPending=!1,Hi(wr,Pi,_r)})}},Hi=(Pi,Ir,wr,_r)=>{if(wr.iconsPending||wr.patternsPending)return;let ln=new n.fm(di,Yi,this.lut);for(let Un in Le){let En=Le[Un];if(Un in Pi)n.fn(En,Pi[Un],this.showCollisionBoxes,ie,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,di,ln);else if(En.hasPattern&&(En instanceof n.b7||En instanceof n.b8||En instanceof n.e4)){xe(En.layers,this.zoom,He.brightness,ie,this.worldview);let uc=Object.fromEntries(ln.patternPositions);En.addFeatures(He,this.tileID.canonical,uc,ie,this.tileTransform,this.brightness)}}this.status="done",ye(null,{buckets:Object.values(Le).filter(Un=>!Un.isEmpty()),featureIndex:be,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ir.image,lineAtlas:st,imageAtlas:ln,brightness:He.brightness})};if(!this.extraShadowCaster){let Pi=n.fh(He.glyphDependencies,_r=>Object.keys(_r).map(Number));Object.keys(Pi).length?re.send("getGlyphs",{uid:this.uid,stacks:Pi},(_r,ln)=>{ui||(ui=_r,si=ln,$r())},void 0,!1,Qr):si={};let Ir=Array.from(He.iconDependencies.keys()).map(_r=>n.I.parse(_r));Ir.length?re.send("getImages",{images:Ir,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(_r,ln)=>{ui||(ui=_r,di=new Map,pi=this.updateImageMapAndGetImageTaskQueue(di,ln,He.iconDependencies),$r())},void 0,!1,Qr):(di=new Map,pi=new Map);let wr=Array.from(He.patternDependencies.keys()).map(_r=>n.I.parse(_r));wr.length?re.send("getImages",{images:wr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(_r,ln)=>{ui||(ui=_r,Yi=new Map,Mr=this.updateImageMapAndGetImageTaskQueue(Yi,ln,He.patternDependencies),$r())},void 0,!1,Qr):(Yi=new Map,Mr=new Map)}if(He.elevationFeatures&&He.elevationFeatures.length>0){let Pi=[];for(let wr of Object.values(Le))if(wr instanceof n.b8){let _r=wr.getUnevaluatedPortalGraph();_r&&Pi.push(_r)}let Ir=n.fi.evaluate(Pi);for(let wr of Object.values(Le))if(wr instanceof n.b8){let _r=q.layers[De.decode(wr.sourceLayerIndex)];wr.setEvaluatedPortalGraph(Ir,_r,this.tileID.canonical,He.availableImages,He.brightness)}}$r()};kt.length>0?Promise.allSettled(kt).then(Xt).catch(ye):Xt()}rasterizeIfNeeded(q,$,ie,fe){Array.from($.values()).some(re=>re.usvg)?this.rasterize(q,$,ie,fe):fe()}updateImageMapAndGetImageTaskQueue(q,$,ie){let fe=new Map;for(let re of $.keys()){let ye=ie.get(re)||[];for(let De of ye){let be=De.toString(),Le=$.get(De.id.toString());Le.usvg?fe.has(be)||(fe.set(be,De),q.set(be,Object.assign({},Le))):q.set(be,Le)}}return fe}rasterize(q,$,ie,fe){this.rasterizeTask=q.send("rasterizeImages",{scope:this.scope,tasks:ie},(re,ye)=>{if(!re)for(let[De,be]of ye.entries()){let Le=Object.assign($.get(De),{data:be});$.set(De,Le)}fe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function xe(Re,q,$,ie,fe){let re=new n.aa(q,{brightness:$,worldview:fe});for(let ye of Re)ye.recalculate(re,ie)}class Ge extends n.E{constructor(q,$,ie,fe,re,ye,De){super(),this.actor=q,this.layerIndex=$,this.availableImages=ie,this.availableModels=fe,this.loadVectorData=ye||n.aJ,this.loading={},this.loaded={},this.deduped=new n.aI(q.scheduler),this.isSpriteLoaded=re,this.scheduler=q.scheduler,this.brightness=De}loadTile(q,$){let ie=q.uid,fe=q&&q.request,re=fe&&fe.collectResourceTiming,ye=this.loading[ie]=new Ae(q);ye.abort=this.loadVectorData(q,(De,be)=>{let Le=!this.loading[ie];if(delete this.loading[ie],ye.cancelRasterize(),Le||De||!be)return ye.status="done",Le||(this.loaded[ie]=ye),$(De);let st=be.rawData,He={};be.expires&&(He.expires=be.expires),be.cacheControl&&(He.cacheControl=be.cacheControl),ye.vectorTile=be.vectorTile||new n.fo(new n.bq(st));let kt=()=>{ye.parse(ye.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Ht,Xt)=>{if(Ht||!Xt)return $(Ht);let ui={};if(re){let si=O(fe);si.length>0&&(ui.resourceTiming=JSON.parse(JSON.stringify(si)))}$(null,n.h({rawTileData:st.slice(0)},Xt,He,ui))})};this.isSpriteLoaded?kt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(kt,{type:"parseTile",isSymbolTile:q.isSymbolTile,zoom:q.tileZoom}):kt()}),this.loaded=this.loaded||{},this.loaded[ie]=ye})}reloadTile(q,$){let ie=this.loaded,fe=q.uid;if(ie&&ie[fe]){let re=ie[fe];re.scaleFactor=q.scaleFactor,re.showCollisionBoxes=q.showCollisionBoxes,re.projection=q.projection,re.brightness=q.brightness,re.tileTransform=n.aW(q.tileID.canonical,q.projection),re.extraShadowCaster=q.extraShadowCaster,re.lut=q.lut,re.worldview=q.worldview;let ye=(De,be)=>{let Le=re.reloadCallback;Le&&(delete re.reloadCallback,re.parse(re.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Le)),$(De,be)};re.status==="parsing"?re.reloadCallback=ye:re.status==="done"&&(re.vectorTile?re.parse(re.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,ye):ye())}else $(null,void 0)}abortTile(q,$){let ie=q.uid,fe=this.loading[ie];fe&&(fe.abort&&fe.abort(),delete this.loading[ie]),$()}removeTile(q,$){let ie=this.loaded,fe=q.uid;ie&&ie[fe]&&delete ie[fe],$()}}class Te{loadTile(q,$){let{uid:ie,encoding:fe,rawImageData:re,padding:ye}=q,De=ImageBitmap&&re instanceof ImageBitmap?this.getImageData(re,ye):re;$(null,new n.fp(ie,De,fe,ye<1))}reloadTile(q,$){$(null,null)}abortTile(q,$){$()}removeTile(q,$){$()}getImageData(q,$){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(q.width,q.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=q.width,this.offscreenCanvas.height=q.height,this.offscreenCanvasContext.drawImage(q,0,0,q.width,q.height);let ie=this.offscreenCanvasContext.getImageData(-$,-$,q.width+2*$,q.height+2*$);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ie}}n.bp.setPbf(n.bq);class We{constructor(q){this._mrt=new n.bp(q.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=q.uid,this.tileID=q.tileID,this.source=q.source}parse(q,$){let ie=this._mrt;this.status="parsing",this._entireBuffer=q;try{ie.parseHeader(q),this._isHeaderLoaded=!0;let fe=[];for(let re in ie.layers){let ye=ie.getLayer(re),De=ye.getDataRange(ye.getBandList()),be=ie.createDecodingTask(De),Le=q.slice(De.firstByte,De.lastByte+1),st=n.bp.performDecoding(Le,be).then(He=>be.complete(null,He)).catch(He=>be.complete(He,null));fe.push(st)}Promise.allSettled(fe).then(()=>$(null,ie)).catch(re=>$(re))}catch(fe){$(fe)}}}class ft{constructor(q){this.actor=q,this.loading={},this.loaded={}}loadTile(q,$){let ie=q.uid,fe=q.request,re=this.loading[ie]=new We(q),{cancel:ye}=n.br(fe,(De,be,Le,st)=>{let He=!this.loading[ie];if(delete this.loading[ie],He||De||!be)return re.status="done",He||(this.loaded[ie]=re),$(De);re.parse(be,(kt,Ht)=>{if(kt||!Ht)return $(kt);$(null,Ht,Le,st)}),this.loaded[ie]=re});re.abort=ye}reloadTile(q,$){$(null,void 0)}abortTile(q,$){let ie=q.uid,fe=this.loading[ie];fe&&(fe.abort&&fe.abort(),delete this.loading[ie]),$()}removeTile(q,$){let ie=q.uid;this.loaded[ie]&&delete this.loaded[ie],$()}decodeRasterArray(q,$){n.bp.performDecoding(q.buffer,q.task).then(ie=>$(null,ie)).catch(ie=>$(ie))}}let _t=n.fq.prototype.toGeoJSON;class Pt{constructor(q){this._feature=q,this.extent=n.aj,this.type=q.type,this.properties=q.tags,"id"in q&&!isNaN(q.id)&&(this.id=parseInt(q.id,10))}loadGeometry(){if(this._feature.type===1){let q=[];for(let $ of this._feature.geometry)q.push([new n.P($[0],$[1])]);return q}{let q=[];for(let $ of this._feature.geometry){let ie=[];for(let fe of $)ie.push(new n.P(fe[0],fe[1]));q.push(ie)}return q}}toGeoJSON(q,$,ie){return _t.call(this,q,$,ie)}}class At{constructor(q,$){this.name=q,this.extent=n.aj,this.length=$.length,this._jsonFeatures=$}feature(q){return new Pt(this._jsonFeatures[q])}}class wt{constructor(q){this.layers={},this.extent=n.aj;for(let $ of Object.keys(q))this.layers[$]=new At($,q[$])}}let Ct=64/4096,Ft=128;class Wt{constructor(){this.features=new Map}clear(){this.features.clear()}load(q=[],$){for(let ie of q){let fe=ie.id;if(fe==null)continue;let re=this.features.get(fe);re&&this.updateCache(re,$),ie.geometry?(re=er(ie),this.updateCache(re,$),this.features.set(fe,re)):this.features.delete(fe),this.updateCache(re,$)}}updateCache(q,$){for(let{canonical:ie,uid:fe}of Object.values($)){let{z:re,x:ye,y:De}=ie;mt(q,Math.pow(2,re),ye,De)&&delete $[fe]}}getTile(q,$,ie){let fe=Math.pow(2,q),re=[];for(let ye of this.features.values())mt(ye,fe,$,ie)&&re.push(vi(ye,fe,$,ie));return{features:re}}getFeatures(){return[...this.features.values()]}}function mt({minX:Re,minY:q,maxX:$,maxY:ie},fe,re,ye){return Re<(re+1+Ct)/fe&&q<(ye+1+Ct)/fe&&$>(re-Ct)/fe&&ie>(ye-Ct)/fe}function er(Re){let{id:q,geometry:$,properties:ie}=Re;if(!$)return;if($.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");let{type:fe,coordinates:re}=$,ye={id:q,type:1,geometry:[],tags:ie,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},De=ye.geometry;if(fe==="Point")Ni(re,De,ye);else if(fe==="MultiPoint")for(let be of re)Ni(be,De,ye);else if(fe==="LineString")ye.type=2,yi(re,De,ye);else if(fe==="MultiLineString")ye.type=2,mi(re,De,ye);else if(fe==="Polygon")ye.type=3,mi(re,De,ye,!0);else{if(fe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");ye.type=3;for(let be of re)mi(be,De,ye,!0)}return ye}function Ni([Re,q],$,ie){let fe=n.aD(Re),re=n.aH(q);re=re<0?0:re>1?1:re,$.push(fe,re),ie.minX=Math.min(ie.minX,fe),ie.minY=Math.min(ie.minY,re),ie.maxX=Math.max(ie.maxX,fe),ie.maxY=Math.max(ie.maxY,re)}function yi(Re,q,$,ie=!1,fe=!1){let re=[];for(let ye of Re)Ni(ye,re,$);q.push(re),ie&&function(ye,De){let be=0;for(let Le=0,st=ye.length,He=st-2;Le<st;He=Le,Le+=2)be+=(ye[Le]-ye[He])*(ye[Le+1]+ye[He+1]);if(be>0===De)for(let Le=0,st=ye.length;Le<st/2;Le+=2){let He=ye[Le],kt=ye[Le+1];ye[Le]=ye[st-2-Le],ye[Le+1]=ye[st-1-Le],ye[st-2-Le]=He,ye[st-1-Le]=kt}}(re,fe)}function mi(Re,q,$,ie=!1){for(let fe=0;fe<Re.length;fe++)yi(Re[fe],q,$,ie,fe===0)}function vi(Re,q,$,ie){let{id:fe,type:re,geometry:ye,tags:De}=Re,be=[];if(re===1)(function(Le,st,He,kt,Ht){for(let Xt=0;Xt<Le.length;Xt+=2){let ui=Math.round(n.aj*(Le[Xt+0]*st-He)),si=Math.round(n.aj*(Le[Xt+1]*st-kt));Ht.push([ui,si])}})(ye,q,$,ie,be);else for(let Le of ye)mr(Le,q,$,ie,be);return{id:fe,type:re,geometry:be,tags:De}}function mr(Re,q,$,ie,fe){let re=-Ft,ye=n.aj+Ft,De;for(let be=0;be<Re.length-2;be+=2){let Le=Math.round(n.aj*(Re[be+0]*q-$)),st=Math.round(n.aj*(Re[be+1]*q-ie)),He=Math.round(n.aj*(Re[be+2]*q-$)),kt=Math.round(n.aj*(Re[be+3]*q-ie)),Ht=He-Le,Xt=kt-st;Le<re&&He<re||(Le<re?(st+=Math.round(Xt*((re-Le)/Ht)),Le=re):He<re&&(kt=st+Math.round(Xt*((re-Le)/Ht)),He=re),st<re&&kt<re||(st<re?(Le+=Math.round(Ht*((re-st)/Xt)),st=re):kt<re&&(He=Le+Math.round(Ht*((re-st)/Xt)),kt=re),Le>=ye&&He>=ye||(Le>=ye?(st+=Math.round(Xt*((ye-Le)/Ht)),Le=ye):He>=ye&&(kt=st+Math.round(Xt*((ye-Le)/Ht)),He=ye),st>=ye&&kt>=ye||(st>=ye?(Le+=Math.round(Ht*((ye-st)/Xt)),st=ye):kt>=ye&&(He=Le+Math.round(Ht*((ye-st)/Xt)),kt=ye),De&&Le===De[De.length-1][0]&&st===De[De.length-1][1]||(De=[[Le,st]],fe.push(De)),De.push([He,kt])))))}}function Fr({name:Re,features:q},$){$.writeStringField(1,Re),$.writeVarintField(5,n.aj);let ie=new Map,fe=new Map,re={keys:ie,values:fe,feature:null};for(let ye of q)re.feature=ye,$.writeMessage(2,Rr,re);for(let ye of ie.keys())$.writeStringField(3,ye);for(let ye of fe.keys())$.writeMessage(4,Ro,ye)}function Rr(Re,q){let $=Re.feature;$.id===void 0||isNaN(+$.id)||q.writeVarintField(1,+$.id),$.tags&&q.writeMessage(2,Hr,Re),q.writeVarintField(3,$.type),q.writeMessage(4,Po,$)}function Hr({keys:Re,values:q,feature:$},ie){for(let fe of Object.keys($.tags)){let re=$.tags[fe];if(re===null)continue;let ye=Re.get(fe);ye===void 0&&(ye=Re.size,Re.set(fe,ye)),ie.writeVarint(ye);let De=typeof re;De!=="string"&&De!=="boolean"&&De!=="number"&&(re=JSON.stringify(re));let be=q.get(re);be===void 0&&(be=q.size,q.set(re,be)),ie.writeVarint(be)}}function Xi(Re,q){return(q<<3)+(7&Re)}function tn(Re){return Re<<1^Re>>31}function Po(Re,q){let{geometry:$,type:ie}=Re,fe=0,re=0;if(ie===1){q.writeVarint(Xi(1,$.length));for(let ye of $){let De=ye[0]-fe,be=ye[1]-re;q.writeVarint(tn(De)),q.writeVarint(tn(be)),fe+=De,re+=be}}else for(let ye of $){q.writeVarint(Xi(1,1));let De=ye.length-(ie===3?1:0);for(let be=0;be<De;be++){be===1&&q.writeVarint(Xi(2,De-1));let Le=ye[be][0]-fe,st=ye[be][1]-re;q.writeVarint(tn(Le)),q.writeVarint(tn(st)),fe+=Le,re+=st}ie===3&&q.writeVarint(Xi(7,1))}}function Ro(Re,q){let $=typeof Re;$==="string"?q.writeStringField(1,Re):$==="boolean"?q.writeBooleanField(7,Re):$==="number"&&(Re%1!=0?q.writeDoubleField(3,Re):Re<0?q.writeSVarintField(6,Re):q.writeVarintField(5,Re))}let Zo={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Re=>Re},Oi=Math.fround||(or=new Float32Array(1),Re=>(or[0]=+Re,or[0]));var or;let Vr=3,Bn=5,Lr=6;class ks{constructor(q){this.options=Object.assign(Object.create(Zo),q),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(q){let{log:$,minZoom:ie,maxZoom:fe}=this.options;$&&console.time("total time");let re=`prepare ${q.length} points`;$&&console.time(re),this.points=q;let ye=[];for(let be=0;be<q.length;be++){let Le=q[be];if(!Le.geometry)continue;let[st,He]=Le.geometry.coordinates,kt=Oi(Lo(st)),Ht=Oi(zr(He));ye.push(kt,Ht,1/0,be,-1,1),this.options.reduce&&ye.push(0)}let De=this.trees[fe+1]=this._createTree(ye);$&&console.timeEnd(re);for(let be=fe;be>=ie;be--){let Le=+Date.now();De=this.trees[be]=this._createTree(this._cluster(De,be)),$&&console.log("z%d: %d clusters in %dms",be,De.numItems,+Date.now()-Le)}return $&&console.timeEnd("total time"),this}getClusters(q,$){let ie=((q[0]+180)%360+360)%360-180,fe=Math.max(-90,Math.min(90,q[1])),re=q[2]===180?180:((q[2]+180)%360+360)%360-180,ye=Math.max(-90,Math.min(90,q[3]));if(q[2]-q[0]>=360)ie=-180,re=180;else if(ie>re){let He=this.getClusters([ie,fe,180,ye],$),kt=this.getClusters([-180,fe,re,ye],$);return He.concat(kt)}let De=this.trees[this._limitZoom($)],be=De.range(Lo(ie),zr(ye),Lo(re),zr(fe)),Le=De.data,st=[];for(let He of be){let kt=this.stride*He;st.push(Le[kt+Bn]>1?Fs(Le,kt,this.clusterProps):this.points[Le[kt+Vr]])}return st}getChildren(q){let $=this._getOriginId(q),ie=this._getOriginZoom(q),fe="No cluster with the specified id.",re=this.trees[ie];if(!re)throw new Error(fe);let ye=re.data;if($*this.stride>=ye.length)throw new Error(fe);let De=this.options.radius/(this.options.extent*Math.pow(2,ie-1)),be=re.within(ye[$*this.stride],ye[$*this.stride+1],De),Le=[];for(let st of be){let He=st*this.stride;ye[He+4]===q&&Le.push(ye[He+Bn]>1?Fs(ye,He,this.clusterProps):this.points[ye[He+Vr]])}if(Le.length===0)throw new Error(fe);return Le}getLeaves(q,$,ie){let fe=[];return this._appendLeaves(fe,q,$=$||10,ie=ie||0,0),fe}getTile(q,$,ie){let fe=this.trees[this._limitZoom(q)],re=Math.pow(2,q),{extent:ye,radius:De}=this.options,be=De/ye,Le=(ie-be)/re,st=(ie+1+be)/re,He={features:[]};return this._addTileFeatures(fe.range(($-be)/re,Le,($+1+be)/re,st),fe.data,$,ie,re,He),$===0&&this._addTileFeatures(fe.range(1-be/re,Le,1,st),fe.data,re,ie,re,He),$===re-1&&this._addTileFeatures(fe.range(0,Le,be/re,st),fe.data,-1,ie,re,He),He.features.length?He:null}getClusterExpansionZoom(q){let $=this._getOriginZoom(q)-1;for(;$<=this.options.maxZoom;){let ie=this.getChildren(q);if($++,ie.length!==1)break;q=ie[0].properties.cluster_id}return $}_appendLeaves(q,$,ie,fe,re){let ye=this.getChildren($);for(let De of ye){let be=De.properties;if(be&&be.cluster?re+be.point_count<=fe?re+=be.point_count:re=this._appendLeaves(q,be.cluster_id,ie,fe,re):re<fe?re++:q.push(De),q.length===ie)break}return re}_createTree(q){let $=new n.c0(q.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ie=0;ie<q.length;ie+=this.stride)$.add(q[ie],q[ie+1]);return $.finish(),$.data=q,$}_addTileFeatures(q,$,ie,fe,re,ye){for(let De of q){let be=De*this.stride,Le=$[be+Bn]>1,st,He,kt;if(Le)st=nc($,be,this.clusterProps),He=$[be],kt=$[be+1];else{let ui=this.points[$[be+Vr]];st=ui.properties;let[si,di]=ui.geometry.coordinates;He=Lo(si),kt=zr(di)}let Ht={type:1,geometry:[[Math.round(this.options.extent*(He*re-ie)),Math.round(this.options.extent*(kt*re-fe))]],tags:st},Xt;Xt=Le||this.options.generateId?$[be+Vr]:this.points[$[be+Vr]].id,Xt!==void 0&&(Ht.id=Xt),ye.features.push(Ht)}}_limitZoom(q){return Math.max(this.options.minZoom,Math.min(Math.floor(+q),this.options.maxZoom+1))}_cluster(q,$){let{radius:ie,extent:fe,reduce:re,minPoints:ye}=this.options,De=ie/(fe*Math.pow(2,$)),be=q.data,Le=[],st=this.stride;for(let He=0;He<be.length;He+=st){if(be[He+2]<=$)continue;be[He+2]=$;let kt=be[He],Ht=be[He+1],Xt=q.within(be[He],be[He+1],De),ui=be[He+Bn],si=ui;for(let di of Xt){let Yi=di*st;be[Yi+2]>$&&(si+=be[Yi+Bn])}if(si>ui&&si>=ye){let di,Yi=kt*ui,pi=Ht*ui,Mr=-1,Qr=(He/st<<5)+($+1)+this.points.length;for(let $r of Xt){let Hi=$r*st;if(be[Hi+2]<=$)continue;be[Hi+2]=$;let Pi=be[Hi+Bn];Yi+=be[Hi]*Pi,pi+=be[Hi+1]*Pi,be[Hi+4]=Qr,re&&(di||(di=this._map(be,He,!0),Mr=this.clusterProps.length,this.clusterProps.push(di)),re(di,this._map(be,Hi)))}be[He+4]=Qr,Le.push(Yi/si,pi/si,1/0,Qr,-1,si),re&&Le.push(Mr)}else{for(let di=0;di<st;di++)Le.push(be[He+di]);if(si>1)for(let di of Xt){let Yi=di*st;if(!(be[Yi+2]<=$)){be[Yi+2]=$;for(let pi=0;pi<st;pi++)Le.push(be[Yi+pi])}}}}return Le}_getOriginId(q){return q-this.points.length>>5}_getOriginZoom(q){return(q-this.points.length)%32}_map(q,$,ie){if(q[$+Bn]>1){let ye=this.clusterProps[q[$+Lr]];return ie?Object.assign({},ye):ye}let fe=this.points[q[$+Vr]].properties,re=this.options.map(fe);return ie&&re===fe?Object.assign({},re):re}}function Fs(Re,q,$){return{type:"Feature",id:Re[q+Vr],properties:nc(Re,q,$),geometry:{type:"Point",coordinates:[(ie=Re[q],360*(ie-.5)),Nn(Re[q+1])]}};var ie}function nc(Re,q,$){let ie=Re[q+Bn],fe=ie>=1e4?`${Math.round(ie/1e3)}k`:ie>=1e3?Math.round(ie/100)/10+"k":ie,re=Re[q+Lr],ye=re===-1?{}:Object.assign({},$[re]);return Object.assign(ye,{cluster:!0,cluster_id:Re[q+Vr],point_count:ie,point_count_abbreviated:fe})}function Lo(Re){return Re/360+.5}function zr(Re){let q=Math.sin(Re*Math.PI/180),$=.5-.25*Math.log((1+q)/(1-q))/Math.PI;return $<0?0:$>1?1:$}function Nn(Re){let q=(180-360*Re)*Math.PI/180;return 360*Math.atan(Math.exp(q))/Math.PI-90}function Bs(Re,q,$,ie){let fe=ie,re=q+($-q>>1),ye,De=$-q,be=Re[q],Le=Re[q+1],st=Re[$],He=Re[$+1];for(let kt=q+3;kt<$;kt+=3){let Ht=oc(Re[kt],Re[kt+1],be,Le,st,He);if(Ht>fe)ye=kt,fe=Ht;else if(Ht===fe){let Xt=Math.abs(kt-re);Xt<De&&(ye=kt,De=Xt)}}fe>ie&&(ye-q>3&&Bs(Re,q,ye,ie),Re[ye+2]=fe,$-ye>3&&Bs(Re,ye,$,ie))}function oc(Re,q,$,ie,fe,re){let ye=fe-$,De=re-ie;if(ye!==0||De!==0){let be=((Re-$)*ye+(q-ie)*De)/(ye*ye+De*De);be>1?($=fe,ie=re):be>0&&($+=ye*be,ie+=De*be)}return ye=Re-$,De=q-ie,ye*ye+De*De}function xs(Re,q,$,ie){let fe={id:Re??null,type:q,geometry:$,tags:ie,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(q==="Point"||q==="MultiPoint"||q==="LineString")co(fe,$);else if(q==="Polygon")co(fe,$[0]);else if(q==="MultiLineString")for(let re of $)co(fe,re);else if(q==="MultiPolygon")for(let re of $)co(fe,re[0]);return fe}function co(Re,q){for(let $=0;$<q.length;$+=3)Re.minX=Math.min(Re.minX,q[$]),Re.minY=Math.min(Re.minY,q[$+1]),Re.maxX=Math.max(Re.maxX,q[$]),Re.maxY=Math.max(Re.maxY,q[$+1])}function Yn(Re,q,$,ie){if(!q.geometry)return;let fe=q.geometry.coordinates;if(fe&&fe.length===0)return;let re=q.geometry.type,ye=Math.pow($.tolerance/((1<<$.maxZoom)*$.extent),2),De=[],be=q.id;if($.promoteId?be=q.properties[$.promoteId]:$.generateId&&(be=ie||0),re==="Point")vs(fe,De);else if(re==="MultiPoint")for(let Le of fe)vs(Le,De);else if(re==="LineString")bs(fe,De,ye,!1);else if(re==="MultiLineString"){if($.lineMetrics){for(let Le of fe)De=[],bs(Le,De,ye,!1),Re.push(xs(be,"LineString",De,q.properties));return}xa(fe,De,ye,!1)}else if(re==="Polygon")xa(fe,De,ye,!0);else{if(re!=="MultiPolygon"){if(re==="GeometryCollection"){for(let Le of q.geometry.geometries)Yn(Re,{id:be,geometry:Le,properties:q.properties},$,ie);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let Le of fe){let st=[];xa(Le,st,ye,!0),De.push(st)}}Re.push(xs(be,re,De,q.properties))}function vs(Re,q){q.push(Ya(Re[0]),Vn(Re[1]),0)}function bs(Re,q,$,ie){let fe,re,ye=0;for(let be=0;be<Re.length;be++){let Le=Ya(Re[be][0]),st=Vn(Re[be][1]);q.push(Le,st,0),be>0&&(ye+=ie?(fe*st-Le*re)/2:Math.sqrt(Math.pow(Le-fe,2)+Math.pow(st-re,2))),fe=Le,re=st}let De=q.length-3;q[2]=1,Bs(q,0,De,$),q[De+2]=1,q.size=Math.abs(ye),q.start=0,q.end=q.size}function xa(Re,q,$,ie){for(let fe=0;fe<Re.length;fe++){let re=[];bs(Re[fe],re,$,ie),q.push(re)}}function Ya(Re){return Re/360+.5}function Vn(Re){let q=Math.sin(Re*Math.PI/180),$=.5-.25*Math.log((1+q)/(1-q))/Math.PI;return $<0?0:$>1?1:$}function ho(Re,q,$,ie,fe,re,ye,De){if(ie/=q,re>=($/=q)&&ye<ie)return Re;if(ye<$||re>=ie)return null;let be=[];for(let Le of Re){let st=Le.geometry,He=Le.type,kt=fe===0?Le.minX:Le.minY,Ht=fe===0?Le.maxX:Le.maxY;if(kt>=$&&Ht<ie){be.push(Le);continue}if(Ht<$||kt>=ie)continue;let Xt=[];if(He==="Point"||He==="MultiPoint")sc(st,Xt,$,ie,fe);else if(He==="LineString")ws(st,Xt,$,ie,fe,!1,De.lineMetrics);else if(He==="MultiLineString")Sn(st,Xt,$,ie,fe,!1);else if(He==="Polygon")Sn(st,Xt,$,ie,fe,!0);else if(He==="MultiPolygon")for(let ui of st){let si=[];Sn(ui,si,$,ie,fe,!0),si.length&&Xt.push(si)}if(Xt.length){if(De.lineMetrics&&He==="LineString"){for(let ui of Xt)be.push(xs(Le.id,He,ui,Le.tags));continue}He!=="LineString"&&He!=="MultiLineString"||(Xt.length===1?(He="LineString",Xt=Xt[0]):He="MultiLineString"),He!=="Point"&&He!=="MultiPoint"||(He=Xt.length===3?"Point":"MultiPoint"),be.push(xs(Le.id,He,Xt,Le.tags))}}return be.length?be:null}function sc(Re,q,$,ie,fe){for(let re=0;re<Re.length;re+=3){let ye=Re[re+fe];ye>=$&&ye<=ie&&uo(q,Re[re],Re[re+1],Re[re+2])}}function ws(Re,q,$,ie,fe,re,ye){let De=Ka(Re),be=fe===0?Ns:Ts,Le,st,He=Re.start;for(let si=0;si<Re.length-3;si+=3){let di=Re[si],Yi=Re[si+1],pi=Re[si+2],Mr=Re[si+3],Qr=Re[si+4],$r=fe===0?di:Yi,Hi=fe===0?Mr:Qr,Pi=!1;ye&&(Le=Math.sqrt(Math.pow(di-Mr,2)+Math.pow(Yi-Qr,2))),$r<$?Hi>$&&(st=be(De,di,Yi,Mr,Qr,$),ye&&(De.start=He+Le*st)):$r>ie?Hi<ie&&(st=be(De,di,Yi,Mr,Qr,ie),ye&&(De.start=He+Le*st)):uo(De,di,Yi,pi),Hi<$&&$r>=$&&(st=be(De,di,Yi,Mr,Qr,$),Pi=!0),Hi>ie&&$r<=ie&&(st=be(De,di,Yi,Mr,Qr,ie),Pi=!0),!re&&Pi&&(ye&&(De.end=He+Le*st),q.push(De),De=Ka(Re)),ye&&(He+=Le)}let kt=Re.length-3,Ht=Re[kt],Xt=Re[kt+1],ui=fe===0?Ht:Xt;ui>=$&&ui<=ie&&uo(De,Ht,Xt,Re[kt+2]),kt=De.length-3,re&&kt>=3&&(De[kt]!==De[0]||De[kt+1]!==De[1])&&uo(De,De[0],De[1],De[2]),De.length&&q.push(De)}function Ka(Re){let q=[];return q.size=Re.size,q.start=Re.start,q.end=Re.end,q}function Sn(Re,q,$,ie,fe,re){for(let ye of Re)ws(ye,q,$,ie,fe,re,!1)}function uo(Re,q,$,ie){Re.push(q,$,ie)}function Ns(Re,q,$,ie,fe,re){let ye=(re-q)/(ie-q);return uo(Re,re,$+(fe-$)*ye,1),ye}function Ts(Re,q,$,ie,fe,re){let ye=(re-$)/(fe-$);return uo(Re,q+(ie-q)*ye,re,1),ye}function Vs(Re,q){let $=[];for(let ie=0;ie<Re.length;ie++){let fe=Re[ie],re=fe.type,ye;if(re==="Point"||re==="MultiPoint"||re==="LineString")ye=Us(fe.geometry,q);else if(re==="MultiLineString"||re==="Polygon"){ye=[];for(let De of fe.geometry)ye.push(Us(De,q))}else if(re==="MultiPolygon"){ye=[];for(let De of fe.geometry){let be=[];for(let Le of De)be.push(Us(Le,q));ye.push(be)}}$.push(xs(fe.id,re,ye,fe.tags))}return $}function Us(Re,q){let $=[];$.size=Re.size,Re.start!==void 0&&($.start=Re.start,$.end=Re.end);for(let ie=0;ie<Re.length;ie+=3)$.push(Re[ie]+q,Re[ie+1],Re[ie+2]);return $}function Ja(Re,q){if(Re.transformed)return Re;let $=1<<Re.z,ie=Re.x,fe=Re.y;for(let re of Re.features){let ye=re.geometry,De=re.type;if(re.geometry=[],De===1)for(let be=0;be<ye.length;be+=2)re.geometry.push(hr(ye[be],ye[be+1],q,$,ie,fe));else for(let be=0;be<ye.length;be++){let Le=[];for(let st=0;st<ye[be].length;st+=2)Le.push(hr(ye[be][st],ye[be][st+1],q,$,ie,fe));re.geometry.push(Le)}}return Re.transformed=!0,Re}function hr(Re,q,$,ie,fe,re){return[Math.round($*(Re*ie-fe)),Math.round($*(q*ie-re))]}function ac(Re,q,$,ie,fe){let re=q===fe.maxZoom?0:fe.tolerance/((1<<q)*fe.extent),ye={features:[],numPoints:0,numSimplified:0,numFeatures:Re.length,source:null,x:$,y:ie,z:q,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let De of Re)lc(ye,De,re,fe);return ye}function lc(Re,q,$,ie){let fe=q.geometry,re=q.type,ye=[];if(Re.minX=Math.min(Re.minX,q.minX),Re.minY=Math.min(Re.minY,q.minY),Re.maxX=Math.max(Re.maxX,q.maxX),Re.maxY=Math.max(Re.maxY,q.maxY),re==="Point"||re==="MultiPoint")for(let De=0;De<fe.length;De+=3)ye.push(fe[De],fe[De+1]),Re.numPoints++,Re.numSimplified++;else if(re==="LineString")po(ye,fe,Re,$,!1,!1);else if(re==="MultiLineString"||re==="Polygon")for(let De=0;De<fe.length;De++)po(ye,fe[De],Re,$,re==="Polygon",De===0);else if(re==="MultiPolygon")for(let De=0;De<fe.length;De++){let be=fe[De];for(let Le=0;Le<be.length;Le++)po(ye,be[Le],Re,$,!0,Le===0)}if(ye.length){let De=q.tags||null;if(re==="LineString"&&ie.lineMetrics){De={};for(let Le in q.tags)De[Le]=q.tags[Le];De.mapbox_clip_start=fe.start/fe.size,De.mapbox_clip_end=fe.end/fe.size}let be={geometry:ye,type:re==="Polygon"||re==="MultiPolygon"?3:re==="LineString"||re==="MultiLineString"?2:1,tags:De};q.id!==null&&(be.id=q.id),Re.features.push(be)}}function po(Re,q,$,ie,fe,re){let ye=ie*ie;if(ie>0&&q.size<(fe?ye:ie))return void($.numPoints+=q.length/3);let De=[];for(let be=0;be<q.length;be+=3)(ie===0||q[be+2]>ye)&&($.numSimplified++,De.push(q[be],q[be+1])),$.numPoints++;fe&&function(be,Le){let st=0;for(let He=0,kt=be.length,Ht=kt-2;He<kt;Ht=He,He+=2)st+=(be[He]-be[Ht])*(be[He+1]+be[Ht+1]);if(st>0===Le)for(let He=0,kt=be.length;He<kt/2;He+=2){let Ht=be[He],Xt=be[He+1];be[He]=be[kt-2-He],be[He+1]=be[kt-1-He],be[kt-2-He]=Ht,be[kt-1-He]=Xt}}(De,re),Re.push(De)}let cc={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class ad{constructor(q,$){let ie=($=this.options=function(re,ye){for(let De in ye)re[De]=ye[De];return re}(Object.create(cc),$)).debug;if(ie&&console.time("preprocess data"),$.maxZoom<0||$.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if($.promoteId&&$.generateId)throw new Error("promoteId and generateId cannot be used together.");let fe=function(re,ye){let De=[];if(re.type==="FeatureCollection")for(let be=0;be<re.features.length;be++)Yn(De,re.features[be],ye,be);else Yn(De,re.type==="Feature"?re:{geometry:re},ye);return De}(q,$);this.tiles={},this.tileCoords=[],ie&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",$.indexMaxZoom,$.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),fe=function(re,ye){let De=ye.buffer/ye.extent,be=re,Le=ho(re,1,-1-De,De,0,-1,2,ye),st=ho(re,1,1-De,2+De,0,-1,2,ye);return(Le||st)&&(be=ho(re,1,-De,1+De,0,-1,2,ye)||[],Le&&(be=Vs(Le,1).concat(be)),st&&(be=be.concat(Vs(st,-1)))),be}(fe,$),fe.length&&this.splitTile(fe,0,0,0),ie&&(fe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(q,$,ie,fe,re,ye,De){let be=[q,$,ie,fe],Le=this.options,st=Le.debug;for(;be.length;){fe=be.pop(),ie=be.pop(),$=be.pop(),q=be.pop();let He=1<<$,kt=Qa($,ie,fe),Ht=this.tiles[kt];if(!Ht&&(st>1&&console.time("creation"),Ht=this.tiles[kt]=ac(q,$,ie,fe,Le),this.tileCoords.push({z:$,x:ie,y:fe}),st)){st>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",$,ie,fe,Ht.numFeatures,Ht.numPoints,Ht.numSimplified),console.timeEnd("creation"));let Pi=`z${$}`;this.stats[Pi]=(this.stats[Pi]||0)+1,this.total++}if(Ht.source=q,re==null){if($===Le.indexMaxZoom||Ht.numPoints<=Le.indexMaxPoints)continue}else{if($===Le.maxZoom||$===re)continue;if(re!=null){let Pi=re-$;if(ie!==ye>>Pi||fe!==De>>Pi)continue}}if(Ht.source=null,q.length===0)continue;st>1&&console.time("clipping");let Xt=.5*Le.buffer/Le.extent,ui=.5-Xt,si=.5+Xt,di=1+Xt,Yi=null,pi=null,Mr=null,Qr=null,$r=ho(q,He,ie-Xt,ie+si,0,Ht.minX,Ht.maxX,Le),Hi=ho(q,He,ie+ui,ie+di,0,Ht.minX,Ht.maxX,Le);q=null,$r&&(Yi=ho($r,He,fe-Xt,fe+si,1,Ht.minY,Ht.maxY,Le),pi=ho($r,He,fe+ui,fe+di,1,Ht.minY,Ht.maxY,Le),$r=null),Hi&&(Mr=ho(Hi,He,fe-Xt,fe+si,1,Ht.minY,Ht.maxY,Le),Qr=ho(Hi,He,fe+ui,fe+di,1,Ht.minY,Ht.maxY,Le),Hi=null),st>1&&console.timeEnd("clipping"),be.push(Yi||[],$+1,2*ie,2*fe),be.push(pi||[],$+1,2*ie,2*fe+1),be.push(Mr||[],$+1,2*ie+1,2*fe),be.push(Qr||[],$+1,2*ie+1,2*fe+1)}}getTile(q,$,ie){q=+q,$=+$,ie=+ie;let fe=this.options,{extent:re,debug:ye}=fe;if(q<0||q>24)return null;let De=1<<q,be=Qa(q,$=$+De&De-1,ie);if(this.tiles[be])return Ja(this.tiles[be],re);ye>1&&console.log("drilling down to z%d-%d-%d",q,$,ie);let Le,st=q,He=$,kt=ie;for(;!Le&&st>0;)st--,He>>=1,kt>>=1,Le=this.tiles[Qa(st,He,kt)];return Le&&Le.source?(ye>1&&(console.log("found parent tile z%d-%d-%d",st,He,kt),console.time("drilling down")),this.splitTile(Le.source,st,He,kt,q,$,ie),ye>1&&console.timeEnd("drilling down"),this.tiles[be]?Ja(this.tiles[be],re):null):null}}function Qa(Re,q,$){return 32*((1<<Re)*$+q)+Re}function Qe(Re,q){let $=Re.tileID.canonical;if(!this._geoJSONIndex)return void q(null,null);let ie=this._geoJSONIndex.getTile($.z,$.x,$.y);if(!ie)return void q(null,null);let fe=Le=>Le.tags&&"3d_elevation_id"in Le.tags&&"source"in Le.tags&&Le.tags.source==="elevation",re=ie.features.filter(Le=>fe(Le)),ye={_geojsonTileLayer:ie.features};re.length>0&&(ye={_geojsonTileLayer:ie.features.filter(Le=>!fe(Le)),hd_road_elevation:re});let De=new wt(ye),be=function(Le){let st=new n.bq;for(let He of Object.keys(Le))st.writeMessage(3,Fr,{name:He,features:Le[He]});return st.finish()}(ye).buffer;q(null,{vectorTile:De,rawData:be})}class Ss extends Ge{constructor(q,$,ie,fe,re,ye,De){super(q,$,ie,fe,re,Qe,De),ye&&(this.loadGeoJSON=ye),this._dynamicIndex=new Wt}loadData(q,$){let ie=q&&q.request,fe=ie&&ie.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(q,(re,ye)=>{if(re||!ye)return $(re);if(typeof ye!="object")return $(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`));{try{if(q.filter){let be=n.X(q.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(be.result==="error")throw new Error(be.value.map(Le=>`${Le.key}: ${Le.message}`).join(", "));ye.features=ye.features.filter(Le=>be.value.evaluate({zoom:0},Le))}q.dynamic?(ye.type==="Feature"&&(ye={type:"FeatureCollection",features:[ye]}),q.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(ye.features,this.loaded),q.cluster&&(ye.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=q.cluster?new ks(function({superclusterOptions:be,clusterProperties:Le}){if(!Le||!be)return be;let st={},He={},kt={accumulated:null,zoom:0},Ht={properties:null},Xt=Object.keys(Le);for(let ui of Xt){let[si,di]=Le[ui],Yi=n.X(di),pi=n.X(typeof si=="string"?[si,["accumulated"],["get",ui]]:si);st[ui]=Yi.value,He[ui]=pi.value}return be.map=ui=>{Ht.properties=ui;let si={};for(let di of Xt)si[di]=st[di].evaluate(kt,Ht);return si},be.reduce=(ui,si)=>{Ht.properties=si;for(let di of Xt)kt.accumulated=ui[di],ui[di]=He[di].evaluate(kt,Ht)},be}(q)).load(ye.features):q.dynamic?this._dynamicIndex:function(be,Le){return new ad(be,Le)}(ye,q.geojsonVtOptions)}catch(be){return $(be)}let De={};if(fe){let be=O(ie);be&&(De.resourceTiming={},De.resourceTiming[q.source]=JSON.parse(JSON.stringify(be)))}$(null,De)}})}reloadTile(q,$){let ie=this.loaded;return ie&&ie[q.uid]?q.partial?$(null,void 0):super.reloadTile(q,$):this.loadTile(q,$)}loadGeoJSON(q,$){if(q.request)n.n(q.request,$);else{if(typeof q.data!="string")return $(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return $(null,JSON.parse(q.data))}catch{return $(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(q,$){try{$(null,this._geoJSONIndex.getClusterExpansionZoom(q.clusterId))}catch(ie){$(ie)}}getClusterChildren(q,$){try{$(null,this._geoJSONIndex.getChildren(q.clusterId))}catch(ie){$(ie)}}getClusterLeaves(q,$){try{$(null,this._geoJSONIndex.getLeaves(q.clusterId,q.limit,q.offset))}catch(ie){$(ie)}}}class ld{constructor(q,$,ie){this.tileID=new n.aM(q.tileID.overscaledZ,q.tileID.wrap,q.tileID.canonical.z,q.tileID.canonical.x,q.tileID.canonical.y),this.tileZoom=q.tileZoom,this.uid=q.uid,this.zoom=q.zoom,this.canonical=q.tileID.canonical,this.pixelRatio=q.pixelRatio,this.tileSize=q.tileSize,this.source=q.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=q.projection,this.brightness=$,this.worldview=ie}parse(q,$,ie,fe){this.status="parsing";let re=new n.aM(ie.tileID.overscaledZ,ie.tileID.wrap,ie.tileID.canonical.z,ie.tileID.canonical.x,ie.tileID.canonical.y),ye=[],De=$.familiesBySource[ie.source],be=new n.fc(re,ie.promoteId);be.bucketLayerIDs=[],be.is3DTile=!0,n.fr(q).then(Le=>{if(!Le)return fe(new Error("Could not parse tile"));let st=Le.json.extensionsUsed&&Le.json.extensionsUsed.includes("MAPBOX_mesh_features")||Le.json.asset.extras&&Le.json.asset.extras.MAPBOX_mesh_features,He=Le.json.extensionsUsed&&Le.json.extensionsUsed.includes("EXT_meshopt_compression"),kt=new n.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(let Ht in De)for(let Xt of De[Ht]){let ui=Xt[0];be.bucketLayerIDs.push(Xt.map(Yi=>n.C(Yi.id,Yi.scope))),ui.recalculate(kt,[]);let si=n.fs(Le,1/n.d4(ie.tileID.canonical)),di=new n.ft(Xt,si,re,st,He,this.brightness,be,this.worldview);st||(di.needsUpload=!0),ye.push(di),di.evaluate(ui)}this.status="done",fe(null,{buckets:ye,featureIndex:be,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Le=>fe(new Error(Le.message)))}}class hc{constructor(q,$,ie,fe,re,ye,De,be){this.actor=q,this.layerIndex=$,this.availableImages=ie,this.availableModels=fe,this.brightness=De,this.loading={},this.loaded={},this.worldview=be}loadTile(q,$){let ie=q.uid,fe=this.loading[ie]=new ld(q,this.brightness,this.worldview);n.br(q.request,(re,ye)=>{let De=!this.loading[ie];return delete this.loading[ie],De||re?(fe.status="done",De||(this.loaded[ie]=fe),$(re)):ye&&ye.byteLength!==0?void fe.parse(ye,this.layerIndex,q,(be,Le)=>{fe.status="done",this.loaded=this.loaded||{},this.loaded[ie]=fe,be||!Le?$(be):$(null,Le)}):(fe.status="done",this.loaded[ie]=fe,$())})}reloadTile(q,$){let ie=this.loaded,fe=q.uid;if(ie&&ie[fe]){let re=ie[fe];re.projection=q.projection,re.brightness=q.brightness;let ye=(De,be)=>{re.reloadCallback&&(delete re.reloadCallback,this.loadTile(q,$)),$(De,be)};re.status==="parsing"?re.reloadCallback=ye:re.status==="done"&&this.loadTile(q,$)}}abortTile(q,$){let ie=q.uid;this.loading[ie]&&delete this.loading[ie],$()}removeTile(q,$){let ie=this.loaded,fe=q.uid;ie&&ie[fe]&&delete ie[fe],$()}}class Ai{constructor(q){this.self=q,this.actor=new n.fv(q,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new n.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=n.cj({name:"mercator"}),this.workerSourceTypes={vector:Ge,geojson:Ss,"raster-dem":Te,"raster-array":ft,"batched-model":hc},this.workerSources={},this.self.registerWorkerSource=($,ie)=>{if(this.workerSourceTypes[$])throw new Error(`Worker source with name "${$}" already registered.`);this.workerSourceTypes[$]=ie},this.self.registerRTLTextPlugin=$=>{if(n.fw.isParsed())throw new Error("RTL text plugin already registered.");n.fw.setState({pluginStatus:n.fx.parsed,pluginURL:n.fw.getPluginURL()}),n.fw.applyArabicShaping=$.applyArabicShaping,n.fw.processBidirectionalText=$.processBidirectionalText,n.fw.processStyledBidirectionalText=$.processStyledBidirectionalText;for(let ie of this.rtlPluginParsingListeners)ie(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(q,$,ie){delete this.layerIndexes[q],delete this.availableImages[q],delete this.availableModels[q],delete this.workerSources[q],ie()}checkIfReady(q,$,ie){ie()}setReferrer(q,$){this.referrer=$}spriteLoaded(q,$){this.isSpriteLoaded[q]||(this.isSpriteLoaded[q]={});let{scope:ie,isLoaded:fe}=$;if(this.isSpriteLoaded[q][ie]=fe,this.workerSources[q]&&this.workerSources[q][ie])for(let re in this.workerSources[q][ie]){let ye=this.workerSources[q][ie][re];for(let De in ye){let be=ye[De];be instanceof Ge&&(be.isSpriteLoaded=fe,be.fire(new n.A("isSpriteLoaded")))}}}setImages(q,$,ie){this.availableImages[q]||(this.availableImages[q]={});let{scope:fe,images:re}=$;if(this.availableImages[q][fe]=re,this.workerSources[q]&&this.workerSources[q][fe]){for(let ye in this.workerSources[q][fe]){let De=this.workerSources[q][fe][ye];for(let be in De)De[be].availableImages=re}ie()}else ie()}setModels(q,{scope:$,models:ie},fe){if(this.availableModels[q]||(this.availableModels[q]={}),this.availableModels[q][$]=ie,this.workerSources[q]&&this.workerSources[q][$]){for(let re in this.workerSources[q][$]){let ye=this.workerSources[q][$][re];for(let De in ye)ye[De].availableModels=ie}fe()}else fe()}setProjection(q,$){this.projections[q]=n.cj($)}setBrightness(q,$,ie){this.brightness=$,ie()}setWorldview(q,$,ie){this.worldview=$,ie()}setLayers(q,$,ie){this.getLayerIndex(q,$.scope).replace($.layers,$.options),ie()}updateLayers(q,$,ie){this.getLayerIndex(q,$.scope).update($.layers,$.removedIds,$.options),ie()}loadTile(q,$,ie){$.projection=this.projections[q]||this.defaultProjection,this.getWorkerSource(q,$.type,$.source,$.scope).loadTile($,ie)}decodeRasterArray(q,$,ie){this.getWorkerSource(q,$.type,$.source,$.scope).decodeRasterArray($,ie)}reloadTile(q,$,ie){$.projection=this.projections[q]||this.defaultProjection,this.getWorkerSource(q,$.type,$.source,$.scope).reloadTile($,ie)}abortTile(q,$,ie){this.getWorkerSource(q,$.type,$.source,$.scope).abortTile($,ie)}removeTile(q,$,ie){this.getWorkerSource(q,$.type,$.source,$.scope).removeTile($,ie)}removeSource(q,$,ie){if(!(this.workerSources[q]&&this.workerSources[q][$.scope]&&this.workerSources[q][$.scope][$.type]&&this.workerSources[q][$.scope][$.type][$.source]))return;let fe=this.workerSources[q][$.scope][$.type][$.source];delete this.workerSources[q][$.scope][$.type][$.source],fe.removeSource!==void 0?fe.removeSource($,ie):ie()}loadWorkerSource(q,$,ie){try{this.self.importScripts($.url),ie()}catch(fe){ie(fe.toString())}}syncRTLPluginState(q,$,ie){if(n.fw.isParsed())ie(null,!0);else if(n.fw.isParsing())this.rtlPluginParsingListeners.push(ie);else try{n.fw.setState($);let fe=n.fw.getPluginURL();!n.fw.isLoaded()||n.fw.isParsed()||n.fw.isParsing()||fe==null||(n.fw.setState({pluginStatus:n.fx.parsing,pluginURL:n.fw.getPluginURL()}),this.self.importScripts(fe),n.fw.isParsed()?ie(null,!0):this.rtlPluginParsingListeners.push(ie))}catch(fe){ie(fe.toString())}}setDracoUrl(q,$){this.dracoUrl=$}getAvailableImages(q,$){this.availableImages[q]||(this.availableImages[q]={});let ie=this.availableImages[q][$];return ie||(ie=[]),ie}getAvailableModels(q,$){this.availableModels[q]||(this.availableModels[q]={});let ie=this.availableModels[q][$];return ie||(ie={}),ie}getLayerIndex(q,$){this.layerIndexes[q]||(this.layerIndexes[q]={});let ie=this.layerIndexes[q][$];return ie||(ie=this.layerIndexes[q][$]=new J,ie.scope=$),ie}getWorkerSource(q,$,ie,fe){let re=this.workerSources;return re[q]||(re[q]={}),re[q][fe]||(re[q][fe]={}),re[q][fe][$]||(re[q][fe][$]={}),this.isSpriteLoaded[q]||(this.isSpriteLoaded[q]={}),re[q][fe][$][ie]||(re[q][fe][$][ie]=new this.workerSourceTypes[$]({send:(ye,De,be,Le,st,He)=>this.actor.send(ye,De,be,q,st,He),scheduler:this.actor.scheduler},this.getLayerIndex(q,fe),this.getAvailableImages(q,fe),this.getAvailableModels(q,fe),this.isSpriteLoaded[q][fe],void 0,this.brightness,this.worldview)),re[q][fe][$][ie]}rasterizeImagesWorker(q,$,ie){let fe=new Map;for(let[re,{image:ye,imageVariant:De}]of $.tasks.entries()){let be=this.imageRasterizer.rasterize(De,ye,$.scope,q);fe.set(re,be)}ie(void 0,fe)}removeRasterizedImages(q,$,ie){this.imageRasterizer.removeImagesFromCacheByIds($.imageIds,$.scope,q),ie()}enforceCacheSizeLimit(q,$){n.fy($)}getWorkerPerformanceMetrics(q,$,ie){ie(void 0,void 0)}}return n.fu(self)&&(self.worker=new Ai(self)),Ai}),T(["./shared"],function(n){var O="3.14.0";let V={create:"create",load:"load",fullLoad:"fullLoad"},H={mark(l){performance.mark(l)},measure(l,t,o){performance.measure(l,t,o)}};function J(l){let t=l.name.split("?")[0];return n.a(t)&&t.includes("mapbox-gl.js")?"javascript":n.a(t)&&t.includes("mapbox-gl.css")?"css":n.b(t)?"fontRange":n.c(t)?"sprite":n.i(t)?"style":n.d(t)?"tilejson":"other"}var ae,we={},Ae=function(){if(ae)return we;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var p,_,x=new Blob([""],{type:"text/javascript"}),b=URL.createObjectURL(x);try{_=new Worker(b),p=!0}catch{p=!1}return _&&_.terminate(),URL.revokeObjectURL(b),p}()?function(){var p=document.createElement("canvas");p.width=p.height=1;var _=p.getContext("2d");if(!_)return!1;var x=_.getImageData(0,0,1,1);return x&&x.width===p.width}()?(o[d=c&&c.failIfMajorPerformanceCaveat]===void 0&&(o[d]=function(p){var _,x=function(b){var M=document.createElement("canvas"),C=Object.create(l.webGLContextAttributes);return C.failIfMajorPerformanceCaveat=b,M.getContext("webgl2",C)}(p);if(!x)return!1;try{_=x.createShader(x.VERTEX_SHADER)}catch{return!1}return!(!_||x.isContextLost())&&(x.shaderSource(_,"void main() {}"),x.compileShader(_),x.getShaderParameter(_,x.COMPILE_STATUS)===!0)}(d)),o[d]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var d}ae=1,we.supported=l,we.notSupportedReason=t;var o={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},we}();function xe(l,t,o){let c=document.createElement(l);return t!=null&&(c.className=t),o&&o.appendChild(c),c}function Ge(l,t,o){let c=document.createElementNS("http://www.w3.org/2000/svg",l);for(let d of Object.keys(t))c.setAttributeNS(null,d,String(t[d]));return o&&o.appendChild(c),c}let Te=typeof document<"u"?document.documentElement&&document.documentElement.style:null,We=Te&&Te.userSelect!==void 0?"userSelect":"WebkitUserSelect",ft;function _t(){Te&&We&&(ft=Te[We],Te[We]="none")}function Pt(){Te&&We&&(Te[We]=ft)}function At(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",At,!0)}function wt(){window.addEventListener("click",At,!0),window.setTimeout(()=>{window.removeEventListener("click",At,!0)},0)}function Ct(l,t){let o=l.getBoundingClientRect();return mt(l,o,t)}function Ft(l,t){let o=l.getBoundingClientRect(),c=[];for(let d=0;d<t.length;d++)c.push(mt(l,o,t[d]));return c}function Wt(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&l.button===2&&l.ctrlKey?0:l.button}function mt(l,t,o){let c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new n.P((o.clientX-t.left)*c,(o.clientY-t.top)*c)}let er="01",Ni="NO_ACCESS_TOKEN";class yi{constructor(t,o,c){this._transformRequestFn=t,this._customAccessToken=o,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){let t=function(){let o="";for(let c=0;c<10;c++)o+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",er,o].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,o){return this._transformRequestFn&&this._transformRequestFn(t,o)||{url:t}}normalizeStyleURL(t,o){if(!n.j(t))return t;let c=vi(t);return c.params.push(`sdk=js-${O}`),c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||o)}normalizeGlyphsURL(t,o){if(!n.j(t))return t;let c=vi(t);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||o)}normalizeModelURL(t,o){if(!n.j(t))return t;let c=vi(t);return c.path=`/models/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||o)}normalizeSourceURL(t,o,c,d){if(!n.j(t))return t;let p=vi(t);return p.path=`/v4/${p.authority}.json`,p.params.push("secure"),c&&p.params.push(`language=${c}`),d&&p.params.push(`worldview=${d}`),this._makeAPIURL(p,this._customAccessToken||o)}normalizeIconsetURL(t,o){let c=vi(t);return n.j(t)?(c.path=`/styles/v1${c.path}/iconset.pbf`,this._makeAPIURL(c,this._customAccessToken||o)):mr(c)}normalizeSpriteURL(t,o,c,d){let p=vi(t);return n.j(t)?(p.path=`/styles/v1${p.path}/sprite${o}${c}`,this._makeAPIURL(p,this._customAccessToken||d)):(p.path+=`${o}${c}`,mr(p))}normalizeTileURL(t,o,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!n.j(t))return t;let d=vi(t);d.path=d.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${o||c&&d.authority!=="raster"&&c===512?"@2x":""}${n.l.supported?".webp":"$1"}`),d.authority==="raster"?d.path=`/${n.e.RASTER_URL_PREFIX}${d.path}`:d.authority==="rasterarrays"?d.path=`/${n.e.RASTERARRAYS_URL_PREFIX}${d.path}`:d.authority==="3dtiles"?d.path=`/${n.e.TILES3D_URL_PREFIX}${d.path}`:(d.path=d.path.replace(/^.+\/v4\//,"/"),d.path=`/${n.e.TILE_URL_VERSION}${d.path}`);let p=this._customAccessToken||function(_){for(let x of _){let b=x.match(/^access_token=(.*)$/);if(b)return b[1]}return null}(d.params)||n.e.ACCESS_TOKEN;return n.e.REQUIRE_ACCESS_TOKEN&&p&&this._skuToken&&d.params.push(`sku=${this._skuToken}`),this._makeAPIURL(d,p)}canonicalizeTileURL(t,o){let c=vi(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let d="mapbox://";c.path.match(/^\/raster\/v1\//)?d+=`raster/${c.path.replace(`/${n.e.RASTER_URL_PREFIX}/`,"")}`:c.path.match(/^\/rasterarrays\/v1\//)?d+=`rasterarrays/${c.path.replace(`/${n.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:d+=`tiles/${c.path.replace(`/${n.e.TILE_URL_VERSION}/`,"")}`;let p=c.params;return o&&(p=p.filter(_=>!_.match(/^access_token=/))),p.length&&(d+=`?${p.join("&")}`),d}canonicalizeTileset(t,o){let c=!!o&&n.j(o),d=[];for(let p of t.tiles||[])n.k(p)?d.push(this.canonicalizeTileURL(p,c)):d.push(p);return d}_makeAPIURL(t,o){let c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",d=vi(n.e.API_URL);if(t.protocol=d.protocol,t.authority=d.authority,t.protocol==="http"){let p=t.params.indexOf("secure");p>=0&&t.params.splice(p,1)}if(d.path!=="/"&&(t.path=`${d.path}${t.path}`),!n.e.REQUIRE_ACCESS_TOKEN)return mr(t);if(o=o||n.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!o)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if(o[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return t.params=t.params.filter(p=>p.indexOf("access_token")===-1),t.params.push(`access_token=${o||""}`),mr(t)}}let mi=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function vi(l){let t=l.match(mi);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function mr(l){let t=l.params.length?`?${l.params.join("&")}`:"";return`${l.protocol}://${l.authority}${l.path}${t}`}let Fr="mapbox.eventData";function Rr(l){if(!l)return null;let t=l.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(n.m(t[1]))}catch{return null}}class Hr{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){let o=Rr(n.e.ACCESS_TOKEN),c="";return c=o&&o.u?n.f(o.u):n.e.ACCESS_TOKEN||"",t?`${Fr}.${t}:${c}`:`${Fr}:${c}`}fetchEventData(){let t=n.s("localStorage"),o=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{let d=localStorage.getItem(o);d&&(this.eventData=JSON.parse(d));let p=localStorage.getItem(c);p&&(this.anonId=p)}catch{n.w("Unable to read from LocalStorage")}}saveEventData(){let t=n.s("localStorage"),o=this.getStorageKey(),c=this.getStorageKey("uuid"),d=this.anonId;if(t&&d)try{localStorage.setItem(c,d),Object.keys(this.eventData).length>=1&&localStorage.setItem(o,JSON.stringify(this.eventData))}catch{n.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,o,c,d){if(!n.e.EVENTS_URL)return;let p=vi(n.e.EVENTS_URL);p.params.push(`access_token=${d||n.e.ACCESS_TOKEN||""}`);let _={event:this.type,created:new Date(t).toISOString()},x=o?n.h(_,o):_,b={url:mr(p),headers:{"Content-Type":"text/plain"},body:JSON.stringify([x])};this.pendingRequest=n.p(b,M=>{this.pendingRequest=null,c(M),this.saveEventData(),this.processRequests(d)})}queueRequest(t,o){this.queue.push(t),this.processRequests(o)}}let Xi=new class extends Hr{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){n.e.EVENTS_URL&&n.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some(o=>n.j(o)||n.k(o))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let t=Rr(n.e.ACCESS_TOKEN),o=t?t.u:n.e.ACCESS_TOKEN,c=o!==this.eventData.tokenU;n.v(this.anonId)||(this.anonId=n.u(),c=!0);let d=this.queue.shift();if(this.eventData.lastSuccess){let p=new Date(this.eventData.lastSuccess),_=new Date(d),x=(d-this.eventData.lastSuccess)/864e5;c=c||x>=1||x<-1||p.getDate()!==_.getDate()}else c=!0;c?this.postEvent(d,{sdkIdentifier:"mapbox-gl-js",sdkVersion:O,skuId:er,"enabled.telemetry":!1,userId:this.anonId},p=>{p||(this.eventData.lastSuccess=d,this.eventData.tokenU=o)},l):this.processRequests()}},tn=Xi.postTurnstileEvent.bind(Xi),Po=new class extends Hr{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,o,c){this.skuToken=t,this.errorCb=c,n.e.EVENTS_URL&&(o||n.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},o):this.errorCb(new Error(Ni)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),n.v(this.anonId)||(this.anonId=n.u()),this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:O,skuId:er,skuToken:this.skuToken,userId:this.anonId},c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l))}remove(){this.errorCb=null}},Ro=Po.postMapLoadEvent.bind(Po),Zo=new class extends Hr{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=n.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){let t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){let{map:o,style:c,importedStyles:d}=t;if(!n.e.EVENTS_URL||!l&&!n.e.ACCESS_TOKEN)return;let p=this.getMapInstanceId(o),_={mapInstanceId:p,eventId:this.getEventId(p),style:c};d.length&&(_.importedStyles=d),this.queueRequest({timestamp:Date.now(),payload:_},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,payload:o}=this.queue.shift();this.postEvent(t,o,()=>{},l)}},Oi=Zo.postStyleLoadEvent.bind(Zo),or=new class extends Hr{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){n.e.EVENTS_URL&&(l||n.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,performanceData:o}=this.queue.shift(),c=function(d){let p=performance.getEntriesByType("resource"),_=performance.getEntriesByType("mark"),x=function(D){let N={};if(D){for(let F in D)if(F!=="other")for(let j of D[F]){let U=`${F}ResolveRangeMin`,Z=`${F}ResolveRangeMax`,Y=`${F}RequestCount`,Q=`${F}RequestCachedCount`;N[U]=Math.min(N[U]||1/0,j.startTime),N[Z]=Math.max(N[Z]||-1/0,j.responseEnd);let ne=he=>{N[he]===void 0&&(N[he]=0),++N[he]};j.transferSize!==void 0&&j.transferSize===0&&ne(Q),ne(Y)}}return N}(function(D,N){let F={};if(D)for(let j of D){let U=N(j);F[U]===void 0&&(F[U]=[]),F[U].push(j)}return F}(p,J)),b=window.devicePixelRatio,M=navigator.connection||navigator.mozConnection||navigator.webkitConnection,C=M?M.effectiveType:void 0,z={counters:[],metadata:[],attributes:[]},P=(D,N,F)=>{F!=null&&D.push({name:N,value:F.toString()})};for(let D in x)P(z.counters,D,x[D]);if(d.interactionRange[0]!==1/0&&d.interactionRange[1]!==-1/0&&(P(z.counters,"interactionRangeMin",d.interactionRange[0]),P(z.counters,"interactionRangeMax",d.interactionRange[1])),_)for(let D of Object.keys(V)){let N=V[D],F=_.find(j=>j.name===N);F&&P(z.counters,N,F.startTime)}return P(z.counters,"visibilityHidden",d.visibilityHidden),P(z.attributes,"style",function(D){if(D)for(let N of D){let F=N.name.split("?")[0];if(n.i(F)){let j=F.split("/").slice(-2);if(j.length===2)return`mapbox://styles/${j[0]}/${j[1]}`}}}(p)),P(z.attributes,"terrainEnabled",d.terrainEnabled?"true":"false"),P(z.attributes,"fogEnabled",d.fogEnabled?"true":"false"),P(z.attributes,"projection",d.projection),P(z.attributes,"zoom",d.zoom),P(z.metadata,"devicePixelRatio",b),P(z.metadata,"connectionEffectiveType",C),P(z.metadata,"navigatorUserAgent",navigator.userAgent),P(z.metadata,"screenWidth",window.screen.width),P(z.metadata,"screenHeight",window.screen.height),P(z.metadata,"windowWidth",window.innerWidth),P(z.metadata,"windowHeight",window.innerHeight),P(z.metadata,"mapWidth",d.width/b),P(z.metadata,"mapHeight",d.height/b),P(z.metadata,"webglRenderer",d.renderer),P(z.metadata,"webglVendor",d.vendor),P(z.metadata,"sdkVersion",O),P(z.metadata,"sdkIdentifier","mapbox-gl-js"),z}(o);for(let d of c.metadata);for(let d of c.counters);for(let d of c.attributes);this.postEvent(t,c,()=>{},l)}},Vr=or.postPerformanceEvent.bind(or),Bn=new class extends Hr{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,o,c){if(!n.e.API_URL||!n.e.SESSION_PATH)return;let d=vi(n.e.API_URL+n.e.SESSION_PATH);d.params.push(`sku=${t||""}`),d.params.push(`access_token=${c||n.e.ACCESS_TOKEN||""}`);let p={url:mr(d),headers:{"Content-Type":"text/plain"}};this.pendingRequest=n.g(p,_=>{this.pendingRequest=null,o(_),this.saveEventData(),this.processRequests(c)})}getSessionAPI(l,t,o,c){this.skuToken=t,this.errorCb=c,n.e.SESSION_PATH&&n.e.API_URL&&(o||n.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},o):this.errorCb(new Error(Ni)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||this.getSession(o,this.skuToken,c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l)}remove(){this.errorCb=null}},Lr=Bn.getSessionAPI.bind(Bn),ks=new Set;function Fs(l,t){t?ks.add(l):ks.delete(l)}class nc{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,o){this._updatedSourceCaches[t]=o,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){let o=t.scope;this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._updatedLayers[o].add(t.id),this.setDirty()}removeLayer(t){let o=t.scope;this._removedLayers[o]=this._removedLayers[o]||{},this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._removedLayers[o][t.id]=t,this._updatedLayers[o].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){let t={};for(let o in this._updatedLayers)t[o]=t[o]||{},t[o].updatedIds=Array.from(this._updatedLayers[o].values());for(let o in this._removedLayers)t[o]=t[o]||{},t[o].removedIds=Object.keys(this._removedLayers[o]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,o){this._updatedImages[o]=this._updatedImages[o]||new Set,this._updatedImages[o].add(n.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Lo(l){let{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class zr extends n.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&n.t()&&(this.imageRasterizerDispatcher=new n.D(n.x(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new n.r({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);let o=this.atlasTexture.get(t);o&&(o.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,o){this.imageProviders.has(o)||this.imageProviders.set(o,new Map),this.imageProviders.get(o).set(t.id,t)}removeImageProvider(t,o){this.imageProviders.has(o)&&this.imageProviders.get(o).delete(t)}getPendingImageProviders(){let t=[];for(let o of this.imageProviders.values())for(let c of o.values())c.hasPendingRequests()&&t.push(c);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new n.y),this._imageRasterizer}isLoaded(){for(let t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,o){if(this.loaded.get(o)!==t&&(this.loaded.set(o,t),t)){for(let{ids:c,callback:d}of this.requestors)this._notify(c,o,d);this.requestors=[]}}hasImage(t,o){return!!this.getImage(t,o)}getImage(t,o){return this.images.get(o).get(t.toString())}addImage(t,o,c){this._validate(t,c)&&this.images.get(o).set(t.toString(),c)}_validate(t,o){let c=!0;return this._validateStretch(o.stretchX,o.data&&o.data.width)||(this.fire(new n.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),c=!1),this._validateStretch(o.stretchY,o.data&&o.data.height)||(this.fire(new n.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),c=!1),this._validateContent(o.content,o)||(this.fire(new n.z(new Error(`Image "${t.name}" has invalid "content" value`))),c=!1),c}_validateStretch(t,o){if(!t)return!0;let c=0;for(let d of t){if(d[0]<c||d[1]<d[0]||o<d[1])return!1;c=d[1]}return!0}_validateContent(t,o){return t?t.length!==4||!o.usvg&&(t[0]<0||o.data.width<t[0]||t[1]<0||o.data.height<t[1]||t[2]<0||o.data.width<t[2]||t[3]<0||o.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,o,c){let d=this.images.get(o).get(t.toString());c.version=d.version+1,this.images.get(o).set(t.toString(),c),this.updatedImages.get(o).add(t),this.removeFromImageRasterizerCache(t,o)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,o){this.spriteFormat!=="raster"&&(n.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:o}):this.imageRasterizer.removeImagesFromCacheByIds([t],o))}removeImage(t,o){let c=this.images.get(o),d=c.get(t.toString());c.delete(t.toString()),this.patterns.get(o).delete(t.toString()),this.removeFromImageRasterizerCache(t,o),d.userImage&&d.userImage.onRemove&&d.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(o=>n.I.from(o))}getImages(t,o,c){let d=[],p=[],_=this.imageProviders.get(o);for(let C of t){if(!C.iconsetId){d.push(C);continue}let z=_.get(C.iconsetId);z&&(this.getImage(C,o)?p.push(C):z.addPendingRequest(C))}if(d.length===0)return void this._notify(p,o,c);let x=!0,b=!!this.loaded.get(o),M=this.images.get(o);if(!b)for(let C of d)M.has(C.toString())||(x=!1);b||x?this._notify(d,o,c):this.requestors.push({ids:d,scope:o,callback:c})}rasterizeImages(t,o){let c=new Map,{tasks:d,scope:p}=t;for(let[_,x]of d.entries()){let b=this.getImage(x.id,p);b&&c.set(_,{image:b,imageVariant:x})}this._rasterizeImages(p,c,o)}_rasterizeImages(t,o,c){if(n.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:o,scope:t},c);else{let d=new Map;for(let[p,{image:_,imageVariant:x}]of o.entries())d.set(p,this.imageRasterizer.rasterize(x,_,t,0));c(void 0,d)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,o,c){let d=this.images.get(o),p=new Map;for(let _ of t){if(!d.get(_.toString())){if(_.iconsetId)continue;this.fire(new n.A("styleimagemissing",{id:_.name}))}let x=d.get(_.toString());if(!x){n.w(`Image "${_.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}let b={data:x.usvg?null:x.data.clone(),pixelRatio:x.pixelRatio,sdf:x.sdf,usvg:x.usvg,version:x.version,stretchX:x.stretchX,stretchY:x.stretchY,content:x.content,hasRenderCallback:!!(x.userImage&&x.userImage.render)};x.usvg&&Object.assign(b,{width:x.icon.usvg_tree.width,height:x.icon.usvg_tree.height}),p.set(n.I.toString(_),b)}c(null,p)}getPixelSize(t){let{width:o,height:c}=this.atlasImage.get(t);return{width:o,height:c}}getPattern(t,o,c){let d=t.toString(),p=this.patterns.get(o),_=p.get(d),x=this.getImage(t,o);if(!x)return null;if(_){if(_.position.version===x.version)return _.position;_.position.version=x.version}else{if(x.usvg&&!x.data){let b=this.getPatternInFlightId(d,o);if(this.patternsInFlight.has(b))return null;this.patternsInFlight.add(b);let M=new n.B(t).scaleSelf(n.q.devicePixelRatio),C=new Map([[M.toString(),{image:x,imageVariant:M}]]);return this._rasterizeImages(o,C,(z,P)=>this.storePatternImage(M,o,x,c,P)),null}this.storePattern(t,o,x)}return this._updatePatternAtlas(o,c),p.get(d).position}getPatternInFlightId(t,o){return n.C(t,o)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,o,c,d,p){let _=t.toString(),x=p?p.get(_):void 0;x&&(c.data=x,this.storePattern(t.id,o,c),this._updatePatternAtlas(o,d),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),o)))}storePattern(t,o,c){let d={w:c.data.width+2*n.F,h:c.data.height+2*n.F,x:0,y:0},p=new n.G(d,c,n.F);this.patterns.get(o).set(t.toString(),{bin:d,position:p})}destroyAtlasTextures(){for(let t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,o){let c=t.gl,d=this.atlasTexture.get(o);d?this.dirty&&(d.update(this.atlasImage.get(o)),this.dirty=!1):(d=new n.T(t,this.atlasImage.get(o),c.RGBA8),this.atlasTexture.set(o,d)),d.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,o){let c=this.patterns.get(t),d=Array.from(c.values()).map(({bin:M})=>M),{w:p,h:_}=n.H(d),x=this.atlasImage.get(t);x.resize({width:p||1,height:_||1});let b=this.images.get(t);for(let[M,{bin:C,position:z}]of c.entries()){let P=z.padding,D=C.x+P,N=C.y+P,F=b.get(M).data,j=F.width,U=F.height;P=P>1?P-1:P,n.r.copy(F,x,{x:0,y:0},{x:D,y:N},{width:j,height:U},o),n.r.copy(F,x,{x:0,y:U-P},{x:D,y:N-P},{width:j,height:P},o),n.r.copy(F,x,{x:0,y:0},{x:D,y:N+U},{width:j,height:P},o),n.r.copy(F,x,{x:j-P,y:0},{x:D-P,y:N},{width:P,height:U},o),n.r.copy(F,x,{x:0,y:0},{x:D+j,y:N},{width:P,height:U},o),n.r.copy(F,x,{x:j-P,y:U-P},{x:D-P,y:N-P},{width:P,height:P},o),n.r.copy(F,x,{x:0,y:U-P},{x:D+j,y:N-P},{width:P,height:P},o),n.r.copy(F,x,{x:0,y:0},{x:D+j,y:N+U},{width:P,height:P},o),n.r.copy(F,x,{x:j-P,y:0},{x:D-P,y:N+U},{width:P,height:P},o)}this.dirty=!0}beginFrame(){for(let t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,o){let c=this.images.get(o);for(let d of t){if(this.callbackDispatchedThisFrame.get(o).has(d.toString()))continue;this.callbackDispatchedThisFrame.get(o).add(d.toString());let p=c.get(d.toString());Lo(p)&&this.updateImage(d,o,p)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Nn(l){let t=l.key,o=l.value,c=l.valueSpec||{},d=l.objectElementValidators||{},p=l.style,_=l.styleSpec,x=[],b=n.J(o);if(b!=="object")return[new n.V(t,o,`object expected, ${b} found`)];for(let M in o){let C=M.split(".")[0],z;d[C]?z=d[C]:c[C]?z=hr:d["*"]?z=d["*"]:c["*"]&&(z=hr),z?x=x.concat(z({key:(t&&`${t}.`)+M,value:o[M],valueSpec:c[C]||c["*"],style:p,styleSpec:_,object:o,objectKey:M},o)):x.push(new n.K(t,o[M],`unknown property "${M}"`))}for(let M in c)d[M]||c[M].required&&c[M].default===void 0&&o[M]===void 0&&x.push(new n.V(t,o,`missing required property "${M}"`));return x}function Bs(l){let t=l.value,o=l.valueSpec,c=l.style,d=l.styleSpec,p=l.key,_=l.arrayElementValidator||hr;if(n.J(t)!=="array")return[new n.V(p,t,`array expected, ${n.J(t)} found`)];if(o.length&&t.length!==o.length)return[new n.V(p,t,`array length ${o.length} expected, length ${t.length} found`)];if(o["min-length"]&&t.length<o["min-length"])return[new n.V(p,t,`array length at least ${o["min-length"]} expected, length ${t.length} found`)];let x={type:o.value,values:o.values,minimum:o.minimum,maximum:o.maximum,function:void 0};d.$version<7&&(x.function=o.function),n.J(o.value)==="object"&&(x=o.value);let b=[];for(let M=0;M<t.length;M++)b=b.concat(_({array:t,arrayIndex:M,value:t[M],valueSpec:x,style:c,styleSpec:d,key:`${p}[${M}]`},!0));return b}function oc(l){let t=l.key,o=l.value,c=l.valueSpec,d=n.J(o);if(d==="number"&&o!=o&&(d="NaN"),d!=="number")return[new n.V(t,o,`number expected, ${d} found`)];if("minimum"in c){let p=c.minimum;if(n.J(c.minimum)==="array"&&(p=c.minimum[l.arrayIndex]),o<p)return[new n.V(t,o,`${o} is less than the minimum value ${p}`)]}if("maximum"in c){let p=c.maximum;if(n.J(c.maximum)==="array"&&(p=c.maximum[l.arrayIndex]),o>p)return[new n.V(t,o,`${o} is greater than the maximum value ${p}`)]}return[]}function xs(l){let t=l.valueSpec,o=n.M(l.value.type),c,d,p,_={},x=o!=="categorical"&&l.value.property===void 0,b=!x,M=n.J(l.value.stops)==="array"&&n.J(l.value.stops[0])==="array"&&n.J(l.value.stops[0][0])==="object",C=Nn({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(D){if(o==="identity")return[new n.V(D.key,D.value,'identity function may not have a "stops" property')];let N=[],F=D.value;return N=N.concat(Bs({key:D.key,value:F,valueSpec:D.valueSpec,style:D.style,styleSpec:D.styleSpec,arrayElementValidator:z})),n.J(F)==="array"&&F.length===0&&N.push(new n.V(D.key,F,"array must have at least one stop")),N},default:function(D){return hr({key:D.key,value:D.value,valueSpec:t,style:D.style,styleSpec:D.styleSpec})}}});return o==="identity"&&x&&C.push(new n.V(l.key,l.value,'missing required property "property"')),o==="identity"||l.value.stops||C.push(new n.V(l.key,l.value,'missing required property "stops"')),o==="exponential"&&l.valueSpec.expression&&!n.N(l.valueSpec)&&C.push(new n.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(b&&!n.O(l.valueSpec)?C.push(new n.V(l.key,l.value,"property functions not supported")):x&&!n.Q(l.valueSpec)&&C.push(new n.V(l.key,l.value,"zoom functions not supported"))),o!=="categorical"&&!M||l.value.property!==void 0||C.push(new n.V(l.key,l.value,'"property" property is required')),C;function z(D){let N=[],F=D.value,j=D.key;if(n.J(F)!=="array")return[new n.V(j,F,`array expected, ${n.J(F)} found`)];if(F.length!==2)return[new n.V(j,F,`array length 2 expected, length ${F.length} found`)];if(M){if(n.J(F[0])!=="object")return[new n.V(j,F,`object expected, ${n.J(F[0])} found`)];if(F[0].zoom===void 0)return[new n.V(j,F,"object stop key must have zoom")];if(F[0].value===void 0)return[new n.V(j,F,"object stop key must have value")];let U=n.M(F[0].zoom);if(typeof U!="number")return[new n.V(j,F[0].zoom,"stop zoom values must be numbers")];if(p&&p>U)return[new n.V(j,F[0].zoom,"stop zoom values must appear in ascending order")];U!==p&&(p=U,d=void 0,_={}),N=N.concat(Nn({key:`${j}[0]`,value:F[0],valueSpec:{zoom:{}},style:D.style,styleSpec:D.styleSpec,objectElementValidators:{zoom:oc,value:P}}))}else N=N.concat(P({key:`${j}[0]`,value:F[0],style:D.style,styleSpec:D.styleSpec},F));return n.S(n.U(F[1]))?N.concat([new n.V(`${j}[1]`,F[1],"expressions are not allowed in function stops.")]):N.concat(hr({key:`${j}[1]`,value:F[1],valueSpec:t,style:D.style,styleSpec:D.styleSpec}))}function P(D,N){let F=n.J(D.value),j=n.M(D.value),U=D.value!==null?D.value:N;if(c){if(F!==c)return[new n.V(D.key,U,`${F} stop domain type must match previous stop domain type ${c}`)]}else c=F;if(F!=="number"&&F!=="string"&&F!=="boolean"&&typeof j!="number"&&typeof j!="string"&&typeof j!="boolean")return[new n.V(D.key,U,"stop domain value must be a number, string, or boolean")];if(F!=="number"&&o!=="categorical"){let Z=`number expected, ${F} found`;return n.O(t)&&o===void 0&&(Z+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new n.V(D.key,U,Z)]}return o!=="categorical"||F!=="number"||typeof j=="number"&&isFinite(j)&&Math.floor(j)===j?o!=="categorical"&&F==="number"&&typeof j=="number"&&typeof d=="number"&&d!==void 0&&j<d?[new n.V(D.key,U,"stop domain values must appear in ascending order")]:(d=j,o==="categorical"&&j in _?[new n.V(D.key,U,"stop domain values must be unique")]:(_[j]=!0,[])):[new n.V(D.key,U,`integer expected, found ${String(j)}`)]}}function co(l){let t=(l.expressionContext==="property"?n.W:n.X)(n.U(l.value),l.valueSpec);if(t.result==="error")return t.value.map(c=>new n.V(`${l.key}${c.key}`,l.value,c.message));let o=t.value.expression||t.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!o.outputDefined())return[new n.V(l.key,l.value,`Invalid data expression for "${l.propertyKey}". Output values must be contained as literals within the expression.`)];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!n.Y(o))return[new n.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return Yn(o,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!n.Z(o,["zoom","feature-state"]))return[new n.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!n._(o))return[new n.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Yn(l,t){let o=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(let d of t.valueSpec.expression.parameters)o.delete(d);if(o.size===0)return[];let c=[];return l instanceof n.$&&o.has(l.name)?[new n.V(t.key,t.value,`["${l.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(l.eachChild(d=>{c.push(...Yn(d,t))}),c)}function vs(l){let t=l.key,o=l.value,c=l.valueSpec,d=[];return Array.isArray(c.values)?c.values.indexOf(n.M(o))===-1&&d.push(new n.V(t,o,`expected one of [${c.values.join(", ")}], ${JSON.stringify(o)} found`)):Object.keys(c.values).indexOf(n.M(o))===-1&&d.push(new n.V(t,o,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(o)} found`)),d}function bs(l){return n.a1(n.U(l.value))?co(n.L({},l,{expressionContext:"filter",valueSpec:l.styleSpec[`filter_${l.layerType||"fill"}`]})):xa(l)}function xa(l){let t=l.value,o=l.key;if(n.J(t)!=="array")return[new n.V(o,t,`array expected, ${n.J(t)} found`)];let c=l.styleSpec,d,p=[];if(t.length<1)return[new n.V(o,t,"filter array must have at least 1 element")];switch(p=p.concat(vs({key:`${o}[0]`,value:t[0],valueSpec:c.filter_operator,style:l.style,styleSpec:l.styleSpec})),n.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&n.M(t[1])==="$type"&&p.push(new n.V(o,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&p.push(new n.V(o,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(d=n.J(t[1]),d!=="string"&&p.push(new n.V(`${o}[1]`,t[1],`string expected, ${d} found`)));for(let _=2;_<t.length;_++)d=n.J(t[_]),n.M(t[1])==="$type"?p=p.concat(vs({key:`${o}[${_}]`,value:t[_],valueSpec:c.geometry_type,style:l.style,styleSpec:l.styleSpec})):d!=="string"&&d!=="number"&&d!=="boolean"&&p.push(new n.V(`${o}[${_}]`,t[_],`string, number, or boolean expected, ${d} found`));break;case"any":case"all":case"none":for(let _=1;_<t.length;_++)p=p.concat(xa({key:`${o}[${_}]`,value:t[_],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":d=n.J(t[1]),t.length!==2?p.push(new n.V(o,t,`filter array for "${t[0]}" operator must have 2 elements`)):d!=="string"&&p.push(new n.V(`${o}[1]`,t[1],`string expected, ${d} found`))}return p}function Ya(l,t){let o=l.key,c=l.style,d=l.layer,p=l.styleSpec,_=l.value,x=l.objectKey,b=p[`${t}_${l.layerType}`];if(!b)return[];let M=x.match(/^(.*)-use-theme$/);if(t==="paint"&&M&&b[M[1]])return n.S(_)?[].concat(hr({key:l.key,value:_,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:x})):hr({key:o,value:_,valueSpec:{type:"string"},style:c,styleSpec:p});let C=x.match(/^(.*)-transition$/);if(t==="paint"&&C&&b[C[1]]&&b[C[1]].transition)return hr({key:o,value:_,valueSpec:p.transition,style:c,styleSpec:p});let z=l.valueSpec||b[x];if(!z)return[new n.K(o,_,`unknown property "${x}"`)];let P;if(n.J(_)==="string"&&n.O(z)&&!z.tokens&&(P=/^{([^}]+)}$/.exec(_))){let N=`\`{ "type": "identity", "property": ${P?JSON.stringify(P[1]):'"_"'} }\``;return[new n.V(o,_,`"${x}" does not support interpolation syntax
Use an identity property function instead: ${N}.`)]}let D=[];if(l.layerType==="symbol")x!=="text-field"||!c||c.glyphs||c.imports||D.push(new n.V(o,_,'use of "text-field" requires a style "glyphs" property')),x==="text-font"&&n.a2(n.U(_))&&n.M(_.type)==="identity"&&D.push(new n.V(o,_,'"text-font" does not support identity functions'));else if(l.layerType==="model"&&t==="paint"&&d&&d.layout&&d.layout.hasOwnProperty("model-id")&&n.O(z)&&(n.a3(z)||n.Q(z))){let N=n.W(n.U(_),z),F=N.value.expression||N.value._styleExpression.expression;F&&!n.Z(F,["measure-light"])&&(x==="model-emissive-strength"&&n._(F)&&n.Y(F)||D.push(new n.V(o,_,`${x} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return D.concat(hr({key:l.key,value:_,valueSpec:z,style:c,styleSpec:p,expressionContext:"property",propertyType:t,propertyKey:x}))}function Vn(l){return Ya(l,"paint")}function ho(l){return Ya(l,"layout")}function sc(l){let t=[],o=l.value,c=l.key,d=l.style,p=l.styleSpec;o.type||o.ref||t.push(new n.V(c,o,'either "type" or "ref" is required'));let _=n.M(o.type),x=n.M(o.ref);if(o.id){let b=n.M(o.id);for(let M=0;M<l.arrayIndex;M++){let C=d.layers[M];n.M(C.id)===b&&t.push(new n.V(c,o.id,`duplicate layer id "${o.id}", previously used at line ${C.id.__line__}`))}}if("ref"in o){let b;["type","source","source-layer","filter","layout"].forEach(M=>{M in o&&t.push(new n.V(c,o[M],`"${M}" is prohibited for ref layers`))}),d.layers.forEach(M=>{n.M(M.id)===x&&(b=M)}),b?b.ref?t.push(new n.V(c,o.ref,"ref cannot reference another ref layer")):_=n.M(b.type):typeof x=="string"&&t.push(new n.V(c,o.ref,`ref layer "${x}" not found`))}else if(_!=="background"&&_!=="sky"&&_!=="slot")if(o.source){let b=d.sources&&d.sources[o.source],M=b&&n.M(b.type);b?M==="vector"&&_==="raster"?t.push(new n.V(c,o.source,`layer "${o.id}" requires a raster source`)):M==="raster"&&_!=="raster"?t.push(new n.V(c,o.source,`layer "${o.id}" requires a vector source`)):M!=="vector"||o["source-layer"]?M==="raster-dem"&&_!=="hillshade"?t.push(new n.V(c,o.source,"raster-dem source can only be used with layer type 'hillshade'.")):M!=="raster-array"||["raster","raster-particle"].includes(_)?_==="line"&&o.paint&&(o.paint["line-gradient"]||o.paint["line-trim-offset"])&&M==="geojson"&&!b.lineMetrics?t.push(new n.V(c,o,`layer "${o.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):_==="raster-particle"&&M!=="raster-array"&&t.push(new n.V(c,o.source,`layer "${o.id}" requires a 'raster-array' source.`)):t.push(new n.V(c,o.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new n.V(c,o,`layer "${o.id}" must specify a "source-layer"`)):t.push(new n.V(c,o.source,`source "${o.source}" not found`))}else t.push(new n.V(c,o,'missing required property "source"'));return t=t.concat(Nn({key:c,value:o,valueSpec:p.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>hr({key:`${c}.type`,value:o.type,valueSpec:p.layer.type,style:l.style,styleSpec:l.styleSpec,object:o,objectKey:"type"}),filter:b=>bs(n.L({layerType:_},b)),layout:b=>Nn({layer:o,key:b.key,value:b.value,valueSpec:{},style:b.style,styleSpec:b.styleSpec,objectElementValidators:{"*":M=>ho(n.L({layerType:_},M))}}),paint:b=>Nn({layer:o,key:b.key,value:b.value,valueSpec:{},style:b.style,styleSpec:b.styleSpec,objectElementValidators:{"*":M=>Vn(n.L({layerType:_,layer:o},M))}})}})),t}function ws(l){let t=l.value,o=l.key,c=n.J(t);return c!=="string"?[new n.V(o,t,`string expected, ${c} found`)]:[]}let Ka={promoteId:function l({key:t,value:o}){if(n.J(o)==="string")return ws({key:t,value:o});if(Array.isArray(o)){let c=[],d=n.U(o),p=n.X(d);return p.result==="error"&&p.value.forEach(_=>{c.push(new n.V(`${t}${_.key}`,null,`${_.message}`))}),n.Z(p.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||c.push(new n.V(`${t}`,null,"promoteId expression should be only feature dependent")),c}{let c=[];for(let d in o)c.push(...l({key:`${t}.${d}`,value:o[d]}));return c}}};function Sn(l){let t=l.value,o=l.key,c=l.styleSpec,d=l.style;if(!t.type)return[new n.V(o,t,'"type" is required')];let p=n.M(t.type),_=[];switch(["vector","raster","raster-dem","raster-array"].includes(p)&&(t.url||t.tiles||_.push(new n.K(o,t,'Either "url" or "tiles" is required.'))),p){case"vector":case"raster":case"raster-dem":case"raster-array":return _=_.concat(Nn({key:o,value:t,valueSpec:c[`source_${p.replace("-","_")}`],style:l.style,styleSpec:c,objectElementValidators:Ka})),_;case"geojson":if(_=Nn({key:o,value:t,valueSpec:c.source_geojson,style:d,styleSpec:c,objectElementValidators:Ka}),t.cluster)for(let x in t.clusterProperties){let[b,M]=t.clusterProperties[x],C=typeof b=="string"?[b,["accumulated"],["get",x]]:b;_.push(...co({key:`${o}.${x}.map`,value:M,expressionContext:"cluster-map"})),_.push(...co({key:`${o}.${x}.reduce`,value:C,expressionContext:"cluster-reduce"}))}return _;case"video":return Nn({key:o,value:t,valueSpec:c.source_video,style:d,styleSpec:c});case"image":return Nn({key:o,value:t,valueSpec:c.source_image,style:d,styleSpec:c});case"canvas":return[new n.V(o,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return vs({key:`${o}.type`,value:t.type,valueSpec:{values:uo(c)}})}}function uo(l){return l.source.reduce((t,o)=>{let c=l[o];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values))),t},[])}function Ns(l){let t=l.value,o=l.styleSpec,c=o.light,d=l.style,p=[],_=n.J(t);if(t===void 0)return p;if(_!=="object")return p=p.concat([new n.V("light",t,`object expected, ${_} found`)]),p;for(let x in t){let b=x.match(/^(.*)-transition$/),M=x.match(/^(.*)-use-theme$/);p=p.concat(M&&c[M[1]]?hr({key:x,value:t[x],valueSpec:{type:"string"},style:d,styleSpec:o}):b&&c[b[1]]&&c[b[1]].transition?hr({key:x,value:t[x],valueSpec:o.transition,style:d,styleSpec:o}):c[x]?hr({key:x,value:t[x],valueSpec:c[x],style:d,styleSpec:o}):[new n.V(x,t[x],`unknown property "${x}"`)])}return p}function Ts(l){let t=l.value,o=[];if(!t)return o;let c=n.J(t);if(c!=="object")return o=o.concat([new n.V("light-3d",t,`object expected, ${c} found`)]),o;let d=l.styleSpec,p=d["light-3d"],_=l.key,x=l.style,b=l.style.lights;for(let z of["type","id"])if(!(z in t))return o=o.concat([new n.V("light-3d",t,`missing property ${z} on light`)]),o;if(t.type&&b)for(let z=0;z<l.arrayIndex;z++){let P=n.M(t.type),D=b[z];n.M(D.type)===P&&o.push(new n.V(_,t.id,`duplicate light type "${t.type}", previously defined at line ${D.id.__line__}`))}let M=`properties_light_${t.type}`;if(!(M in d))return o=o.concat([new n.V("light-3d",t,`Invalid light type ${t.type}`)]),o;let C=d[M];for(let z in t)if(z==="properties"){let P=t[z],D=n.J(P);if(D!=="object")return o=o.concat([new n.V("properties",P,`object expected, ${D} found`)]),o;for(let N in P){let F=N.match(/^(.*)-transition$/),j=N.match(/^(.*)-use-theme$/);o=o.concat(j&&C[j[1]]?hr({key:z,value:P[N],valueSpec:{type:"string"},style:x,styleSpec:d}):F&&C[F[1]]&&C[F[1]].transition?hr({key:z,value:t[z],valueSpec:d.transition,style:x,styleSpec:d}):C[N]?hr({key:N,value:P[N],valueSpec:C[N],style:x,styleSpec:d}):[new n.K(l.key,P[N],`unknown property "${N}"`)])}}else o=o.concat(p[z]?hr({key:z,value:t[z],valueSpec:p[z],style:x,styleSpec:d}):[new n.K(z,t[z],`unknown property "${z}"`)]);return o}function Vs(l){let t=l.value,o=l.key,c=l.style,d=l.styleSpec,p=d.terrain,_=[],x=n.J(t);if(t===void 0||x==="null")return _;if(x!=="object")return _=_.concat([new n.V("terrain",t,`object expected, ${x} found`)]),_;for(let b in t){let M=b.match(/^(.*)-transition$/),C=b.match(/^(.*)-use-theme$/);_=_.concat(C&&p[C[1]]?hr({key:b,value:t[b],valueSpec:{type:"string"},style:c,styleSpec:d}):M&&p[M[1]]&&p[M[1]].transition?hr({key:b,value:t[b],valueSpec:d.transition,style:c,styleSpec:d}):p[b]?hr({key:b,value:t[b],valueSpec:p[b],style:c,styleSpec:d}):[new n.K(b,t[b],`unknown property "${b}"`)])}if(t.source){let b=c.sources&&c.sources[t.source],M=b&&n.M(b.type);b?M!=="raster-dem"&&_.push(new n.V(o,t.source,`terrain cannot be used with a source of type ${String(M)}, it only be used with a "raster-dem" source type`)):_.push(new n.V(o,t.source,`source "${t.source}" not found`))}else _.push(new n.V(o,t,'terrain is missing required property "source"'));return _}function Us(l){let t=l.value,o=l.style,c=l.styleSpec,d=c.fog,p=[],_=n.J(t);if(t===void 0)return p;if(_!=="object")return p=p.concat([new n.V("fog",t,`object expected, ${_} found`)]),p;for(let x in t){let b=x.match(/^(.*)-transition$/),M=x.match(/^(.*)-use-theme$/);p=p.concat(M&&d[M[1]]?hr({key:x,value:t[x],valueSpec:{type:"string"},style:o,styleSpec:c}):b&&d[b[1]]&&d[b[1]].transition?hr({key:x,value:t[x],valueSpec:c.transition,style:o,styleSpec:c}):d[x]?hr({key:x,value:t[x],valueSpec:d[x],style:o,styleSpec:c}):[new n.K(x,t[x],`unknown property "${x}"`)])}return p}let Ja={"*":()=>[],array:Bs,boolean:function(l){let t=l.value,o=l.key,c=n.J(t);return c!=="boolean"?[new n.V(o,t,`boolean expected, ${c} found`)]:[]},number:oc,color:function(l){let t=l.key,o=l.value,c=n.J(o);return c!=="string"?[new n.V(t,o,`color expected, ${c} found`)]:n.a0.parseCSSColor(o)===null?[new n.V(t,o,`color expected, "${o}" found`)]:[]},enum:vs,filter:bs,function:xs,layer:sc,object:Nn,source:Sn,model:n.a4,light:Ns,"light-3d":Ts,terrain:Vs,fog:Us,string:ws,formatted:function(l){return ws(l).length===0?[]:co(l)},resolvedImage:function(l){return ws(l).length===0?[]:co(l)},projection:function(l){let t=l.value,o=l.styleSpec,c=o.projection,d=l.style,p=[],_=n.J(t);if(_==="object")for(let x in t)p=p.concat(hr({key:x,value:t[x],valueSpec:c[x],style:d,styleSpec:o}));else _!=="string"&&(p=p.concat([new n.V("projection",t,`object or string expected, ${_} found`)]));return p},import:function(l){let{value:t,styleSpec:o}=l,{data:c,...d}=t;Object.defineProperty(d,"__line__",{value:t.__line__,enumerable:!1});let p=Nn(n.L({},l,{value:d,valueSpec:o.import}));return n.M(d.id)===""&&p.push(new n.V(`${l.key}.id`,d,"import id can't be an empty string")),c&&(p=p.concat(lc(c,o,{key:`${l.key}.data`}))),p},iconset:function(l){let t=l.value,o=l.key,c=l.styleSpec,d=l.style;if(!t.type)return[new n.V(o,t,'"type" is required')];let p=n.M(t.type),_=[];if(_=_.concat(Nn({key:o,value:t,valueSpec:c[`iconset_${p}`],style:d,styleSpec:c})),p==="source"&&t.source){let x=d.sources&&d.sources[t.source],b=x&&n.M(x.type);x?b!=="raster-array"&&_.push(new n.V(o,t.source,`iconset cannot be used with a source of type ${String(b)}, it only be used with a "raster-array" source type`)):_.push(new n.V(o,t.source,`source "${t.source}" not found`))}return _}};function hr(l,t=!1){let o=l.value,c=l.valueSpec,d=l.styleSpec;if(c.expression&&n.a2(n.M(o)))return xs(l);if(c.expression&&n.S(n.U(o)))return co(l);if(c.type&&Ja[c.type]){let p=Ja[c.type](l);return t===!0&&p.length>0&&n.J(l.value)==="array"?co(l):p}return Nn(n.L({},l,{valueSpec:c.type?d[c.type]:c}))}function ac(l){let t=l.value,o=l.key,c=ws(l);return c.length||(t.indexOf("{fontstack}")===-1&&c.push(new n.V(o,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&c.push(new n.V(o,t,'"glyphs" url must include a "{range}" token'))),c}function lc(l,t=n.a5,o={}){return hr({key:o.key||"",value:l,valueSpec:t.$root,styleSpec:t,style:l,objectElementValidators:{glyphs:ac,"*":()=>[]}})}function po(l,t=n.a5){return fe(lc(l,t))}let cc=l=>fe(Sn(l)),ad=l=>fe(Ns(l)),Qa=l=>fe(Ts(l)),Qe=l=>fe(Vs(l)),Ss=l=>fe(Us(l)),ld=l=>fe(function(t){let o=t.value,c=t.style,d=t.styleSpec,p=d.snow,_=[],x=n.J(o);if(o===void 0)return _;if(x!=="object")return _=_.concat([new n.V("snow",o,`object expected, ${x} found`)]),_;for(let b in o){let M=b.match(/^(.*)-transition$/);_=_.concat(M&&p[M[1]]&&p[M[1]].transition?hr({key:b,value:o[b],valueSpec:d.transition,style:c,styleSpec:d}):p[b]?hr({key:b,value:o[b],valueSpec:p[b],style:c,styleSpec:d}):[new n.K(b,o[b],`unknown property "${b}"`)])}return _}(l)),hc=l=>fe(function(t){let o=t.value,c=t.style,d=t.styleSpec,p=d.rain,_=[],x=n.J(o);if(o===void 0)return _;if(x!=="object")return _=_.concat([new n.V("rain",o,`object expected, ${x} found`)]),_;for(let b in o){let M=b.match(/^(.*)-transition$/);_=_.concat(M&&p[M[1]]&&p[M[1]].transition?hr({key:b,value:o[b],valueSpec:d.transition,style:c,styleSpec:d}):p[b]?hr({key:b,value:o[b],valueSpec:p[b],style:c,styleSpec:d}):[new n.K(b,o[b],`unknown property "${b}"`)])}return _}(l)),Ai=l=>fe(sc(l)),Re=l=>fe(bs(l)),q=l=>fe(Vn(l)),$=l=>fe(ho(l)),ie=l=>fe(n.a4(l));function fe(l){return l.slice().sort((t,o)=>t.line&&o.line?t.line-o.line:0)}function re(l,t){let o=!1;if(t&&t.length)for(let c of t)c instanceof n.K?n.w(c.message):(l.fire(new n.z(new Error(c.message))),o=!0);return o}let ye;class De extends n.E{constructor(t,o="flat"){super(),this._transitionable=new n.a6(ye||(ye=new n.a7({anchor:new n.a8(n.a5.light.anchor),position:new n.a9(n.a5.light.position),color:new n.a8(n.a5.light.color),intensity:new n.a8(n.a5.light.intensity)}))),this.setLight(t,o),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,o,c={}){this._validate(ad,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=o)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,c){return(!c||c.validate!==!1)&&re(this,t.call(po,n.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:n.a5})))}}let be=class extends n.E{constructor(l,t,o,c,d){super(),this.scope=o,this._transitionable=new n.a6(new n.a7({source:new n.a8(n.a5.terrain.source),exaggeration:new n.a8(n.a5.terrain.exaggeration)}),o,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=d}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new n.aa(l,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;let l=this._transitionable._values.exaggeration;if(!l)return null;let t=l.value.expression;if(!t)return null;let o=-1,c=-1,d=1;for(let p of t.zoomStops)d=t.evaluate(new n.aa(p,{worldview:this.worldview})),d>.01?(o=p,c=-1):c=p;return d<.01&&o>0&&c>o?[o,c]:null}isZoomDependent(){let l=this._transitionable._values.exaggeration;return l!=null&&l.value!=null&&l.value.expression!=null&&l.value.expression instanceof n.ab}},Le=45,st=65,He=.05;function kt(l,t,o,c){let d=n.af(Le,st,o),[p,_]=Ht(l,c),x=1-Math.min(1,Math.exp((t-p)/(_-p)*-6));return x*=x*x,x=Math.min(1,1.00747*x),x*d*l.alpha}function Ht(l,t){let o=.5/Math.tan(.5*t);return[l.range[0]+o,l.range[1]+o]}function Xt(l,t,o,c,d){let p=n.ad([],[t,o,c],d.mercatorFogMatrix);return kt(l,n.ae(p),d.pitch,d._fov)}function ui(l,t,o,c,d,p,_){let x=[[o,c,0],[d,c,0],[d,p,0],[o,p,0]],b=Number.MAX_VALUE,M=-Number.MAX_VALUE;for(let C of x){let z=n.ad([],C,t),P=n.ae(z);b=Math.min(b,P),M=Math.max(M,P)}return[kt(l,b,_.pitch,_._fov),kt(l,M,_.pitch,_._fov)]}class si extends n.E{constructor(t,o,c,d){super();let p=new n.a7({range:new n.a8(n.a5.fog.range),color:new n.a8(n.a5.fog.color),"color-use-theme":new n.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new n.a8(n.a5.fog["high-color"]),"high-color-use-theme":new n.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new n.a8(n.a5.fog["space-color"]),"space-color-use-theme":new n.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new n.a8(n.a5.fog["horizon-blend"]),"star-intensity":new n.a8(n.a5.fog["star-intensity"]),"vertical-range":new n.a8(n.a5.fog["vertical-range"])});this._transitionable=new n.a6(p,c,new Map(d)),this.set(t,d),this._transitioning=this._transitionable.untransitioned(),this._transform=o,this.properties=new n.ag(p),this.scope=c}get state(){let t=this._transform,o=t.projection.name==="globe",c=n.ah(t.zoom),d=this.properties.get("range"),p=[.5,3];return{range:o?[n.ai(p[0],d[0],c),n.ai(p[1],d[1],c)]:d,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,o,c={}){if(this._validate(Ss,t,c))return;let d=n.h({},t);for(let p of Object.keys(n.a5.fog))d[p]===void 0&&(d[p]=n.a5.fog[p].default);this._options=d,this._transitionable.setTransitionOrValue(this._options,o)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;let o=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:n.af(Le,st,t))*o.a}getOpacityAtLatLng(t,o){return this._transform.projection.supportsFog?function(c,d,p){let _=n.ac.fromLngLat(d),x=p.elevation?p.elevation.getAtPointOrZero(_):0;return Xt(c,_.x,_.y,x,p)}(this.state,t,o):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];let o=this._transform.calculateFogTileMatrix(t.toUnwrapped());return ui(this.state,o,0,0,n.aj,n.aj,this._transform)}getOpacityForBounds(t,o,c,d,p){return this._transform.projection.supportsFog?ui(this.state,t,o,c,d,p,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?Ht(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;let o=[4,5,6,7];for(let c of o){let d=t.points[c],p;if(d[2]>=0)p=d;else{let _=t.points[c-4];p=n.ak(_,d,_[2]/(_[2]-d[2]))}if(Xt(this.state,p[0],p[1],0,this._transform)>=He)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,c){return(!c||c.validate!==!1)&&re(this,t.call(po,n.h({value:o,style:{glyphs:!0,sprite:!0},styleSpec:n.a5})))}}let di,Yi,pi,Mr,Qr=class extends n.E{constructor(l,t,o,c){super();let d=di||(di=new n.a7({density:new n.a8(n.a5.snow.density),intensity:new n.a8(n.a5.snow.intensity),color:new n.a8(n.a5.snow.color),opacity:new n.a8(n.a5.snow.opacity),vignette:new n.a8(n.a5.snow.vignette),"vignette-color":new n.a8(n.a5.snow["vignette-color"]),"center-thinning":new n.a8(n.a5.snow["center-thinning"]),direction:new n.a8(n.a5.snow.direction),"flake-size":new n.a8(n.a5.snow["flake-size"])}));this._transitionable=new n.a6(d,o,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new n.ag(d),this.scope=o}get state(){let l=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),c=n.al(o[0]),d=-Math.max(n.al(o[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],_=this.properties.get("vignette"),x=this.properties.get("vignette-color");return x.a=_,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new n.am(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:x}}get(){return this._transitionable.serialize()}set(l,t,o={}){if(this._validate(ld,l,o))return;let c=n.h({},l);for(let d of Object.keys(n.a5.snow))c[d]===void 0&&(c[d]=n.a5.snow[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,o){return(!o||o.validate!==!1)&&re(this,l.call(po,n.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:n.a5})))}},$r=class extends n.E{constructor(l,t,o,c){super();let d=Yi||(Yi=new n.a7({density:new n.a8(n.a5.rain.density),intensity:new n.a8(n.a5.rain.intensity),color:new n.a8(n.a5.rain.color),opacity:new n.a8(n.a5.rain.opacity),vignette:new n.a8(n.a5.rain.vignette),"vignette-color":new n.a8(n.a5.rain["vignette-color"]),"center-thinning":new n.a8(n.a5.rain["center-thinning"]),direction:new n.a8(n.a5.rain.direction),"droplet-size":new n.a8(n.a5.rain["droplet-size"]),"distortion-strength":new n.a8(n.a5.rain["distortion-strength"])}));this._transitionable=new n.a6(d,o,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new n.ag(d),this.scope=o}get state(){let l=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),c=n.al(o[0]),d=-Math.max(n.al(o[1]),.01),p=[Math.cos(c)*Math.cos(d),Math.sin(c)*Math.cos(d),Math.sin(d)],_=this.properties.get("vignette-color");return _.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new n.am(t.r,t.g,t.b,t.a*l),direction:p,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:_}}get(){return this._transitionable.serialize()}set(l,t,o={}){if(this._validate(hc,l,o))return;let c=n.h({},l);for(let d of Object.keys(n.a5.rain))c[d]===void 0&&(c[d]=n.a5.rain[d].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,o){return(!o||o.validate!==!1)&&re(this,l.call(po,n.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:n.a5})))}};class Hi extends n.E{constructor(t,o,c,d){super(),this.scope=c,this._options=t,this.properties=new n.ag(o),this._transitionable=new n.a6(o,c,new Map(d)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,o){this._options=t,this._transitionable.setTransitionOrValue(t.properties,o)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Pi{constructor(t,o,c){this.screenBounds=t,this.cameraPoint=c.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=o,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,c)}static createFromScreenPoints(t,o){let c,d;if(t instanceof n.P||typeof t[0]=="number"){let p=n.P.convert(t);c=[p],d=o.isPointAboveHorizon(p)}else{let p=n.P.convert(t[0]),_=n.P.convert(t[1]),x=p.add(_)._div(2);c=[p,_],d=n.ao(p,_).every(b=>o.isPointAboveHorizon(b))&&o.isPointAboveHorizon(x)}return new Pi(c,d,o)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return n.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){let o=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new n.P(1,1)):this.screenBounds[1],d=n.ao(o,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>o.x&&this.cameraPoint.x<c.x?d.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?d[2]=this.cameraPoint:this.cameraPoint.x<=o.x&&(d[3]=this.cameraPoint)),n.ap(d,t)}bufferedCameraGeometryGlobe(t){let o=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new n.P(1,1)):this.screenBounds[1],d=n.ao(o,c,t),p=this.cameraPoint.clone();switch(3*((p.y>o.y)+(p.y>c.y))+((p.x>o.x)+(p.x>c.x))){case 0:d[0]=p,d[4]=p.clone();break;case 1:d.splice(1,0,p);break;case 2:d[1]=p;break;case 3:d.splice(4,0,p);break;case 5:d.splice(2,0,p);break;case 6:d[3]=p;break;case 7:d.splice(3,0,p);break;case 8:d[2]=p}return d}containsTile(t,o,c,d=0){let p=t.queryPadding/o._pixelsPerMercatorPixel+1,_=c?this._bufferedCameraMercator(p,o):this._bufferedScreenMercator(p,o),x=t.tileID.wrap+(_.unwrapped?d:0),b=_.polygon.map(j=>n.aq(t.tileTransform,j,x));if(!n.ar(b,0,0,n.aj,n.aj))return;x=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?d:0);let M=this.screenGeometryMercator.polygon.map(j=>n.as(t.tileTransform,j,x)),C=M.map(j=>new n.P(j[0],j[1])),z=o.getFreeCameraOptions().position||new n.ac(0,0,0),P=n.as(t.tileTransform,z,x),D=M.map(j=>{let U=n.at(j,j,P);return n.au(U,U),new n.av(P,U)}),N=n.aw(t,1,o.zoom)*o._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:C,tilespaceRays:D,bufferedTilespaceGeometry:b,bufferedTilespaceBounds:(F=n.ax(b),F.min.x=n.ay(F.min.x,0,n.aj),F.min.y=n.ay(F.min.y,0,n.aj),F.max.x=n.ay(F.max.x,0,n.aj),F.max.y=n.ay(F.max.y,0,n.aj),F),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:N};var F}_bufferedScreenMercator(t,o){let c=_r(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let d;return d=o.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),o):{polygon:this.bufferedScreenGeometry(t).map(p=>o.pointCoordinate3D(p)),unwrapped:!0},this._screenRaycastCache[c]=d,d}}_bufferedCameraMercator(t,o){let c=_r(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let d;return d=o.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),o):{polygon:this.bufferedCameraGeometry(t).map(p=>o.pointCoordinate3D(p)),unwrapped:!0},this._cameraRaycastCache[c]=d,d}}_projectAndResample(t,o){let c=function(p,_){let x=n.az([],_.pixelMatrix,_.globeMatrix),b=[0,-n.aB,0,1],M=[0,n.aB,0,1],C=[0,0,0,1];n.aA(b,b,x),n.aA(M,M,x),n.aA(C,C,x);let z=new n.P(b[0]/b[3],b[1]/b[3]),P=new n.P(M[0]/M[3],M[1]/M[3]),D=n.aC(p,z)&&b[3]<C[3],N=n.aC(p,P)&&M[3]<C[3];if(!D&&!N)return null;let F=function(de,oe,se){for(let le=1;le<de.length;le++){let Me=wr(oe.pointCoordinate3D(de[le-1]).x),_e=wr(oe.pointCoordinate3D(de[le]).x);if(se<0){if(Me<_e)return{idx:le,t:-Me/(_e-1-Me)}}else if(_e<Me)return{idx:le,t:(1-Me)/(_e+1-Me)}}return null}(p,_,D?-1:1);if(!F)return null;let{idx:j,t:U}=F,Z=j>1?Ir(p.slice(0,j),_):[],Y=j<p.length?Ir(p.slice(j),_):[];Z=Z.map(de=>new n.P(wr(de.x),de.y)),Y=Y.map(de=>new n.P(wr(de.x),de.y));let Q=[...Z];Q.length===0&&Q.push(Y[Y.length-1]);let ne=n.ai(Q[Q.length-1].y,(Y.length===0?Z[0]:Y[0]).y,U),he;return he=D?[new n.P(0,ne),new n.P(0,0),new n.P(1,0),new n.P(1,ne)]:[new n.P(1,ne),new n.P(1,1),new n.P(0,1),new n.P(0,ne)],Q.push(...he),Y.length===0?Q.push(Z[0]):Q.push(...Y),{polygon:Q.map(de=>new n.ac(de.x,de.y)),unwrapped:!1}}(t,o);if(c)return c;let d=function(p,_){let x=!1,b=-1/0,M=0;for(let z=0;z<p.length-1;z++)p[z].x>b&&(b=p[z].x,M=z);for(let z=0;z<p.length-1;z++){let P=(M+z)%(p.length-1),D=p[P],N=p[P+1];Math.abs(D.x-N.x)>.5&&(D.x<N.x?(D.x+=1,P===0&&(p[p.length-1].x+=1)):(N.x+=1,P+1===p.length-1&&(p[0].x+=1)),x=!0)}let C=n.aD(_.center.lng);return x&&C<Math.abs(C-1)&&p.forEach(z=>{z.x-=1}),{polygon:p,unwrapped:x}}(Ir(t,o).map(p=>new n.P(wr(p.x),p.y)),o);return{polygon:d.polygon.map(p=>new n.ac(p.x,p.y)),unwrapped:d.unwrapped}}}function Ir(l,t){return n.aE(l,o=>{let c=t.pointCoordinate3D(o);o.x=c.x,o.y=c.y},1/256)}function wr(l){return l<0?1+l%1:l%1}function _r(l){return 100*l|0}function ln(l,t,o,c,d){let p=function(x,b){if(x)return d(x);if(b){if(l.url&&b.tiles&&l.tiles&&delete l.tiles,b.variants){if(!Array.isArray(b.variants))return d(new Error("variants must be an array"));for(let C of b.variants){if(C==null||typeof C!="object"||C.constructor!==Object)return d(new Error("variant must be an object"));if(!Array.isArray(C.capabilities))return d(new Error("capabilities must be an array"));if(C.capabilities.length===1&&C.capabilities[0]==="meshopt"){b=n.h(b,C);break}}}let M=n.aF(n.h({},b,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);M.tiles=t.canonicalizeTileset(M,l.url),d(null,M)}},_=function(x,b,M){if(!x)return null;if(!b&&!M)return x;M=M||x.worldview_default;let C=Object.values(x.language||{});if(C.length===0)return null;let z=Object.values(x.worldview||{});if(z.length===0)return null;let P=C.every(N=>N===b),D=z.every(N=>N===M);return P&&D?x:b in(x.language_options||{})||M in(x.worldview_options||{})?null:x.language_options&&x.worldview_options?x:null}(l.data,o,c);return _?n.q.frame(()=>p(null,_)):l.url?n.n(t.transformRequest(t.normalizeSourceURL(l.url,null,o,c),n.R.Source),p):n.q.frame(()=>{let{data:x,...b}=l;p(null,b)})}function Un(l,t){let o=Math.pow(2,t.z),c=Math.floor(n.aD(l.getWest())*o),d=Math.floor(n.aH(l.getNorth())*o),p=Math.ceil(n.aD(l.getEast())*o),_=Math.ceil(n.aH(l.getSouth())*o);return t.x>=c&&t.x<p&&t.y>=d&&t.y<_}class En{constructor(t,o,c){this.bounds=t?n.aG.convert(this.validateBounds(t)):null,this.minzoom=o||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(let o of t)this.extraBounds.push(n.aG.convert(this.validateBounds(o)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!Un(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(let o of this.extraBounds)if(Un(o,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;let o=new En(t.bounds,t.minzoom,t.maxzoom);return o.addExtraBounds(t.extra_bounds),o}}class uc extends n.E{constructor(t,o,c,d){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,n.h(this,n.aF(o,["url","scheme","tileSize","promoteId"])),this._options=n.h({type:"vector"},o),this._collectResourceTiming=!!o.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(d),this._tileWorkers={},this._deduped=new n.aI}load(t){this._loaded=!1,this.fire(new n.A("dataloading",{dataType:"source"}));let o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=ln(this._options,this.map._requestManager,o,c,(d,p)=>{if(this._tileJSONRequest=null,this._loaded=!0,d)o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),c&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new n.z(d));else if(p){if(n.h(this,p),this.hasWorldviews=!!p.worldview_options,p.worldview_default&&(this.worldviewDefault=p.worldview_default),p.vector_layers){this.vectorLayers=p.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(let _ of p.vector_layers)this.vectorLayerIds.push(_.id),p.worldview&&p.worldview[_.source]&&this.localizableLayerIds.add(_.id)}this.tileBounds=En.fromTileJSON(p),tn(p.tiles,this.map._requestManager._customAccessToken),this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(d)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=n.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return n.h({},this._options)}loadTile(t,o){let c=t.tileID.canonical.url(this.tiles,this.scheme),d=this.map._requestManager.normalizeTileURL(c),p=this.map._requestManager.transformRequest(d,n.R.Tile),_=this.map.style?this.map.style.getLut(this.scope):null,x=_?{image:_.image.clone()}:null,b={request:p,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:x,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:n.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&n.j(c)&&(b.localizableLayerIds=this.localizableLayerIds),b.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=o:t.request=t.actor.send("reloadTile",b,M.bind(this));else if(t.actor=this._tileWorkers[d]=this._tileWorkers[d]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",b,M.bind(this),void 0,!0);else{let C=n.aJ.call({deduped:this._deduped},b,(z,P)=>{z||!P?M.call(this,z):(b.data={cacheControl:P.cacheControl,expires:P.expires,rawData:P.rawData.slice(0)},t.actor&&t.actor.send("loadTile",b,M.bind(this),void 0,!0))},!0);t.request={cancel:C}}function M(C,z){return delete t.request,t.aborted?o(null):C&&C.status!==404?o(C):(z&&z.resourceTiming&&(t.resourceTiming=z.resourceTiming),this.map._refreshExpiredTiles&&z&&t.setExpiryData(z),t.loadVectorData(z,this.map.painter),n.aK(this.dispatcher),o(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class mn extends n.E{constructor(t,o,c,d){super(),this.id=t,this.dispatcher=c,this.setEventedParent(d),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=n.h({type:"raster"},o),n.h(this,n.aF(o,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new n.A("dataloading",{dataType:"source"}));let o=this.map.getWorldview();this._tileJSONRequest=ln(this._options,this.map._requestManager,null,o,(c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new n.z(c)):d&&(n.h(this,d),d.raster_layers&&(this.rasterLayers=d.raster_layers,this.rasterLayerIds=this.rasterLayers.map(p=>p.id)),this.tileBounds=En.fromTileJSON(d),tn(d.tiles),this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(c)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=n.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return n.h({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,o){let c=n.q.devicePixelRatio>=2,d=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=n.o(this.map._requestManager.transformRequest(d,n.R.Tile),(p,_,x,b)=>(delete t.request,t.aborted?(t.state="unloaded",o(null)):p?(t.state="errored",o(p)):_?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:x,expires:b}),t.setTexture(_,this.map.painter),t.state="loaded",n.aK(this.dispatcher),void o(null)):o(null)))}abortTile(t,o){t.request&&(t.request.cancel(),delete t.request),o&&o()}unloadTile(t,o){t.texture&&t.texture instanceof n.T?(t.destroy(!0),t.texture&&t.texture instanceof n.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),o&&o()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class js extends mn{constructor(t,o,c,d){super(t,o,c,d),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=n.h({type:"raster-array"},o)}triggerRepaint(t){let o=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);o&&o.enabled&&c&&o._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,o){let c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),d=this.map._requestManager.transformRequest(c,n.R.Tile),p={request:d,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=d,t.actor||(t.actor=this.dispatcher.getActor());let _=(x,b,M,C)=>{if(delete t.request,t.aborted)return t.state="unloaded",o(null);if(x)return x.name==="AbortError"?void 0:(t.state="errored",o(x));if(this.map._refreshExpiredTiles&&b&&t.setExpiryData({cacheControl:M,expires:C}),this.partial)t.state="empty";else{if(!b)return o(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=b}o(null)};t.request=this.partial?t.fetchHeader(void 0,_.bind(this)):t.actor.send("loadTile",p,_.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){let c=t.texturePerLayer;if(t.flushAllQueues(),c.size){t.destroy(!0);for(let d of c.values())this.map.painter.saveTileTexture(d)}else t.destroy()}prepareTile(t,o,c,d){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(o,c,d,(p,_)=>{if(p)return t.state="errored",this.fire(new n.z(p)),void this.triggerRepaint(t);_&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(c,_,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;let o=this.rasterLayers.find(({id:p})=>p===t),c=o&&o.fields,d=c&&c.bands&&c.bands;return d?d[0]:0}getTextureDescriptor(t,o,c){if(!t)return;let d=o.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!d)return;let p=null;o instanceof n.aN?p=o.paint.get("raster-array-band"):o instanceof n.aO&&(p=o.paint.get("raster-particle-array-band"));let _=p||this.getInitialBand(d);if(_==null)return;if(!t.textureDescriptorPerLayer.get(o.id))return void this.prepareTile(t,d,o.id,_);if(t.updateNeeded(o.id,_)&&!c)return;let x=t.textureDescriptorPerLayer.get(o.id);return Object.assign({},x,{texture:t.texturePerLayer.get(o.id)})}getImages(t,o){let c=new Map;for(let d of t)for(let p of o){let[_,x]=p.split("/"),b=d.getLayer(_);if(!b||!b.hasBand(x)||!b.hasDataForBand(x))continue;let{bytes:M,tileSize:C,buffer:z}=b.getBandView(x),P=C+2*z,D={data:new n.r({width:P,height:P},M),pixelRatio:2,sdf:!1,usvg:!1,version:0};c.set(p,D)}return c}}let Sh={vector:uc,raster:mn,"raster-dem":class extends mn{constructor(l,t,o,c){super(l,t,o,c),this.type="raster-dem",this.maxzoom=22,this._options=n.h({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){let o=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(d,p){d&&(l.state="errored",t(d)),p&&(l.dem=p,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=n.o(this.map._requestManager.transformRequest(o,n.R.Tile),function(d,p,_,x){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(d)l.state="errored",t(d);else if(p){this.map._refreshExpiredTiles&&l.setExpiryData({cacheControl:_,expires:x});let b=ImageBitmap&&p instanceof ImageBitmap&&n.t(),M=1-(p.width-n.aL(p.width))/2;M<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));let C=b?p:n.q.getImageData(p,M),z={uid:l.uid,tileID:l.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:C,encoding:this.encoding,padding:M};l.actor&&l.state!=="expired"||(l.actor=this.dispatcher.getActor(),l.actor.send("loadTile",z,c.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(l){let t=l.canonical,o=Math.pow(2,t.z),c=(t.x-1+o)%o,d=t.x===0?l.wrap-1:l.wrap,p=(t.x+1+o)%o,_=t.x+1===o?l.wrap+1:l.wrap,x={};return x[new n.aM(l.overscaledZ,d,t.z,c,t.y).key]={backfilled:!1},x[new n.aM(l.overscaledZ,_,t.z,p,t.y).key]={backfilled:!1},t.y>0&&(x[new n.aM(l.overscaledZ,d,t.z,c,t.y-1).key]={backfilled:!1},x[new n.aM(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},x[new n.aM(l.overscaledZ,_,t.z,p,t.y-1).key]={backfilled:!1}),t.y+1<o&&(x[new n.aM(l.overscaledZ,d,t.z,c,t.y+1).key]={backfilled:!1},x[new n.aM(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},x[new n.aM(l.overscaledZ,_,t.z,p,t.y+1).key]={backfilled:!1}),x}},"raster-array":js,geojson:class extends n.E{constructor(l,t,o,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=o.getActor(),this.setEventedParent(c),this._data=t.data,this._options=n.h({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;let d=n.aj/this.tileSize;this.workerOptions=n.h({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*d,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*d,extent:n.aj,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:n.aj,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*d,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new n.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof l!="string"&&(l.type==="Feature"&&(l={type:"FeatureCollection",features:[l]}),l.type!=="FeatureCollection"))return this.fire(new n.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof l!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){let t=new Map;for(let o of this._data.features)t.set(o.id,o);for(let o of l.features)t.set(o.id,o);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,o,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:o},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new n.A("dataloading",{dataType:"source"})),this._loaded=!1;let t=n.h({append:l},this.workerOptions);t.scope=this.scope;let o=this._data;typeof o=="string"?(t.request=this.map._requestManager.transformRequest(n.q.resolveURL(o),n.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(o),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(c,d)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new n.z(c));else{let p={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&d&&d.resourceTiming&&d.resourceTiming[this.id]&&(p.resourceTiming=d.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new n.A("data",p)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)})}loaded(){return this._loaded}reload(){let l=n.C(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){let o=l.actor?"reloadTile":"loadTile";l.actor=this.actor;let c=this.map.style?this.map.style.getLut(this.scope):null,d=c?{image:c.image.clone()}:null,p=this._partialReload,_={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:d,scope:this.scope,pixelRatio:n.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:l.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:p,worldview:this.map.getWorldview()};l.request=this.actor.send(o,_,(x,b)=>p&&!b?(l.state="loaded",t(null)):(delete l.request,l.destroy(),l.aborted?t(null):x?t(x):(l.loadVectorData(b,this.map.painter,o==="reloadTile"),t(null))),void 0,o==="loadTile")}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return n.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends n.aP{constructor(l,t,o,c){super(l,t,o,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;let l=this.options;this.urls=[];for(let t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,n.R.Source).url);n.aQ(this.urls,(t,o)=>{this._loaded=!0,t?this.fire(new n.z(t)):o&&(this.video=o,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){let t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new n.z(new n.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new n.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:n.aP,model:class extends n.E{constructor(l,t,o,c){super(),this.id=l,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){let l=[];for(let t in this._options.models){let o=this._options.models[t],c=n.aS(this.map._requestManager.transformRequest(o.uri,n.R.Model).url).then(d=>{if(!d)return;let p=n.aT(d),_=new n.aU(t,o.position,o.orientation,p);_.computeBoundsAndApplyParent(),this.models.push(_)}).catch(d=>{this.fire(new n.z(new Error(`Could not load model ${t} from ${o.uri}: ${d.message}`)))});l.push(c)}Promise.allSettled(l).then(()=>{this._loaded=!0,this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this._loaded=!0,this.fire(new n.z(new Error(`Could not load models: ${t.message}`)))})}onAdd(l){this.map=l,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(l,t){}serialize(){return this._options}},"batched-model":class extends n.E{constructor(l,t,o,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=o,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();let l=n.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(l))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new n.A("dataloading",{dataType:"source"}));let t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map.getWorldview();this._tileJSONRequest=ln(this._options,this.map._requestManager,t,o,(c,d)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),o&&o.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new n.z(c))):d&&(n.h(this,d),d.bounds&&(this.tileBounds=new En(d.bounds,this.minzoom,this.maxzoom)),tn(d.tiles,this.map._requestManager._customAccessToken),this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)})}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){let o=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(o,n.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:n.q.devicePixelRatio,promoteId:this.promoteId};if(l.actor&&l.state!=="expired")if(l.state==="loading")l.reloadCallback=t;else{if(l.buckets){let p=Object.values(l.buckets);for(let _ of p)_.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,d.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,d.bind(this),void 0,!0);function d(p,_){return l.aborted?t(null):p&&p.status!==404?t(p):(this.map._refreshExpiredTiles&&_&&l.setExpiryData(_),l.loadModelData(_,this.map.painter),l.state="loaded",void t(null))}}serialize(){return n.h({},this._options)}},canvas:class extends n.aP{constructor(l,t,o,c){super(l,t,o,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(d=>!Array.isArray(d)||d.length!==2||d.some(p=>typeof p!="number"))||this.fire(new n.z(new n.V(`sources.${l}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new n.z(new n.V(`sources.${l}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new n.z(new n.V(`sources.${l}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new n.z(new n.V(`sources.${l}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new n.z(new n.V(`sources.${l}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new n.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof n.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new n.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends n.E{constructor(l,t,o,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=o,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new n.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new n.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new En(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),n.h(this,n.aF(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return n.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new n.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new n.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){let{x:t,y:o,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:o,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){let{x:o,y:c,z:d}=l.tileID.canonical,p=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:o,y:c,z:d},{signal:p.signal})).then(function(_){return delete l.request,l.aborted?(l.state="unloaded",t(null)):_===void 0?(l.state="errored",t(null)):_===null?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):function(x){return x instanceof ImageData||x instanceof HTMLCanvasElement||x instanceof ImageBitmap||x instanceof HTMLImageElement}(_)?(this.loadTileData(l,_),l.state="loaded",void t(null)):(l.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch(_=>{_.name!=="AbortError"&&(l.state="errored",t(_))}),l.request.cancel=()=>p.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof n.T?(l.destroy(!0),l.texture&&l.texture instanceof n.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){let{x:o,y:c,z:d}=l.tileID.canonical;this._implementation.unloadTile({x:o,y:c,z:d})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z}))}_clearTiles(){let l=n.C(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new n.A("data",{dataType:"source",sourceDataType:"content"}))}}},dc=function(l,t,o,c){let d=new Sh[t.type](l,t,o,c);if(d.id!==l)throw new Error(`Expected Source id to be ${l} instead of ${d.id}`);return n.aV(["load","abort","unload","serialize","prepare"],d),d};function pc(l,t,o=""){return`${o}:${t.id||""}:${t.layer.id}:${function(c){if("layerId"in c)return`layer:${c.layerId}`;{let{featuresetId:d,importId:p}=c;return`featureset:${d}${p?`:import:${p}`:""}`}}(l.target)}`}function Eh(l,t,o,c=""){if(l.uniqueFeatureID){let d=pc(l,t,c);if(o.has(d))return!0;o.add(d)}return!1}function Ih(l,t,o,c,d=!1){let p=t.sourceCache.transform,_=t.sourceCache.tilesIn(l,t.has3DLayers,d);_.sort(Ah);let x=[];for(let b of _){let M=b.tile.queryRenderedFeatures(t,b,o,c,p,d);Object.keys(M).length&&x.push({wrappedTileID:b.tile.tileID.wrapped().key,queryResults:M})}return x.length===0?{}:function(b){let M={},C={};for(let z of b){let P=z.queryResults,D=z.wrappedTileID,N=C[D]=C[D]||{};for(let F in P){let j=P[F],U=N[F]=N[F]||{},Z=M[F]=M[F]||[];for(let Y of j)U[Y.featureIndex]||(U[Y.featureIndex]=!0,Z.push(Y))}}return M}(x)}function va(l,t,o,c,d,p){let _={},x=c.queryRenderedSymbols(l),b=[];for(let M of Object.keys(x).map(Number))b.push(d[M]);b.sort(Ah);for(let M of b){let C=M.featureIndex.lookupSymbolFeatures(x[M.bucketInstanceId],M.bucketIndex,M.sourceLayerIndex,t,o,p);for(let z in C){let P=_[z]=_[z]||[],D=C[z];D.sort((N,F)=>{let j=M.featureSortOrder;if(j){let U=j.indexOf(N.featureIndex);return j.indexOf(F.featureIndex)-U}return F.featureIndex-N.featureIndex});for(let N of D)P.push(N)}}return _}function fc(l,t){let o=l.getRenderableIds().map(p=>l.getTileByID(p)),c=[],d={};for(let p=0;p<o.length;p++){let _=o[p],x=_.tileID.canonical.key;d[x]||(d[x]=!0,_.querySourceFeatures(c,t))}return c}function Ah(l,t){let o=l.tileID,c=t.tileID;return o.overscaledZ-c.overscaledZ||o.canonical.y-c.canonical.y||o.wrap-c.wrap||o.canonical.x-c.canonical.x}function Wo(l,t){let o={};if(!t)return o;for(let c of l){let d=c.layerIds.map(p=>t.getLayer(p)).filter(Boolean);if(d.length!==0){c.layers=d,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map(p=>d.filter(_=>_.id===p)[0]));for(let p of d)o[p.fqid]=c}}return o}let fo=32,zo=33,Es=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,o=0,c=0,d=0,p=0,_=0,x=0;for(1&t?d=p=_=fo:o=c=x=fo;(t>>=1)>1;){let M=o+d>>1,C=c+p>>1;1&t?(d=o,p=c,o=_,c=x):(o=d,c=p,d=_,p=x),_=M,x=C}let b=4*l;Es[b+0]=o,Es[b+1]=c,Es[b+2]=d,Es[b+3]=p}let Xo=new Uint16Array(2178),Is=new Uint8Array(1089),mc=new Uint16Array(1089);function os(l){return l===0?-.03125:l===32?.03125:0}let _c={type:2,extent:n.aj,loadGeometry:()=>[[new n.P(0,0),new n.P(n.aj+1,0),new n.P(n.aj+1,n.aj+1),new n.P(0,n.aj+1),new n.P(0,0)]]};class ba{constructor(t,o,c,d,p,_){this.tileID=t,this.uid=n.a$(),this.uses=0,this.tileSize=o,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=p,d&&d.style&&(this._lastUpdatedBrightness=d.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",d&&d.transform&&(this.projection=d.transform.projection),this.worldview=_}registerFadeDuration(t){let o=t+this.timeAdded;o<n.q.now()||this.fadeEndTime&&o<this.fadeEndTime||(this.fadeEndTime=o)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=n.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,o,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=Wo(t.buckets,o.style),this.hasSymbolBuckets=!1;for(let d in this.buckets){let p=this.buckets[d];if(p instanceof n.b1){if(this.hasSymbolBuckets=!0,!c)break;p.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let d in this.buckets){let p=this.buckets[d];if(p instanceof n.b1&&p.hasRTLText){this.hasRTLText=!0,n.b2();break}}this.queryPadding=0;for(let d in this.buckets){let p=this.buckets[d],_=o.style.getOwnLayer(d);if(!_)continue;let x=_.queryRadius(p);this.queryPadding=Math.max(this.queryPadding,x)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new n.b0}unloadVectorData(){if(this.hasData()){for(let t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,o,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,Wo(t.buckets,o.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(let d in this.buckets){let p=this.buckets[d];p.uploadPending()&&p.upload(t)}let o=t.gl,c=this.imageAtlas;c&&!c.uploaded&&(this.imageAtlasTexture=new n.T(t,c.image,o.RGBA8,{useMipmap:!!c.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new n.T(t,this.glyphAtlasImage,o.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new n.T(t,this.lineAtlas.image,o.R8),this.lineAtlas.uploaded=!0)}prepare(t,o,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!o||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let d=o.style.getBrightness();(this._lastUpdatedBrightness||d)&&(this._lastUpdatedBrightness&&d&&Math.abs(this._lastUpdatedBrightness-d)<.001||(this.updateBuckets(o,this._lastUpdatedBrightness!==d),this._lastUpdatedBrightness=d))}queryRenderedFeatures(t,o,c,d,p,_){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};let x=function(b,M){let C=n.bn([],[.5*b.width,.5*-b.height,1]);return n.bo(C,C,[1,-1,0]),n.az(C,C,b.calculateProjMatrix(M.toUnwrapped())),Float32Array.from(C)}(p,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:o,pixelPosMatrix:x,transform:d,availableImages:c,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(t,o){let c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;let d=c.loadVTLayers(),p=o?o.sourceLayer:"",_=d._geojsonTileLayer||d[p];if(!_)return;let x=n.b3(o&&o.filter),{z:b,x:M,y:C}=this.tileID.canonical,z={z:b,x:M,y:C};for(let P=0;P<_.length;P++){let D=_.feature(P);if(x.needGeometry){let j=n.b4(D,!0);if(!x.filter(new n.aa(this.tileID.overscaledZ,{worldview:this.worldview}),j,this.tileID.canonical))continue}else if(!x.filter(new n.aa(this.tileID.overscaledZ,{worldview:this.worldview}),D))continue;let N=c.getId(D,p),F=new n.b5(D,b,M,C,N);F.tile=z,t.push(F)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){let o=this.expirationTime;if(t.cacheControl){let c=n.b6(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){let c=Date.now(),d=!1;if(this.expirationTime>c)d=!1;else if(o)if(this.expirationTime<o)d=!0;else{let p=this.expirationTime-o;p?this.expirationTime=c+Math.max(p,3e4):d=!0}else d=!0;d?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,o){if(!this.latestFeatureIndex||!t.style)return;let c=this.latestFeatureIndex.loadVTLayers(),d=t.style.listImages(),p=t.style.getBrightness();for(let _ in this.buckets){if(!t.style.hasLayer(_))continue;let x=this.buckets[_],b=x.layers[0],M=b.sourceLayer||"_geojsonTileLayer",C=c[M],z=t.style.getLayerSourceCache(b),P={};z&&(P=z._state.getState(M,void 0));let D=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},N=Object.keys(P).length>0&&!o;N&&!x.stateDependentLayers.length&&!o||x.update(P,C,d,D,N?x.stateDependentLayers:x.layers,o,p),(x instanceof n.b7||x instanceof n.b8)&&t._terrain&&t._terrain.enabled&&z&&x.uploadPending()&&t._terrain._clearRenderCacheForTile(z.id,this.tileID);let F=t&&t.style&&t.style.getOwnLayer(_);F&&(this.queryPadding=Math.max(this.queryPadding,F.queryRadius(x)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<n.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=n.q.now()+t}setTexture(t,o){let c=o.context,d=c.gl;this.texture=this.texture||o.getTileTexture(t.width),this.texture&&this.texture instanceof n.T?this.texture.update(t):(this.texture=new n.T(c,t,d.RGBA8,{useMipmap:!0}),this.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE))}setDependencies(t,o){let c={};for(let d of o)c[d]=!0;this.dependencies[t]=c}hasDependency(t,o){for(let c of t){let d=this.dependencies[c];if(d){for(let p of o)if(d[p])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,o){if(!o||o.name==="mercator"||this._tileDebugBuffer)return;let c=n.b9(_c,this.tileID.canonical,this.tileTransform)[0],d=new n.ba,p=new n.bb;for(let _=0;_<c.length;_++){let{x,y:b}=c[_];d.emplaceBack(x,b),p.emplaceBack(_)}p.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(p),this._tileDebugBuffer=t.createVertexBuffer(d,n.bc.members),this._tileDebugSegments=n.bd.simpleSegment(0,0,d.length,p.length)}_makeTileBoundsBuffers(t,o){if(this._tileBoundsBuffer||!o||o.name==="mercator")return;let c=n.b9(_c,this.tileID.canonical,this.tileTransform)[0],d,p;if(this.isRaster){let _=function(x,b){let M=n.aW(x,b),C=Math.pow(2,x.z);for(let j=0;j<zo;j++)for(let U=0;U<zo;U++){let Z=n.aX((x.x+(U+os(U))/fo)/C),Y=n.aY((x.y+(j+os(j))/fo)/C),Q=b.project(Z,Y),ne=j*zo+U;Xo[2*ne+0]=Math.round((Q.x*M.scale-M.x)*n.aj),Xo[2*ne+1]=Math.round((Q.y*M.scale-M.y)*n.aj)}Is.fill(0),mc.fill(0);for(let j=2045;j>=0;j--){let U=4*j,Z=Es[U+0],Y=Es[U+1],Q=Es[U+2],ne=Es[U+3],he=Z+Q>>1,de=Y+ne>>1,oe=he+de-Y,se=de+Z-he,le=Y*zo+Z,Me=ne*zo+Q,_e=de*zo+he,Ve=Math.hypot((Xo[2*le+0]+Xo[2*Me+0])/2-Xo[2*_e+0],(Xo[2*le+1]+Xo[2*Me+1])/2-Xo[2*_e+1])>=16;Is[_e]=Is[_e]||(Ve?1:0),j<1022&&(Is[_e]=Is[_e]||Is[(Y+se>>1)*zo+(Z+oe>>1)]||Is[(ne+se>>1)*zo+(Q+oe>>1)])}let z=new n.aZ,P=new n.a_,D=0;function N(j,U){let Z=U*zo+j;return mc[Z]===0&&(z.emplaceBack(Xo[2*Z+0],Xo[2*Z+1],j*n.aj/fo,U*n.aj/fo),mc[Z]=++D),mc[Z]-1}function F(j,U,Z,Y,Q,ne){let he=j+Z>>1,de=U+Y>>1;if(Math.abs(j-Q)+Math.abs(U-ne)>1&&Is[de*zo+he])F(Q,ne,j,U,he,de),F(Z,Y,Q,ne,he,de);else{let oe=N(j,U),se=N(Z,Y),le=N(Q,ne);P.emplaceBack(oe,se,le)}}return F(0,0,fo,fo,fo,0),F(fo,fo,0,0,0,fo),{vertices:z,indices:P}}(this.tileID.canonical,o);d=_.vertices,p=_.indices}else{d=new n.aZ,p=new n.a_;for(let{x,y:b}of c)d.emplaceBack(x,b,0,0);let _=n.be(d.int16.subarray(0,4*d.length),void 0,4);for(let x=0;x<_.length;x+=3)p.emplaceBack(_[x],_[x+1],_[x+2])}this._tileBoundsBuffer=t.createVertexBuffer(d,n.bf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(p),this._tileBoundsSegments=n.bd.simpleSegment(0,0,d.length,p.length)}_makeGlobeTileDebugBuffers(t,o){let c=o.projection;if(!c||c.name!=="globe"||o.freezeTileCoverage)return;let d=this.tileID.canonical,p=n.bg(d,o),_=n.bh(p),x=n.ah(o.zoom),b;x>0&&(b=n.bi(new Float64Array(16),o.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,d,o,_,b,x),this._makeGlobeTileDebugTextBuffer(t,d,o,_,b,x)}_globePoint(t,o,c,d,p,_,x){let b=n.bj(t,o,c);if(_){let M=1<<c.z,C=n.aD(d.center.lng),z=n.aH(d.center.lat),P=(c.x+.5)/M-C,D=0;P>.5?D=-1:P<-.5&&(D=1);let N=(t/n.aj+c.x)/M+D,F=(o/n.aj+c.y)/M;N=(N-C)*d._pixelsPerMercatorPixel+C,F=(F-z)*d._pixelsPerMercatorPixel+z;let j=[N*d.worldSize,F*d.worldSize,0];n.ad(j,j,_),b=n.bk(b,j,x)}return n.ad(b,b,p)}_makeGlobeTileDebugBorderBuffer(t,o,c,d,p,_){let x=new n.ba,b=new n.bb,M=new n.bl,C=(P,D,N,F,j)=>{let U=(N-P)/(j-1),Z=(F-D)/(j-1),Y=x.length;for(let Q=0;Q<j;Q++){let ne=P+Q*U,he=D+Q*Z;x.emplaceBack(ne,he);let de=this._globePoint(ne,he,o,c,d,p,_);M.emplaceBack(de[0],de[1],de[2]),b.emplaceBack(Y+Q)}},z=n.aj;C(0,0,z,0,16),C(z,0,z,z,16),C(z,z,0,z,16),C(0,z,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(b),this._tileDebugBuffer=t.createVertexBuffer(x,n.bc.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(M,n.bm.members),this._tileDebugSegments=n.bd.simpleSegment(0,0,x.length,b.length)}_makeGlobeTileDebugTextBuffer(t,o,c,d,p,_){let x=n.aj/4,b=new n.ba,M=new n.a_,C=new n.bl,z=25;M.reserve(32),b.reserve(z),C.reserve(z);let P=(D,N)=>z*D+N;for(let D=0;D<z;D++){let N=D*x;for(let F=0;F<z;F++){let j=F*x;b.emplaceBack(j,N);let U=this._globePoint(j,N,o,c,d,p,_);C.emplaceBack(U[0],U[1],U[2])}}for(let D=0;D<4;D++)for(let N=0;N<4;N++){let F=P(D,N),j=P(D,N+1),U=P(D+1,N),Z=P(D+1,N+1);M.emplaceBack(F,j,U),M.emplaceBack(U,j,Z)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(M),this._tileDebugTextBuffer=t.createVertexBuffer(b,n.bc.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(C,n.bm.members),this._tileDebugTextSegments=n.bd.simpleSegment(0,0,z,32)}destroy(t=!1){for(let o in this.buckets)this.buckets[o].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof n.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}n.bp.setPbf(n.bq);class el extends ba{constructor(t,o,c,d,p){super(t,o,c,d,p),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,o,c){let d=c.context,p=d.gl,_=this.texturePerLayer.get(t)||c.getTileTexture(o.width);_&&_ instanceof n.T?_.update(o,{premultiply:!1}):_=new n.T(d,o,p.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,_)}flushQueues(t){let o=this._workQueuePerLayer.get(t)||[],c=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()();for(;c.length;)c.pop()()}flushAllQueues(){for(let t of this._workQueuePerLayer.keys()){let o=this._workQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}for(let t of this._fetchQueuePerLayer.keys()){let o=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}}fetchHeader(t=16384,o){let c=this._mrt=new n.bp(30),d=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=n.br(d,(p,_,x,b)=>{if(p)o(p);else try{let M=c.getHeaderLength(_);if(M>t)return void(this.request=this.fetchHeader(M,o));c.parseHeader(_),this._isHeaderLoaded=!0;let C=0;for(let z of Object.values(c.layers))C=Math.max(C,z.dataIndex[z.dataIndex.length-1].lastByte);_.byteLength>=C&&(this.entireBuffer=_),o(null,this.entireBuffer||_,x,b)}catch(M){o(M)}}),this.request}fetchBand(t,o,c,d){let p=this._mrt;if(!this._isHeaderLoaded||!p)return void d(new Error("Tile header is not ready"));let _=this.actor;if(!_)return void d(new Error("Can't fetch tile band without an actor"));let x,b=(P,D)=>{if(x.complete(P,D),P)return void d(P);this.updateTextureDescriptor(t,o,c);let N=this.textureDescriptorPerLayer.get(o);d(null,N&&N.img)},M=(P,D)=>{if(P)return d(P);let N=_.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:D,task:x},b,void 0,!0),F=this._workQueuePerLayer.get(o)||[];F.push(()=>{N&&N.cancel(),x.cancel()}),this._workQueuePerLayer.has(o)||this._workQueuePerLayer.set(o,F)},C=p.getLayer(t);if(!C)return void d(new Error(`Unknown sourceLayer "${t}"`));if(C.hasDataForBand(c)){this.updateTextureDescriptor(t,o,c);let P=this.textureDescriptorPerLayer.get(o);return void d(null,P?P.img:null)}let z=C.getDataRange([c]);if(x=p.createDecodingTask(z),!x||x.tasks.length)if(this.flushQueues(o),this.entireBuffer)M(null,this.entireBuffer.slice(z.firstByte,z.lastByte+1));else{let P=Object.assign({},this.requestParams,{headers:{Range:`bytes=${z.firstByte}-${z.lastByte}`}}),D=n.br(P,M),N=this._fetchQueuePerLayer.get(o)||[];N.push(()=>{D.cancel(),x.cancel()}),this._fetchQueuePerLayer.has(o)||this._fetchQueuePerLayer.set(o,N)}else d(null)}updateNeeded(t,o){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==o)&&this.state!=="errored"}updateTextureDescriptor(t,o,c){if(!this._mrt)return;let d=this._mrt.getLayer(t);if(!d||!d.hasBand(c)||!d.hasDataForBand(c))return;let{bytes:p,tileSize:_,buffer:x,offset:b,scale:M}=d.getBandView(c),C=_+2*x,z=new n.r({width:C,height:C},p),P=this.texturePerLayer.get(o);P&&P instanceof n.T&&P.update(z,{premultiply:!1}),this.textureDescriptorPerLayer.set(o,{layer:t,band:c,img:z,buffer:x,offset:b,tileSize:_,format:d.pixelFormat,mix:[M,256*M,65536*M,16777216*M]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(let o of this.texturePerLayer.values())o&&o instanceof n.T&&o.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class cd{constructor(t,o){this.max=t,this.onRemove=o,this.reset()}reset(){for(let t in this.data)for(let o of this.data[t])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(t,o,c){let d=t.wrapped().key;this.data[d]===void 0&&(this.data[d]=[]);let p={value:o,timeout:void 0};if(c!==void 0&&(p.timeout=setTimeout(()=>{this.remove(t,p)},c)),this.data[d].push(p),this.order.push(d),this.order.length>this.max){let _=this._getAndRemoveByKey(this.order[0]);_&&this.onRemove(_)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){let o=this.data[t].shift();return o.timeout&&clearTimeout(o.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),o.value}getByKey(t){let o=this.data[t];return o?o[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,o){if(!this.has(t))return this;let c=t.wrapped().key,d=o===void 0?0:this.data[c].indexOf(o),p=this.data[c][d];return this.data[c].splice(d,1),p.timeout&&clearTimeout(p.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(p.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){let o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(t){let o=[];for(let c in this.data)for(let d of this.data[c])t(d.value)||o.push(d);for(let c of o)this.remove(c.value.tileID,c)}}class hd{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,o,c){let d=String(o);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][d]=this.stateChanges[t][d]||{},n.h(this.stateChanges[t][d],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(let p in this.state[t])p!==d&&(this.deletedStates[t][p]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][d]===null){this.deletedStates[t][d]={};for(let p in this.state[t][d])c[p]||(this.deletedStates[t][d][p]=null)}else for(let p in c)this.deletedStates[t]&&this.deletedStates[t][d]&&this.deletedStates[t][d][p]===null&&delete this.deletedStates[t][d][p]}removeFeatureState(t,o,c){if(this.deletedStates[t]===null)return;let d=String(o);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&o!==void 0)this.deletedStates[t][d]!==null&&(this.deletedStates[t][d]=this.deletedStates[t][d]||{},this.deletedStates[t][d][c]=null);else if(o!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][d])for(c in this.deletedStates[t][d]={},this.stateChanges[t][d])this.deletedStates[t][d][c]=null;else this.deletedStates[t][d]=null;else this.deletedStates[t]=null}getState(t,o){let c=this.state[t]||{},d=this.stateChanges[t]||{},p=this.deletedStates[t];if(p===null)return{};if(o!==void 0){let x=String(o),b=n.h({},c[x],d[x]);if(p){let M=p[o];if(M===null)return{};for(let C in M)delete b[C]}return b}let _=n.h({},c,d);if(p)for(let x in p)delete _[x];return _}initializeTileState(t,o){t.refreshFeatureState(o)}coalesceChanges(t,o){let c={};for(let d in this.stateChanges){this.state[d]=this.state[d]||{};let p={};for(let _ in this.stateChanges[d])this.state[d][_]||(this.state[d][_]={}),n.h(this.state[d][_],this.stateChanges[d][_]),p[_]=this.state[d][_];c[d]=p}for(let d in this.deletedStates){this.state[d]=this.state[d]||{};let p={};if(this.deletedStates[d]===null)for(let _ in this.state[d])p[_]={},this.state[d][_]={};else for(let _ in this.deletedStates[d]){if(this.deletedStates[d][_]===null)this.state[d][_]={};else if(this.state[d][_])for(let x of Object.keys(this.deletedStates[d][_]))delete this.state[d][_][x];p[_]=this.state[d][_]}c[d]=c[d]||{},n.h(c[d],p)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(let d in t)t[d].refreshFeatureState(o)}}class jn extends n.E{constructor(t,o,c){super(),this.id=t,this._onlySymbols=c,o.on("data",d=>{d.dataType==="source"&&d.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&d.dataType==="source"&&d.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),o.on("error",()=>{this._sourceErrored=!0}),this._source=o,this._tiles={},this._cache=new cd(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=o.minTileCacheSize,this._maxTileCacheSize=o.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new hd,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,o){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,o)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let o in this._tiles){let c=this._tiles[o];c.upload(t),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(wa).map(t=>t.key)}getRenderableIds(t,o){let c=[];for(let d in this._tiles)this._isIdRenderable(+d,t,o)&&c.push(this._tiles[d]);return t?c.sort((d,p)=>{let _=d.tileID,x=p.tileID,b=new n.P(_.canonical.x,_.canonical.y)._rotate(this.transform.angle),M=new n.P(x.canonical.x,x.canonical.y)._rotate(this.transform.angle);return _.overscaledZ-x.overscaledZ||M.y-b.y||M.x-b.x}).map(d=>d.tileID.key):c.map(d=>d.tileID).sort(wa).map(d=>d.key)}hasRenderableParent(t){let o=this.findLoadedParent(t,0);return!!o&&this._isIdRenderable(o.tileID.key)}_isIdRenderable(t,o,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(o||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,o){let c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=o),this._loadTile(c,this._tileLoaded.bind(this,c,t,o)))}_tileLoaded(t,o,c,d){if(d)if(t.state="errored",d.status!==404)this._source.fire(new n.z(d,{tile:t}));else{if(this._source.fire(new n.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){let p=this.map.painter.terrain;this.update(this.transform,p.getScaledDemTileSize(),!0),p.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=n.q.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(o,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new n.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){let o=this.getRenderableIds();for(let d=0;d<o.length;d++){let p=o[d];if(t.neighboringTiles&&t.neighboringTiles[p]){let _=this.getTileByID(p);c(t,_),c(_,t)}}function c(d,p){if(!d.dem||d.dem.borderReady)return;d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0;let _=p.tileID.canonical.x-d.tileID.canonical.x,x=p.tileID.canonical.y-d.tileID.canonical.y,b=Math.pow(2,d.tileID.canonical.z),M=p.tileID.key;_===0&&x===0||Math.abs(x)>1||(Math.abs(_)>1&&(Math.abs(_+b)===1?_+=b:Math.abs(_-b)===1&&(_-=b)),p.dem&&d.dem&&(d.dem.backfillBorder(p.dem,_,x),d.neighboringTiles&&d.neighboringTiles[M]&&(d.neighboringTiles[M].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,o,c,d){for(let p in this._tiles){let _=this._tiles[p];if(d[p]||!_.hasData()||_.tileID.overscaledZ<=o||_.tileID.overscaledZ>c)continue;let x=_.tileID;for(;_&&_.tileID.overscaledZ>o+1;){let M=_.tileID.scaledTo(_.tileID.overscaledZ-1);_=this._tiles[M.key],_&&_.hasData()&&(x=M)}let b=x;for(;b.overscaledZ>o;)if(b=b.scaledTo(b.overscaledZ-1),t[b.key]){d[x.key]=x;break}}}findLoadedParent(t,o){if(t.key in this._loadedParentTiles){let c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=o?c:null}for(let c=t.overscaledZ-1;c>=o;c--){let d=t.scaledTo(c),p=this._getLoadedTile(d);if(p)return p}}_getLoadedTile(t){let o=this._tiles[t.key];return o&&o.hasData()?o:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,o){o=o||this._source.tileSize;let c=Math.ceil(t.width/o)+1,d=Math.ceil(t.height/o)+1,p=Math.floor(c*d*5),_=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,p):p,x=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,_):_;this._cache.setMaxSize(x)}handleWrapJump(t){let o=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,o){let c={};for(let d in this._tiles){let p=this._tiles[d];p.tileID=p.tileID.unwrapTo(p.tileID.wrap+o),c[p.tileID.key]=p}this._tiles=c;for(let d in this._timers)clearTimeout(this._timers[d]),delete this._timers[d];for(let d in this._tiles)this._setTileReloadTimer(+d,this._tiles[d])}}update(t,o,c,d,p){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,o),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let _=this._source.type==="batched-model",x,b=this._source.maxzoom,M=this.map&&this.map.painter?this.map.painter._terrain:null;if(M&&M.sourceCache===this&&M.attenuationRange()){let P=M.attenuationRange()[0],D=Math.floor(P)-Math.log2(M.getDemUpscale());b>D&&(b=D)}if(this.used||this.usedForTerrain){if(this._source.tileID)x=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(P=>new n.aM(P.canonical.z,P.wrap,P.canonical.z,P.canonical.x,P.canonical.y));else if(this.tileCoverLift!==0){let P=t.clone();P.tileCoverLift=this.tileCoverLift,x=P.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:b,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:_}),this._source.minzoom<=1&&t.projection.name==="globe"&&(x.push(new n.aM(1,0,1,0,0)),x.push(new n.aM(1,0,1,1,0)),x.push(new n.aM(1,0,1,0,1)),x.push(new n.aM(1,0,1,1,1)))}else if(x=t.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:b,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:_}),this._source.hasTile){let P=this._source.hasTile.bind(this._source);x=x.filter(D=>P(D))}}else x=[];if(x.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!gc(this._source.type)){let P=t.coveringZoomLevel({tileSize:o||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),D=Math.min(P,this._source.maxzoom);if(_){let N=t.extendTileCover(x,D);for(let F of N)x.push(F)}else if(p){let N=t.extendTileCoverToNearPlane(x,this.transform.getFrustum(D),D);for(let F of N)x.push(F)}else if(this.castsShadows&&d){let N=t.extendTileCover(x,D,d);for(let F of N)this._shadowCasterTiles[F.key]=!0,x.push(F)}}let C=this._updateRetainedTiles(x);if(gc(this._source.type)&&x.length!==0){let P={},D={},N=Object.keys(C);for(let j of N){let U=C[j],Z=this._tiles[j];if(!Z||Z.fadeEndTime&&Z.fadeEndTime<=n.q.now())continue;let Y=this.findLoadedParent(U,Math.max(U.overscaledZ-jn.maxOverzooming,this._source.minzoom));Y&&(this._addTile(Y.tileID),P[Y.tileID.key]=Y.tileID),D[j]=U}let F=x[x.length-1].overscaledZ;for(let j in this._tiles){let U=this._tiles[j];if(C[j]||!U.hasData())continue;let Z=U.tileID;for(;Z.overscaledZ>F;){Z=Z.scaledTo(Z.overscaledZ-1);let Y=this._tiles[Z.key];if(Y&&Y.hasData()&&D[Z.key]){C[j]=U.tileID;break}}}for(let j in P)C[j]||(this._coveredTiles[j]=!0,C[j]=P[j])}for(let P in C)this._tiles[P].clearFadeHold();let z=n.bs(this._tiles,C);for(let P of z){let D=this._tiles[P];D.hasSymbolBuckets&&!D.holdingForFade()?D.setHoldDuration(this.map._fadeDuration):D.hasSymbolBuckets&&!D.symbolFadeFinished()||this._removeTile(+P)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){let o={};if(t.length===0)return o;let c={},d=t.reduce((M,C)=>Math.min(M,C.overscaledZ),1/0),p=t[0].overscaledZ,_=Math.max(p-jn.maxOverzooming,this._source.minzoom),x=Math.max(p+jn.maxUnderzooming,this._source.minzoom),b={};for(let M of t){let C=this._addTile(M);o[M.key]=M,C.hasData()||d<this._source.maxzoom&&(b[M.key]=M)}this._retainLoadedChildren(b,d,x,o);for(let M of t){let C=this._tiles[M.key];if(C.hasData())continue;if(M.canonical.z>=this._source.maxzoom){let P=M.children(this._source.maxzoom)[0],D=this.getTile(P);if(D&&D.hasData()){o[P.key]=P;continue}}else{let P=M.children(this._source.maxzoom);if(o[P[0].key]&&o[P[1].key]&&o[P[2].key]&&o[P[3].key])continue}let z=C.wasRequested();for(let P=M.overscaledZ-1;P>=_;--P){let D=M.scaledTo(P);if(c[D.key]||(c[D.key]=!0,C=this.getTile(D),!C&&z&&(C=this._addTile(D)),C&&(o[D.key]=D,z=C.wasRequested(),C.hasData())))break}}return o}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let t in this._tiles){let o=[],c,d=this._tiles[t].tileID;for(;d.overscaledZ>0;){if(d.key in this._loadedParentTiles){c=this._loadedParentTiles[d.key];break}o.push(d.key);let p=d.scaledTo(d.overscaledZ-1);if(c=this._getLoadedTile(p),c)break;d=p}for(let p of o)this._loadedParentTiles[p]=c}}_addTile(t){let o=this._tiles[t.key];if(o)return o.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),o;o=this._cache.getAndRemove(t),o&&(this._setTileReloadTimer(t.key,o),o.tileID=t,this._state.initializeTileState(o,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,o)));let c=!!o;if(!c){let d=this.map?this.map.painter:null,p=this._source.tileSize*t.overscaleFactor();o=this._source.type==="raster-array"?new el(t,p,this.transform.tileZoom,d,this._isRaster):new ba(t,p,this.transform.tileZoom,d,this._isRaster,this._source.worldview),this._loadTile(o,this._tileLoaded.bind(this,o,t.key,o.state))}return o.uses++,this._tiles[t.key]=o,c||this._source.fire(new n.A("dataloading",{tile:o,coord:o.tileID,dataType:"source"})),o}_setTileReloadTimer(t,o){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);let c=o.getExpiryTimeout();c&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},c))}_removeTile(t){let o=this._tiles[t];o&&(o.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),o.uses>0||(o.hasData()&&o.state!=="reloading"||o.state==="empty"?this._cache.add(o.tileID,o,o.getExpiryTimeout()):(o.aborted=!0,this._abortTile(o),this._unloadTile(o))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,o,c){let d=[],p=this.transform;if(!p)return d;let _=p.projection.name==="globe",x=n.aD(p.center.lng);for(let b in this._tiles){let M=this._tiles[b];if(c&&M.clearQueryDebugViz(),M.holdingForFade())continue;let C;if(_){let z=M.tileID.canonical;if(z.z===0){let P=[Math.abs(n.ay(x,...tl(z,-1))-x),Math.abs(n.ay(x,...tl(z,1))-x)];C=[0,2*P.indexOf(Math.min(...P))-1]}else{let P=[Math.abs(n.ay(x,...tl(z,-1))-x),Math.abs(n.ay(x,...tl(z,0))-x),Math.abs(n.ay(x,...tl(z,1))-x)];C=[P.indexOf(Math.min(...P))-1]}}else C=[0];for(let z of C){let P=t.containsTile(M,p,o,z);P&&d.push(P)}}return d}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,o){let c=this.getRenderableIds(t,o).map(p=>this._tiles[p].tileID),d=this.transform.projection.name==="globe";for(let p of c)p.projMatrix=this.transform.calculateProjMatrix(p.toUnwrapped()),p.expandedProjMatrix=d?this.transform.calculateProjMatrix(p.toUnwrapped(),!1,!0):p.projMatrix;return c}sortCoordinatesByDistance(t){let o=t.slice(),c=this.transform._camera.position,d=this.transform._camera.forward(),p={};for(let _ of o){let x=1/(1<<_.canonical.z);p[_.key]=((_.canonical.x+.5)*x+_.wrap-c[0])*d[0]+((_.canonical.y+.5)*x-c[1])*d[1]-c[2]*d[2]}return o.sort((_,x)=>p[_.key]-p[x.key]),o}hasTransition(){if(this._source.hasTransition())return!0;if(gc(this._source.type))for(let t in this._tiles){let o=this._tiles[t];if(o.fadeEndTime!==void 0&&o.fadeEndTime>=n.q.now())return!0}return!1}setFeatureState(t,o,c){this._state.updateState(t=t||"_geojsonTileLayer",o,c)}removeFeatureState(t,o,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",o,c)}getFeatureState(t,o){return this._state.getState(t=t||"_geojsonTileLayer",o)}setDependencies(t,o,c){let d=this._tiles[t];d&&d.setDependencies(o,c)}reloadTilesForDependencies(t,o){for(let c in this._tiles)this._tiles[c].hasDependency(t,o)&&this._reloadTile(+c,"reloading");this._cache.filter(c=>!c.hasDependency(t,o))}_preloadTiles(t,o){if(!this._sourceLoaded){let b=()=>{this._sourceLoaded&&(this._source.off("data",b),this._preloadTiles(t,o))};return void this._source.on("data",b)}let c=new Map,d=Array.isArray(t)?t:[t],p=this.map.painter.terrain,_=this.usedForTerrain&&p?p.getScaledDemTileSize():this._source.tileSize;for(let b of d){let M=b.coveringTiles({tileSize:_,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let C of M)c.set(C.key,C);this.usedForTerrain&&b.updateElevation(!1)}let x=Array.from(c.values());n.bt(x,(b,M)=>{let C=new ba(b,this._source.tileSize*b.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(C,z=>{this._source.type==="raster-dem"&&C.dem&&this._backfillDEM(C),M(z,C)})},o)}}function wa(l,t){let o=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-o||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function gc(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function tl(l,t){let o=1<<l.z;return[l.x/o+t,(l.x+1)/o+t]}jn.maxOverzooming=10,jn.maxUnderzooming=3;class Pf{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];let t=!1,o=!1;for(let c in this.style._mergedLayers){let d=this.style._mergedLayers[c];if(d.type==="fill-extrusion"||d.type==="building")this.layers.push({layer:d,visible:t,visibilityChanged:o});else if(d.type==="model"){let p=this.style.getLayerSource(d);p&&p.type==="batched-model"&&this.layers.push({layer:d,visible:t,visibilityChanged:o})}}}onNewFrame(t){this.layersGotHidden=!1;for(let o of this.layers){let c=o.layer,d=!1;c.type==="fill-extrusion"?d=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="building"?d=!c.isHidden(t)&&c.paint.get("building-opacity")>0:c.type==="model"&&(d=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!d&&o.visible,o.visible=d}}updateZOffset(t,o){this.currentBuildingBuckets=[];for(let d of this.layers){let p=d.layer,_=this.style.getLayerSourceCache(p),x=1;p.type==="fill-extrusion"?x=d.visible?p.paint.get("fill-extrusion-vertical-scale"):0:p.type==="building"&&(x=d.visible?p.paint.get("building-vertical-scale"):0);let b=_?_.getTile(o):null;if(!b&&_)for(let M in _._tiles){let C=_._tiles[M];if(o.canonical.isChildOf(C.tileID.canonical)){b=C;break}}this.currentBuildingBuckets.push({bucket:b?b.getBucket(p):null,tileID:b?b.tileID:o,verticalScale:x})}t.hasAnyZOffset=!1;let c=!1;for(let d=0;d<t.symbolInstances.length;d++){let p=t.symbolInstances.get(d),_=p.zOffset,x=this._getHeightAtTileOffset(o,p.tileAnchorX,p.tileAnchorY);p.zOffset=x!==Number.NEGATIVE_INFINITY?x:_,c||_===p.zOffset||(c=!0),t.hasAnyZOffset||p.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,o,c,d){let p=o,_=c;if(t.canonical.z!==d.canonical.z){let x=d.canonical,b=1/(1<<t.canonical.z-x.z);p=(o+t.canonical.x*n.aj)*b-x.x*n.aj|0,_=(c+t.canonical.y*n.aj)*b-x.y*n.aj|0}return{tileX:p,tileY:_}}_getHeightAtTileOffset(t,o,c){let d,p;for(let _=0;_<this.layers.length;++_){let x=this.layers[_].layer;if(x.type!=="fill-extrusion"&&x.type!=="building")continue;let{bucket:b,tileID:M,verticalScale:C}=this.currentBuildingBuckets[_];if(!b)continue;let{tileX:z,tileY:P}=this._mapCoordToOverlappingTile(t,o,c,M),D=b.getHeightAtTileCoord(z,P);D&&D.height!==void 0&&(D.hidden?d=D.height:p=Math.max(D.height*C,p||0))}if(p!==void 0)return p;for(let _=0;_<this.layers.length;++_){let x=this.layers[_];if(x.layer.type!=="model"||!x.visible)continue;let{bucket:b,tileID:M}=this.currentBuildingBuckets[_];if(!b)continue;let{tileX:C,tileY:z}=this._mapCoordToOverlappingTile(t,o,c,M),P=b.getHeightAtTileCoord(C,z);if(P&&!P.hidden)return P.height===void 0&&d!==void 0?Math.min(P.maxHeight,d)*P.verticalScale:P.height?P.height*P.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Rf(l,t){let o={};for(let c in l)c!=="ref"&&(o[c]=l[c]);return n.bu.forEach(c=>{c in t&&(o[c]=t[c])}),o}function yc(l){l=l.slice();let t=Object.create(null);for(let o=0;o<l.length;o++)t[l[o].id]=l[o];for(let o=0;o<l.length;o++)"ref"in l[o]&&(l[o]=Rf(l[o],t[l[o].ref]));return l}let wi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Mh(l,t,o){o.push({command:wi.addSource,args:[l,t[l]]})}function il(l,t,o){t.push({command:wi.removeSource,args:[l]}),o[l]=!0}function xc(l,t,o,c){il(l,o,c),Mh(l,t,o)}function ug(l,t,o){let c;for(c in l[o])if(l[o].hasOwnProperty(c)&&c!=="data"&&!n.bv(l[o][c],t[o][c]))return!1;for(c in t[o])if(t[o].hasOwnProperty(c)&&c!=="data"&&!n.bv(l[o][c],t[o][c]))return!1;return!0}function vc(l,t,o,c,d,p){let _;for(_ in t=t||{},l=l||{})l.hasOwnProperty(_)&&(n.bv(l[_],t[_])||o.push({command:p,args:[c,_,t[_],d]}));for(_ in t)t.hasOwnProperty(_)&&!l.hasOwnProperty(_)&&(n.bv(l[_],t[_])||o.push({command:p,args:[c,_,t[_],d]}))}function Ta(l){return l.id}function Gs(l,t){return l[t.id]=t,l}function bc(l,t,o){let c=t.createTileMatrix(l,l.worldSize,o.toUnwrapped());return n.az(new Float32Array(16),l.projMatrix,c)}function Lf(l,t,o){if(t.projection.name===o.projection.name)return l.projMatrix;let c=o.clone();return c.setProjection(t.projection),bc(c,t.getProjection(),l)}function Ch(l,t,o){return t.name===o.projection.name?l.projMatrix:bc(o,t,l)}class zf{constructor(t,o){this.reset(t,o)}reset(t,o){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(o||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=n.ay(t,0,1);let o=1,c=this._distances[o],d=t*this.paddedLength+this.padding;for(;c<d&&o<this._distances.length;)c=this._distances[++o];let p=o-1,_=this._distances[p],x=c-_,b=x>0?(d-_)/x:0;return this.points[p].mult(1-b).add(this.points[o].mult(b))}}class rl{constructor(t,o,c){let d=this.boxCells=[],p=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(o/c);for(let _=0;_<this.xCellCount*this.yCellCount;_++)d.push([]),p.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=o,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/o,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,o,c,d,p){this._forEachCell(o,c,d,p,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(o),this.bboxes.push(c),this.bboxes.push(d),this.bboxes.push(p)}insertCircle(t,o,c,d){this._forEachCell(o-d,c-d,o+d,c+d,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(o),this.circles.push(c),this.circles.push(d)}_insertBoxCell(t,o,c,d,p,_){this.boxCells[p].push(_)}_insertCircleCell(t,o,c,d,p,_){this.circleCells[p].push(_)}_query(t,o,c,d,p,_){if(c<0||t>this.width||d<0||o>this.height)return!p&&[];let x=[];if(t<=0&&o<=0&&this.width<=c&&this.height<=d){if(p)return!0;for(let b=0;b<this.boxKeys.length;b++)x.push({key:this.boxKeys[b],x1:this.bboxes[4*b],y1:this.bboxes[4*b+1],x2:this.bboxes[4*b+2],y2:this.bboxes[4*b+3]});for(let b=0;b<this.circleKeys.length;b++){let M=this.circles[3*b],C=this.circles[3*b+1],z=this.circles[3*b+2];x.push({key:this.circleKeys[b],x1:M-z,y1:C-z,x2:M+z,y2:C+z})}return _?x.filter(_):x}return this._forEachCell(t,o,c,d,this._queryCell,x,{hitTest:p,seenUids:{box:{},circle:{}}},_),p?x.length>0:x}_queryCircle(t,o,c,d,p){let _=t-c,x=t+c,b=o-c,M=o+c;if(x<0||_>this.width||M<0||b>this.height)return!d&&[];let C=[];return this._forEachCell(_,b,x,M,this._queryCellCircle,C,{hitTest:d,circle:{x:t,y:o,radius:c},seenUids:{box:{},circle:{}}},p),d?C.length>0:C}query(t,o,c,d,p){return this._query(t,o,c,d,!1,p)}hitTest(t,o,c,d,p){return this._query(t,o,c,d,!0,p)}hitTestCircle(t,o,c,d){return this._queryCircle(t,o,c,!0,d)}_queryCell(t,o,c,d,p,_,x,b){let M=x.seenUids,C=this.boxCells[p];if(C!==null){let P=this.bboxes;for(let D of C)if(!M.box[D]){M.box[D]=!0;let N=4*D;if(t<=P[N+2]&&o<=P[N+3]&&c>=P[N+0]&&d>=P[N+1]&&(!b||b(this.boxKeys[D]))){if(x.hitTest)return _.push(!0),!0;_.push({key:this.boxKeys[D],x1:P[N],y1:P[N+1],x2:P[N+2],y2:P[N+3]})}}}let z=this.circleCells[p];if(z!==null){let P=this.circles;for(let D of z)if(!M.circle[D]){M.circle[D]=!0;let N=3*D;if(this._circleAndRectCollide(P[N],P[N+1],P[N+2],t,o,c,d)&&(!b||b(this.circleKeys[D]))){if(x.hitTest)return _.push(!0),!0;{let F=P[N],j=P[N+1],U=P[N+2];_.push({key:this.circleKeys[D],x1:F-U,y1:j-U,x2:F+U,y2:j+U})}}}}}_queryCellCircle(t,o,c,d,p,_,x,b){let M=x.circle,C=x.seenUids,z=this.boxCells[p];if(z!==null){let D=this.bboxes;for(let N of z)if(!C.box[N]){C.box[N]=!0;let F=4*N;if(this._circleAndRectCollide(M.x,M.y,M.radius,D[F+0],D[F+1],D[F+2],D[F+3])&&(!b||b(this.boxKeys[N])))return _.push(!0),!0}}let P=this.circleCells[p];if(P!==null){let D=this.circles;for(let N of P)if(!C.circle[N]){C.circle[N]=!0;let F=3*N;if(this._circlesCollide(D[F],D[F+1],D[F+2],M.x,M.y,M.radius)&&(!b||b(this.circleKeys[N])))return _.push(!0),!0}}}_forEachCell(t,o,c,d,p,_,x,b){let M=this._convertToXCellCoord(t),C=this._convertToYCellCoord(o),z=this._convertToXCellCoord(c),P=this._convertToYCellCoord(d);for(let D=M;D<=z;D++)for(let N=C;N<=P;N++)if(p.call(this,t,o,c,d,this.xCellCount*N+D,_,x,b))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,o,c,d,p,_){let x=d-t,b=p-o,M=c+_;return M*M>x*x+b*b}_circleAndRectCollide(t,o,c,d,p,_,x){let b=(_-d)/2,M=Math.abs(t-(d+b));if(M>b+c)return!1;let C=(x-p)/2,z=Math.abs(o-(p+C));if(z>C+c)return!1;if(M<=b||z<=C)return!0;let P=M-b,D=z-C;return P*P+D*D<=c*c}}let Sa={unknown:0,flipRequired:1,flipNotRequired:2},Df=Math.tan(85*Math.PI/180);function wc(l,t,o,c,d,p,_){let x=n.bz();if(o)if(p.name==="globe"){let b=n.bA(d,t);n.az(x,x,b)}else{let b=n.bB([],_);x[0]=b[0],x[1]=b[1],x[4]=b[2],x[5]=b[3],c||n.by(x,x,d.angle)}else n.az(x,d.labelPlaneMatrix,l);return x}function nl(l,t,o,c,d,p,_){let x=wc(l,t,o,c,d,p,_);return p.name==="globe"&&o||(x[2]=x[6]=x[10]=x[14]=0),x}function As(l,t,o,c,d,p,_){if(o){if(p.name==="globe"){let x=wc(l,t,o,c,d,p,_);return n.bi(x,x),n.az(x,l,x),x}{let x=n.bw(l),b=n.bx([]);return b[0]=_[0],b[1]=_[1],b[4]=_[2],b[5]=_[3],n.az(x,x,b),c||n.by(x,x,-d.angle),x}}return d.glCoordMatrix}function mo(l,t,o,c){let d=[l,t,o,1];o?n.aA(d,d,c):Of(d,d,c);let p=d[3];return d[0]/=p,d[1]/=p,d[2]/=p,d}function ud(l,t){return Math.min(.5+l/t*.5,1.5)}function dd(l,t){let o=l[0]/l[3],c=l[1]/l[3];return o>=-t[0]&&o<=t[0]&&c>=-t[1]&&c<=t[1]}function Ea(l,t,o,c,d,p,_,x,b,M){let C=o.transform,z=c?l.textSizeData:l.iconSizeData,P=n.bH(z,o.transform.zoom),D=C.projection.name==="globe",N=[256/o.width*2+1,256/o.height*2+1],F=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;F.clear();let j=null;D&&(j=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);let U=l.lineVertexArray,Z=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,Y=o.transform.width/o.transform.height,Q,ne=!1;for(let he=0;he<Z.length;he++){let de=Z.get(he),{numGlyphs:oe,writingMode:se}=de;if(se!==n.bI.vertical||ne||Q===n.bI.horizontal||(ne=!0),Q=se,(de.hidden||se===n.bI.vertical)&&!ne){ol(oe,F);continue}ne=!1;let le=new n.P(de.tileAnchorX,de.tileAnchorY),{x:Me,y:_e,z:Ve}=C.projection.projectTilePoint(le.x,le.y,M.canonical);if(b){let[Mt,Ot,yt]=b(le);Me+=Mt,_e+=Ot,Ve+=yt}let ze=[Me,_e,Ve,1];if(n.aA(ze,ze,t),!dd(ze,N)){ol(oe,F);continue}let je=ze[3],rt=ud(o.transform.getCameraToCenterDistance(C.projection),je),Ce=n.bJ(z,P,de),me=_?Ce/rt:Ce*rt,ke=mo(Me,_e,Ve,d);if(ke[3]<=0){ol(oe,F);continue}let Pe={},$e=n.al(l.layers[0].layout.get("text-max-angle")),Ze=Math.cos($e),Ye=_?null:b,ct=Ph(de,me,!1,x,t,d,p,l.glyphOffsetArray,U,F,j,ke,le,Pe,Y,Ye,C.projection,M,_,Ze);ne=ct.useVertical,Ye&&ct.needsFlipping&&(Pe={}),(ct.notEnoughRoom||ne||ct.needsFlipping&&Ph(de,me,!0,x,t,d,p,l.glyphOffsetArray,U,F,j,ke,le,Pe,Y,Ye,C.projection,M,_,Ze).notEnoughRoom)&&ol(oe,F)}c?(l.text.dynamicLayoutVertexBuffer.updateData(F),j&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(j)):(l.icon.dynamicLayoutVertexBuffer.updateData(F),j&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(j))}function Kn(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j){let{lineStartIndex:U,glyphStartIndex:Z,segment:Y}=x,Q=Z+x.numGlyphs,ne=U+x.lineLength,he=t.getoffsetX(Z),de=t.getoffsetX(Q-1),oe=Tc(l*he,o,c,d,p,_,Y,U,ne,b,M,C,z,P,!0,D,N,F,j);if(!oe)return null;let se=Tc(l*de,o,c,d,p,_,Y,U,ne,b,M,C,z,P,!0,D,N,F,j);return se?{first:oe,last:se}:null}function pd(l,t,o,c){return l===n.bI.horizontal&&Math.abs(c)>Math.abs(o)?{useVertical:!0}:l===n.bI.vertical?c>0?{needsFlipping:!0}:null:t!==Sa.unknown&&function(d,p){return d===0||Math.abs(p/d)>Df}(o,c)?t===Sa.flipRequired?{needsFlipping:!0}:null:o<0?{needsFlipping:!0}:null}function Ph(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y){let Q=t/24,ne=l.lineOffsetX*Q,he=l.lineOffsetY*Q,{lineStartIndex:de,glyphStartIndex:oe,numGlyphs:se,segment:le,writingMode:Me,flipState:_e}=l,Ve=de+l.lineLength,ze=je=>{if(C){let[ke,Pe,$e]=je.up,Ze=M.length;n.bK(C,Ze+0,ke,Pe,$e),n.bK(C,Ze+1,ke,Pe,$e),n.bK(C,Ze+2,ke,Pe,$e),n.bK(C,Ze+3,ke,Pe,$e)}let[rt,Ce,me]=je.point;n.bL(M,rt,Ce,me,je.angle)};if(se>1){let je=Kn(Q,x,ne,he,o,z,P,l,b,p,D,F,!1,j,U,Z,Y);if(!je)return{notEnoughRoom:!0};if(c&&!o){let[rt,Ce,me]=je.first.point,[ke,Pe,$e]=je.last.point;[rt,Ce]=mo(rt,Ce,me,_),[ke,Pe]=mo(ke,Pe,$e,_);let Ze=pd(Me,_e,(ke-rt)*N,Pe-Ce);if(l.flipState=Ze&&Ze.needsFlipping?Sa.flipRequired:Sa.flipNotRequired,Ze)return Ze}ze(je.first);for(let rt=oe+1;rt<oe+se-1;rt++){let Ce=Tc(Q*x.getoffsetX(rt),ne,he,o,z,P,le,de,Ve,b,p,D,F,!1,!1,j,U,Z,Y);if(!Ce)return M.length-=4*(rt-oe),{notEnoughRoom:!0};ze(Ce)}ze(je.last)}else{if(c&&!o){let rt=mo(P.x,P.y,0,d),Ce=de+le+1,me=new n.P(b.getx(Ce),b.gety(Ce)),ke=mo(me.x,me.y,0,d),Pe=ke[3]>0?ke:ki(P,me,rt,1,d,void 0,j,U.canonical),$e=pd(Me,_e,(Pe[0]-rt[0])*N,Pe[1]-rt[1]);if(l.flipState=$e&&$e.needsFlipping?Sa.flipRequired:Sa.flipNotRequired,$e)return $e}let je=Tc(Q*x.getoffsetX(oe),ne,he,o,z,P,le,de,Ve,b,p,D,F,!1,!1,j,U,Z,Y);if(!je)return{notEnoughRoom:!0};ze(je)}return{}}function fd(l,t,o,c,d){let{x:p,y:_,z:x}=c.projectTilePoint(l.x,l.y,t);if(!d)return mo(p,_,x,o);let[b,M,C]=d(l);return mo(p+b,_+M,x+C,o)}function ki(l,t,o,c,d,p,_,x){let b=fd(l.sub(t)._unit()._add(l),x,d,_,p);return n.at(b,o,b),n.au(b,b),n.bE(b,o,b,c)}function Tc(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z){let Y=c?l-t:l+t,Q=Y>0?1:-1,ne=0;c&&(Q*=-1,ne=Math.PI),Q<0&&(ne+=Math.PI);let he=x+_+(Q>0?0:1)|0,de=d,oe=d,se=0,le=0,Me=Math.abs(Y),_e=[],Ve=[],ze=p,je=ze,rt=n.bC([]),Ce=()=>ki(je,ze,oe,Me-se+1,C,P,F,j.canonical);for(;se+le<=Me;){if(he+=Q,he<x||he>=b)return null;if(oe=de,je=ze,_e.push(oe),D&&Ve.push(je),ze=new n.P(M.getx(he),M.gety(he)),de=z[he],!de){let yt=fd(ze,j.canonical,C,F,P);de=yt[3]>0?z[he]=yt:Ce()}se+=le;let Mt=n.at([],de,oe),Ot=n.bD(oe,de);if(o&&Ot>0&&le>0&&n.bG(rt,Mt)/(le*Ot)<Z)return null;le=Ot,rt=Mt}N&&P&&(z[he]&&(de=Ce(),le=n.bD(oe,de),rt=n.at([],de,oe)),z[he]=de);let me=(Me-se)/le,ke=ze.sub(je)._mult(me)._add(je),Pe=n.bE([],oe,rt,me),$e=[0,0,1],Ze=rt[0],Ye=rt[1];if(U&&($e=F.upVector(j.canonical,ke.x,ke.y),$e[0]!==0||$e[1]!==0||$e[2]!==1)){let Mt=[$e[2],0,-$e[0]],Ot=n.bF([],$e,Mt);n.au(Mt,Mt),n.au(Ot,Ot),Ze=n.bG(rt,Mt),Ye=n.bG(rt,Ot)}if(o){let Mt=n.bF([],$e,rt);n.au(Mt,Mt),n.bE(Pe,Pe,Mt,o*Q)}let ct=ne+Math.atan2(Ye,Ze);return _e.push(Pe),D&&Ve.push(ke),{point:Pe,angle:ct,path:_e,tilePath:Ve,up:$e}}function ol(l,t){let o=t.length,c=o+4*l;t.resize(c),t.float32.fill(-1/0,4*o,4*c)}function Of(l,t,o){let c=t[0],d=t[1];return l[0]=o[0]*c+o[4]*d+o[12],l[1]=o[1]*c+o[5]*d+o[13],l[3]=o[3]*c+o[7]*d+o[15],l}let Bt=100;class kf{constructor(t,o,c=new rl(t.width+200,t.height+200,25),d=new rl(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=d,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Bt,this.screenBottomBoundary=t.height+Bt,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=o}placeCollisionBox(t,o,c,d,p,_,x,b,M,C,z){let P=c.projectedAnchorX,D=c.projectedAnchorY,N=c.projectedAnchorZ,F=c.tileAnchorX,j=c.tileAnchorY,U=c.elevation,Z=c.tileID,Y=t.getProjection();if(U&&Z){let[Ve,ze,je]=Y.upVector(Z.canonical,c.tileAnchorX,c.tileAnchorY),rt=Y.upVectorScale(Z.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;P+=Ve*U*rt,D+=ze*U*rt,N+=je*U*rt}let Q=t.projection.name==="globe",ne=t.projection.name==="globe"?n.ah(this.transform.zoom):0;if(Z&&Q&&ne<1&&!_){let Ve=1<<Z.canonical.z,ze=n.bM(F,j);n.bN(ze,ze,1/n.aj),n.bO(ze,ze,n.bM(Z.canonical.x,Z.canonical.y)),n.bN(ze,ze,1/Ve),n.bP(ze,ze,n.bM(d[0],d[1])),ze[0]=n.bQ(ze[0],-.5,.5),n.bN(ze,ze,n.aj);let je=n.bR(ze[0],ze[1],n.aj/(2*Math.PI),1);n.aA(je,je,p),P=n.ai(P,je[0],ne),D=n.ai(D,je[1],ne),N=n.ai(N,je[2],ne)}let he=this.projectAndGetPerspectiveRatio(C,P,D,N,c.tileID,Y.name==="globe"||!!U||this.transform.pitch>0,Y),de=M*he.perspectiveRatio,oe=(c.x1*o+x.x-c.padding)*de+he.point.x,se=(c.y1*o+x.y-c.padding)*de+he.point.y,le=(c.x2*o+x.x+c.padding)*de+he.point.x,Me=(c.y2*o+x.y+c.padding)*de+he.point.y,_e=he.perspectiveRatio<=.55||he.occluded;return!this.isInsideGrid(oe,se,le,Me)||!b&&this.grid.hitTest(oe,se,le,Me,z)||_e?{box:[],offscreen:!1,occluded:he.occluded}:{box:[oe,se,le,Me],offscreen:this.isOffscreen(oe,se,le,Me),occluded:!1}}placeCollisionCircles(t,o,c,d,p,_,x,b,M,C,z,P,D,N,F){let j=[],U=this.transform.elevation,Z=t.getProjection(),Y=U?U.getAtTileOffsetFunc(F,this.transform.center.lat,this.transform.worldSize,Z):null,Q=new n.P(c.tileAnchorX,c.tileAnchorY),{x:ne,y:he,z:de}=Z.projectTilePoint(Q.x,Q.y,F.canonical);if(Y){let[$e,Ze,Ye]=Y(Q);ne+=$e,he+=Ze,de+=Ye}let oe=Z.name==="globe",se=this.projectAndGetPerspectiveRatio(x,ne,he,de,F,oe||!!U||this.transform.pitch>0,Z),{perspectiveRatio:le}=se,Me=(z?_/le:_*le)/n.bU,_e=mo(ne,he,de,b),Ve=c.lineOffsetX*Me,ze=c.lineOffsetY*Me,je=n.al(t.layers[0].layout.get("text-max-angle")),rt=Math.cos(je),Ce=se.signedDistanceFromCamera>0?Kn(Me,p,Ve,ze,!1,_e,Q,c,d,b,{},U&&!z?Y:null,z&&!!U,Z,F,z,rt):null,me=!1,ke=!1,Pe=!0;if(Ce&&!se.occluded){let $e=.5*D*le+N,Ze=new n.P(-100,-100),Ye=new n.P(this.screenRightBoundary,this.screenBottomBoundary),ct=new zf,{first:Mt,last:Ot}=Ce,yt=Mt.path.length,zt=[];for(let Jt=yt-1;Jt>=1;Jt--)zt.push(Mt.path[Jt]);for(let Jt=1;Jt<Ot.path.length;Jt++)zt.push(Ot.path[Jt]);let Rt=2.5*$e;M&&(zt=zt.map(([Jt,ai,Ti],Yt)=>(Y&&!oe&&(Ti=Y(Yt<yt-1?Mt.tilePath[yt-1-Yt]:Ot.tilePath[Yt-yt+2])[2]),mo(Jt,ai,Ti,M))),zt.some(Jt=>Jt[3]<=0)&&(zt=[]));let $t=[];if(zt.length>0){let Jt=1/0,ai=-1/0,Ti=1/0,Yt=-1/0;for(let Si of zt)Jt=Math.min(Jt,Si[0]),Ti=Math.min(Ti,Si[1]),ai=Math.max(ai,Si[0]),Yt=Math.max(Yt,Si[1]);ai>=Ze.x&&Jt<=Ye.x&&Yt>=Ze.y&&Ti<=Ye.y&&($t=[zt.map(Si=>new n.P(Si[0],Si[1]))],(Jt<Ze.x||ai>Ye.x||Ti<Ze.y||Yt>Ye.y)&&($t=n.bS($t,Ze.x,Ze.y,Ye.x,Ye.y)))}for(let Jt of $t){ct.reset(Jt,.25*$e);let ai=0;ai=ct.length<=.5*$e?1:Math.ceil(ct.paddedLength/Rt)+1;for(let Ti=0;Ti<ai;Ti++){let Yt=Ti/Math.max(ai-1,1),Si=ct.lerp(Yt),Mi=Si.x+Bt,Wi=Si.y+Bt;j.push(Mi,Wi,$e,0);let ni=Mi-$e,Ei=Wi-$e,Ii=Mi+$e,Ri=Wi+$e;if(Pe=Pe&&this.isOffscreen(ni,Ei,Ii,Ri),ke=ke||this.isInsideGrid(ni,Ei,Ii,Ri),!o&&this.grid.hitTestCircle(Mi,Wi,$e,P)&&(me=!0,!C))return{circles:[],offscreen:!1,collisionDetected:me,occluded:!1}}}}return{circles:!C&&me||!ke?[]:j,offscreen:Pe,collisionDetected:me,occluded:se.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let o=[],c=1/0,d=1/0,p=-1/0,_=-1/0;for(let C of t){let z=new n.P(C.x+Bt,C.y+Bt);c=Math.min(c,z.x),d=Math.min(d,z.y),p=Math.max(p,z.x),_=Math.max(_,z.y),o.push(z)}let x=this.grid.query(c,d,p,_).concat(this.ignoredGrid.query(c,d,p,_)),b={},M={};for(let C of x){let z=C.key;if(b[z.bucketInstanceId]===void 0&&(b[z.bucketInstanceId]={}),b[z.bucketInstanceId][z.featureIndex])continue;let P=[new n.P(C.x1,C.y1),new n.P(C.x2,C.y1),new n.P(C.x2,C.y2),new n.P(C.x1,C.y2)];n.bT(o,P)&&(b[z.bucketInstanceId][z.featureIndex]=!0,M[z.bucketInstanceId]===void 0&&(M[z.bucketInstanceId]=[]),M[z.bucketInstanceId].push(z.featureIndex))}return M}insertCollisionBox(t,o,c,d,p){(o?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:d,collisionGroupID:p},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,o,c,d,p){let _=o?this.ignoredGrid:this.grid,x={bucketInstanceId:c,featureIndex:d,collisionGroupID:p};for(let b=0;b<t.length;b+=4)_.insertCircle(x,t[b],t[b+1],t[b+2])}projectAndGetPerspectiveRatio(t,o,c,d,p,_,x){let b=[o,c,d,1],M=!1;d||this.transform.pitch>0?(n.aA(b,b,t),this.fogState&&p&&x.name!=="globe"&&(M=function(P,D,N,F,j,U){let Z=U.calculateFogTileMatrix(j),Y=[D,N,F];return n.ad(Y,Y,Z),kt(P,n.ae(Y),U.pitch,U._fov)}(this.fogState,o,c,d,p.toUnwrapped(),this.transform)>.9)):Of(b,b,t);let C=b[3];return{point:new n.P((b[0]/C+1)/2*this.transform.width+Bt,(-b[1]/C+1)/2*this.transform.height+Bt),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(x)/C*.5,1.5),signedDistanceFromCamera:C,occluded:_&&b[2]>C||M}}isOffscreen(t,o,c,d){return c<Bt||t>=this.screenRightBoundary||d<Bt||o>this.screenBottomBoundary}isInsideGrid(t,o,c,d){return c>=0&&t<this.gridRightBoundary&&d>=0&&o<this.gridBottomBoundary}getViewportMatrix(){let t=n.bx([]);return n.bo(t,t,[-100,-100,0]),t}}class Sc{constructor(t,o,c,d){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?o:-o))):d&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Ia{constructor(t,o,c,d,p,_=!1){this.text=new Sc(t?t.text:null,o,c,p),this.icon=new Sc(t?t.icon:null,o,d,p),this.clipped=_}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class _o{constructor(t,o,c,d=!1){this.text=t,this.icon=o,this.skipFade=c,this.clipped=d}}class md{constructor(){this.invProjMatrix=n.bz(),this.viewportMatrix=n.bz(),this.circles=[]}}class sl{constructor(t,o,c,d,p){this.bucketInstanceId=t,this.featureIndex=o,this.sourceLayerIndex=c,this.bucketIndex=d,this.tileID=p}}class Dt{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){let o=++this.maxGroupID;this.collisionGroups[t]={ID:o,predicate:c=>c.collisionGroupID===o}}return this.collisionGroups[t]}}function zi(l,t,o,c,d){let{horizontalAlign:p,verticalAlign:_}=n.bZ(l),x=-(p-.5)*t,b=-(_-.5)*o,M=n.b_(l,c);return new n.P(x+M[0]*d,b+M[1]*d)}function Di(l,t,o,c,d){let p=new n.P(l,t);return o&&p._rotate(c?d:-d),p}class Jn{constructor(t,o,c,d,p,_){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new kf(this.transform,p),this.buildingIndex=_,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=o,this.retainedQueryData={},this.collisionGroups=new Dt(c),this.collisionCircleArrays={},this.prevPlacement=d,d&&(d.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,o,c,d,p=1){let _=c.getBucket(o),x=c.latestFeatureIndex;if(!_||!x||o.fqid!==_.layerIds[0])return;let b=_.layers[0].layout,M=_.layers[0].paint,C=c.collisionBoxArray,z=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),P=c.tileSize/n.aj,D=c.tileID.toUnwrapped();this.transform.setProjection(_.projection);let N=(F=c.tileID,j=_.getProjection(),U=this.transform,j.name===this.projection?U.calculateProjMatrix(F.toUnwrapped()):bc(U,j,F));var F,j,U;let Z=b.get("text-pitch-alignment")==="map",Y=b.get("text-rotation-alignment")==="map";o.compileFilter(o.options);let Q=o.dynamicFilter(),ne=o.dynamicFilterNeedsFeature(),he=this.transform.calculatePixelsToTileUnitsMatrix(c),de=nl(N,c.tileID.canonical,Z,Y,this.transform,_.getProjection(),he),oe=null,se=_.getProjection().createInversionMatrix(this.transform,c.tileID.canonical);if(Z){let me=As(N,c.tileID.canonical,Z,Y,this.transform,_.getProjection(),he);oe=n.az([],this.transform.labelPlaneMatrix,me)}let le=null;Q&&c.latestFeatureIndex&&(le={unwrappedTileID:D,dynamicFilter:Q,dynamicFilterNeedsFeature:ne}),this.retainedQueryData[_.bucketInstanceId]=new sl(_.bucketInstanceId,x,_.sourceLayerIndex,_.index,c.tileID);let[Me,_e]=_.layers[0].layout.get("text-size-scale-range"),Ve=n.ay(p,Me,_e),[ze,je]=b.get("icon-size-scale-range"),rt=n.ay(p,ze,je),Ce={bucket:_,layout:b,paint:M,posMatrix:N,invMatrix:se,mercatorCenter:[n.aD(this.transform.center.lng),n.aH(this.transform.center.lat)],textLabelPlaneMatrix:de,labelToScreenMatrix:oe,clippingData:le,scale:z,textPixelRatio:P,holdingForFade:c.holdingForFade(),collisionBoxArray:C,partiallyEvaluatedTextSize:n.bH(_.textSizeData,this.transform.zoom,Ve),partiallyEvaluatedIconSize:n.bH(_.iconSizeData,this.transform.zoom,rt),collisionGroup:this.collisionGroups.get(_.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(d)for(let me of _.sortKeyRanges){let{sortKey:ke,symbolInstanceStart:Pe,symbolInstanceEnd:$e}=me;t.push({sortKey:ke,symbolInstanceStart:Pe,symbolInstanceEnd:$e,parameters:Ce})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:_.symbolInstances.length,parameters:Ce})}attemptAnchorPlacement(t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y,Q,ne){let{textOffset0:he,textOffset1:de,crossTileID:oe}=F,se=[he,de],le=zi(t,_,x,se,b),Me=this.collisionIndex.placeCollisionBox(U,b,o,c,d,p,Di(le.x,le.y,M,C,this.transform.angle),N,z,P,D.predicate);if(Y){let _e=U.getSymbolInstanceIconSize(ne,this.transform.zoom,F.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(U,_e,Y,c,d,p,Di(le.x,le.y,M,C,this.transform.angle),N,z,P,D.predicate).box.length===0)return}if(Me.box.length>0){let _e;return this.prevPlacement&&this.prevPlacement.variableOffsets[oe]&&this.prevPlacement.placements[oe]&&this.prevPlacement.placements[oe].text&&(_e=this.prevPlacement.variableOffsets[oe].anchor),this.variableOffsets[oe]={textOffset:se,width:_,height:x,anchor:t,textScale:b,prevAnchor:_e},this.markUsedJustification(U,t,F,Z),U.allowVerticalPlacement&&(this.markUsedOrientation(U,Z,F),this.placedOrientations[oe]=Z),{shift:le,placedGlyphBoxes:Me}}}placeLayerBucketPart(t,o,c,d,p=1){let{bucket:_,layout:x,paint:b,posMatrix:M,textLabelPlaneMatrix:C,labelToScreenMatrix:z,clippingData:P,textPixelRatio:D,mercatorCenter:N,invMatrix:F,holdingForFade:j,collisionBoxArray:U,partiallyEvaluatedTextSize:Z,partiallyEvaluatedIconSize:Y,collisionGroup:Q,latestFeatureIndex:ne}=t.parameters,he=x.get("text-optional"),de=x.get("icon-optional"),oe=x.get("text-allow-overlap"),se=x.get("icon-allow-overlap"),le=x.get("text-rotation-alignment")==="map",Me=x.get("icon-rotation-alignment")==="map",_e=x.get("text-pitch-alignment")==="map",Ve=b.get("symbol-z-offset"),ze=x.get("symbol-elevation-reference")==="sea",je=x.get("symbol-placement"),[rt,Ce]=x.get("text-size-scale-range"),[me,ke]=x.get("icon-size-scale-range"),Pe=n.ay(p,rt,Ce),$e=n.ay(p,me,ke),Ze=x.get("text-variable-anchor"),Ye=le&&je!=="point",ct=Me&&je!=="point",Mt=Ze&&_.hasTextData(),Ot=_.hasIconTextFit()&&Mt&&_.hasIconData();this.transform.setProjection(_.projection);let yt=Mt||Ye,zt=ct||Ot,Rt=oe&&(se||!_.hasIconData()||de),$t=se&&(oe||!_.hasTextData()||he),Jt=!Ve.isConstant();!_.collisionArrays&&U&&_.deserializeCollisionBoxes(U),c&&d&&_.updateCollisionDebugBuffers(this.transform.zoom,U,Pe,$e);let ai=(Yt,Si,Mi)=>{let{crossTileID:Wi,numVerticalGlyphVertices:ni}=Yt,Ei=null;if(P&&P.dynamicFilterNeedsFeature||Jt){let Cr=this.retainedQueryData[_.bucketInstanceId];Ei=ne.loadFeature({featureIndex:Yt.featureIndex,bucketIndex:Cr.bucketIndex,sourceLayerIndex:Cr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(P&&!(0,P.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Ei,this.retainedQueryData[_.bucketInstanceId].tileID.canonical,new n.P(Yt.tileAnchorX,Yt.tileAnchorY),this.transform.calculateDistanceTileData(P.unwrappedTileID)))return this.placements[Wi]=new _o(!1,!1,!1,!0),void o.add(Wi);let Ii=Ve.evaluate(Ei,{});if(o.has(Wi))return;if(j)return void(this.placements[Wi]=new _o(!1,!1,!1));let Ri=!1,li=!1,Vi=!0,Ci=!1,yr=!1,bi=null,Li={box:null,offscreen:null,occluded:null},$i={box:null},kr=null,Dr=null,Br=null,hn=0,Jo=0,kn=0;Mi.textFeatureIndex?hn=Mi.textFeatureIndex:Yt.useRuntimeCollisionCircles&&(hn=Yt.featureIndex),Mi.verticalTextFeatureIndex&&(Jo=Mi.verticalTextFeatureIndex);let eo=Cr=>{Cr.tileID=this.retainedQueryData[_.bucketInstanceId].tileID;let Sr=this.transform.elevation;Cr.elevation=ze?Ii:Ii+(Sr?Sr.getAtTileOffset(Cr.tileID,Cr.tileAnchorX,Cr.tileAnchorY):0),Cr.elevation+=Yt.zOffset},yn=Mi.textBox;if(yn){eo(yn);let Cr=Ki=>{let Wr=n.bI.horizontal;if(_.allowVerticalPlacement&&!Ki&&this.prevPlacement){let un=this.prevPlacement.placedOrientations[Wi];un&&(this.placedOrientations[Wi]=un,Wr=un,this.markUsedOrientation(_,Wr,Yt))}return Wr},Sr=(Ki,Wr)=>{if(_.allowVerticalPlacement&&ni>0&&Mi.verticalTextBox){for(let un of _.writingModes)if(un===n.bI.vertical?(Li=Wr(),$i=Li):Li=Ki(),Li&&Li.box&&Li.box.length)break}else Li=Ki()};if(Ze){let Ki=Ze;if(this.prevPlacement&&this.prevPlacement.variableOffsets[Wi]){let Pr=this.prevPlacement.variableOffsets[Wi];Ki.indexOf(Pr.anchor)>0&&(Ki=Ki.filter(wo=>wo!==Pr.anchor),Ki.unshift(Pr.anchor))}let Wr=(Pr,wo,Na)=>{let la=_.getSymbolInstanceTextSize(Z,Yt,this.transform.zoom,Si),Ol=(Pr.x2-Pr.x1)*la+2*Pr.padding,kl=(Pr.y2-Pr.y1)*la+2*Pr.padding,To=Yt.hasIconTextFit&&!se?wo:null;To&&eo(To);let us={box:[],offscreen:!1,occluded:!1},Xr=oe?2*Ki.length:Ki.length;for(let So=0;So<Xr;++So){let Va=this.attemptAnchorPlacement(Ki[So%Ki.length],Pr,N,F,yt,Ol,kl,la,le,_e,D,M,Q,So>=Ki.length,Yt,Si,_,Na,To,Z,Y);if(Va&&(us=Va.placedGlyphBoxes,us&&us.box&&us.box.length)){Ri=!0,bi=Va.shift;break}}return us};Sr(()=>Wr(yn,Mi.iconBox,n.bI.horizontal),()=>{let Pr=Mi.verticalTextBox;return Pr&&eo(Pr),_.allowVerticalPlacement&&!(Li&&Li.box&&Li.box.length)&&ni>0&&Pr?Wr(Pr,Mi.verticalIconBox,n.bI.vertical):{box:null,offscreen:null,occluded:null}}),Li&&(Ri=Li.box,Vi=Li.offscreen,Ci=Li.occluded);let un=Cr(!(!Li||!Li.box));if(!Ri&&this.prevPlacement){let Pr=this.prevPlacement.variableOffsets[Wi];Pr&&(this.variableOffsets[Wi]=Pr,this.markUsedJustification(_,Pr.anchor,Yt,un))}}else{let Ki=(Wr,un)=>{let Pr=_.getSymbolInstanceTextSize(Z,Yt,this.transform.zoom,Si,p),wo=this.collisionIndex.placeCollisionBox(_,Pr,Wr,N,F,yt,new n.P(0,0),oe,D,M,Q.predicate);return wo&&wo.box&&wo.box.length&&(this.markUsedOrientation(_,un,Yt),this.placedOrientations[Wi]=un),wo};Sr(()=>Ki(yn,n.bI.horizontal),()=>{let Wr=Mi.verticalTextBox;return _.allowVerticalPlacement&&ni>0&&Wr?(eo(Wr),Ki(Wr,n.bI.vertical)):{box:null,offscreen:null,occluded:null}}),Cr(!!(Li&&Li.box&&Li.box.length))}}if(kr=Li,Ri=kr&&kr.box&&kr.box.length>0,Vi=kr&&kr.offscreen,Ci=kr&&kr.occluded,Yt.useRuntimeCollisionCircles){let Cr=_.text.placedSymbolArray.get(Yt.centerJustifiedTextSymbolIndex>=0?Yt.centerJustifiedTextSymbolIndex:Yt.verticalPlacedTextSymbolIndex),Sr=n.bJ(_.textSizeData,Z,Cr),Ki=x.get("text-padding");Dr=this.collisionIndex.placeCollisionCircles(_,oe,Cr,_.lineVertexArray,_.glyphOffsetArray,Sr,M,C,z,c,_e,Q.predicate,Yt.collisionCircleDiameter*Sr/n.bU,Ki,this.retainedQueryData[_.bucketInstanceId].tileID),Ri=oe||Dr.circles.length>0&&!Dr.collisionDetected,Vi=Vi&&Dr.offscreen,Ci=Dr.occluded}if(Mi.iconFeatureIndex&&(kn=Mi.iconFeatureIndex),Mi.iconBox){let Cr=Sr=>{eo(Sr);let Ki=Yt.hasIconTextFit&&bi?Di(bi.x,bi.y,le,_e,this.transform.angle):new n.P(0,0),Wr=_.getSymbolInstanceIconSize(Y,this.transform.zoom,Yt.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(_,Wr,Sr,N,F,zt,Ki,se,D,M,Q.predicate)};$i&&$i.box&&$i.box.length&&Mi.verticalIconBox?(Br=Cr(Mi.verticalIconBox),li=Br.box.length>0):(Br=Cr(Mi.iconBox),li=Br.box.length>0),Vi=Vi&&Br.offscreen,yr=Br.occluded}let bo=he||Yt.numHorizontalGlyphVertices===0&&ni===0,Vo=de||Yt.numIconVertices===0;if(bo||Vo?Vo?bo||(li=li&&Ri):Ri=li&&Ri:li=Ri=li&&Ri,Ri&&kr&&kr.box&&this.collisionIndex.insertCollisionBox(kr.box,x.get("text-ignore-placement"),_.bucketInstanceId,$i&&$i.box&&Jo?Jo:hn,Q.ID),li&&Br&&this.collisionIndex.insertCollisionBox(Br.box,x.get("icon-ignore-placement"),_.bucketInstanceId,kn,Q.ID),Dr&&(Ri&&this.collisionIndex.insertCollisionCircles(Dr.circles,x.get("text-ignore-placement"),_.bucketInstanceId,hn,Q.ID),c)){let Cr=_.bucketInstanceId,Sr=this.collisionCircleArrays[Cr];Sr===void 0&&(Sr=this.collisionCircleArrays[Cr]=new md);for(let Ki=0;Ki<Dr.circles.length;Ki+=4)Sr.circles.push(Dr.circles[Ki+0]),Sr.circles.push(Dr.circles[Ki+1]),Sr.circles.push(Dr.circles[Ki+2]),Sr.circles.push(Dr.collisionDetected?1:0)}let xn=_.projection.name!=="globe";Rt=Rt&&(xn||!Ci),$t=$t&&(xn||!yr),this.placements[Wi]=new _o(Ri||Rt,li||$t,Vi||_.justReloaded),o.add(Wi)},Ti=this.retainedQueryData[_.bucketInstanceId].tileID;if(_.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(_,Ti),_.elevationType==="road"&&_.updateRoadElevation(Ti.canonical),_.updateZOffset(),_.sortFeaturesByY){let Yt=_.getSortedSymbolIndexes(this.transform.angle);for(let Si=Yt.length-1;Si>=0;--Si){let Mi=Yt[Si];ai(_.symbolInstances.get(Mi),Mi,_.collisionArrays[Mi])}_.hasAnyZOffset&&n.w(`${_.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(_.hasAnyZOffset){let Yt=_.getSortedIndexesByZOffset();for(let Si=0;Si<Yt.length;++Si){let Mi=Yt[Si];ai(_.symbolInstances.get(Mi),Mi,_.collisionArrays[Mi])}}else for(let Yt=t.symbolInstanceStart;Yt<t.symbolInstanceEnd;Yt++)ai(_.symbolInstances.get(Yt),Yt,_.collisionArrays[Yt]);if(c&&_.bucketInstanceId in this.collisionCircleArrays){let Yt=this.collisionCircleArrays[_.bucketInstanceId];n.bi(Yt.invProjMatrix,M),Yt.viewportMatrix=this.collisionIndex.getViewportMatrix()}_.justReloaded=!1}markUsedJustification(t,o,c,d){let{leftJustifiedTextSymbolIndex:p,centerJustifiedTextSymbolIndex:_,rightJustifiedTextSymbolIndex:x,verticalPlacedTextSymbolIndex:b,crossTileID:M}=c,C=n.b$(o),z=d===n.bI.vertical?b:C==="left"?p:C==="center"?_:C==="right"?x:-1;p>=0&&(t.text.placedSymbolArray.get(p).crossTileID=z>=0&&p!==z?0:M),_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=z>=0&&_!==z?0:M),x>=0&&(t.text.placedSymbolArray.get(x).crossTileID=z>=0&&x!==z?0:M),b>=0&&(t.text.placedSymbolArray.get(b).crossTileID=z>=0&&b!==z?0:M)}markUsedOrientation(t,o,c){let d=o===n.bI.horizontal||o===n.bI.horizontalOnly?o:0,p=o===n.bI.vertical?o:0,{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:x,rightJustifiedTextSymbolIndex:b,verticalPlacedTextSymbolIndex:M}=c,C=t.text.placedSymbolArray;_>=0&&(C.get(_).placedOrientation=d),x>=0&&(C.get(x).placedOrientation=d),b>=0&&(C.get(b).placedOrientation=d),M>=0&&(C.get(M).placedOrientation=p)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;let o=this.prevPlacement,c=!1;this.prevZoomAdjustment=o?o.zoomAdjustment(this.transform.zoom):0;let d=o?o.symbolFadeChange(t):1,p=o?o.opacities:{},_=o?o.variableOffsets:{},x=o?o.placedOrientations:{};for(let b in this.placements){let M=this.placements[b],C=p[b];C?(this.opacities[b]=new Ia(C,d,M.text,M.icon,null,M.clipped),c=c||M.text!==C.text.placed||M.icon!==C.icon.placed):(this.opacities[b]=new Ia(null,d,M.text,M.icon,M.skipFade,M.clipped),c=c||M.text||M.icon)}for(let b in p){let M=p[b];if(!this.opacities[b]){let C=new Ia(M,d,!1,!1);C.isHidden()||(this.opacities[b]=C,c=c||M.text.placed||M.icon.placed)}}for(let b in _)this.variableOffsets[b]||!this.opacities[b]||this.opacities[b].isHidden()||(this.variableOffsets[b]=_[b]);for(let b in x)this.placedOrientations[b]||!this.opacities[b]||this.opacities[b].isHidden()||(this.placedOrientations[b]=x[b]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=o?o.lastPlacementChangeTime:t)}updateLayerOpacities(t,o,c,d){let p=new Set;for(let _ of o){let x=_.getBucket(t);x&&_.latestFeatureIndex&&t.fqid===x.layerIds[0]&&(this.updateBucketOpacities(x,p,_,_.collisionBoxArray,c,d,_.tileID,t.scope),x.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(x,_.tileID),x.elevationType==="road"&&x.updateRoadElevation(_.tileID.canonical),x.updateZOffset())}}updateBucketOpacities(t,o,c,d,p,_,x,b){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();let M=t.layers[0].layout,C=t.layers[0].paint,z=!!t.layers[0].dynamicFilter(),P=new Ia(null,0,!1,!1,!0),D=M.get("text-allow-overlap"),N=M.get("icon-allow-overlap"),F=M.get("text-variable-anchor"),j=M.get("text-rotation-alignment")==="map",U=M.get("text-pitch-alignment")==="map",Z=C.get("symbol-z-offset"),Y=M.get("symbol-elevation-reference")==="sea",Q=!Z.isConstant(),ne=new Ia(null,0,D&&(N||!t.hasIconData()||M.get("icon-optional")),N&&(D||!t.hasTextData()||M.get("text-optional")),!0);!t.collisionArrays&&d&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(d);let he=(oe,se,le)=>{for(let Me=0;Me<se/4;Me++)oe.opacityVertexArray.emplaceBack(le)},de=0;_&&t.updateReplacement(x,_);for(let oe=0;oe<t.symbolInstances.length;oe++){let se=t.symbolInstances.get(oe),{numHorizontalGlyphVertices:le,numVerticalGlyphVertices:Me,crossTileID:_e,numIconVertices:Ve,tileAnchorX:ze,tileAnchorY:je}=se,rt=null,Ce=this.retainedQueryData[t.bucketInstanceId];Q&&se&&Ce&&(rt=c.latestFeatureIndex.loadFeature({featureIndex:se.featureIndex,bucketIndex:Ce.bucketIndex,sourceLayerIndex:Ce.sourceLayerIndex,layoutVertexArrayOffset:0}));let me=Z.evaluate(rt,{}),ke=o.has(_e),Pe=this.opacities[_e];ke?Pe=P:Pe||(Pe=ne,this.opacities[_e]=Pe),o.add(_e);let $e=le>0||Me>0,Ze=Ve>0,Ye=this.placedOrientations[_e],ct=Ye===n.bI.vertical,Mt=Ye===n.bI.horizontal||Ye===n.bI.horizontalOnly;!$e&&!Ze||Pe.isHidden()||de++;let Ot=!1;if(($e||Ze)&&_)for(let yt of t.activeReplacements){if(n.bV(yt,p,n.bW.Symbol,b)||yt.min.x>ze||ze>yt.max.x||yt.min.y>je||je>yt.max.y)continue;let zt=n.bX(ze,je,x.canonical,yt.footprintTileId.canonical);if(Ot=n.bY(zt,yt.footprint),Ot)break}if($e){let yt=Ot?qs:al(Pe.text);he(t.text,le,ct?qs:yt),he(t.text,Me,Mt?qs:yt);let zt=Pe.text.isHidden(),{leftJustifiedTextSymbolIndex:Rt,centerJustifiedTextSymbolIndex:$t,rightJustifiedTextSymbolIndex:Jt,verticalPlacedTextSymbolIndex:ai}=se,Ti=t.text.placedSymbolArray,Yt=zt||ct?1:0;Rt>=0&&(Ti.get(Rt).hidden=Yt),$t>=0&&(Ti.get($t).hidden=Yt),Jt>=0&&(Ti.get(Jt).hidden=Yt),ai>=0&&(Ti.get(ai).hidden=zt||Mt?1:0);let Si=this.variableOffsets[_e];Si&&this.markUsedJustification(t,Si.anchor,se,Ye);let Mi=this.placedOrientations[_e];Mi&&(this.markUsedJustification(t,"left",se,Mi),this.markUsedOrientation(t,Mi,se))}if(Ze){let yt=Ot?qs:al(Pe.icon),{placedIconSymbolIndex:zt,verticalPlacedIconSymbolIndex:Rt}=se,$t=t.icon.placedSymbolArray,Jt=Pe.icon.isHidden()?1:0;zt>=0&&(he(t.icon,Ve,ct?qs:yt),$t.get(zt).hidden=Jt),Rt>=0&&(he(t.icon,se.numVerticalIconVertices,Mt?qs:yt),$t.get(Rt).hidden=Jt)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){let yt=t.collisionArrays[oe];if(yt){let zt=new n.P(0,0),Rt=!0;if(yt.textBox||yt.verticalTextBox){if(F){let Jt=this.variableOffsets[_e];Jt?(zt=zi(Jt.anchor,Jt.width,Jt.height,Jt.textOffset,Jt.textScale),j&&zt._rotate(U?this.transform.angle:-this.transform.angle)):Rt=!1}z&&(Rt=!Pe.clipped),yt.textBox&&Ms(t.textCollisionBox.collisionVertexArray,Pe.text.placed,!Rt||ct,me,Y,zt.x,zt.y),yt.verticalTextBox&&Ms(t.textCollisionBox.collisionVertexArray,Pe.text.placed,!Rt||Mt,me,Y,zt.x,zt.y)}let $t=Rt&&!!(!Mt&&yt.verticalIconBox);yt.iconBox&&Ms(t.iconCollisionBox.collisionVertexArray,Pe.icon.placed,$t,me,Y,se.hasIconTextFit?zt.x:0,se.hasIconTextFit?zt.y:0),yt.verticalIconBox&&Ms(t.iconCollisionBox.collisionVertexArray,Pe.icon.placed,!$t,me,Y,se.hasIconTextFit?zt.x:0,se.hasIconTextFit?zt.y:0)}}}if(t.fullyClipped=de===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){let oe=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=oe.invProjMatrix,t.placementViewportMatrix=oe.viewportMatrix,t.collisionCircleArray=oe.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,o){let c=this.zoomAtLastRecencyCheck===o?1-this.zoomAdjustment(o):1;return this.zoomAtLastRecencyCheck=o,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function Ms(l,t,o,c,d,p,_){l.emplaceBack(t?1:0,o?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,o?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,o?1:0,p||0,_||0,c,d?1:0),l.emplaceBack(t?1:0,o?1:0,p||0,_||0,c,d?1:0)}let Fi=Math.pow(2,25),Rh=Math.pow(2,24),Ec=Math.pow(2,17),Ic=Math.pow(2,16),In=Math.pow(2,9),Zr=Math.pow(2,8),dg=Math.pow(2,1);function al(l){if(l.opacity===0&&!l.placed)return 0;if(l.opacity===1&&l.placed)return 4294967295;let t=l.placed?1:0,o=Math.floor(127*l.opacity);return o*Fi+t*Rh+o*Ec+t*Ic+o*In+t*Zr+o*dg+t}let qs=0;class Ac{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,o,c,d,p,_){let x=this._bucketParts;for(;this._currentTileIndex<t.length;)if(o.getBucketParts(x,d,t[this._currentTileIndex],this._sortAcrossTiles,_),this._currentTileIndex++,p())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,x.sort((b,M)=>b.sortKey-M.sortKey));this._currentPartIndex<x.length;){let b=x[this._currentPartIndex];if(o.placeLayerBucketPart(b,this._seenCrossTileIDs,c,b.symbolInstanceStart===0,_),this._currentPartIndex++,p())return!0}return!1}}class Lh{constructor(t,o,c,d,p,_,x,b,M){this.placement=new Jn(t,p,_,x,b,M),this._currentPlacementIndex=o.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(t,o,c,d,p){let _=n.q.now(),x=()=>{let b=n.q.now()-_;return!this._forceFullPlacement&&b>2};for(;this._currentPlacementIndex>=0;){let b=o[t[this._currentPlacementIndex]],M=this.placement.collisionIndex.transform.zoom;if(b.type==="symbol"&&(!b.minzoom||b.minzoom<=M)&&(!b.maxzoom||b.maxzoom>M)){let C=b,z=C.layout.get("symbol-z-elevate"),P=C.layout.get("symbol-sort-key").constantOr(1)!==void 0,D=C.layout.get("symbol-z-order"),N=D==="viewport-y"||D==="auto"&&!(D!=="viewport-y"&&P),F=C.layout.get("text-allow-overlap")||C.layout.get("icon-allow-overlap")||C.layout.get("text-ignore-placement")||C.layout.get("icon-ignore-placement"),j=N&&F,U=this._inProgressLayer=this._inProgressLayer||new Ac(C),Z=n.C(b.source,b.scope);if(U.continuePlacement(z||j?d[Z]:c[Z],this.placement,this._showCollisionBoxes,b,x,p))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}let Mc=512/n.aj/2;class zh{constructor(t,o,c){this.tileID=t,this.bucketInstanceId=c,this.index=new n.c0(o.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let d=t.canonical.x*n.aj,p=t.canonical.y*n.aj;for(let _=0;_<o.length;_++){let{key:x,crossTileID:b,tileAnchorX:M,tileAnchorY:C}=o.get(_),z=Math.floor((d+M)*Mc),P=Math.floor((p+C)*Mc);this.index.add(z,P),this.keys.push(x),this.crossTileIDs.push(b)}this.index.finish()}findMatches(t,o,c){let d=this.tileID.canonical.z<o.canonical.z?1:Math.pow(2,this.tileID.canonical.z-o.canonical.z),p=Mc/Math.pow(2,o.canonical.z-this.tileID.canonical.z),_=o.canonical.x*n.aj,x=o.canonical.y*n.aj;for(let b=0;b<t.length;b++){let M=t.get(b);if(M.crossTileID)continue;let{key:C,tileAnchorX:z,tileAnchorY:P}=M,D=Math.floor((_+z)*p),N=Math.floor((x+P)*p),F=this.index.range(D-d,N-d,D+d,N+d).sort((j,U)=>j-U);for(let j of F){let U=this.crossTileIDs[j];if(this.keys[j]===C&&!c.has(U)){c.add(U),M.crossTileID=U;break}}}}}class Ln{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Cs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){let o=Math.round((t-this.lng)/360);if(o!==0)for(let c in this.indexes){let d=this.indexes[c],p={};for(let _ in d){let x=d[_];x.tileID=x.tileID.unwrapTo(x.tileID.wrap+o),p[x.tileID.key]=x}this.indexes[c]=p}this.lng=t}addBucket(t,o,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===o.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let p=0;p<o.symbolInstances.length;p++)o.symbolInstances.get(p).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);let d=this.usedCrossTileIDs[t.overscaledZ];for(let p in this.indexes){let _=this.indexes[p];if(Number(p)>t.overscaledZ)for(let x in _){let b=_[x];b.tileID.isChildOf(t)&&b.findMatches(o.symbolInstances,t,d)}else{let x=_[t.scaledTo(Number(p)).key];x&&x.findMatches(o.symbolInstances,t,d)}}for(let p=0;p<o.symbolInstances.length;p++){let _=o.symbolInstances.get(p);_.crossTileID||(_.crossTileID=c.generate(),d.add(_.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new zh(t,o.symbolInstances,o.bucketInstanceId),!0}removeBucketCrossTileIDs(t,o){for(let c of o.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let o=!1;for(let c in this.indexes){let d=this.indexes[c];for(let p in d)t[d[p].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,d[p]),delete d[p],o=!0)}return o}}class Gn{constructor(){this.layerIndexes={},this.crossTileIDs=new Ln,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,o,c,d){let p=this.layerIndexes[t.fqid];p===void 0&&(p=this.layerIndexes[t.fqid]=new Cs);let _=!1,x={};d.name!=="globe"&&p.handleWrapJump(c);for(let b of o){let M=b.getBucket(t);M&&t.fqid===M.layerIds[0]&&(M.bucketInstanceId||(M.bucketInstanceId=++this.maxBucketInstanceId),p.addBucket(b.tileID,M,this.crossTileIDs)&&(_=!0),x[M.bucketInstanceId]=!0)}return p.removeStaleBuckets(x)&&(_=!0),_}pruneUnusedLayers(t){let o={};t.forEach(c=>{o[c]=!0});for(let c in this.layerIndexes)o[c]||delete this.layerIndexes[c]}}let Aa=771;class ti{constructor(t,o,c,d){this.blendFunction=t,this.blendColor=o.toNonPremultipliedRenderColor(null),this.mask=c,this.blendEquation=d}}ti.Replace=[1,0,1,0],ti.disabled=new ti(ti.Replace,n.am.transparent,[!1,!1,!1,!1]),ti.unblended=new ti(ti.Replace,n.am.transparent,[!0,!0,!0,!0]),ti.alphaBlended=new ti([1,Aa,1,Aa],n.am.transparent,[!0,!0,!0,!0]),ti.alphaBlendedNonPremultiplied=new ti([770,Aa,770,Aa],n.am.transparent,[!0,!0,!0,!0]),ti.multiply=new ti([774,0,774,0],n.am.transparent,[!0,!0,!0,!0]);class bt{constructor(t,o,c){this.func=t,this.mask=o,this.range=c}}bt.ReadOnly=!1,bt.ReadWrite=!0,bt.disabled=new bt(519,bt.ReadOnly,[0,1]);let Do=7680;class Gt{constructor(t,o,c,d,p,_){this.test=t,this.ref=o,this.mask=c,this.fail=d,this.depthFail=p,this.pass=_}}Gt.disabled=new Gt({func:519,mask:0},0,0,Do,Do,Do);let Ur=1029,Cc=2305;class Nt{constructor(t,o,c){this.enable=t,this.mode=o,this.frontFace=c}}function ll(l,t){let o=n.c6(l,3);n.c8(l,t),n.cc(l,3,o)}function cl(l,t){let o=n.c3([]);return n.c4(o,o,-t),n.c5(o,o,-l),o}function Hs(l,t){let o=[l[0],l[1],0],c=[t[0],t[1],0];if(n.ae(o)>=1e-15){let _=n.au([],o);n.c1(c,_,n.bG(c,_)),t[0]=c[0],t[1]=c[1]}let d=n.bF([],t,l);if(n.c2(d)<1e-15)return null;let p=Math.atan2(-d[1],d[0]);return cl(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),p)}Nt.disabled=new Nt(!1,Ur,Cc),Nt.backCCW=new Nt(!0,Ur,Cc),Nt.backCW=new Nt(!0,Ur,2304),Nt.frontCW=new Nt(!0,1028,2304),Nt.frontCCW=new Nt(!0,1028,Cc);class Ff{constructor(t,o){this.position=t,this.orientation=o}get position(){return this._position}set position(t){if(t){let o=t instanceof n.ac?t:new n.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(o.x=n.bQ(o.x,0,1)),this._position=o}else this._position=null}lookAtPoint(t,o){if(this.orientation=null,!this.position)return;let c=this.position,d=this._elevation?this._elevation.getAtPointOrZero(n.ac.fromLngLat(t)):0,p=n.ac.fromLngLat(t,d),_=[p.x-c.x,p.y-c.y,p.z-c.z];o||(o=[0,0,1]),o[2]=Math.abs(o[2]),this.orientation=Hs(_,o)}setPitchBearing(t,o){this.orientation=cl(n.al(t),n.al(-o))}}class Oo{constructor(t,o){this._transform=n.bx([]),this.orientation=o,this.position=t}get mercatorPosition(){let t=this.position;return new n.ac(t[0],t[1],t[2])}get position(){let t=n.c6(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var o;t&&n.cc(this._transform,3,[(o=t)[0],o[1],o[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||n.c3([]),t&&ll(this._transform,this._orientation)}getPitchBearing(){let t=this.forward(),o=this.right();return{bearing:Math.atan2(-o[1],o[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,o){this._orientation=cl(t,o),ll(this._transform,this._orientation)}forward(){let t=n.c6(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){let t=n.c6(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){let t=n.c6(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,o){let c=new Float64Array(16);return n.bi(c,this.getWorldToCamera(t,o)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,o,c){let d=this.position;n.c1(d,d,-t);let p=new Float64Array(16);return n.bn(p,[c,c,c]),n.bo(p,p,d),p[10]*=o,p}getWorldToCamera(t,o){let c=new Float64Array(16),d=new Float64Array(4),p=this.position;return n.c7(d,this._orientation),n.c1(p,p,-t),n.c8(c,d),n.bo(c,c,p),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=o,c[9]*=o,c[10]*=o,c[11]*=o,c}getCameraToClipPerspective(t,o,c,d){let p=new Float64Array(16);return n.c9(p,t,o,c,d),p}getCameraToClipOrthographic(t,o,c,d,p,_){let x=new Float64Array(16);return n.ca(x,t,o,c,d,p,_),x}getDistanceToElevation(t,o=!1){let c=t===0?0:n.cb(t,o?n.aY(this.position[1]):this.position[1]),d=this.forward();return(c-this.position[2])/d[2]}clone(){return new Oo([...this.position],[...this.orientation])}}let zn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Pc{constructor(t=0,o=0,c=0,d=0){if(isNaN(t)||t<0||isNaN(o)||o<0||isNaN(c)||c<0||isNaN(d)||d<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=o,this.left=c,this.right=d}interpolate(t,o,c){return o.top!=null&&t.top!=null&&(this.top=n.ai(t.top,o.top,c)),o.bottom!=null&&t.bottom!=null&&(this.bottom=n.ai(t.bottom,o.bottom,c)),o.left!=null&&t.left!=null&&(this.left=n.ai(t.left,o.left,c)),o.right!=null&&t.right!=null&&(this.right=n.ai(t.right,o.right,c)),this}getCenter(t,o){let c=n.ay((this.left+t-this.right)/2,0,t),d=n.ay((this.top+o-this.bottom)/2,0,o);return new n.P(c,d)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Pc(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}let cn=15;class _d{constructor(t,o,c,d,p,_,x){this.tileSize=512,this._renderWorldCopies=p===void 0||p,this._minZoom=t||0,this._maxZoom=o||22,this._minPitch=c??0,this._maxPitch=d??60,this.setProjection(_),this.setMaxBounds(x),this.width=0,this.height=0,this._center=new n.ci(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Pc,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Oo,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){let t=new _d(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<cn}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,o=!1){let c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(o),this._calcMatrices()}getProjection(){return n.aF(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};let o=this.projection?this.getProjection():void 0;this.projection=n.cj(this.projectionOptions);let c=this.getProjection(),d=!n.bv(o,c);return d&&this._calcMatrices(),this.mercatorFromTransition=!1,d}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){let t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=n.cj({name:"mercator"});let o=t!==this.projection.name;return o&&this._calcMatrices(),o}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return n.cb(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new n.P(this.width,this.height)}get bearing(){return n.bQ(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){let o=-t*Math.PI/180;this.angle!==o&&(this._unmodified=!1,this.angle=o,this._calcMatrices(),this.rotationMatrix=n.ck(),n.cl(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){let o=n.ay(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==o&&(this._unmodified=!1,this._pitch=o,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=n.al(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){let t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){let o=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==o&&(this._unmodified=!1,this._setZoom(o),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){let t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,o=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!o||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let c=this._elevation;o||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;let t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;let t=this._elevation,o=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop(),d=0,p=0;for(let _=0;_<o.length;_++){let x=new n.P(o[_][0]*this.width,c+o[_][1]*(this.height-c)),b=t.pointCoordinate(x);if(!b)continue;let M=1/Math.hypot(b[0]-this._camera.position[0],b[1]-this._camera.position[1]);d+=b[3]*M,p+=M}return p===0?NaN:d/p}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;let t=this._seaLevelZoom,o=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*o,d=this._mercatorZfromZoom(t),p=this._mercatorZfromZoom(this._maxZoom),_=Math.max(d-c,p);this._setZoom(this._zoomFromMercatorZ(_))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){let o=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude())),c;c=t.z<this._camera.position[2]?[o.x,o.y,o.z]:[t.x,t.y,t.z];let d=n.ae(n.at([],this._camera.position,c));return n.ay(this._zoomFromMercatorZ(d),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let o=!1;if(t.orientation&&!n.cm(t.orientation,this._camera.orientation)&&(o=this._setCameraOrientation(t.orientation)),t.position){let c=[t.position.x,t.position.y,t.position.z];n.cn(c,this._camera.position)||(this._setCameraPosition(c),o=!0)}o&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let t=this._camera.position,o=new Ff;return o.position=new n.ac(t[0],t[1],t[2]),o.orientation=this._camera.orientation,o._elevation=this.elevation,o._renderWorldCopies=this.renderWorldCopies,o}_setCameraOrientation(t){if(!n.co(t))return!1;n.cp(t,t);let o=n.cq([],[0,0,-1],t),c=n.cq([],[0,-1,0],t);if(c[2]<0)return!1;let d=Hs(o,c);return!!d&&(this._camera.orientation=d,!0)}_setCameraPosition(t){let o=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,d=this.cameraToCenterDistance;t[2]=n.ay(t[2],d/c,d/o),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,o,c){this._unmodified=!1,this._edgeInsets.interpolate(t,o,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){let o=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,o)}getVisibleUnwrappedCoordinates(t){let o=[new n.cr(0,t)];if(this.renderWorldCopies){let c=this.pointCoordinate(new n.P(0,0)),d=this.pointCoordinate(new n.P(this.width,0)),p=this.pointCoordinate(new n.P(this.width,this.height)),_=this.pointCoordinate(new n.P(0,this.height)),x=Math.floor(Math.min(c.x,d.x,p.x,_.x)),b=Math.floor(Math.max(c.x,d.x,p.x,_.x)),M=1;for(let C=x-M;C<=b+M;C++)C!==0&&o.push(new n.cr(C,t))}return o}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,o,c){let d=[],p=c!=null,_=!p;if(_&&this.zoom<o||p&&c[0]===0&&c[1]===0)return d;let x=new Set,b=(C,z,P,D,N)=>{let F=n.cV(z,C,P,D,N);x.has(F)||(d.push(new n.aM(C,z,P,D,N)),x.add(F))};for(let C=0;C<t.length;C++){let z=t[C];if(_&&z.canonical.z!==o)continue;let P=z.canonical,D=z.overscaledZ,N=z.wrap,F=1<<P.z,j=P.x+1<F,U=P.x>0,Z=P.y+1<F,Y=P.y>0,Q=z.wrap-(U?0:1),ne=z.wrap+(j?0:1),he=U?P.x-1:F-1,de=j?P.x+1:0;if(p)c[0]<0?(b(D,ne,P.z,de,P.y),c[1]<0&&Z&&(b(D,N,P.z,P.x,P.y+1),b(D,ne,P.z,de,P.y+1)),c[1]>0&&Y&&(b(D,N,P.z,P.x,P.y-1),b(D,ne,P.z,de,P.y-1))):c[0]>0?(b(D,Q,P.z,he,P.y),c[1]<0&&Z&&(b(D,N,P.z,P.x,P.y+1),b(D,Q,P.z,he,P.y+1)),c[1]>0&&Y&&(b(D,N,P.z,P.x,P.y-1),b(D,Q,P.z,he,P.y-1))):c[1]<0&&Z?b(D,N,P.z,P.x,P.y+1):Y&&b(D,N,P.z,P.x,P.y-1);else{let oe=z.visibleQuadrants;1&oe&&(b(D,Q,P.z,he,P.y),Y&&(b(D,N,P.z,P.x,P.y-1),b(D,Q,P.z,he,P.y-1))),2&oe&&(b(D,ne,P.z,de,P.y),Y&&(b(D,N,P.z,P.x,P.y-1),b(D,ne,P.z,de,P.y-1))),4&oe&&(b(D,Q,P.z,he,P.y),Z&&(b(D,N,P.z,P.x,P.y+1),b(D,Q,P.z,he,P.y+1))),8&oe&&(b(D,ne,P.z,de,P.y),Z&&(b(D,N,P.z,P.x,P.y+1),b(D,ne,P.z,de,P.y+1)))}}let M=[];for(let C of d)d.some(z=>C.isChildOf(z))||M.push(C);if(d=M.filter(C=>!t.some(z=>!!(C.overscaledZ<o&&z.isChildOf(C))||C.equals(z)||C.isChildOf(z))),_){let C=1<<o,z=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),P=[C*z.x,C*z.y],D=4,N=D*D;d=d.filter(F=>{let j=F.canonical.x+.5-P[0],U=F.canonical.y+.5-P[1];return j*j+U*U<N})}return d}extendTileCoverToNearPlane(t,o,c){let d=[],p=new Set;for(let Z of t)p.add(Z.key);let _=(Z,Y,Q,ne,he)=>{let de=n.cV(Y,Z,Q,ne,he);p.has(de)||(d.push(new n.aM(Z,Y,Q,ne,he)),p.add(de))},x=t.reduce((Z,Y)=>Math.max(Z,Y.overscaledZ),c),b=1<<c,M=[new n.P(0,0),new n.P(n.aj,0),new n.P(n.aj,n.aj),new n.P(0,n.aj)],C=new n.P(0,0),z=new n.P(0,0),P=(Z,Y)=>{let Q=Math.floor(Z[0]),ne=Math.floor(Z[1]),he=(Z[0]-Q)*n.aj,de=(Z[1]-ne)*n.aj,oe=Math.floor(Y[0]),se=Math.floor(Y[1]),le=(Y[0]-oe)*n.aj,Me=(Y[1]-se)*n.aj;for(let _e=-1;_e<=1;_e++){let Ve=Q+_e;if(!(Ve<0||Ve>=b)){C.x=he-_e*n.aj,z.x=le-(Ve-oe)*n.aj;for(let ze=-1;ze<=1;ze++){let je=ne+ze;C.y=de-ze*n.aj,z.y=Me-(je-se)*n.aj,n.cW(C,z,M)&&_(x,0,c,Ve,je)}}}},D=o.points,N=D[n.cs],F=D[n.ct],j=this._projectToGround(N,D[n.cu]),U=this._projectToGround(F,D[n.cv]);return P(N,j),P(F,U),d}_projectToGround(t,o){return n.cw(n.cx(),t,o,t[2]/(t[2]-o[2]))}coveringTiles(t){let o=this.coveringZoomLevel(t),c=o,d=this.elevation&&this.elevation.exaggeration(),p=d&&!t.isTerrainDEM,_=this.projection.name==="mercator";if(t.minzoom!==void 0&&o<t.minzoom)return[];t.maxzoom!==void 0&&o>t.maxzoom&&(o=t.maxzoom);let x=this.locationCoordinate(this.center),b=this.center.lat,M=1<<o,C=[M*x.x,M*x.y,0],z=this.projection.name==="globe",P=!z,D=n.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,o,P),N=z?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),F=M*n.cb(1,this.center.lat),j=this._camera.position[2]/n.cb(1,this.center.lat),U=[M*N.x,M*N.y,j*(P?1:F)],Z=z||d,Y=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),Q=this.isLODDisabled(!0)?o:0,ne;if(this._elevation&&t.isTerrainDEM)ne=1e4*this._elevation.exaggeration();else if(this._elevation){let me=this._elevation.getMinMaxForVisibleTiles();ne=me?me.max:this._centerAltitude}else ne=this._centerAltitude;let he=t.isTerrainDEM?-ne:this._elevation?this._elevation.getMinElevationBelowMSL():0,de=this.projection.isReprojectedInTileSpace?n.cz(this):1,oe=me=>{let Pe=new n.ac(me.x+25e-6,me.y,me.z),$e=new n.ac(me.x,me.y+25e-6,me.z),Ze=me.toLngLat(),Ye=Pe.toLngLat(),ct=$e.toLngLat(),Mt=this.locationCoordinate(Ze),Ot=this.locationCoordinate(Ye),yt=this.locationCoordinate(ct),zt=Math.hypot(Ot.x-Mt.x,Ot.y-Mt.y),Rt=Math.hypot(yt.x-Mt.x,yt.y-Mt.y);return Math.sqrt(zt*Rt)*de/25e-6},se=me=>{let ke=ne,Pe=he;return{aabb:n.cC(this,M,0,0,0,me,Pe,ke,this.projection),zoom:0,x:0,y:0,minZ:Pe,maxZ:ke,wrap:me,fullyVisible:!1}},le=[],Me=[],_e=o,Ve=t.reparseOverscaled?c:o,ze=(j-this._centerAltitude)*F,je=me=>{if(!this._elevation||!me.tileID||!_)return;let ke=this._elevation.getMinMaxForTile(me.tileID),Pe=me.aabb;ke?(Pe.min[2]=ke.min,Pe.max[2]=ke.max,Pe.center[2]=(Pe.min[2]+Pe.max[2])/2):(me.shouldSplit=Ce(me),me.shouldSplit||(Pe.min[2]=Pe.max[2]=Pe.center[2]=this._centerAltitude))},rt=(me,ke)=>{if(.707*ke<me)return 1;let Pe=ke/me;return Pe/(1.4144271570014144+(Math.pow(1.1,Pe-1.4144271570014144+1)-1)/(1.1-1)-1)},Ce=me=>{if(me.zoom<Q)return!0;if(me.zoom===_e)return!1;if(me.shouldSplit!=null)return me.shouldSplit;let ke=me.aabb.distanceX(U),Pe=me.aabb.distanceY(U),$e=ze,Ze=1;if(z){$e=me.aabb.distanceZ(U);let Rt=Math.pow(2,me.zoom),$t=n.aY((me.y+1)/Rt),Jt=n.aY(me.y/Rt),ai=Math.min(Math.max(b,$t),Jt),Ti=n.c_(ai)/n.c_(b);if(Ze=ai===b?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Ti/this._mercatorScaleRatio),this.zoom<=n.cX&&me.zoom===_e-1&&Ti>=.9)return!0}else if(p&&($e=me.aabb.distanceZ(U)*F),this.projection.isReprojectedInTileSpace&&c<=5){let Rt=Math.pow(2,me.zoom),$t=oe(new n.ac((me.x+.5)/Rt,(me.y+.5)/Rt));Ze=$t>.85?1:$t}if(!_){let Rt=Math.sqrt(ke*ke+Pe*Pe+$e*$e),$t=(1<<_e-me.zoom)*Y*Ze;return $t*=rt(Math.max($e,ze),Rt),Rt<$t}let Ye=Number.MAX_VALUE,ct=0,Mt=me.aabb.getCorners(),Ot=[];for(let Rt of Mt){n.at(Ot,Rt,U),z||(p?Ot[2]*=F:Ot[2]=ze);let $t=n.bG(Ot,this._camera.forward());$t<Ye&&(Ye=$t,ct=Math.abs(Ot[2]))}let yt=(1<<_e-me.zoom)*Y*Ze;if(yt*=rt(Math.max(ct,ze),Ye),Ye<yt)return!0;let zt=me.aabb.closestPoint(C);return zt[0]===C[0]&&zt[1]===C[1]};if(this.renderWorldCopies)for(let me=1;me<=3;me++)le.push(se(-me)),le.push(se(me));for(le.push(se(0));le.length>0;){let me=le.pop(),ke=me.x,Pe=me.y,$e=me.fullyVisible,Ze=()=>this.projection.name==="globe"&&(me.y===0||me.y===(1<<me.zoom)-1);if(!$e){let Ye=Z?me.aabb.intersects(D):me.aabb.intersectsFlat(D);if(Ye===0&&Ze()){let ct=new n.cA(me.zoom,ke,Pe);Ye=n.cB(this,M,ct,!0).intersects(D)}if(Ye===0)continue;$e=Ye===2}if(me.zoom!==_e&&Ce(me))for(let Ye=0;Ye<4;Ye++){let ct=(ke<<1)+Ye%2,Mt=(Pe<<1)+(Ye>>1),Ot={aabb:_?me.aabb.quadrant(Ye):n.cC(this,M,me.zoom+1,ct,Mt,me.wrap,me.minZ,me.maxZ,this.projection),zoom:me.zoom+1,x:ct,y:Mt,wrap:me.wrap,fullyVisible:$e,tileID:void 0,shouldSplit:void 0,minZ:me.minZ,maxZ:me.maxZ};p&&!z&&(Ot.tileID=new n.aM(me.zoom+1===_e?Ve:me.zoom+1,me.wrap,me.zoom+1,ct,Mt),je(Ot)),le.push(Ot)}else{let Ye=me.zoom===_e?Ve:me.zoom;if(t.minzoom&&t.minzoom>Ye)continue;let ct=0;if(!$e){let zt=Z?me.aabb.intersectsPrecise(D):me.aabb.intersectsPreciseFlat(D);if(zt===0&&Ze()){let Rt=new n.cA(me.zoom,ke,Pe);zt=n.cB(this,M,Rt,!0).intersectsPrecise(D)}if(zt===0)continue;if(t.calculateQuadrantVisibility)if(D.containsPoint(me.aabb.center))ct=15;else for(let Rt=0;Rt<4;Rt++)me.aabb.quadrant(Rt).intersects(D)!==0&&(ct|=1<<Rt)}let Mt=C[0]-(.5+ke+(me.wrap<<me.zoom))*(1<<o-me.zoom),Ot=C[1]-.5-Pe,yt=me.tileID?me.tileID:new n.aM(Ye,me.wrap,me.zoom,ke,Pe);t.calculateQuadrantVisibility&&(yt.visibleQuadrants=ct),Me.push({tileID:yt,distanceSq:Mt*Mt+Ot*Ot})}}if(this.fogCullDistSq){let me=this.fogCullDistSq,ke=this.horizonLineFromTop();Me=Me.filter(Pe=>{let $e=[0,0,0,1],Ze=[n.aj,n.aj,0,1],Ye=this.calculateFogTileMatrix(Pe.tileID.toUnwrapped());n.aA($e,$e,Ye),n.aA(Ze,Ze,Ye);let ct=n.cD([],$e,Ze),Mt=n.cE([],$e,Ze),Ot=n.cY(ct,Mt);if(Ot===0)return!0;let yt=!1,zt=this._elevation;if(zt&&Ot>me&&ke!==0){let Rt=this.calculateProjMatrix(Pe.tileID.toUnwrapped()),$t;t.isTerrainDEM||($t=zt.getMinMaxForTile(Pe.tileID)),$t||($t={min:he,max:ne});let Jt=n.cF(this.rotation),ai=[Jt[0]*n.aj,Jt[1]*n.aj,$t.max];n.ad(ai,ai,Rt),yt=(1-ai[1])*this.height*.5<ke}return Ot<me||yt})}return Me.sort((me,ke)=>me.distanceSq-ke.distanceSq).map(me=>me.tileID)}resize(t,o){this.width=t,this.height=o,this.pixelsToGLUnits=[2/t,-2/o],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){let o=n.ay(t.lat,-n.cG,n.cG),c=this.projection.project(t.lng,o);return new n.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/n.cb(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,o){let c,d,p=this.centerPoint;if(this.projection.name==="globe"){let x=this.worldSize;c=(o.x-p.x)/x,d=(o.y-p.y)/x}else{let x=this.pointCoordinate(o),b=this.pointCoordinate(p);c=x.x-b.x,d=x.y-b.y}let _=this.locationCoordinate(t);this.setLocation(new n.ac(_.x-c,_.y-d))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,o){return this.projection.locationPoint(this,t,o)}locationPoint3D(t,o){return this.projection.locationPoint(this,t,o,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,o){return this.coordinateLocation(this.pointCoordinate3D(t,o))}locationCoordinate(t,o){let c=o?n.cb(o,t.lat):void 0,d=this.projection.project(t.lng,t.lat);return new n.ac(d.x,d.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,o){let c=o??this._centerAltitude,d=[t.x,t.y,0,1],p=[t.x,t.y,1,1];n.aA(d,d,this.pixelMatrixInverse),n.aA(p,p,this.pixelMatrixInverse);let _=p[3];n.cH(d,d,1/d[3]),n.cH(p,p,1/_);let x=d[2],b=p[2];return{p0:d,p1:p,t:x===b?0:(c-x)/(b-x)}}screenPointToMercatorRay(t){let o=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return n.aA(o,o,this.pixelMatrixInverse),n.aA(c,c,this.pixelMatrixInverse),n.cH(o,o,1/o[3]),n.cH(c,c,1/c[3]),o[2]=n.cb(o[2],this._center.lat)*this.worldSize,c[2]=n.cb(c[2],this._center.lat)*this.worldSize,n.cH(o,o,1/this.worldSize),n.cH(c,c,1/this.worldSize),new n.av([o[0],o[1],o[2]],n.au([],n.at([],c,o)))}rayIntersectionCoordinate(t){let{p0:o,p1:c,t:d}=t,p=n.cb(o[2],this._center.lat),_=n.cb(c[2],this._center.lat);return new n.ac(n.ai(o[0],c[0],d)/this.worldSize,n.ai(o[1],c[1],d)/this.worldSize,n.ai(p,_,d))}pointCoordinate(t,o=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,o)}pointCoordinate3D(t,o){if(!this.elevation)return this.pointCoordinate(t,o);let c=this.projection.pointCoordinate3D(this,t.x,t.y);if(c)return new n.ac(c[0],c[1],c[2]);let d=0,p=this.horizonLineFromTop();if(t.y>p)return this.pointCoordinate(t,o);let _=.02*p,x=t.clone();for(let b=0;b<10&&p-d>_;b++){x.y=n.ai(d,p,.66);let M=this.projection.pointCoordinate3D(this,x.x,x.y);M?(p=x.y,c=M):d=x.y}return c?new n.ac(c[0],c[1],c[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=n.cI)return!this.isPointAboveHorizon(t);let o=this.pointCoordinate(t);return o.y>=0&&o.y<=1}_coordinatePoint(t,o){let c=o&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,d=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return n.aA(d,d,this.pixelMatrix),d[3]>0?new n.P(d[0]/d[3],d[1]/d[3]):new n.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:t,left:o}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,d=this.width-this._edgeInsets.right,p=this.pointLocation3D(new n.P(o,t)),_=this.pointLocation3D(new n.P(d,t)),x=this.pointLocation3D(new n.P(d,c)),b=this.pointLocation3D(new n.P(o,c)),M=Math.min(p.lng,_.lng,x.lng,b.lng),C=Math.max(p.lng,_.lng,x.lng,b.lng),z=Math.min(p.lat,_.lat,x.lat,b.lat),P=Math.max(p.lat,_.lat,x.lat,b.lat),D=Math.pow(2,-this.zoom)/16*270,N=this.projection.name==="globe"?1:4,F=(j,U,Z,Y,Q)=>{let ne=(j+Z)/2,he=(U+Y)/2,de=new n.P(ne,he),{lng:oe,lat:se}=this.pointLocation3D(de),le=Math.max(0,M-oe,z-se,oe-C,se-P);M=Math.min(M,oe),C=Math.max(C,oe),z=Math.min(z,se),P=Math.max(P,se),(Q<N||le>D)&&(F(j,U,ne,he,Q+1),F(ne,he,Z,Y,Q+1))};if(F(o,t,d,t,1),F(d,t,d,c,1),F(d,c,o,c,1),F(o,c,o,t,1),this.projection.name==="globe"){let[j,U]=n.cJ(this);j?(P=90,C=180,M=-180):U&&(z=-90,C=180,M=-180)}return new n.aG(new n.ci(M,z),new n.ci(C,P))}_getBoundsRectangular(t,o){let{top:c,left:d}=this._edgeInsets,p=this.height-this._edgeInsets.bottom,_=this.width-this._edgeInsets.right,x=new n.P(d,c),b=new n.P(_,c),M=new n.P(_,p),C=new n.P(d,p),z=this.pointCoordinate(x,t),P=this.pointCoordinate(b,t),D=this.pointCoordinate(M,o),N=this.pointCoordinate(C,o),F=(j,U)=>(U.y-j.y)/(U.x-j.x);return z.y>1&&P.y>=0?z=new n.ac((1-N.y)/F(N,z)+N.x,1):z.y<0&&P.y<=1&&(z=new n.ac(-N.y/F(N,z)+N.x,0)),P.y>1&&z.y>=0?P=new n.ac((1-D.y)/F(D,P)+D.x,1):P.y<0&&z.y<=1&&(P=new n.ac(-D.y/F(D,P)+D.x,0)),new n.aG().extend(this.coordinateLocation(z)).extend(this.coordinateLocation(P)).extend(this.coordinateLocation(N)).extend(this.coordinateLocation(D))}_getBoundsRectangularTerrain(){let t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);let o=t.visibleDemTiles.reduce((c,d)=>{if(d.dem){let p=d.dem.tree;c.min=Math.min(c.min,p.minimums[0]),c.max=Math.max(c.max,p.maximums[0])}return c},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(o.min*t.exaggeration(),o.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){let o=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-o*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-n.cG,this.maxLat=n.cG,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=n.aD(this.minLng)*this.tileSize,this.worldMaxX=n.aD(this.maxLng)*this.tileSize,this.worldMinY=n.aH(this.maxLat)*this.tileSize,this.worldMaxY=n.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,o){return this.projection.createTileMatrix(this,o,t)}calculateDistanceTileData(t){let o=t.key,c=this._distanceTileDataCache;if(c[o])return c[o];let d=t.canonical,p=1/this.height,_=this.cameraWorldSize,x=_/this.zoomScale(d.z),b=(d.x+Math.pow(2,d.z)*t.wrap)*x,M=d.y*x,C=this.point;C.x*=_/this.worldSize,C.y*=_/this.worldSize;let z=this.angle,P=Math.sin(-z),D=-Math.cos(-z);return c[o]={bearing:[P,D],center:[(C.x-b)*p,(C.y-M)*p],scale:x/n.aj*p},c[o]}calculateFogTileMatrix(t){let o=t.key,c=this._fogTileMatrixCache;if(c[o])return c[o];let d=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return n.az(d,this.worldToFogMatrix,d),c[o]=new Float32Array(d),c[o]}calculateProjMatrix(t,o=!1,c=!1){let d=t.key,p;if(p=c?this._expandedProjMatrixCache:o?this._alignedProjMatrixCache:this._projMatrixCache,p[d])return p[d];let _=this.calculatePosMatrix(t,this.worldSize),x;return x=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:o?this.alignedProjMatrix:this.projMatrix,n.az(_,x,_),p[d]=new Float32Array(_),p[d]}calculatePixelsToTileUnitsMatrix(t){let o=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[o])return c[o];let d=n.cK(t,this);return c[o]=d,c[o]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){let t=1/this.worldSize,o=n.bn([],[t,t,t]);return n.az(o,o,this.globeMatrix),o}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;let t=this._elevation;this._updateCameraState();let o=n.cb(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(o),d=this._camera.forward(),p=n.cb(1,this._center.lat);c[2]/=p,d[2]/=p,n.au(d,d);let _=t.raycast(c,d,t.exaggeration());if(_){let x=n.bE([],c,d,_),b=new n.ac(x[0],x[1],n.cb(x[2],n.aY(x[1]))),M=(b.z+n.ae([b.x-c[0],b.y-c[1],b.z-c[2]*p]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(M),this._centerAltitude=b.toAltitude(),this._center=this.coordinateLocation(b),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;let o=this._elevation,c=n.cb(1,this._center.lat)*this.worldSize,d=this._computeCameraPosition(c),p=o.getAtPointOrZero(new n.ac(...d)),_=this.pixelsPerMeter/this.worldSize*p,x=this._minimumHeightOverTerrain(),b=d[2]-_;if(b<=x)if(b<0||t){let M=this.locationCoordinate(this._center,this._centerAltitude),C=[d[0],d[1],M.z-d[2]],z=n.ae(C);C[2]-=(x-b)/this._pixelsPerMercatorPixel;let P=n.ae(C);if(P===0)return;n.c1(C,C,z/P*this._pixelsPerMercatorPixel),this._camera.position=[d[0],d[1],M.z*this._pixelsPerMercatorPixel-C[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){let P=this.center;return P.lat=n.ay(P.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(P.lng=n.ay(P.lng,this.minLng,this.maxLng)),this.center=P,void(this._constraining=!1)}let o=this._unmodified,{x:c,y:d}=this.point,p=0,_=c,x=d,b=this.width/2,M=this.height/2,C=this.worldMinY*this.scale,z=this.worldMaxY*this.scale;if(d-M<C&&(x=C+M),d+M>z&&(x=z-M),z-C<this.height&&(p=Math.max(p,this.height/(z-C)),x=(z+C)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let P=this.worldMinX*this.scale,D=this.worldMaxX*this.scale,N=this.worldSize/2-(P+D)/2;_=(c+N+this.worldSize)%this.worldSize-N,_-b<P&&(_=P+b),_+b>D&&(_=D-b),D-P<this.width&&(p=Math.max(p,this.width/(D-P)),_=(D+P)/2)}_===c&&x===d||this._allowWorldUnderZoom||(this.center=this.unproject(new n.P(_,x))),p&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(p)),this._constrainCamera(),this._unmodified=o,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;let t=this.centerOffset,o=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=n.cb(1,this.center.lat)/n.cb(1,n.c$));let d=n.cL(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,d),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let p=this.projection.zAxisUnit==="meters"?c:1,_=this._camera.getWorldToCamera(this.worldSize,p),x,b=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(b[8]=2*-t.x/this.width,b[9]=2*t.y/this.height,this.isOrthographic){let se=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),le=se*this.aspect,Me=-le,_e=-se;le-=t.x,Me-=t.x,se+=t.y,_e+=t.y,x=this._camera.getCameraToClipOrthographic(Me,le,_e,se,this._nearZ,this._farZ),((Ve,ze,je,rt)=>{for(let Ce=0;Ce<16;Ce++)Ve[Ce]=n.ai(ze[Ce],je[Ce],rt)})(x,x,b,n.cZ(this.pitch>=cn?1:this.pitch/cn))}else x=b;let M=n.cM([],b,_),C=n.cM([],x,_);if(this.projection.isReprojectedInTileSpace){let se=this.locationCoordinate(this.center),le=n.bx([]);n.bo(le,le,[se.x*this.worldSize,se.y*this.worldSize,0]),n.az(le,le,n.cN(this)),n.bo(le,le,[-se.x*this.worldSize,-se.y*this.worldSize,0]),n.az(C,C,le),n.az(M,M,le),this.inverseAdjustmentMatrix=n.cO(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=n.cP([],C,[this.worldSize,this.worldSize,this.worldSize/p,1]),this.projMatrix=C,this.invProjMatrix=n.bi(new Float64Array(16),this.projMatrix),o){let se=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);se[8]=2*-t.x/this.width,se[9]=2*t.y/this.height,this.expandedFarZProjMatrix=n.cM([],se,_)}else this.expandedFarZProjMatrix=this.projMatrix;let z=n.bi([],x);this.frustumCorners=n.cQ.fromInvProjectionMatrix(z,this.horizonLineFromTop(),this.height),this.cameraFrustum=n.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!o);let P=new Float32Array(16);n.bx(P),n.cP(P,P,[1,-1,1]),n.cR(P,P,this._pitch),n.by(P,P,this.angle);let D=n.c9(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=n.bw(D);let N=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;D[8]=2*-t.x/this.width,D[9]=2*(t.y+N)/this.height,this.skyboxMatrix=n.az(P,D,P);let F=this.point,j=F.x,U=F.y,Z=this.width%2/2,Y=this.height%2/2,Q=Math.cos(this.angle),ne=Math.sin(this.angle),he=j-Math.round(j)+Q*Z+ne*Y,de=U-Math.round(U)+Q*Y+ne*Z,oe=new Float64Array(C);if(n.bo(oe,oe,[he>.5?he-1:he,de>.5?de-1:de,0]),this.alignedProjMatrix=oe,C=n.bz(),n.cP(C,C,[this.width/2,-this.height/2,1]),n.bo(C,C,[1,-1,0]),this.labelPlaneMatrix=C,C=n.bz(),n.cP(C,C,[1,-1,1]),n.bo(C,C,[-1,-1,0]),n.cP(C,C,[2/this.width,2/this.height,1]),this.glCoordMatrix=C,this.pixelMatrix=n.az(new Float64Array(16),this.labelPlaneMatrix,M),this._calcFogMatrices(),this._distanceTileDataCache={},C=n.bi(new Float64Array(16),this.pixelMatrix),!C)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=C,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=n.cS(this);let se=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=n.ad(se,se,_),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=C;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let t=this.cameraWorldSizeForFog,o=this.cameraPixelsPerMeter,c=this._camera.position,d=1/this.height/this._pixelsPerMercatorPixel,p=[t,t,o];n.c1(p,p,d),n.c1(c,c,-1),n.cT(c,c,p);let _=n.bz();n.bo(_,_,c),n.cP(_,_,p),this.mercatorFogMatrix=_,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,o,d)}_computeCameraPosition(t){let o=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),d=this.point,p=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*o-t/this.worldSize*this._centerAltitude;return[d.x/this.worldSize-c[0]*p,d.y/this.worldSize-c[1]*p,t/this.worldSize*this._centerAltitude-c[2]*p]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){let o=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],d=t[2],p=1;this.projection.wrap&&(this.center=this.center.wrap()),d>0&&(p=Math.min((o-c)/d,1)),this._camera.position=n.bE([],this._camera.position,t,p),this._updateStateFromCamera()}_updateStateFromCamera(){let t=this._camera.position,o=this._camera.forward(),{pitch:c,bearing:d}=this._camera.getPitchBearing(),p=n.cb(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,_=this._mercatorZfromZoom(this._maxZoom)*Math.cos(n.al(this._maxPitch)),x=Math.max((t[2]-p)/Math.cos(c),_),b=this._zoomFromMercatorZ(x);n.bE(t,t,o,x),this._pitch=n.ay(c,n.al(this.minPitch),n.al(this.maxPitch)),this.angle=n.bQ(d,-Math.PI,Math.PI),this._setZoom(n.ay(b,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new n.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){let t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let o=0,c=n.cI,d=0,p=1/0;for(;c-o>1e-6&&c>o;){let _=o+.5*(c-o),x=this.tileSize*Math.pow(2,_),b=this.getCameraToCenterDistance(this.projection,_,x),M=this.scaleZoom(b/(Math.max(0,t)*this.tileSize)),C=Math.abs(_-M);C<p&&(p=C,d=_),_<M?o=_:c=_}return d}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(n.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,o){let c=Math.min(t.x,o.x),d=Math.max(t.x,o.x),p=Math.min(t.y,o.y),_=Math.max(t.y,o.y);if(p<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;let x=[new n.P(c,p),new n.P(d,_),new n.P(c,_),new n.P(d,p)],b=this.renderWorldCopies?-3:0,M=this.renderWorldCopies?4:1;for(let C of x){let z=this.pointRayIntersection(C);if(z.t<0)return!0;let P=this.rayIntersectionCoordinate(z);if(P.x<b||P.y<0||P.x>M||P.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+n.cU(this.fovAboveCenter)>88||this.anyCornerOffEdge(new n.P(0,0),new n.P(this.width,this.height))}zoomDeltaToMovement(t,o){let c=n.ae(n.at([],this._camera.position,t)),d=this._zoomFromMercatorZ(c)+o;return c-this._mercatorZfromZoom(d)}getCameraPoint(){if(this.projection.name==="globe"){let t=function([o,c,d],p){let _=[o,c,d,1];n.aA(_,_,p);let x=_[3]=Math.max(_[3],1e-6);return _[0]/=x,_[1]/=x,_[2]/=x,_}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new n.P(t[0],t[1])}{let t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new n.P(0,t))}}getCameraToCenterDistance(t,o=this.zoom,c=this.worldSize){let d=n.cL(t,o,this.width,this.height,1024),p=t.pixelSpaceConversion(this.center.lat,c,d),_=.5/Math.tan(.5*this._fov)*this.height*p;return this.isOrthographic&&(_=n.ai(1,_,n.cZ(this.pitch>=cn?1:this.pitch/cn))),_}getWorldToCameraMatrix(){let t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&n.az(t,t,this.globeMatrix),t}getFrustum(t){return n.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}let ss=(l,t)=>{if(t>0&&l.terrain&&n.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let o=l.transform,c=Math.max(Math.abs(o._zoom-(l.minCutoffZoom-1)),1),d=o.isLODDisabled(!1)?n.af(60,45,o.pitch):n.af(30,15,o.pitch),p=o._farZ-o._nearZ,_=t*o.height,x=((1-(b=d))*o.cameraToCenterDistance+b*(o._farZ+_))*c;var b;return{shouldRenderCutoff:d<1,uniformValues:{u_cutoff_params:[o._nearZ,o._farZ,(x-o._nearZ)/p,(x-_-o._nearZ)/p]}}},An={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Rc{constructor(t,o){this.aabb=t,this.lastCascade=o}}class pg{add(t,o){let c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],o.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],o.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],o.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],o.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],o.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],o.max[2])):this.receivers[t.key]=new Rc(o,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,o,c){let d=n.d6.fromPoints(t.points),p=0;for(let _ in this.receivers){let x=this.receivers[_];if(!x||!d.intersectsAabb(x.aabb))continue;x.aabb.min=d.closestPoint(x.aabb.min),x.aabb.max=d.closestPoint(x.aabb.max);let b=x.aabb.getCorners();for(let M=0;M<c.length;M++){let C=!0;for(let z of b){let P=[z[0]*o,z[1]*o,z[2]];if(n.ad(P,P,c[M].matrix),P[0]<-1||P[0]>1||P[1]<-1||P[1]>1){C=!1;break}}if(x.lastCascade=M,p=Math.max(p,M),C)break}}return p+1}}class fg{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new pg,this._depthMode=new bt(t.context.gl.LEQUAL,bt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(An,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(An,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(An,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,o){let c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!o||!o.properties)return;let d=o.properties.get("shadow-intensity");if(!o.shadowsEnabled()||d<=0||(this._shadowLayerCount=c.style.order.reduce((N,F)=>{let j=c.style._mergedLayers[F];return N+(j.hasShadowPass()&&!j.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let p=c.context,_=An.shadowMapResolution,x=An.shadowMapResolution;if(this._cascades.length===0||An.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let N=0;N<An.cascadeCount;++N){let F=c._shadowMapDebug,j=p.gl,U=p.createFramebuffer(_,x,F,"texture"),Z=new n.T(p,{width:_,height:x,data:null},j.DEPTH_COMPONENT16);if(U.depthAttachment.set(Z.texture),F){let Y=new n.T(p,{width:_,height:x,data:null},j.RGBA8);U.colorAttachment.set(Y.texture)}this._cascades.push({framebuffer:U,texture:Z,matrix:[],far:0,boundingSphereRadius:0,frustum:new n.cy,scale:0})}}this.shadowDirection=hl(o);let b=0;if(t.elevation){let N=t.elevation,F=[1e4,-1e4];N.visibleDemTiles.filter(j=>j.dem).forEach(j=>{let U=j.dem.tree;F[0]=Math.min(F[0],U.minimums[0]),F[1]=Math.max(F[1],U.maximums[0])}),F[0]!==1e4&&(b=(F[1]-F[0])*N.exaggeration())}let M=1.5*t.cameraToCenterDistance,C=3*M,z=new Float64Array(16);for(let N=0;N<this._cascades.length;++N){let F=this._cascades[N],j=t.height/50,U=1;An.cascadeCount===1?U=C:N===0?U=M:(j=M,U=C);let[Z,Y]=ul(t,this.shadowDirection,j,U,An.shadowMapResolution,b);F.scale=t.scale,F.matrix=Z,F.boundingSphereRadius=Y,n.bi(z,F.matrix),F.frustum=n.cy.fromInvProjectionMatrix(z,1,0,!0),F.far=U}let P=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[P].far,this._cascades[P].far],this._uniformValues.u_shadow_intensity=d,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/An.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=An.shadowMapResolution,this._uniformValues.u_shadowmap_0=zn.ShadowMap0,this._uniformValues.u_shadowmap_1=zn.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let D=c.transform.elevation;for(let N of this._groundShadowTiles){let F={min:0,max:0};if(D){let j=D.getMinMaxForTile(N);j&&(F=j)}this.addShadowReceiver(N.toUnwrapped(),F.min,F.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,o){if(!this.enabled)return;let c=this.painter,d=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),d.viewport.set([0,0,An.shadowMapResolution,An.shadowMapResolution]);for(let p=0;p<this._numCascadesToRender;++p){c.currentShadowCascade=p,d.bindFramebuffer.set(this._cascades[p].framebuffer.framebuffer),d.clear({color:n.am.white,depth:1});for(let _ of t.order){let x=t._mergedLayers[_];if(!x.hasShadowPass()||x.isHidden(c.transform.zoom))continue;let b=t.getLayerSourceCache(x),M=b?o[b.id]:void 0;(x.type==="model"||M&&M.length)&&c.renderLayer(c,b,x,M)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let t=this.painter,o=t.style,c=t.context,d=c.gl,p=o.directionalLight,_=o.ambientLight;if(!p||!_)return;let x=[],b=ss(t,t.longestCutoffRange);b.shouldRenderCutoff&&x.push("RENDER_CUTOFF"),x.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&x.push("NORMAL_OFFSET");let M=Ma(o,p,_),C=new bt(d.LEQUAL,bt.ReadOnly,t.depthRangeFor3D),z=new Gt({func:d.EQUAL,mask:255},0,255,d.KEEP,d.KEEP,d.KEEP);for(let P of this._groundShadowTiles){let D=P.toUnwrapped(),N=t.isTileAffectedByFog(P),F=t.getOrCreateProgram("groundShadow",{defines:x,overrideFog:N});this.setupShadows(D,F),t.uploadCommonUniforms(c,F,D,null,b);let j={u_matrix:t.transform.calculateProjMatrix(D),u_ground_shadow_factor:M};F.draw(t,d.TRIANGLES,C,z,ti.multiply,Nt.disabled,j,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ti.unblended:ti.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){let o=this.painter.transform,c=o.calculatePosMatrix(t,o.worldSize);return n.az(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){return n.az(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,o,c){if(!this.enabled)return;let d=this.painter.transform,p=this.painter.context,_=p.gl,x=this._uniformValues,b=new Float64Array(16),M=d.calculatePosMatrix(t,d.worldSize);for(let C=0;C<this._cascades.length;C++)n.az(b,this._cascades[C].matrix,M),x[C===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(b),p.activeTexture.set(_.TEXTURE0+zn.ShadowMap0+C),this._cascades[C].texture.bindExtraParam(_.LINEAR,_.LINEAR,_.CLAMP_TO_EDGE,_.CLAMP_TO_EDGE,_.GREATER);if(this.useNormalOffset=!!c,this.useNormalOffset){let C=n.d4(t.canonical),z=2/d.tileSize*n.aj/An.shadowMapResolution,P=z*this._cascades[0].boundingSphereRadius,D=z*this._cascades[this._cascades.length-1].boundingSphereRadius,N=(c==="vector-tile"?1:3)*function(F,j,U,Z,Y){let Q=n.ay((F-22)/-22,0,1);return .125*(1-Q)+4*Q}(d.zoom);x.u_shadow_normal_offset=[C,P*N,D*N],x.u_shadow_bias=[1e-4,.0012,.012]}else x.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(p,x)}setupShadowsFromMatrix(t,o,c=!1){if(!this.enabled)return;let d=this.painter.context,p=d.gl,_=this._uniformValues,x=new Float64Array(16);for(let b=0;b<An.cascadeCount;b++)n.az(x,this._cascades[b].matrix,t),_[b===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(x),d.activeTexture.set(p.TEXTURE0+zn.ShadowMap0+b),this._cascades[b].texture.bindExtraParam(p.LINEAR,p.LINEAR,p.CLAMP_TO_EDGE,p.CLAMP_TO_EDGE,p.GREATER);if(this.useNormalOffset=c,c){let b=An.normalOffset;_.u_shadow_normal_offset=[1,b,b],_.u_shadow_bias=[6e-5,.0012,.012]}else _.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(d,_)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,o,c,d){if(d[2]>=0)return{};let p=function(b,M,C){let z=C/(1<<b.canonical.z);return new n.d6([b.canonical.x*z+b.wrap*C,b.canonical.y*z+b.wrap*C,0],[(b.canonical.x+1)*z+b.wrap*C,(b.canonical.y+1)*z+b.wrap*C,M])}(t,o,c).getCorners(),_=o/-d[2];d[0]<0?(n.d5(p[0],p[0],[d[0]*_,0,0]),n.d5(p[3],p[3],[d[0]*_,0,0])):d[0]>0&&(n.d5(p[1],p[1],[d[0]*_,0,0]),n.d5(p[2],p[2],[d[0]*_,0,0])),d[1]<0?(n.d5(p[0],p[0],[0,d[1]*_,0]),n.d5(p[1],p[1],[0,d[1]*_,0])):d[1]>0&&(n.d5(p[2],p[2],[0,d[1]*_,0]),n.d5(p[3],p[3],[0,d[1]*_,0]));let x={};return x.vertices=p,x.planes=[$s(p[1],p[0],p[4]),$s(p[2],p[1],p[5]),$s(p[3],p[2],p[6]),$s(p[0],p[3],p[7])],x}addShadowReceiver(t,o,c){this._receivers.add(t,n.d6.fromTileIdAndHeight(t,o,c))}getMaxCascadeForTile(t){let o=this._receivers.get(t);return o&&o.lastCascade?o.lastCascade:0}}function $s(l,t,o){let c=n.at([],o,t),d=n.at([],l,t),p=n.bF([],c,d),_=n.ae(p);return _===0?[0,0,1,0]:(n.c1(p,p,1/_),[p[0],p[1],p[2],-n.bG(p,t)])}function hl(l){let t=l.properties.get("direction"),o=n.d1(t.x,t.y,t.z);o[2]=n.ay(o[2],0,75);let c=n.d3([o[0],o[1],o[2]]);return n.d2(c.x,c.y,c.z)}function Ma(l,t,o){let c=t.properties.get("color-use-theme")==="none",d=t.properties.get("color"),p=t.properties.get("intensity"),_=t.properties.get("direction"),x=[_.x,_.y,_.z],b=o.properties.get("color-use-theme")==="none",M=o.properties.get("color"),C=o.properties.get("intensity"),z=Math.max(n.bG([0,0,1],x),0),P=[0,0,0];n.c1(P,M.toPremultipliedRenderColor(b?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),C);let D=[0,0,0];return n.c1(D,d.toPremultipliedRenderColor(c?null:l.getLut(o.scope)).toArray01Linear().slice(0,3),z*p),n.d8([P[0]>0?P[0]/(P[0]+D[0]):0,P[1]>0?P[1]/(P[1]+D[1]):0,P[2]>0?P[2]/(P[2]+D[2]):0])}function ul(l,t,o,c,d,p){let _=l.zoom,x=l.scale,b=l.worldSize,M=1/b,C=l.aspect,z=Math.sqrt(1+C*C)*Math.tan(.5*l.fovX),P=z*z,D=c-o,N=c+o,F,j;P>D/N?(F=c,j=c*z):(F=.5*N*(1+P),j=.5*Math.sqrt(D*D+2*(c*c+o*o)*P+N*N*P*P));let U=l.projection.pixelsPerMeter(l.center.lat,b),Z=l._camera.getCameraToWorldMercator(),Y=[0,0,-F*M];n.ad(Y,Y,Z);let Q=j*M,ne=l._edgeInsets;if(!(ne.left===0&&ne.top===0&&ne.right===0&&ne.bottom===0||ne.left===ne.right&&ne.top===ne.bottom)){let $e=l._camera.getWorldToCamera(l.worldSize,l.projection.zAxisUnit==="meters"?U:1),Ze=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,o,c);Ze[8]=2*-l.centerOffset.x/l.width,Ze[9]=2*l.centerOffset.y/l.height;let Ye=new Float64Array(16);n.cM(Ye,Ze,$e);let ct=new Float64Array(16);n.bi(ct,Ye);let Mt=n.cy.fromInvProjectionMatrix(ct,b,_,!0);for(let Ot of Mt.points){let yt=((he=Ot)[0]/=x,he[1]/=x,he[2]=n.cb(he[2],l._center.lat),he);Q=Math.max(Q,n.c2(n.d7([],Y,yt)))}}var he;Q*=d/(d-1);let de=Math.acos(t[2]),oe=Math.atan2(-t[0],-t[1]),se=new Oo;se.position=Y,se.setPitchBearing(de,oe);let le=se.getWorldToCamera(b,U),Me=Q*b,_e=Math.min(l._mercatorZfromZoom(17)*b*-2,-2*Me),Ve=se.getCameraToClipOrthographic(-Me,Me,-Me,Me,_e,(Me+p*U)/t[2]),ze=new Float64Array(16);n.az(ze,Ve,le);let je=n.d2(Math.floor(1e6*Y[0])/1e6*b,Math.floor(1e6*Y[1])/1e6*b,0),rt=.5*d,Ce=[0,0,0];n.ad(Ce,je,ze),n.c1(Ce,Ce,rt);let me=[Math.floor(Ce[0]),Math.floor(Ce[1]),Math.floor(Ce[2])],ke=[0,0,0];n.at(ke,Ce,me),n.c1(ke,ke,-1/rt);let Pe=new Float64Array(16);return n.bx(Pe),n.bo(Pe,Pe,ke),n.az(ze,Pe,ze),[ze,Me]}class Bf extends n.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,o){return n.aS(this.requestManager.transformRequest(o,n.R.Model).url).then(c=>{if(!c)return;let d=n.aT(c),p=new n.aU(t,void 0,void 0,d);return p.computeBoundsAndApplyParent(),p}).catch(c=>{if(c&&c.status===404)return null;this.fire(new n.z(new Error(`Could not load model ${t} from ${o}: ${c.message}`)))})}load(t,o,c={forceReload:!1}){this.models[o]||(this.models[o]={});let d=Object.keys(t),p=[],_=[];for(let x of d){let b=t[x];this.hasURLBeenRequested(b)&&!c.forceReload||(this.modelByURL[b]={modelId:x,scope:o},p.push(this.loadModel(x,b)),_.push(x)),this.models[o][x]||(this.models[o][x]={model:null,numReferences:1})}this.numModelsLoading[o]=(this.numModelsLoading[o]||0)+_.length,Promise.allSettled(p).then(x=>{for(let b=0;b<x.length;b++){let{status:M}=x[b];if(M==="rejected")continue;let{value:C}=x[b];this.models[o][_[b]]||(this.models[o][_[b]]={model:null,numReferences:1}),this.models[o][_[b]].model=C}this.numModelsLoading[o]-=_.length,this.fire(new n.A("data",{dataType:"style"}))}).catch(x=>{this.fire(new n.z(new Error(`Could not load models: ${x.message}`)))})}isLoaded(){for(let t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,o,c={exactIdMatch:!1}){return!!(c.exactIdMatch?this.getModel(t,o):this.getModelByURL(this.modelUris[o][t]))}getModel(t,o){return this.models[o]||(this.models[o]={}),this.models[o][t]?this.models[o][t].model:void 0}getModelByURL(t){if(!t)return null;let o=this.modelByURL[t];return o?this.models[o.scope][o.modelId].model:null}hasModelBeenAdded(t,o){return this.models[o]&&this.models[o][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,o,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});let d=this.requestManager.normalizeModelURL(o);if((this.hasModel(t,c,{exactIdMatch:!0})||this.hasModelBeenAdded(t,c))&&this.modelUris[c][t]===d)this.models[c][t].numReferences++;else if(this.hasURLBeenRequested(d)){let{scope:p,modelId:_}=this.modelByURL[d];this.models[p][_].numReferences++}else this.modelUris[c][t]=d,this.load({[t]:this.modelUris[c][t]},c)}addModelURLs(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let c=this.modelUris[o];for(let d in t)c[d]=this.requestManager.normalizeModelURL(t[d])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let c={};for(let d of t)this.hasModel(d,o,{exactIdMatch:!0})||this.hasURLBeenRequested(d)?this.models[o][d].numReferences++:this.modelUris[o][d]&&!this.hasURLBeenRequested(d)?c[d]=this.modelUris[o][d]:!this.hasURLBeenRequested(d)&&n.d9(d,!1)&&(this.modelUris[o][d]=this.requestManager.normalizeModelURL(d),c[d]=this.modelUris[o][d]);this.load(c,o)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,o,c=!1,d=!1){if(this.models[o]&&this.models[o][t]&&(this.models[o][t].numReferences--,this.models[o][t].numReferences===0||d)){let p=this.modelUris[o][t];c||delete this.modelUris[o][t],delete this.modelByURL[p];let _=this.models[o][t].model;if(!_)return;delete this.models[o][t],_.destroy()}}destroy(){for(let t of Object.keys(this.models))for(let o of Object.keys(this.models[t])){let c=this.models[t][o].model;delete this.models[t][o],c&&c.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,o){this.models[o]||(this.models[o]={});for(let c in this.models[o])this.models[o][c].model&&this.models[o][c].model.upload(t.context)}}let Dh=new n.a7({data:new n.a8(n.a5.colorTheme.data)});class gd{constructor(t){this._scope=t,this._buildingQueryParams={target:{featuresetId:"building-outline",importId:this._scope}},this._floorQueryParams={target:{featuresetId:"floor-outline",importId:this._scope}}}execute(t){let o=this._makeBuildingsQueryArea(t),c=this._makeFloorsQueryArea(t),d=t.queryRenderedFeatures(o,this._buildingQueryParams).filter(x=>x.properties.shape_type==="building").reduce((x,b)=>{let M=b.properties.id;return b.properties.shape_type!=="building"||x.some(C=>C.properties.id===M)||x.push(b),x},[]),p=t.queryRenderedFeatures(c,this._floorQueryParams).filter(x=>x.properties.shape_type==="floor").reduce((x,b)=>{let M=b.properties.id;return b.properties.shape_type!=="floor"||x.some(C=>C.properties.id===M)||x.push(b),x},[]),_=[t.getCenter().lng,t.getCenter().lat];return{floors:p,building:this._findBuildingAtCenter(_,d)||(d.length>0?d[0]:null)}}_makeBuildingsQueryArea(t){let o=t.transform.width,c=t.transform.height,d=Math.min(o,c),p=d*(1/8),_=d*(1/8),x=.5*(o-p),b=.5*(c-_);return[new n.P(x,b),new n.P(x+p,b+_)]}_makeFloorsQueryArea(t){let o=t.transform.width,c=t.transform.height,d=o*(2/3),p=c*(2/3),_=.5*(o-d),x=.5*(c-p);return[new n.P(_,x),new n.P(_+d,x+p)]}_findBuildingAtCenter(t,o){for(let c of o)if(c.geometry.type==="Polygon"&&this._pointInPolygon(t,c.geometry.coordinates[0]))return c;return null}_pointInPolygon(t,o){let c=!1;for(let d=0,p=o.length-1;d<o.length;p=d++){let _=o[d][0],x=o[d][1],b=o[p][1];x>t[1]!=b>t[1]&&t[0]<(o[p][0]-_)*(t[1]-x)/(b-x)+_&&(c=!c)}return c}}class Zs{constructor(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}setBuildingId(t){this._selectedBuildingId=t}setFloors(t){if(this._floors=t.filter(o=>o.properties.building_id===this._selectedBuildingId),!this._selectedFloorId||!this._floors.map(o=>o.properties.id).includes(this._selectedFloorId)){let o=this._floors.map(c=>({id:c.properties.id,level:c.properties.floor_level})).reduce((c,d)=>{let p=Math.abs(c.level-1),_=Math.abs(d.level-1);return _<p||_===p&&d.level>c.level?d:c});this._selectedFloorId=o.id}}setFloorId(t){this._selectedFloorId=t}getSelectedFloorId(){return this._selectedFloorId}getCurrentBuildingFloors(){return this._floors}reset(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}}let mg={"mbx-indoor-level-selected":{default:["literal",[]]}};function Nf(l){return l=l||{},Object.assign(l,mg)}class _g extends n.E{constructor(t){super(),n.aV(["_onLoad","_onMove"],this),this._map=t,this._floorSelectionState=new Zs,this._queryIndoor(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=null,this._floorSelectionState=null}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._indoorDataQuery?this.fire(new n.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._scope=t.scope,this._indoorDataQuery=new gd(this._scope)))}),this._map._addIndoorControl(),this._queryIndoor()}_onMove(){this._queryIndoor()}_queryIndoor(){if(!this._indoorDataQuery||!this._map.isStyleLoaded())return;if(this._map.transform.zoom<16)return void this._clearIndoorData();let t=this._indoorDataQuery.execute(this._map);t&&t.floors.length!==0?(this._floorSelectionState.getSelectedFloorId()||this._map._addIndoorControl(),this._selectFloors(t)):this._clearIndoorData()}_selectFloors(t){if(t.building)this._floorSelectionState.setBuildingId(t.building.properties.id),this._floorSelectionState.setFloors(t.floors),this._updateUI();else{let o=this._floorSelectionState.getSelectedFloorId();if(o&&t.floors.some(c=>c.properties.id===o))return;this._clearIndoorData()}}_clearIndoorData(){this._floorSelectionState.reset(),this._map._removeIndoorControl(),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[]])}_updateUI(){let t=this._floorSelectionState.getCurrentBuildingFloors().map(c=>({id:c.properties.id,name:c.properties.name,shortName:c.properties.floor_level,levelOrder:c.properties.floor_level})),o=this._floorSelectionState.getSelectedFloorId();o?(this._updateIndoorConfig(),this.fire(new n.A("indoorupdate",{selectedFloorId:o,floors:t}))):console.warn("IndoorManager: Selected floor is not set")}_updateIndoorConfig(){let t=this._floorSelectionState.getSelectedFloorId();t?this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[t]]):console.warn("IndoorManager: Selected floor is not set")}selectFloor(t){this._floorSelectionState.setFloorId(t),this._updateIndoorConfig()}}function Vf(l){if(!l.metadata||!l.metadata.content_area)return;let t=n.q.devicePixelRatio,{left:o,top:c,width:d,height:p}=l.metadata.content_area,_=o*t,x=c*t;return[_,x,_+d*t,x+p*t]}function Uf(l){if(l)return l.map(([t,o])=>[t*n.q.devicePixelRatio,o*n.q.devicePixelRatio])}class yd{constructor(t,o,c){this.id=t,this.scope=o,this.sourceCache=c,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){let t=new Map;if(!this.sourceCache.loaded())return t;let o=this.sourceCache.getVisibleCoordinates();if(o.length===0)return t;let c=this.sourceCache.getSource();if(!(c instanceof js))return t;let d=o.map(_=>this.sourceCache.getTile(_)),p=c.getImages(d,Array.from(this.pendingRequests));for(let[_,x]of p)t.set(n.I.from({name:_,iconsetId:this.id}),x),this.pendingRequests.delete(_);for(let _ of this.pendingRequests)this.missingRequests.add(_);return this.pendingRequests.clear(),t}}let Ws=(l,t)=>re(l,t&&t.filter(o=>o.identifier!=="source.canvas")),jf=n.aF(wi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),Gf=n.aF(wi,["setCenter","setZoom","setBearing","setPitch"]),Oh=new Set(["background","sky","slot","custom"]),Xs={version:8,layers:[],sources:{}},Lc={duration:300,delay:0};class ko extends n.E{constructor(t,o={}){super(),this.map=t,this.scope=o.scope||"",this.globalId=null,this.fragments=[],this.importDepth=o.importDepth||0,this.importsCache=o.importsCache||new Map,this.resolvedImports=o.resolvedImports||new Set,this.transition=n.h({},Lc),this._buildingIndex=new Pf(this),this.crossTileSymbolIndex=new Gn,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=o.styleChanges||new nc,this.dispatcher=o.dispatcher?o.dispatcher:new n.D(n.db(),this),o.imageManager?this.imageManager=o.imageManager:(this.imageManager=new zr(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=o.glyphManager?o.glyphManager:new n.dc(t._requestManager,o.localFontFamily?n.dd.all:o.localIdeographFontFamily?n.dd.ideographs:n.dd.none,o.localFontFamily||o.localIdeographFontFamily),o.modelManager?this.modelManager=o.modelManager:(this.modelManager=new Bf(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=o.configOptions?o.configOptions:new Map,this._configDependentLayers=o.configDependentLayers?o.configDependentLayers:new Set,this._config=o.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:o.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=o.initialConfig,this.dispatcher.broadcast("setReferrer",n.de());let c=this;this._rtlTextPluginCallback=ko.registerForPluginStateChange(d=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:d.pluginStatus,pluginURL:d.pluginURL},(p,_)=>{if(n.df(p),_&&_.every(x=>x))for(let x in c._sourceCaches){let b=c._sourceCaches[x],M=b.getSource().type;M!=="vector"&&M!=="geojson"||b.reload()}})}),this.on("data",d=>{if(d.dataType!=="source"||d.sourceDataType!=="metadata")return;let p=this.getOwnSource(d.sourceId);if(p&&p.vectorLayerIds)for(let _ in this._layers){let x=this._layers[_];x.source===p.id&&this._validateLayer(x)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(n.j(t))return t;let o=n.dg(t);if(!o.startsWith("http"))try{return new URL(o,location.href).toString()}catch{return o}return o}return`json://${n.dh(JSON.stringify(t))}`}_diffStyle(t,o,c){this.globalId=this._getGlobalId(t);let d=(p,_)=>{try{_(null,this.setState(p,c))}catch(x){_(x,!1)}};if(typeof t=="string"){let p=this.map._requestManager.normalizeStyleURL(t),_=this.map._requestManager.transformRequest(p,n.R.Style);n.n(_,(x,b)=>{x?this.fire(new n.z(x)):b&&d(b,o)})}else typeof t=="object"&&d(t,o)}loadURL(t,o={}){this.fire(new n.A("dataloading",{dataType:"style"}));let c=typeof o.validate=="boolean"?o.validate:!n.j(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,o.accessToken),this.resolvedImports.add(t);let d=this.importsCache.get(t);if(d)return this._load(d,c);let p=this.map._requestManager.transformRequest(t,n.R.Style);this._request=n.n(p,(_,x)=>{if(this._request=null,_)this.fire(new n.z(_));else if(x)return this.importsCache.set(t,x),this._load(x,c)})}loadJSON(t,o={}){this.fire(new n.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=n.q.frame(()=>{this._request=null,this._load(t,o.validate!==!1)})}loadEmpty(){this.fire(new n.A("dataloading",{dataType:"style"})),this._load(Xs,!1)}_loadImports(t,o,c){if(this.importDepth>=4)return n.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let d=[];for(let p of t){let _=this._createFragmentStyle(p),x=new Promise(C=>{_.once("style.import.load",C),_.once("error",C)}).then(()=>this.mergeAll());if(d.push(x),this.resolvedImports.has(p.url)){_.loadEmpty();continue}let b=p.data||this.importsCache.get(p.url);b?(_.loadJSON(b,{validate:o}),this._isInternalStyle(b)&&(_.globalId=null)):p.url?_.loadURL(p.url,{validate:o}):_.loadEmpty();let M={style:_,id:p.id,config:p.config};if(c){let C=this.fragments.findIndex(({id:z})=>z===c);this.fragments=this.fragments.slice(0,C).concat(M).concat(this.fragments.slice(C))}else this.fragments.push(M)}return Promise.allSettled(d)}getImportGlobalIds(t=this,o=new Set){for(let c of t.fragments)c.style.globalId&&o.add(c.style.globalId),this.getImportGlobalIds(c.style,o);return[...o.values()]}_createFragmentStyle(t){let o=this.scope?n.C(t.id,this.scope):t.id,c,d=this._initialConfig&&this._initialConfig[o];(t.config||d)&&(c=n.h({},t.config,d));let p=new ko(this.map,{scope:o,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return p.setEventedParent(this.map,{style:p}),p}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,o){let c=t.indoor?Nf(t.schema):t.schema;if(this._isInternalStyle(t)){let _=n.h({},Xs,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(_,o)}if(this.updateConfig(this._config,c),o&&Ws(this,po(t)))return;this._loaded=!0,this.stylesheet=n.di(t);let d=()=>{for(let M in t.sources)this.addSource(M,t.sources[M],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(let M in t.iconsets)this.addIconset(M,t.iconsets[M]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);let _=yc(this.stylesheet.layers);if(this._order=_.map(M=>M.id),this.stylesheet.light&&n.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){let M=this.stylesheet.lights[0];this.light=new De(M.properties,M.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new De(this.stylesheet.light)),this._layers={};for(let M of _){let C=n.dn(M,this.scope,this._styleColorTheme.lut,this.options);C.configDependencies.size!==0&&this._configDependentLayers.add(C.fqid),C.setEventedParent(this,{layer:{id:C.id}}),this._layers[C.id]=C;let z=this.getOwnLayerSourceCache(C),P=!!this.directionalLight&&this.directionalLight.shadowsEnabled();z&&C.canCastShadows()&&P&&(z.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);let x=this.stylesheet.terrain;x&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(x,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new n.A("data",{dataType:"style"}));let b=this.isRootStyle();t.imports?this._loadImports(t.imports,o).then(()=>{this._reloadImports(),this.fire(new n.A(b?"style.load":"style.import.load"))}).catch(M=>{this.fire(new n.z(new Error("Failed to load imports",M))),this.fire(new n.A(b?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new n.A(b?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];let p=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(p){let _=this._evaluateColorThemeData(p);this._loadColorTheme(_).then(()=>{d()}).catch(x=>{n.w(`Couldn't load color theme from the stylesheet: ${x}`),d()})}else this._styleColorTheme.lut=null,d()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,o,c,d,p,_,x,b,M,C,z={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(P=>{if(P.stylesheet){if(P.light!=null&&(t=P.light),P.stylesheet.lights)for(let D of P.stylesheet.lights)D.type==="ambient"&&P.ambientLight!=null&&(o=P.ambientLight),D.type==="directional"&&P.directionalLight!=null&&(c=P.directionalLight);d=this._prioritizeTerrain(d,P.terrain,P.stylesheet.terrain),P.stylesheet.fog&&P.fog!=null&&(p=P.fog),P.stylesheet.snow&&P.snow!=null&&(_=P.snow),P.stylesheet.rain&&P.rain!=null&&(x=P.rain),P.stylesheet.camera!=null&&(C=P.stylesheet.camera),P.stylesheet.projection!=null&&(b=P.stylesheet.projection),P.stylesheet.transition!=null&&(M=P.stylesheet.transition),z[P.scope]=P._styleColorTheme}}),this.light=t,this.ambientLight=o,this.directionalLight=c,this.fog=p,this.snow=_,this.rain=x,this._styleColorThemeForScope=z,d===null?delete this.terrain:this.terrain=d,this.camera=C||{"camera-projection":"perspective"},this.projection=b||{name:"mercator"},this.transition=n.h({},Lc,M),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){let o=c=>{for(let d of c.fragments)o(d.style);t(c)};o(this)}_prioritizeTerrain(t,o,c){let d=t&&t.drapeRenderMode===0;return c===null?o&&o.drapeRenderMode===0?o:d?t:null:o!=null&&(!t||d||o&&o.drapeRenderMode===1)?o:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(o=>{t=this._prioritizeTerrain(t,o.terrain,o.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(o=>{o.stylesheet.projection!=null&&(t=o.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){let t={},o={},c={};this.forEachFragmentStyle(d=>{for(let p in d._sourceCaches){let _=n.C(p,d.scope);t[_]=d._sourceCaches[p]}for(let p in d._otherSourceCaches){let _=n.C(p,d.scope);o[_]=d._otherSourceCaches[p]}for(let p in d._symbolSourceCaches){let _=n.C(p,d.scope);c[_]=d._symbolSourceCaches[p]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=o,this._mergedSymbolSourceCaches=c}mergeLayers(){let t={},o=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(p=>{for(let _ of p._order){let x=p._layers[_];if(x.type==="slot"){let b=n.dj(_);if(t[b])continue;t[b]=[]}x.slot&&t[x.slot]?t[x.slot].push(x):o.push(x)}}),this._mergedOrder=[];let d=(p=[])=>{for(let _ of p)if(_.type==="slot"){let x=n.dj(_.id);t[x]&&d(t[x]),this._mergedSlots.push(x)}else{let x=n.C(_.id,_.scope);this._mergedOrder.push(x),c[x]=_,_.is3D(!!this.terrain)&&(this._has3DLayers=!0),_.type==="circle"&&(this._hasCircleLayers=!0),_.type==="symbol"&&(this._hasSymbolLayers=!0),_.type==="clip"&&(this._clipLayerPresent=!0)}};d(o),this._mergedOrder.sort((p,_)=>{let x=c[p],b=c[_];return x.hasInitialOcclusionOpacityProperties?b.is3D(!!this.terrain)?1:0:x.is3D(!!this.terrain)&&b.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=n.h({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(o,c,d,p){let _=n.h({},c);for(let b of Object.keys(n.a5.colorTheme))_[b]===void 0&&(_[b]=n.a5.colorTheme[b].default);let x=new n.a6(Dh,o,new Map(d));return x.setTransitionOrValue(_,d),x.untransitioned().possiblyEvaluate(new n.aa(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let o=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((c,d)=>{let p="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let _=t;_.startsWith(p)||(_=p+_);let x=n.I.from("mapbox-reserved-lut"),b=new Image;b.src=_,b.onerror=()=>{this._styleColorTheme.lutLoading=!1,d(new Error("Failed to load image data"))},b.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==o)return void c();this._styleColorTheme.lutLoading=!1;let{width:M,height:C,data:z}=n.q.getImageData(b);if(C>32)return void d(new Error("The height of the image must be less than or equal to 32 pixels."));if(M!==C*C)return void d(new Error("The width of the image must be equal to the height squared."));this.getImage(x)&&this.removeImage(x),this.addImage(x,{data:new n.r({width:M,height:C},z),pixelRatio:1,sdf:!1,usvg:!1,version:0});let P=this.imageManager.getImage(x,this.scope);P?(this._styleColorTheme.lut={image:P.data,data:t},c()):d(new Error("Missing LUT image."))}})}getLut(t){let o=this._styleColorThemeForScope[t];return o?o.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(o,c,d){let p,_,x,b=n.q.devicePixelRatio>1?"@2x":"",M=n.n(c.transformRequest(c.normalizeSpriteURL(o,b,".json"),n.R.SpriteJSON),(P,D)=>{M=null,x||(x=P,p=D,z())}),C=n.o(c.transformRequest(c.normalizeSpriteURL(o,b,".png"),n.R.SpriteImage),(P,D)=>{C=null,x||(x=P,_=D,z())});function z(){if(x)d(x);else if(p&&_){let P=n.q.getImageData(_),D={};for(let N in p){let{width:F,height:j,x:U,y:Z,sdf:Y,pixelRatio:Q,stretchX:ne,stretchY:he,content:de}=p[N],oe=new n.r({width:F,height:j});n.r.copy(P,oe,{x:U,y:Z},{x:0,y:0},{width:F,height:j},null),D[N]={data:oe,pixelRatio:Q,sdf:Y,stretchX:ne,stretchY:he,content:de,usvg:!1}}d(null,D)}}return{cancel(){M&&(M.cancel(),M=null),C&&(C.cancel(),C=null)}}}(t,this.map._requestManager,(o,c)=>{if(this._spriteRequest=null,o)this.fire(new n.z(o));else if(c){let d=new Map;for(let p in c)d.set(n.I.from(p),c[p]);this.addImages(d)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new n.A("data",{dataType:"style"}))})}addIconset(t,o){if(o.type==="sprite")return void this._loadSprite(o.url);let c=this.getOwnSourceCache(o.source);if(!c)return void this.fire(new n.z(new Error(`Source "${o.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));let d=c.getSource();if(d.type!=="raster-array")return void this.fire(new n.z(new Error(`Source "${o.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));d.partial=!1;let p=new yd(t,this.scope,c);this.imageManager.addImageProvider(p,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!n.j(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);let o=this.map._spriteFormat==="auto";var c,d;this._spriteRequest=(d=(p,_)=>{if(this._spriteRequest=null,p)o?this._loadSprite(t):this.fire(new n.z(p));else if(_){let x=new Map;for(let b in _)x.set(n.I.from(b),_[b]);this.addImages(x)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new n.A("data",{dataType:"style"}))},n.br((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),n.R.Iconset),(p,_)=>{if(p)return void d(p);let x={},b=n.da(new n.bq(_));for(let M of b.icons){let C={version:1,pixelRatio:n.q.devicePixelRatio,content:Vf(M),stretchX:M.metadata?Uf(M.metadata.stretch_x_areas):void 0,stretchY:M.metadata?Uf(M.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:M};x[M.name]=C}d(null,x)}))}_validateLayer(t){let o=this.getOwnSource(t.source);if(!o)return;let c=t.sourceLayer;c&&(o.type==="geojson"||o.vectorLayerIds&&o.vectorLayerIds.indexOf(c)===-1)&&this.fire(new n.z(new Error(`Source layer "${c}" does not exist on source "${o.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,o)=>{let c=this.fragments[o];return c&&c.style&&(t.data=c.style.serialize()),t})}_serializeSources(){let t={};for(let o in this._sourceCaches){let c=this._sourceCaches[o].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){let o=[];for(let c of t){let d=this._layers[c];d&&d.type!=="custom"&&o.push(d.serialize())}return o}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(let t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(let t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){let o=this.getOwnLayer(t);if(o)return o;this.fire(new n.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){let o=this.getOwnSource(t);if(o)return o;this.fire(new n.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,o){let c=this.map.painter;if(c)for(let d=t.minzoom||0;d<(t.maxzoom||25.5);d++){let p=t.getProgramIds();if(p)for(let _ of p){let x=t.getDefaultProgramParams(_,o.zoom,this._styleColorTheme.lut);x&&(c.style=this,this.fog&&(c._fogVisible=!0,x.overrideFog=!0,c.getOrCreateProgram(_,x)),c._fogVisible=!1,x.overrideFog=!1,c.getOrCreateProgram(_,x),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(x.overrideRtt=!0,c.getOrCreateProgram(_,x)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);let o=this.calculateLightsBrightness();t.brightness=o||0,o!==this._brightness&&(this._brightness=o,this.dispatcher.broadcast("setBrightness",o)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));let c=this._changes.isDirty(),d=!1;if(this._changes.isDirty()){let x=this._changes.getLayerUpdatesByScope();for(let b in x){let{updatedIds:M,removedIds:C}=x[b];(M||C)&&(this._updateWorkerLayers(b,M,C),d=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}let p={};for(let x in this._mergedSourceCaches){let b=this._mergedSourceCaches[x];p[x]=b.used,b.used=!1,b.tileCoverLift=0}for(let x of this._mergedOrder){let b=this._mergedLayers[x];if(b.recalculate(t,this._availableImages),!b.isHidden(t.zoom)){let M=this.getLayerSourceCache(b);M&&(M.used=!0,M.tileCoverLift=Math.max(M.tileCoverLift,b.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(b,t)}):this.precompilePrograms(b,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&d&&this.mergeLayers();let _=this.imageManager.getPendingImageProviders();for(let x of _)x.sourceCache.used=!0;for(let x in p){let b=this._mergedSourceCaches[x];p[x]!==b.used&&b.getSource().fire(new n.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:b.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),c&&this.fire(new n.A("data",{dataType:"style"}))}updateImageProviders(){let t=this.imageManager.getPendingImageProviders();for(let o of t){let c=o.resolvePendingRequests(),d=this.getFragmentStyle(o.scope);d&&d.addImages(c)}}_updateTilesForChangedImages(){let t={};for(let o in this._mergedSourceCaches){let c=this._mergedSourceCaches[o].getSource().scope;t[c]=t[c]||this._changes.getUpdatedImages(c),t[c].length!==0&&this._mergedSourceCaches[o].reloadTilesForDependencies(["icons","patterns"],t[c])}for(let o in t)this._changes.resetUpdatedImages(o)}_updateWorkerLayers(t,o,c){let d=this.getFragmentStyle(t);d&&this.dispatcher.broadcast("updateLayers",{layers:o?d._serializeLayers(o):[],scope:t,removedIds:c||[],options:d.options})}setState(t,o){if(this._checkLoaded(),Ws(this,po(t)))return!1;(t=n.di(t)).layers=yc(t.layers);let c=function(_,x){if(!_)return[{command:wi.setStyle,args:[x]}];let b=[];try{if(!n.bv(_.version,x.version))return[{command:wi.setStyle,args:[x]}];if(n.bv(_.center,x.center)||b.push({command:wi.setCenter,args:[x.center]}),n.bv(_.zoom,x.zoom)||b.push({command:wi.setZoom,args:[x.zoom]}),n.bv(_.bearing,x.bearing)||b.push({command:wi.setBearing,args:[x.bearing]}),n.bv(_.pitch,x.pitch)||b.push({command:wi.setPitch,args:[x.pitch]}),n.bv(_.sprite,x.sprite)||b.push({command:wi.setSprite,args:[x.sprite]}),n.bv(_.glyphs,x.glyphs)||b.push({command:wi.setGlyphs,args:[x.glyphs]}),n.bv(_.imports,x.imports)||function(D=[],N=[],F){N=N||[];let j=(D=D||[]).map(Ta),U=N.map(Ta),Z=D.reduce(Gs,{}),Y=N.reduce(Gs,{}),Q=j.slice(),ne,he,de,oe;for(ne=0,he=0;ne<j.length;ne++)de=j[ne],Y.hasOwnProperty(de)?he++:(F.push({command:wi.removeImport,args:[de]}),Q.splice(Q.indexOf(de,he),1));for(ne=0,he=0;ne<U.length;ne++)de=U[U.length-1-ne],Q[Q.length-1-ne]!==de&&(Z.hasOwnProperty(de)?(F.push({command:wi.removeImport,args:[de]}),Q.splice(Q.lastIndexOf(de,Q.length-he),1)):he++,oe=Q[Q.length-ne],F.push({command:wi.addImport,args:[Y[de],oe]}),Q.splice(Q.length-ne,0,de));for(let se of N){let le=Z[se.id];le&&(delete le.data,n.bv(le,se)||F.push({command:wi.updateImport,args:[se.id,se]}))}}(_.imports,x.imports,b),n.bv(_.transition,x.transition)||b.push({command:wi.setTransition,args:[x.transition]}),n.bv(_.light,x.light)||b.push({command:wi.setLight,args:[x.light]}),n.bv(_.fog,x.fog)||b.push({command:wi.setFog,args:[x.fog]}),n.bv(_.snow,x.snow)||b.push({command:wi.setSnow,args:[x.snow]}),n.bv(_.rain,x.rain)||b.push({command:wi.setRain,args:[x.rain]}),n.bv(_.projection,x.projection)||b.push({command:wi.setProjection,args:[x.projection]}),n.bv(_.lights,x.lights)||b.push({command:wi.setLights,args:[x.lights]}),n.bv(_.camera,x.camera)||b.push({command:wi.setCamera,args:[x.camera]}),n.bv(_.iconsets,x.iconsets)||function(D,N,F){let j;for(j in N=N||{},D=D||{})D.hasOwnProperty(j)&&(N.hasOwnProperty(j)||F.push({command:wi.removeIconset,args:[j]}));for(j in N){if(!N.hasOwnProperty(j))continue;let U=N[j];D.hasOwnProperty(j)?n.bv(D[j],U)||(F.push({command:wi.removeIconset,args:[j]}),F.push({command:wi.addIconset,args:[j,U]})):F.push({command:wi.addIconset,args:[j,U]})}}(_.iconsets,x.iconsets,b),!n.bv(_["color-theme"],x["color-theme"]))return[{command:wi.setStyle,args:[x]}];let M={},C=[];(function(D,N,F,j){let U;for(U in N=N||{},D=D||{})D.hasOwnProperty(U)&&(N.hasOwnProperty(U)||il(U,F,j));for(U in N){if(!N.hasOwnProperty(U))continue;let Z=N[U];D.hasOwnProperty(U)?n.bv(D[U],Z)||(D[U].type==="geojson"&&Z.type==="geojson"&&ug(D,N,U)?F.push({command:wi.setGeoJSONSourceData,args:[U,Z.data]}):xc(U,N,F,j)):Mh(U,N,F)}})(_.sources,x.sources,C,M);let z=[];_.layers&&_.layers.forEach(D=>{D.source&&M[D.source]?b.push({command:wi.removeLayer,args:[D.id]}):z.push(D)});let P=_.terrain;P&&M[P.source]&&(b.push({command:wi.setTerrain,args:[void 0]}),P=void 0),b=b.concat(C),n.bv(P,x.terrain)||b.push({command:wi.setTerrain,args:[x.terrain]}),function(D,N,F){N=N||[];let j=(D=D||[]).map(Ta),U=N.map(Ta),Z=D.reduce(Gs,{}),Y=N.reduce(Gs,{}),Q=j.slice(),ne=Object.create(null),he,de,oe,se,le,Me,_e;for(he=0,de=0;he<j.length;he++)oe=j[he],Y.hasOwnProperty(oe)?de++:(F.push({command:wi.removeLayer,args:[oe]}),Q.splice(Q.indexOf(oe,de),1));for(he=0,de=0;he<U.length;he++)oe=U[U.length-1-he],Q[Q.length-1-he]!==oe&&(Z.hasOwnProperty(oe)?(F.push({command:wi.removeLayer,args:[oe]}),Q.splice(Q.lastIndexOf(oe,Q.length-de),1)):de++,Me=Q[Q.length-he],F.push({command:wi.addLayer,args:[Y[oe],Me]}),Q.splice(Q.length-he,0,oe),ne[oe]=!0);for(he=0;he<U.length;he++)if(oe=U[he],se=Z[oe],le=Y[oe],!ne[oe]&&!n.bv(se,le))if(n.bv(se.source,le.source)&&n.bv(se["source-layer"],le["source-layer"])&&n.bv(se.type,le.type)){for(_e in vc(se.layout,le.layout,F,oe,null,wi.setLayoutProperty),vc(se.paint,le.paint,F,oe,null,wi.setPaintProperty),n.bv(se.slot,le.slot)||F.push({command:wi.setSlot,args:[oe,le.slot]}),n.bv(se.filter,le.filter)||F.push({command:wi.setFilter,args:[oe,le.filter]}),n.bv(se.minzoom,le.minzoom)&&n.bv(se.maxzoom,le.maxzoom)||F.push({command:wi.setLayerZoomRange,args:[oe,le.minzoom,le.maxzoom]}),se)se.hasOwnProperty(_e)&&_e!=="layout"&&_e!=="paint"&&_e!=="filter"&&_e!=="metadata"&&_e!=="minzoom"&&_e!=="maxzoom"&&_e!=="slot"&&(_e.indexOf("paint.")===0?vc(se[_e],le[_e],F,oe,_e.slice(6),wi.setPaintProperty):n.bv(se[_e],le[_e])||F.push({command:wi.setLayerProperty,args:[oe,_e,le[_e]]}));for(_e in le)le.hasOwnProperty(_e)&&!se.hasOwnProperty(_e)&&_e!=="layout"&&_e!=="paint"&&_e!=="filter"&&_e!=="metadata"&&_e!=="minzoom"&&_e!=="maxzoom"&&_e!=="slot"&&(_e.indexOf("paint.")===0?vc(se[_e],le[_e],F,oe,_e.slice(6),wi.setPaintProperty):n.bv(se[_e],le[_e])||F.push({command:wi.setLayerProperty,args:[oe,_e,le[_e]]}))}else F.push({command:wi.removeLayer,args:[oe]}),Me=Q[Q.lastIndexOf(oe)+1],F.push({command:wi.addLayer,args:[le,Me]})}(z,x.layers,b)}catch(M){console.warn("Unable to compute style diff:",M),b=[{command:wi.setStyle,args:[x]}]}return b}(this.serialize(),t).filter(_=>!(_.command in Gf));if(c.length===0)return!1;let d=c.filter(_=>!(_.command in jf));if(d.length>0)throw new Error(`Unimplemented: ${d.map(_=>_.command).join(", ")}.`);let p=[];return c.forEach(_=>{p.push(this[_.command](..._.args))}),o&&Promise.all(p).then(o).catch(o),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(let[o,c]of t.entries()){if(this.getImage(o))return this.fire(new n.z(new Error(`An image with the name "${o.name}" already exists.`)));this.imageManager.addImage(o,this.scope,c),this._changes.updateImage(o,this.scope)}return this._updateWorkerImages(),this.fire(new n.A("data",{dataType:"style"})),this}addImage(t,o){return this.getImage(t)?this.fire(new n.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,o),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new n.A("data",{dataType:"style"})),this)}updateImage(t,o,c=!1){this.imageManager.updateImage(t,this.scope,o),c&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new n.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new n.A("data",{dataType:"style"})),this):this.fire(new n.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new n.A("data",{dataType:"style"})),this}addModel(t,o,c={}){return this._checkLoaded(),this._validate(ie,`models.${t}`,o,null,c)||(this.modelManager.addModel(t,o,this.scope),this.fire(new n.A("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new n.A("data",{dataType:"style"})),this):this.fire(new n.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,o,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!o.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(o).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(o.type)>=0&&this._validate(cc,`sources.${t}`,o,null,c))return;this.map&&this.map._collectResourceTiming&&(o.collectResourceTiming=!0);let d=dc(t,o,this.dispatcher,this);d.scope=this.scope,d.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(d.id),source:d.serialize(),sourceId:d.id}));let p=_=>{let x=(_?"symbol:":"other:")+d.id,b=n.C(x,this.scope),M=this._sourceCaches[x]=new jn(b,d,_);(_?this._symbolSourceCaches:this._otherSourceCaches)[d.id]=M,M.onAdd(this.map)};p(!1),o.type!=="vector"&&o.type!=="geojson"||p(!0),d.onAdd&&d.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();let o=this.getOwnSource(t);if(!o)throw new Error("There is no source with this ID");for(let d in this._layers)if(this._layers[d].source===t)return this.fire(new n.z(new Error(`Source "${t}" cannot be removed while layer "${d}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new n.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){let d=Object.entries(this.stylesheet.iconsets).find(([p,_])=>_.type==="source"&&_.source===t);if(d)return this.fire(new n.z(new Error(`Source "${t}" cannot be removed while iconset "${d[0]}" is using it.`)))}let c=this.getOwnSourceCaches(t);for(let d of c){let p=n.dj(d.id);delete this._sourceCaches[p],this._changes.discardSourceCacheUpdate(d.id),d.fire(new n.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:d.getSource().id})),d.setEventedParent(null),d.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),o.setEventedParent(null),o.onRemove&&o.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,o){this._checkLoaded(),this.getOwnSource(t).setData(o),this._changes.setDirty()}getOwnSource(t){let o=this.getOwnSourceCache(t);return o&&o.getSource()}getOwnSources(){let t=[];for(let o in this._otherSourceCaches){let c=this.getOwnSourceCache(o);c&&t.push(c.getSource())}return t}areTilesLoaded(){let t=this._mergedSourceCaches;for(let o in t){let c=t[o]._tiles;for(let d in c){let p=c[d];if(p.state!=="loaded"&&p.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;let o=this._getTransitionParameters();for(let p of t){if(this._validate(Qa,"lights",p))return;switch(p.type){case"ambient":if(this.ambientLight){let _=this.ambientLight;_.set(p),_.updateTransitions(o)}else this.ambientLight=new Hi(p,pi||(pi=new n.a7({color:new n.a8(n.a5.properties_light_ambient.color),"color-use-theme":new n.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new n.a8(n.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let _=this.directionalLight;_.set(p),_.updateTransitions(o)}else this.directionalLight=new Hi(p,Mr||(Mr=new n.a7({direction:new n.an(n.a5.properties_light_directional.direction),color:new n.a8(n.a5.properties_light_directional.color),"color-use-theme":new n.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new n.a8(n.a5.properties_light_directional.intensity),"cast-shadows":new n.a8(n.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new n.a8(n.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new n.a8(n.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let c=Object.assign(o,{worldview:this.map.getWorldview()}),d=new n.aa(this.z||0,c);this.ambientLight&&this.ambientLight.recalculate(d),this.directionalLight&&this.directionalLight.recalculate(d),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let t=this.directionalLight,o=this.ambientLight;if(!t||!o)return;let c=P=>.2126*(P[0]<=.03928?P[0]/12.92:Math.pow((P[0]+.055)/1.055,2.4))+.7152*(P[1]<=.03928?P[1]/12.92:Math.pow((P[1]+.055)/1.055,2.4))+.0722*(P[2]<=.03928?P[2]/12.92:Math.pow((P[2]+.055)/1.055,2.4)),d=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),p=t.properties.get("intensity"),_=t.properties.get("direction"),x=1-n.d1(_.x,_.y,_.z)[2]/90,b=c(d)*p*x,M=o.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),C=o.properties.get("intensity"),z=c(M)*C;return Number(((b+z)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(n.dk(t)){let o=n.dl(t),c=this.fragments.find(({id:p})=>p===o);if(!c)return;let d=n.dj(t);return c.style.getFragmentStyle(d)}{let o=this.fragments.find(({id:c})=>c===t);return o?o.style:void 0}}setFeaturesetSelectors(t){if(!t)return;let o={},c=(d,p="")=>`${d}::${p}`;this._featuresetSelectors={};for(let d in t){let p=this._featuresetSelectors[d]=[];for(let _ of t[d].selectors){if(_.featureNamespace){let b=this.getOwnLayer(_.layer);if(!b){n.w(`Layer is undefined for selector: ${_.layer}`);continue}let M=c(b.source,b.sourceLayer);if(M in o&&o[M]!==_.featureNamespace){n.w(`"featureNamespace ${_.featureNamespace} of featureset ${d}'s selector is not associated to the same source, skip this selector`);continue}o[M]=_.featureNamespace}let x;if(_.properties)for(let b in _.properties){let M=n.X(_.properties[b]);M.result==="success"&&(x=x||{},x[b]=M.value)}p.push({layerId:_.layer,namespace:_.featureNamespace,properties:x,uniqueFeatureID:_._uniqueFeatureID})}}}getFeaturesetDescriptors(t){let o=this.getFragmentStyle(t);if(!o||!o.stylesheet.featuresets)return[];let c=[];for(let d in o.stylesheet.featuresets)c.push({featuresetId:d,importId:o.scope?o.scope:void 0});return c}getFeaturesetLayers(t,o){let c=this.getFragmentStyle(o),d=c.stylesheet.featuresets;if(!d||!d[t])return this.fire(new n.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];let p=[];for(let _ of d[t].selectors){let x=c.getOwnLayer(_.layer);x&&p.push(x)}return p}getConfigProperty(t,o){let c=this.getFragmentStyle(t);if(!c)return null;let d=n.C(o,c.scope),p=c.options.get(d),_=p?p.value||p.default:null;return _?_.serialize():null}setConfigProperty(t,o,c){let d=this.getFragmentStyle(t);if(!d)return;let p=d.stylesheet.indoor?Nf(d.stylesheet.schema):d.stylesheet.schema;if(!p||!p[o])return;let _=n.X(c);if(_.result!=="success")return void Ws(this,_.value);let x=_.value.expression,b=n.C(o,d.scope),M=d.options.get(b);if(!M)return;let C,{minValue:z,maxValue:P,stepValue:D,type:N,values:F}=p[o],j=n.X(p[o].default);j.result==="success"&&(C=j.value.expression),C?(this.options.set(b,Object.assign({},M,{value:x,default:C,minValue:z,maxValue:P,stepValue:D,type:N,values:F})),this.updateConfigDependencies(o)):this.fire(new n.z(new Error(`No schema defined for the config option "${o}" in the "${t}" fragment.`)))}getConfig(t){let o=this.getFragmentStyle(t);if(!o)return null;let c=o.stylesheet.schema;if(!c)return null;let d={};for(let p in c){let _=n.C(p,o.scope),x=o.options.get(_),b=x?x.value||x.default:null;d[p]=b?b.serialize():null}return d}setConfig(t,o){let c=this.getFragmentStyle(t);c&&(c.updateConfig(o,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){let o=this.getFragmentStyle(t);return o?o.stylesheet.schema:null}setSchema(t,o){let c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=o,c.updateConfig(c._config,o),this.updateConfigDependencies())}updateConfig(t,o){if(this._config=t,t||o)if(o)for(let c in o){let d,p,_=n.X(o[c].default);if(_.result==="success"&&(d=_.value.expression),t&&t[c]!==void 0){let P=n.X(t[c]);P.result==="success"&&(p=P.value.expression)}let{minValue:x,maxValue:b,stepValue:M,type:C,values:z}=o[c];if(d){let P=n.C(c,this.scope);this.options.set(P,{default:d,value:p,minValue:x,maxValue:b,stepValue:M,type:C,values:z})}else this.fire(new n.z(new Error(`No schema defined for config option "${c}".`)))}else this.fire(new n.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(let o of this._configDependentLayers){let c=this.getLayer(o);if(c){if(t&&!c.configDependencies.has(t))continue;c.possiblyEvaluateVisibility(),this._updateLayer(c)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(o=>{let c=o._styleColorTheme.colorThemeOverride?o._styleColorTheme.colorThemeOverride:o._styleColorTheme.colorTheme;if(c){let d=o._evaluateColorThemeData(c);(!o._styleColorTheme.lut&&d!==""||o._styleColorTheme.lut&&d!==o._styleColorTheme.lut.data)&&o.setColorTheme(c)}}),this._changes.setDirty()}addLayer(t,o,c={}){this._checkLoaded();let d=t.id;if(this._layers[d])return void this.fire(new n.z(new Error(`Layer with id "${d}" already exists on this map`)));let p;if(t.type==="custom"){if(Ws(this,n.dm(t)))return;p=n.dn(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(d,t.source),t=n.di(t),t=n.h(t,{source:d})),this._validate(Ai,`layers.${d}`,t,{arrayIndex:-1},c))return;p=n.dn(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(p),p.setEventedParent(this,{layer:{id:d}})}p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid);let _=this._order.length;if(o){let C=this._order.indexOf(o);if(C===-1)return void this.fire(new n.z(new Error(`Layer with id "${o}" does not exist on this map.`)));p.slot===this._layers[o].slot?_=C:n.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(_,0,d),this._layerOrderChanged=!0,this._layers[d]=p;let x=this.getOwnLayerSourceCache(p),b=!!this.directionalLight&&this.directionalLight.shadowsEnabled();x&&p.canCastShadows()&&b&&(x.castsShadows=!0);let M=this._changes.getRemovedLayer(p);if(M&&p.source&&x&&p.type!=="custom"){this._changes.discardLayerRemoval(p);let C=n.C(p.source,p.scope);M.type!==p.type?this._changes.updateSourceCache(C,"clear"):(this._changes.updateSourceCache(C,"reload"),x.pause())}this._updateLayer(p),p.onAdd&&p.onAdd(this.map),p.scope=this.scope,this.mergeLayers()}moveLayer(t,o){this._checkLoaded();let c=this._checkLayer(t);if(!c||t===o)return;let d=this._order.indexOf(t);this._order.splice(d,1);let p=this._order.length;if(o){let _=this._order.indexOf(o);if(_===-1)return void this.fire(new n.z(new Error(`Layer with id "${o}" does not exist on this map.`)));c.slot===this._layers[o].slot?p=_:n.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(p,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();let o=this._checkLayer(t);if(!o)return;o.setEventedParent(null);let c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(o.fqid),this._changes.removeLayer(o);let d=this.getOwnLayerSourceCache(o);if(d&&d.castsShadows){let p=!1;for(let _ in this._layers)if(this._layers[_].source===o.source&&this._layers[_].canCastShadows()){p=!0;break}d.castsShadows=p}o.onRemove&&o.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(let o in this._layers)if(this._layers[o].type===t)return!0;return!1}setLayerZoomRange(t,o,c){this._checkLoaded();let d=this._checkLayer(t);d&&(d.minzoom===o&&d.maxzoom===c||(o!=null&&(d.minzoom=o),c!=null&&(d.maxzoom=c),this._updateLayer(d)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,o){this._checkLoaded();let c=this._checkLayer(t);c&&c.slot!==o&&(c.slot=o,this._updateLayer(c))}setFilter(t,o,c={}){this._checkLoaded();let d=this._checkLayer(t);if(d&&!n.bv(d.filter,o))return o==null?(d.filter=void 0,void this._updateLayer(d)):void(this._validate(Re,`layers.${d.id}.filter`,o,{layerType:d.type},c)||(d.filter=n.di(o),this._updateLayer(d)))}getFilter(t){let o=this._checkLayer(t);if(o)return n.di(o.filter)}setLayoutProperty(t,o,c,d={}){this._checkLoaded();let p=this._checkLayer(t);if(p&&!n.bv(p.getLayoutProperty(o),c)){if(c!=null&&(!d||d.validate!==!1)&&Ws(p,$.call(po,{key:`layers.${t}.layout.${o}`,layerType:p.type,objectKey:o,value:c,styleSpec:n.a5,style:{glyphs:!0,sprite:!0}})))return;p.setLayoutProperty(o,c),p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),this._updateLayer(p)}}getLayoutProperty(t,o){let c=this._checkLayer(t);if(c)return c.getLayoutProperty(o)}setPaintProperty(t,o,c,d={}){this._checkLoaded();let p=this._checkLayer(t);if(!p||n.bv(p.getPaintProperty(o),c)||c!=null&&(!d||d.validate!==!1)&&Ws(p,q.call(po,{key:`layers.${t}.paint.${o}`,layerType:p.type,objectKey:o,value:c,styleSpec:n.a5})))return;let _=p.setPaintProperty(o,c);p.configDependencies.size!==0&&this._configDependentLayers.add(p.fqid),_&&this._updateLayer(p),this._changes.updatePaintProperties(p)}getPaintProperty(t,o){let c=this._checkLayer(t);if(c)return c.getPaintProperty(o)}setFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:b,importId:M}=t.target,C=this.getFragmentStyle(M),z=C.getFeaturesetLayers(b);for(let{source:P,sourceLayer:D}of z)C.setFeatureState({id:t.id,source:P,sourceLayer:D},o)}else if("layerId"in t.target){let{layerId:b}=t.target,M=this.getLayer(b);this.setFeatureState({id:t.id,source:M.source,sourceLayer:M.sourceLayer},o)}return}let c=t.source,d=t.sourceLayer,p=this._checkSource(c);if(!p)return;let _=p.type;if(_==="geojson"&&d)return void this.fire(new n.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(_==="vector"&&!d)return void this.fire(new n.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new n.z(new Error("The feature id parameter must be provided.")));let x=this.getOwnSourceCaches(c);for(let b of x)b.setFeatureState(d,t.id,o)}removeFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:b,importId:M}=t.target,C=this.getFragmentStyle(M),z=C.getFeaturesetLayers(b);for(let{source:P,sourceLayer:D}of z)C.removeFeatureState({id:t.id,source:P,sourceLayer:D},o)}else if("layerId"in t.target){let{layerId:b}=t.target,M=this.getLayer(b);this.removeFeatureState({id:t.id,source:M.source,sourceLayer:M.sourceLayer},o)}return}let c=t.source,d=this._checkSource(c);if(!d)return;let p=d.type,_=p==="vector"?t.sourceLayer:void 0;if(p==="vector"&&!_)return void this.fire(new n.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(o&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new n.z(new Error("A feature id is required to remove its specific state property.")));let x=this.getOwnSourceCaches(c);for(let b of x)b.removeFeatureState(_,t.id,o)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let p;if("featuresetId"in t.target){let{featuresetId:_,importId:x}=t.target,b=this.getFragmentStyle(x),M=b.getFeaturesetLayers(_);for(let{source:C,sourceLayer:z}of M){let P=b.getFeatureState({id:t.id,source:C,sourceLayer:z});if(P&&!p)p=P;else if(!n.bv(p,P))return void this.fire(new n.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){let{layerId:_}=t.target,x=this.getLayer(_);p=this.getFeatureState({id:t.id,source:x.source,sourceLayer:x.sourceLayer})}return p}let o=t.source,c=t.sourceLayer,d=this._checkSource(o);if(d){if(d.type!=="vector"||c)return t.id===void 0&&this.fire(new n.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(o)[0].getFeatureState(c,t.id);this.fire(new n.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=n.h({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return n.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();let t=this.getTerrain(),o=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return n.dp({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:o,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},c=>c!==void 0)}_updateFilteredLayers(t){for(let o of Object.values(this._mergedLayers))t(o)&&this._updateLayer(o)}_updateLayer(t){this._changes.updateLayer(t);let o=this.getLayerSourceCache(t),c=n.C(t.source,t.scope),d=this._changes.getUpdatedSourceCaches();t.source&&!d[c]&&o&&o.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),o.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){let o=x=>this._mergedLayers[x].is3D(!!this.terrain),c=this.order,d={},p=[];for(let x=c.length-1;x>=0;x--){let b=c[x];if(o(b)){d[b]=x;for(let M of t){let C=M[b];if(C)for(let z of C)p.push(z)}}}p.sort((x,b)=>b.intersectionZ-x.intersectionZ);let _=[];for(let x=c.length-1;x>=0;x--){let b=c[x];if(o(b))for(let M=p.length-1;M>=0;M--){let C=p[M].feature;if(C.layer&&d[C.layer.id]<x)break;_.push(C),p.pop()}else for(let M of t){let C=M[b];if(C)for(let z of C)_.push(z.feature)}}return _}queryRenderedFeatures(t,o,c){let d;o&&!Array.isArray(o)&&o.filter&&(this._validate(Re,"queryRenderedFeatures.filter",o.filter,null,o),d=n.b3(o.filter));let p={},_=C=>{if(Oh.has(C.type))return;let z=this.getOwnLayerSourceCache(C),P=p[z.id]=p[z.id]||{sourceCache:z,layers:{},has3DLayers:!1};C.is3D(!!this.terrain)&&(P.has3DLayers=!0),P.layers[C.fqid]=P.layers[C.fqid]||{styleLayer:C,targets:[]},P.layers[C.fqid].targets.push({filter:d})};if(o&&o.layers){if(!Array.isArray(o.layers))return this.fire(new n.z(new Error("parameters.layers must be an Array."))),[];for(let C of o.layers){let z=this._layers[C];if(!z)return this.fire(new n.z(new Error(`The layer '${C}' does not exist in the map's style and cannot be queried for features.`))),[];_(z)}}else for(let C in this._layers)_(this._layers[C]);let x=this._queryRenderedFeatures(t,p,c),b=this._flattenAndSortRenderedFeatures(x),M=[];for(let C of b)n.dq(C.layer.id)===this.scope&&M.push(C);return M}queryRenderedFeatureset(t,o,c){let d;o&&!Array.isArray(o)&&o.filter&&(this._validate(Re,"queryRenderedFeatures.filter",o.filter,null,o),d=n.b3(o.filter));let p="mock",_=[];if(o&&o.target)_.push(Object.assign({},o,{targetId:p,filter:d}));else{let C=this.getFeaturesetDescriptors();for(let z of C)_.push({targetId:p,filter:d,target:z});for(let{style:z}of this.fragments){let P=z.getFeaturesetDescriptors();for(let D of P)_.push({targetId:p,filter:d,target:D})}}let x=this.queryRenderedTargets(t,_,c),b=[],M=new Set;for(let C of x)for(let z of C.variants[p])Eh(z,C,M)||b.push(new n.dr(C,z));return b}queryRenderedTargets(t,o,c){let d={},p=(x,b,M,C)=>{let z=d[b.id]=d[b.id]||{sourceCache:b,layers:{},has3DLayers:!1};if(z.layers[x.fqid]=z.layers[x.fqid]||{styleLayer:x,targets:[]},x.is3D(!!this.terrain)&&(z.has3DLayers=!0),!C)return M.uniqueFeatureID=!1,void z.layers[x.fqid].targets.push(M);z.layers[x.fqid].targets.push(Object.assign({},M,{namespace:C.namespace,properties:C.properties,uniqueFeatureID:C.uniqueFeatureID}))};for(let x of o)if("featuresetId"in x.target){let{featuresetId:b,importId:M}=x.target,C=this.getFragmentStyle(M);if(!C||!C._featuresetSelectors)continue;let z=C._featuresetSelectors[b];if(!z){this.fire(new n.z(new Error(`The featureset '${b}' does not exist in the map's style and cannot be queried for features.`)));continue}for(let P of z){let D=C.getOwnLayer(P.layerId);D&&!Oh.has(D.type)&&p(D,C.getOwnLayerSourceCache(D),x,P)}}else if("layerId"in x.target){let{layerId:b}=x.target,M=this.getLayer(b);if(!M||Oh.has(M.type))continue;p(M,this.getLayerSourceCache(M),x)}let _=this._queryRenderedFeatures(t,d,c);return this._flattenAndSortRenderedFeatures(_)}_queryRenderedFeatures(t,o,c){let d=[],p=!!this.map._showQueryGeometry,_=Pi.createFromScreenPoints(t,c);for(let x in o){let b=Ih(_,o[x],this._availableImages,c,p);Object.keys(b).length&&d.push(b)}if(this.placement)for(let x in o){if(!o[x].sourceCache._onlySymbols)continue;let b=va(_.screenGeometry,o[x],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(b).length&&d.push(b)}return d}querySourceFeatures(t,o){let c=o&&o.filter;c&&this._validate(Re,"querySourceFeatures.filter",c,null,o);let d=[],p=this.getOwnSourceCaches(t);for(let _ of p)d=d.concat(fc(_,o));return d}addSourceType(t,o,c){return ko.getSourceType(t)?c(new Error(`A source type called "${t}" already exists.`)):(ko.setSourceType(t,o),o.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:o.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,o,c={}){this._checkLoaded();let d=this.light.getLight(),p=!1;for(let x in t)if(!n.bv(t[x],d[x])){p=!0;break}if(!p)return;let _=this._getTransitionParameters();this.light.setLight(t,o,c),this.light.updateTransitions(_)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=n.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&n.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,o=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),o===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t,d=t.source==null;if(o===1){if(this.disableElevatedTerrain)return;if(typeof c.source=="object"){let x="terrain-dem-src";this.addSource(x,c.source),c=n.di(c),c=n.h(c,{source:x})}let p=n.h({},c),_={};if(this.terrain&&d){p.source=this.terrain.get().source;let x=this.terrain?this.getFragmentStyle(this.terrain.scope):null;x&&(_.style=x.serialize())}if(this._validate(Qe,"terrain",p,_))return}if(!this.terrain||this.terrain.scope!==this.scope&&!d||this.terrain&&o!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,o),this.fire(new n.A("data",{dataType:"style"}))}else{let p=this.terrain,_=p.get();for(let x of Object.keys(n.a5.terrain))!c.hasOwnProperty(x)&&n.a5.terrain[x].default&&(c[x]=n.a5.terrain[x].default);for(let x in t)if(!n.bv(t[x],_[x])){p.set(t,this.options),this.stylesheet.terrain=t;let b=this._getTransitionParameters({duration:0});p.updateTransitions(b),this.fire(new n.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){let o=this.fog=new si(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}_createSnow(t){let o=this.snow=new Qr(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}_createRain(t){let o=this.rain=new $r(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(let t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let o=this.fog;if(!n.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.fog=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){let o=this.snow;if(!n.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.snow=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){let o=this.rain;if(!n.bv(o.get(),t)){o.set(t,this.options),this.stylesheet.rain=o.get();let c=this._getTransitionParameters({duration:0});o.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){let t=()=>{for(let d in this._layers)this._layers[d].lut=this._styleColorTheme.lut;for(let d in this._sourceCaches)this._sourceCaches[d].clearTiles()},o=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!o)return this._styleColorTheme.lut=null,void t();let c=this._evaluateColorThemeData(o);this._loadColorTheme(c).then(()=>{this.fire(new n.A("colorthemeset")),t()}).catch(d=>{n.w(`Couldn't set color theme: ${d}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&n.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,o){let c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=o,c._reloadColorTheme())}_getTransitionParameters(t){return{now:n.q.now(),transition:n.h(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;let t=[],o=[];for(let c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):o.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...o)}_createTerrain(t,o){let c=this.terrain=new be(t,o,this.scope,this.options,this.map.getWorldview());o===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let d=this._getTransitionParameters({duration:0});c.updateTransitions(d)}_force3DLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="fill-extrusion"&&this._updateLayer(o)}}_forceSymbolLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="symbol"&&this._updateLayer(o)}}_validate(t,o,c,d,p={}){if(p&&p.validate===!1)return!1;let _=n.h({},this.serialize());return Ws(this,t.call(po,n.h({key:o,style:_,value:c,styleSpec:n.a5},d)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),n.ds.off("pluginStateChange",this._rtlTextPluginCallback);for(let t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){let o=this.getSourceCaches(t);for(let c of o)c.clearTiles()}clearSources(){for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(let t in this._mergedLayers){let o=this._mergedLayers[t];o._clear&&o._clear()}}reloadSource(t){let o=this.getSourceCaches(t);for(let c of o)c.resume(),c.reload()}reloadSources(){for(let t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let o;this.directionalLight&&(o=hl(this.directionalLight));let c=new Set;for(let d in this._mergedLayers){let p=this._mergedLayers[d];p.hasElevation()&&!c.has(p.source)&&c.add(p.source)}for(let d in this._mergedSourceCaches){let p=this._mergedSourceCaches[d],_=c.has(p._source.id);p.update(t,void 0,void 0,o,_)}}_generateCollisionBoxes(){for(let t in this._sourceCaches){let o=this._sourceCaches[t];o.resume(),o.reload()}}_updatePlacement(t,o,c,d,p,_,x=!1){let b=!1,M=!1,C={},z={};for(let P of this._mergedOrder){let D=this._mergedLayers[P];if(D.type!=="symbol")continue;let N=n.C(D.source,D.scope),F=C[N];if(!F){let U=this.getLayerSourceCache(D);if(!U)continue;let Z=U.getRenderableIds(!0).map(Y=>U.getTileByID(Y));z[N]=Z.slice(),F=C[N]=Z.sort((Y,Q)=>Q.tileID.overscaledZ-Y.tileID.overscaledZ||(Y.tileID.isLessThan(Q.tileID)?-1:1))}let j=this.crossTileSymbolIndex.addLayer(D,F,o.center.lng,o.projection);b=b||j}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),x=x||this._layerOrderChanged||d===0,this._layerOrderChanged&&this.fire(new n.A("neworder")),(x||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(n.q.now(),o.zoom))&&(this.pauseablePlacement=new Lh(o,this._mergedOrder,x,c,d,p,this.placement,this.fog&&o.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,C,z,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(n.q.now()),M=!0),b&&this.pauseablePlacement.placement.setStale()),M||b){this._buildingIndex.onNewFrame(o.zoom);for(let P=0;P<this._mergedOrder.length;P++){let D=this._mergedLayers[this._mergedOrder[P]];if(D.type!=="symbol")continue;let N=this.isLayerClipped(D);this.placement.updateLayerOpacities(D,C[n.C(D.source,D.scope)],P,N?_:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(n.q.now())}}_releaseSymbolFadeTiles(){for(let t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,o){this._checkLoaded();let c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex(({id:p})=>p===t.id)!==-1)return void this.fire(new n.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!o)return c.push(t),this._loadImports([t],!0);let d=c.findIndex(({id:p})=>p===o);return d===-1&&this.fire(new n.z(new Error(`Import with id "${o}" does not exist on this map.`))),this.stylesheet.imports=c.slice(0,d).concat(t).concat(c.slice(d)),this._loadImports([t],!0,o)}updateImport(t,o){this._checkLoaded();let c=this.stylesheet.imports||[],d=this.getImportIndex(t);return d===-1?this:typeof o=="string"?(this.setImportUrl(t,o),this):(o.url&&o.url!==c[d].url&&this.setImportUrl(t,o.url),n.bv(o.config,c[d].config)||this.setImportConfig(t,o.config,o.data.schema),n.bv(o.data,c[d].data)||this.setImportData(t,o.data),this)}moveImport(t,o){this._checkLoaded();let c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;let p=this.getImportIndex(o);if(p===-1)return this;let _=c[d],x=this.fragments[d];return c=c.filter(({id:b})=>b!==t),this.fragments=this.fragments.filter(({id:b})=>b!==t),this.stylesheet.imports=c.slice(0,p).concat(_).concat(c.slice(p)),this.fragments=this.fragments.slice(0,p).concat(x).concat(this.fragments.slice(p)),this.mergeLayers(),this}setImportUrl(t,o){this._checkLoaded();let c=this.stylesheet.imports||[],d=this.getImportIndex(t);if(d===-1)return this;c[d].url=o;let p=this.fragments[d];return p.style=this._createFragmentStyle(c[d]),p.style.on("style.import.load",()=>this.mergeAll()),p.style.loadURL(o),this}setImportData(t,o){this._checkLoaded();let c=this.getImportIndex(t),d=this.stylesheet.imports||[];return c===-1?this:o?(this.fragments[c].style.setState(o),this._reloadImports(),this):(delete d[c].data,this.setImportUrl(t,d[c].url))}setImportConfig(t,o,c){this._checkLoaded();let d=this.getImportIndex(t),p=this.stylesheet.imports||[];if(d===-1)return this;o?p[d].config=o:delete p[d].config;let _=this.fragments[d];c&&_.style.stylesheet&&(_.style.stylesheet.schema=c);let x=_.style.stylesheet&&_.style.stylesheet.schema;return _.config=o,_.style.updateConfig(o,x),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();let o=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(o.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){let o=(this.stylesheet.imports||[]).findIndex(c=>c.id===t);return o===-1&&this.fire(new n.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),o}getLayer(t){return this._mergedLayers[t]}getSources(){let t=[];for(let o in this._mergedOtherSourceCaches){let c=this._mergedOtherSourceCaches[o];c&&t.push(c.getSource())}return t}getSource(t,o){let c=this.getSourceCache(t,o);return c&&c.getSource()}getLayerSource(t){let o=this.getLayerSourceCache(t);return o&&o.getSource()}getSourceCache(t,o){let c=n.C(t,o);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){let o=n.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[o]:this._mergedOtherSourceCaches[o]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);let o=[];return this._mergedOtherSourceCaches[t]&&o.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&o.push(this._mergedSymbolSourceCaches[t]),o}updateSourceCaches(){let t=this._changes.getUpdatedSourceCaches();for(let o in t){let c=t[o];c==="reload"?this.reloadSource(o):c==="clear"&&this.clearSource(o)}}updateLayers(t){let o=this._changes.getUpdatedPaintProperties();for(let c of o){let d=this.getLayer(c);d&&d.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,o,c){this.imageManager.getImages(o.images,o.scope,c),this._updateTilesForChangedImages();let d=_=>{if(_){let x=o.images.map(b=>n.I.toString(b));_.setDependencies(o.tileID.key,o.type,x)}},p=n.C(o.source,o.scope);d(this._mergedOtherSourceCaches[p]),d(this._mergedSymbolSourceCaches[p]),o.images.some(_=>_.iconsetId)&&this.fire(new n.A("data",{dataType:"style"}))}rasterizeImages(t,o,c){this.imageManager.rasterizeImages(o,c)}getGlyphs(t,o,c){this.glyphManager.getGlyphs(o.stacks,c)}getResource(t,o,c){return n.dt(o,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){let o=[];return this._otherSourceCaches[t]&&o.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&o.push(this._symbolSourceCaches[t]),o}_isSourceCacheLoaded(t){let o=this.getOwnSourceCaches(t);return o.length===0?(this.fire(new n.z(new Error(`There is no source with ID '${t}'`))),!1):o.every(c=>c.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,o){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;let c=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),d=t.type==="building";if(t.is3D(!!this.terrain)){if(c||d||o&&o.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}ko.getSourceType=function(l){return Sh[l]},ko.setSourceType=function(l,t){Sh[l]=t},ko.registerForPluginStateChange=n.du;var xd=`
>>>>>>> a526947f4e024d155ff980808ddb8c37daf4d8a2
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,pl=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,fl=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,bd="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Fh=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,go=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Bh=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,ht=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,wd=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,Nh=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Vh=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;let Dc=[];Yo(vd,Dc),Yo(fl,Dc),Yo(pl,Dc);let Pa={"_prelude_fog.vertex.glsl":go,"_prelude_terrain.vertex.glsl":Fh,"_prelude_shadow.vertex.glsl":Nh,"_prelude_fog.fragment.glsl":Bh,"_prelude_shadow.fragment.glsl":Vh,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":ht,"_prelude_raster_particle.glsl":wd},Fo={};_i("",Fh),_i(Bh,go),_i(Vh,Nh),_i(ht,""),_i(wd,"");let Uh=_i(pl,fl),Ks=vd;var Oc={background:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,base_color.rgb,emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color.rgb=linearTosRGB(color.rgb);color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}`),buildingBloom:_i(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);}`),buildingDepth:_i(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:_i("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:_i(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:_i(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:_i("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:_i("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:_i("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:_i(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:_i(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:_i(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:_i(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:_i(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:_i(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:_i("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:_i("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:_i(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:_i(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:_i("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:_i(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,bd),skyboxGradient:_i(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,bd),skyboxCapture:_i(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:_i(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:_i(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:_i(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:_i(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:_i("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:_i("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:_i("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:_i("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Yo(l,t){let o=l.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let c of o)if(c=c.trim(),c[0]==="#"&&c.includes("if")&&!c.includes("endif")){c=c.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let d=c.split(" ");for(let p of d)t.includes(p)||t.push(p)}}function _i(l,t){let o=/#include\s+"([^"]+)"/g,c=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,d=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);d&&(d=d.map(M=>{let C=M.split(" ");return C[C.length-1]}),d=[...new Set(d)]);let p={},_=[],x=[];if(l=l.replace(o,(M,C)=>(x.push(C),"")),(t=t.replace(o,(M,C)=>(_.push(C),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let b=[...Dc];Yo(l,b),Yo(t,b);for(let M of[..._,...x])Pa[M]||console.error(`Undefined include: ${M}`),Fo[M]||(Fo[M]=[],Yo(Pa[M],Fo[M])),b=[...b,...Fo[M]];return{fragmentSource:l=l.replace(c,(M,C,z,P,D)=>(p[D]=!0,C==="define"?`
#ifndef HAS_UNIFORM_u_${D}
in ${z} ${P} ${D};
#else
uniform ${z} ${P} u_${D};
#endif
`:C==="initialize"?`
#ifdef HAS_UNIFORM_u_${D}
    ${z} ${P} ${D} = u_${D};
#endif
`:C==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${D}
    in ${z} ${P} ${D};
#endif
`:C==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(c,(M,C,z,P,D)=>{let N=P==="float"?"vec2":P,F=D.match(/color/)?"color":N;return C==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${D}
in ${z} ${P} a_${D};
#endif
`:p[D]?C==="define"?`
#ifndef HAS_UNIFORM_u_${D}
uniform lowp float u_${D}_t;
in ${z} ${N} a_${D};
out ${z} ${P} ${D};
#else
uniform ${z} ${P} u_${D};
#endif
`:C==="initialize"?F==="vec4"?`
#ifndef HAS_UNIFORM_u_${D}
    ${D} = a_${D};
#else
    ${z} ${P} ${D} = u_${D};
#endif
`:`
#ifndef HAS_UNIFORM_u_${D}
    ${D} = unpack_mix_${F}(a_${D}, u_${D}_t);
#else
    ${z} ${P} ${D} = u_${D};
#endif
`:C==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${D}
    in ${z} ${P} a_${D};
    out ${z} ${P} ${D};
#endif
`:C==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${D}
    ${D} = a_${D};
#endif
`:void 0:C==="define"?`
#ifndef HAS_UNIFORM_u_${D}
uniform lowp float u_${D}_t;
in ${z} ${N} a_${D};
#else
uniform ${z} ${P} u_${D};
#endif
`:C==="define-instanced"?F==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${D}0;
in vec4 a_${D}1;
in vec4 a_${D}2;
in vec4 a_${D}3;
#else
uniform ${z} ${P} u_${D};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${z} ${N} a_${D};
#else
uniform ${z} ${P} u_${D};
#endif
`:C==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${D}
    ${z} ${P} ${D} = a_${D};
#endif
`:F==="vec4"?`
#ifndef HAS_UNIFORM_u_${D}
    ${z} ${P} ${D} = a_${D};
#else
    ${z} ${P} ${D} = u_${D};
#endif
`:`
#ifndef HAS_UNIFORM_u_${D}
    ${z} ${P} ${D} = unpack_mix_${F}(a_${D}, u_${D}_t);
#else
    ${z} ${P} ${D} = u_${D};
#endif
<<<<<<< HEAD
`}),staticAttributes:d,usedDefines:b,vertexIncludes:_,fragmentIncludes:x}}class yg{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,o,c,d,p,_,x,b){this.context=t;let M=this.boundPaintVertexBuffers.length!==d.length;for(let z=0;!M&&z<d.length;z++)this.boundPaintVertexBuffers[z]!==d[z]&&(M=!0);let C=this.boundDynamicVertexBuffers.length!==x.length;for(let z=0;!C&&z<x.length;z++)this.boundDynamicVertexBuffers[z]!==x[z]&&(C=!0);if(!this.vao||this.boundProgram!==o||this.boundLayoutVertexBuffer!==c||M||C||this.boundIndexBuffer!==p||this.boundVertexOffset!==_)this.freshBind(o,c,d,p,_,x,b);else{t.bindVertexArrayOES.set(this.vao);for(let z of x)z&&(z.bind(),b&&z.instanceCount&&z.setVertexAttribDivisor(t.gl,o,b));p&&p.dynamicDraw&&p.bind()}}freshBind(t,o,c,d,p,_,x){let b=t.numAttributes,M=this.context,C=M.gl;this.vao&&this.destroy(),this.vao=M.gl.createVertexArray(),M.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=o,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=p,this.boundDynamicVertexBuffers=_,o.enableAttributes(C,t),o.bind(),o.setVertexAttribPointers(C,t,p);for(let z of c)z.enableAttributes(C,t),z.bind(),z.setVertexAttribPointers(C,t,p);for(let z of _)z&&(z.enableAttributes(C,t),z.bind(),z.setVertexAttribPointers(C,t,p),x&&z.instanceCount&&z.setVertexAttribDivisor(C,t,x));d&&d.bind(),M.currentNumAttributes=b}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Td(l,t){let o=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new n.ac(0,c/o).toLngLat().lat,new n.ac(0,(c+1)/o).toLngLat().lat]}function xg(l,t,o,c,d,p,_){let x=l.context,b=x.gl,M=o.hillshadeFBO;if(!M)return;l.prepareDrawTile();let C=l.isTileAffectedByFog(t),z=l.getOrCreateProgram("hillshade",{overrideFog:C});x.activeTexture.set(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,M.colorAttachment.get());let P=((j,U,Z,Y)=>{let Q=Z.paint.get("hillshade-shadow-color"),ne=Z.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",he=Z.paint.get("hillshade-highlight-color"),de=Z.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",oe=Z.paint.get("hillshade-accent-color"),se=Z.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",le=Z.paint.get("hillshade-emissive-strength"),Me=n.al(Z.paint.get("hillshade-illumination-direction"));if(Z.paint.get("hillshade-illumination-anchor")==="viewport")Me-=j.transform.angle;else if(j.style&&j.style.enable3dLights()&&j.style.directionalLight){let Ve=j.style.directionalLight.properties.get("direction"),ze=n.d1(Ve.x,Ve.y,Ve.z);Me=n.al(ze[1])}let _e=!j.options.moving;return{u_matrix:Y||j.transform.calculateProjMatrix(U.tileID.toUnwrapped(),_e),u_image:0,u_latrange:Td(0,U.tileID),u_light:[Z.paint.get("hillshade-exaggeration"),Me],u_shadow:Q.toPremultipliedRenderColor(ne?null:Z.lut),u_highlight:he.toPremultipliedRenderColor(de?null:Z.lut),u_emissive_strength:le,u_accent:oe.toPremultipliedRenderColor(se?null:Z.lut)}})(l,o,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(x,z,t.toUnwrapped());let{tileBoundsBuffer:D,tileBoundsIndexBuffer:N,tileBoundsSegments:F}=l.getTileBoundsBuffers(o);z.draw(l,b.TRIANGLES,d,p,_,Nt.disabled,P,c.id,D,N,F)}function Sd(l,t,o){if(!t.needsDEMTextureUpload)return;let c=l.context,d=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(o.stride);let p=o.getPixels();t.demTexture?t.demTexture.update(p,{premultiply:!1}):t.demTexture=new n.T(c,p,d.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function Hf(l,t,o){let c=l.context,d=c.gl;if(!t.dem)return;let p=t.dem;if(c.activeTexture.set(d.TEXTURE1),Sd(l,t,p),!t.demTexture)return;t.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);let _=p.dim;c.activeTexture.set(d.TEXTURE0);let x=t.hillshadeFBO;if(!x){let P=new n.T(c,{width:_,height:_,data:null},d.RGBA8);P.bind(d.LINEAR,d.CLAMP_TO_EDGE),x=t.hillshadeFBO=c.createFramebuffer(_,_,!0,"renderbuffer"),x.colorAttachment.set(P.texture)}c.bindFramebuffer.set(x.framebuffer),c.viewport.set([0,0,_,_]);let{tileBoundsBuffer:b,tileBoundsIndexBuffer:M,tileBoundsSegments:C}=l.getMercatorTileBoundsBuffers(),z=[];l.linearFloatFilteringSupported()&&z.push("TERRAIN_DEM_FLOAT_FORMAT"),l.getOrCreateProgram("hillshadePrepare",{defines:z}).draw(l,d.TRIANGLES,bt.disabled,Gt.disabled,ti.unblended,Nt.disabled,((P,D)=>{let N=D.stride,F=n.bz();return n.ca(F,0,n.aj,-n.aj,0,0,1),n.bo(F,F,[0,-n.aj,0]),{u_matrix:F,u_image:1,u_dimension:[N,N],u_zoom:P.overscaledZ}})(t.tileID,p),o.id,b,M,C),t.needsHillshadePrepare=!1}class pr{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class vg extends pr{getDefault(){return n.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class bg extends pr{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class wg extends pr{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Tg extends pr{getDefault(){return[!0,!0,!0,!0]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class $f extends pr{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Sg extends pr{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class jh extends pr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){let o=this.current;(t.func!==o.func||t.ref!==o.ref||t.mask!==o.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Eg extends pr{getDefault(){let t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class Zf extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),this.current=t,this.dirty=!1}}class Ed extends pr{getDefault(){return[0,1]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Gh extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.current=t,this.dirty=!1}}class Id extends pr{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Ra extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.BLEND):o.disable(o.BLEND),this.current=t,this.dirty=!1}}class ml extends pr{getDefault(){let t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class qh extends pr{getDefault(){return n.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Hh extends pr{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class _l extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.CULL_FACE):o.disable(o.CULL_FACE),this.current=t,this.dirty=!1}}class Wf extends pr{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Ad extends pr{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Xf=class extends pr{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class gl extends pr{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class $h extends pr{getDefault(){let t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Zh extends pr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Md extends pr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindRenderbuffer(o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Wh extends pr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindTexture(o.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class kc extends pr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindBuffer(o.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Yf extends pr{getDefault(){return null}set(t){let o=this.gl;o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Kf extends pr{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class Jf extends pr{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class yl extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class Qf extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Cd extends pr{constructor(t,o){super(t),this.context=t,this.parent=o}getDefault(){return null}}class Ig extends Cd{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class em extends Cd{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferRenderbuffer(o.FRAMEBUFFER,this.attachment(),o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Pd extends Cd{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,this.attachment(),o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Rd extends em{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}let Ld=(l,t,o)=>({u_matrix:l,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:o}),Xh=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:o,u_zoom_transition:d,u_merc_center:p,u_image0:0,u_frustum_tl:_,u_frustum_tr:x,u_frustum_br:b,u_frustum_bl:M,u_globe_pos:C,u_globe_radius:z,u_viewport:P,u_grid_matrix:F?Float32Array.from(F):new Float32Array(9),u_skirt_height:D,u_far_z_cutoff:N});function zd(l,t){return l!=null&&t!=null&&!(!l.hasData()||!t.hasData())&&l.demTexture!=null&&t.demTexture!=null&&l.tileID.key!==t.tileID.key}let La=new class{constructor(){this.operations={}}newMorphing(l,t,o,c,d){if(l in this.operations){let p=this.operations[l];p.to.tileID.key!==o.tileID.key&&(p.queued=o)}else this.operations[l]={startTime:c,phase:0,duration:d,from:t,to:o,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;let t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(let t in this.operations){let o=this.operations[t];for(o.phase=(l-o.startTime)/o.duration;o.phase>=1||!this._validOp(o);)if(!this._nextOp(o,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},tm={0:null,1:"TERRAIN_VERTEX_MORPHING"};function xl(l,t,o){if(t===0)return 0;let c=t<1&&o===514?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function Fc(l,t){let o=1<<l.z;return!t&&(l.x===0||l.x===o-1)||l.y===0||l.y===o-1}let Yh=l=>({u_matrix:l});function Hn(l,t,o,c,d){if(d>0){let p=n.q.now(),_=(p-l.timeAdded)/d,x=t?(p-t.timeAdded)/d:-1,b=o.getSource(),M=c.coveringZoomLevel({tileSize:b.tileSize,roundZoom:b.roundZoom}),C=!t||Math.abs(t.tileID.overscaledZ-M)>Math.abs(l.tileID.overscaledZ-M),z=C&&l.refreshedUponExpiration?1:n.ay(C?_:1-x,0,1);return l.refreshedUponExpiration&&_>=1&&(l.refreshedUponExpiration=!1),t?{opacity:1,mix:1-z}:{opacity:z,mix:0}}return{opacity:1,mix:0}}class Dd extends Gn{constructor(t){let o=pc("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",o,!1),o.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,o){t.state="loaded",o(null)}}class Kh extends Gn{constructor(t){let o=pc("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",o,!1),o.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,o,c){if(t.freezeTileCoverage)return;this.transform=t;let d=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((p,_)=>{if(p[_.key]="",!this._tiles[_.key]){let x=new wa(_,this._source.tileSize*_.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);x.state="loaded",this._tiles[_.key]=x}return p},{});for(let p in this._tiles)p in d||(this.freeFBO(p),this._tiles[p].unloadVectorData(),delete this._tiles[p])}freeFBO(t){let o=this.proxyCachedFBO[t];if(o!==void 0){let c=Object.values(o);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Bc extends n.aM{constructor(t,o,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=o,this.projMatrix=c}}class Jh extends n.dF{constructor(t,o){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[c,d,p]=function(b){let M=new n.ba,C=new n.a_,z=131;M.reserve(17161),C.reserve(33800);let P=n.aj/128,D=n.aj+P/2,N=D+P;for(let j=-P;j<N;j+=P)for(let U=-P;U<N;U+=P){let Z=U<0||U>D||j<0||j>D?24575:0,Y=n.ay(Math.round(U),0,n.aj),Q=n.ay(Math.round(j),0,n.aj);M.emplaceBack(Y+Z,Q)}let F=(j,U)=>{let Z=U*z+j;C.emplaceBack(Z+1,Z,Z+z),C.emplaceBack(Z+z,Z+z+1,Z+1)};for(let j=1;j<129;j++)for(let U=1;U<129;U++)F(U,j);return[0,129].forEach(j=>{for(let U=0;U<130;U++)F(U,j),F(j,U)}),[M,C,32768]}(),_=t.context;this.gridBuffer=_.createVertexBuffer(c,n.bc.members),this.gridIndexBuffer=_.createIndexBuffer(d),this.gridSegments=n.bd.simpleSegment(0,0,c.length,d.length),this.gridNoSkirtSegments=n.bd.simpleSegment(0,0,c.length,p),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Kh(o.map),this.orthoMatrix=n.bz(),n.ca(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,n.aj,0,n.aj,0,1);let x=_.gl;this._overlapStencilMode=new Gt({func:x.GEQUAL,mask:255},0,255,x.KEEP,x.KEEP,x.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=o,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Dd(o.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,o,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);let d=t.terrain.properties,p=t.terrain.drapeRenderMode===0,_=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=n.q.now();let x=t.terrain&&t.terrain.scope,b=d.get("source"),M=p?this._mockSourceCache:t.getSourceCache(b,x);if(!M)return void n.w(`Couldn't find terrain source "${b}".`);if(this.sourceCache=M,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=_?this.calculateExaggeration(o):d.get("exaggeration"),!o.projection.requiresDraping&&_&&this._exaggeration===0)return void this._disable();this.enabled=!0;let C=()=>{this.sourceCache.used&&n.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let z=this.getScaledDemTileSize();this.sourceCache.update(o,z,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,C(),this._initializing=!0),C(),o.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(o),this._emptyDEMTextureDirty=!0,this._previousZoom=o.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);let o=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;let d=o!=null?c-o:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;let p=t.zoom,_=this._style.terrain;if(!this._previousUpdateTimestamp)return _.getExaggeration(p);let x=p-this._previousZoom,b=this._previousUpdateTimestamp,M=p;this._evaluationZoom!=null&&(M=this._evaluationZoom,Math.abs(p-M)>.5&&(x=.5*(p-M+x)),x*d<0&&(M+=x)),this._evaluationZoom=M;let C=_.getExaggeration(M),z=C===_.getExaggeration(Math.max(0,M-.1));if(z&&Math.abs(C-this._exaggeration)<.01)return C;let P=Math.min(.1,.00375*(this._updateTimestamp-b));return(z||C<.1||Math.abs(x)<1e-4)&&(P=Math.min(.2,4*P)),n.ai(this._exaggeration,C,P)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let o=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(n.ac.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);let d=this.proxyCoords=o.getIds().map(b=>{let M=o.getTileByID(b).tileID;return M.projMatrix=c.calculateProjMatrix(M.toUnwrapped()),M});(function(b,M){let C=M.transform.pointCoordinate(M.transform.getCameraPoint()),z=new n.P(C.x,C.y);b.sort((P,D)=>{if(D.overscaledZ-P.overscaledZ)return D.overscaledZ-P.overscaledZ;let N=new n.P(P.canonical.x+(1<<P.canonical.z)*P.wrap,P.canonical.y),F=new n.P(D.canonical.x+(1<<D.canonical.z)*D.wrap,D.canonical.y),j=z.mult(1<<P.canonical.z);return j.x-=.5,j.y-=.5,j.distSqr(N)-j.distSqr(F)})})(d,this.painter);let p=this.proxyToSource||{};this.proxyToSource={},d.forEach(b=>{this.proxyToSource[b.key]={}}),this.terrainTileForTile={};let _=this._style._mergedSourceCaches;for(let b in _){let M=_[b];if(!M.used||(M!==this.sourceCache&&this.resetTileLookupCache(M.id),this._setupProxiedCoordsForOrtho(M,t[b],p),M.usedForTerrain))continue;let C=t[b];M.getSource().reparseOverscaled&&this._assignTerrainTiles(C)}this.proxiedCoords[o.id]=d.map(b=>new Bc(b,b.key,this.orthoMatrix)),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(p),this.renderingToTexture=!1;let x={};this._visibleDemTiles=[];for(let b of this.proxyCoords){let M=this.terrainTileForTile[b.key];if(!M)continue;let C=M.tileID.key;C in x||(this._visibleDemTiles.push(M),x[C]=C)}}_assignTerrainTiles(t){this._initializing||t.forEach(o=>{if(this.terrainTileForTile[o.key])return;let c=this._findTileCoveringTileID(o,this.sourceCache);c&&(this.terrainTileForTile[o.key]=c)})}_prepareDEMTextures(){let t=this.painter.context,o=t.gl;for(let c in this.terrainTileForTile){let d=this.terrainTileForTile[c],p=d.dem;!p||d.demTexture&&!d.needsDEMTextureUpload||(t.activeTexture.set(o.TEXTURE1),Sd(this.painter,d,p))}}_prepareDemTileUniforms(t,o,c,d){if(!o||o.demTexture==null)return!1;let p=t.tileID.canonical,_=Math.pow(2,o.tileID.canonical.z-p.z),x=d||"";return c[`u_dem_tl${x}`]=[p.x*_%1,p.y*_%1],c[`u_dem_scale${x}`]=_,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0,o=this._visibleDemTiles.reduce((c,d)=>{if(!d.dem)return c;let p=d.dem.tree.minimums[0];return p>0&&t++,c+p},0);return t?o/t:0}_updateEmptyDEMTexture(){let t=this.painter.context,o=t.gl;t.activeTexture.set(o.TEXTURE2);let c=this._getLoadedAreaMinimum(),d=new n.dG({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let p=this._emptyDEMTexture;return p?p.update(d,{premultiply:!1}):p=this._emptyDEMTexture=new n.T(t,d,o.R32F,{premultiply:!1}),p}setupElevationDraw(t,o,c){let d=this.painter.context,p=d.gl,_={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};_.u_exaggeration=this.exaggeration();let x=null,b=null,M=1;if(c&&c.morphing&&this._useVertexMorphing){let D=c.morphing.srcDemTile,N=c.morphing.dstDemTile;M=c.morphing.phase,D&&N&&(this._prepareDemTileUniforms(t,D,_,"_prev")&&(b=D),this._prepareDemTileUniforms(t,N,_)&&(x=N))}let C=D=>D&&D.demTexture&&this.painter.linearFloatFilteringSupported()?p.LINEAR:p.NEAREST,z=null;var P;if(this.enabled?b&&x?(z=x.demTexture,d.activeTexture.set(p.TEXTURE4),b.demTexture.bind(C(b),p.CLAMP_TO_EDGE),_.u_dem_lerp=M):(x=this.terrainTileForTile[t.tileID.key],z=this._prepareDemTileUniforms(t,x,_)?x.demTexture:this.emptyDEMTexture):z=this.emptyDEMTexture,d.activeTexture.set(p.TEXTURE2),z&&(_.u_dem_size=(P=z).size[0]===1?1:P.size[0]-2,z.bind(C(x),p.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,o,_),c&&c.useMeterToDem&&x){let D=(1<<x.tileID.canonical.z)*n.cb(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;_.u_meter_to_dem=D}if(c&&c.labelPlaneMatrixInv&&(_.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),o.setTerrainUniformValues(d,_),this.painter.transform.projection.name==="globe"){let D=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);o.setGlobeUniformValues(d,D)}}globeUniformValues(t,o,c){let d=t.projection;return{u_tile_tl_up:d.upVector(o,0,0),u_tile_tr_up:d.upVector(o,n.aj,0),u_tile_br_up:d.upVector(o,n.aj,n.aj),u_tile_bl_up:d.upVector(o,0,n.aj),u_tile_up_scale:c?n.dH(1):d.upVectorScale(o,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){let o=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,o.width,o.height]),o.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(d,p,_,x,b){if(d.transform.projection.name==="globe")(function(M,C,z,P,D){let N=M.context,F=N.gl,j,U,Z=M.transform,Y=n.dy(M,N,Z),Q=(Ve,ze)=>{if(U===ze)return;let je=[tm[ze],"PROJECTION_GLOBE_VIEW"];Y&&je.push("CUSTOM_ANTIALIASING");let rt=M.isTileAffectedByFog(Ve);j=M.getOrCreateProgram("globeRaster",{defines:je,overrideFog:rt}),U=ze},ne=M.colorModeForRenderPass(),he=new bt(F.LEQUAL,bt.ReadWrite,M.depthRangeFor3D);La.update(D);let de=n.dz(Z),oe=[n.aD(Z.center.lng),n.aH(Z.center.lat)],se=M.globeSharedBuffers,le=[Z.width*n.q.devicePixelRatio,Z.height*n.q.devicePixelRatio],Me=Float32Array.from(Z.globeMatrix),_e={useDenormalizedUpVectorScale:!0};{let Ve=M.transform,ze=xl(Ve.zoom,C.exaggeration(),C.sourceCache._source.tileSize);U=-1;let je=F.TRIANGLES;for(let rt of P){let Ce=z.getTile(rt),me=Gt.disabled,ke=C.prevTerrainTileForTile[rt.key],Pe=C.terrainTileForTile[rt.key];zd(ke,Pe)&&La.newMorphing(rt.key,ke,Pe,D,250),N.activeTexture.set(F.TEXTURE0),Ce.texture&&Ce.texture.bind(F.LINEAR,F.CLAMP_TO_EDGE);let $e=La.getMorphValuesForProxy(rt.key),Ze=$e?1:0;$e&&n.L(_e,{morphing:{srcDemTile:$e.from,dstDemTile:$e.to,phase:n.dx($e.phase)}});let Ye=n.dA(rt.canonical),ct=n.dB(Ye.getCenter().lat),Mt=n.dC(rt.canonical,Ye,ct,Ve.worldSize/Ve._pixelsPerMercatorPixel),Ot=n.bh(n.dD(rt.canonical)),yt=Xh(Ve.expandedFarZProjMatrix,Me,de,Ot,n.ah(Ve.zoom),oe,Ve.frustumCorners.TL,Ve.frustumCorners.TR,Ve.frustumCorners.BR,Ve.frustumCorners.BL,Ve.globeCenterInViewSpace,Ve.globeRadius,le,ze,Ve._farZ,Mt);if(Q(rt,Ze),j&&(C.setupElevationDraw(Ce,j,_e),M.uploadCommonUniforms(N,j,rt.toUnwrapped()),se)){let[zt,Rt,$t]=se.getGridBuffers(ct,ze!==0);j.draw(M,je,he,me,ne,Nt.backCCW,yt,"globe_raster",zt,Rt,$t)}}}if(se&&(M.renderDefaultNorthPole||M.renderDefaultSouthPole)){let Ve=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Y&&Ve.push("CUSTOM_ANTIALIASING"),j=M.getOrCreateProgram("globeRaster",{defines:Ve});for(let ze of P){let{x:je,y:rt,z:Ce}=ze.canonical,me=rt===0,ke=rt===(1<<Ce)-1,[Pe,$e,Ze,Ye]=se.getPoleBuffers(Ce,!1);if(Ye&&(me||ke)){let ct=z.getTile(ze);N.activeTexture.set(F.TEXTURE0),ct.texture&&ct.texture.bind(F.LINEAR,F.CLAMP_TO_EDGE);let Mt=n.dE(Ce,je,Z),Ot=n.bh(n.dD(ze.canonical)),yt=(zt,Rt)=>zt.draw(M,F.TRIANGLES,he,Gt.disabled,ne,Nt.disabled,Xh(Z.expandedFarZProjMatrix,Mt,Mt,Ot,0,oe,Z.frustumCorners.TL,Z.frustumCorners.TR,Z.frustumCorners.BR,Z.frustumCorners.BL,Z.globeCenterInViewSpace,Z.globeRadius,le,0,Z._farZ),"globe_pole_raster",Rt,Ze,Ye);C.setupElevationDraw(ct,j,_e),M.uploadCommonUniforms(N,j,ze.toUnwrapped()),me&&M.renderDefaultNorthPole&&yt(j,Pe),ke&&M.renderDefaultSouthPole&&(Mt=n.cP(n.bz(),Mt,[1,-1,1]),yt(j,$e))}}}})(d,p,_,x,b);else{let M=d.context,C=M.gl,z,P,D=d.shadowRenderer,N=ss(d,d.longestCutoffRange),F=ne=>{if(P===ne)return;let he=[];he.push(tm[ne]),N.shouldRenderCutoff&&he.push("RENDER_CUTOFF"),D&&(he.push("RENDER_SHADOWS","DEPTH_TEXTURE"),D.useNormalOffset&&he.push("NORMAL_OFFSET")),z=d.getOrCreateProgram("terrainRaster",{defines:he}),P=ne},j=d.colorModeForRenderPass(),U=new bt(C.LEQUAL,bt.ReadWrite,d.depthRangeFor3D);La.update(b);let Z=d.transform,Y=xl(Z.zoom,p.exaggeration(),p.sourceCache._source.tileSize),Q=[0,0,0];if(D){let ne=d.style.directionalLight,he=d.style.ambientLight;ne&&he&&(Q=Ca(d.style,ne,he))}{P=-1;let ne=C.TRIANGLES,[he,de]=[p.gridIndexBuffer,p.gridSegments];for(let oe of x){let se=_.getTile(oe),le=Gt.disabled,Me=p.prevTerrainTileForTile[oe.key],_e=p.terrainTileForTile[oe.key];zd(Me,_e)&&La.newMorphing(oe.key,Me,_e,b,250),M.activeTexture.set(C.TEXTURE0),se.texture&&se.texture.bind(C.LINEAR,C.CLAMP_TO_EDGE);let Ve=La.getMorphValuesForProxy(oe.key),ze=Ve?1:0,je;Ve&&(je={morphing:{srcDemTile:Ve.from,dstDemTile:Ve.to,phase:n.dx(Ve.phase)}});let rt=Ld(oe.projMatrix,Fc(oe.canonical,Z.renderWorldCopies)?Y/10:Y,Q);if(F(ze),!z)continue;p.setupElevationDraw(se,z,je);let Ce=oe.toUnwrapped();D&&D.setupShadows(Ce,z),d.uploadCommonUniforms(M,z,Ce,null,N),z.draw(d,ne,U,le,j,Nt.backCCW,rt,"terrain_raster",p.gridBuffer,he,de)}}}}(o,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,o.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;let o=this.painter,c=this.painter.context,d=this.proxySourceCache,p=this.proxiedCoords[d.id],_=this._drapedRenderBatches.shift(),x=o.style.order,b=[],M=0;for(let C of p){let z=d.getTileByID(C.proxyTileKey),P=d.proxyCachedFBO[C.key]?d.proxyCachedFBO[C.key][t]:void 0,D=P!==void 0?d.renderCache[P]:this.pool[M++],N=P!==void 0;if(z.texture=D.tex,N&&!D.dirty){b.push(z.tileID);continue}let F;c.bindFramebuffer.set(D.fb.framebuffer),this.renderedToTile=!1,D.dirty&&(c.clear({color:n.am.transparent,stencil:0}),D.dirty=!1);for(let j=_.start;j<=_.end;++j){let U=o.style._mergedLayers[x[j]];if(U.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache(U),Y=Z?this.proxyToSource[C.key][Z.id]:[C];if(!Y)continue;let Q=Y;c.viewport.set([0,0,D.fb.width,D.fb.height]),F!==(Z?Z.id:null)&&(this._setupStencil(D,Y,U,Z),F=Z?Z.id:null),o.renderLayer(o,Z,U,Q)}if(this._drapedRenderBatches.length===0)for(let j of this._pendingGroundEffectLayers){let U=o.style._mergedLayers[x[j]];if(U.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache(U),Y=Z?this.proxyToSource[C.key][Z.id]:[C];if(!Y)continue;let Q=Y;c.viewport.set([0,0,D.fb.width,D.fb.height]),F!==(Z?Z.id:null)&&(this._setupStencil(D,Y,U,Z),F=Z?Z.id:null),o.renderLayer(o,Z,U,Q)}this.renderedToTile?(D.dirty=!0,b.push(z.tileID)):N||--M,M===5&&(M=0,this.renderToBackBuffer(b))}return this.renderToBackBuffer(b),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,o.width,o.height]),_.end+1}postRender(){}isLayerOrderingCorrect(t){let o=t.order.length,c=-1,d=o;for(let p=0;p<o;++p)this._style.isLayerDraped(t._mergedLayers[t.order[p]])?c=Math.max(c,p):d=Math.min(d,p);return d>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(o=>o.dem).forEach(o=>{t=Math.min(t,o.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,o,c){if(!this._visibleDemTiles)return null;let d=this._visibleDemTiles.filter(p=>p.dem).map(p=>{let _=p.tileID,x=1<<_.overscaledZ,{x:b,y:M}=_.canonical,C=b/x,z=(b+1)/x,P=M/x,D=(M+1)/x;return{minx:C,miny:P,maxx:z,maxy:D,t:p.dem.tree.raycastRoot(C,P,z,D,t,o,c),tile:p}});d.sort((p,_)=>(p.t!==null?p.t:Number.MAX_VALUE)-(_.t!==null?_.t:Number.MAX_VALUE));for(let p of d){if(p.t==null)return null;let _=p.tile.dem.tree.raycast(p.minx,p.miny,p.maxx,p.maxy,t,o,c);if(_!=null)return _}return null}_createFBO(){let t=this.painter.context,o=t.gl,c=this.drapeBufferSize;t.activeTexture.set(o.TEXTURE0);let d=new n.T(t,{width:c[0],height:c[1],data:null},o.RGBA8);d.bind(o.LINEAR,o.CLAMP_TO_EDGE);let p=t.createFramebuffer(c[0],c[1],!0,null);return p.colorAttachment.set(d.texture),p.depthAttachment=new Rd(t,p.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,p.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):p.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&o.texParameterf(o.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:p,tex:d,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{let o=this._style._mergedLayers[t],c=o.isHidden(this.painter.transform.zoom);return o.type==="hillshade"||o.type==="custom"?!c&&o.shouldRedrape():!c&&o.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(let c of this._style.getSources())if(c instanceof dc){t=!0;break}if(!t)return;let o={};for(let c=0;c<this._style.order.length;++c){let d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(p&&!o[p.id]&&!d.isHidden(this.painter.transform.zoom)&&d.type==="line"&&d.widthExpression()instanceof n.ab){o[p.id]=!0;for(let _ of this.proxyCoords){let x=this.proxyToSource[_.key][p.id];if(x)for(let b of x)this._clearRenderCacheForTile(p.id,b)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(let c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof mn){t=!0;break}if(!t)return;let o={};for(let c=0;c<this._style.order.length;++c){let d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(!p||o[p.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;let _=d.paint.get("raster-fade-duration");for(let x of this.proxyCoords){let b=this.proxyToSource[x.key][p.id];if(b)for(let M of b){let C=Hn(p.getTile(M),p.findLoadedParent(M,0),p,this.painter.transform,_);(C.opacity!==1||C.mix!==0)&&this._clearRenderCacheForTile(p.id,M)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();let t=this._style.order,o=t.length;if(o===0)return;let c=[];this._pendingGroundEffectLayers=[];let d,p=0,_=this._style._mergedLayers[t[p]];for(;!this._style.isLayerDraped(_)&&_.isHidden(this.painter.transform.zoom)&&++p<o;)_=this._style._mergedLayers[t[p]];for(;p<o;++p){let x=this._style._mergedLayers[t[p]];x.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(x)?d===void 0&&(d=p):(x.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(p),d!==void 0&&(c.push({start:d,end:p-1}),d=void 0)))}if(d!==void 0&&c.push({start:d,end:p-1}),c.length!==0){let x=c[c.length-1];this._pendingGroundEffectLayers.every(b=>b>x.end)||n.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){let o=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,o.renderCache.length>o.renderCachePool.length){let _=Object.values(o.proxyCachedFBO);o.proxyCachedFBO={};for(let x=0;x<_.length;++x){let b=Object.values(_[x]);o.renderCachePool.push(...b)}}return}this._clearRasterLayersFromRenderCache();let c=this.proxyCoords,d=this._tilesDirty;for(let _=c.length-1;_>=0;_--){let x=c[_];if(o.getTileByID(x.key),o.proxyCachedFBO[x.key]!==void 0){let b=t[x.key],M=this.proxyToSource[x.key],C=0;for(let z in M){let P=M[z],D=b[z];if(!D||D.length!==P.length||P.some((N,F)=>N!==D[F]||d[z]&&d[z].hasOwnProperty(N.key))){C=-1;break}++C}for(let z in o.proxyCachedFBO[x.key])o.renderCache[o.proxyCachedFBO[x.key][z]].dirty=C<0||C!==Object.values(b).length}}let p=[...this._drapedRenderBatches];p.sort((_,x)=>x.end-x.start-(_.end-_.start));for(let _ of p)for(let x of c){if(o.proxyCachedFBO[x.key])continue;let b=o.renderCachePool.pop();b===void 0&&o.renderCache.length<50&&(b=o.renderCache.length,o.renderCache.push(this._createFBO())),b!==void 0&&(o.proxyCachedFBO[x.key]={},o.proxyCachedFBO[x.key][_.start]=b,o.renderCache[b].dirty=!0)}this._tilesDirty={}}_setupStencil(t,o,c,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let p=this.painter.context,_=p.gl;if(o.length<=1)return void(this._overlapStencilType=!1);let x;if(c.isTileClipped())x=o.length,this._overlapStencilMode.test={func:_.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(o[0].overscaledZ>o[o.length-1].overscaledZ))return void(this._overlapStencilType=!1);x=1,this._overlapStencilMode.test={func:_.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+x>255&&(p.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=x,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(o,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Gt.disabled}_renderTileClippingMasks(t,o){let c=this.painter,d=this.painter.context,p=d.gl;c._tileClippingMaskIDs={},d.setColorMode(ti.disabled),d.setDepthMode(bt.disabled);let _=c.getOrCreateProgram("clippingMask");for(let x of t){let b=c._tileClippingMaskIDs[x.key]=--o;_.draw(c,p.TRIANGLES,bt.disabled,new Gt({func:p.ALWAYS,mask:0},b,255,p.KEEP,p.KEEP,p.REPLACE),ti.disabled,Nt.disabled,Yh(x.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){let o=this.painter.transform;if(t.x<0||t.x>o.width||t.y<0||t.y>o.height)return null;let c=[t.x,t.y,1,1];n.aA(c,c,o.pixelMatrixInverse),n.cH(c,c,1/c[3]),c[0]/=o.worldSize,c[1]/=o.worldSize;let d=o._camera.position,p=n.cb(1,o.center.lat),_=[d[0],d[1],d[2]/p,0],x=n.d7([],c.slice(0,3),_);n.au(x,x);let b=this.raycast(_,x,this._exaggeration);return b!==null&&b?(n.bE(_,_,x,b),_[3]=_[2],_[2]*=p,_):null}_setupProxiedCoordsForOrtho(t,o,c){if(t.getSource()instanceof n.aP)return this._setupProxiedCoordsForImageSource(t,o,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};let d=this.proxiedCoords[t.id]=[],p=this.proxyCoords;for(let b=0;b<p.length;b++){let M=p[b],C=this._findTileCoveringTileID(M,t);if(C){let z=this._createProxiedId(M,C,c[M.key]&&c[M.key][t.id]);d.push(z),this.proxyToSource[M.key][t.id]=[z]}}let _=!1,x=new Set;for(let b=0;b<o.length;b++){let M=t.getTile(o[b]);if(!M||!M.hasData())continue;let C=this._findTileCoveringTileID(M.tileID,this.proxySourceCache);if(C&&C.tileID.canonical.z!==M.tileID.canonical.z){let z=this.proxyToSource[C.tileID.key][t.id],P=this._createProxiedId(C.tileID,M,c[C.tileID.key]&&c[C.tileID.key][t.id]);z?z.splice(z.length-1,0,P):this.proxyToSource[C.tileID.key][t.id]=[P];let D=this.proxyToSource[C.tileID.key][t.id];x.has(D)||x.add(D),d.push(P),_=!0}}if(this._sourceTilesOverlap[t.id]=_,_&&this._debugParams.sortTilesHiZFirst)for(let b of x)b.sort((M,C)=>C.overscaledZ-M.overscaledZ)}_setupProxiedCoordsForImageSource(t,o,c){if(!t.getSource().loaded())return;let d=this.proxiedCoords[t.id]=[],p=this.proxyCoords,_=t.getSource(),x=_.tileID;if(!x)return;let b=new n.P(x.x,x.y)._div(1<<x.z),M=_.coordinates.map(n.ac.fromLngLat).reduce((z,P)=>(z.min.x=Math.min(z.min.x,P.x-b.x),z.min.y=Math.min(z.min.y,P.y-b.y),z.max.x=Math.max(z.max.x,P.x-b.x),z.max.y=Math.max(z.max.y,P.y-b.y),z),{min:new n.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new n.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),C=(z,P)=>{let D=z.wrap+z.canonical.x/(1<<z.canonical.z),N=z.canonical.y/(1<<z.canonical.z),F=n.aj/(1<<z.canonical.z),j=P.wrap+P.canonical.x/(1<<P.canonical.z),U=P.canonical.y/(1<<P.canonical.z);return D+F<j+M.min.x||D>j+M.max.x||N+F<U+M.min.y||N>U+M.max.y};for(let z=0;z<p.length;z++){let P=p[z];for(let D=0;D<o.length;D++){let N=t.getTile(o[D]);if(!N||!N.hasData()||C(P,N.tileID))continue;let F=this._createProxiedId(P,N,c[P.key]&&c[P.key][t.id]),j=this.proxyToSource[P.key][t.id];j?j.push(F):this.proxyToSource[P.key][t.id]=[F],d.push(F)}}}_createProxiedId(t,o,c){let d=this.orthoMatrix;if(c){let p=c.find(_=>_.key===o.tileID.key);if(p)return p}if(o.tileID.key!==t.key){let p=t.canonical.z-o.tileID.canonical.z,_,x,b;d=n.bz();let M=o.tileID.wrap-t.wrap<<t.overscaledZ;p>0?(_=n.aj>>p,x=_*((o.tileID.canonical.x<<p)-t.canonical.x+M),b=_*((o.tileID.canonical.y<<p)-t.canonical.y)):(_=n.aj<<-p,x=n.aj*(o.tileID.canonical.x-(t.canonical.x+M<<-p)),b=n.aj*(o.tileID.canonical.y-(t.canonical.y<<-p))),n.ca(d,0,_,0,_,0,1),n.bo(d,d,[x,b,0])}return new Bc(o.tileID,t.key,d)}_findTileCoveringTileID(t,o){let c=o.getTile(t);if(c&&c.hasData())return c;let d=this._findCoveringTileCache[o.id],p=d[t.key];if(c=p?o.getTileByID(p):null,c&&c.hasData()||p===null)return c;let _=c?c.tileID:t,x=_.overscaledZ,b=o.getSource().minzoom,M=[];if(!p){let z=o.getSource().maxzoom;if(t.canonical.z>=z){let P=t.canonical.z-z;o.getSource().reparseOverscaled?(x=Math.max(t.canonical.z+2,o.transform.tileZoom),_=new n.aM(x,t.wrap,z,t.canonical.x>>P,t.canonical.y>>P)):P!==0&&(x=z,_=new n.aM(x,t.wrap,z,t.canonical.x>>P,t.canonical.y>>P))}_.key!==t.key&&(M.push(_.key),c=o.getTile(_))}let C=z=>{M.forEach(P=>{d[P]=z}),M.length=0};for(x-=1;x>=b&&(!c||!c.hasData());x--){c&&C(c.tileID.key);let z=_.calculateScaledKey(x);if(c=o.getTileByID(z),c&&c.hasData())break;let P=d[z];if(P===null)break;P===void 0?M.push(z):c=o.getTileByID(P)}return C(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,o){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[o.key]=!0}}function Od(l,t,o){let c=function(x,b,M){let C=n.bG(b,x),z=n.bG(M,[.2126,.7152,.0722]),P=(N,F,j)=>(1-j)*N+j*F,D=P(1-.3*Math.min(z,1),1,Math.min(C+1,1));return P(.92,1,Math.asin(n.ay(b[2],-1,1))/Math.PI+.5)*D}(l,[0,0,1],t),d=[0,0,0];n.c1(d,o.slice(0,3),c);let p=[0,0,0];n.c1(p,t.slice(0,3),l[2]);let _=[0,0,0];return n.d5(_,d,p),n.d8(_)}let kd=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Qh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class eu{static cacheKey(t,o,c,d){let p=`${o}${d?d.cacheKey:""}`;for(let _ of c)t.usedDefines.includes(_)&&(p+=`/${_}`);return p}constructor(t,o,c,d,p,_){let x=t.gl;this.program=x.createProgram(),this.configuration=d,this.name=o,this.fixedDefines=[..._];let b=d?d.getBinderAttributes():[],M=(c.staticAttributes||[]).concat(b),C=d?d.defines():[];C=C.concat(_.map(j=>`#define ${j}`));let z=`#version 300 es
`,P=z+C.concat("precision mediump float;",Ks,Uh.fragmentSource).join(`
=======
`}),staticAttributes:d,usedDefines:b,vertexIncludes:_,fragmentIncludes:x}}class gg{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,o,c,d,p,_,x,b){this.context=t;let M=this.boundPaintVertexBuffers.length!==d.length;for(let z=0;!M&&z<d.length;z++)this.boundPaintVertexBuffers[z]!==d[z]&&(M=!0);let C=this.boundDynamicVertexBuffers.length!==x.length;for(let z=0;!C&&z<x.length;z++)this.boundDynamicVertexBuffers[z]!==x[z]&&(C=!0);if(!this.vao||this.boundProgram!==o||this.boundLayoutVertexBuffer!==c||M||C||this.boundIndexBuffer!==p||this.boundVertexOffset!==_)this.freshBind(o,c,d,p,_,x,b);else{t.bindVertexArrayOES.set(this.vao);for(let z of x)z&&(z.bind(),b&&z.instanceCount&&z.setVertexAttribDivisor(t.gl,o,b));p&&p.dynamicDraw&&p.bind()}}freshBind(t,o,c,d,p,_,x){let b=t.numAttributes,M=this.context,C=M.gl;this.vao&&this.destroy(),this.vao=M.gl.createVertexArray(),M.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=o,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=d,this.boundVertexOffset=p,this.boundDynamicVertexBuffers=_,o.enableAttributes(C,t),o.bind(),o.setVertexAttribPointers(C,t,p);for(let z of c)z.enableAttributes(C,t),z.bind(),z.setVertexAttribPointers(C,t,p);for(let z of _)z&&(z.enableAttributes(C,t),z.bind(),z.setVertexAttribPointers(C,t,p),x&&z.instanceCount&&z.setVertexAttribDivisor(C,t,x));d&&d.bind(),M.currentNumAttributes=b}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function wd(l,t){let o=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new n.ac(0,c/o).toLngLat().lat,new n.ac(0,(c+1)/o).toLngLat().lat]}function yg(l,t,o,c,d,p,_){let x=l.context,b=x.gl,M=o.hillshadeFBO;if(!M)return;l.prepareDrawTile();let C=l.isTileAffectedByFog(t),z=l.getOrCreateProgram("hillshade",{overrideFog:C});x.activeTexture.set(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,M.colorAttachment.get());let P=((j,U,Z,Y)=>{let Q=Z.paint.get("hillshade-shadow-color"),ne=Z.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",he=Z.paint.get("hillshade-highlight-color"),de=Z.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",oe=Z.paint.get("hillshade-accent-color"),se=Z.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",le=Z.paint.get("hillshade-emissive-strength"),Me=n.al(Z.paint.get("hillshade-illumination-direction"));if(Z.paint.get("hillshade-illumination-anchor")==="viewport")Me-=j.transform.angle;else if(j.style&&j.style.enable3dLights()&&j.style.directionalLight){let Ve=j.style.directionalLight.properties.get("direction"),ze=n.d1(Ve.x,Ve.y,Ve.z);Me=n.al(ze[1])}let _e=!j.options.moving;return{u_matrix:Y||j.transform.calculateProjMatrix(U.tileID.toUnwrapped(),_e),u_image:0,u_latrange:wd(0,U.tileID),u_light:[Z.paint.get("hillshade-exaggeration"),Me],u_shadow:Q.toPremultipliedRenderColor(ne?null:Z.lut),u_highlight:he.toPremultipliedRenderColor(de?null:Z.lut),u_emissive_strength:le,u_accent:oe.toPremultipliedRenderColor(se?null:Z.lut)}})(l,o,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(x,z,t.toUnwrapped());let{tileBoundsBuffer:D,tileBoundsIndexBuffer:N,tileBoundsSegments:F}=l.getTileBoundsBuffers(o);z.draw(l,b.TRIANGLES,d,p,_,Nt.disabled,P,c.id,D,N,F)}function Td(l,t,o){if(!t.needsDEMTextureUpload)return;let c=l.context,d=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(o.stride);let p=o.getPixels();t.demTexture?t.demTexture.update(p,{premultiply:!1}):t.demTexture=new n.T(c,p,d.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function qf(l,t,o){let c=l.context,d=c.gl;if(!t.dem)return;let p=t.dem;if(c.activeTexture.set(d.TEXTURE1),Td(l,t,p),!t.demTexture)return;t.demTexture.bind(d.NEAREST,d.CLAMP_TO_EDGE);let _=p.dim;c.activeTexture.set(d.TEXTURE0);let x=t.hillshadeFBO;if(!x){let P=new n.T(c,{width:_,height:_,data:null},d.RGBA8);P.bind(d.LINEAR,d.CLAMP_TO_EDGE),x=t.hillshadeFBO=c.createFramebuffer(_,_,!0,"renderbuffer"),x.colorAttachment.set(P.texture)}c.bindFramebuffer.set(x.framebuffer),c.viewport.set([0,0,_,_]);let{tileBoundsBuffer:b,tileBoundsIndexBuffer:M,tileBoundsSegments:C}=l.getMercatorTileBoundsBuffers(),z=[];l.linearFloatFilteringSupported()&&z.push("TERRAIN_DEM_FLOAT_FORMAT"),l.getOrCreateProgram("hillshadePrepare",{defines:z}).draw(l,d.TRIANGLES,bt.disabled,Gt.disabled,ti.unblended,Nt.disabled,((P,D)=>{let N=D.stride,F=n.bz();return n.ca(F,0,n.aj,-n.aj,0,0,1),n.bo(F,F,[0,-n.aj,0]),{u_matrix:F,u_image:1,u_dimension:[N,N],u_zoom:P.overscaledZ}})(t.tileID,p),o.id,b,M,C),t.needsHillshadePrepare=!1}class pr{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class xg extends pr{getDefault(){return n.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class vg extends pr{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class bg extends pr{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class wg extends pr{getDefault(){return[!0,!0,!0,!0]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Hf extends pr{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Tg extends pr{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class Uh extends pr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){let o=this.current;(t.func!==o.func||t.ref!==o.ref||t.mask!==o.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Sg extends pr{getDefault(){let t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class $f extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),this.current=t,this.dirty=!1}}class Sd extends pr{getDefault(){return[0,1]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class jh extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.current=t,this.dirty=!1}}class Ed extends pr{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Pa extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.BLEND):o.disable(o.BLEND),this.current=t,this.dirty=!1}}class fl extends pr{getDefault(){let t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Gh extends pr{getDefault(){return n.am.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class qh extends pr{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class ml extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.CULL_FACE):o.disable(o.CULL_FACE),this.current=t,this.dirty=!1}}class Zf extends pr{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Id extends pr{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Wf=class extends pr{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class _l extends pr{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Hh extends pr{getDefault(){let t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class $h extends pr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Ad extends pr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindRenderbuffer(o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Zh extends pr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindTexture(o.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Oc extends pr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindBuffer(o.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Xf extends pr{getDefault(){return null}set(t){let o=this.gl;o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Yf extends pr{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class Kf extends pr{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class gl extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class Jf extends pr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Md extends pr{constructor(t,o){super(t),this.context=t,this.parent=o}getDefault(){return null}}class Eg extends Md{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Qf extends Md{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferRenderbuffer(o.FRAMEBUFFER,this.attachment(),o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Cd extends Md{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,this.attachment(),o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Pd extends Qf{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}let Rd=(l,t,o)=>({u_matrix:l,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:o}),Wh=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:o,u_zoom_transition:d,u_merc_center:p,u_image0:0,u_frustum_tl:_,u_frustum_tr:x,u_frustum_br:b,u_frustum_bl:M,u_globe_pos:C,u_globe_radius:z,u_viewport:P,u_grid_matrix:F?Float32Array.from(F):new Float32Array(9),u_skirt_height:D,u_far_z_cutoff:N});function Ld(l,t){return l!=null&&t!=null&&!(!l.hasData()||!t.hasData())&&l.demTexture!=null&&t.demTexture!=null&&l.tileID.key!==t.tileID.key}let Ra=new class{constructor(){this.operations={}}newMorphing(l,t,o,c,d){if(l in this.operations){let p=this.operations[l];p.to.tileID.key!==o.tileID.key&&(p.queued=o)}else this.operations[l]={startTime:c,phase:0,duration:d,from:t,to:o,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;let t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(let t in this.operations){let o=this.operations[t];for(o.phase=(l-o.startTime)/o.duration;o.phase>=1||!this._validOp(o);)if(!this._nextOp(o,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},em={0:null,1:"TERRAIN_VERTEX_MORPHING"};function yl(l,t,o){if(t===0)return 0;let c=t<1&&o===514?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function kc(l,t){let o=1<<l.z;return!t&&(l.x===0||l.x===o-1)||l.y===0||l.y===o-1}let Xh=l=>({u_matrix:l});function qn(l,t,o,c,d){if(d>0){let p=n.q.now(),_=(p-l.timeAdded)/d,x=t?(p-t.timeAdded)/d:-1,b=o.getSource(),M=c.coveringZoomLevel({tileSize:b.tileSize,roundZoom:b.roundZoom}),C=!t||Math.abs(t.tileID.overscaledZ-M)>Math.abs(l.tileID.overscaledZ-M),z=C&&l.refreshedUponExpiration?1:n.ay(C?_:1-x,0,1);return l.refreshedUponExpiration&&_>=1&&(l.refreshedUponExpiration=!1),t?{opacity:1,mix:1-z}:{opacity:z,mix:0}}return{opacity:1,mix:0}}class zd extends jn{constructor(t){let o=dc("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",o,!1),o.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,o){t.state="loaded",o(null)}}class Yh extends jn{constructor(t){let o=dc("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",o,!1),o.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,o,c){if(t.freezeTileCoverage)return;this.transform=t;let d=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((p,_)=>{if(p[_.key]="",!this._tiles[_.key]){let x=new ba(_,this._source.tileSize*_.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);x.state="loaded",this._tiles[_.key]=x}return p},{});for(let p in this._tiles)p in d||(this.freeFBO(p),this._tiles[p].unloadVectorData(),delete this._tiles[p])}freeFBO(t){let o=this.proxyCachedFBO[t];if(o!==void 0){let c=Object.values(o);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Fc extends n.aM{constructor(t,o,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=o,this.projMatrix=c}}class Kh extends n.dF{constructor(t,o){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[c,d,p]=function(b){let M=new n.ba,C=new n.a_,z=131;M.reserve(17161),C.reserve(33800);let P=n.aj/128,D=n.aj+P/2,N=D+P;for(let j=-P;j<N;j+=P)for(let U=-P;U<N;U+=P){let Z=U<0||U>D||j<0||j>D?24575:0,Y=n.ay(Math.round(U),0,n.aj),Q=n.ay(Math.round(j),0,n.aj);M.emplaceBack(Y+Z,Q)}let F=(j,U)=>{let Z=U*z+j;C.emplaceBack(Z+1,Z,Z+z),C.emplaceBack(Z+z,Z+z+1,Z+1)};for(let j=1;j<129;j++)for(let U=1;U<129;U++)F(U,j);return[0,129].forEach(j=>{for(let U=0;U<130;U++)F(U,j),F(j,U)}),[M,C,32768]}(),_=t.context;this.gridBuffer=_.createVertexBuffer(c,n.bc.members),this.gridIndexBuffer=_.createIndexBuffer(d),this.gridSegments=n.bd.simpleSegment(0,0,c.length,d.length),this.gridNoSkirtSegments=n.bd.simpleSegment(0,0,c.length,p),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Yh(o.map),this.orthoMatrix=n.bz(),n.ca(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,n.aj,0,n.aj,0,1);let x=_.gl;this._overlapStencilMode=new Gt({func:x.GEQUAL,mask:255},0,255,x.KEEP,x.KEEP,x.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=o,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new zd(o.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,o,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);let d=t.terrain.properties,p=t.terrain.drapeRenderMode===0,_=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=n.q.now();let x=t.terrain&&t.terrain.scope,b=d.get("source"),M=p?this._mockSourceCache:t.getSourceCache(b,x);if(!M)return void n.w(`Couldn't find terrain source "${b}".`);if(this.sourceCache=M,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=_?this.calculateExaggeration(o):d.get("exaggeration"),!o.projection.requiresDraping&&_&&this._exaggeration===0)return void this._disable();this.enabled=!0;let C=()=>{this.sourceCache.used&&n.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let z=this.getScaledDemTileSize();this.sourceCache.update(o,z,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,C(),this._initializing=!0),C(),o.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(o),this._emptyDEMTextureDirty=!0,this._previousZoom=o.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);let o=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;let d=o!=null?c-o:Number.MAX_VALUE;if(Math.abs(d)<2)return this._exaggeration;let p=t.zoom,_=this._style.terrain;if(!this._previousUpdateTimestamp)return _.getExaggeration(p);let x=p-this._previousZoom,b=this._previousUpdateTimestamp,M=p;this._evaluationZoom!=null&&(M=this._evaluationZoom,Math.abs(p-M)>.5&&(x=.5*(p-M+x)),x*d<0&&(M+=x)),this._evaluationZoom=M;let C=_.getExaggeration(M),z=C===_.getExaggeration(Math.max(0,M-.1));if(z&&Math.abs(C-this._exaggeration)<.01)return C;let P=Math.min(.1,.00375*(this._updateTimestamp-b));return(z||C<.1||Math.abs(x)<1e-4)&&(P=Math.min(.2,4*P)),n.ai(this._exaggeration,C,P)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let o=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(n.ac.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);let d=this.proxyCoords=o.getIds().map(b=>{let M=o.getTileByID(b).tileID;return M.projMatrix=c.calculateProjMatrix(M.toUnwrapped()),M});(function(b,M){let C=M.transform.pointCoordinate(M.transform.getCameraPoint()),z=new n.P(C.x,C.y);b.sort((P,D)=>{if(D.overscaledZ-P.overscaledZ)return D.overscaledZ-P.overscaledZ;let N=new n.P(P.canonical.x+(1<<P.canonical.z)*P.wrap,P.canonical.y),F=new n.P(D.canonical.x+(1<<D.canonical.z)*D.wrap,D.canonical.y),j=z.mult(1<<P.canonical.z);return j.x-=.5,j.y-=.5,j.distSqr(N)-j.distSqr(F)})})(d,this.painter);let p=this.proxyToSource||{};this.proxyToSource={},d.forEach(b=>{this.proxyToSource[b.key]={}}),this.terrainTileForTile={};let _=this._style._mergedSourceCaches;for(let b in _){let M=_[b];if(!M.used||(M!==this.sourceCache&&this.resetTileLookupCache(M.id),this._setupProxiedCoordsForOrtho(M,t[b],p),M.usedForTerrain))continue;let C=t[b];M.getSource().reparseOverscaled&&this._assignTerrainTiles(C)}this.proxiedCoords[o.id]=d.map(b=>new Fc(b,b.key,this.orthoMatrix)),this._assignTerrainTiles(d),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(p),this.renderingToTexture=!1;let x={};this._visibleDemTiles=[];for(let b of this.proxyCoords){let M=this.terrainTileForTile[b.key];if(!M)continue;let C=M.tileID.key;C in x||(this._visibleDemTiles.push(M),x[C]=C)}}_assignTerrainTiles(t){this._initializing||t.forEach(o=>{if(this.terrainTileForTile[o.key])return;let c=this._findTileCoveringTileID(o,this.sourceCache);c&&(this.terrainTileForTile[o.key]=c)})}_prepareDEMTextures(){let t=this.painter.context,o=t.gl;for(let c in this.terrainTileForTile){let d=this.terrainTileForTile[c],p=d.dem;!p||d.demTexture&&!d.needsDEMTextureUpload||(t.activeTexture.set(o.TEXTURE1),Td(this.painter,d,p))}}_prepareDemTileUniforms(t,o,c,d){if(!o||o.demTexture==null)return!1;let p=t.tileID.canonical,_=Math.pow(2,o.tileID.canonical.z-p.z),x=d||"";return c[`u_dem_tl${x}`]=[p.x*_%1,p.y*_%1],c[`u_dem_scale${x}`]=_,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0,o=this._visibleDemTiles.reduce((c,d)=>{if(!d.dem)return c;let p=d.dem.tree.minimums[0];return p>0&&t++,c+p},0);return t?o/t:0}_updateEmptyDEMTexture(){let t=this.painter.context,o=t.gl;t.activeTexture.set(o.TEXTURE2);let c=this._getLoadedAreaMinimum(),d=new n.dG({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let p=this._emptyDEMTexture;return p?p.update(d,{premultiply:!1}):p=this._emptyDEMTexture=new n.T(t,d,o.R32F,{premultiply:!1}),p}setupElevationDraw(t,o,c){let d=this.painter.context,p=d.gl,_={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};_.u_exaggeration=this.exaggeration();let x=null,b=null,M=1;if(c&&c.morphing&&this._useVertexMorphing){let D=c.morphing.srcDemTile,N=c.morphing.dstDemTile;M=c.morphing.phase,D&&N&&(this._prepareDemTileUniforms(t,D,_,"_prev")&&(b=D),this._prepareDemTileUniforms(t,N,_)&&(x=N))}let C=D=>D&&D.demTexture&&this.painter.linearFloatFilteringSupported()?p.LINEAR:p.NEAREST,z=null;var P;if(this.enabled?b&&x?(z=x.demTexture,d.activeTexture.set(p.TEXTURE4),b.demTexture.bind(C(b),p.CLAMP_TO_EDGE),_.u_dem_lerp=M):(x=this.terrainTileForTile[t.tileID.key],z=this._prepareDemTileUniforms(t,x,_)?x.demTexture:this.emptyDEMTexture):z=this.emptyDEMTexture,d.activeTexture.set(p.TEXTURE2),z&&(_.u_dem_size=(P=z).size[0]===1?1:P.size[0]-2,z.bind(C(x),p.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,o,_),c&&c.useMeterToDem&&x){let D=(1<<x.tileID.canonical.z)*n.cb(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;_.u_meter_to_dem=D}if(c&&c.labelPlaneMatrixInv&&(_.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),o.setTerrainUniformValues(d,_),this.painter.transform.projection.name==="globe"){let D=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);o.setGlobeUniformValues(d,D)}}globeUniformValues(t,o,c){let d=t.projection;return{u_tile_tl_up:d.upVector(o,0,0),u_tile_tr_up:d.upVector(o,n.aj,0),u_tile_br_up:d.upVector(o,n.aj,n.aj),u_tile_bl_up:d.upVector(o,0,n.aj),u_tile_up_scale:c?n.dH(1):d.upVectorScale(o,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){let o=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,o.width,o.height]),o.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(d,p,_,x,b){if(d.transform.projection.name==="globe")(function(M,C,z,P,D){let N=M.context,F=N.gl,j,U,Z=M.transform,Y=n.dy(M,N,Z),Q=(Ve,ze)=>{if(U===ze)return;let je=[em[ze],"PROJECTION_GLOBE_VIEW"];Y&&je.push("CUSTOM_ANTIALIASING");let rt=M.isTileAffectedByFog(Ve);j=M.getOrCreateProgram("globeRaster",{defines:je,overrideFog:rt}),U=ze},ne=M.colorModeForRenderPass(),he=new bt(F.LEQUAL,bt.ReadWrite,M.depthRangeFor3D);Ra.update(D);let de=n.dz(Z),oe=[n.aD(Z.center.lng),n.aH(Z.center.lat)],se=M.globeSharedBuffers,le=[Z.width*n.q.devicePixelRatio,Z.height*n.q.devicePixelRatio],Me=Float32Array.from(Z.globeMatrix),_e={useDenormalizedUpVectorScale:!0};{let Ve=M.transform,ze=yl(Ve.zoom,C.exaggeration(),C.sourceCache._source.tileSize);U=-1;let je=F.TRIANGLES;for(let rt of P){let Ce=z.getTile(rt),me=Gt.disabled,ke=C.prevTerrainTileForTile[rt.key],Pe=C.terrainTileForTile[rt.key];Ld(ke,Pe)&&Ra.newMorphing(rt.key,ke,Pe,D,250),N.activeTexture.set(F.TEXTURE0),Ce.texture&&Ce.texture.bind(F.LINEAR,F.CLAMP_TO_EDGE);let $e=Ra.getMorphValuesForProxy(rt.key),Ze=$e?1:0;$e&&n.L(_e,{morphing:{srcDemTile:$e.from,dstDemTile:$e.to,phase:n.dx($e.phase)}});let Ye=n.dA(rt.canonical),ct=n.dB(Ye.getCenter().lat),Mt=n.dC(rt.canonical,Ye,ct,Ve.worldSize/Ve._pixelsPerMercatorPixel),Ot=n.bh(n.dD(rt.canonical)),yt=Wh(Ve.expandedFarZProjMatrix,Me,de,Ot,n.ah(Ve.zoom),oe,Ve.frustumCorners.TL,Ve.frustumCorners.TR,Ve.frustumCorners.BR,Ve.frustumCorners.BL,Ve.globeCenterInViewSpace,Ve.globeRadius,le,ze,Ve._farZ,Mt);if(Q(rt,Ze),j&&(C.setupElevationDraw(Ce,j,_e),M.uploadCommonUniforms(N,j,rt.toUnwrapped()),se)){let[zt,Rt,$t]=se.getGridBuffers(ct,ze!==0);j.draw(M,je,he,me,ne,Nt.backCCW,yt,"globe_raster",zt,Rt,$t)}}}if(se&&(M.renderDefaultNorthPole||M.renderDefaultSouthPole)){let Ve=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];Y&&Ve.push("CUSTOM_ANTIALIASING"),j=M.getOrCreateProgram("globeRaster",{defines:Ve});for(let ze of P){let{x:je,y:rt,z:Ce}=ze.canonical,me=rt===0,ke=rt===(1<<Ce)-1,[Pe,$e,Ze,Ye]=se.getPoleBuffers(Ce,!1);if(Ye&&(me||ke)){let ct=z.getTile(ze);N.activeTexture.set(F.TEXTURE0),ct.texture&&ct.texture.bind(F.LINEAR,F.CLAMP_TO_EDGE);let Mt=n.dE(Ce,je,Z),Ot=n.bh(n.dD(ze.canonical)),yt=(zt,Rt)=>zt.draw(M,F.TRIANGLES,he,Gt.disabled,ne,Nt.disabled,Wh(Z.expandedFarZProjMatrix,Mt,Mt,Ot,0,oe,Z.frustumCorners.TL,Z.frustumCorners.TR,Z.frustumCorners.BR,Z.frustumCorners.BL,Z.globeCenterInViewSpace,Z.globeRadius,le,0,Z._farZ),"globe_pole_raster",Rt,Ze,Ye);C.setupElevationDraw(ct,j,_e),M.uploadCommonUniforms(N,j,ze.toUnwrapped()),me&&M.renderDefaultNorthPole&&yt(j,Pe),ke&&M.renderDefaultSouthPole&&(Mt=n.cP(n.bz(),Mt,[1,-1,1]),yt(j,$e))}}}})(d,p,_,x,b);else{let M=d.context,C=M.gl,z,P,D=d.shadowRenderer,N=ss(d,d.longestCutoffRange),F=ne=>{if(P===ne)return;let he=[];he.push(em[ne]),N.shouldRenderCutoff&&he.push("RENDER_CUTOFF"),D&&(he.push("RENDER_SHADOWS","DEPTH_TEXTURE"),D.useNormalOffset&&he.push("NORMAL_OFFSET")),z=d.getOrCreateProgram("terrainRaster",{defines:he}),P=ne},j=d.colorModeForRenderPass(),U=new bt(C.LEQUAL,bt.ReadWrite,d.depthRangeFor3D);Ra.update(b);let Z=d.transform,Y=yl(Z.zoom,p.exaggeration(),p.sourceCache._source.tileSize),Q=[0,0,0];if(D){let ne=d.style.directionalLight,he=d.style.ambientLight;ne&&he&&(Q=Ma(d.style,ne,he))}{P=-1;let ne=C.TRIANGLES,[he,de]=[p.gridIndexBuffer,p.gridSegments];for(let oe of x){let se=_.getTile(oe),le=Gt.disabled,Me=p.prevTerrainTileForTile[oe.key],_e=p.terrainTileForTile[oe.key];Ld(Me,_e)&&Ra.newMorphing(oe.key,Me,_e,b,250),M.activeTexture.set(C.TEXTURE0),se.texture&&se.texture.bind(C.LINEAR,C.CLAMP_TO_EDGE);let Ve=Ra.getMorphValuesForProxy(oe.key),ze=Ve?1:0,je;Ve&&(je={morphing:{srcDemTile:Ve.from,dstDemTile:Ve.to,phase:n.dx(Ve.phase)}});let rt=Rd(oe.projMatrix,kc(oe.canonical,Z.renderWorldCopies)?Y/10:Y,Q);if(F(ze),!z)continue;p.setupElevationDraw(se,z,je);let Ce=oe.toUnwrapped();D&&D.setupShadows(Ce,z),d.uploadCommonUniforms(M,z,Ce,null,N),z.draw(d,ne,U,le,j,Nt.backCCW,rt,"terrain_raster",p.gridBuffer,he,de)}}}}(o,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,o.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;let o=this.painter,c=this.painter.context,d=this.proxySourceCache,p=this.proxiedCoords[d.id],_=this._drapedRenderBatches.shift(),x=o.style.order,b=[],M=0;for(let C of p){let z=d.getTileByID(C.proxyTileKey),P=d.proxyCachedFBO[C.key]?d.proxyCachedFBO[C.key][t]:void 0,D=P!==void 0?d.renderCache[P]:this.pool[M++],N=P!==void 0;if(z.texture=D.tex,N&&!D.dirty){b.push(z.tileID);continue}let F;c.bindFramebuffer.set(D.fb.framebuffer),this.renderedToTile=!1,D.dirty&&(c.clear({color:n.am.transparent,stencil:0}),D.dirty=!1);for(let j=_.start;j<=_.end;++j){let U=o.style._mergedLayers[x[j]];if(U.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache(U),Y=Z?this.proxyToSource[C.key][Z.id]:[C];if(!Y)continue;let Q=Y;c.viewport.set([0,0,D.fb.width,D.fb.height]),F!==(Z?Z.id:null)&&(this._setupStencil(D,Y,U,Z),F=Z?Z.id:null),o.renderLayer(o,Z,U,Q)}if(this._drapedRenderBatches.length===0)for(let j of this._pendingGroundEffectLayers){let U=o.style._mergedLayers[x[j]];if(U.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache(U),Y=Z?this.proxyToSource[C.key][Z.id]:[C];if(!Y)continue;let Q=Y;c.viewport.set([0,0,D.fb.width,D.fb.height]),F!==(Z?Z.id:null)&&(this._setupStencil(D,Y,U,Z),F=Z?Z.id:null),o.renderLayer(o,Z,U,Q)}this.renderedToTile?(D.dirty=!0,b.push(z.tileID)):N||--M,M===5&&(M=0,this.renderToBackBuffer(b))}return this.renderToBackBuffer(b),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,o.width,o.height]),_.end+1}postRender(){}isLayerOrderingCorrect(t){let o=t.order.length,c=-1,d=o;for(let p=0;p<o;++p)this._style.isLayerDraped(t._mergedLayers[t.order[p]])?c=Math.max(c,p):d=Math.min(d,p);return d>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(o=>o.dem).forEach(o=>{t=Math.min(t,o.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,o,c){if(!this._visibleDemTiles)return null;let d=this._visibleDemTiles.filter(p=>p.dem).map(p=>{let _=p.tileID,x=1<<_.overscaledZ,{x:b,y:M}=_.canonical,C=b/x,z=(b+1)/x,P=M/x,D=(M+1)/x;return{minx:C,miny:P,maxx:z,maxy:D,t:p.dem.tree.raycastRoot(C,P,z,D,t,o,c),tile:p}});d.sort((p,_)=>(p.t!==null?p.t:Number.MAX_VALUE)-(_.t!==null?_.t:Number.MAX_VALUE));for(let p of d){if(p.t==null)return null;let _=p.tile.dem.tree.raycast(p.minx,p.miny,p.maxx,p.maxy,t,o,c);if(_!=null)return _}return null}_createFBO(){let t=this.painter.context,o=t.gl,c=this.drapeBufferSize;t.activeTexture.set(o.TEXTURE0);let d=new n.T(t,{width:c[0],height:c[1],data:null},o.RGBA8);d.bind(o.LINEAR,o.CLAMP_TO_EDGE);let p=t.createFramebuffer(c[0],c[1],!0,null);return p.colorAttachment.set(d.texture),p.depthAttachment=new Pd(t,p.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,p.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):p.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&o.texParameterf(o.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:p,tex:d,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{let o=this._style._mergedLayers[t],c=o.isHidden(this.painter.transform.zoom);return o.type==="hillshade"||o.type==="custom"?!c&&o.shouldRedrape():!c&&o.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(let c of this._style.getSources())if(c instanceof uc){t=!0;break}if(!t)return;let o={};for(let c=0;c<this._style.order.length;++c){let d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(p&&!o[p.id]&&!d.isHidden(this.painter.transform.zoom)&&d.type==="line"&&d.widthExpression()instanceof n.ab){o[p.id]=!0;for(let _ of this.proxyCoords){let x=this.proxyToSource[_.key][p.id];if(x)for(let b of x)this._clearRenderCacheForTile(p.id,b)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(let c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof mn){t=!0;break}if(!t)return;let o={};for(let c=0;c<this._style.order.length;++c){let d=this._style._mergedLayers[this._style.order[c]],p=this._style.getLayerSourceCache(d);if(!p||o[p.id]||d.isHidden(this.painter.transform.zoom)||d.type!=="raster")continue;let _=d.paint.get("raster-fade-duration");for(let x of this.proxyCoords){let b=this.proxyToSource[x.key][p.id];if(b)for(let M of b){let C=qn(p.getTile(M),p.findLoadedParent(M,0),p,this.painter.transform,_);(C.opacity!==1||C.mix!==0)&&this._clearRenderCacheForTile(p.id,M)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();let t=this._style.order,o=t.length;if(o===0)return;let c=[];this._pendingGroundEffectLayers=[];let d,p=0,_=this._style._mergedLayers[t[p]];for(;!this._style.isLayerDraped(_)&&_.isHidden(this.painter.transform.zoom)&&++p<o;)_=this._style._mergedLayers[t[p]];for(;p<o;++p){let x=this._style._mergedLayers[t[p]];x.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(x)?d===void 0&&(d=p):(x.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(p),d!==void 0&&(c.push({start:d,end:p-1}),d=void 0)))}if(d!==void 0&&c.push({start:d,end:p-1}),c.length!==0){let x=c[c.length-1];this._pendingGroundEffectLayers.every(b=>b>x.end)||n.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){let o=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,o.renderCache.length>o.renderCachePool.length){let _=Object.values(o.proxyCachedFBO);o.proxyCachedFBO={};for(let x=0;x<_.length;++x){let b=Object.values(_[x]);o.renderCachePool.push(...b)}}return}this._clearRasterLayersFromRenderCache();let c=this.proxyCoords,d=this._tilesDirty;for(let _=c.length-1;_>=0;_--){let x=c[_];if(o.getTileByID(x.key),o.proxyCachedFBO[x.key]!==void 0){let b=t[x.key],M=this.proxyToSource[x.key],C=0;for(let z in M){let P=M[z],D=b[z];if(!D||D.length!==P.length||P.some((N,F)=>N!==D[F]||d[z]&&d[z].hasOwnProperty(N.key))){C=-1;break}++C}for(let z in o.proxyCachedFBO[x.key])o.renderCache[o.proxyCachedFBO[x.key][z]].dirty=C<0||C!==Object.values(b).length}}let p=[...this._drapedRenderBatches];p.sort((_,x)=>x.end-x.start-(_.end-_.start));for(let _ of p)for(let x of c){if(o.proxyCachedFBO[x.key])continue;let b=o.renderCachePool.pop();b===void 0&&o.renderCache.length<50&&(b=o.renderCache.length,o.renderCache.push(this._createFBO())),b!==void 0&&(o.proxyCachedFBO[x.key]={},o.proxyCachedFBO[x.key][_.start]=b,o.renderCache[b].dirty=!0)}this._tilesDirty={}}_setupStencil(t,o,c,d){if(!d||!this._sourceTilesOverlap[d.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let p=this.painter.context,_=p.gl;if(o.length<=1)return void(this._overlapStencilType=!1);let x;if(c.isTileClipped())x=o.length,this._overlapStencilMode.test={func:_.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(o[0].overscaledZ>o[o.length-1].overscaledZ))return void(this._overlapStencilType=!1);x=1,this._overlapStencilMode.test={func:_.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+x>255&&(p.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=x,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(o,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Gt.disabled}_renderTileClippingMasks(t,o){let c=this.painter,d=this.painter.context,p=d.gl;c._tileClippingMaskIDs={},d.setColorMode(ti.disabled),d.setDepthMode(bt.disabled);let _=c.getOrCreateProgram("clippingMask");for(let x of t){let b=c._tileClippingMaskIDs[x.key]=--o;_.draw(c,p.TRIANGLES,bt.disabled,new Gt({func:p.ALWAYS,mask:0},b,255,p.KEEP,p.KEEP,p.REPLACE),ti.disabled,Nt.disabled,Xh(x.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){let o=this.painter.transform;if(t.x<0||t.x>o.width||t.y<0||t.y>o.height)return null;let c=[t.x,t.y,1,1];n.aA(c,c,o.pixelMatrixInverse),n.cH(c,c,1/c[3]),c[0]/=o.worldSize,c[1]/=o.worldSize;let d=o._camera.position,p=n.cb(1,o.center.lat),_=[d[0],d[1],d[2]/p,0],x=n.d7([],c.slice(0,3),_);n.au(x,x);let b=this.raycast(_,x,this._exaggeration);return b!==null&&b?(n.bE(_,_,x,b),_[3]=_[2],_[2]*=p,_):null}_setupProxiedCoordsForOrtho(t,o,c){if(t.getSource()instanceof n.aP)return this._setupProxiedCoordsForImageSource(t,o,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};let d=this.proxiedCoords[t.id]=[],p=this.proxyCoords;for(let b=0;b<p.length;b++){let M=p[b],C=this._findTileCoveringTileID(M,t);if(C){let z=this._createProxiedId(M,C,c[M.key]&&c[M.key][t.id]);d.push(z),this.proxyToSource[M.key][t.id]=[z]}}let _=!1,x=new Set;for(let b=0;b<o.length;b++){let M=t.getTile(o[b]);if(!M||!M.hasData())continue;let C=this._findTileCoveringTileID(M.tileID,this.proxySourceCache);if(C&&C.tileID.canonical.z!==M.tileID.canonical.z){let z=this.proxyToSource[C.tileID.key][t.id],P=this._createProxiedId(C.tileID,M,c[C.tileID.key]&&c[C.tileID.key][t.id]);z?z.splice(z.length-1,0,P):this.proxyToSource[C.tileID.key][t.id]=[P];let D=this.proxyToSource[C.tileID.key][t.id];x.has(D)||x.add(D),d.push(P),_=!0}}if(this._sourceTilesOverlap[t.id]=_,_&&this._debugParams.sortTilesHiZFirst)for(let b of x)b.sort((M,C)=>C.overscaledZ-M.overscaledZ)}_setupProxiedCoordsForImageSource(t,o,c){if(!t.getSource().loaded())return;let d=this.proxiedCoords[t.id]=[],p=this.proxyCoords,_=t.getSource(),x=_.tileID;if(!x)return;let b=new n.P(x.x,x.y)._div(1<<x.z),M=_.coordinates.map(n.ac.fromLngLat).reduce((z,P)=>(z.min.x=Math.min(z.min.x,P.x-b.x),z.min.y=Math.min(z.min.y,P.y-b.y),z.max.x=Math.max(z.max.x,P.x-b.x),z.max.y=Math.max(z.max.y,P.y-b.y),z),{min:new n.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new n.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),C=(z,P)=>{let D=z.wrap+z.canonical.x/(1<<z.canonical.z),N=z.canonical.y/(1<<z.canonical.z),F=n.aj/(1<<z.canonical.z),j=P.wrap+P.canonical.x/(1<<P.canonical.z),U=P.canonical.y/(1<<P.canonical.z);return D+F<j+M.min.x||D>j+M.max.x||N+F<U+M.min.y||N>U+M.max.y};for(let z=0;z<p.length;z++){let P=p[z];for(let D=0;D<o.length;D++){let N=t.getTile(o[D]);if(!N||!N.hasData()||C(P,N.tileID))continue;let F=this._createProxiedId(P,N,c[P.key]&&c[P.key][t.id]),j=this.proxyToSource[P.key][t.id];j?j.push(F):this.proxyToSource[P.key][t.id]=[F],d.push(F)}}}_createProxiedId(t,o,c){let d=this.orthoMatrix;if(c){let p=c.find(_=>_.key===o.tileID.key);if(p)return p}if(o.tileID.key!==t.key){let p=t.canonical.z-o.tileID.canonical.z,_,x,b;d=n.bz();let M=o.tileID.wrap-t.wrap<<t.overscaledZ;p>0?(_=n.aj>>p,x=_*((o.tileID.canonical.x<<p)-t.canonical.x+M),b=_*((o.tileID.canonical.y<<p)-t.canonical.y)):(_=n.aj<<-p,x=n.aj*(o.tileID.canonical.x-(t.canonical.x+M<<-p)),b=n.aj*(o.tileID.canonical.y-(t.canonical.y<<-p))),n.ca(d,0,_,0,_,0,1),n.bo(d,d,[x,b,0])}return new Fc(o.tileID,t.key,d)}_findTileCoveringTileID(t,o){let c=o.getTile(t);if(c&&c.hasData())return c;let d=this._findCoveringTileCache[o.id],p=d[t.key];if(c=p?o.getTileByID(p):null,c&&c.hasData()||p===null)return c;let _=c?c.tileID:t,x=_.overscaledZ,b=o.getSource().minzoom,M=[];if(!p){let z=o.getSource().maxzoom;if(t.canonical.z>=z){let P=t.canonical.z-z;o.getSource().reparseOverscaled?(x=Math.max(t.canonical.z+2,o.transform.tileZoom),_=new n.aM(x,t.wrap,z,t.canonical.x>>P,t.canonical.y>>P)):P!==0&&(x=z,_=new n.aM(x,t.wrap,z,t.canonical.x>>P,t.canonical.y>>P))}_.key!==t.key&&(M.push(_.key),c=o.getTile(_))}let C=z=>{M.forEach(P=>{d[P]=z}),M.length=0};for(x-=1;x>=b&&(!c||!c.hasData());x--){c&&C(c.tileID.key);let z=_.calculateScaledKey(x);if(c=o.getTileByID(z),c&&c.hasData())break;let P=d[z];if(P===null)break;P===void 0?M.push(z):c=o.getTileByID(P)}return C(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,o){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[o.key]=!0}}function Dd(l,t,o){let c=function(x,b,M){let C=n.bG(b,x),z=n.bG(M,[.2126,.7152,.0722]),P=(N,F,j)=>(1-j)*N+j*F,D=P(1-.3*Math.min(z,1),1,Math.min(C+1,1));return P(.92,1,Math.asin(n.ay(b[2],-1,1))/Math.PI+.5)*D}(l,[0,0,1],t),d=[0,0,0];n.c1(d,o.slice(0,3),c);let p=[0,0,0];n.c1(p,t.slice(0,3),l[2]);let _=[0,0,0];return n.d5(_,d,p),n.d8(_)}let Od=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Jh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Qh{static cacheKey(t,o,c,d){let p=`${o}${d?d.cacheKey:""}`;for(let _ of c)t.usedDefines.includes(_)&&(p+=`/${_}`);return p}constructor(t,o,c,d,p,_){let x=t.gl;this.program=x.createProgram(),this.configuration=d,this.name=o,this.fixedDefines=[..._];let b=d?d.getBinderAttributes():[],M=(c.staticAttributes||[]).concat(b),C=d?d.defines():[];C=C.concat(_.map(j=>`#define ${j}`));let z=`#version 300 es
`,P=z+C.concat("precision mediump float;",Ys,Vh.fragmentSource).join(`
>>>>>>> a526947f4e024d155ff980808ddb8c37daf4d8a2
`);for(let j of c.fragmentIncludes)P+=`
${Pa[j]}`;P+=`
${c.fragmentSource}`;let D=z+C.concat("precision highp float;",Ks,Uh.vertexSource).join(`
`);for(let j of c.vertexIncludes)D+=`
${Pa[j]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&c.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(D+=`
uniform int u_instanceID;
`),D+=`
<<<<<<< HEAD
${c.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(D=D.replaceAll("gl_InstanceID","u_instanceID"));let N=x.createShader(x.FRAGMENT_SHADER);if(x.isContextLost())return void(this.failedToCreate=!0);x.shaderSource(N,P),x.compileShader(N),x.attachShader(this.program,N);let F=x.createShader(x.VERTEX_SHADER);if(x.isContextLost())this.failedToCreate=!0;else{x.shaderSource(F,D),x.compileShader(F),x.attachShader(this.program,F),this.attributes={},this.numAttributes=M.length;for(let j=0;j<this.numAttributes;j++)if(M[j]){let U=M[j].startsWith("a_")?M[j]:`a_${M[j]}`;x.bindAttribLocation(this.program,j,U),this.attributes[U]=j}x.linkProgram(this.program),x.deleteShader(F),x.deleteShader(N),this.fixedUniforms=p(t),this.binderUniforms=d?d.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(j=>({u_instanceID:new n.cd(j)}))(t)),(_.includes("TERRAIN")||o.indexOf("symbol")!==-1||o.indexOf("circle")!==-1)&&(this.terrainUniforms=(j=>({u_dem:new n.cd(j),u_dem_prev:new n.cd(j),u_dem_tl:new n.cg(j),u_dem_scale:new n.cf(j),u_dem_tl_prev:new n.cg(j),u_dem_scale_prev:new n.cf(j),u_dem_size:new n.cf(j),u_dem_lerp:new n.cf(j),u_exaggeration:new n.cf(j),u_depth:new n.cd(j),u_depth_size_inv:new n.cg(j),u_depth_range_unpack:new n.cg(j),u_occluder_half_size:new n.cf(j),u_occlusion_depth_offset:new n.cf(j),u_meter_to_dem:new n.cf(j),u_label_plane_matrix_inv:new n.ch(j)}))(t)),_.includes("GLOBE")&&(this.globeUniforms=(j=>({u_tile_tl_up:new n.ce(j),u_tile_tr_up:new n.ce(j),u_tile_br_up:new n.ce(j),u_tile_bl_up:new n.ce(j),u_tile_up_scale:new n.cf(j)}))(t)),_.includes("FOG")&&(this.fogUniforms=(j=>({u_fog_matrix:new n.ch(j),u_fog_range:new n.cg(j),u_fog_color:new n.d0(j),u_fog_horizon_blend:new n.cf(j),u_fog_vertical_limit:new n.cg(j),u_fog_temporal_offset:new n.cf(j),u_frustum_tl:new n.ce(j),u_frustum_tr:new n.ce(j),u_frustum_br:new n.ce(j),u_frustum_bl:new n.ce(j),u_globe_pos:new n.ce(j),u_globe_radius:new n.cf(j),u_globe_transition:new n.cf(j),u_is_globe:new n.cd(j),u_viewport:new n.cg(j)}))(t)),_.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(j=>({u_cutoff_params:new n.d0(j)}))(t)),_.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(j=>({u_lighting_ambient_color:new n.ce(j),u_lighting_directional_dir:new n.ce(j),u_lighting_directional_color:new n.ce(j),u_ground_radiance:new n.ce(j)}))(t)),_.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(j=>({u_light_matrix_0:new n.ch(j),u_light_matrix_1:new n.ch(j),u_fade_range:new n.cg(j),u_shadow_normal_offset:new n.ce(j),u_shadow_intensity:new n.cf(j),u_shadow_texel_size:new n.cf(j),u_shadow_map_resolution:new n.cf(j),u_shadow_direction:new n.ce(j),u_shadow_bias:new n.ce(j),u_shadowmap_0:new n.cd(j),u_shadowmap_1:new n.cd(j)}))(t))}}setTerrainUniformValues(t,o){if(!this.terrainUniforms)return;let c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d]&&c[d].set(this.program,d,o[d])}}setGlobeUniformValues(t,o){if(!this.globeUniforms)return;let c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d]&&c[d].set(this.program,d,o[d])}}setFogUniformValues(t,o){if(!this.fogUniforms)return;let c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d].set(this.program,d,o[d])}}setCutoffUniformValues(t,o){if(!this.cutoffUniforms)return;let c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d].set(this.program,d,o[d])}}setLightsUniformValues(t,o){if(!this.lightsUniforms)return;let c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d].set(this.program,d,o[d])}}setShadowUniformValues(t,o){if(this.failedToCreate||!this.shadowUniforms)return;let c=this.shadowUniforms;t.program.set(this.program);for(let d in o)c[d].set(this.program,d,o[d])}_drawDebugWireframe(t,o,c,d,p,_,x,b,M,C){let z=t.options.wireframe;if(z.terrain===!1&&z.layers2D===!1&&z.layers3D===!1)return;let P=t.context;if(!(!(!z.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!z.layers2D||t._terrain&&t._terrain.renderingToTexture||!kd.includes(this.name))||!(!z.layers3D||!Qh.includes(this.name))))return;let D=P.gl,N=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,p,P);if(!N)return;let F=[...this.fixedDefines];F.push("DEBUG_WIREFRAME");let j=t.getOrCreateProgram(this.name,{config:this.configuration,defines:F});P.program.set(j.program);let U=(Q,ne,he)=>{if(ne[Q]&&he[Q])for(let de in ne[Q])he[Q][de]&&he[Q][de].set(he.program,de,ne[Q][de].current)};M&&M.setUniforms(j.program,P,j.binderUniforms,x,{zoom:b}),U("fixedUniforms",this,j),U("terrainUniforms",this,j),U("globeUniforms",this,j),U("fogUniforms",this,j),U("lightsUniforms",this,j),U("shadowUniforms",this,j),N.bind(),P.setColorMode(new ti([D.ONE,D.ONE_MINUS_SRC_ALPHA,D.ZERO,D.ONE],n.am.transparent,[!0,!0,!0,!1])),P.setDepthMode(new bt(o.func===D.LESS?D.LEQUAL:o.func,bt.ReadOnly,o.range)),P.setStencilMode(Gt.disabled);let Z=3*_.primitiveLength*2,Y=3*_.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){let Q=C||1;for(let ne=0;ne<Q;++ne)j.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ne),D.drawElements(D.LINES,Z,D.UNSIGNED_SHORT,Y)}else C&&C>1?D.drawElementsInstanced(D.LINES,Z,D.UNSIGNED_SHORT,Y,C):D.drawElements(D.LINES,Z,D.UNSIGNED_SHORT,Y);p.bind(),P.program.set(this.program),P.setDepthMode(o),P.setStencilMode(c),P.setColorMode(d)}checkUniforms(t,o,c){if(this.fixedDefines.includes(o)){for(let d of Object.keys(c))if(!c[d].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${d} not set but required by ${o} being defined`)}}draw(t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j){let U=t.context,Z=U.gl;if(this.failedToCreate)return;U.program.set(this.program),U.setDepthMode(c),U.setStencilMode(d),U.setColorMode(p),U.setCullFace(_);for(let ne of Object.keys(this.fixedUniforms))this.fixedUniforms[ne].set(this.program,ne,x[ne]);N&&N.setUniforms(this.program,U,this.binderUniforms,P,{zoom:D});let Y={[Z.POINTS]:1,[Z.LINES]:2,[Z.TRIANGLES]:3,[Z.LINE_STRIP]:1}[o];this.checkUniforms(b,"RENDER_SHADOWS",this.shadowUniforms);let Q=j&&j>0?1:void 0;for(let ne of z.get()){let he=ne.vaos||(ne.vaos={});if((he[b]||(he[b]=new yg)).bind(U,this,M,N?N.getPaintVertexBuffers():[],C,ne.vertexOffset,F||[],Q),this.forceManualRenderingForInstanceIDShaders){let de=j||1;for(let oe=0;oe<de;++oe)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",oe),C?Z.drawElements(o,ne.primitiveLength*Y,Z.UNSIGNED_SHORT,ne.primitiveOffset*Y*2):Z.drawArrays(o,ne.vertexOffset,ne.vertexLength)}else j&&j>1?Z.drawElementsInstanced(o,ne.primitiveLength*Y,Z.UNSIGNED_SHORT,ne.primitiveOffset*Y*2,j):C?Z.drawElements(o,ne.primitiveLength*Y,Z.UNSIGNED_SHORT,ne.primitiveOffset*Y*2):Z.drawArrays(o,ne.vertexOffset,ne.vertexLength);o===Z.TRIANGLES&&C&&this._drawDebugWireframe(t,c,d,p,C,ne,P,D,N,j)}}}function tu(l,t,o=0){let c=Math.pow(2,t.tileID.overscaledZ),d=t.tileSize*Math.pow(2,l.transform.tileZoom)/c,p=d*(t.tileID.canonical.x+t.tileID.wrap*c),_=d*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/n.aw(t,1,l.transform.tileZoom),u_pixel_coord_upper:[p>>16,_>>16],u_pixel_coord_lower:[65535&p,65535&_],u_pattern_transition:o}}let za={terrain:0,flat:1},Fd=n.bz(),Bd=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U)=>{let Z=t.style.light,Y=Z.properties.get("position"),Q=[Y.x,Y.y,Y.z],ne=n.dJ();Z.properties.get("anchor")==="viewport"&&(n.dK(ne,-t.transform.angle),n.dL(Q,Q,ne));let he=Z.properties.get("color").toPremultipliedRenderColor(null),de=t.transform,oe={u_matrix:l,u_lightpos:Q,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[he.r,he.g,he.b],u_vertical_gradient:+o,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Fd,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:za[M],u_base_type:za[C],u_ao:d,u_edge_radius:p,u_width_scale:_,u_flood_light_color:N,u_vertical_scale:F,u_flood_light_intensity:j,u_ground_shadow_factor:U};return de.projection.name==="globe"&&(oe.u_tile_id=[x.canonical.x,x.canonical.y,1<<x.canonical.z],oe.u_zoom_transition=z,oe.u_inv_rot_matrix=D,oe.u_merc_center=P,oe.u_up_dir=de.projection.upVector(new n.cA(0,0,0),P[0]*n.aj,P[1]*n.aj),oe.u_height_lift=b),oe},im=(l,t,o,c,d,p)=>({u_matrix:l,u_edge_radius:t,u_width_scale:o,u_vertical_scale:c,u_height_type:za[d],u_base_type:za[p]}),vl=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U)=>{let Z=Bd(l,t,o,c,d,p,_,x,M,C,z,P,D,N,F,j,1,[0,0,0]),Y={u_height_factor:-Math.pow(2,x.overscaledZ)/b.tileSize/8};return n.h(Z,tu(t,b,U),Y)},rm=(l,t,o)=>({u_matrix:l,u_emissive_strength:t,u_ground_shadow_factor:o}),nm=(l,t,o,c,d,p=0)=>n.h(rm(l,t,d),tu(o,c,p)),Ag=(l,t,o,c)=>({u_matrix:l,u_world:o,u_emissive_strength:t,u_ground_shadow_factor:c}),Mg=(l,t,o,c,d,p,_=0)=>n.h(nm(l,t,o,c,p,_),{u_world:d}),Cg=(l,t)=>({u_matrix:l,u_ground_shadow_factor:t}),iu=(l,t,o,c,d)=>({u_matrix:l,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:o,u_height_scale:c,u_reset_depth:d}),Nd=(l,t)=>({u_matrix:l,u_normal_matrix:t,u_opacity:1}),Vd=l=>({u_matrix:l}),om=l=>({u_matrix:l}),bl=(l,t,o,c,d,p,_,x)=>{let b=n.aj/p.tileSize;return{u_matrix:l,u_inv_rot_matrix:t,u_camera_to_center_distance:o.getCameraToCenterDistance(x),u_extrude_scale:[o.pixelsToGLUnits[0]/b,o.pixelsToGLUnits[1]/b],u_zoom_transition:c,u_tile_id:_,u_merc_center:d}},Ud=(l,t,o=1)=>({u_matrix:l,u_color:t,u_overlay:0,u_overlay_scale:o}),sm=n.bz(),am=(l,t,o,c,d,p,_)=>{let x=l.transform,b=x.projection.name==="globe",M=b?n.dM(x.zoom,t.canonical)*x._pixelsPerMercatorPixel:n.aw(o,1,p),C={u_matrix:t.projMatrix,u_extrude_scale:M,u_intensity:_,u_inv_rot_matrix:sm,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(b){C.u_inv_rot_matrix=c,C.u_merc_center=d,C.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],C.u_zoom_transition=n.ah(x.zoom);let z=d[0]*n.aj,P=d[1]*n.aj;C.u_up_dir=x.projection.upVector(new n.cA(0,0,0),z,P)}return C};function ru(l,[t,o,c,d],[p,_]){if(p===_)return[0,0,0,0];let x=255*(l-1)/(l*(_-p));return[t*x,o*x,c*x,d*x]}function Js(l,t,[o,c]){return o===c?0:.5/l+(t-o)*(l-1)/(l*(c-o))}let jd=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y,Q)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:M,u_fade_t:C.mix,u_opacity:C.opacity*z.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:z.paint.get("raster-brightness-min"),u_brightness_high:z.paint.get("raster-brightness-max"),u_saturation_factor:n.dO(z.paint.get("raster-saturation")),u_contrast_factor:n.dN(z.paint.get("raster-contrast")),u_spin_weights:Qs(z.paint.get("raster-hue-rotate")),u_perspective_transform:P,u_raster_elevation:D,u_zoom_transition:_,u_merc_center:x,u_cutoff_params:b,u_colorization_mix:ru(n.dP,F,U),u_colorization_offset:Js(n.dP,j,U),u_color_ramp:N,u_texture_offset:[Y/(Z+2*Y),Z/(Z+2*Y)],u_texture_res:[Z+2*Y,Z+2*Y],u_emissive_strength:Q});function Qs(l){l*=Math.PI/180;let t=Math.sin(l),o=Math.cos(l);return[(2*o+1)/3,(-Math.sqrt(3)*t-o+1)/3,(Math.sqrt(3)*t-o+1)/3]}let ea=.05,nu=(l,t,o,c,d,p,_,x,b,M,C,z)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:M,u_fade_t:C.mix,u_opacity:C.opacity,u_image0:0,u_image1:1,u_raster_elevation:z,u_zoom_transition:_,u_merc_center:x,u_cutoff_params:b}),lm=(l,t,o,c,d,p,_,x,b,M)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:o,u_velocity:c,u_color_ramp:p,u_velocity_res:d,u_max_speed:_,u_uv_offset:x,u_data_scale:[255*b[0],255*b[1]],u_data_offset:M,u_particle_pos_scale:1.1,u_particle_pos_offset:[ea,ea]}),cm=(l,t,o,c,d,p,_,x,b,M)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:o,u_velocity_res:c,u_max_speed:d,u_speed_factor:p,u_reset_rate:_,u_rand_seed:Math.random(),u_uv_offset:x,u_data_scale:[255*b[0],255*b[1]],u_data_offset:M,u_particle_pos_scale:1.1,u_particle_pos_offset:[ea,ea]}),ou=n.bz(),su=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y,Q,ne,he,de)=>{let oe=d.transform,se={u_is_size_zoom_constant:+(l==="constant"||l==="source"),u_is_size_feature_constant:+(l==="constant"||l==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:oe.getCameraToCenterDistance(Z),u_rotate_symbol:+o,u_aspect_ratio:oe.width/oe.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:p,u_label_plane_matrix:_,u_coord_matrix:x,u_is_text:+M,u_elevation_from_sea:b?1:0,u_pitch_with_map:+c,u_texsize:C,u_texsize_icon:z,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:ou,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:ou,u_up_vector:[0,-1,0],u_color_adj_mat:ne,u_icon_transition:he||0,u_gamma_scale:c?d.transform.getCameraToCenterDistance(Z)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:n.q.devicePixelRatio,u_is_halo:1,u_scale_factor:de||1,u_ground_shadow_factor:Y,u_inv_matrix:n.bi(n.bz(),_),u_normal_scale:Q};return Z.name==="globe"&&(se.u_tile_id=[D.canonical.x,D.canonical.y,1<<D.canonical.z],se.u_zoom_transition=N,se.u_inv_rot_matrix=j,se.u_merc_center=F,se.u_camera_forward=oe._camera.forward(),se.u_ecef_origin=n.dQ(oe.globeMatrix,D.toUnwrapped()),se.u_tile_matrix=Float32Array.from(oe.globeMatrix),se.u_up_vector=U),se},hm=(l,t,o,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:o,u_color:c}),Gd=(l,t,o,c,d,p,_,x,b)=>n.h(function(M,C,z,P,D,N){let{width:F,height:j}=P.imageManager.getPixelSize(C),U=Math.pow(2,N.tileID.overscaledZ),Z=N.tileSize*Math.pow(2,P.transform.tileZoom)/U,Y=Z*(N.tileID.canonical.x+N.tileID.wrap*U),Q=Z*N.tileID.canonical.y;return{u_image:0,u_pattern_tl:z.tl,u_pattern_br:z.br,u_texsize:[F,j],u_pattern_size:z.displaySize,u_pattern_units_to_pixels:D?[P.transform.width,-1*P.transform.height]:[1/n.aw(N,1,P.transform.tileZoom),1/n.aw(N,1,P.transform.tileZoom)],u_pixel_coord_upper:[Y>>16,Q>>16],u_pixel_coord_lower:[65535&Y,65535&Q]}}(0,p,_,c,x,b),{u_matrix:l,u_emissive_strength:t,u_opacity:o}),Da=new Float32Array(n.bx([])),qd=(l,t,o,c,d,p,_,x,b,M,C,z,P,D=[0,0,0],N)=>{let F=d.style.light,j=F.properties.get("position"),U=[-j.x,-j.y,j.z],Z=n.dJ();F.properties.get("anchor")==="viewport"&&(n.dK(Z,-d.transform.angle),n.dL(U,U,Z));let Y=C.alphaMode==="MASK",Q=F.properties.get("color").toNonPremultipliedRenderColor(null),ne=P.paint.get("model-ambient-occlusion-intensity"),he=P.paint.get("model-color").constantOr(n.am.white).toNonPremultipliedRenderColor(null);return he.a=P.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:o,u_node_matrix:c||Da,u_lightpos:U,u_lightintensity:F.properties.get("intensity"),u_lightcolor:[Q.r,Q.g,Q.b],u_camera_pos:D,u_opacity:p,u_baseTextureIsAlpha:0,u_alphaMask:+Y,u_alphaCutoff:C.alphaCutoff,u_baseColorFactor:_.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:x.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:b,u_roughnessFactor:M,u_baseColorTexture:zn.BaseColor,u_metallicRoughnessTexture:zn.MetallicRoughness,u_normalTexture:zn.Normal,u_occlusionTexture:zn.Occlusion,u_emissionTexture:zn.Emission,u_lutTexture:zn.LUT,u_color_mix:he.toArray01(),u_aoIntensity:ne,u_emissive_strength:z,u_occlusionTextureTransform:N||[0,0,0,0]}},um=(l,t=Da,o=Da)=>({u_matrix:l,u_instance:t,u_node_matrix:o}),dm={fillExtrusion:l=>({u_matrix:new n.ch(l),u_lightpos:new n.ce(l),u_lightintensity:new n.cf(l),u_lightcolor:new n.ce(l),u_vertical_gradient:new n.cf(l),u_opacity:new n.cf(l),u_edge_radius:new n.cf(l),u_width_scale:new n.cf(l),u_ao:new n.cg(l),u_height_type:new n.cd(l),u_base_type:new n.cd(l),u_tile_id:new n.ce(l),u_zoom_transition:new n.cf(l),u_inv_rot_matrix:new n.ch(l),u_merc_center:new n.cg(l),u_up_dir:new n.ce(l),u_height_lift:new n.cf(l),u_flood_light_color:new n.ce(l),u_vertical_scale:new n.cf(l),u_flood_light_intensity:new n.cf(l),u_ground_shadow_factor:new n.ce(l)}),fillExtrusionDepth:l=>({u_matrix:new n.ch(l),u_edge_radius:new n.cf(l),u_width_scale:new n.cf(l),u_vertical_scale:new n.cf(l),u_height_type:new n.cd(l),u_base_type:new n.cd(l)}),fillExtrusionPattern:l=>({u_matrix:new n.ch(l),u_lightpos:new n.ce(l),u_lightintensity:new n.cf(l),u_lightcolor:new n.ce(l),u_vertical_gradient:new n.cf(l),u_height_factor:new n.cf(l),u_edge_radius:new n.cf(l),u_width_scale:new n.cf(l),u_ao:new n.cg(l),u_height_type:new n.cd(l),u_base_type:new n.cd(l),u_tile_id:new n.ce(l),u_zoom_transition:new n.cf(l),u_inv_rot_matrix:new n.ch(l),u_merc_center:new n.cg(l),u_up_dir:new n.ce(l),u_height_lift:new n.cf(l),u_image:new n.cd(l),u_texsize:new n.cg(l),u_pixel_coord_upper:new n.cg(l),u_pixel_coord_lower:new n.cg(l),u_tile_units_to_pixels:new n.cf(l),u_opacity:new n.cf(l),u_pattern_transition:new n.cf(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new n.ch(l),u_opacity:new n.cf(l),u_ao_pass:new n.cf(l),u_meter_to_tile:new n.cf(l),u_ao:new n.cg(l),u_flood_light_intensity:new n.cf(l),u_flood_light_color:new n.ce(l),u_attenuation:new n.cf(l),u_edge_radius:new n.cf(l),u_fb:new n.cd(l),u_fb_size:new n.cf(l),u_dynamic_offset:new n.cf(l)}),fill:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_ground_shadow_factor:new n.ce(l)}),fillPattern:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_image:new n.cd(l),u_texsize:new n.cg(l),u_pixel_coord_upper:new n.cg(l),u_pixel_coord_lower:new n.cg(l),u_tile_units_to_pixels:new n.cf(l),u_ground_shadow_factor:new n.ce(l),u_pattern_transition:new n.cf(l)}),fillOutline:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_world:new n.cg(l),u_ground_shadow_factor:new n.ce(l)}),fillOutlinePattern:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_world:new n.cg(l),u_image:new n.cd(l),u_texsize:new n.cg(l),u_pixel_coord_upper:new n.cg(l),u_pixel_coord_lower:new n.cg(l),u_tile_units_to_pixels:new n.cf(l),u_ground_shadow_factor:new n.ce(l),u_pattern_transition:new n.cf(l)}),building:l=>({u_matrix:new n.ch(l),u_normal_matrix:new n.ch(l),u_opacity:new n.cf(l)}),buildingBloom:l=>({u_matrix:new n.ch(l)}),buildingDepth:l=>({u_matrix:new n.ch(l)}),elevatedStructuresDepth:l=>({u_matrix:new n.ch(l),u_depth_bias:new n.cf(l)}),elevatedStructures:l=>({u_matrix:new n.ch(l),u_ground_shadow_factor:new n.ce(l)}),elevatedStructuresDepthReconstruct:l=>({u_matrix:new n.ch(l),u_camera_pos:new n.ce(l),u_depth_bias:new n.cf(l),u_height_scale:new n.cf(l),u_reset_depth:new n.cf(l)}),circle:n.dT,collisionBox:l=>({u_matrix:new n.ch(l),u_inv_rot_matrix:new n.ch(l),u_camera_to_center_distance:new n.cf(l),u_extrude_scale:new n.cg(l),u_zoom_transition:new n.cf(l),u_merc_center:new n.cg(l),u_tile_id:new n.ce(l)}),collisionCircle:l=>({u_matrix:new n.ch(l),u_inv_matrix:new n.ch(l),u_camera_to_center_distance:new n.cf(l),u_viewport_size:new n.cg(l)}),debug:l=>({u_color:new n.dv(l),u_matrix:new n.ch(l),u_overlay:new n.cd(l),u_overlay_scale:new n.cf(l)}),clippingMask:l=>({u_matrix:new n.ch(l)}),heatmap:l=>({u_extrude_scale:new n.cf(l),u_intensity:new n.cf(l),u_matrix:new n.ch(l),u_inv_rot_matrix:new n.ch(l),u_merc_center:new n.cg(l),u_tile_id:new n.ce(l),u_zoom_transition:new n.cf(l),u_up_dir:new n.ce(l)}),heatmapTexture:l=>({u_image:new n.cd(l),u_color_ramp:new n.cd(l),u_opacity:new n.cf(l)}),hillshade:l=>({u_matrix:new n.ch(l),u_image:new n.cd(l),u_latrange:new n.cg(l),u_light:new n.cg(l),u_shadow:new n.dv(l),u_highlight:new n.dv(l),u_emissive_strength:new n.cf(l),u_accent:new n.dv(l)}),hillshadePrepare:l=>({u_matrix:new n.ch(l),u_image:new n.cd(l),u_dimension:new n.cg(l),u_zoom:new n.cf(l)}),line:n.dS,linePattern:n.dR,raster:l=>({u_matrix:new n.ch(l),u_normalize_matrix:new n.ch(l),u_globe_matrix:new n.ch(l),u_merc_matrix:new n.ch(l),u_grid_matrix:new n.dw(l),u_tl_parent:new n.cg(l),u_scale_parent:new n.cf(l),u_fade_t:new n.cf(l),u_opacity:new n.cf(l),u_image0:new n.cd(l),u_image1:new n.cd(l),u_brightness_low:new n.cf(l),u_brightness_high:new n.cf(l),u_saturation_factor:new n.cf(l),u_contrast_factor:new n.cf(l),u_spin_weights:new n.ce(l),u_perspective_transform:new n.cg(l),u_raster_elevation:new n.cf(l),u_zoom_transition:new n.cf(l),u_merc_center:new n.cg(l),u_cutoff_params:new n.d0(l),u_colorization_mix:new n.d0(l),u_colorization_offset:new n.cf(l),u_color_ramp:new n.cd(l),u_texture_offset:new n.cg(l),u_texture_res:new n.cg(l),u_emissive_strength:new n.cf(l)}),rasterParticle:l=>({u_matrix:new n.ch(l),u_normalize_matrix:new n.ch(l),u_globe_matrix:new n.ch(l),u_merc_matrix:new n.ch(l),u_grid_matrix:new n.dw(l),u_tl_parent:new n.cg(l),u_scale_parent:new n.cf(l),u_fade_t:new n.cf(l),u_opacity:new n.cf(l),u_image0:new n.cd(l),u_image1:new n.cd(l),u_raster_elevation:new n.cf(l),u_zoom_transition:new n.cf(l),u_merc_center:new n.cg(l),u_cutoff_params:new n.d0(l)}),rasterParticleTexture:l=>({u_texture:new n.cd(l),u_opacity:new n.cf(l)}),rasterParticleDraw:l=>({u_particle_texture:new n.cd(l),u_particle_texture_side_len:new n.cf(l),u_tile_offset:new n.cg(l),u_velocity:new n.cd(l),u_color_ramp:new n.cd(l),u_velocity_res:new n.cg(l),u_max_speed:new n.cf(l),u_uv_offset:new n.cg(l),u_data_scale:new n.cg(l),u_data_offset:new n.cf(l),u_particle_pos_scale:new n.cf(l),u_particle_pos_offset:new n.cg(l)}),rasterParticleUpdate:l=>({u_particle_texture:new n.cd(l),u_particle_texture_side_len:new n.cf(l),u_velocity:new n.cd(l),u_velocity_res:new n.cg(l),u_max_speed:new n.cf(l),u_speed_factor:new n.cf(l),u_reset_rate:new n.cf(l),u_rand_seed:new n.cf(l),u_uv_offset:new n.cg(l),u_data_scale:new n.cg(l),u_data_offset:new n.cf(l),u_particle_pos_scale:new n.cf(l),u_particle_pos_offset:new n.cg(l)}),symbol:l=>({u_is_size_zoom_constant:new n.cd(l),u_is_size_feature_constant:new n.cd(l),u_size_t:new n.cf(l),u_size:new n.cf(l),u_camera_to_center_distance:new n.cf(l),u_rotate_symbol:new n.cd(l),u_aspect_ratio:new n.cf(l),u_fade_change:new n.cf(l),u_matrix:new n.ch(l),u_label_plane_matrix:new n.ch(l),u_coord_matrix:new n.ch(l),u_is_text:new n.cd(l),u_elevation_from_sea:new n.cd(l),u_pitch_with_map:new n.cd(l),u_texsize:new n.cg(l),u_texsize_icon:new n.cg(l),u_texture:new n.cd(l),u_texture_icon:new n.cd(l),u_gamma_scale:new n.cf(l),u_device_pixel_ratio:new n.cf(l),u_tile_id:new n.ce(l),u_zoom_transition:new n.cf(l),u_inv_rot_matrix:new n.ch(l),u_merc_center:new n.cg(l),u_camera_forward:new n.ce(l),u_tile_matrix:new n.ch(l),u_up_vector:new n.ce(l),u_ecef_origin:new n.ce(l),u_is_halo:new n.cd(l),u_icon_transition:new n.cf(l),u_color_adj_mat:new n.ch(l),u_scale_factor:new n.cf(l),u_ground_shadow_factor:new n.ce(l),u_inv_matrix:new n.ch(l),u_normal_scale:new n.cf(l)}),background:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_opacity:new n.cf(l),u_color:new n.dv(l)}),backgroundPattern:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_opacity:new n.cf(l),u_image:new n.cd(l),u_pattern_tl:new n.cg(l),u_pattern_br:new n.cg(l),u_texsize:new n.cg(l),u_pattern_size:new n.cg(l),u_pixel_coord_upper:new n.cg(l),u_pixel_coord_lower:new n.cg(l),u_pattern_units_to_pixels:new n.cg(l)}),terrainRaster:l=>({u_matrix:new n.ch(l),u_image0:new n.cd(l),u_skirt_height:new n.cf(l),u_ground_shadow_factor:new n.ce(l)}),skybox:l=>({u_matrix:new n.ch(l),u_sun_direction:new n.ce(l),u_cubemap:new n.cd(l),u_opacity:new n.cf(l),u_temporal_offset:new n.cf(l)}),skyboxGradient:l=>({u_matrix:new n.ch(l),u_color_ramp:new n.cd(l),u_center_direction:new n.ce(l),u_radius:new n.cf(l),u_opacity:new n.cf(l),u_temporal_offset:new n.cf(l)}),skyboxCapture:l=>({u_matrix_3f:new n.dw(l),u_sun_direction:new n.ce(l),u_sun_intensity:new n.cf(l),u_color_tint_r:new n.d0(l),u_color_tint_m:new n.d0(l),u_luminance:new n.cf(l)}),globeRaster:l=>({u_proj_matrix:new n.ch(l),u_globe_matrix:new n.ch(l),u_normalize_matrix:new n.ch(l),u_merc_matrix:new n.ch(l),u_zoom_transition:new n.cf(l),u_merc_center:new n.cg(l),u_image0:new n.cd(l),u_grid_matrix:new n.dw(l),u_skirt_height:new n.cf(l),u_far_z_cutoff:new n.cf(l),u_frustum_tl:new n.ce(l),u_frustum_tr:new n.ce(l),u_frustum_br:new n.ce(l),u_frustum_bl:new n.ce(l),u_globe_pos:new n.ce(l),u_globe_radius:new n.cf(l),u_viewport:new n.cg(l)}),globeAtmosphere:l=>({u_frustum_tl:new n.ce(l),u_frustum_tr:new n.ce(l),u_frustum_br:new n.ce(l),u_frustum_bl:new n.ce(l),u_horizon:new n.cf(l),u_transition:new n.cf(l),u_fadeout_range:new n.cf(l),u_color:new n.d0(l),u_high_color:new n.d0(l),u_space_color:new n.d0(l),u_temporal_offset:new n.cf(l),u_horizon_angle:new n.cf(l)}),model:l=>({u_matrix:new n.ch(l),u_lighting_matrix:new n.ch(l),u_normal_matrix:new n.ch(l),u_node_matrix:new n.ch(l),u_lightpos:new n.ce(l),u_lightintensity:new n.cf(l),u_lightcolor:new n.ce(l),u_camera_pos:new n.ce(l),u_opacity:new n.cf(l),u_baseColorFactor:new n.d0(l),u_emissiveFactor:new n.d0(l),u_metallicFactor:new n.cf(l),u_roughnessFactor:new n.cf(l),u_baseTextureIsAlpha:new n.cd(l),u_alphaMask:new n.cd(l),u_alphaCutoff:new n.cf(l),u_baseColorTexture:new n.cd(l),u_metallicRoughnessTexture:new n.cd(l),u_normalTexture:new n.cd(l),u_occlusionTexture:new n.cd(l),u_emissionTexture:new n.cd(l),u_lutTexture:new n.cd(l),u_color_mix:new n.d0(l),u_aoIntensity:new n.cf(l),u_emissive_strength:new n.cf(l),u_occlusionTextureTransform:new n.d0(l)}),modelDepth:l=>({u_matrix:new n.ch(l),u_instance:new n.ch(l),u_node_matrix:new n.ch(l)}),groundShadow:l=>({u_matrix:new n.ch(l),u_ground_shadow_factor:new n.ce(l)}),stars:l=>({u_matrix:new n.ch(l),u_up:new n.ce(l),u_right:new n.ce(l),u_intensity_multiplier:new n.cf(l)}),snowParticle:l=>({u_modelview:new n.ch(l),u_projection:new n.ch(l),u_time:new n.cf(l),u_cam_pos:new n.ce(l),u_velocityConeAperture:new n.cf(l),u_velocity:new n.cf(l),u_horizontalOscillationRadius:new n.cf(l),u_horizontalOscillationRate:new n.cf(l),u_boxSize:new n.cf(l),u_billboardSize:new n.cf(l),u_simpleShapeParameters:new n.cg(l),u_screenSize:new n.cg(l),u_thinningCenterPos:new n.cg(l),u_thinningShape:new n.ce(l),u_thinningAffectedRatio:new n.cf(l),u_thinningParticleOffset:new n.cf(l),u_particleColor:new n.d0(l),u_direction:new n.ce(l)}),rainParticle:l=>({u_modelview:new n.ch(l),u_projection:new n.ch(l),u_time:new n.cf(l),u_cam_pos:new n.ce(l),u_texScreen:new n.cd(l),u_velocityConeAperture:new n.cf(l),u_velocity:new n.cf(l),u_boxSize:new n.cf(l),u_rainDropletSize:new n.cg(l),u_distortionStrength:new n.cf(l),u_rainDirection:new n.ce(l),u_color:new n.d0(l),u_screenSize:new n.cg(l),u_thinningCenterPos:new n.cg(l),u_thinningShape:new n.ce(l),u_thinningAffectedRatio:new n.cf(l),u_thinningParticleOffset:new n.cf(l),u_shapeDirectionalPower:new n.cf(l),u_shapeNormalPower:new n.cf(l),u_mode:new n.cf(l)}),vignette:l=>({u_vignetteShape:new n.ce(l),u_vignetteColor:new n.d0(l)}),occlusion:l=>({u_matrix:new n.ch(l),u_anchorPos:new n.ce(l),u_screenSizePx:new n.cg(l),u_occluderSizePx:new n.cg(l),u_color:new n.d0(l)})};class ta{constructor(t,o,c,d){this.id=ta.uniqueIdxCounter,ta.uniqueIdxCounter++,this.context=t;let p=t.gl;this.buffer=p.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?p.DYNAMIC_DRAW:p.STATIC_DRAW),this.dynamicDraw||d||o.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=ta.uniqueIdxCounter,ta.uniqueIdxCounter++;let o=this.context.gl;this.context.unbindVAO(),this.bind(),o.bufferSubData(o.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}ta.uniqueIdxCounter=0;let Hd={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class $d{constructor(t,o,c,d,p,_){this.length=o.length,this.attributes=c,this.itemSize=o.bytesPerElement,this.dynamicDraw=d,this.instanceCount=_,this.context=t;let x=t.gl;this.buffer=x.createBuffer(),t.bindVertexBuffer.set(this.buffer),x.bufferData(x.ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?x.DYNAMIC_DRAW:x.STATIC_DRAW),this.dynamicDraw||p||o.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){let o=this.context.gl;this.bind(),o.bufferSubData(o.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,o){for(let c=0;c<this.attributes.length;c++){let d=o.attributes[this.attributes[c].name];d!==void 0&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,o,c){for(let d=0;d<this.attributes.length;d++){let p=this.attributes[d],_=o.attributes[p.name];_!==void 0&&t.vertexAttribPointer(_,p.components,t[Hd[p.type]],!1,this.itemSize,p.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,o,c){for(let d=0;d<this.attributes.length;d++){let p=o.attributes[this.attributes[d].name];p!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(p,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Oa{constructor(t,o,c,d,p){this.context=t,this.width=o,this.height=c;let _=this.framebuffer=t.gl.createFramebuffer();d&&(this.colorAttachment=new Ig(t,_)),p&&(this.depthAttachmentType=p,this.depthAttachment=p==="renderbuffer"?new em(t,_):new Pd(t,_))}destroy(){let t=this.context.gl;if(this.colorAttachment){let o=this.colorAttachment.get();o&&t.deleteTexture(o)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){let o=this.depthAttachment.get();o&&t.deleteRenderbuffer(o)}else{let o=this.depthAttachment.get();o&&t.deleteTexture(o)}t.deleteFramebuffer(this.framebuffer)}}class au{constructor(t,o){this.gl=t,this.clearColor=new vg(this),this.clearDepth=new bg(this),this.clearStencil=new wg(this),this.colorMask=new Tg(this),this.depthMask=new $f(this),this.stencilMask=new Sg(this),this.stencilFunc=new jh(this),this.stencilOp=new Eg(this),this.stencilTest=new Zf(this),this.depthRange=new Ed(this),this.depthTest=new Gh(this),this.depthFunc=new Id(this),this.blend=new Ra(this),this.blendFunc=new ml(this),this.blendColor=new qh(this),this.blendEquation=new Hh(this),this.cullFace=new _l(this),this.cullFaceSide=new Wf(this),this.frontFace=new Ad(this),this.program=new Xf(this),this.activeTexture=new gl(this),this.viewport=new $h(this),this.bindFramebuffer=new Zh(this),this.bindRenderbuffer=new Md(this),this.bindTexture=new Wh(this),this.bindVertexBuffer=new kc(this),this.bindElementBuffer=new Yf(this),this.bindVertexArrayOES=new Kf(this),this.pixelStoreUnpack=new Jf(this),this.pixelStoreUnpackPremultiplyAlpha=new yl(this),this.pixelStoreUnpackFlipY=new Qf(this),this.options=o?Object.assign({},o):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=o&&!!o.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,o,c){return new ta(this,t,o,c)}createVertexBuffer(t,o,c,d,p){return new $d(this,t,o,c,d,p)}createRenderbuffer(t,o,c){let d=this.gl,p=d.createRenderbuffer();return this.bindRenderbuffer.set(p),d.renderbufferStorage(d.RENDERBUFFER,t,o,c),this.bindRenderbuffer.set(null),p}createFramebuffer(t,o,c,d){return new Oa(this,t,o,c,d)}clear({color:t,depth:o,stencil:c,colorMask:d}){let p=this.gl,_=0;t&&(_|=p.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(d||[!0,!0,!0,!0])),o!==void 0&&(_|=p.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(o),this.depthMask.set(!0)),c!==void 0&&(_|=p.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),p.clear(_)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){n.bv(t.blendFunction,ti.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let ia;function Zd(l,t,o,c,d,p,_){let x=l.context,b=x.gl,M=l.transform,C=[n.aD(M.center.lng),n.aH(M.center.lat)],z=o.layout.get("symbol-placement"),P=o.layout.get("text-variable-anchor"),D=o.layout.get("icon-rotation-alignment")==="map",N=o.layout.get("text-rotation-alignment")==="map",F=z!=="point",j=[],U=0,Z=0;for(let se=0;se<c.length;se++){let le=c[se],Me=t.getTile(le),_e=Me.getBucket(o);if(!_e)continue;let Ve=_e.getProjection().createInversionMatrix(M,le.canonical),ze=[],je=zf(le,_e,M),rt=!_&&D&&F,Ce=_&&N&&F,me=P&&_e.hasTextData(),ke=_e.hasIconTextFit()&&me&&_e.hasIconData(),Pe=rt||Ce||_&&me||ke,$e=_e.projection.name==="globe",Ze=$e?n.ah(M.zoom):0;$e&&(ze.push("PROJECTION_GLOBE_VIEW"),Pe&&ze.push("PROJECTED_POS_ON_VIEWPORT"));let Ye=l.getOrCreateProgram("collisionBox",{defines:ze}),ct=je;d[0]===0&&d[1]===0||(ct=l.translatePosMatrix(je,Me,d,p));let Mt=_?_e.textCollisionBox:_e.iconCollisionBox,Ot=_e.collisionCircleArray;if(Ot.length>0){let zt=n.bz(),Rt=ct;n.cM(zt,_e.placementInvProjMatrix,M.glCoordMatrix),n.cM(zt,zt,_e.placementViewportMatrix),j.push({circleArray:Ot,circleOffset:Z,transform:Rt,invTransform:zt,projection:_e.getProjection()}),U+=Ot.length/4,Z=U}if(!Mt)continue;l.terrain&&l.terrain.setupElevationDraw(Me,Ye);let yt=$e?[le.canonical.x,le.canonical.y,1<<le.canonical.z]:[0,0,0];Ye.draw(l,b.LINES,bt.disabled,Gt.disabled,l.colorModeForRenderPass(),Nt.disabled,bl(ct,Ve,M,Ze,C,Me,yt,_e.getProjection()),o.id,Mt.layoutVertexBuffer,Mt.indexBuffer,Mt.segments,null,M.zoom,null,[Mt.collisionVertexBuffer,Mt.collisionVertexBufferExt])}if(!_||!j.length)return;let Y=l.getOrCreateProgram("collisionCircle"),Q=new n.dU;Q.resize(4*U),Q._trim();let ne=0;for(let se of j)for(let le=0;le<se.circleArray.length/4;le++){let Me=4*le,_e=se.circleArray[Me+0],Ve=se.circleArray[Me+1],ze=se.circleArray[Me+2],je=se.circleArray[Me+3];Q.emplace(ne++,_e,Ve,ze,je,0),Q.emplace(ne++,_e,Ve,ze,je,1),Q.emplace(ne++,_e,Ve,ze,je,2),Q.emplace(ne++,_e,Ve,ze,je,3)}(!ia||ia.length<2*U)&&(ia=function(se){let le=2*se,Me=new n.a_;Me.resize(le),Me._trim();for(let _e=0;_e<le;_e++){let Ve=6*_e;Me.uint16[Ve+0]=4*_e+0,Me.uint16[Ve+1]=4*_e+1,Me.uint16[Ve+2]=4*_e+2,Me.uint16[Ve+3]=4*_e+2,Me.uint16[Ve+4]=4*_e+3,Me.uint16[Ve+5]=4*_e+0}return Me}(U));let he=x.createIndexBuffer(ia,!0),de=x.createVertexBuffer(Q,n.dV.members,!0);for(let se of j){let le={u_matrix:se.transform,u_inv_matrix:se.invTransform,u_camera_to_center_distance:(oe=M).getCameraToCenterDistance(se.projection),u_viewport_size:[oe.width,oe.height]};Y.draw(l,b.TRIANGLES,bt.disabled,Gt.disabled,l.colorModeForRenderPass(),Nt.disabled,le,o.id,de,he,n.bd.simpleSegment(0,2*se.circleOffset,se.circleArray.length,se.circleArray.length/2),null,M.zoom)}var oe;de.destroy(),he.destroy()}let ka=n.bz();function Nc(l){let t=l._camera.getWorldToCamera(l.worldSize,1),o=n.az([],t,l.globeMatrix);n.bi(o,o);let c=[0,0,0],d=[0,1,0,0];return n.aA(d,d,o),c[0]=d[0],c[1]=d[1],c[2]=d[2],n.au(c,c),c}function Wd({width:l,height:t,anchor:o,textOffset:c,textScale:d},p){let{horizontalAlign:_,verticalAlign:x}=n.bZ(o),b=-(_-.5)*l,M=-(x-.5)*t,C=n.b_(o,c);return new n.P((b/d+C[0])*p,(M/d+C[1])*p)}function pm(l,t,o,c,d,p,_,x,b,M){let C=l.text.placedSymbolArray,z=l.text.dynamicLayoutVertexArray,P=l.icon.dynamicLayoutVertexArray,D={},N=l.getProjection(),F=Ph(_,N,d),j=d.elevation,U=N.upVectorScale(_.canonical,d.center.lat,d.worldSize).metersToTile;z.clear();for(let Z=0;Z<C.length;Z++){let Y=C.get(Z),{tileAnchorX:Q,tileAnchorY:ne,numGlyphs:he}=Y,de=Y.hidden||!Y.crossTileID||l.allowVerticalPlacement&&!Y.placedOrientation?null:c[Y.crossTileID];if(de){let oe=0,se=0,le=0;if(j){let ke=j?j.getAtTileOffset(_,Q,ne):0,[Pe,$e,Ze]=N.upVector(_.canonical,Q,ne);oe=ke*Pe*U,se=ke*$e*U,le=ke*Ze*U}let[Me,_e,Ve,ze]=mo(Y.projectedAnchorX+oe,Y.projectedAnchorY+se,Y.projectedAnchorZ+le,o?F:p),je=dd(d.getCameraToCenterDistance(N),ze),rt=n.bJ(l.textSizeData,b,Y)*je/n.bU;o&&(rt*=l.tilePixelRatio/x);let Ce=Wd(de,rt);o?({x:Me,y:_e,z:Ve}=N.projectTilePoint(Q+Ce.x,ne+Ce.y,_.canonical),[Me,_e,Ve]=mo(Me+oe,_e+se,Ve+le,p)):(t&&Ce._rotate(-d.angle),Me+=Ce.x,_e+=Ce.y,Ve=0);let me=l.allowVerticalPlacement&&Y.placedOrientation===n.bI.vertical?Math.PI/2:0;for(let ke=0;ke<he;ke++)n.bL(z,Me,_e,Ve,me);M&&Y.associatedIconIndex>=0&&(D[Y.associatedIconIndex]={x:Me,y:_e,z:Ve,angle:me})}else sl(he,z)}if(M){P.clear();let Z=l.icon.placedSymbolArray;for(let Y=0;Y<Z.length;Y++){let Q=Z.get(Y),{numGlyphs:ne}=Q,he=D[Y];if(Q.hidden||!he)sl(ne,P);else{let{x:de,y:oe,z:se,angle:le}=he;for(let Me=0;Me<ne;Me++)n.bL(P,de,oe,se,le)}}l.icon.dynamicLayoutVertexBuffer.updateData(P)}l.text.dynamicLayoutVertexBuffer.updateData(z)}function Xd(l,t,o,c,d,p,_={}){let x=o.paint.get("icon-translate"),b=o.paint.get("text-translate"),M=o.paint.get("icon-translate-anchor"),C=o.paint.get("text-translate-anchor"),z=o.layout.get("icon-rotation-alignment"),P=o.layout.get("text-rotation-alignment"),D=o.layout.get("icon-pitch-alignment"),N=o.layout.get("text-pitch-alignment"),F=o.layout.get("icon-keep-upright"),j=o.layout.get("text-keep-upright"),U=o.paint.get("icon-color-saturation"),Z=o.paint.get("icon-color-contrast"),Y=o.paint.get("icon-color-brightness-min"),Q=o.paint.get("icon-color-brightness-max"),ne=o.layout.get("symbol-elevation-reference")==="sea",he=l.context,de=he.gl,oe=l.transform,se=z==="map",le=P==="map",Me=D==="map",_e=N==="map",Ve=o.layout.get("symbol-sort-key").constantOr(1)!==void 0,ze=!1,je=l.depthModeForSublayer(0,bt.ReadOnly),rt=new bt(l.context.gl.LEQUAL,bt.ReadOnly,l.depthRangeFor3D),Ce=[n.aD(oe.center.lng),n.aH(oe.center.lat)],me=o.layout.get("text-variable-anchor"),ke=oe.projection.name==="globe",Pe=[],$e=[0,-1,0];for(let Ze of c){let Ye=t.getTile(Ze),ct=Ye.getBucket(o);if(!ct||ct.projection.name==="mercator"&&ke||ct.fullyClipped)continue;let Mt=ct.projection.name==="globe",Ot=Mt?n.ah(oe.zoom):0,yt=Ph(Ze,ct.getProjection(),oe),zt=oe.calculatePixelsToTileUnitsMatrix(Ye),Rt=me&&ct.hasTextData(),$t=ct.hasIconTextFit()&&Rt&&ct.hasIconData(),Jt=ct.getProjection().createInversionMatrix(oe,Ze.canonical),ai=(1<<Ye.tileID.canonical.z)*n.aj/l.transform.worldSize,Ti=Vi=>{let Ci=[0,0,0];if(Vi){let yr=l.style.directionalLight,bi=l.style.ambientLight;yr&&bi&&(Ci=Ca(l.style,yr,bi))}return Ci},Yt=Vi=>{oe.depthOcclusionForSymbolsAndCircles&&(o.hasInitialOcclusionOpacityProperties||l.terrain)&&(Vi.push("DEPTH_D24"),Vi.push("DEPTH_OCCLUSION"))},Si=()=>{let Vi=se&&o.layout.get("symbol-placement")!=="point",Ci=[];Yt(Ci);let yr=Vi||$t,bi=ct.elevationType==="road",Li=l.shadowRenderer,$i=bi&&Me&&!!Li&&Li.enabled,kr=Ti($i),Dr=bi&&Me&&!l.terrain?rt:je,Br=o.paint.get("icon-image-cross-fade");l.terrainRenderModeElevated()&&Me&&Ci.push("PITCH_WITH_MAP_TERRAIN"),Mt&&(Ci.push("PROJECTION_GLOBE_VIEW"),yr&&Ci.push("PROJECTED_POS_ON_VIEWPORT")),Br>0&&ct.hasAnySecondaryIcon&&Ci.push("ICON_TRANSITION"),!ct.icon.zOffsetVertexBuffer||bi&&l.terrain||Ci.push("Z_OFFSET"),U===0&&Z===0&&Y===0&&Q===1||Ci.push("COLOR_ADJUSTMENT"),ct.sdfIcons&&Ci.push("RENDER_SDF"),$i&&Ci.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),bi&&Me&&!l.terrain&&ct.icon.orientationVertexBuffer&&Ci.push("ELEVATED_ROADS");let hn=ct.icon.programConfigurations.get(o.id),Jo=l.getOrCreateProgram("symbol",{config:hn,defines:Ci}),kn=Ye.imageAtlasTexture?Ye.imageAtlasTexture.size:[0,0],to=ct.iconSizeData,yn=n.bH(to,oe.zoom),bo=Me||!oe.isOrthographic,Vo=Tc(yt,Ye.tileID.canonical,Me,se,oe,ct.getProjection(),zt),xn=Ms(yt,Ye.tileID.canonical,Me,se,oe,ct.getProjection(),zt),Cr=l.translatePosMatrix(xn,Ye,x,M,!0),Sr=l.translatePosMatrix(yt,Ye,x,M),Ki=yr?ka:Vo,Wr=se&&!Me&&!Vi,un=$e;!ke&&!oe.mercatorFromTransition||se||(un=Nc(oe));let Pr=Mt?un:$e,wo=o.getColorAdjustmentMatrix(U,Z,Y,Q),Va=su(to.kind,yn,Wr,Me,l,Sr,Ki,Cr,ne,!1,kn,[0,0],0,Ze,Ot,Ce,Jt,Pr,ct.getProjection(),kr,ai,wo,Br,null),ca=Ye.imageAtlasTexture?Ye.imageAtlasTexture:null,kl=o.layout.get("icon-size").constantOr(0)!==1||ct.iconsNeedLinear,Fl=ct.sdfIcons||l.options.rotating||l.options.zooming||kl||bo?de.LINEAR:de.NEAREST,To=ct.sdfIcons&&o.paint.get("icon-halo-width").constantOr(1)!==0,us=l.terrain&&Me&&Vi?n.bi(n.bz(),Vo):ka;if(Vi&&ct.icon){let Xr=oe.elevation,So=Xr?Xr.getAtTileOffsetFunc(Ze,oe.center.lat,oe.worldSize,ct.getProjection()):null,Ua=ol(yt,Ye.tileID.canonical,Me,se,oe,ct.getProjection(),zt);Ia(ct,yt,l,!1,Ua,xn,Me,F,So,Ze)}return{program:Jo,buffers:ct.icon,uniformValues:Va,atlasTexture:ca,atlasTextureIcon:null,atlasInterpolation:Fl,atlasInterpolationIcon:null,isSDF:ct.sdfIcons,hasHalo:To,depthMode:Dr,tile:Ye,renderWithShadows:$i,labelPlaneMatrixInv:us}},Mi=()=>{let Vi=le&&o.layout.get("symbol-placement")!=="point",Ci=[],yr=Vi||me||$t,bi=ct.elevationType==="road",Li=l.shadowRenderer,$i=bi&&_e&&!!Li&&Li.enabled,kr=Ti($i),Dr=bi&&_e&&!l.terrain?rt:je;l.terrainRenderModeElevated()&&_e&&Ci.push("PITCH_WITH_MAP_TERRAIN"),Mt&&(Ci.push("PROJECTION_GLOBE_VIEW"),yr&&Ci.push("PROJECTED_POS_ON_VIEWPORT")),!ct.text.zOffsetVertexBuffer||bi&&l.terrain||Ci.push("Z_OFFSET"),ct.iconsInText&&Ci.push("RENDER_TEXT_AND_SYMBOL"),Ci.push("RENDER_SDF"),$i&&Ci.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),bi&&_e&&!l.terrain&&ct.text.orientationVertexBuffer&&Ci.push("ELEVATED_ROADS"),Yt(Ci);let Br=ct.text.programConfigurations.get(o.id),hn=l.getOrCreateProgram("symbol",{config:Br,defines:Ci}),Jo,kn=[0,0],to=null,yn=ct.textSizeData;ct.iconsInText&&(kn=Ye.imageAtlasTexture?Ye.imageAtlasTexture.size:[0,0],to=Ye.imageAtlasTexture?Ye.imageAtlasTexture:null,Jo=_e||!oe.isOrthographic||l.options.rotating||l.options.zooming||yn.kind==="composite"||yn.kind==="camera"?de.LINEAR:de.NEAREST);let bo=Ye.glyphAtlasTexture?Ye.glyphAtlasTexture.size:[0,0],Vo=o.layout.get("text-size-scale-range"),xn=n.ay(l.scaleFactor,Vo[0],Vo[1]),Cr=n.bH(yn,oe.zoom,xn),Sr=Tc(yt,Ye.tileID.canonical,_e,le,oe,ct.getProjection(),zt),Ki=Ms(yt,Ye.tileID.canonical,_e,le,oe,ct.getProjection(),zt),Wr=l.translatePosMatrix(Ki,Ye,b,C,!0),un=l.translatePosMatrix(yt,Ye,b,C),Pr=yr?ka:Sr,wo=le&&!_e&&!Vi,Va=$e;!ke&&!oe.mercatorFromTransition||le||(Va=Nc(oe));let ca=su(yn.kind,Cr,wo,_e,l,un,Pr,Wr,ne,!0,bo,kn,0,Ze,Ot,Ce,Jt,Mt?Va:$e,ct.getProjection(),kr,ai,null,null,xn),kl=Ye.glyphAtlasTexture?Ye.glyphAtlasTexture:null,Fl=de.LINEAR,To=o.paint.get("text-halo-width").constantOr(1)!==0,us=l.terrain&&_e&&Vi?n.bi(n.bz(),Sr):ka;if(Vi&&ct.text){let Xr=oe.elevation,So=Xr?Xr.getAtTileOffsetFunc(Ze,oe.center.lat,oe.worldSize,ct.getProjection()):null,Ua=ol(yt,Ye.tileID.canonical,_e,le,oe,ct.getProjection(),zt);Ia(ct,yt,l,!0,Ua,Ki,_e,j,So,Ze)}return{program:hn,buffers:ct.text,uniformValues:ca,atlasTexture:kl,atlasTextureIcon:to,atlasInterpolation:Fl,atlasInterpolationIcon:Jo,isSDF:!0,hasHalo:To,depthMode:Dr,tile:Ye,renderWithShadows:$i,labelPlaneMatrixInv:us}},Wi=ct.icon.segments.get().length,ni=ct.text.segments.get().length,Ei=Wi&&!_.onlyText?Si():null,Ii=ni&&!_.onlyIcons?Mi():null,Ri=o.paint.get("icon-opacity").constantOr(1),li=o.paint.get("text-opacity").constantOr(1);if(Ve&&ct.canOverlap){ze=!0;let Vi=Ri&&!_.onlyText?ct.icon.segments.get():[],Ci=li&&!_.onlyIcons?ct.text.segments.get():[];for(let yr of Vi)Pe.push({segments:new n.bd([yr]),sortKey:yr.sortKey,state:Ei});for(let yr of Ci)Pe.push({segments:new n.bd([yr]),sortKey:yr.sortKey,state:Ii})}else _.onlyText||Pe.push({segments:Ri?ct.icon.segments:new n.bd([]),sortKey:0,state:Ei}),_.onlyIcons||Pe.push({segments:li?ct.text.segments:new n.bd([]),sortKey:0,state:Ii})}ze&&Pe.sort((Ze,Ye)=>Ze.sortKey-Ye.sortKey);for(let Ze of Pe){let Ye=Ze.state;if(Ye)if(l.terrain?l.terrain.setupElevationDraw(Ye.tile,Ye.program,{useDepthForOcclusion:oe.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Ye.labelPlaneMatrixInv}):l.setupDepthForOcclusion(oe.depthOcclusionForSymbolsAndCircles,Ye.program),he.activeTexture.set(de.TEXTURE0),Ye.atlasTexture&&Ye.atlasTexture.bind(Ye.atlasInterpolation,de.CLAMP_TO_EDGE,!0),Ye.atlasTextureIcon&&(he.activeTexture.set(de.TEXTURE1),Ye.atlasTextureIcon&&Ye.atlasTextureIcon.bind(Ye.atlasInterpolationIcon,de.CLAMP_TO_EDGE,!0)),Ye.renderWithShadows&&l.shadowRenderer.setupShadows(Ye.tile.tileID.toUnwrapped(),Ye.program,"vector-tile"),l.uploadCommonLightUniforms(l.context,Ye.program),Ye.hasHalo){let ct=Ye.uniformValues;ct.u_is_halo=1,ra(Ye.buffers,Ze.segments,o,l,Ye.program,Ye.depthMode,d,p,ct,2),ct.u_is_halo=0}else{if(Ye.isSDF){let ct=Ye.uniformValues;Ye.hasHalo&&(ct.u_is_halo=1,ra(Ye.buffers,Ze.segments,o,l,Ye.program,Ye.depthMode,d,p,ct,1)),ct.u_is_halo=0}ra(Ye.buffers,Ze.segments,o,l,Ye.program,Ye.depthMode,d,p,Ye.uniformValues,1)}}}function ra(l,t,o,c,d,p,_,x,b,M){let C=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer,l.orientationVertexBuffer];d.draw(c,c.context.gl.TRIANGLES,p,_,x,Nt.disabled,b,o.id,l.layoutVertexBuffer,l.indexBuffer,t,o.paint,c.transform.zoom,l.programConfigurations.get(o.id),C,M)}function Vc(l,t){let o=1<<l.canonical.z,c=(t.x*o-l.canonical.x-l.wrap*o)*n.aj,d=(t.y*o-l.canonical.y)*n.aj,p=n.e2(t.z,t.y);return n.d2(c,d,p)}function Tt(l,t,o,c,d){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let p=l.context.gl,_=new bt(l.context.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),x=new bt(l.context.gl.GREATER,bt.ReadWrite,l.depthRangeFor3D),b=function(D){let N=n.cU(D.pitch),F=.01;return D.isOrthographic&&(F=n.ai(1e-4,F,n.cZ(N>=cn?1:N/cn))),2*F}(l.transform),M=l.transform.getFreeCameraOptions().position,C="elevatedStructuresDepthReconstruct",z=l.getOrCreateProgram(C,{defines:["DEPTH_RECONSTRUCTION"]}),P=l.getOrCreateProgram(C);for(let D of c){let N=t.getTile(D),F=N.getBucket(o);if(!F)continue;let j=F.elevatedStructures;if(!j)continue;let U=F.elevationBufferData.heightRange,Z=Vc(D.toUnwrapped(),M),Y=l.translatePosMatrix(D.projMatrix,N,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),Q,ne,he,de;if(d==="initialize"){if(!U||U.min>=1||j.depthSegments.segments[0].primitiveLength===0)continue;Q=iu(Y,Z,b,1,0),ne=_,he=j.depthSegments,de=z}else if(d==="reset"){if(!U||U.min>=0||j.maskSegments.segments[0].primitiveLength===0)continue;Q=iu(Y,Z,0,0,1),ne=x,he=j.maskSegments,de=z}else if(d==="geometry"){if(j.depthSegments.segments[0].primitiveLength===0)continue;Q=iu(Y,Z,b,1,0),ne=_,he=j.depthSegments,de=P}de.draw(l,p.TRIANGLES,ne,Gt.disabled,ti.disabled,Nt.disabled,Q,o.id,j.vertexBuffer,j.indexBuffer,he,o.paint,l.transform.zoom)}}function lu(l,t,o){let{painter:c,sourceCache:d,layer:p,coords:_,colorMode:x,elevationType:b,terrainEnabled:M,pass:C}=l,z=c.context.gl,P=p.paint.get("fill-pattern"),D=p.paint.get("fill-pattern-cross-fade"),N=P.constantOr(null),F=b;b!=="road"||t&&!M||(F="none");let j=F==="road",U=l.painter.shadowRenderer,Z=j&&!!U&&U.enabled,Y=new bt(c.context.gl.LEQUAL,bt.ReadOnly,c.depthRangeFor3D),Q=[0,0,0];if(Z){let de=c.style.directionalLight,oe=c.style.ambientLight;de&&oe&&(Q=Ca(c.style,de,oe))}let ne=P&&P.constantOr(1),he=(de,oe)=>{let se,le,Me,_e,Ve;oe?(se=ne&&!p.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Me=z.LINES):(se=ne?"fillPattern":"fill",Me=z.TRIANGLES);for(let ze of _){let je=d.getTile(ze);if(ne&&!je.patternsLoaded())continue;let rt=je.getBucket(p);if(!rt)continue;let Ce=t?rt.elevationBufferData:rt.bufferData;if(Ce.isEmpty())continue;c.prepareDrawTile();let me=Ce.programConfigurations.get(p.id),ke=c.isTileAffectedByFog(ze),Pe=[],$e=[];j&&(Pe.push("ELEVATED_ROADS"),$e.push(Ce.elevatedLayoutVertexBuffer)),Z&&Pe.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ne&&(c.context.activeTexture.set(z.TEXTURE0),je.imageAtlasTexture&&je.imageAtlasTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),me.updatePaintBuffers());let Ze=!1;if(N&&je.imageAtlas){let yt=je.imageAtlas,zt=n.dZ.from(N),Rt=zt.getPrimary().scaleSelf(n.q.devicePixelRatio).toString(),$t=zt.getSecondary(),Jt=yt.patternPositions.get(Rt),ai=$t?yt.patternPositions.get($t.scaleSelf(n.q.devicePixelRatio).toString()):null;Ze=!!Jt&&!!ai,Jt&&me.setConstantPatternPositions(Jt,ai)}D>0&&(Ze||me.getPatternTransitionVertexBuffer("fill-pattern"))&&Pe.push("FILL_PATTERN_TRANSITION");let Ye=c.getOrCreateProgram(se,{config:me,overrideFog:ke,defines:Pe}),ct=c.translatePosMatrix(ze.projMatrix,je,p.paint.get("fill-translate"),p.paint.get("fill-translate-anchor"));Z&&U.setupShadows(je.tileID.toUnwrapped(),Ye,"vector-tile");let Mt=p.paint.get("fill-emissive-strength");if(oe){_e=Ce.lineIndexBuffer,Ve=Ce.lineSegments;let yt=c.terrain&&c.terrain.renderingToTexture?c.terrain.drapeBufferSize:[z.drawingBufferWidth,z.drawingBufferHeight];le=se==="fillOutlinePattern"&&ne?Mg(ct,Mt,c,je,yt,Q,D):Ag(ct,Mt,yt,Q)}else _e=Ce.indexBuffer,Ve=Ce.triangleSegments,le=ne?nm(ct,Mt,c,je,Q,D):rm(ct,Mt,Q);c.uploadCommonUniforms(c.context,Ye,ze.toUnwrapped());let Ot=de;(b==="road"&&!M||b==="offset")&&(Ot=Y),Ye.draw(c,Me,Ot,o||c.stencilModeForClipping(ze),x,Nt.disabled,le,p.id,Ce.layoutVertexBuffer,_e,Ve,p.paint,c.transform.zoom,me,$e)}};c.renderPass===C&&he(c.depthModeForSublayer(1,c.renderPass==="opaque"?bt.ReadWrite:bt.ReadOnly),!1),F==="none"&&c.renderPass==="translucent"&&p.paint.get("fill-antialias")&&he(c.depthModeForSublayer(p.getPaintProperty("fill-outline-color")?2:0,bt.ReadOnly),!0)}function Uc(l,t,o,c,d,p,_,x){o.resetLayerRenderingStats(l);let b=l.context,M=b.gl,C=l.transform,z=o.paint.get("fill-extrusion-pattern"),P=o.paint.get("fill-extrusion-pattern-cross-fade"),D=z.constantOr(null),N=z.constantOr(1),F=o.paint.get("fill-extrusion-opacity"),j=l.style.enable3dLights(),U=o.paint.get(j&&!N?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Z=[o.paint.get("fill-extrusion-ambient-occlusion-intensity"),U],Y=o.layout.get("fill-extrusion-edge-radius"),Q=Y>0&&!o.paint.get("fill-extrusion-rounded-roof"),ne=Q?0:Y,he=C.projection.name==="globe"?n.e5():0,de=C.projection.name==="globe",oe=de?n.ah(C.zoom):0,se=[n.aD(C.center.lng),n.aH(C.center.lat)],le=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Me=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(le?null:o.lut).toArray01().slice(0,3),_e=o.paint.get("fill-extrusion-flood-light-intensity"),Ve=o.paint.get("fill-extrusion-vertical-scale"),ze=o.paint.get("fill-extrusion-line-width").constantOr(1)!==0,je=o.paint.get("fill-extrusion-height-alignment"),rt=o.paint.get("fill-extrusion-base-alignment"),Ce=ss(l,o.paint.get("fill-extrusion-cutoff-fade-range")),me=[],ke;de&&me.push("PROJECTION_GLOBE_VIEW"),Z[0]>0&&me.push("FAUX_AO"),Q&&me.push("ZERO_ROOF_RADIUS"),x&&me.push("HAS_CENTROID"),_e>0&&me.push("FLOOD_LIGHT"),Ce.shouldRenderCutoff&&me.push("RENDER_CUTOFF"),ze&&me.push("RENDER_WALL_MODE");let Pe=l.renderPass==="shadow",$e=l.shadowRenderer,Ze=Pe&&!!$e,Ye=Pe?Nt.disabled:Nt.backCCW;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let ct=[0,0,0];if($e){let yt=l.style.directionalLight,zt=l.style.ambientLight;yt&&zt&&(ct=Ca(l.style,yt,zt)),Pe||(me.push("RENDER_SHADOWS","DEPTH_TEXTURE"),$e.useNormalOffset&&me.push("NORMAL_OFFSET")),ke=me.concat(["SHADOWS_SINGLE_CASCADE"])}let Mt=Ze?"fillExtrusionDepth":N?"fillExtrusionPattern":"fillExtrusion",Ot=o.getLayerRenderingStats();for(let yt of c){let zt=t.getTile(yt),Rt=zt.getBucket(o);if(!Rt||Rt.projection.name!==C.projection.name)continue;let $t=!1;$e&&($t=$e.getMaxCascadeForTile(yt.toUnwrapped())===0);let Jt=l.isTileAffectedByFog(yt),ai=Rt.programConfigurations.get(o.id),Ti=!1;if(D&&zt.imageAtlas){let Ii=zt.imageAtlas,Ri=n.dZ.from(D),li=Ri.getPrimary().scaleSelf(n.q.devicePixelRatio).toString(),Vi=Ri.getSecondary(),Ci=Ii.patternPositions.get(li),yr=Vi?Ii.patternPositions.get(Vi.scaleSelf(n.q.devicePixelRatio).toString()):null;Ti=!!Ci&&!!yr,Ci&&ai.setConstantPatternPositions(Ci,yr)}P>0&&(Ti||ai.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&me.push("FILL_EXTRUSION_PATTERN_TRANSITION");let Yt=l.getOrCreateProgram(Mt,{config:ai,defines:$t?ke:me,overrideFog:Jt});if(l.terrain&&l.terrain.setupElevationDraw(zt,Yt,{useMeterToDem:!0}),!Rt.centroidVertexBuffer){let Ii=Yt.attributes.a_centroid_pos;Ii!==void 0&&M.vertexAttrib2f(Ii,0,0)}!Pe&&$e&&$e.setupShadows(zt.tileID.toUnwrapped(),Yt,"vector-tile"),N&&(l.context.activeTexture.set(M.TEXTURE0),zt.imageAtlasTexture&&zt.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),ai.updatePaintBuffers());let Si=o.paint.get("fill-extrusion-vertical-gradient"),Mi=1/Rt.tileToMeter,Wi;if(Pe&&$e){if(cu(zt.tileID,Rt.maxHeight,l))continue;let Ii=$e.calculateShadowPassMatrixFromTile(zt.tileID.toUnwrapped());Wi=im(Ii,ne,Mi,Ve,je,rt)}else{let Ii=l.translatePosMatrix(yt.expandedProjMatrix,zt,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),Ri=C.projection.createInversionMatrix(C,yt.canonical);Wi=N?vl(Ii,l,Si,F,Z,ne,Mi,yt,zt,he,je,rt,oe,se,Ri,Me,Ve,P):Bd(Ii,l,Si,F,Z,ne,Mi,yt,he,je,rt,oe,se,Ri,Me,Ve,_e,ct)}l.uploadCommonUniforms(b,Yt,yt.toUnwrapped(),null,Ce);let ni=Rt.segments;if(C.projection.name==="mercator"&&!Pe&&(ni=Rt.getVisibleSegments(zt.tileID,l.terrain,l.transform.getFrustum(0)),!ni.get().length))continue;if(Ot)if(Pe)for(let Ii of ni.get())Ot.numRenderedVerticesInShadowPass+=Ii.primitiveLength;else for(let Ii of ni.get())Ot.numRenderedVerticesInTransparentPass+=Ii.primitiveLength;let Ei=[];(l.terrain||x)&&Ei.push(Rt.centroidVertexBuffer),de&&Ei.push(Rt.layoutVertexExtBuffer),ze&&Ei.push(Rt.wallVertexBuffer),Yt.draw(l,b.gl.TRIANGLES,d,p,_,Ye,Wi,o.id,Rt.layoutVertexBuffer,Rt.indexBuffer,ni,o.paint,l.transform.zoom,ai,Ei)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}class Rs{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function $n(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y){let Q=t.context,ne=Q.gl,he=t.transform,de=t.transform.zoom,oe=[],se=l.translate,le=l.translateAnchor,Me=l.edgeRadius,_e=ss(t,l.cutoffFadeRange);C==="clear"?(oe.push("CLEAR_SUBPASS"),Y&&(oe.push("CLEAR_FROM_TEXTURE"),Q.activeTexture.set(ne.TEXTURE0),Y.bind(ne.LINEAR,ne.CLAMP_TO_EDGE))):C==="sdf"&&oe.push("SDF_SUBPASS"),U&&oe.push("HAS_CENTROID"),_e.shouldRenderCutoff&&oe.push("RENDER_CUTOFF");let Ve=(ze,je,rt,Ce,me)=>{let ke=je.programConfigurations.get(c.id),Pe=t.isTileAffectedByFog(ze),$e=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:ke,defines:oe,overrideFog:Pe}),Ze=((ct,Mt,Ot,yt,zt,Rt,$t,Jt,ai,Ti,Yt)=>({u_matrix:Mt,u_opacity:Ot,u_ao_pass:yt?1:0,u_meter_to_tile:zt,u_ao:Rt,u_flood_light_intensity:$t,u_flood_light_color:Jt,u_attenuation:ai,u_edge_radius:Ti,u_fb:0,u_fb_size:Yt,u_dynamic_offset:1}))(0,Ce,z,M,me,[P,D*me],N,F,j,de>=17?0:Me*me,Y?Y.size[0]:0),Ye=[];U&&Ye.push(je.hiddenByLandmarkVertexBuffer),t.uploadCommonUniforms(Q,$e,ze.toUnwrapped(),null,_e),$e.draw(t,Q.gl.TRIANGLES,p,_,x,b,Ze,c.id,je.vertexBuffer,je.indexBuffer,rt,c.paint,de,ke,Ye)};for(let ze of d){let je=o.getTile(ze),rt=je.getBucket(c);if(!rt||rt.projection.name!==he.projection.name||!rt.groundEffect||rt.groundEffect&&!rt.groundEffect.hasData())continue;let Ce=rt.groundEffect,me=1/rt.tileToMeter;{let ke=t.translatePosMatrix(ze.projMatrix,je,se,le),Pe=Ce.getDefaultSegment();Ve(ze,Ce,Pe,ke,me)}if(Z)for(let ke=0;ke<4;ke++){let Pe=n.e3[ke](ze),$e=o.getTile(Pe);if(!$e)continue;let Ze=$e.getBucket(c);if(!Ze||Ze.projection.name!==he.projection.name||!Ze.groundEffect||Ze.groundEffect&&!Ze.groundEffect.hasData())continue;let Ye=Ze.groundEffect,ct,Mt;ke===0?(ct=[-n.aj,0,0],Mt=1):ke===1?(ct=[n.aj,0,0],Mt=0):ke===2?(ct=[0,-n.aj,0],Mt=3):(ct=[0,n.aj,0],Mt=2);let Ot=Ye.regionSegments[Mt];if(!Ot)continue;let yt=new Float32Array(16);n.bo(yt,ze.projMatrix,ct),Ve(ze,Ye,Ot,t.translatePosMatrix(yt,je,se,le),me)}}}function Ut(l,t,o,c,d,p,_){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();let x=p?p.findDEMTileFor(o):null;if(!(x&&x.dem||_))return;p&&x&&x.dem&&c.selfDEMTileTimestamp!==x.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=x.dem._timestamp);let b=U=>new n.P(Math.ceil((U+n.e7)*n.e8),0),M=U=>{let Z=t.getSource().minzoom,Y=ne=>{let he=t.getTileByID(ne);if(he&&he.hasData())return he.getBucket(d)},Q=[0,-1,1];for(let ne of Q){if(U.overscaledZ+ne<Z)continue;let he=Y(U.calculateScaledKey(U.overscaledZ+ne));if(he)return he}},C=[0,0,0],z=(U,Z)=>(C[0]=Math.min(U.min.y,Z.min.y),C[1]=Math.max(U.max.y,Z.max.y),C[2]=n.aj-Z.min.x>U.max.x?Z.min.x-n.aj:U.max.x,C),P=(U,Z)=>(C[0]=Math.min(U.min.x,Z.min.x),C[1]=Math.max(U.max.x,Z.max.x),C[2]=n.aj-Z.min.y>U.max.y?Z.min.y-n.aj:U.max.y,C),D=[(U,Z)=>z(U,Z),(U,Z)=>z(Z,U),(U,Z)=>P(U,Z),(U,Z)=>P(Z,U)],N=(U,Z,Y,Q,ne,he,de)=>{if(!p)return 0;let oe=[[he?Y:U,he?U:Y,0],[he?Y:Z,he?Z:Y,0]],se=de<0?n.aj+de:de,le=[he?se:(U+Z)/2,he?(U+Z)/2:se,0];return Y===0&&de<0||Y!==0&&de>0?p.getForTilePoints(ne,[le],!0,Q):oe.push(le),p.getForTilePoints(o,oe,!0,x),Math.max(oe[0][2],oe[1][2],le[2])/p.exaggeration()};for(let U=0;U<4;U++){let Z=c.borderFeatureIndices[U];if(Z.length===0)continue;let Y=n.e3[U](o),Q=M(Y);if(!(Q&&Q instanceof n.e4))continue;let ne=p?p.findDEMTileFor(Y):null;if(!(ne&&ne.dem||_)||(p&&ne&&ne.dem&&c.borderDEMTileTimestamp[U]!==ne.dem._timestamp&&(c.borderDoneWithNeighborZ[U]=-1,c.borderDEMTileTimestamp[U]=ne.dem._timestamp),c.borderDoneWithNeighborZ[U]===Q.canonical.z))continue;Q.centroidVertexArray.length===0&&Q.createCentroidsBuffer();let he=(U<2?1:5)-U,de=Q.borderDoneWithNeighborZ[he]!==c.canonical.z,oe=Q.borderFeatureIndices[he],se=0;if(c.canonical.z!==Q.canonical.z){for(let le of Z)c.showCentroid(c.featuresOnBorder[le]);if(de)for(let le of oe)Q.showCentroid(Q.featuresOnBorder[le]);c.borderDoneWithNeighborZ[U]=Q.canonical.z,Q.borderDoneWithNeighborZ[he]=c.canonical.z}for(let le of Z){let Me=c.featuresOnBorder[le],_e=c.centroidData[Me.centroidDataIndex],Ve=Me.borders[U],ze;for(;se<oe.length;){ze=Q.featuresOnBorder[oe[se]];let je=ze.borders[he];if(je[1]>Ve[0]+3||je[0]>Ve[0]-3)break;Q.showCentroid(ze),se++}if(ze&&se<oe.length){let je=se,rt=0;for(;!(ze.borders[he][0]>Ve[1]-3)&&(rt++,++se!==oe.length);)ze=Q.featuresOnBorder[oe[se]];ze=Q.featuresOnBorder[oe[je]];let Ce=!1;if(rt>=1){let Pe=ze.borders[he];Math.abs(Ve[0]-Pe[0])<3&&Math.abs(Ve[1]-Pe[1])<3&&(rt=1,Ce=!0,se=je+1)}else if(rt===0){c.showCentroid(Me);continue}let me=Q.centroidData[ze.centroidDataIndex];_&&Ce&&(((F=_e).flags|(j=me).flags)&n.e6?(F.flags|=n.e6,j.flags|=n.e6):(F.flags&=~n.e6,j.flags&=~n.e6));let ke=Me.intersectsCount()>1||ze.intersectsCount()>1;if(rt>1)se=je,_e.centroidXY=me.centroidXY=new n.P(0,0);else if(ne&&ne.dem&&!ke){let Pe=D[U](_e,me),$e=U%2?n.aj-1:0,Ze=N(Pe[0],Math.min(n.aj-1,Pe[1]),$e,ne,Y,U<2,Pe[2]);_e.centroidXY=me.centroidXY=b(Ze)}else ke?_e.centroidXY=me.centroidXY=new n.P(0,0):(_e.centroidXY=c.encodeBorderCentroid(Me),me.centroidXY=Q.encodeBorderCentroid(ze));c.writeCentroidToBuffer(_e),Q.writeCentroidToBuffer(me)}else c.showCentroid(Me)}c.borderDoneWithNeighborZ[U]=Q.canonical.z,Q.borderDoneWithNeighborZ[he]=c.canonical.z}var F,j;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(l)}let Yd=[1,0,0],Pg=[0,1,0],Rg=[0,0,1];function cu(l,t,o){let c=o.transform,d=o.shadowRenderer;if(!d)return!0;let p=l.toUnwrapped(),_=c.tileSize*d._cascades[o.currentShadowCascade].scale,x=t;if(c.elevation){let F=c.elevation.getMinMaxForTile(l);F&&(x+=F.max)}let b=[...d.shadowDirection];b[2]=-b[2];let M=d.computeSimplifiedTileShadowVolume(p,x,_,b);if(!M)return!1;let C=[Yd,Pg,Rg,b,[b[0],0,b[2]],[0,b[1],b[2]]],z=c.projection.name==="globe",P=c.scaleZoom(_),D=n.cy.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,P,!z),N=d.getCurrentCascadeFrustum();return D.intersectsPrecise(M.vertices,M.planes,C)===0||N.intersectsPrecise(M.vertices,M.planes,C)===0}function hu(l){let{painter:t,source:o,layer:c,coords:d}=l,p=l.defines,_=t.context,x=t.renderPass==="shadow",b=t.renderPass==="light-beam",M=t.shadowRenderer,C;M&&(C=p.concat(["SHADOWS_SINGLE_CASCADE"]));let z=n.e9(t.transform.center.lat,t.transform.zoom);for(let P of d){let D=o.getTile(P),N=D.getBucket(c);if(!N)continue;let F=!1;M&&(F=M.getMaxCascadeForTile(P.toUnwrapped())===0);let j=N.programConfigurations.get(c.id),U,Z,Y=t.translatePosMatrix(P.expandedProjMatrix,D,[0,0],"map");if(Y=n.cP(n.bz(),Y,[1,1,l.verticalScale]),x&&M){if(cu(D.tileID,N.maxHeight*z,t))continue;let Q=M.calculateShadowPassMatrixFromTile(D.tileID.toUnwrapped());Q=n.cP(n.bz(),Q,[1,1,l.verticalScale]),Z=om(Q),U=t.getOrCreateProgram("buildingDepth",{config:j,defines:F?C:p,overrideFog:!1})}else if(b)U=t.getOrCreateProgram("buildingBloom",{config:j,defines:F?C:p,overrideFog:!1}),Z=Vd(Y);else{let Q=t.transform.calculatePosMatrix(P.toUnwrapped(),t.transform.worldSize);n.cP(Q,Q,[1,1,l.verticalScale]);let ne=n.bz();n.cP(ne,Q,[1,-1,1/z]),n.bi(ne,ne),n.ea(ne,ne),Z=Nd(Y,ne),U=t.getOrCreateProgram("building",{config:j,defines:F?C:p,overrideFog:!1}),M&&M.setupShadowsFromMatrix(Q,U,!0)}if(t.uploadCommonUniforms(_,U,P.toUnwrapped(),null,null),b){let Q=N.bloomGeometry;U.draw(t,_.gl.TRIANGLES,l.depthMode,Gt.disabled,l.blendMode,Nt.disabled,Z,c.id,Q.layoutVertexBuffer,Q.indexBuffer,Q.segmentsBucket,c.paint,t.transform.zoom,j,[Q.layoutAttenuationBuffer,Q.layoutColorBuffer])}else U.draw(t,_.gl.TRIANGLES,l.depthMode,Gt.disabled,l.blendMode,x?Nt.disabled:Nt.backCW,Z,c.id,N.layoutVertexBuffer,N.indexBuffer,N.segments,c.paint,t.transform.zoom,j,[N.layoutNormalBuffer,N.layoutColorBuffer])}}function fm(l){return[l[0]*n.eb,l[1]*n.eb,l[2]*n.eb,0]}function uu(l,t,o,c,d,p,_,x,b){let M=c.getSource(),C=o.globeSharedBuffers;if(!C)return;let z,P,D;if(t&&(z=c.getTile(t)),M instanceof n.aP?(P=M.texture,D=n.dE(0,0,o.transform)):z&&t&&(P=z.texture,D=n.dE(t.canonical.z,t.canonical.x,o.transform)),!P||!D)return;l||(D=n.cP(n.bz(),D,[1,-1,1]));let N=o.context,F=N.gl,j=d.paint.get("raster-resampling")==="nearest"?F.NEAREST:F.LINEAR,U=o.colorModeForDrapableLayerRenderPass(p),Z=_.defines;Z.push("GLOBE_POLES");let Y=new bt(F.LEQUAL,bt.ReadWrite,o.depthRangeFor3D),Q=Float32Array.from(o.transform.expandedFarZProjMatrix),ne=Float32Array.from(n.bh(n.dD(new n.cA(0,0,0))));o.terrain&&o.terrain.prepareDrawTile(),N.activeTexture.set(F.TEXTURE0),P.bind(j,F.CLAMP_TO_EDGE),N.activeTexture.set(F.TEXTURE1),P.bind(j,F.CLAMP_TO_EDGE),"useMipmap"in P&&N.extTextureFilterAnisotropic&&o.transform.pitch>20&&F.texParameterf(F.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);let[he,de,oe,se]=t?C.getPoleBuffers(t.canonical.z,!1):C.getPoleBuffers(0,!0),le=d.paint.get("raster-elevation"),Me;l?(Me=he,o.renderDefaultNorthPole=le!==0):(Me=de,o.renderDefaultSouthPole=le!==0);let _e=fm(_.mix),Ve=((je,rt,Ce,me,ke,Pe,$e,Ze,Ye,ct,Mt,Ot,yt)=>jd(je,rt,Ce,new Float32Array(16),new Float32Array(9),[0,0],me,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Pe,[0,0],Ze,2,ct,Mt,Ot,1,0,yt))(Q,ne,D,n.ah(o.transform.zoom),0,d,0,le,0,_e,_.offset,_.range,p),ze=o.getOrCreateProgram("raster",{defines:Z});o.uploadCommonUniforms(N,ze,null),ze.draw(o,F.TRIANGLES,Y,b,U,x,Ve,d.id,Me,oe,se)}function Lg(l){let t=l._nearZ,o=l.projection.farthestPixelDistance(l),c=o-t,d=.2*l.height,p=t+d;return[t,o,(p-d-t)/c,(p-t)/c]}function zg(l,t,o,c){if(l)return t instanceof Gs&&l instanceof tl?t.getTextureDescriptor(l,o,!0):{texture:l.texture,mix:fm(c.mix),offset:c.offset,buffer:0,tileSize:1}}var eo=n.ec([{name:"a_index",type:"Int16",components:1}]);class Kd{constructor(t,o,c,d){let p={width:c[0],height:c[1],data:null},_=t.gl;this.targetColorTexture=new n.T(t,p,_.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new n.T(t,p,_.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(o,d),this.lastInvalidatedAt=0}updateParticleTexture(t,o){if(this.particleTextureDimension===o.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let c=this.context.gl,d=o.width*o.height;this.particleTexture0=new n.T(this.context,o,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new n.T(this.context,o,c.RGBA8,{premultiply:!1,useMipmap:!1});let p=new n.ed;p.reserve(d);for(let _=0;_<d;_++)p.emplaceBack(_);this.particleIndexBuffer=this.context.createVertexBuffer(p,eo.members,!0),this.particleSegment=n.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=o.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=n.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Dn(l,t,o){if(!l)return null;let c=t.getTextureDescriptor(l,o,!0);if(!c)return null;let{texture:d,mix:p,offset:_,tileSize:x,buffer:b,format:M}=c;if(!d||!M)return null;let C=!1;return M==="uint32"&&(C=!0,p[3]=0,p=ru(n.ee,p,[0,o.paint.get("raster-particle-max-speed")]),_=Js(n.ee,_,[0,o.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[b/(x+2*b),x/(x+2*b)],tileSize:x,scalarData:C,scale:p,offset:_,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[M]]}}function na(l){let t=l._nearZ,o=l.projection.farthestPixelDistance(l),c=o-t,d=.2*l.height,p=t+d;return[t,o,(p-d-t)/c,(p-t)/c]}let mm=new n.am(1,0,0,1),Jd=new n.am(0,1,0,1),Qd=new n.am(0,0,1,1),ep=new n.am(1,0,1,1),_m=new n.am(0,1,1,1);function as(l,t,o,c,d,p){for(let _=0;_<o.length;_++)if(d){let M=new n.am(c.r*.8,c.g*.8,c.b*.8,1);ji(l,t,o[_],c,-1,-1,p),ji(l,t,o[_],c,-1,1,p),ji(l,t,o[_],c,1,1,p),ji(l,t,o[_],c,1,-1,p),ji(l,t,o[_],M,0,0,p)}else ji(l,t,o[_],c,0,0,p)}function ji(l,t,o,c,d,p,_){let x=l.context,b=l.transform,M=x.gl,C=b.projection.name==="globe",z=C?["PROJECTION_GLOBE_VIEW"]:[],P=n.bw(o.projMatrix);if(C&&n.ah(b.zoom)>0){let _e=n.bg(o.canonical,b),Ve=n.ef(_e);P=n.az(new Float32Array(16),b.globeMatrix,Ve),n.az(P,b.projMatrix,P)}let D=n.bz();D[12]+=2*d/(n.q.devicePixelRatio*b.width),D[13]+=2*p/(n.q.devicePixelRatio*b.height),n.az(P,D,P);let N=l.getOrCreateProgram("debug",{defines:z}),F=t.getTileByID(o.key);l.terrain&&l.terrain.setupElevationDraw(F,N);let j=bt.disabled,U=Gt.disabled,Z=l.colorModeForRenderPass(),Y="$debug";x.activeTexture.set(M.TEXTURE0),l.emptyTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),C?F._makeGlobeTileDebugBuffers(l.context,b):F._makeDebugTileBoundsBuffers(l.context,b.projection);let Q=F._tileDebugBuffer||l.debugBuffer,ne=F._tileDebugIndexBuffer||l.debugIndexBuffer,he=F._tileDebugSegments||l.debugSegments;if(N.draw(l,M.LINE_STRIP,j,U,Z,Nt.disabled,Ud(P,c.toPremultipliedRenderColor(null)),Y,Q,ne,he,null,null,null,[F._globeTileDebugBorderBuffer]),_){let _e=F.latestRawTileData,Ve=Math.floor((_e&&_e.byteLength||0)/1024),ze=o.canonical.toString();o.overscaledZ!==o.canonical.z&&(ze+=` => ${o.overscaledZ}`),ze+=` ${F.state}`,ze+=` ${Ve}kb`,function(je,rt){je.initDebugOverlayCanvas();let Ce=je.debugOverlayCanvas,me=je.context.gl,ke=je.debugOverlayCanvas.getContext("2d");ke.clearRect(0,0,Ce.width,Ce.height),ke.shadowColor="white",ke.shadowBlur=2,ke.lineWidth=1.5,ke.strokeStyle="white",ke.textBaseline="top",ke.font="bold 36px Open Sans, sans-serif",ke.fillText(rt,5,5),ke.strokeText(rt,5,5),je.debugOverlayTexture.update(Ce),je.debugOverlayTexture.bind(me.LINEAR,me.CLAMP_TO_EDGE)}(l,ze)}let de=t.getTile(o).tileSize,oe=512/Math.min(de,512)*(o.overscaledZ/b.zoom)*.5,se=F._tileDebugTextBuffer||l.debugBuffer,le=F._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,Me=F._tileDebugTextSegments||l.debugSegments;N.draw(l,M.TRIANGLES,j,U,ti.alphaBlended,Nt.disabled,Ud(P,n.am.transparent.toPremultipliedRenderColor(null),oe),Y,se,le,Me,null,null,null,[F._globeTileDebugTextBuffer])}function jc(l,t,o,c){Gc(l,0,t+o/2,l.transform.width,o,c)}function du(l,t,o,c){Gc(l,t-o/2,0,o,l.transform.height,c)}function Gc(l,t,o,c,d,p){let _=l.context,x=_.gl;x.enable(x.SCISSOR_TEST),x.scissor(t*n.q.devicePixelRatio,o*n.q.devicePixelRatio,c*n.q.devicePixelRatio,d*n.q.devicePixelRatio),_.clear({color:p}),x.disable(x.SCISSOR_TEST)}let gm=n.ec([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:ym}=gm;function oa(l,t,o,c){l.emplaceBack(t,o,c)}class Fa{constructor(t){this.vertexArray=new n.eg,this.indices=new n.a_,oa(this.vertexArray,-1,-1,1),oa(this.vertexArray,1,-1,1),oa(this.vertexArray,-1,1,1),oa(this.vertexArray,1,1,1),oa(this.vertexArray,-1,-1,-1),oa(this.vertexArray,1,-1,-1),oa(this.vertexArray,-1,1,-1),oa(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,ym),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=n.bd.simpleSegment(0,0,36,12)}}function Ko(l,t,o,c,d,p){let _=l.context.gl,x=t.paint.get("sky-atmosphere-color"),b=t.paint.get("sky-atmosphere-halo-color"),M=t.paint.get("sky-atmosphere-sun-intensity"),C=((z,P,D,N,F)=>({u_matrix_3f:z,u_sun_direction:P,u_sun_intensity:D,u_color_tint_r:[N.r,N.g,N.b,N.a],u_color_tint_m:[F.r,F.g,F.b,F.a],u_luminance:5e-5}))(n.ei(n.dJ(),c),d,M,x.toPremultipliedRenderColor(null),b.toPremultipliedRenderColor(null));_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+p,t.skyboxTexture,0),o.draw(l,_.TRIANGLES,bt.disabled,Gt.disabled,ti.unblended,Nt.frontCW,C,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}let ot=n.ec([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class gt{constructor(t){let o=new n.ej;o.emplaceBack(-1,1,1,0,0),o.emplaceBack(1,1,1,1,0),o.emplaceBack(1,-1,1,1,1),o.emplaceBack(-1,-1,1,0,1);let c=new n.a_;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(o,ot.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=n.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}let wl=n.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Ar{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Se{constructor(t){this.colorModeAlphaBlendedWriteRGB=new ti([1,Ma,1,Ma],n.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ti([1,0,1,0],n.am.transparent,[!1,!1,!1,!0]),this.params=new Ar,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){let o=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new gt(o);let c=this.params.sizeRange,d=this.params.intensityRange,p=function(C){let z=n.el(30),P=[];for(let D=0;D<C;++D){let N=2*Math.PI*z(),F=Math.acos(1-2*z())-.5*Math.PI;P.push(n.d2(Math.cos(F)*Math.cos(N),Math.cos(F)*Math.sin(N),Math.sin(F)))}return P}(this.params.starsCount),_=n.el(300),x=new n.ek,b=new n.a_,M=0;for(let C=0;C<p.length;++C){let z=n.c1([],p[C],200),P=Math.max(0,1+.01*c*(1*_()-.5)),D=Math.max(0,1+.01*d*(1*_()-.5));x.emplaceBack(z[0],z[1],z[2],-1,-1,P,D),x.emplaceBack(z[0],z[1],z[2],1,-1,P,D),x.emplaceBack(z[0],z[1],z[2],1,1,P,D),x.emplaceBack(z[0],z[1],z[2],-1,1,P,D),b.emplaceBack(M+0,M+1,M+2),b.emplaceBack(M+0,M+2,M+3),M+=4}this.starsVx=o.createVertexBuffer(x,wl.members),this.starsIdx=o.createIndexBuffer(b),this.starsSegments=n.bd.simpleSegment(0,0,x.length,b.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,o){let c=t.context,d=c.gl,p=t.transform,_=new bt(d.LEQUAL,bt.ReadOnly,[0,1]),x=n.ah(p.zoom),b=t.style.getLut(o.scope),M=o.properties.get("color-use-theme")==="none",C=o.properties.get("color").toNonPremultipliedRenderColor(M?null:b).toArray01(),z=o.properties.get("high-color-use-theme")==="none",P=o.properties.get("high-color").toNonPremultipliedRenderColor(z?null:b).toArray01(),D=o.properties.get("space-color-use-theme")==="none",N=o.properties.get("space-color").toNonPremultipliedRenderColor(D?null:b).toArray01(),F=5e-4,j=n.em(o.properties.get("horizon-blend"),0,1,F,.25),U=n.dy(t,c,p)&&j===F?p.worldSize/(2*Math.PI*1.025)-1:p.globeRadius,Z=t.frameCounter/1e3%1,Y=n.ae(p.globeCenterInViewSpace),Q=Math.sqrt(Math.pow(Y,2)-Math.pow(U,2)),ne=Math.acos(Q/Y),he=de=>{let oe=p.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];de&&oe.push("ALPHA_PASS");let se=t.getOrCreateProgram("globeAtmosphere",{defines:oe}),le=((_e,Ve,ze,je,rt,Ce,me,ke,Pe,$e,Ze,Ye)=>({u_frustum_tl:_e,u_frustum_tr:Ve,u_frustum_br:ze,u_frustum_bl:je,u_horizon:rt,u_transition:Ce,u_fadeout_range:me,u_color:ke,u_high_color:Pe,u_space_color:$e,u_temporal_offset:Ze,u_horizon_angle:Ye}))(p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.frustumCorners.horizon,x,j,C,P,N,Z,ne);t.uploadCommonUniforms(c,se);let Me=this.atmosphereBuffer;Me&&se.draw(t,d.TRIANGLES,_,Gt.disabled,de?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Nt.backCW,le,de?"atmosphere_glow_alpha":"atmosphere_glow",Me.vertexBuffer,Me.indexBuffer,Me.segments)};he(!1),he(!0)}drawStars(t,o){let c=n.ay(o.properties.get("star-intensity"),0,1);if(c===0)return;let d=t.context,p=d.gl,_=t.transform,x=t.getOrCreateProgram("stars"),b=n.c3([]);n.c5(b,b,-_._pitch),n.c4(b,b,-_.angle),n.c5(b,b,n.al(_._center.lat)),n.en(b,b,-n.al(_._center.lng));let M=n.c8(new Float32Array(16),b),C=n.az([],_.starsProjMatrix,M),z=n.ei([],M),P=n.eo([],z),D=[0,1,0];n.dL(D,D,P),n.c1(D,D,this.params.sizeMultiplier);let N=[1,0,0];n.dL(N,N,P),n.c1(N,N,this.params.sizeMultiplier);let F=(j=D,U=N,Z=c,{u_matrix:Float32Array.from(C),u_up:j,u_right:U,u_intensity_multiplier:Z});var j,U,Z;t.uploadCommonUniforms(d,x),this.starsVx&&this.starsIdx&&x.draw(t,p.TRIANGLES,bt.disabled,Gt.disabled,this.colorModeAlphaBlendedWriteRGB,Nt.disabled,F,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class xm{constructor(){this.visibleTiles=[]}updateBorders(t,o){let c=[],d=[],p=t._getRenderableCoordinates(!1,!0);for(let b of p){let M=t.getTile(b);if(!M.hasData())continue;let C=M.getBucket(o);C&&(C.isEmpty()||(c.push(b.key),d.push({bucket:C,tileID:b.canonical})))}let _=c.length!==this.visibleTiles.length;if(!_){c.sort();for(let b=0;b<c.length;b++)if(c[b]!==this.visibleTiles[b]){_=!0;break}}if(!_)return;let x=new Set;this.visibleTiles=c,d.sort((b,M)=>b.tileID.z-M.tileID.z||b.tileID.x-M.tileID.x||b.tileID.y-M.tileID.y);for(let b of d){let M=new Array,C=new Array,z=b.bucket;for(let P of z.featuresOnBorder)x.has(P.featureId)?C.push(P.footprintIndex):(x.add(P.featureId),M.push(P.footprintIndex));z.updateFootprintHiddenFlags(M,n.ep,!1),z.updateFootprintHiddenFlags(C,n.ep,!0)}}}function qc(l,t){let o=[...l],c=t.cameraWorldSizeForFog/t.worldSize,d=n.bx([]);return n.cP(d,d,[c,c,1]),n.az(o,d,o),n.az(o,t.worldToFogMatrix,o),o}function Hc(l,t,o,c,d){let p=o.material,_=c.context,{baseColorTexture:x,metallicRoughnessTexture:b}=p.pbrMetallicRoughness,{normalTexture:M,occlusionTexture:C,emissionTexture:z}=p;function P(N,F,j){if(N&&(l.push(F),_.activeTexture.set(_.gl.TEXTURE0+j),N.gfxTexture)){let{minFilter:U,magFilter:Z,wrapS:Y,wrapT:Q}=N.sampler;N.gfxTexture.bindExtraParam(U,Z,Y,Q)}}P(x,"HAS_TEXTURE_u_baseColorTexture",zn.BaseColor),P(b,"HAS_TEXTURE_u_metallicRoughnessTexture",zn.MetallicRoughness),P(M,"HAS_TEXTURE_u_normalTexture",zn.Normal),P(C,"HAS_TEXTURE_u_occlusionTexture",zn.Occlusion),P(z,"HAS_TEXTURE_u_emissionTexture",zn.Emission),d&&(d.texture||(d.texture=new n.et(c.context,d.image,[d.image.height,d.image.height,d.image.height],_.gl.RGBA8)),_.activeTexture.set(_.gl.TEXTURE0+zn.LUT),d.texture&&d.texture.bind(_.gl.LINEAR,_.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),o.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(o.texcoordBuffer)),o.colorBuffer&&(l.push(o.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(o.colorBuffer)),o.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(o.normalBuffer)),o.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(o.pbrBuffer)),p.alphaMode!=="OPAQUE"&&p.alphaMode!=="MASK"||l.push("UNPREMULT_TEXTURE_IN_SHADER"),p.defined||l.push("DIFFUSE_SHADED");let D=c.shadowRenderer;D&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),D.useNormalOffset&&l.push("NORMAL_OFFSET"))}function Tl(l,t,o,c,d,p){let _=o.paint.get("model-opacity").constantOr(1),x=t.context,b=new bt(t.context.gl.LEQUAL,bt.ReadWrite,t.depthRangeFor3D),M=t.transform,C=l.mesh,z=C.material,P=z.pbrMetallicRoughness,D=t.style.fog,N;N=t.transform.projection.zAxisUnit==="pixels"?[...l.nodeModelMatrix]:n.az([],c.zScaleMatrix,l.nodeModelMatrix),n.az(N,c.negCameraPosMatrix,N);let F=n.bi([],N);n.ea(F,F);let j=o.paint.get("model-color-use-theme").constantOr("default")==="none",U=o.paint.get("model-emissive-strength").constantOr(0),Z=qd(new Float32Array(l.worldViewProjection),new Float32Array(N),new Float32Array(F),null,t,_,P.baseColorFactor,z.emissiveFactor,P.metallicFactor,P.roughnessFactor,z,U,o),Y={defines:[]},Q=[],ne=t.shadowRenderer;ne&&(ne.useNormalOffset=!1),Hc(Y.defines,Q,C,t,j?null:o.lut);let he=null;if(D){let se=qc(l.nodeModelMatrix,t.transform);if(he=new Float32Array(se),M.projection.name!=="globe"){let le=C.aabb.min,Me=C.aabb.max,[_e,Ve]=D.getOpacityForBounds(se,le[0],le[1],Me[0],Me[1]);Y.overrideFog=_e>=He||Ve>=He}}let de=ss(t,o.paint.get("model-cutoff-fade-range"));de.shouldRenderCutoff&&Y.defines.push("RENDER_CUTOFF");let oe=t.getOrCreateProgram("model",Y);t.uploadCommonUniforms(x,oe,null,he,de),t.renderPass!=="shadow"&&ne&&ne.setupShadowsFromMatrix(l.nodeModelMatrix,oe),oe.draw(t,x.gl.TRIANGLES,b,d,p,C.material.doubleSided?Nt.disabled:Nt.backCCW,Z,o.id,C.vertexBuffer,C.indexBuffer,C.segments,o.paint,t.transform.zoom,void 0,Q)}function tp(l,t,o,c,d,p,_){let x;x=l.projection.name==="globe"?n.er(o,l):[...o],n.az(x,x,t.matrix);let b=n.az([],c,x);if(t.meshes)for(let M of t.meshes){if(M.material.alphaMode!=="BLEND"){_.push({mesh:M,depth:0,modelIndex:d,worldViewProjection:b,nodeModelMatrix:x});continue}let C=n.ad([],M.centroid,b);!l.isOrthographic&&C[2]<=0||p.push({mesh:M,depth:C[2],modelIndex:d,worldViewProjection:b,nodeModelMatrix:x})}if(t.children)for(let M of t.children)tp(l,M,o,c,d,p,_)}function pu(l,t,o,c){let d=o.shadowRenderer;if(!d)return;let p=d.getShadowPassDepthMode(),_=d.getShadowPassColorMode(),x=d.calculateShadowPassMatrixFromMatrix(t),b=um(x);o.getOrCreateProgram("modelDepth",{defines:o._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(o,o.context.gl.TRIANGLES,p,Gt.disabled,_,Nt.backCCW,b,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,o.transform.zoom,void 0,void 0)}function Sl(l,t,o){let c=t.updateZoomBasedPaintProperties(),d=function(p,_,x){let b,M,C,z=p.terrain?p.terrain.exaggeration():0;if(p.terrain&&z>0){let P=p.terrain,D=P.findDEMTileFor(x);D&&D.dem?b=n.eu.create(P,x,D):z=0}if(z===0&&(_.terrainElevationMin=0,_.terrainElevationMax=0),z===_.validForExaggeration&&(z===0||b&&b._demTile&&b._demTile.tileID===_.validForDEMTile.id&&b._dem._timestamp===_.validForDEMTile.timestamp))return!1;for(let P in _.instancesPerModel){let D=_.instancesPerModel[P];for(let N=0;N<D.instancedDataArray.length;++N){let F=(b?z*b.getElevationAt(0|D.instancedDataArray.float32[16*N],0|D.instancedDataArray.float32[16*N+1],!0,!0):0)+D.instancesEvaluatedElevation[N];D.instancedDataArray.float32[16*N+6]=F,M=M?Math.min(_.terrainElevationMin,F):F,C=C?Math.max(_.terrainElevationMax,F):F}}return _.terrainElevationMin=M||0,_.terrainElevationMax=C||0,_.validForExaggeration=z,_.validForDEMTile=b&&b._demTile?{id:b._demTile.tileID,timestamp:b._dem._timestamp}:{id:void 0,timestamp:0},!0}(l,t,o);(c||d)&&(t.uploaded=!1,t.upload(l.context))}let ls={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new n.d6([0,0,0],[n.aj,n.aj,0])};function Dg(l,t){let o=1<<l.canonical.z,c=t.getFreeCameraOptions().position,d=t.elevation,p=l.canonical.x/o,_=(l.canonical.x+1)/o,x=l.canonical.y/o,b=(l.canonical.y+1)/o,M=t._centerAltitude;if(d){let D=d.getMinMaxForTile(l);D&&D.max>M&&(M=D.max)}let C=n.ay(c.x,p,_)-c.x,z=n.ay(c.y,x,b)-c.y,P=n.cb(M,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(C*C+z*z+P*P))}function ip(l,t,o,c,d,p,_){let x=l.context,b=l.renderPass==="shadow",M=l.shadowRenderer,C=b&&M?M.getShadowPassDepthMode():new bt(x.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),z=l.isTileAffectedByFog(p);if(o.meshes)for(let P of o.meshes){let D=["MODEL_POSITION_ON_GPU"],N=[],F,j,U;c.instancedDataArray.length>20&&D.push("INSTANCED_ARRAYS");let Z=ss(l,t.paint.get("model-cutoff-fade-range"));if(Z.shouldRenderCutoff&&D.push("RENDER_CUTOFF"),b&&M)F=l.getOrCreateProgram("modelDepth",{defines:D}),j=um(_.shadowTileMatrix,_.shadowTileMatrix,Float32Array.from(o.matrix)),U=M.getShadowPassColorMode();else{Hc(D,N,P,l,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),F=l.getOrCreateProgram("model",{defines:D,overrideFog:z});let Q=P.material,ne=Q.pbrMetallicRoughness,he=t.paint.get("model-opacity").constantOr(1),de=t.paint.get("model-emissive-strength").constantOr(0);j=qd(p.expandedProjMatrix,Float32Array.from(o.matrix),new Float32Array(16),null,l,he,ne.baseColorFactor,Q.emissiveFactor,ne.metallicFactor,ne.roughnessFactor,Q,de,t,d),M&&(_.shadowUniformsInitialized?F.setShadowUniformValues(x,M.getShadowUniformValues()):(M.setupShadows(p.toUnwrapped(),F,"model-tile"),_.shadowUniformsInitialized=!0)),U=Z.shouldRenderCutoff||he<1||Q.alphaMode!=="OPAQUE"?ti.alphaBlended:ti.unblended}l.uploadCommonUniforms(x,F,p.toUnwrapped(),null,Z);let Y=P.material.doubleSided?Nt.disabled:Nt.backCCW;if(c.instancedDataArray.length>20)N.push(c.instancedDataBuffer),F.draw(l,x.gl.TRIANGLES,C,Gt.disabled,U,Y,j,t.id,P.vertexBuffer,P.indexBuffer,P.segments,t.paint,l.transform.zoom,void 0,N,c.instancedDataArray.length);else{let Q=b?"u_instance":"u_normal_matrix";for(let ne=0;ne<c.instancedDataArray.length;++ne)j[Q]=new Float32Array(c.instancedDataArray.arrayBuffer,64*ne,16),F.draw(l,x.gl.TRIANGLES,C,Gt.disabled,U,Y,j,t.id,P.vertexBuffer,P.indexBuffer,P.segments,t.paint,l.transform.zoom,void 0,N)}}if(o.children)for(let P of o.children)ip(l,t,P,c,d,p,_)}let fu=[1,-1,1];function rp(l,t,o,c){if(!o.modelManager)return!0;let d=o.modelManager;if(!o.shadowRenderer)return!0;let p=o.shadowRenderer,_=t.aabb,x=!0,b=l.maxHeight;if(b===0){let C=0;for(let z in l.instancesPerModel){let P=d.getModel(z,c);P?C=Math.max(C,Math.max(Math.max(P.aabb.max[0],P.aabb.max[1]),P.aabb.max[2])):x=!1}b=l.maxScale*C*1.41+l.maxVerticalOffset,x&&(l.maxHeight=b)}_.max[2]=b,_.min[2]+=l.terrainElevationMin,_.max[2]+=l.terrainElevationMax,n.ad(_.min,_.min,t.tileMatrix),n.ad(_.max,_.max,t.tileMatrix);let M=_.intersects(p.getCurrentCascadeFrustum());return o.currentShadowCascade===0&&(l.isInsideFirstShadowMapFrustum=M===2),M===0}function vm(l,t){let o=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],d=l.uniformValues.u_cutoff_params[2],p=l.uniformValues.u_cutoff_params[3];return c===o||p===d?1:n.ay(((t-o)/(c-o)-d)/(p-d),0,1)}function bm(l,t,o,c){if(t.pitch<20)return 1;let d=t.getWorldToCameraMatrix();n.az(d,d,l);let p=n.bR(o.min[0],o.min[1],o.min[2],1),_=n.aA(n.ev(),p,d),x=_,b=_;p[1]=o.max[1],_=n.aA(n.ev(),p,d),x=_[1]<x[1]?_:x,b=_[1]>b[1]?_:b,p[0]=o.max[0],_=n.aA(n.ev(),p,d),x=_[1]<x[1]?_:x,b=_[1]>b[1]?_:b,p[1]=o.min[1],_=n.aA(n.ev(),p,d),x=_[1]<x[1]?_:x,b=_[1]>b[1]?_:b;let M=n.ay(c[0],0,1),C=100*t.pixelsPerMeter*n.ay(c[1],0,1),z=n.ay(c[2],0,1),P=n.ew(n.ev(),x,b,M),D=Math.tan(.5*t.fovX),N=-P[2]*D;if(C===0)return P[1]<-Math.abs(N)?z:1;let F=(-Math.abs(N)-P[1])/C,j=(Z,Y,Q)=>(1-Q)*Z+Q*Y,U=n.ay(j(1,z,F),z,1);return j(1,U,n.ay((t.pitch-20)/20,0,1))}class mu{}class $c{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,o,c){{let z=this._storage.get(o.id);if(z)return z.lastUsedFrameIdx=t,z.buf}let d=c.gl,p=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),_=new ArrayBuffer(p),x=new Int16Array(_);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(_));let b=new n.ey;for(let z=0;z<p/2;z+=3){let P=x[z],D=x[z+1],N=x[z+2];b.emplaceBack(P,D),b.emplaceBack(D,N),b.emplaceBack(N,P)}let M=c.bindVertexArrayOES.current,C=new mu;return C.buf=new ta(c,b),C.lastUsedFrameIdx=t,this._storage.set(o.id,C),c.bindVertexArrayOES.set(M),C.buf}update(t){for(let[o,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(o))}destroy(){for(let[t,o]of this._storage)o.buf.destroy(),this._storage.delete(t)}}class El{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}let wm=n.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Og{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Mn{constructor(t,o){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...o,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...o,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}let kg=n.ec([{type:"Float32",name:"a_pos_2f",components:2}]);class Zc{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,o){let c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){let _=new n.ez,x=new n.a_;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(1,1),_.emplaceBack(-1,1),x.emplaceBack(0,1,2),x.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(_,kg.members),this.vignetteIdx=t.context.createIndexBuffer(x)}let d=n.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);let _={u_vignetteShape:(p={vignetteShape:[o.start,o.range,Math.pow(10,o.fadePower)],vignetteColor:[o.color.r,o.color.g,o.color.b,o.color.a*o.strength]}).vignetteShape,u_vignetteColor:p.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,_,"vignette",this.vignetteVx,this.vignetteIdx,d)}var p}}class sr{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,o){let c=t.getFreeCameraOptions().position,d=c.toAltitude(),p=c.toLngLat(),_=n.al(p.lng),x=n.al(p.lat),b=t.pixelsPerMeter/o,M=_*n.eB,C=n.eB*Math.log(Math.tan(Math.PI/4+x/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{let z=-this._offsetYPrev+C,P=-this._elevationPrev+d;this._accumulatedOffsetX+=(-this._offsetXPrev+M)*b,this._accumulatedOffsetY+=z*b,this._accumulatedElevation+=P*b,this._offsetXPrev=M,this._offsetYPrev=C,this._elevationPrev=d}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function gi(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function np(l){let t=n.el(1323123451230),o=[];for(let c=0;c<l;++c){let d=2*t()-1,p=2*t()-1,_=2*t()-1;o.push(n.d2(d,p,_))}return o}function Zn(l,t,o,c,d){let p=n.ay((d-o)/(c-o),0,1);return(1-p)*l+p*t}class Il{constructor(t){this._movement=new sr,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Zc,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,o){let c=t.transform;this._movement.update(c,this._ppmScaleFactor);let d=c.starsProjMatrix,p=n.c3([]);n.c5(p,p,n.al(90)-c._pitch),n.c4(p,p,-c.angle);let _=n.c8(new Float32Array(16),p),x=n.eA(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),b=n.ea([],x),M=n.az([],b,_),C=Date.now()/1e3;return this._accumulatedTimeFromStart+=(C-this._prevTime)*o,this._prevTime=C,{projectionMatrix:d,modelviewMatrix:M}}}class Al extends Il{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Mn(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let c=np(this.particlesCount),d=new n.eC,p=new n.a_,_=0,x=n.el(1323123451230);for(let b=0;b<c.length;++b){let M=c[b],C=[2*x()-1,x(),x(),x()];d.emplaceBack(M[0],M[1],M[2],-1,-1,...C),d.emplaceBack(M[0],M[1],M[2],1,-1,...C),d.emplaceBack(M[0],M[1],M[2],1,1,...C),d.emplaceBack(M[0],M[1],M[2],-1,1,...C),p.emplaceBack(_+0,_+1,_+2),p.emplaceBack(_+0,_+2,_+3),_+=4}this.particlesVx=o.createVertexBuffer(d,wm.members),this.particlesIdx=o.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;let o=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(o.revealStart>c)return;let d=Zn(0,1,o.revealStart,o.revealStart+o.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;let p=structuredClone(this._params),_=[-p.direction.x,p.direction.y,-100];n.au(_,_);let x=structuredClone(this._vignetteParams);x.strength*=d,p.overrideStyleParameters||(p.intensity=t.style.rain.state.density,p.timeFactor=t.style.rain.state.intensity,p.color=structuredClone(t.style.rain.state.color),_=structuredClone(t.style.rain.state.direction),p.screenThinning.intensity=t.style.rain.state.centerThinning,p.dropletSizeX=t.style.rain.state.dropletSize[0],p.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],p.distortionStrength=100*t.style.rain.state.distortionStrength,x.strength=1,x.color=structuredClone(t.style.rain.state.vignetteColor));let b=this.updateOnRender(t,p.timeFactor),M=t.context,C=M.gl,z=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new n.T(M,{width:t.width,height:t.height,data:null},C.RGBA8)),p.distortionStrength>0&&(M.activeTexture.set(C.TEXTURE0),this.screenTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),C.copyTexSubImage2D(C.TEXTURE_2D,0,0,0,0,0,t.width,t.height));let P=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(M,P),M.activeTexture.set(C.TEXTURE0),this.screenTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE);let D=[p.color.r,p.color.g,p.color.b,p.color.a],N=(F,j)=>{let U=gi(this._movement.getPosition(),F),Z=p.dropletSizeX,Y=p.dropletSizeX*p.dropletSizeYScale,Q=t.width/2,ne=t.height/2,he=Zn(0,p.screenThinning.start,0,1,p.screenThinning.intensity),de=Zn(.001,p.screenThinning.range,0,1,p.screenThinning.intensity),oe=Zn(0,p.screenThinning.particleOffset,0,1,p.screenThinning.intensity),se=(le={modelview:b.modelviewMatrix,projection:b.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:U,velocityConeAperture:p.velocityConeAperture,velocity:p.velocity,boxSize:F,rainDropletSize:[Z,Y],distortionStrength:p.distortionStrength,rainDirection:_,color:D,screenSize:[z.width,z.height],thinningCenterPos:[Q,ne],thinningShape:[he,de,Math.pow(10,p.screenThinning.fadePower)],thinningAffectedRatio:p.screenThinning.affectedRatio,thinningParticleOffset:oe,shapeDirectionalPower:p.shapeDirPower,shapeNormalPower:p.shapeNormalPower,mode:j?0:1},{u_modelview:Float32Array.from(le.modelview),u_projection:Float32Array.from(le.projection),u_time:le.time,u_cam_pos:le.camPos,u_texScreen:0,u_velocityConeAperture:le.velocityConeAperture,u_velocity:le.velocity,u_boxSize:le.boxSize,u_rainDropletSize:le.rainDropletSize,u_distortionStrength:le.distortionStrength,u_rainDirection:le.rainDirection,u_color:le.color,u_screenSize:le.screenSize,u_thinningCenterPos:le.thinningCenterPos,u_thinningShape:le.thinningShape,u_thinningAffectedRatio:le.thinningAffectedRatio,u_thinningParticleOffset:le.thinningParticleOffset,u_shapeDirectionalPower:le.shapeDirectionalPower,u_shapeNormalPower:le.shapeNormalPower,u_mode:le.mode});var le;let Me=Math.round(p.intensity*this.particlesCount),_e=n.bd.simpleSegment(0,0,4*Me,2*Me);P.draw(t,C.TRIANGLES,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,se,"rain_particles",this.particlesVx,this.particlesIdx,_e)};p.distortionStrength>0&&N(p.boxSize,!0),N(p.boxSize,!1),this._vignette.draw(t,x)}}let Ba=n.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class op extends Il{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Mn(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let c=np(this.particlesCount),d=new n.eD,p=new n.a_,_=0,x=n.el(1323123451230);for(let b=0;b<c.length;++b){let M=c[b],C=x(),z=x(),P=x(),D=[b/c.length,C,z,P],N=[x(),x()];d.emplaceBack(M[0],M[1],M[2],-1,-1,...D,...N),d.emplaceBack(M[0],M[1],M[2],1,-1,...D,...N),d.emplaceBack(M[0],M[1],M[2],1,1,...D,...N),d.emplaceBack(M[0],M[1],M[2],-1,1,...D,...N),p.emplaceBack(_+0,_+1,_+2),p.emplaceBack(_+0,_+2,_+3),_+=4}this.particlesVx=o.createVertexBuffer(d,Ba.members),this.particlesIdx=o.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;let o=structuredClone(this._params),c=[-o.direction.x,o.direction.y,-100];n.au(c,c);let d=structuredClone(this._vignetteParams),p=o.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},_=t.transform.zoom;if(p.revealStart>_)return;let x=Zn(0,1,p.revealStart,p.revealStart+p.revealRange,_);d.strength*=x,o.overrideStyleParameters||(o.intensity=t.style.snow.state.density,o.timeFactor=t.style.snow.state.intensity,o.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),o.screenThinning.intensity=t.style.snow.state.centerThinning,o.billboardSize=2.79*t.style.snow.state.flakeSize,d.strength=1,d.color=structuredClone(t.style.snow.state.vignetteColor));let b=this.updateOnRender(t,o.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;let M=t.context,C=M.gl,z=t.transform,P=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(M,P),((D,N,F)=>{let j=gi(this._movement.getPosition(),D),U=z.width/2,Z=z.height/2,Y=Zn(0,F.screenThinning.start,0,1,F.screenThinning.intensity),Q=Zn(.001,F.screenThinning.range,0,1,F.screenThinning.intensity),ne=Zn(0,F.screenThinning.particleOffset,0,1,F.screenThinning.intensity),he=(de={modelview:b.modelviewMatrix,projection:b.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:j,velocityConeAperture:F.velocityConeAperture,velocity:F.velocity,horizontalOscillationRadius:F.horizontalOscillationRadius,horizontalOscillationRate:F.horizontalOscillationRate,boxSize:D,billboardSize:1*F.billboardSize,simpleShapeParameters:[F.shapeFadeStart,F.shapeFadePower],screenSize:[z.width,z.height],thinningCenterPos:[U,Z],thinningShape:[Y,Q,Math.pow(10,F.screenThinning.fadePower)],thinningAffectedRatio:F.screenThinning.affectedRatio,thinningParticleOffset:ne,color:[F.color.r,F.color.g,F.color.b,F.color.a],direction:c},{u_modelview:Float32Array.from(de.modelview),u_projection:Float32Array.from(de.projection),u_time:de.time,u_cam_pos:de.camPos,u_velocityConeAperture:de.velocityConeAperture,u_velocity:de.velocity,u_horizontalOscillationRadius:de.horizontalOscillationRadius,u_horizontalOscillationRate:de.horizontalOscillationRate,u_boxSize:de.boxSize,u_billboardSize:de.billboardSize,u_simpleShapeParameters:de.simpleShapeParameters,u_screenSize:de.screenSize,u_thinningCenterPos:de.thinningCenterPos,u_thinningShape:de.thinningShape,u_thinningAffectedRatio:de.thinningAffectedRatio,u_thinningParticleOffset:de.thinningParticleOffset,u_particleColor:de.color,u_direction:de.direction});var de;let oe=Math.round(F.intensity*this.particlesCount),se=n.bd.simpleSegment(0,0,4*oe,2*oe);this.particlesVx&&this.particlesIdx&&P.draw(t,C.TRIANGLES,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,he,"snow_particles",this.particlesVx,this.particlesIdx,se)})(o.boxSize,0,o),this._vignette.draw(t,d)}}let sp={symbol:function(l,t,o,c,d){if(l.renderPass!=="translucent")return;let p=Gt.disabled,_=l.colorModeForRenderPass(),x=o.layout.get("text-variable-anchor"),b=o.layout.get("text-size-scale-range"),M=n.ay(l.scaleFactor,b[0],b[1]);x&&function(P,D,N,F,j,U,Z,Y){let Q=D.transform,ne=j==="map",he=U==="map";for(let de of P){let oe=F.getTile(de),se=oe.getBucket(N);if(!se||!se.text||!se.text.segments.get().length)continue;let le=n.bH(se.textSizeData,Q.zoom,Y),Me=Ph(de,se.getProjection(),Q),_e=Q.calculatePixelsToTileUnitsMatrix(oe),Ve=Tc(Me,oe.tileID.canonical,he,ne,Q,se.getProjection(),_e),ze=se.hasIconTextFit()&&se.hasIconData();le&&pm(se,ne,he,Z,Q,Ve,de,Math.pow(2,Q.zoom-oe.tileID.overscaledZ),le,ze)}}(c,l,o,t,o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),d,M);let C=o.paint.get("icon-opacity").constantOr(1)!==0,z=o.paint.get("text-opacity").constantOr(1)!==0;o.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(C||z)?Xd(l,t,o,c,p,_):(C&&Xd(l,t,o,c,p,_,{onlyIcons:!0}),z&&Xd(l,t,o,c,p,_,{onlyText:!0})),t.map.showCollisionBoxes&&(Zd(l,t,o,c,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),!0),Zd(l,t,o,c,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,o,c){if(l.renderPass!=="translucent")return;let d=o.paint.get("circle-opacity"),p=o.paint.get("circle-stroke-width"),_=o.paint.get("circle-stroke-opacity"),x=o.layout.get("circle-sort-key").constantOr(1)!==void 0,b=o.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(p.constantOr(1)===0||_.constantOr(1)===0))return;let M=l.context,C=M.gl,z=l.transform,P=!(!l.terrain||!l.terrain.enabled),D=o.layout.get("circle-elevation-reference"),N=l.depthModeForSublayer(0,bt.ReadOnly),F=new bt(l.context.gl.LEQUAL,bt.ReadOnly,l.depthRangeFor3D),j=D==="none"||P?N:F,U=Gt.disabled,Z=l.colorModeForDrapableLayerRenderPass(b),Y=z.projection.name==="globe",Q=[n.aD(z.center.lng),n.aH(z.center.lat)],ne=[];for(let de=0;de<c.length;de++){let oe=c[de],se=t.getTile(oe),le=se.getBucket(o);if(!le||le.projection.name!==z.projection.name)continue;let Me=le.programConfigurations.get(o.id),_e=le.layoutVertexBuffer,Ve=le.globeExtVertexBuffer,ze=le.indexBuffer,je=n.dW(o),rt=[Ve],Ce=l.isTileAffectedByFog(oe);Y&&je.push("PROJECTION_GLOBE_VIEW"),je.push("DEPTH_D24"),l.terrain&&z.depthOcclusionForSymbolsAndCircles&&je.push("DEPTH_OCCLUSION"),le.hasElevation&&!l.terrain&&(je.push("ELEVATED_ROADS"),rt.push(le.elevatedLayoutVertexBuffer));let me=l.getOrCreateProgram("circle",{config:Me,defines:je,overrideFog:Ce}),ke=z.projection.createInversionMatrix(z,oe.canonical),Pe={programConfiguration:Me,program:me,layoutVertexBuffer:_e,dynamicBuffers:rt,indexBuffer:ze,uniformValues:n.dX(l,oe,se,ke,Q,o),tile:se};if(x){let $e=le.segments.get();for(let Ze of $e)ne.push({segments:new n.bd([Ze]),sortKey:Ze.sortKey,state:Pe})}else ne.push({segments:le.segments,sortKey:0,state:Pe})}x&&ne.sort((de,oe)=>de.sortKey-oe.sortKey);let he={useDepthForOcclusion:z.depthOcclusionForSymbolsAndCircles};for(let de of ne){let{programConfiguration:oe,program:se,layoutVertexBuffer:le,dynamicBuffers:Me,indexBuffer:_e,uniformValues:Ve,tile:ze}=de.state,je=de.segments;l.terrain&&l.terrain.setupElevationDraw(ze,se,he),l.uploadCommonUniforms(M,se,ze.tileID.toUnwrapped()),se.draw(l,C.TRIANGLES,j,U,Z,Nt.disabled,Ve,o.id,le,_e,je,o.paint,z.zoom,oe,Me)}},heatmap:function(l,t,o,c){if(o.paint.get("heatmap-opacity")!==0)if(l.renderPass==="offscreen"){let d=l.context,p=d.gl,_=Gt.disabled,x=new ti([p.ONE,p.ONE,p.ONE,p.ONE],n.am.transparent,[!0,!0,!0,!0]);(function(D,N,F,j){let U=D.gl,Z=N.width*j,Y=N.height*j;D.activeTexture.set(U.TEXTURE1),D.viewport.set([0,0,Z,Y]);let Q=F.heatmapFbo;if(!Q||Q&&(Q.width!==Z||Q.height!==Y)){Q&&Q.destroy();let ne=U.createTexture();U.bindTexture(U.TEXTURE_2D,ne),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_WRAP_S,U.CLAMP_TO_EDGE),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_WRAP_T,U.CLAMP_TO_EDGE),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR),Q=F.heatmapFbo=D.createFramebuffer(Z,Y,!0,null),function(he,de,oe,se,le,Me){let _e=he.gl;_e.texImage2D(_e.TEXTURE_2D,0,he.extRenderToTextureHalfFloat?_e.RGBA16F:_e.RGBA,le,Me,0,_e.RGBA,he.extRenderToTextureHalfFloat?_e.HALF_FLOAT:_e.UNSIGNED_BYTE,null),se.colorAttachment.set(oe)}(D,0,ne,Q,Z,Y)}else U.bindTexture(U.TEXTURE_2D,Q.colorAttachment.get()),D.bindFramebuffer.set(Q.framebuffer)})(d,l,o,l.transform.projection.name==="globe"?.5:.25),d.clear({color:n.am.transparent});let b=l.transform,M=b.projection.name==="globe",C=M?["PROJECTION_GLOBE_VIEW"]:[],z=M?Nt.frontCCW:Nt.disabled,P=[n.aD(b.center.lng),n.aH(b.center.lat)];for(let D=0;D<c.length;D++){let N=c[D];if(t.hasRenderableParent(N))continue;let F=t.getTile(N),j=F.getBucket(o);if(!j||j.projection.name!==b.projection.name)continue;let U=l.isTileAffectedByFog(N),Z=j.programConfigurations.get(o.id),Y=l.getOrCreateProgram("heatmap",{config:Z,defines:C,overrideFog:U}),{zoom:Q}=l.transform;l.terrain&&l.terrain.setupElevationDraw(F,Y),l.uploadCommonUniforms(d,Y,N.toUnwrapped());let ne=b.projection.createInversionMatrix(b,N.canonical);Y.draw(l,p.TRIANGLES,bt.disabled,_,x,z,am(l,N,F,ne,P,Q,o.paint.get("heatmap-intensity")),o.id,j.layoutVertexBuffer,j.indexBuffer,j.segments,o.paint,l.transform.zoom,Z,M?[j.globeExtVertexBuffer]:null)}d.viewport.set([0,0,l.width,l.height])}else l.renderPass==="translucent"&&(l.context.setColorMode(l.colorModeForRenderPass()),function(d,p){let _=d.context,x=_.gl,b=p.heatmapFbo;if(!b)return;_.activeTexture.set(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,b.colorAttachment.get()),_.activeTexture.set(x.TEXTURE1);let M=p.colorRampTexture;M||(M=p.colorRampTexture=new n.T(_,p.colorRamp,x.RGBA8)),M.bind(x.LINEAR,x.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,x.TRIANGLES,bt.disabled,Gt.disabled,d.colorModeForRenderPass(),Nt.disabled,((C,z,P,D)=>({u_image:0,u_color_ramp:1,u_opacity:z.paint.get("heatmap-opacity")}))(0,p),p.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,p.paint,d.transform.zoom)}(l,o))},line:function(l,t,o,c){if(l.renderPass!=="translucent")return;let d=o.paint.get("line-opacity"),p=o.paint.get("line-width");if(d.constantOr(1)===0||p.constantOr(1)===0)return;let _=o.paint.get("line-emissive-strength"),x=o.paint.get("line-occlusion-opacity"),b=o.layout.get("line-elevation-reference"),M=o.layout.get("line-width-unit")==="meters",C=b==="sea",z=!(!l.terrain||!l.terrain.enabled),P=l.context,D=P.gl;if(o.hasElevatedBuckets&&l.transform.projection.name==="globe")return;let N=o.layout.get("line-cross-slope"),F=N!==void 0,j=N<1,U=l.colorModeForDrapableLayerRenderPass(_),Z=l.terrain&&l.terrain.renderingToTexture,Y=Z?1:n.q.devicePixelRatio,Q=o.paint.get("line-dasharray"),ne=Q.constantOr(1),he=o.layout.get("line-cap"),de=Q.constantOr(null),oe=he.constantOr(null),se=o.paint.get("line-pattern"),le=se.constantOr(1),Me=o.paint.get("line-pattern-cross-fade"),_e=se.constantOr(null),Ve=o.paint.get("line-opacity").constantOr(1),ze=!le&&Ve!==1||l.depthOcclusion&&x>0&&x<1,je=o.paint.get("line-gradient"),rt=le?"linePattern":"line",Ce=n.dY(o),me;if(Z&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(ze=!1),x!==0&&l.depthOcclusion){let Ze=o.paint._values["line-opacity"];Ze&&Ze.value&&Ze.value.kind==="constant"?me=Ze.value:n.w(`Occlusion opacity for layer ${o.id} is supported only when line-opacity isn't data-driven.`)}p.value.kind!=="constant"&&p.value.isLineProgressConstant===!1&&Ce.push("VARIABLE_LINE_WIDTH");let ke=(Ze,Ye,ct,Mt,Ot,yt)=>{for(let zt of Ze){let Rt=t.getTile(zt);if(le&&!Rt.patternsLoaded())continue;let $t=Rt.getBucket(o);if(!$t||$t.elevationType!=="none"&&!Ot||$t.elevationType==="none"&&Ot)continue;l.prepareDrawTile();let Jt=[...Ye],ai=l.shadowRenderer,Ti=$t.elevationType==="road"&&!!ai&&ai.enabled,Yt=[0,0,0];if(Ti){let bi=l.style.directionalLight,Li=l.style.ambientLight;bi&&Li&&(Yt=Ca(l.style,bi,Li)),Jt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}let Si=$t.programConfigurations.get(o.id),Mi=!1;if(_e&&Rt.imageAtlas){let bi=n.dZ.from(_e),Li=bi.getPrimary().scaleSelf(Y).toString(),$i=Rt.imageAtlas.patternPositions.get(Li),kr=bi.getSecondary(),Dr=kr?Rt.imageAtlas.patternPositions.get(kr.scaleSelf(Y).toString()):null;Mi=!!$i&&!!Dr,$i&&Si.setConstantPatternPositions($i,Dr)}Me>0&&(Mi||Si.getPatternTransitionVertexBuffer("line-pattern"))&&Jt.push("LINE_PATTERN_TRANSITION");let Wi=l.isTileAffectedByFog(zt),ni=l.getOrCreateProgram(rt,{config:Si,defines:Jt,overrideFog:Wi});if(!le&&de&&oe&&Rt.lineAtlas){let bi=Rt.lineAtlas.getDash(de,oe);bi&&Si.setConstantPatternPositions(bi)}Ti&&ai.setupShadows(Rt.tileID.toUnwrapped(),ni,"vector-tile");let[Ei,Ii]=o.paint.get("line-trim-offset");(oe==="round"||oe==="square")&&Ei!==Ii&&(Ei===0&&(Ei-=1),Ii===1&&(Ii+=1));let Ri=Z?zt.projMatrix:null,li=M?1/$t.tileToMeter/n.aw(Rt,1,l.transform.zoom):1,Vi=M?1/$t.tileToMeter/n.aw(Rt,1,Math.floor(l.transform.zoom)):1,Ci=le?n.d_(l,Rt,o,Ri,Y,li,Vi,[Ei,Ii],Yt,Me):n.d$(l,Rt,o,Ri,$t.lineClipsArray.length,Y,li,Vi,[Ei,Ii],Yt);if(je){let bi=$t.gradients[o.id],Li=bi.texture;if(o.gradientVersion!==bi.version){let $i=256;if(o.stepInterpolant){let kr=t.getSource().maxzoom,Dr=zt.canonical.z===kr?Math.ceil(1<<l.transform.maxZoom-zt.canonical.z):1;$i=n.ay(n.e0($t.maxLineLength/n.aj*1024*Dr),256,P.maxTextureSize)}bi.gradient=n.e1({expression:o.gradientExpression(),evaluationKey:"lineProgress",resolution:$i,image:bi.gradient||void 0,clips:$t.lineClipsArray}),bi.texture?bi.texture.update(bi.gradient):bi.texture=new n.T(P,bi.gradient,D.RGBA8),bi.version=o.gradientVersion,Li=bi.texture}P.activeTexture.set(D.TEXTURE1),Li.bind(o.stepInterpolant?D.NEAREST:D.LINEAR,D.CLAMP_TO_EDGE)}ne&&(P.activeTexture.set(D.TEXTURE0),Rt.lineAtlasTexture&&Rt.lineAtlasTexture.bind(D.LINEAR,D.REPEAT),Si.updatePaintBuffers()),le&&(P.activeTexture.set(D.TEXTURE0),Rt.imageAtlasTexture&&Rt.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),Si.updatePaintBuffers()),Ot&&!C&&l.terrain.setupElevationDraw(Rt,ni),l.uploadCommonUniforms(P,ni,zt.toUnwrapped());let yr=bi=>{me!=null&&(me.value=Ve*x),ni.draw(l,D.TRIANGLES,ct,bi,U,Nt.disabled,Ci,o.id,$t.layoutVertexBuffer,$t.indexBuffer,$t.segments,o.paint,l.transform.zoom,Si,[$t.layoutVertexBuffer2,$t.patternVertexBuffer,$t.zOffsetVertexBuffer]),me!=null&&(me.value=Ve)};if(ze&&!Ot){let bi=l.stencilModeForClipping(zt).ref;bi===0&&Z&&P.clear({stencil:0});let Li={func:D.EQUAL,mask:255};Ci.u_alpha_discard_threshold=.8,yr(new Gt(Li,bi,255,D.KEEP,D.KEEP,D.INVERT)),Ci.u_alpha_discard_threshold=0,yr(new Gt(Li,bi,255,D.KEEP,D.KEEP,D.KEEP))}else Ci.u_alpha_discard_threshold=ze&&Ot&&yt?.8:0,yr(Ot?Mt:l.stencilModeForClipping(zt))}},Pe=l.depthModeForSublayer(0,bt.ReadOnly),$e=new bt(l.depthOcclusion?D.GREATER:D.LEQUAL,bt.ReadOnly,l.depthRangeFor3D);if(o.hasNonElevatedBuckets){let Ze=!Z&&l.terrain;x!==0&&Ze?n.w(`Occlusion opacity for layer ${o.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ze?n.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${o.id}.`):ke(c,Ce,Pe,Gt.disabled,!1,!0)}if(o.hasElevatedBuckets){b==="hd-road-markup"?z||(Pe=$e,Ce.push("ELEVATED_ROADS")):(Ce.push("ELEVATED"),Pe=$e,F&&Ce.push(j?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),C&&Ce.push("ELEVATION_REFERENCE_SEA"));let Ze=ze?l.stencilModeFor3D():Gt.disabled;l.forceTerrainMode=!0,ke(c,Ce,Pe,Ze,!0,!0),ze&&ke(c,Ce,Pe,Ze,!0,!1),l.forceTerrainMode=!1}ze&&(l.resetStencilClippingMasks(),Z&&P.clear({stencil:0})),x===0||l.depthOcclusion||Z||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,o,c){let d=o.paint.get("fill-color"),p=o.paint.get("fill-opacity");if(p.constantOr(1)===0)return;let _=o.paint.get("fill-emissive-strength"),x=l.colorModeForDrapableLayerRenderPass(_),b=o.paint.get("fill-pattern"),M=l.opaquePassEnabledForLayer()&&!b.constantOr(1)&&d.constantOr(n.am.transparent).a===1&&p.constantOr(0)===1?"opaque":"translucent",C="none";o.layout.get("fill-elevation-reference")!=="none"?C="road":o.paint.get("fill-z-offset").constantOr(1)!==0&&(C="offset");let z=!(!l.terrain||!l.terrain.enabled),P={painter:l,sourceCache:t,layer:o,coords:c,colorMode:x,elevationType:C,terrainEnabled:z,pass:M};if(l.renderPass!=="shadow")if(C!=="offset"){if(lu(P,!1),C==="road"){let D=!z&&l.renderPass==="translucent";D&&Tt(l,t,o,c,"geometry"),lu(P,!0,Gt.disabled),D&&function(N){let{painter:F,sourceCache:j,layer:U,coords:Z,colorMode:Y}=N,Q=F.context.gl,ne=N.painter.shadowRenderer,he=!!ne&&ne.enabled,de=new bt(F.context.gl.LEQUAL,bt.ReadOnly,F.depthRangeFor3D),oe=[0,0,0];if(he){let le=F.style.directionalLight,Me=F.style.ambientLight;le&&Me&&(oe=Ca(F.style,le,Me))}let se=le=>{for(let Me of Z){let _e=j.getTile(Me),Ve=_e.getBucket(U);if(!Ve)continue;let ze=Ve.elevatedStructures;if(!ze)continue;let je,rt;if(le?(je=ze.renderableBridgeSegments,rt=ze.bridgeProgramConfigurations.get(U.id)):(je=ze.renderableTunnelSegments,rt=ze.tunnelProgramConfigurations.get(U.id)),!je||je.segments[0].primitiveLength===0)continue;rt.updatePaintBuffers(),F.prepareDrawTile();let Ce=F.isTileAffectedByFog(Me),me=[];he&&me.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");let ke=F.getOrCreateProgram("elevatedStructures",{config:rt,overrideFog:Ce,defines:me}),Pe=F.translatePosMatrix(Me.projMatrix,_e,U.paint.get("fill-translate"),U.paint.get("fill-translate-anchor"));he&&ne.setupShadows(_e.tileID.toUnwrapped(),ke,"vector-tile");let $e=Cg(Pe,oe);F.uploadCommonUniforms(F.context,ke,Me.toUnwrapped()),ke.draw(F,Q.TRIANGLES,de,Gt.disabled,Y,Nt.backCCW,$e,U.id,ze.vertexBuffer,ze.indexBuffer,je,U.paint,F.transform.zoom,rt,[ze.vertexBufferNormal])}};se(!0),se(!1)}(P)}}else lu(P,!1,l.stencilModeFor3D());else l.shadowRenderer&&C==="road"&&!z&&function(D){let{painter:N,sourceCache:F,layer:j,coords:U}=D,Z=N.context.gl,Y=D.painter.shadowRenderer;for(let Q of U){let ne=F.getTile(Q),he=ne.getBucket(j);if(!he)continue;let de=he.elevatedStructures;if(!de||!de.shadowCasterSegments||de.shadowCasterSegments.segments[0].primitiveLength===0)continue;N.prepareDrawTile();let oe=he.bufferData.programConfigurations.get(j.id),se=N.isTileAffectedByFog(Q),le=N.getOrCreateProgram("elevatedStructuresDepth",{config:oe,overrideFog:se}),Me=Y.calculateShadowPassMatrixFromTile(ne.tileID.toUnwrapped());N.uploadCommonUniforms(N.context,le,Q.toUnwrapped());let _e={u_matrix:Me,u_depth_bias:0};le.draw(N,Z.TRIANGLES,Y.getShadowPassDepthMode(),Gt.disabled,Y.getShadowPassColorMode(),Nt.disabled,_e,j.id,de.vertexBuffer,de.indexBuffer,de.shadowCasterSegments,j.paint,N.transform.zoom,oe)}}(P)},"fill-extrusion":function(l,t,o,c){let d=o.paint.get("fill-extrusion-opacity"),p=l.context,_=p.gl,x=l.terrain,b=x&&x.renderingToTexture;if(d===0)return;let M=l.conflationActive&&l.style.isLayerClipped(o,t.getSource()),C=l.style.order.indexOf(o.fqid);if(M&&function(z,P,D,N,F){for(let j of N){let U=P.getTile(j).getBucket(D);U&&(U.updateReplacement(j,z.replacementSource,F),U.uploadCentroid(z.context))}}(l,t,o,c,C),x||M)for(let z of c){let P=t.getTile(z).getBucket(o);P&&Ut(l.context,t,z,P,o,x,M)}if(l.renderPass==="shadow"&&l.shadowRenderer){let z=l.shadowRenderer;if(x&&d<.65&&o._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof n.ab)return;let P=z.getShadowPassDepthMode(),D=z.getShadowPassColorMode();Uc(l,t,o,c,P,Gt.disabled,D,M)}else if(l.renderPass==="translucent"){let z=!o.paint.get("fill-extrusion-pattern").constantOr(1),P=o.paint.get("fill-extrusion-color").constantOr(n.am.white);if(!b&&P.a!==0){let D=new bt(l.context.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D);d===1&&z?Uc(l,t,o,c,D,Gt.disabled,ti.unblended,M):(Uc(l,t,o,c,D,Gt.disabled,ti.disabled,M),Uc(l,t,o,c,D,l.stencilModeFor3D(),l.colorModeForRenderPass(),M),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&z&&(!x&&l.transform.projection.name!=="globe"||b)){let D=o.paint.get("fill-extrusion-opacity"),N=o.paint.get("fill-extrusion-ambient-occlusion-intensity"),F=o.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),j=o.paint.get("fill-extrusion-flood-light-intensity"),U=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Z=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(U?null:o.lut).toArray01().slice(0,3),Y=N>0&&F>0,Q=j>0,ne=(oe,se,le)=>(1-le)*oe+le*se,he=new Rs;he.translate=o.paint.get("fill-extrusion-translate"),he.translateAnchor=o.paint.get("fill-extrusion-translate-anchor"),he.edgeRadius=o.layout.get("fill-extrusion-edge-radius"),he.cutoffFadeRange=o.paint.get("fill-extrusion-cutoff-fade-range");let de=oe=>{let se=l.depthModeForSublayer(1,bt.ReadOnly,_.LEQUAL,!0),le=o.paint.get(oe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Me=ne(.1,3,le),_e=l._showOverdrawInspector;if(!_e){let Ve=new Gt({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),ze=new ti([_.ONE,_.ONE,_.ONE,_.ONE],n.am.transparent,[!1,!1,!1,!0],_.MIN);$n(he,l,t,o,c,se,Ve,ze,Nt.disabled,oe,"sdf",D,N,F,j,Z,Me,M,!1)}{let Ve=_e?Gt.disabled:new Gt({func:_.EQUAL,mask:255},255,255,_.KEEP,_.DECR,_.DECR),ze=_e?l.colorModeForRenderPass():new ti([_.ONE_MINUS_DST_ALPHA,_.DST_ALPHA,_.ONE,_.ONE],n.am.transparent,[!0,!0,!0,!0]);$n(he,l,t,o,c,se,Ve,ze,Nt.disabled,oe,"color",D,N,F,j,Z,Me,M,!1)}};if(b){let oe=(se,le,Me)=>{let _e=l.depthModeForSublayer(1,bt.ReadOnly,_.LEQUAL,!1),Ve=o.paint.get(se?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ze=ne(.1,3,Ve);{let je=new ti([_.ONE,_.ONE,_.ONE,_.ONE],n.am.transparent,[!1,!1,!1,!0]);$n(he,l,t,o,c,_e,Gt.disabled,je,Nt.disabled,se,"clear",D,N,F,j,Z,ze,M,le)}{let je=new Gt({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),rt=new ti([_.ONE,_.ONE,_.ONE,_.ONE],n.am.transparent,[!1,!1,!1,!0],_.MIN);$n(he,l,t,o,c,_e,je,rt,Nt.disabled,se,"sdf",D,N,F,j,Z,ze,M,le)}{let je=se?_.ZERO:_.ONE_MINUS_DST_ALPHA,rt=new Gt({func:_.EQUAL,mask:255},255,255,_.KEEP,_.DECR,_.DECR),Ce=new ti([je,_.DST_ALPHA,_.ONE_MINUS_DST_ALPHA,_.ZERO],n.am.transparent,[!0,!0,!0,!0]);$n(he,l,t,o,c,_e,rt,Ce,Nt.disabled,se,"color",D,N,F,j,Z,ze,M,le)}{let je=new ti([_.ONE,_.ONE,_.ONE,se?_.ZERO:_.ONE],n.am.transparent,[!1,!1,!1,!0],se?_.FUNC_ADD:_.MAX);$n(he,l,t,o,c,_e,Gt.disabled,je,Nt.disabled,se,"clear",D,N,F,j,Z,ze,M,le,Me)}};if(Y||Q){let se;if(l.prepareDrawTile(),x){let le=x.drapeBufferSize[0],Me=x.drapeBufferSize[1];se=x.framebufferCopyTexture,se&&(!se||se.size[0]===le&&se.size[1]===Me)||(se&&se.destroy(),se=x.framebufferCopyTexture=new n.T(p,new n.r({width:le,height:Me}),_.RGBA8)),se.bind(_.LINEAR,_.CLAMP_TO_EDGE),_.copyTexSubImage2D(_.TEXTURE_2D,0,0,0,0,0,le,Me)}Y&&oe(!0,!1,se),Q&&oe(!1,!0,se)}}else Y&&de(!0),Q&&de(!1),(Y||Q)&&l.resetStencilClippingMasks()}}},building:function(l,t,o,c){l.currentLayer<l.firstLightBeamLayer&&(l.firstLightBeamLayer=l.currentLayer);let d=o.paint.get("building-ambient-occlusion-ground-intensity"),p=o.paint.get("building-ambient-occlusion-ground-radius"),_=o.paint.get("building-ambient-occlusion-ground-attenuation"),x=d>0&&p>0,b=!0,M=o.paint.get("building-vertical-scale");M<1&&(b=!1);let C=l.conflationActive&&l.style.isLayerClipped(o,t.getSource()),z=l.style.order.indexOf(o.fqid);if(function(P,D,N,F,j,U){for(let Z of U){let Y=D.getTile(Z).getBucket(N);Y&&(j&&Y.updateReplacement(Z,P.replacementSource,F),Y.uploadUpdatedIndexBuffer(P.context))}}(l,t,o,z,C,c),function(P,D,N,F){for(let j of F){let U=D.getTile(j).getBucket(N);U&&U.needsEvaluation(P,N)&&(U.evaluate(N),U.uploadUpdatedColorBuffer(P.context))}}(l,t,o,c),o.resetLayerRenderingStats(l),l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0),l.renderPass==="shadow"&&l.shadowRenderer){let P=l.shadowRenderer,D=[],N=P.getShadowPassDepthMode();hu({painter:l,source:t,layer:o,coords:c,defines:D,blendMode:P.getShadowPassColorMode(),depthMode:N,verticalScale:M})}else if(l.renderPass==="translucent"){x&&function(F,j,U,Z,Y,Q,ne,he,de,oe,se,le,Me){let _e=F.context.gl,Ve=F.depthModeForSublayer(1,bt.ReadOnly,_e.LEQUAL,!0),ze=.1*(1-(je=se))+3*je;var je;let rt=F._showOverdrawInspector,Ce=le,me=new Rs;rt||$n(me,F,j,U,Z,Ve,new Gt({func:_e.ALWAYS,mask:255},255,255,_e.KEEP,_e.KEEP,_e.REPLACE),new ti([_e.ONE,_e.ONE,_e.ONE,_e.ONE],n.am.transparent,[!1,!1,!1,!0],_e.MIN),Nt.disabled,Y,"sdf",1,ne,he,0,oe,ze,Ce,!1);{let ke=rt?Gt.disabled:new Gt({func:_e.EQUAL,mask:255},255,255,_e.KEEP,_e.DECR,_e.DECR),Pe=rt?F.colorModeForRenderPass():new ti([_e.ONE_MINUS_DST_ALPHA,_e.DST_ALPHA,_e.ONE,_e.ONE],n.am.transparent,[!0,!0,!0,!0]);$n(me,F,j,U,Z,Ve,ke,Pe,Nt.disabled,Y,"color",1,ne,he,0,oe,ze,Ce,!1)}}(l,t,o,c,!0,0,d,p,0,[0,0,0],_,C);let P=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];b&&(P=P.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),l.shadowRenderer.useNormalOffset&&(P=P.concat("NORMAL_OFFSET"));let D=new bt(l.context.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),N=l.colorModeForRenderPass();hu({painter:l,source:t,layer:o,coords:c,defines:P,blendMode:N,depthMode:D,verticalScale:M})}else if(l.renderPass==="light-beam"){let P=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],D=new bt(l.context.gl.LEQUAL,bt.ReadOnly,l.depthRangeFor3D);hu({painter:l,source:t,layer:o,coords:c,defines:P,blendMode:ti.alphaBlended,depthMode:D,verticalScale:M})}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1),l.resetStencilClippingMasks()},hillshade:function(l,t,o,c){if(l.renderPass!=="offscreen"&&l.renderPass!=="translucent"||l.style.disableElevatedTerrain)return;let d=l.context,p=l.terrain&&l.terrain.renderingToTexture,[_,x]=l.renderPass!=="translucent"||p?[{},c]:l.stencilConfigForOverlap(c);for(let b of x){let M=t.getTile(b);if(M.needsHillshadePrepare&&l.renderPass==="offscreen")Hf(l,M,o);else if(l.renderPass==="translucent"){let C=l.depthModeForSublayer(0,bt.ReadOnly),z=o.paint.get("hillshade-emissive-strength"),P=l.colorModeForDrapableLayerRenderPass(z),D=p&&l.terrain?l.terrain.stencilModeForRTTOverlap(b):_[b.overscaledZ];xg(l,b,M,o,C,D,P)}}d.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,o,c,d,p){if(l.renderPass!=="translucent"||o.paint.get("raster-opacity")===0)return;let _=l.transform.projection.name==="globe",x=o.paint.get("raster-elevation")!==0,b=x&&_;if(l.renderElevatedRasterBackface&&!b)return;let M=l.context,C=M.gl,z=t.getSource(),P=function(he,de,oe,se){let le=de.paint.get("raster-color"),Me=he.type==="raster-array",_e=[],Ve=de.paint.get("raster-resampling"),ze=de.paint.get("raster-color-mix"),je=de.paint.get("raster-color-range"),rt=[ze[0],ze[1],ze[2],0],Ce=ze[3],me=Ve==="nearest"?se.NEAREST:se.LINEAR;if(Me&&(_e.push("RASTER_ARRAY"),le||_e.push("RASTER_COLOR"),Ve==="linear"&&_e.push("RASTER_ARRAY_LINEAR"),me=se.NEAREST,!je&&he.rasterLayers)){let ke=he.rasterLayers.find(({id:Pe})=>Pe===de.sourceLayer);ke&&ke.fields&&ke.fields.range&&(je=ke.fields.range)}if(je=je||[0,1],le){_e.push("RASTER_COLOR"),oe.activeTexture.set(se.TEXTURE2),de.updateColorRamp(je);let ke=de.colorRampTexture;ke||(ke=de.colorRampTexture=new n.T(oe,de.colorRamp,se.RGBA8)),ke.bind(se.LINEAR,se.CLAMP_TO_EDGE)}return{mix:rt,range:je,offset:Ce,defines:_e,resampling:me}}(z,o,M,C);if(z instanceof n.aP&&!c.length&&!_)return;let D=o.paint.get("raster-emissive-strength"),N=l.colorModeForDrapableLayerRenderPass(D),F=l.terrain&&l.terrain.renderingToTexture,j=!l.options.moving,U=o.paint.get("raster-resampling")==="nearest"?C.NEAREST:C.LINEAR;if(z instanceof n.aP&&!c.length&&(z.onNorthPole||z.onSouthPole)){let he=x?l.stencilModeFor3D():Gt.disabled;return void uu(!!z.onNorthPole,null,l,t,o,D,P,Nt.disabled,he)}if(!c.length)return;let[Z,Y]=z instanceof n.aP||F?[{},c]:l.stencilConfigForOverlap(c),Q=Y[Y.length-1].overscaledZ;b&&P.defines.push("PROJECTION_GLOBE_VIEW"),x&&P.defines.push("RENDER_CUTOFF");let ne=(he,de,oe)=>{for(let se of he){let le=se.toUnwrapped(),Me=t.getTile(se);if(F&&(!Me||!Me.hasData()))continue;M.activeTexture.set(C.TEXTURE0);let _e=zg(Me,z,o,P);if(!_e||!_e.texture)continue;let{texture:Ve,mix:ze,offset:je,tileSize:rt,buffer:Ce}=_e,me,ke;F?(me=bt.disabled,ke=se.projMatrix):x?(me=new bt(C.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),ke=_?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(le,j)):(me=l.depthModeForSublayer(se.overscaledZ-Q,o.paint.get("raster-opacity")===1?bt.ReadWrite:bt.ReadOnly,C.LESS),ke=l.transform.calculateProjMatrix(le,j));let Pe=l.terrain&&F?l.terrain.stencilModeForRTTOverlap(se):Z[se.overscaledZ],$e=p?0:o.paint.get("raster-fade-duration");Me.registerFadeDuration($e);let Ze=t.findLoadedParent(se,0),Ye=Hn(Me,Ze,t,l.transform,$e),ct,Mt;l.terrain&&l.terrain.prepareDrawTile(),M.activeTexture.set(C.TEXTURE0),Ve.bind(U,C.CLAMP_TO_EDGE),M.activeTexture.set(C.TEXTURE1),Ze?(Ze.texture&&Ze.texture.bind(U,C.CLAMP_TO_EDGE),ct=Math.pow(2,Ze.tileID.overscaledZ-Me.tileID.overscaledZ),Mt=[Me.tileID.canonical.x*ct%1,Me.tileID.canonical.y*ct%1]):Ve.bind(U,C.CLAMP_TO_EDGE),"useMipmap"in Ve&&M.extTextureFilterAnisotropic&&l.transform.pitch>20&&C.texParameterf(C.TEXTURE_2D,M.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,M.extTextureFilterAnisotropicMax);let Ot=l.transform,yt,zt=x?Lg(Ot):[0,0,0,0],Rt,$t,Jt,ai,Ti,Yt=0;if(b&&z instanceof n.aP&&z.coordinates.length>3)Rt=Float32Array.from(n.bh(n.dD(new n.cA(0,0,0)))),$t=Float32Array.from(Ot.globeMatrix),Jt=Float32Array.from(n.dz(Ot)),ai=[n.aD(Ot.center.lng),n.aH(Ot.center.lat)],yt=z.elevatedGlobePerspectiveTransform,Ti=z.elevatedGlobeGridMatrix||new Float32Array(9);else if(b){let ni=n.dA(se.canonical);Yt=n.dB(ni.getCenter().lat),Rt=Float32Array.from(n.bh(n.dD(se.canonical))),$t=Float32Array.from(Ot.globeMatrix),Jt=Float32Array.from(n.dz(Ot)),ai=[n.aD(Ot.center.lng),n.aH(Ot.center.lat)],yt=[0,0],Ti=Float32Array.from(n.dC(se.canonical,ni,Yt,Ot.worldSize/Ot._pixelsPerMercatorPixel))}else yt=z instanceof n.aP?z.perspectiveTransform:[0,0],Rt=new Float32Array(16),$t=new Float32Array(9),Jt=new Float32Array(16),ai=[0,0],Ti=new Float32Array(9);let Si=jd(ke,Rt,$t,Jt,Ti,Mt||[0,0],n.ah(l.transform.zoom),ai,zt,ct||1,Ye,o,yt,x?o.paint.get("raster-elevation"):0,2,ze,je,P.range,rt,Ce,D),Mi=l.isTileAffectedByFog(se),Wi=l.getOrCreateProgram("raster",{defines:P.defines,overrideFog:Mi});if(l.uploadCommonUniforms(M,Wi,le),z instanceof n.aP){let ni=z.elevatedGlobeVertexBuffer,Ei=z.elevatedGlobeIndexBuffer;if(F||!_)z.boundsBuffer&&z.boundsSegments&&Wi.draw(l,C.TRIANGLES,me,Gt.disabled,N,Nt.disabled,Si,o.id,z.boundsBuffer,l.quadTriangleIndexBuffer,z.boundsSegments);else if(ni&&Ei){let Ii=Ot.zoom<=n.cX?z.elevatedGlobeSegments:z.getSegmentsForLongitude(Ot.center.lng);Ii&&Wi.draw(l,C.TRIANGLES,me,Gt.disabled,N,de,Si,o.id,ni,Ei,Ii)}}else if(b){me=new bt(C.LEQUAL,bt.ReadOnly,l.depthRangeFor3D);let ni=l.globeSharedBuffers;if(ni){let[Ei,Ii,Ri]=ni.getGridBuffers(Yt,!1);Wi.draw(l,C.TRIANGLES,me,oe||Pe,l.colorModeForRenderPass(),de,Si,o.id,Ei,Ii,Ri)}}else{let{tileBoundsBuffer:ni,tileBoundsIndexBuffer:Ei,tileBoundsSegments:Ii}=l.getTileBoundsBuffers(Me);Wi.draw(l,C.TRIANGLES,me,Pe,N,Nt.disabled,Si,o.id,ni,Ei,Ii)}}if(!(z instanceof n.aP)&&b)for(let se of he){let le=se.canonical.y===(1<<se.canonical.z)-1;se.canonical.y===0&&uu(!0,se,l,t,o,D,P,de,oe||Gt.disabled),le&&uu(!1,se,l,t,o,D,P,de===Nt.frontCW?Nt.backCW:Nt.frontCW,oe||Gt.disabled)}};b?ne(Y,l.renderElevatedRasterBackface?Nt.backCW:Nt.frontCW,l.stencilModeFor3D()):ne(Y,Nt.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,o,c,d,p){l.renderPass==="offscreen"&&function(_,x,b,M){if(!M.length)return;let C=_.context,z=C.gl,P=x.getSource();if(!(P instanceof Gs))return;let D=Math.ceil(Math.sqrt(b.paint.get("raster-particle-count"))),N=b.particlePositionRGBAImage;if(!N||N.width!==D){let Y=function(Q){let ne=Q*Q,he=new Uint8Array(4*ne),de=function(se){return se|=0,se=Math.imul(2747636419^se,2654435769),se=Math.imul(se^se>>>16,2654435769),((se=Math.imul(se^se>>>16,2654435769))>>>0)/4294967296},oe=1/1.1;for(let se=0;se<ne;se++){let le=oe*(de(2*se+0)+ea),Me=oe*(de(2*se+1)+ea),_e=255*le%1,Ve=255*Me%1,ze=_e,je=Me-Ve/255,rt=Ve;he[4*se+0]=255*(le-_e/255),he[4*se+1]=255*ze,he[4*se+2]=255*je,he[4*se+3]=255*rt}return he}(D);N=b.particlePositionRGBAImage=new n.r({width:D,height:D},Y)}let F=b.particleFramebuffer;F?F.width!==D&&(F.destroy(),F=b.particleFramebuffer=C.createFramebuffer(D,D,!0,null)):F=b.particleFramebuffer=C.createFramebuffer(D,D,!0,null);let j=[];for(let Y of M){let Q=x.getTile(Y);if(!(Q instanceof tl))continue;let ne=Dn(Q,P,b);if(!ne)continue;let he=[Q.tileSize,Q.tileSize],de=b.tileFramebuffer;de||(de=b.tileFramebuffer=C.createFramebuffer(he[0],he[1],!0,null));let oe=Q.rasterParticleState;oe||(oe=Q.rasterParticleState=new Kd(C,Y,he,N));let se=oe.update(b.lastInvalidatedAt);oe.particleTextureDimension!==D&&oe.updateParticleTexture(Y,N);let le=oe.targetColorTexture;oe.targetColorTexture=oe.backgroundColorTexture,oe.backgroundColorTexture=le;let Me=oe.particleTexture0;oe.particleTexture0=oe.particleTexture1,oe.particleTexture1=Me,j.push([Y,ne,oe,se])}if(j.length===0)return;let U=n.q.now(),Z=b.previousDrawTimestamp?.001*(U-b.previousDrawTimestamp):.0167;if(b.previousDrawTimestamp=U,b.hasColorMap()){C.activeTexture.set(z.TEXTURE0+2);let Y=b.colorRampTexture;Y||(Y=b.colorRampTexture=new n.T(C,b.colorRamp,z.RGBA8)),Y.bind(z.LINEAR,z.CLAMP_TO_EDGE)}C.bindFramebuffer.set(b.tileFramebuffer.framebuffer),function(Y,Q,ne){let he=Y.context,de=he.gl,oe=Q.tileFramebuffer;he.activeTexture.set(de.TEXTURE0);let se={u_texture:0,u_opacity:1.05*(Me=Q.paint.get("raster-particle-fade-opacity-factor"))/(Me+.05)},le=Y.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Me;for(let _e of ne){let[,,Ve,ze]=_e;oe.colorAttachment.set(Ve.targetColorTexture.texture),he.viewport.set([0,0,oe.width,oe.height]),he.clear({color:n.am.transparent}),ze&&(Ve.backgroundColorTexture.bind(de.NEAREST,de.CLAMP_TO_EDGE),le.draw(Y,de.TRIANGLES,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,se,Q.id,Y.viewportBuffer,Y.quadTriangleIndexBuffer,Y.viewportSegments))}}(_,b,j),function(Y,Q,ne,he){let de=Y.context,oe=de.gl,se=ne.tileFramebuffer,le=Y.transform.projection.name==="globe",Me=ne.paint.get("raster-particle-max-speed");for(let _e of he){let[Ve,ze,je]=_e;de.activeTexture.set(oe.TEXTURE0+0),ze.texture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE),se.colorAttachment.set(je.targetColorTexture.texture);let rt=Y.getOrCreateProgram("rasterParticleDraw",{defines:ze.defines,overrideFog:!1});de.activeTexture.set(oe.TEXTURE0+1);let Ce=ze.scalarData?[]:[0,1,2,3].map(Pe=>n.e3[Pe](Ve));Ce.push(Ve);let me=Ve.canonical.x,ke=Ve.canonical.y;for(let Pe of Ce){let $e=Q.getTile(le?Pe.wrapped():Pe);if(!$e)continue;let Ze=$e.rasterParticleState;if(!Ze)continue;let Ye=Pe.canonical.x+(1<<Pe.canonical.z)*(Pe.wrap-Ve.wrap),ct=Pe.canonical.y;Ze.particleTexture0.bind(oe.NEAREST,oe.CLAMP_TO_EDGE);let Mt=lm(1,Ze.particleTexture0.size[0],[Ye-me,ct-ke],0,ze.texture.size,2,Me,ze.textureOffset,ze.scale,ze.offset);rt.draw(Y,oe.POINTS,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,Mt,ne.id,Ze.particleIndexBuffer,void 0,Ze.particleSegment)}}}(_,x,b,j),C.bindFramebuffer.set(b.particleFramebuffer.framebuffer),function(Y,Q,ne,he){let de=Y.context,oe=de.gl,se=Q.paint.get("raster-particle-max-speed"),le=he*Q.paint.get("raster-particle-speed-factor")*.15,Me=function(Ve){return Math.pow(Ve,6)}(.01+1*Q.paint.get("raster-particle-reset-rate-factor")),_e=Q.particleFramebuffer;de.viewport.set([0,0,_e.width,_e.height]);for(let Ve of ne){let[,ze,je]=Ve;de.activeTexture.set(oe.TEXTURE0+0),ze.texture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE),de.activeTexture.set(oe.TEXTURE0+1);let rt=je.particleTexture0;rt.bind(oe.NEAREST,oe.CLAMP_TO_EDGE);let Ce=cm(1,rt.size[0],0,ze.texture.size,se,le,Me,ze.textureOffset,ze.scale,ze.offset);_e.colorAttachment.set(je.particleTexture1.texture),de.clear({color:n.am.transparent}),Y.getOrCreateProgram("rasterParticleUpdate",{defines:ze.defines}).draw(Y,oe.TRIANGLES,bt.disabled,Gt.disabled,ti.unblended,Nt.disabled,Ce,Q.id,Y.viewportBuffer,Y.quadTriangleIndexBuffer,Y.viewportSegments)}}(_,b,j,Z)}(l,t,o,c),l.renderPass==="translucent"&&(function(_,x,b,M,C){let z=_.context,P=z.gl,D=x.getSource().tileSize,N=5*(1-n.af(n.cI,n.cI+1,_.transform.zoom))*D+b.paint.get("raster-particle-elevation"),F=!_.options.moving,j=_.transform.projection.name==="globe";if(!M.length)return;let[U,Z]=_.stencilConfigForOverlap(M),Y=[];j&&Y.push("PROJECTION_GLOBE_VIEW");let Q=_.stencilModeFor3D();for(let ne of Z){let he=ne.toUnwrapped(),de=x.getTile(ne);if(!de.rasterParticleState)continue;let oe=de.rasterParticleState,se=100;de.registerFadeDuration(se);let le=x.findLoadedParent(ne,0),Me=Hn(de,le,x,_.transform,se),_e,Ve;_.terrain&&_.terrain.prepareDrawTile(),z.activeTexture.set(P.TEXTURE0),oe.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),z.activeTexture.set(P.TEXTURE1),le&&le.rasterParticleState?(le.rasterParticleState.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),_e=Math.pow(2,le.tileID.overscaledZ-de.tileID.overscaledZ),Ve=[de.tileID.canonical.x*_e%1,de.tileID.canonical.y*_e%1]):oe.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE);let ze=j?Float32Array.from(_.transform.expandedFarZProjMatrix):_.transform.calculateProjMatrix(he,F),je=_.transform,rt=na(je),Ce=n.dA(ne.canonical),me=n.dB(Ce.getCenter().lat),ke,Pe,$e,Ze,Ye;j?(ke=Float32Array.from(n.bh(n.dD(ne.canonical))),Pe=Float32Array.from(je.globeMatrix),$e=Float32Array.from(n.dz(je)),Ze=[n.aD(je.center.lng),n.aH(je.center.lat)],Ye=Float32Array.from(n.dC(ne.canonical,Ce,me,je.worldSize/je._pixelsPerMercatorPixel))):(ke=new Float32Array(16),Pe=new Float32Array(9),$e=new Float32Array(16),Ze=[0,0],Ye=new Float32Array(9));let ct=nu(ze,ke,Pe,$e,Ye,Ve||[0,0],n.ah(_.transform.zoom),Ze,rt,_e||1,Me,N),Mt=_.isTileAffectedByFog(ne),Ot=_.getOrCreateProgram("rasterParticle",{defines:Y,overrideFog:Mt});if(_.uploadCommonUniforms(z,Ot,he),j){let yt=new bt(P.LEQUAL,bt.ReadOnly,_.depthRangeFor3D),zt=0,Rt=_.globeSharedBuffers;if(Rt){let[$t,Jt,ai]=Rt.getGridBuffers(me,zt!==0);Ot.draw(_,P.TRIANGLES,yt,Q,ti.alphaBlended,_.renderElevatedRasterBackface?Nt.frontCCW:Nt.backCCW,ct,b.id,$t,Jt,ai)}}else{let yt=_.depthModeForSublayer(0,bt.ReadOnly),zt=U[ne.overscaledZ],{tileBoundsBuffer:Rt,tileBoundsIndexBuffer:$t,tileBoundsSegments:Jt}=_.getTileBoundsBuffers(de);Ot.draw(_,P.TRIANGLES,yt,zt,ti.alphaBlended,Nt.disabled,ct,b.id,Rt,$t,Jt)}}_.resetStencilClippingMasks()}(l,t,o,c),l.style.map.triggerRepaint())},background:function(l,t,o,c){let d=o.paint.get("background-color"),p=o.paint.get("background-color-use-theme").constantOr("default")==="none",_=o.paint.get("background-opacity"),x=o.paint.get("background-emissive-strength"),b=o.paint.get("background-pitch-alignment")==="viewport";if(_===0)return;let M=l.context,C=M.gl,z=l.transform,P=z.tileSize,D=o.paint.get("background-pattern"),N;if(D!==void 0&&(D===null||(N=l.imageManager.getPattern(n.I.from(D.toString()),o.scope,l.style.getLut(o.scope)),!N)))return;let F=!D&&d.a===1&&_===1&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==F)return;let j=Gt.disabled,U=l.depthModeForSublayer(0,F==="opaque"?bt.ReadWrite:bt.ReadOnly),Z=l.colorModeForDrapableLayerRenderPass(x),Y=D?"backgroundPattern":"background",Q,ne=c;if(ne||(Q=l.getBackgroundTiles(),ne=Object.values(Q).map(he=>he.tileID)),D&&(M.activeTexture.set(C.TEXTURE0),l.imageManager.bind(l.context,o.scope)),b){let he=l.getOrCreateProgram(Y,{overrideFog:!1,overrideRtt:!0}),de=new Float32Array(n.bx([])),oe=new n.aM(0,0,0,0,0),se=D?Gd(de,x,_,l,0,o.scope,N,b,{tileID:oe,tileSize:P}):hm(de,x,_,d.toPremultipliedRenderColor(p?null:o.lut));he.draw(l,C.TRIANGLES,U,j,Z,Nt.disabled,se,o.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(let he of ne){let de=l.isTileAffectedByFog(he),oe=l.getOrCreateProgram(Y,{overrideFog:de}),se=he.toUnwrapped(),le=c?he.projMatrix:l.transform.calculateProjMatrix(se);l.prepareDrawTile();let Me=t?t.getTile(he):Q?Q[he.key]:new wa(he,P,z.zoom,l),_e=D?Gd(le,x,_,l,0,o.scope,N,b,{tileID:he,tileSize:P}):hm(le,x,_,d.toPremultipliedRenderColor(p?null:o.lut));l.uploadCommonUniforms(M,oe,se);let{tileBoundsBuffer:Ve,tileBoundsIndexBuffer:ze,tileBoundsSegments:je}=l.getTileBoundsBuffers(Me);oe.draw(l,C.TRIANGLES,U,j,Z,Nt.disabled,_e,o.id,Ve,ze,je)}},sky:function(l,t,o){let c=l._atmosphere?n.ah(l.transform.zoom):1,d=o.paint.get("sky-opacity")*c;if(d===0)return;let p=l.context,_=o.paint.get("sky-type"),x=new bt(p.gl.LEQUAL,bt.ReadOnly,[0,1]),b=l.frameCounter/1e3%1;_==="atmosphere"?l.renderPass==="offscreen"?o.needsSkyboxCapture(l)&&(function(M,C,z,P){let D=M.context,N=D.gl,F=C.skyboxFbo;if(!F){F=C.skyboxFbo=D.createFramebuffer(32,32,!0,null),C.skyboxGeometry=new Fa(D),C.skyboxTexture=D.gl.createTexture(),N.bindTexture(N.TEXTURE_CUBE_MAP,C.skyboxTexture),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MIN_FILTER,N.LINEAR),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MAG_FILTER,N.LINEAR);for(let Y=0;Y<6;++Y)N.texImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+Y,0,N.RGBA,32,32,0,N.RGBA,N.UNSIGNED_BYTE,null)}D.bindFramebuffer.set(F.framebuffer),D.viewport.set([0,0,32,32]);let j=C.getCenter(M,!0),U=M.getOrCreateProgram("skyboxCapture"),Z=new Float64Array(16);n.bx(Z),n.eh(Z,Z,.5*-Math.PI),Ko(M,C,U,Z,j,0),n.bx(Z),n.eh(Z,Z,.5*Math.PI),Ko(M,C,U,Z,j,1),n.bx(Z),n.cR(Z,Z,.5*-Math.PI),Ko(M,C,U,Z,j,2),n.bx(Z),n.cR(Z,Z,.5*Math.PI),Ko(M,C,U,Z,j,3),n.bx(Z),Ko(M,C,U,Z,j,4),n.bx(Z),n.eh(Z,Z,Math.PI),Ko(M,C,U,Z,j,5),D.viewport.set([0,0,M.width,M.height])}(l,o),o.markSkyboxValid(l)):l.renderPass==="sky"&&function(M,C,z,P,D){let N=M.context,F=N.gl,j=M.transform,U=M.getOrCreateProgram("skybox");N.activeTexture.set(F.TEXTURE0),F.bindTexture(F.TEXTURE_CUBE_MAP,C.skyboxTexture);let Z=((Y,Q,ne,he,de)=>({u_matrix:Y,u_sun_direction:Q,u_cubemap:0,u_opacity:he,u_temporal_offset:de}))(j.skyboxMatrix,C.getCenter(M,!1),0,P,D);M.uploadCommonUniforms(N,U),U.draw(M,F.TRIANGLES,z,Gt.disabled,M.colorModeForRenderPass(),Nt.backCW,Z,"skybox",C.skyboxGeometry.vertexBuffer,C.skyboxGeometry.indexBuffer,C.skyboxGeometry.segment)}(l,o,x,d,b):_==="gradient"&&l.renderPass==="sky"&&function(M,C,z,P,D){let N=M.context,F=N.gl,j=M.transform,U=M.getOrCreateProgram("skyboxGradient");C.skyboxGeometry||(C.skyboxGeometry=new Fa(N)),N.activeTexture.set(F.TEXTURE0);let Z=C.colorRampTexture;Z||(Z=C.colorRampTexture=new n.T(N,C.colorRamp,F.RGBA8)),Z.bind(F.LINEAR,F.CLAMP_TO_EDGE);let Y=((Q,ne,he,de,oe)=>({u_matrix:Q,u_color_ramp:0,u_center_direction:ne,u_radius:n.al(he),u_opacity:de,u_temporal_offset:oe}))(j.skyboxMatrix,C.getCenter(M,!1),C.paint.get("sky-gradient-radius"),P,D);M.uploadCommonUniforms(N,U),U.draw(M,F.TRIANGLES,z,Gt.disabled,M.colorModeForRenderPass(),Nt.backCW,Y,"skyboxGradient",C.skyboxGeometry.vertexBuffer,C.skyboxGeometry.indexBuffer,C.skyboxGeometry.segment)}(l,o,x,d,b)},custom:function(l,t,o,c){let d=l.context,p=o.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||l.renderPass==="offscreen")&&o.isDraped(t)){if(l.renderPass==="offscreen"){let _=p.prerender;if(_){if(l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),l.transform.projection.name==="globe"){let x=l.transform.pointMerc;_.call(p,d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),n.ah(l.transform.zoom),[x.x,x.y],l.transform.pixelsPerMeterRatio)}else _.call(p,d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState()}}else if(l.renderPass==="translucent"){if(l.terrain&&l.terrain.renderingToTexture){let x=p.renderToTile;if(x){let b=c[0].canonical,M={x:b.x+c[0].wrap*(p.wrapTileId?0:1<<b.z),y:b.y,z:b.z};d.setDepthMode(bt.disabled),d.setStencilMode(Gt.disabled),d.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),x.call(p,d.gl,M),d.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),d.setStencilMode(Gt.disabled);let _=p.renderingMode==="3d"?new bt(l.context.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,bt.ReadOnly);if(d.setDepthMode(_),l.transform.projection.name==="globe"){let x=l.transform.pointMerc;p.render(d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),n.ah(l.transform.zoom),[x.x,x.y],l.transform.pixelsPerMeterRatio)}else p.render(d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState(),d.bindFramebuffer.set(null)}}else n.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,o,c){if(l.renderPass==="opaque")return;let d=o.paint.get("model-opacity").constantOr(1);if(d===0)return;let p=o.paint.get("model-cast-shadows");if(l.renderPass==="shadow"&&(!p||l.terrain&&d<.65&&o._transitionablePaint._values["model-opacity"].value.expression instanceof n.ab))return;let _=l.shadowRenderer,x=o.paint.get("model-receive-shadows");_&&(_.useNormalOffset=!0,x||(_.enabled=!1));let b=()=>{_&&(_.useNormalOffset=!0,x||(_.enabled=!0))},M=t.getSource();if(l.renderPass==="light-beam"&&M.type!=="batched-model")return;if(M.type==="vector"||M.type==="geojson")return function(U,Z,Y,Q,ne){let he=U.transform;if(he.projection.name!=="mercator")return void n.w(`Drawing 3D models for ${he.projection.name} projection is not yet implemented`);let de=he.getFreeCameraOptions().position;if(!U.modelManager)return;let oe=U.modelManager;Y.modelManager=oe;let se=U.shadowRenderer;if(!Y._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let le=Y._unevaluatedLayout._values["model-id"],Me=Object.assign({},Y.layout.get("model-id").parameters),_e=U.style.order.indexOf(Y.fqid);for(let Ve of Q){let ze=Z.getTile(Ve).getBucket(Y);if(!ze||ze.projection.name!==he.projection.name)continue;let je=ze.getModelUris();je&&!ze.modelsRequested&&(oe.addModelsFromBucket(je,ne),ze.modelsRequested=!0);let rt=Dg(Ve,he);Me.zoom=rt;let Ce=le.possiblyEvaluate(Me);if(Sl(U,ze,Ve),ls.shadowUniformsInitialized=!1,ls.useSingleShadowCascade=!!se&&se.getMaxCascadeForTile(Ve.toUnwrapped())===0,U.renderPass==="shadow"&&se){if(U.currentShadowCascade===1&&ze.isInsideFirstShadowMapFrustum)continue;let Pe=he.calculatePosMatrix(Ve.toUnwrapped(),he.worldSize);if(ls.tileMatrix.set(Pe),ls.shadowTileMatrix=Float32Array.from(se.calculateShadowPassMatrixFromMatrix(Pe)),ls.aabb.min.fill(0),ls.aabb.max[0]=ls.aabb.max[1]=n.aj,ls.aabb.max[2]=0,rp(ze,ls,U,Y.scope))continue}let me=1<<Ve.canonical.z,ke=[((de.x-Ve.wrap)*me-Ve.canonical.x)*n.aj,(de.y*me-Ve.canonical.y)*n.aj,de.z*me*n.aj];U.conflationActive&&Object.keys(ze.instancesPerModel).length>0&&U.style.isLayerClipped(Y,Z.getSource())&&ze.updateReplacement(Ve,U.replacementSource,_e,ne)&&(ze.uploaded=!1,ze.upload(U.context));for(let Pe in ze.instancesPerModel){let $e=ze.instancesPerModel[Pe];$e.features.length>0&&(Pe=Ce.evaluate($e.features[0].feature,{}));let Ze=oe.getModel(Pe,ne);if(Ze||oe.hasURLBeenRequested(Pe)||ze.modelUris.includes(Pe)||(ze.modelUris.push(Pe),ze.modelsRequested=!1),Ze&&Ze.uploaded)for(let Ye of Ze.nodes)ip(U,Y,Ye,$e,ke,Ve,ls)}}}(l,t,o,c,M.type==="vector"?o.scope:""),void b();if(!M.loaded())return;if(M.type==="batched-model")return function(U,Z,Y,Q){Y.resetLayerRenderingStats(U);let ne=U.context,he=U.transform,de=U.style.fog,oe=U.shadowRenderer;if(he.projection.name!=="mercator")return void n.w(`Drawing 3D landmark models for ${he.projection.name} projection is not yet implemented`);let se=U.transform.getFreeCameraOptions().position,le=n.c1([],[se.x,se.y,se.z],U.transform.worldSize),Me=n.eq([],le),_e=n.bx([]),Ve=n.e9(he.center.lat,he.zoom),ze=n.bn([],[1,1,1/Ve]);n.bo(_e,_e,Me);let je=Y.paint.get("model-opacity").constantOr(1),rt=new bt(ne.gl.LEQUAL,bt.ReadWrite,U.depthRangeFor3D),Ce=new bt(ne.gl.LEQUAL,bt.ReadOnly,U.depthRangeFor3D),me=new n.d6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),ke=U.renderPass==="shadow",Pe=ke&&oe?oe.getCurrentCascadeFrustum():he.getFrustum(he.scaleZoom(he.worldSize)),$e=Y.paint.get("model-front-cutoff"),Ze=$e[2]<1,Ye=ss(U,Y.paint.get("model-cutoff-fade-range")),ct=Y.getLayerRenderingStats();(function(Mt,Ot,yt,zt){let Rt=Mt.terrain?Mt.terrain.exaggeration():0,$t=Mt.transform.zoom;for(let Jt of zt){let ai=Ot.getTile(Jt).getBucket(yt);ai&&(ai.setFilter(yt.filter),Mt.conflationActive&&ai.updateReplacement(Jt,Mt.replacementSource),ai.evaluateTransform(Mt,yt),Mt.terrain&&Rt>0&&ai.elevationUpdate(Mt.terrain,Rt,Jt,yt.source),ai.needsReEvaluation(Mt,$t,yt)&&ai.evaluate(yt))}})(U,Z,Y,Q),function(){let Mt,Ot,yt;Ze?(Mt=Q.length-1,Ot=-1,yt=-1):(Mt=0,Ot=Q.length,yt=1);let zt=new Float64Array(16),Rt=n.cx(),$t=new n.P(0,0);for(let Jt=Mt;Jt!==Ot;Jt+=yt){let ai=Q[Jt],Ti=Z.getTile(ai).getBucket(Y);if(!Ti||!Ti.uploaded)continue;let Yt=!1;oe&&(Yt=oe.getMaxCascadeForTile(ai.toUnwrapped())===0);let Si=he.calculatePosMatrix(ai.toUnwrapped(),he.worldSize),Mi=Ti.modelTraits;!ke&&Ze&&(n.bi(zt,Si),n.ad(Rt,le,zt),$t.x=Rt[0],$t.y=Rt[1]);let Wi=[];Ti.setFilter(Y.filter);for(let ni of Ti.getNodesInfo()){if(ni.hiddenByReplacement||!ni.node.meshes)continue;let Ei=ni.node,Ii=0;U.terrain&&Ei.elevation&&(Ii=Ei.elevation*U.terrain.exaggeration());let Ri=(()=>{let hn=ni.aabb;return me.min=[...hn.min],me.max=[...hn.max],me.min[2]+=Ii,me.max[2]+=Ii,n.ad(me.min,me.min,Si),n.ad(me.max,me.max,Si),me})(),li=ni.evaluatedScale;if(li[0]<=1&&li[1]<=1&&li[2]<=1&&Ri.intersects(Pe)===0)continue;if(!ke&&Ze){let hn=.16666666666666666;ni.cameraCollisionOpacity=le[0]>Ri.min[0]&&le[0]<Ri.max[0]&&le[1]>Ri.min[1]&&le[1]<Ri.max[1]&&le[2]*Ve<Ri.max[2]&&Ei.footprint&&n.bY($t,Ei.footprint)?Math.max(ni.cameraCollisionOpacity-hn,0):Math.min(1,ni.cameraCollisionOpacity+hn)}let Vi=[...Si],Ci=1/n.d4(ai.canonical),yr=Ei.anchor?Ei.anchor[0]:0,bi=Ei.anchor?Ei.anchor[1]:0;n.bo(Vi,Vi,[yr*(li[0]-1)+ni.evaluatedTranslation[0]*Ci,bi*(li[1]-1)+ni.evaluatedTranslation[1]*Ci,Ii+ni.evaluatedTranslation[2]]),n.cn(li,n.es)||n.cP(Vi,Vi,li);let Li=n.az([],Vi,Ei.matrix),$i=n.az([],he.expandedFarZProjMatrix,Li),kr=n.az([],he.expandedFarZProjMatrix,Vi),Dr=n.aA([],[yr,bi,Ii,1],$i)[2];Ei.hidden=!1;let Br=je;ke||(Ze&&(Br*=ni.cameraCollisionOpacity,Br*=bm(Vi,he,ni.aabb,$e)),Br*=vm(Ye,Dr)),Br!==0?Wi.push({nodeInfo:ni,depth:Dr,opacity:Br,wvpForNode:$i,wvpForTile:kr,nodeModelMatrix:Li,tileModelMatrix:Vi}):Ei.hidden=!0}ke||Wi.sort((ni,Ei)=>!Ze||ni.opacity===1&&Ei.opacity===1?ni.depth<Ei.depth?-1:1:ni.opacity===1?-1:Ei.opacity===1?1:ni.depth>Ei.depth?-1:1);for(let ni of Wi){let Ei=ni.nodeInfo,Ii=Ei.node,Ri=n.az([],ze,ni.tileModelMatrix);n.az(Ri,_e,Ri);let li=n.bi([],Ri);n.ea(li,li),n.cP(li,li,fu),Ri=n.az(Ri,Ri,Ii.matrix);let Vi=U.renderPass==="light-beam",Ci=Y.paint.get("model-color-use-theme").constantOr("default")==="none",yr=Mi&n.ex.HasMapboxMeshFeatures,bi=yr?0:Ei.evaluatedRMEA[0][2];for(let Li=0;Li<Ii.meshes.length;++Li){let $i=Ii.meshes[Li],kr=Li===Ii.lightMeshIndex,Dr=ni.wvpForNode;if(kr){if(!Vi&&!U.terrain&&U.shadowRenderer){U.currentLayer<U.firstLightBeamLayer&&(U.firstLightBeamLayer=U.currentLayer);continue}Dr=ni.wvpForTile}else if(Vi)continue;let Br={defines:[]},hn=[];if(!ke&&oe&&(oe.useNormalOffset=!!$i.normalBuffer),Hc(Br.defines,hn,$i,U,Ci?null:Y.lut),yr||Br.defines.push("DIFFUSE_SHADED"),Yt&&Br.defines.push("SHADOWS_SINGLE_CASCADE"),ct&&(ke?ct.numRenderedVerticesInShadowPass+=$i.vertexArray.length:ct.numRenderedVerticesInTransparentPass+=$i.vertexArray.length),ke){pu($i,ni.nodeModelMatrix,U,Y);continue}let Jo=null;if(de){let xn=qc(ni.nodeModelMatrix,U.transform);if(Jo=new Float32Array(xn),he.projection.name!=="globe"){let Cr=$i.aabb.min,Sr=$i.aabb.max,[Ki,Wr]=de.getOpacityForBounds(xn,Cr[0],Cr[1],Sr[0],Sr[1]);Br.overrideFog=Ki>=He||Wr>=He}}let kn=$i.material,to;kn.occlusionTexture&&kn.occlusionTexture.offsetScale&&(to=kn.occlusionTexture.offsetScale,Br.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));let yn=U.getOrCreateProgram("model",Br);!ke&&oe&&oe.setupShadowsFromMatrix(ni.tileModelMatrix,yn,oe.useNormalOffset),U.uploadCommonUniforms(ne,yn,null,Jo);let bo=kn.pbrMetallicRoughness;bo.metallicFactor=.9,bo.roughnessFactor=.5;let Vo=qd(new Float32Array(Dr),new Float32Array(Ri),new Float32Array(li),new Float32Array(Ii.matrix),U,ni.opacity,bo.baseColorFactor,kn.emissiveFactor,bo.metallicFactor,bo.roughnessFactor,kn,bi,Y,[0,0,0],to);!kr&&(Ei.hasTranslucentParts||ni.opacity<1)&&yn.draw(U,ne.gl.TRIANGLES,rt,Gt.disabled,ti.disabled,Nt.backCCW,Vo,Y.id,$i.vertexBuffer,$i.indexBuffer,$i.segments,Y.paint,U.transform.zoom,void 0,hn),yn.draw(U,ne.gl.TRIANGLES,kr?Ce:rt,Gt.disabled,kr||ni.opacity<1||Ei.hasTranslucentParts?ti.alphaBlended:ti.unblended,Nt.backCCW,Vo,Y.id,$i.vertexBuffer,$i.indexBuffer,$i.segments,Y.paint,U.transform.zoom,void 0,hn)}}}}()}(l,t,o,c),void b();if(M.type!=="model")return;let C=M.getModels(),z=[],P=l.transform.getFreeCameraOptions().position,D=n.c1([],[P.x,P.y,P.z],l.transform.worldSize);n.eq(D,D);let N=[],F=[],j=0;for(let U of C){let Z=o.paint.get("model-rotation").constantOr(null),Y=o.paint.get("model-scale").constantOr(null),Q=o.paint.get("model-translation").constantOr(null);U.computeModelMatrix(l,Z,Y,Q,!0,!0,!1);let ne=n.bx([]),he=n.e9(U.position.lat,l.transform.zoom),de=n.bn([],[1,1,1/he]);n.bo(ne,ne,D),z.push({zScaleMatrix:de,negCameraPosMatrix:ne});for(let oe of U.nodes)tp(l.transform,oe,U.matrix,l.transform.expandedFarZProjMatrix,j,N,F);j++}if(N.sort((U,Z)=>Z.depth-U.depth),l.renderPass!=="shadow"){if(d===1)for(let U of F)Tl(U,l,o,z[U.modelIndex],Gt.disabled,l.colorModeForRenderPass());else{for(let U of F)Tl(U,l,o,z[U.modelIndex],Gt.disabled,ti.disabled);for(let U of F)Tl(U,l,o,z[U.modelIndex],l.stencilModeFor3D(),l.colorModeForRenderPass());l.resetStencilClippingMasks()}for(let U of N)Tl(U,l,o,z[U.modelIndex],Gt.disabled,l.colorModeForRenderPass());b()}else{for(let U of F)pu(U.mesh,U.nodeModelMatrix,l,o);for(let U of N)pu(U.mesh,U.nodeModelMatrix,l,o);b()}}},_u={line:function(l,t,o){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,l._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||l._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){let c=t.getVisibleCoordinates();for(let d of c){let p=t.getTile(d).getBucket(l);if(p&&(p.elevationType!=="none"?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,o){let c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson")return void(o.modelManager&&o.modelManager.upload(o,c.type==="vector"?l.scope:""));if(c.type==="batched-model"||c.type!=="model")return;let d=c.getModels();for(let p of d)p.upload(o.context)},raster:function(l,t,o){let c=t.getSource();if(!(c instanceof Gs&&c.loaded()))return;let d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;let p=l.paint.get("raster-array-band")||c.getInitialBand(d);if(p==null)return;let _=t.getIds().map(x=>t.getTileByID(x));for(let x of _)x.updateNeeded(l.id,p)&&c.prepareTile(x,d,l.id,p)},"raster-particle":function(l,t,o){let c=t.getSource();if(!(c instanceof Gs&&c.loaded()))return;let d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;let p=l.paint.get("raster-particle-array-band")||c.getInitialBand(d);if(p==null)return;let _=t.getIds().map(x=>t.getTileByID(x));for(let x of _)x.updateNeeded(l.id,p)&&c.prepareTile(x,d,l.id,p)}},gu={fill:Tt},yo={fill:function(l,t,o,c){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let d=l.context.gl,p=new bt(d.LEQUAL,bt.ReadOnly,l.depthRangeFor3D),_=new Gt({func:d.ALWAYS,mask:255},255,255,d.KEEP,d.KEEP,d.REPLACE),x=l.transform.getFreeCameraOptions().position,b=l.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(let M of c){let C=t.getTile(M),z=C.getBucket(o);if(!z)continue;let P=z.elevatedStructures;if(!P||P.depthSegments.segments[0].primitiveLength===0)continue;let D=Vc(M.toUnwrapped(),x),N=l.translatePosMatrix(M.projMatrix,C,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),F=iu(N,D,0,1,0);b.draw(l,d.TRIANGLES,p,_,ti.disabled,Nt.disabled,F,o.id,P.vertexBuffer,P.indexBuffer,P.depthSegments,o.paint,l.transform.zoom)}}};class sa{constructor(t,o,c,d,p,_){this.context=new au(t,o),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=p,this._timeStamp=n.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let x=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(let M of x)this._debugParams.enabledLayers[M]=!0;p.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),p.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),p.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),p.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(let M of x)p.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],M);this.occlusionParams=new El(p),this.setup(),this.numSublayers=Gn.maxUnderzooming+Gn.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new n.eE,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new mg(this),this._wireframeDebugCache=new $c,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let b=new n.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new n.T(this.context,b,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=d,this.worldview=_}updateTerrain(t,o){let c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Jh(this,t));let d=this._terrain;this.transform.elevation=c?d:null,d.update(t,this.transform,o),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(t){let o=t.fog;if(!o||this.transform.projection.name==="globe"||o.getOpacity(this.transform.pitch)<1||o.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);let[c,d]=o.getFovAdjustedRange(this.transform._fov);if(c>d)return void(this.transform.fogCullDistSq=null);let p=c+.78*(d-c);this.transform.fogCullDistSq=p*p}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Jh(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,o){if(this.width=t*n.q.devicePixelRatio,this.height=o*n.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let c of this.style.order)this.style._mergedLayers[c].resize()}setup(){let t=this.context,o=new n.ba;o.emplaceBack(0,0),o.emplaceBack(n.aj,0),o.emplaceBack(0,n.aj),o.emplaceBack(n.aj,n.aj),this.tileExtentBuffer=t.createVertexBuffer(o,n.bc.members),this.tileExtentSegments=n.bd.simpleSegment(0,0,4,2);let c=new n.ba;c.emplaceBack(0,0),c.emplaceBack(n.aj,0),c.emplaceBack(0,n.aj),c.emplaceBack(n.aj,n.aj),this.debugBuffer=t.createVertexBuffer(c,n.bc.members),this.debugSegments=n.bd.simpleSegment(0,0,4,5);let d=new n.ba;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(d,n.bc.members),this.viewportSegments=n.bd.simpleSegment(0,0,4,2);let p=new n.aZ;p.emplaceBack(0,0,0,0),p.emplaceBack(n.aj,0,n.aj,0),p.emplaceBack(0,n.aj,0,n.aj),p.emplaceBack(n.aj,n.aj,n.aj,n.aj),this.mercatorBoundsBuffer=t.createVertexBuffer(p,n.bf.members),this.mercatorBoundsSegments=n.bd.simpleSegment(0,0,4,2);let _=new n.a_;_.emplaceBack(0,1,2),_.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(_);let x=new n.bb;for(let M of[0,1,3,2,0])x.emplaceBack(M);this.debugIndexBuffer=t.createIndexBuffer(x),this.emptyTexture=new n.T(t,new n.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=n.bz();let b=this.context.gl;this.stencilClearMode=new Gt({func:b.ALWAYS,mask:0},0,255,b.ZERO,b.ZERO,b.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,bt.disabled,this.stencilClearMode,ti.disabled,Nt.disabled,Yh(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,o,c){if(!o||this.currentStencilSource===o.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let x=!1;for(let b of c)if(this._tileClippingMaskIDs[b.key]===void 0){x=!0;break}if(!x)return}this.currentStencilSource=o.id;let d=this.context,p=d.gl;this.nextStencilID+c.length>256&&this.clearStencil(),d.setColorMode(ti.disabled),d.setDepthMode(bt.disabled);let _=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(let x of c){let b=o.getTile(x),M=this._tileClippingMaskIDs[x.key]=this.nextStencilID++,{tileBoundsBuffer:C,tileBoundsIndexBuffer:z,tileBoundsSegments:P}=this.getTileBoundsBuffers(b);_.draw(this,p.TRIANGLES,bt.disabled,new Gt({func:p.ALWAYS,mask:0},M,255,p.KEEP,p.KEEP,p.REPLACE),ti.disabled,Nt.disabled,Yh(x.projMatrix),"$clipping",C,z,P)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let t=this.nextStencilID++,o=this.context.gl;return new Gt({func:o.NOTEQUAL,mask:255},t,255,o.KEEP,o.KEEP,o.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);let o=this.context.gl;return new Gt({func:o.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,o.KEEP,o.KEEP,o.REPLACE)}stencilConfigForOverlap(t){let o=this.context.gl,c=t.sort((_,x)=>x.overscaledZ-_.overscaledZ),d=c[c.length-1].overscaledZ,p=c[0].overscaledZ-d+1;if(p>1){this.currentStencilSource=void 0,this.nextStencilID+p>256&&this.clearStencil();let _={};for(let x=0;x<p;x++)_[x+d]=new Gt({func:o.GEQUAL,mask:255},x+this.nextStencilID,255,o.KEEP,o.KEEP,o.REPLACE);return this.nextStencilID+=p,[_,c]}return[{[d]:Gt.disabled},c]}colorModeForRenderPass(){let t=this.context.gl;return this._showOverdrawInspector?new ti([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new n.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ti.unblended:ti.alphaBlended}colorModeForDrapableLayerRenderPass(t){let o=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new ti([o.ONE,o.ONE_MINUS_SRC_ALPHA,o.CONSTANT_ALPHA,o.ONE_MINUS_SRC_ALPHA],new n.am(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,o,c,d=!1){if(this.depthOcclusion)return new bt(this.context.gl.GREATER,bt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!d)return bt.disabled;let p=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new bt(c||this.context.gl.LEQUAL,o,[p,p])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let t=this.context.gl,o=Math.ceil(this.width),c=Math.ceil(this.height),d=this.context.bindFramebuffer.get(),p=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===o&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),o!==0&&c!==0&&(this.depthFBO=new Oa(this.context,o,c,!1,"texture"),this.depthTexture=new n.T(this.context,{width:o,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(d),t.bindTexture(t.TEXTURE_2D,p),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,o,c,0,0,o,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,o)=>t+o/this._fpsHistory.length,0))}render(t,o){let c=n.q.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=o;let d=this.style._mergedLayers,p=!(!this.terrain||!this.terrain.enabled),_=()=>this.style._getOrder(p).filter(Ce=>{let me=d[Ce];return!(me.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[me.type]}),x=_(),b=!1,M=!1,C=null;for(let Ce of x){let me=d[Ce];me.type==="circle"?b=!0:me.type==="building"?C=me:me.type==="symbol"&&(me.hasInitialOcclusionOpacityProperties?M=!0:b=!0)}let z=x.map(Ce=>d[Ce]),P=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(n.q.now()),this.imageManager.beginFrame();let D=0,N=!1;for(let Ce in P){let me=P[Ce];me.used&&(me.prepare(this.context),me.getSource().usedInConflation&&++D)}let F=!1;for(let Ce of z)Ce.isHidden(this.transform.zoom)||(Ce.type==="clip"&&(F=!0),this.prepareLayer(Ce));let j={},U={},Z={},Y={},Q={};for(let Ce in P){let me=P[Ce];j[Ce]=me.getVisibleCoordinates(),U[Ce]=j[Ce].slice().reverse(),Z[Ce]=me.getVisibleCoordinates(!0).reverse(),Y[Ce]=me.getShadowCasterCoordinates(),Q[Ce]=me.sortCoordinatesByDistance(j[Ce])}let ne=Ce=>{let me=this.style.getLayerSourceCache(Ce);return me&&me.used?me.getSource():null};if(D||F||this._clippingActiveLastFrame){let Ce=[],me=[],ke=0;for(let Pe of z)this.isSourceForClippingOrConflation(Pe,ne(Pe))&&(Ce.push(Pe),me.push(ke)),ke++;if(Ce&&(F||Ce.length>1)||this._clippingActiveLastFrame){F=!1;let Pe=[];for(let $e=0;$e<Ce.length;$e++){let Ze=Ce[$e],Ye=me[$e],ct=this.style.getLayerSourceCache(Ze);if(!ct||!ct.used||!ct.getSource().usedInConflation&&Ze.type!=="clip"&&Ze.type!=="building")continue;let Mt=n.eF,Ot=n.bW.None,yt=[],zt=!0;if(Ze.type==="building")Mt=n.eH;else if(Ze.type==="clip"){Mt=Ye;for(let Rt of Ze.layout.get("clip-layer-types"))Ot|=Rt==="model"?n.bW.Model:Rt==="symbol"?n.bW.Symbol:n.bW.FillExtrusion;for(let Rt of Ze.layout.get("clip-layer-scope"))yt.push(Rt);Ze.isHidden(this.transform.zoom)?zt=!1:F=!0}zt&&Pe.push({layer:Ze.fqid,cache:ct,order:Mt,clipMask:Ot,clipScope:yt})}this.replacementSource.setSources(Pe),N=!0}}this._clippingActiveLastFrame=F,N||this.replacementSource.clear(),this.conflationActive=N,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Ce=0;Ce<z.length;Ce++){let me=z[Ce],ke=me.cutoffRange();if(this.longestCutoffRange=Math.max(ke,this.longestCutoffRange),ke>0){let Pe=ne(me);Pe&&(this.minCutoffZoom=Math.max(Pe.minzoom,this.minCutoffZoom)),me.minzoom&&(this.minCutoffZoom=Math.max(me.minzoom,this.minCutoffZoom))}me.is3D(p)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Ce),this._lastOcclusionLayer=Ce)}let he=this.style&&this.style.fog;he?(this._fogVisible=he.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=he.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Z),this.opaquePassCutoff=0,x=_(),z=x.map(Ce=>d[Ce]));let de=this._shadowRenderer;if(de){de.updateShadowParameters(this.transform,this.style.directionalLight);for(let Ce in P)for(let me of j[Ce]){let ke={min:0,max:0};this.terrain&&(ke=this.terrain.getMinMaxForTile(me)||ke),de.addShadowReceiver(me.toUnwrapped(),ke.min,ke.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new n.eG(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Se(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);let oe=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),se=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(oe&&!this._snow&&(this._snow=new op(this)),!oe&&this._snow&&(this._snow.destroy(),delete this._snow),se&&!this._rain&&(this._rain=new Al(this)),!se&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),C){this.buildingTileBorderManager||(this.buildingTileBorderManager=new xm);let Ce=this.style.getLayerSourceCache(C);this.buildingTileBorderManager.updateBorders(Ce,C)}if(!Fs.has(this.context.gl))return;this.renderPass="offscreen";for(let Ce of z){let me=t.getLayerSourceCache(Ce);if(!Ce.hasOffscreenPass()||Ce.isHidden(this.transform.zoom))continue;let ke=me?U[me.id]:void 0;(Ce.type==="custom"||Ce.type==="raster"||Ce.type==="raster-particle"||Ce.isSky()||ke&&ke.length)&&this.renderLayer(this,me,Ce,ke)}this.depthRangeFor3D=[0,1-(z.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Y)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let le=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Me=(()=>{if(o.showOverdrawInspector)return n.am.black;let Ce=this.style.fog;if(Ce&&this.transform.projection.supportsFog){let me=this.style.getLut(Ce.scope);if(!le){let ke=Ce.properties.get("color-use-theme")==="none",Pe=Ce.properties.get("color").toNonPremultipliedRenderColor(ke?null:me).toArray01();return new n.am(...Pe)}if(le){let ke=Ce.properties.get("space-color-use-theme")==="none",Pe=Ce.properties.get("space-color").toNonPremultipliedRenderColor(ke?null:me).toArray01();return new n.am(...Pe)}}return n.am.transparent})();if(this.context.clear({color:Me,depth:1}),this.clearStencil(),this._showOverdrawInspector=o.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&le&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=x.length-1;this.currentLayer>=0;this.currentLayer--){let Ce=z[this.currentLayer],me=t.getLayerSourceCache(Ce);if(Ce.isSky())continue;let ke=me?(Ce.is3D(p)?Q:U)[me.id]:void 0;this._renderTileClippingMasks(Ce,me,ke),this.renderLayer(this,me,Ce,ke)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&le&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||n.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<x.length;this.currentLayer++){let Ce=z[this.currentLayer],me=t.getLayerSourceCache(Ce);Ce.isSky()&&this.renderLayer(this,me,Ce,me?U[me.id]:void 0)}function _e(Ce,me){let ke;return me&&(ke=(Ce.type==="symbol"?Z:Ce.is3D(p)?Q:U)[me.id]),ke}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<x.length;){let Ce=z[this.currentLayer];if(Ce.type==="raster"||Ce.type==="raster-particle"){let me=t.getLayerSourceCache(Ce);this.renderLayer(this,me,Ce,_e(Ce,me))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ve=0;de&&(Ve=de.getShadowCastingLayerCount());let ze=!1,je=-1;for(let Ce=0;Ce<x.length;++Ce){let me=z[Ce];me.isHidden(this.transform.zoom)||me.is3D(p)&&(je=Ce)}M&&je===-1&&(b=!0);let rt=!1;for(;this.currentLayer<x.length;){let Ce=z[this.currentLayer],me=t.getLayerSourceCache(Ce);if(Ce.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Ce)){if(Ce.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!rt&&Ce.is3D(p)&&!p){let ke=this.currentLayer,Pe=$e=>{for(this.currentLayer=0;this.currentLayer<z.length;this.currentLayer++){let Ze=z[this.currentLayer];if(gu[Ze.type]){let Ye=this.style.getLayerSourceCache(Ze);gu[Ze.type](this,Ye,Ze,_e(Ze,Ye),$e)}}};Pe("initialize"),Pe("reset"),this.currentLayer=ke,rt=!0}if(b&&!ze&&this.terrain&&!this.transform.isOrthographic&&(ze=!0,this.blitDepth()),M&&je!==-1&&this.currentLayer===je+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(Ce,me,me?j[me.id]:void 0),this.renderLayer(this,me,Ce,_e(Ce,me)),!this.terrain&&de&&Ve>0&&Ce.hasShadowPass()&&--Ve==0){{this.clearStencil(),this.resetStencilClippingMasks();let ke=this.currentLayer;for(this.currentLayer=0;this.currentLayer<z.length;this.currentLayer++){let Pe=z[this.currentLayer];if(yo[Pe.type]){let $e=this.style.getLayerSourceCache(Pe);yo[Pe.type](this,$e,Pe,_e(Pe,$e))}}this.currentLayer=ke}if(de.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){let ke=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=ke;this.currentLayer++){let Pe=z[this.currentLayer];if(!Pe.hasLightBeamPass())continue;let $e=t.getLayerSourceCache(Pe);this.renderLayer(this,$e,Pe,$e?U[$e.id]:void 0)}this.currentLayer=ke,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let ke=this.currentLayer;this.depthOcclusion=!0;for(let Pe of this.layersWithOcclusionOpacity){this.currentLayer=Pe;let $e=z[this.currentLayer],Ze=t.getLayerSourceCache($e),Ye=Ze?U[Ze.id]:void 0;this.terrain||this._renderTileClippingMasks($e,Ze,Ze?j[Ze.id]:void 0),this.renderLayer(this,Ze,$e,Ye)}this.depthOcclusion=!1,this.currentLayer=ke,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Ce=null;z.forEach(me=>{let ke=t.getLayerSourceCache(me);ke&&!me.isHidden(this.transform.zoom)&&ke.getVisibleCoordinates().length&&(!Ce||Ce.getSource().maxzoom<ke.getSource().maxzoom)&&(Ce=ke)}),Ce&&this.options.showTileBoundaries&&as(this,Ce,Ce.getVisibleCoordinates(),n.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&as(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new n.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Ce){let me=Ce.transform.padding;jc(Ce,Ce.transform.height-(me.top||0),3,mm),jc(Ce,me.bottom||0,3,Jd),du(Ce,me.left||0,3,Qd),du(Ce,Ce.transform.width-(me.right||0),3,ep);let ke=Ce.transform.centerPoint;(function(Pe,$e,Ze,Ye){Gc(Pe,$e-1,Ze-10,2,20,Ye),Gc(Pe,$e-10,Ze-1,20,2,Ye)})(Ce,ke.x,Ce.transform.height-ke.y,_m)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),N||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);let{unsupportedLayers:o}=this.transform.projection,c=!o||!o.includes(t.type);if(_u[t.type]&&(c||this.terrain&&t.type==="custom")){let d=this.style.getLayerSourceCache(t);_u[t.type](t,d,this)}this.gpuTimingEnd()}renderLayer(t,o,c,d){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||d&&d.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||sp[c.type](t,o,c,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;let o=this.context.extTimerQuery,c=this.context.gl,d=this.gpuTimers[t.id];d||(d=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),d.calls++,c.beginQuery(o.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let t=this.context.extTimerQuery,o=this.context.gl,c=o.createQuery();this.deferredRenderGpuTimeQueries.push(c),o.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){let t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){let o={};for(let c in t){let d=t[c],p=this.context.extTimerQuery,_=p.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;p.deleteQueryEXT(d.query),o[c]=_}return o}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;let o=this.context.gl,c=0;for(let d of t)c+=o.getQueryParameter(d,o.QUERY_RESULT)/1e6,o.deleteQuery(d);return c}translatePosMatrix(t,o,c,d,p){if(!c[0]&&!c[1])return t;let _=p?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(_){let M=Math.sin(_),C=Math.cos(_);c=[c[0]*C-c[1]*M,c[0]*M+c[1]*C]}let x=[p?c[0]:n.aw(o,c[0],this.transform.zoom),p?c[1]:n.aw(o,c[1],this.transform.zoom),0],b=new Float32Array(16);return n.bo(b,t,x),b}saveTileTexture(t){if(t.context!==this.context)return;let o=t.size[0],c=this._tileTextures[o];c?c.push(t):this._tileTextures[o]=[t]}getTileTexture(t){let o=this._tileTextures[t];return o&&o.length>0?o.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,o,c){let d=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,p=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(p.push("LIGHTING_3D_MODE"),p.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||p.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||p.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(p.push("TERRAIN"),this.linearFloatFilteringSupported()&&p.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&p.push("GLOBE"),!this._fogVisible||d||o!==void 0&&!o||p.push("FOG","FOG_DITHERING"),d&&p.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&p.push("OVERDRAW_INSPECTOR"),p}getOrCreateProgram(t,o){this.cache=this.cache||{};let c=o&&o.defines||[],d=o&&o.config,p=this.currentGlobalDefines(t,o&&o.overrideFog,o&&o.overrideRtt).concat(c),_=eu.cacheKey(Oc[t],t,p,d);return this.cache[_]||(this.cache[_]=new eu(this.context,t,Oc[t],d,dm[t],p)),this.cache[_]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new n.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,o){if(this.style.enable3dLights()){let c=this.style.directionalLight,d=this.style.ambientLight;if(c&&d){let p=((_,x,b)=>{let M=_.properties.get("direction"),C=_.properties.get("color-use-theme")==="none",z=_.properties.get("color").toNonPremultipliedRenderColor(C?null:b.getLut(_.scope)).toArray01(),P=_.properties.get("intensity"),D=x.properties.get("color-use-theme")==="none",N=x.properties.get("color").toNonPremultipliedRenderColor(D?null:b.getLut(x.scope)).toArray01(),F=x.properties.get("intensity"),j=[M.x,M.y,M.z],U=n.dI(N,F),Z=n.dI(z,P);return{u_lighting_ambient_color:U,u_lighting_directional_dir:j,u_lighting_directional_color:Z,u_ground_radiance:Od(j,Z,U)}})(c,d,this.style);o.setLightsUniformValues(t,p)}}}uploadCommonUniforms(t,o,c,d,p){if(this.uploadCommonLightUniforms(t,o),this.terrain&&this.terrain.renderingToTexture)return;let _=this.style.fog;if(_){let x=_.getOpacity(this.transform.pitch),b=((M,C,z,P,D,N,F,j,U,Z,Y,Q)=>{let ne=M.transform,he=C.properties.get("color-use-theme")==="none",de=C.properties.get("color").toNonPremultipliedRenderColor(he?null:M.style.getLut(C.scope)).toArray01();de[3]=P;let oe=M.frameCounter/1e3%1,[se,le]=C.properties.get("vertical-range");return{u_fog_matrix:z?ne.calculateFogTileMatrix(z):Q||M.identityMat,u_fog_range:C.getFovAdjustedRange(ne._fov),u_fog_color:de,u_fog_horizon_blend:C.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(se,le),le],u_fog_temporal_offset:oe,u_frustum_tl:D,u_frustum_tr:N,u_frustum_br:F,u_frustum_bl:j,u_globe_pos:U,u_globe_radius:Z,u_viewport:Y,u_globe_transition:n.ah(ne.zoom),u_is_globe:+(ne.projection.name==="globe")}})(this,_,c,x,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*n.q.devicePixelRatio,this.transform.height*n.q.devicePixelRatio],d);o.setFogUniformValues(t,b)}p&&o.setCutoffUniformValues(t,p.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){let t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){let t=this.context.gl,o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),o}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){let t=this._backgroundTiles,o=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(let d of c)o[d.key]=t[d.key]||new wa(d,512,this.transform.tileZoom,this,void 0,this.worldview);return o}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,o){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!o||o.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let o=this._cachedTileFogOpacities[t.key];return o||(this._cachedTileFogOpacities[t.key]=o=this.style.fog.getOpacityForTile(t)),o[0]>=He||o[1]>=He}setupDepthForOcclusion(t,o,c){let d=this.context,p=d.gl,_=!!c;var x;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),d.activeTexture.set(p.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((x=this.depthRangeFor3D)[1]-x[0]),-1-2*x[0]/(x[1]-x[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),d.activeTexture.set(p.TEXTURE0),_||o.setTerrainUniformValues(d,c)}}function Ml(l,t){let o=!1,c=null,d=()=>{c=null,o&&(l(),c=setTimeout(d,t),o=!1)};return()=>(o=!0,c||d(),c)}class yu{constructor(t){this._hashName=t&&encodeURIComponent(t),n.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ml(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){let t=this._map;if(!t)return"";let o=xu(t);if(this._hashName){let c=this._hashName,d=!1,p=location.hash.slice(1).split("&").map(_=>{let x=_.split("=")[0];return x===c?(d=!0,`${x}=${o}`):_}).filter(_=>_);return d||p.push(`${c}=${o}`),`#${p.join("&")}`}return`#${o}`}_getCurrentHash(){let t=location.hash.replace("#","");if(this._hashName){let o;return t.split("&").map(c=>c.split("=")).forEach(c=>{c[0]===this._hashName&&(o=c)}),(o&&o[1]||"").split("/")}return t.split("/")}_onHashChange(){let t=this._map;if(!t)return!1;let o=this._getCurrentHash();if(o.length>=3&&!o.some(c=>isNaN(Number(c)))){let c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(o[3]||0):t.getBearing();return t.jumpTo({center:[+o[2],+o[1]],zoom:+o[0],bearing:c,pitch:+(o[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function xu(l,t){let o=l.getCenter(),c=Math.round(100*l.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),p=Math.pow(10,d),_=Math.round(o.lng*p)/p,x=Math.round(o.lat*p)/p,b=l.getBearing(),M=l.getPitch(),C=t?`/${_}/${x}/${c}`:`${c}/${x}/${_}`;return(b||M)&&(C+="/"+Math.round(10*b)/10),M&&(C+=`/${Math.round(M)}`),C}let Cl={linearity:.3,easing:n.eI(0,0,.3,1)},aa=n.h({deceleration:2500,maxSpeed:1400},Cl),ap=n.h({deceleration:20,maxSpeed:1400},Cl),cs=n.h({deceleration:1e3,maxSpeed:360},Cl),lp=n.h({deceleration:1e3,maxSpeed:90},Cl);class vu{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:n.q.now(),settings:t})}_drainInertiaBuffer(){let t=this._inertiaBuffer,o=n.q.now();for(;t.length>0&&o-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let o={zoom:0,bearing:0,pitch:0,pan:new n.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:p}of this._inertiaBuffer)o.zoom+=p.zoomDelta||0,o.bearing+=p.bearingDelta||0,o.pitch+=p.pitchDelta||0,p.panDelta&&o.pan._add(p.panDelta),p.around&&(o.around=p.around),p.pinchAround&&(o.pinchAround=p.pinchAround);let c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(o.pan.mag()){let p=Rl(o.pan.mag(),c,n.h({},aa,t||{}));d.offset=o.pan.mult(p.amount/o.pan.mag()),d.center=this._map.transform.center,Pl(d,p)}if(o.zoom){let p=Rl(o.zoom,c,ap);d.zoom=this._map.transform.zoom+p.amount,Pl(d,p)}if(o.bearing){let p=Rl(o.bearing,c,cs);d.bearing=this._map.transform.bearing+n.ay(p.amount,-179,179),Pl(d,p)}if(o.pitch){let p=Rl(o.pitch,c,lp);d.pitch=this._map.transform.pitch+p.amount,Pl(d,p)}if(d.zoom||d.bearing){let p=o.pinchAround===void 0?o.around:o.pinchAround;d.around=p?this._map.unproject(p):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function Pl(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function Rl(l,t,o){let{maxSpeed:c,linearity:d,deceleration:p}=o,_=n.ay(l*d/(t/1e3),-c,c),x=Math.abs(_)/(p*d);return{easing:o.easing,duration:1e3*x,amount:_*(x/2)}}class ur extends n.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,c,d={}){let p=Ct(o.getCanvasContainer(),c),_=o.unproject(p);super(t,n.h({point:p,lngLat:_,originalEvent:c},d)),this._defaultPrevented=!1,this.target=o}}class Ll extends n.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,c){let d=t==="touchend"?c.changedTouches:c.touches,p=Ft(o.getCanvasContainer(),d),_=p.map(b=>o.unproject(b)),x=p.reduce((b,M,C,z)=>b.add(M.div(z.length)),new n.P(0,0));super(t,{points:p,point:x,lngLats:_,lngLat:o.unproject(x),originalEvent:c}),this._defaultPrevented=!1}}class cp extends n.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o){super("wheel",{originalEvent:o}),this._defaultPrevented=!1}}class hp{constructor(t,o){this._map=t,this._clickTolerance=o.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new cp(this._map,t))}mousedown(t,o){return this._mousedownPos=o,this._firePreventable(new ur(t.type,this._map,t))}mouseup(t){this._map.fire(new ur(t.type,this._map,t))}preclick(t){let o=n.h({},t);o.type="preclick",this._map.fire(new ur(o.type,this._map,o))}click(t,o){this._mousedownPos&&this._mousedownPos.dist(o)>=this._clickTolerance||(this.preclick(t),this._map.fire(new ur(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new ur(t.type,this._map,t))}mouseover(t){this._map.fire(new ur(t.type,this._map,t))}mouseout(t){this._map.fire(new ur(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Ll(t.type,this._map,t))}touchmove(t){this._map.fire(new Ll(t.type,this._map,t))}touchend(t){this._map.fire(new Ll(t.type,this._map,t))}touchcancel(t){this._map.fire(new Ll(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Na{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new ur(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ur("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new ur(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class up{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=o.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,o){this.isEnabled()&&t.shiftKey&&t.button===0&&(_t(),this._startPos=this._lastPos=o,this._active=!0)}mousemoveWindow(t,o){if(!this._active)return;let c=o,d=this._startPos,p=this._lastPos;if(!d||!p||p.equals(c)||!this._box&&c.dist(d)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=xe("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));let _=Math.min(d.x,c.x),x=Math.max(d.x,c.x),b=Math.min(d.y,c.y),M=Math.max(d.y,c.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${_}px,${b}px)`,this._box.style.width=x-_+"px",this._box.style.height=M-b+"px")})}mouseupWindow(t,o){if(!this._active)return;let c=this._startPos,d=o;if(c&&t.button===0){if(this.reset(),wt(),c.x!==d.x||c.y!==d.y)return this._map.fire(new n.A("boxzoomend",{originalEvent:t})),{cameraAnimation:p=>p.fitScreenCoordinates(c,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Pt(),delete this._startPos,delete this._lastPos}_fireEvent(t,o){return this._map.fire(new n.A(t,{originalEvent:o}))}}function Wc(l,t){let o={};for(let c=0;c<l.length;c++)o[l[c].identifier]=t[c];return o}class dp{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,o,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=function(d){let p=new n.P(0,0);for(let _ of d)p._add(_);return p.div(d.length)}(o),this.touches=Wc(c,o)))}touchmove(t,o,c){if(this.aborted||!this.centroid)return;let d=Wc(c,o);for(let p in this.touches){let _=d[p];(!_||_.dist(this.touches[p])>30)&&(this.aborted=!0)}}touchend(t,o,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){let d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class la{constructor(t){this.singleTap=new dp(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,o,c){this.singleTap.touchstart(t,o,c)}touchmove(t,o,c){this.singleTap.touchmove(t,o,c)}touchend(t,o,c){let d=this.singleTap.touchend(t,o,c);if(d){let p=t.timeStamp-this.lastTime<500,_=!this.lastTap||this.lastTap.dist(d)<30;if(p&&_||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class pp{constructor(){this._zoomIn=new la({numTouches:1,numTaps:2}),this._zoomOut=new la({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,o,c){this._zoomIn.touchstart(t,o,c),this._zoomOut.touchstart(t,o,c)}touchmove(t,o,c){this._zoomIn.touchmove(t,o,c),this._zoomOut.touchmove(t,o,c)}touchend(t,o,c){let d=this._zoomIn.touchend(t,o,c),p=this._zoomOut.touchend(t,o,c);return d?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:_=>_.easeTo({duration:300,zoom:_.getZoom()+1,around:_.unproject(d)},{originalEvent:t})}):p?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:_=>_.easeTo({duration:300,zoom:_.getZoom()-1,around:_.unproject(p)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}let fp={0:1,2:2},bu={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class zl{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,o){return!1}_move(t,o){return{}}mousedown(t,o){if(this._lastPoint)return;let c=Wt(t);this._correctButton(t,c)&&(this._lastPoint=o,this._eventButton=c)}mousemoveWindow(t,o){let c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&function(d,p){let _=fp[p];return d.buttons===void 0||(d.buttons&_)!==_}(t,this._eventButton))this.reset();else if(this._moved||!(o.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=o,this._move(c,o)}}mouseupWindow(t){this._lastPoint&&Wt(t)===this._eventButton&&(this._moved&&wt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class mp extends zl{mousedown(t,o){super.mousedown(t,o),this._lastPoint&&(this._active=!0)}_correctButton(t,o){return o===0&&!t.ctrlKey}_move(t,o){return{around:o,panDelta:o.sub(t)}}}class wu extends zl{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?bu[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let c=.8*(o.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class _p extends zl{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?bu[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let c=-.5*(o.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Tm{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=o.clickTolerance||1,this.reset(),n.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new n.P(0,0)}touchstart(t,o,c){return this._calculateTransform(t,o,c)}touchmove(t,o,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!n.eJ())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,o,c)}}touchend(t,o,c){this._calculateTransform(t,o,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,o,c){c.length>0&&(this._active=!0);let d=Wc(c,o),p=new n.P(0,0),_=new n.P(0,0),x=0;for(let M in d){let C=d[M],z=this._touches[M];z&&(p._add(C),_._add(C.sub(z)),x++,d[M]=C)}if(this._touches=d,x<this._minTouches||!_.mag())return;let b=_.div(x);return this._sum._add(b),this._sum.mag()<this._clickTolerance?void 0:{around:p.div(x),panDelta:b}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=xe("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Tu{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,o,c){return{}}touchstart(t,o,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([o[0],o[1]]))}touchmove(t,o,c){let d=this._firstTwoTouches;if(!d)return;t.preventDefault();let[p,_]=d,x=Xc(c,o,p),b=Xc(c,o,_);if(!x||!b)return;let M=this._aroundCenter?null:x.add(b).div(2);return this._move([x,b],M,t)}touchend(t,o,c){if(!this._firstTwoTouches)return;let[d,p]=this._firstTwoTouches,_=Xc(c,o,d),x=Xc(c,o,p);_&&x||(this._active&&wt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Xc(l,t,o){for(let c=0;c<l.length;c++)if(l[c].identifier===o)return t[c]}function gp(l,t){return Math.log(l/t)/Math.LN2}class Sm extends Tu{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,o){let c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(gp(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:gp(this._distance,c),pinchAround:o}}}function yp(l,t){return 180*l.angleWith(t)/Math.PI}class Em extends Tu{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,o){let c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:yp(this._vector,c),pinchAround:o}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());let o=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;let d=yp(t,c);return Math.abs(d)<o}}function Su(l){return Math.abs(l.y)>Math.abs(l.x)}class Im extends Tu{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Su(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,o,c){let d=this._lastPoints;if(!d)return;let p=t[0].sub(d[0]),_=t[1].sub(d[1]);return this._map._cooperativeGestures&&!n.eJ()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(p,_,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(p.y+_.y)/2*-.5})}gestureBeginsVertically(t,o,c){if(this._valid!==void 0)return this._valid;let d=t.mag()>=2,p=o.mag()>=2;if(!d&&!p)return;if(!d||!p)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;let _=t.y>0==o.y>0;return Su(t)&&Su(o)&&_}}let Am={panStep:100,bearingStep:15,pitchStep:10};class Mm{constructor(){let t=Am;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let o=0,c=0,d=0,p=0,_=0;switch(t.keyCode){case 61:case 107:case 171:case 187:o=1;break;case 189:case 109:case 173:o=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),p=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),p=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),_=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),_=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:x=>{let b=x.getZoom();x.easeTo({duration:300,easeId:"keyboardHandler",easing:Cm,zoom:o?Math.round(b)+o*(t.shiftKey?2:1):b,bearing:x.getBearing()+c*this._bearingStep,pitch:x.getPitch()+d*this._pitchStep,offset:[-p*this._panStep,-_*this._panStep],center:x.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Cm(l){return l*(2-l)}let Pm=4.000244140625,Fg=1/450;class Bg{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._handler=o,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Fg,n.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||n.eJ()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let o=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY,c=n.q.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,o!==0&&o%Pm==0?this._type="wheel":o!==0&&Math.abs(o)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=o,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*o)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,o+=this._lastValue)),t.shiftKey&&o&&(o/=4),this._type&&(this._lastWheelEvent=t,this._delta-=o,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let o=Ct(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:o,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let o=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){let M=this._type==="wheel"&&Math.abs(this._delta)>Pm?this._wheelZoomRate:this._defaultZoomRate,C=2/(1+Math.exp(-Math.abs(this._delta*M)));this._delta<0&&C!==0&&(C=1/C);let z=o(),P=Math.pow(2,z),D=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):P;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(D*C))),this._type==="wheel"&&(this._startZoom=z,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let c=typeof this._targetZoom=="number"?this._targetZoom:o(),d=this._startZoom,p=this._easing,_,x=!1;if(this._type==="wheel"&&d&&p){let M=Math.min((n.q.now()-this._lastWheelEventTime)/200,1),C=p(M);_=n.ai(d,c,C),M<1?this._frameId||(this._frameId=!0):x=!0}else _=c,x=!0;this._active=!0,x&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let b=_-o();return b*this._lastDelta<0&&(b=0),{noInertia:!0,needsRenderFrame:!x,zoomDelta:b,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let o=n.eK;if(this._prevEase){let c=this._prevEase,d=(n.q.now()-c.start)/c.duration,p=c.easing(d+.01)-c.easing(d),_=.27/Math.sqrt(p*p+1e-4)*.01,x=Math.sqrt(.0729-_*_);o=n.eI(_,x,.25,1)}return this._prevEase={start:n.q.now(),duration:t,easing:o},o}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=xe("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class gr{constructor(t,o){this._clickZoom=t,this._tapZoom=o}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Rm{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,o){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(o)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ng{constructor(){this._tap=new la({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,o,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=o[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,o,c))}touchmove(t,o,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;let d=o[0],p=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:p/128}}}else this._tap.touchmove(t,o,c)}touchend(t,o,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,o,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class xp{constructor(t,o,c){this._el=t,this._mousePan=o,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Vg{constructor(t,o,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=o,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Yc{constructor(t,o,c,d){this._el=t,this._touchZoom=o,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}let Kc=l=>l.zoom||l.drag||l.pitch||l.rotate;class vp extends n.A{}class Eu{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,o){let c=n.at([],o,t);this.radius=n.ae(c[2]<0?n.eM([],c,this.constants):[c[0],c[1],0])}projectRay(t){n.eM(t,t,this.constants),n.au(t,t),n.eN(t,t,this.constants);let o=n.c1([],t,this.radius);if(o[2]>0){let c=n.c1([],[0,0,1],n.bG(o,[0,0,1])),d=n.c1([],n.au([],[o[0],o[1],0]),this.radius),p=n.d5([],o,n.c1([],n.at([],n.d5([],d,c),o),2));o[0]=p[0],o[1]=p[1]}return o}}function Bo(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class Iu{constructor(t,o){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new vu(t),this._bearingSnap=o.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Eu,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(o),n.aV(["handleEvent","handleWindowEvent"],this);let c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(let[d,p,_]of this._listeners){let x=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(p,x,_)}}destroy(){for(let[t,o,c]of this._listeners){let d=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(o,d,c)}}_addDefaultHandlers(t){let o=this._map,c=o.getCanvasContainer();this._add("mapEvent",new hp(o,t));let d=o.boxZoom=new up(o,t);this._add("boxZoom",d);let p=new pp,_=new Rm;o.doubleClickZoom=new gr(_,p),this._add("tapZoom",p),this._add("clickZoom",_);let x=new Ng;this._add("tapDragZoom",x);let b=o.touchPitch=new Im(o);this._add("touchPitch",b);let M=new wu(t),C=new _p(t);o.dragRotate=new Vg(t,M,C),this._add("mouseRotate",M,["mousePitch"]),this._add("mousePitch",C,["mouseRotate"]);let z=new mp(t),P=new Tm(o,t);o.dragPan=new xp(c,z,P),this._add("mousePan",z),this._add("touchPan",P,["touchZoom","touchRotate"]);let D=new Em,N=new Sm;o.touchZoomRotate=new Yc(c,N,D,x),this._add("touchRotate",D,["touchPan","touchZoom"]),this._add("touchZoom",N,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Na(o));let F=o.scrollZoom=new Bg(o,this);this._add("scrollZoom",F,["mousePan"]);let j=o.keyboard=new Mm;this._add("keyboard",j);for(let U of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[U]&&o[U].enable(t[U])}_add(t,o,c){this._handlers.push({handlerName:t,handler:o,allowed:c}),this._handlersById[t]=o}stop(t){if(!this._updatingCamera){for(let{handler:o}of this._handlers)o.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Kc(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,o,c){for(let d in t)if(d!==c&&(!o||o.indexOf(d)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){let o=[];for(let c of t)this._el.contains(c.target)&&o.push(c);return o}handleEvent(t,o){this._updatingCamera=!0;let c=t.type==="renderFrame",d=c?void 0:t,p={needsRenderFrame:!1},_={},x={},b=t.touches?this._getMapTouches(t.touches):void 0,M=b?Ft(this._el,b):c?void 0:Ct(this._el,t);for(let{handlerName:P,handler:D,allowed:N}of this._handlers){if(!D.isEnabled())continue;let F;this._blockedByActive(x,N,P)?D.reset():D[o||t.type]&&(F=D[o||t.type](t,M,b),this.mergeHandlerResult(p,_,F,P,d),F&&F.needsRenderFrame&&this._triggerRenderFrame()),(F||D.isActive())&&(x[P]=D)}let C={};for(let P in this._previousActiveHandlers)x[P]||(C[P]=d);this._previousActiveHandlers=x,(Object.keys(C).length||Bo(p))&&(this._changes.push([p,_,C]),this._triggerRenderFrame()),(Object.keys(x).length||Bo(p))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:z}=p;z&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],z(this._map))}mergeHandlerResult(t,o,c,d,p){if(!c)return;n.h(t,c);let _={handlerName:d,originalEvent:c.originalEvent||p};c.zoomDelta!==void 0&&(o.zoom=_),c.panDelta!==void 0&&(o.drag=_),c.pitchDelta!==void 0&&(o.pitch=_),c.bearingDelta!==void 0&&(o.rotate=_)}_applyChanges(){let t={},o={},c={};for(let[d,p,_]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new n.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.aroundCoord!==void 0&&(t.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),n.h(o,p),n.h(c,_);this._updateMapTransform(t,o,c),this._changes=[]}_updateMapTransform(t,o,c){let d=this._map,p=d.transform,_=Z=>[Z.x,Z.y,Z.z];if((Z=>{let Y=this._eventsInProgress.drag;return Y&&!this._handlersById[Y.handlerName].isActive()})()&&!Bo(t)){let Z=p.zoom;p.cameraElevationReference="sea",this._originalZoom!=null&&p._orthographicProjectionAtLowPitch&&p.projection.name!=="globe"&&p.pitch===0?(p.cameraElevationReference="ground",p.zoom=this._originalZoom):(p.recenterOnTerrain(),p.cameraElevationReference="ground"),Z!==p.zoom&&this._map._update(!0)}if(p._isCameraConstrained&&d._stop(!0),!Bo(t))return void this._fireEvents(o,c,!0);let{panDelta:x,zoomDelta:b,bearingDelta:M,pitchDelta:C,around:z,aroundCoord:P,pinchAround:D}=t;p._isCameraConstrained&&(b>0&&(b=0),p._isCameraConstrained=!1),D!==void 0&&(z=D),(b||(Z=>o[Z]&&!this._eventsInProgress[Z])("drag"))&&z&&(this._dragOrigin=_(p.pointCoordinate3D(z)),this._originalZoom=p.zoom,this._trackingEllipsoid.setup(p._camera.position,this._dragOrigin)),p.cameraElevationReference="sea",d._stop(!0),z=z||d.transform.centerPoint,M&&(p.bearing+=M),C&&(p.pitch+=C),p._updateCameraState();let N=[0,0,0];if(x)if(p.projection.name==="mercator"){let Z=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(z).dir),Y=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(z.sub(x)).dir);N[0]=Y[0]-Z[0],N[1]=Y[1]-Z[1]}else{let Z=p.pointCoordinate(z);if(p.projection.name==="globe"){x=x.rotate(-p.angle);let Y=p._pixelsPerMercatorPixel/p.worldSize;N[0]=-x.x*n.eL(n.aY(Z.y))*Y,N[1]=-x.y*n.eL(p.center.lat)*Y}else{let Y=p.pointCoordinate(z.sub(x));Z&&Y&&(N[0]=Y.x-Z.x,N[1]=Y.y-Z.y)}}let F=p.zoom,j=[0,0,0];if(b){let Z=_(P||p.pointCoordinate3D(z)),Y={dir:n.au([],n.at([],Z,p._camera.position))};if(Y.dir[2]<0){let Q=p.zoomDeltaToMovement(Z,b);n.c1(j,Y.dir,Q)}}let U=n.d5(N,N,j);p._translateCameraConstrained(U),b&&Math.abs(p.zoom-F)>1e-4&&p.recenterOnTerrain(),p.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(o,c,!0)}_fireEvents(t,o,c){let d=Kc(this._eventsInProgress),p=Kc(t),_={};for(let C in t){let{originalEvent:z}=t[C];this._eventsInProgress[C]||(_[`${C}start`]=z),this._eventsInProgress[C]=t[C]}!d&&p&&this._fireEvent("movestart",p.originalEvent);for(let C in _)this._fireEvent(C,_[C]);p&&this._fireEvent("move",p.originalEvent);for(let C in t){let{originalEvent:z}=t[C];this._fireEvent(C,z)}let x={},b;for(let C in this._eventsInProgress){let{handlerName:z,originalEvent:P}=this._eventsInProgress[C];this._handlersById[z].isActive()||(delete this._eventsInProgress[C],b=o[z]||P,x[`${C}end`]=b)}for(let C in x)this._fireEvent(C,x[C]);let M=Kc(this._eventsInProgress);if(c&&(d||p)&&!M){this._updatingCamera=!0;let C=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),z=P=>P!==0&&-this._bearingSnap<P&&P<this._bearingSnap;C?(z(C.bearing||this._map.getBearing())&&(C.bearing=0),this._map.easeTo(C,{originalEvent:b})):(this._map.fire(new n.A("moveend",{originalEvent:b})),z(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,o){this._map.fire(new n.A(t,o?{originalEvent:o}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new vp("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}let Or="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class hs extends n.E{constructor(t,o){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=o.bearingSnap,this._respectPrefersReducedMotion=o.respectPrefersReducedMotion!==!1,n.aV(["_renderFrameCallback"],this)}getCenter(){return new n.ci(this.transform.center.lng,this.transform.center.lat)}setCenter(t,o){return this.jumpTo({center:t},o)}panBy(t,o,c){return t=n.P.convert(t).mult(-1),this.panTo(this.transform.center,n.h({offset:t},o),c)}panTo(t,o,c){return this.easeTo(n.h({center:t},o),c)}getZoom(){return this.transform.zoom}setZoom(t,o){return this.jumpTo({zoom:t},o),this}zoomTo(t,o,c){return this.easeTo(n.h({zoom:t},o),c)}zoomIn(t,o){return this.zoomTo(this.getZoom()+1,t,o),this}zoomOut(t,o){return this.zoomTo(this.getZoom()-1,t,o),this}getBearing(){return this.transform.bearing}setBearing(t,o){return this.jumpTo({bearing:t},o),this}getPadding(){return this.transform.padding}setPadding(t,o){return this.jumpTo({padding:t},o),this}rotateTo(t,o,c){return this.easeTo(n.h({bearing:t},o),c)}resetNorth(t,o){return this.rotateTo(0,n.h({duration:1e3},t),o),this}resetNorthPitch(t,o){return this.easeTo(n.h({bearing:0,pitch:0,duration:1e3},t),o),this}snapToNorth(t,o){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,o):this}getPitch(){return this.transform.pitch}setPitch(t,o){return this.jumpTo({pitch:t},o),this}cameraForBounds(t,o){t=n.aG.convert(t);let c=o&&o.bearing||0,d=o&&o.pitch||0,p=t.getNorthWest(),_=t.getSouthEast();return this._cameraForBounds(this.transform,p,_,c,d,o)}_extendPadding(t){let o={top:0,right:0,bottom:0,left:0};return t==null?n.h({},o,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:n.h({},o,t)}_extendCameraOptions(t){return(t=n.h({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,o){let c=o.max[0]-o.min[0],d=o.max[1]-o.min[1];return c/d>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):d/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,o,c,d,p,_){let x=t.clone(),b=this._extendCameraOptions(_);x.bearing=d,x.pitch=p;let M=n.ci.convert(o),C=n.ci.convert(c),z=.5*(M.lat+C.lat),P=.5*(M.lng+C.lng),D=n.eO(z,P),N=n.au([],D),F=n.au([],n.bF([],N,[0,1,0])),j=n.bF([],F,N),U=[F[0],F[1],F[2],0,j[0],j[1],j[2],0,N[0],N[1],N[2],0,0,0,0,1],Z=[D,n.eO(M.lat,M.lng),n.eO(C.lat,M.lng),n.eO(C.lat,C.lng),n.eO(M.lat,C.lng),n.eO(z,M.lng),n.eO(z,C.lng),n.eO(M.lat,P),n.eO(C.lat,P)],Y=n.d6.fromPoints(Z.map(Pe=>[n.bG(F,Pe),n.bG(j,Pe),n.bG(N,Pe)])),Q=n.ad([],Y.center,U);n.eP(Q)===0&&n.eQ(Q,0,0,1),n.au(Q,Q),n.c1(Q,Q,n.aB),x.center=n.eR(Q);let ne=x.getWorldToCameraMatrix(),he=n.bi(new Float64Array(16),ne);Y=n.d6.applyTransform(Y,n.az([],ne,U));let de=this._extendAABB(Y,x,b,d);if(!de)return void n.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Y=de,n.ad(Q,Q,ne);let oe=.5*(Y.max[2]-Y.min[2]),se=this._minimumAABBFrustumDistance(x,Y),le=n.c1([],[0,0,1],oe),Me=n.d5(le,Q,le),_e=se+(x.pitch===0?0:n.bD(Q,Me)),Ve=x.globeCenterInViewSpace,ze=n.at([],Q,[Ve[0],Ve[1],Ve[2]]);n.au(ze,ze),n.c1(ze,ze,_e);let je=n.d5([],Q,ze);n.ad(je,je,he);let rt=n.eB/n.aB,Ce=n.ae(je),me=n.cb(Math.max(Ce*rt-n.eB,Number.EPSILON),0),ke=Math.min(x.zoomFromMercatorZAdjusted(me),b.maxZoom);return ke>.5*(n.cX+n.cI)?(x.setProjection({name:"mercator"}),x.zoom=ke,this._cameraForBounds(x,o,c,d,p,_)):{center:x.center,zoom:ke,bearing:d,pitch:p}}_extendAABB(t,o,c,d){let p=.5*((c.padding.left||0)+(c.padding.right||0)),_=.5*((c.padding.top||0)+(c.padding.bottom||0)),x=_,b=p,M=p,C=_,z=o.width-(b+M),P=o.height-(x+C),D=n.at([],t.max,t.min),N=Math.min(z/D[0],P/D[1]),F=Math.min(o.scaleZoom(o.scale*N),c.maxZoom);if(isNaN(F))return null;let j=o.scale/o.zoomScale(F),U=new n.d6([t.min[0]-b*j,t.min[1]-C*j,t.min[2]],[t.max[0]+M*j,t.max[1]+x*j,t.max[2]]),Z=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new n.P(c.offset.x,c.offset.y):n.P.convert(c.offset)).rotate(-n.al(d));return U.center[0]-=Z.x*j,U.center[1]+=Z.y*j,U}queryTerrainElevation(t,o){let c=this.transform.elevation;return c?(o=n.h({},{exaggerated:!0},o),c.getAtPoint(n.ac.fromLngLat(t),null,o.exaggerated)):null}_cameraForBounds(t,o,c,d,p,_){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,o,c,d,p,_);let x=t.clone(),b=this._extendCameraOptions(_);x.bearing=d,x.pitch=p;let M=n.ci.convert(o),C=n.ci.convert(c),z=new n.ci(M.lng,C.lat),P=new n.ci(C.lng,M.lat),D=x.project(M),N=x.project(C),F=this.queryTerrainElevation(M),j=this.queryTerrainElevation(C),U=this.queryTerrainElevation(z),Z=this.queryTerrainElevation(P),Y=[[D.x,D.y,Math.min(F||0,j||0,U||0,Z||0)],[N.x,N.y,Math.max(F||0,j||0,U||0,Z||0)]],Q=n.d6.fromPoints(Y),ne=x.getWorldToCameraMatrix(),he=n.bi(new Float64Array(16),ne);Q=n.d6.applyTransform(Q,ne);let de=this._extendAABB(Q,x,b,d);if(!de)return void n.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Q=de;let oe=.5*n.at([],Q.max,Q.min)[2],se=this._minimumAABBFrustumDistance(x,Q),le=[0,0,1,0];n.aA(le,le,ne),n.eS(le,le);let Me=n.c1([],le,se+oe),_e=n.d5([],Q.center,Me);n.ad(Q.center,Q.center,he),n.ad(_e,_e,he);let Ve=x.unproject(new n.P(Q.center[0],Q.center[1])),ze=n.eT(x.projection,Ve),je=Math.pow(2,ze),rt=Math.min(x._zoomFromMercatorZ(_e[2]*x.pixelsPerMeter*je/x.worldSize),b.maxZoom);return x.mercatorFromTransition&&rt<.5*(n.cX+n.cI)?(x.setProjection({name:"globe"}),x.zoom=rt,this._cameraForBounds(x,o,c,d,p,_)):{center:Ve,zoom:rt,bearing:d,pitch:p}}fitBounds(t,o,c){let d=this.cameraForBounds(t,o);return this._fitInternal(d,o,c)}fitScreenCoordinates(t,o,c,d,p){let _=n.P.convert(t),x=n.P.convert(o),b=new n.P(Math.min(_.x,x.x),Math.min(_.y,x.y)),M=new n.P(Math.max(_.x,x.x),Math.max(_.y,x.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(_,x))return this;let C=this.transform.pointLocation3D(b),z=this.transform.pointLocation3D(M),P=this.transform.pointLocation3D(new n.P(b.x,M.y)),D=this.transform.pointLocation3D(new n.P(M.x,b.y)),N=[Math.min(C.lng,z.lng,P.lng,D.lng),Math.min(C.lat,z.lat,P.lat,D.lat)],F=[Math.max(C.lng,z.lng,P.lng,D.lng),Math.max(C.lat,z.lat,P.lat,D.lat)],j=d&&d.pitch?d.pitch:this.getPitch(),U=this._cameraForBounds(this.transform,N,F,c,j,d);return this._fitInternal(U,d,p)}_fitInternal(t,o,c){return t?(o=n.h(t,o)).linear?this.easeTo(o,c):this.flyTo(o,c):this}jumpTo(t,o){this.stop();let c=t.preloadOnly?this.transform.clone():this.transform,d=!1,p=!1,_=!1;"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=n.ci.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(p=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(_=!0,c.pitch=+t.pitch);let x=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(x))if(t.retainPadding===!1){let b=c.clone();b.padding=x,c.setLocationAtPoint(c.center,b.centerPoint)}else c.padding=x;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new n.A("movestart",o)).fire(new n.A("move",o)),d&&this.fire(new n.A("zoomstart",o)).fire(new n.A("zoom",o)).fire(new n.A("zoomend",o)),p&&this.fire(new n.A("rotatestart",o)).fire(new n.A("rotate",o)).fire(new n.A("rotateend",o)),_&&this.fire(new n.A("pitchstart",o)).fire(new n.A("pitch",o)).fire(new n.A("pitchend",o)),this.fire(new n.A("moveend",o)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||n.w(Or),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,o){let c=this.transform;if(!c.projection.supportsFreeCamera)return n.w(Or),this;this.stop();let d=c.zoom,p=c.pitch,_=c.bearing;c.setFreeCameraOptions(t);let x=d!==c.zoom,b=p!==c.pitch,M=_!==c.bearing;return this.fire(new n.A("movestart",o)).fire(new n.A("move",o)),x&&this.fire(new n.A("zoomstart",o)).fire(new n.A("zoom",o)).fire(new n.A("zoomend",o)),M&&this.fire(new n.A("rotatestart",o)).fire(new n.A("rotate",o)).fire(new n.A("rotateend",o)),b&&this.fire(new n.A("pitchstart",o)).fire(new n.A("pitch",o)).fire(new n.A("pitchend",o)),this.fire(new n.A("moveend",o)),this}easeTo(t,o){this._stop(!1,t.easeId),((t=n.h({offset:[0,0],duration:500,easing:n.eK},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);let c=this.transform,d=this.getZoom(),p=this.getBearing(),_=this.getPitch(),x=this.getPadding(),b="zoom"in t?+t.zoom:d,M="bearing"in t?this._normalizeBearing(t.bearing,p):p,C="pitch"in t?+t.pitch:_,z=this._extendPadding(t.padding),P=n.P.convert(t.offset),D,N,F;if(c.projection.name==="globe"){let le=n.ac.fromLngLat(c.center),Me=P.rotate(-c.angle);le.x+=Me.x/c.worldSize,le.y+=Me.y/c.worldSize;let _e=le.toLngLat(),Ve=n.ci.convert(t.center||_e);this._normalizeCenter(Ve),D=c.centerPoint.add(Me),N=new n.P(le.x,le.y).mult(c.worldSize),F=new n.P(n.aD(Ve.lng),n.aH(Ve.lat)).mult(c.worldSize).sub(N)}else{D=c.centerPoint.add(P);let le=c.pointLocation(D),Me=n.ci.convert(t.center||le);this._normalizeCenter(Me),N=c.project(le),F=c.project(Me).sub(N)}let j=c.zoomScale(b-d),U,Z;t.around&&(U=n.ci.convert(t.around),Z=c.locationPoint(U));let Y=this._zooming||b!==d,Q=this._rotating||p!==M,ne=this._pitching||C!==_,he=!c.isPaddingEqual(z),de=t.retainPadding===!1?c.clone():c,oe=le=>Me=>{if(Y&&(le.zoom=n.ai(d,b,Me)),Q&&(le.bearing=n.ai(p,M,Me)),ne&&(le.pitch=n.ai(_,C,Me)),he&&(de.interpolatePadding(x,z,Me),D=de.centerPoint.add(P)),U)le.setLocationAtPoint(U,Z);else{let _e=le.zoomScale(le.zoom-d),Ve=b>d?Math.min(2,j):Math.max(.5,j),ze=Math.pow(Ve,1-Me),je=le.unproject(N.add(F.mult(Me*ze)).mult(_e));le.setLocationAtPoint(le.renderWorldCopies?je.wrap():je,D)}return t.preloadOnly||this._fireMoveEvents(o),le};if(t.preloadOnly){let le=this._emulate(oe,t.duration,c);return this._preloadTiles(le),this}let se={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Y,this._rotating=Q,this._pitching=ne,this._padding=he,this._easeId=t.easeId,this._prepareEase(o,t.noMoveStart,se),this._ease(oe(c),le=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(o,le)},t),this}_prepareEase(t,o,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),o||c.moving||this.fire(new n.A("movestart",t)),this._zooming&&!c.zooming&&this.fire(new n.A("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new n.A("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new n.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new n.A("move",t)),this._zooming&&this.fire(new n.A("zoom",t)),this._rotating&&this.fire(new n.A("rotate",t)),this._pitching&&this.fire(new n.A("pitch",t))}_afterEase(t,o){if(this._easeId&&o&&this._easeId===o)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let c=this._zooming,d=this._rotating,p=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new n.A("zoomend",t)),d&&this.fire(new n.A("rotateend",t)),p&&this.fire(new n.A("pitchend",t)),this.fire(new n.A("moveend",t))}flyTo(t,o){if(this._prefersReducedMotion(t)){let Pe=n.aF(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Pe,o)}this.stop(),t=n.h({offset:[0,0],speed:1.2,curve:1.42,easing:n.eK},t);let c=this.transform,d=this.getZoom(),p=this.getBearing(),_=this.getPitch(),x=this.getPadding(),b="zoom"in t?n.ay(+t.zoom,c.minZoom,c.maxZoom):d,M="bearing"in t?this._normalizeBearing(t.bearing,p):p,C="pitch"in t?+t.pitch:_,z=this._extendPadding(t.padding),P=c.zoomScale(b-d),D=n.P.convert(t.offset),N=c.centerPoint.add(D),F=c.pointLocation(N),j=n.ci.convert(t.center||F);this._normalizeCenter(j);let U=c.project(F),Z=c.project(j).sub(U),Y=t.curve,Q=Math.max(c.width,c.height),ne=Q/P,he=Z.mag();if("minZoom"in t){let Pe=n.ay(Math.min(t.minZoom,d,b),c.minZoom,c.maxZoom),$e=Q/c.zoomScale(Pe-d);Y=Math.sqrt($e/he*2)}let de=Y*Y;function oe(Pe){let $e=(ne*ne-Q*Q+(Pe?-1:1)*de*de*he*he)/(2*(Pe?ne:Q)*de*he);return Math.log(Math.sqrt($e*$e+1)-$e)}function se(Pe){return(Math.exp(Pe)-Math.exp(-Pe))/2}function le(Pe){return(Math.exp(Pe)+Math.exp(-Pe))/2}let Me=oe(0),_e=function(Pe){return le(Me)/le(Me+Y*Pe)},Ve=function(Pe){return Q*((le(Me)*(se($e=Me+Y*Pe)/le($e))-se(Me))/de)/he;var $e},ze=(oe(1)-Me)/Y;if(Math.abs(he)<1e-6||!isFinite(ze)){if(Math.abs(Q-ne)<1e-6)return this.easeTo(t,o);let Pe=ne<Q?-1:1;ze=Math.abs(Math.log(ne/Q))/Y,Ve=function(){return 0},_e=function($e){return Math.exp(Pe*Y*$e)}}t.duration="duration"in t?+t.duration:1e3*ze/("screenSpeed"in t?+t.screenSpeed/Y:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);let je=p!==M,rt=C!==_,Ce=!c.isPaddingEqual(z),me=t.retainPadding===!1?c.clone():c,ke=Pe=>$e=>{let Ze=$e*ze,Ye=1/_e(Ze);Pe.zoom=$e===1?b:d+Pe.scaleZoom(Ye),je&&(Pe.bearing=n.ai(p,M,$e)),rt&&(Pe.pitch=n.ai(_,C,$e)),Ce&&(me.interpolatePadding(x,z,$e),N=me.centerPoint.add(D));let ct=$e===1?j:Pe.unproject(U.add(Z.mult(Ve(Ze))).mult(Ye));return Pe.setLocationAtPoint(Pe.renderWorldCopies?ct.wrap():ct,N),Pe._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(o),Pe};if(t.preloadOnly){let Pe=this._emulate(ke,t.duration,c);return this._preloadTiles(Pe),this}return this._zooming=!0,this._rotating=je,this._pitching=rt,this._padding=Ce,this._prepareEase(o,!1),this._ease(ke(c),()=>this._afterEase(o),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,o){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,o)}if(!t){let c=this.handlers;c&&c.stop(!1)}return this}_ease(t,o,c){c.animate===!1||c.duration===0?(t(1),o()):(this._easeStart=n.q.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=o,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let t=Math.min((n.q.now()-this._easeStart)/this._easeOptions.duration,1),o=this._onEaseFrame;o&&o(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,o){t=n.bQ(t,-180,180);let c=Math.abs(t-o);return Math.abs(t-360-o)<c&&(t-=360),Math.abs(t+360-o)<c&&(t+=360),t}_normalizeCenter(t){let o=this.transform;if(o.maxBounds||o.projection.name!=="globe"&&!o.renderWorldCopies)return;let c=t.lng-o.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&n.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,o,c){let d=Math.ceil(15*o/1e3),p=[],_=t(c.clone());for(let x=0;x<=d;x++){let b=_(x/d);p.push(b.clone())}return p}_preloadTiles(t,o){}}class Dl{constructor(t={}){this.options=t,n.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){let o=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=xe("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);let d=xe("span","mapboxgl-ctrl-icon",this._compactButton);return d.setAttribute("aria-hidden","true"),d.setAttribute("title",c),this._innerContainer=xe("div","mapboxgl-ctrl-attrib-inner",this._container),o&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),o===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));let o=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||n.e.ACCESS_TOKEN}];if(t){let c=o.reduce((d,p,_)=>(p.value&&(d+=`${p.key}=${p.value}${_<o.length-1?"&":""}`),d),"?");t.href=`${n.e.FEEDBACK_URL}/${c}#${xu(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){let d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}let o=this._map.style._mergedSourceCaches;for(let d in o){let p=o[d];if(p.used){let _=p.getSource();_.attribution&&t.indexOf(_.attribution)<0&&t.push(_.attribution)}}t.sort((d,p)=>d.length-p.length),t=t.filter((d,p)=>{for(let _=p+1;_<t.length;_++)if(t[_].indexOf(d)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));let c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Jc{constructor(){n.aV(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=xe("div","mapboxgl-ctrl");let o=xe("a","mapboxgl-ctrl-logo");return o.target="_blank",o.rel="noopener nofollow",o.href="https://www.mapbox.com/",o.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),o.setAttribute("rel","noopener nofollow"),this._container.appendChild(o),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(let o in t){let c=t[o].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){let t=this._container.children;if(t.length){let o=t[0];this._map.getCanvasContainer().offsetWidth<250?o.classList.add("mapboxgl-compact"):o.classList.remove("mapboxgl-compact")}}}class bp{constructor(){n.aV(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("indoorupdate",o=>this._onIndoorUpdate({selectedFloorId:o.selectedFloorId,floors:o.floors})),this._container}_createButton(t,o){let c=xe("button",t,this._container);return c.type="button",c.addEventListener("click",o),c}_setButtonTitle(t,o){this._map&&(t.setAttribute("aria-label",o),t.innerHTML=`<strong>${o}</strong>`,t.firstElementChild&&t.firstElementChild.setAttribute("title",o))}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("indoorupdate",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return void(this._container.style.display="none");let o=this._model;this._model=t,this._container.style.display="inline-block";let c=t.floors.sort((d,p)=>d.levelOrder-p.levelOrder);o?(Array.from(this._container.children).forEach(d=>d.remove()),this.addCurrentFloors(c)):this.addCurrentFloors(c)}addCurrentFloors(t){for(let o of t){let c=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(o.id),Array.from(this._container.children).forEach(d=>{d.classList.remove("mapboxgl-ctrl-level-button-selected")}),c.classList.add("mapboxgl-ctrl-level-button-selected")});this._setButtonTitle(c,o.shortName),this._model&&o.id===this._model.selectedFloorId&&(this._map._selectIndoorFloor(o.id),c.classList.add("mapboxgl-ctrl-level-button-selected")),this._container.append(c)}}}class Lm{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){let o=++this._id;return this._queue.push({callback:t,id:o,cancelled:!1}),o}remove(t){let o=this._currentlyRunning,c=o?this._queue.concat(o):this._queue;for(let d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){let o=this._currentlyRunning=this._queue;this._queue=[];for(let c of o)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Qc{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;let o=n.dx((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-o)+this._end*o}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,o,c){this._start=this.getValue(o),this._end=t,this._startTime=o,this._endTime=o+c}}let Ug={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class zm extends n.A{constructor(t,o,c,d){let{point:p,lngLat:_,originalEvent:x,target:b}=t;super(t.type,{point:p,lngLat:_,originalEvent:x,target:b}),this.preventDefault=()=>{t.preventDefault()},this.id=o,this.interaction=c,this.feature=d}}class wp{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,o){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);let c=o.filter,d=o.type;c&&this.filters.set(t,n.b3(c)),d==="mouseover"&&(d="mouseenter"),d==="mouseout"&&(d="mouseleave");let p=this.interactionsByType.get(d)||new Map;d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,o)):p.size===0&&this.map.on(d,this.handleType),p.size===0&&this.interactionsByType.set(d,p),p.set(t,o),this.typeById.set(t,d)}get(t){let o=this.typeById.get(t);if(!o)return;let c=this.interactionsByType.get(o);return c?c.get(t):void 0}remove(t){let o=this.typeById.get(t);if(!o)return;this.typeById.delete(t),this.filters.delete(t);let c=this.interactionsByType.get(o);c&&(c.delete(t),o==="mouseenter"||o==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(o,this.handleType))}queryTargets(t,o){let c=[];for(let[d,p]of o)p.target&&c.push({targetId:d,target:p.target,filter:this.filters.get(d)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;let o=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());o.length&&(t.type="mouseenter",this.handleType(t,o));let c=new Map;for(let[d,{feature:p}]of this.prevHoveredFeatures)this.hoveredFeatures.has(d)||c.set(p.id,p);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){let o=Array.from(this.hoveredFeatures.values()).map(({feature:c})=>c);o.length&&(t.type="mouseleave",this.handleType(t,o)),this.hoveredFeatures.clear()}handleType(t,o){let c=t.type==="mouseenter";if(c&&!this.interactionsByType.has(t.type))return void n.w("mouseenter interaction required for mouseleave to work.");let d=Array.from(this.interactionsByType.get(t.type)).reverse(),p=!!o;o=o||this.queryTargets(t.point,d);let _=!1,x=new Set;for(let b of o){for(let[M,C]of d){if(!C.target)continue;let z=b.variants?b.variants[M]:null;if(z){for(let P of z){if(Ih(P,b,x,M))continue;let D=new n.dr(b,P),N=fc(P,b,M);p&&(D.state=this.map.getFeatureState(D));let F=c?this.prevHoveredFeatures.get(N):null,j=new zm(t,M,C,D),U=F?F.stop:C.handler(j);if(c&&this.hoveredFeatures.set(N,{feature:b,stop:U}),U!==!1){_=!0;break}}if(_)break}}if(_)break}if(!_)for(let[b,M]of d){let{handler:C,target:z}=M;if(!z&&C(new zm(t,b,M,null))!==!1)break}}}function Tp(l,t){if(Array.isArray(l)&&Array.isArray(t)){let o=new Set(l),c=new Set(t);return o.size===c.size&&l.every(d=>c.has(d))}return n.bv(l,t)}let eh={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Ol={showCompass:!0,showZoom:!0,visualizePitch:!1};class Ls{constructor(t,o,c=!1){this._clickTolerance=10,this.element=o,this.mouseRotate=new wu({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new _p({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),n.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),o.addEventListener("mousedown",this.mousedown),o.addEventListener("touchstart",this.touchstart,{passive:!1}),o.addEventListener("touchmove",this.touchmove),o.addEventListener("touchend",this.touchend),o.addEventListener("touchcancel",this.reset)}down(t,o){this.mouseRotate.mousedown(t,o),this.mousePitch&&this.mousePitch.mousedown(t,o),_t()}move(t,o){let c=this.map,d=this.mouseRotate.mousemoveWindow(t,o),p=d&&d.bearingDelta;if(p&&c.setBearing(c.getBearing()+p),this.mousePitch){let _=this.mousePitch.mousemoveWindow(t,o),x=_&&_.pitchDelta;x&&c.setPitch(c.getPitch()+x)}}off(){let t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Pt(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(n.h({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Ct(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Ct(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Ft(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=Ft(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function No(l,t,o){if(l=new n.ci(l.lng,l.lat),t){let c=new n.ci(l.lng-360,l.lat),d=new n.ci(l.lng+360,l.lat),p=360*Math.ceil(Math.abs(l.lng-o.center.lng)/360),_=o.locationPoint3D(l).distSqr(t),x=t.x<0||t.y<0||t.x>o.width||t.y>o.height;o.locationPoint3D(c).distSqr(t)<_&&(x||Math.abs(c.lng-o.center.lng)<p)?l=c:o.locationPoint3D(d).distSqr(t)<_&&(x||Math.abs(d.lng-o.center.lng)<p)&&(l=d)}for(;Math.abs(l.lng-o.center.lng)>180;){let c=o.locationPoint3D(l);if(c.x>=0&&c.y>=0&&c.x<=o.width&&c.y<=o.height)break;l.lng>o.center.lng?l.lng-=360:l.lng+=360}return l}let xo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},On={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class vo extends n.E{constructor(t,o){super(),(t instanceof HTMLElement||o)&&(t=n.h({element:t},o)),n.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);let{anchor:c="center",color:d="#3FB1CE",scale:p=1,draggable:_=!1,clickTolerance:x=0,rotation:b=On.rotation,rotationAlignment:M=On.rotationAlignment,pitchAlignment:C=On.pitchAlignment,occludedOpacity:z=On.occludedOpacity,altitude:P=On.altitude}=t||{};this._anchor=c,this._color=d,this._scale=p,this._draggable=_,this._clickTolerance=x,this._rotation=b,this._rotationAlignment=M,this._pitchAlignment=C,this._occludedOpacity=z,this._altitude=P,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=n.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=n.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",F=>{F.preventDefault()}),this._element.addEventListener("mousedown",F=>{F.preventDefault()});let D=this._element.classList;for(let F in xo)D.remove(`mapboxgl-marker-anchor-${F}`);D.add(`mapboxgl-marker-anchor-${this._anchor}`);let N=t&&t.className?t.className.trim().split(/\s+/):[];D.add(...N),this._popup=null}_createDefaultMarker(){let t=xe("div"),o=Ge("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){let c=Ge("radialGradient",{id:"shadowGradient"},Ge("defs",{},o));Ge("stop",{offset:"10%","stop-opacity":.4},c),Ge("stop",{offset:"100%","stop-opacity":.05},c),Ge("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},o)}return Ge("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},o),Ge("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},o),Ge("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},o),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){let t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=n.ci.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||On.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){let d=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){let o=t.code,c=t.charCode||t.keyCode;o!=="Space"&&o!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){let o=t.originalEvent.target,c=this._element;this._popup&&(o===c||c.contains(o))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){let t=this._map,o=this._pos;if(!t||!o)return!1;let c=t.unproject(o,this._altitude),d=t.getFreeCameraOptions();if(!d.position)return!1;let p=d.position.toLngLat();return p.distanceTo(c)<.9*p.distanceTo(this._lngLat)}_evaluateOpacity(){let t=this._map;if(!t)return;let o=this._pos;if(!o||o.x<0||o.x>t.transform.width||o.y<0||o.y>t.transform.height)return void this._clearFadeTimer();let c=t.unproject(o,this._altitude),d;t._showingGlobe()&&n.eW(t.transform,this._lngLat)?d=0:(d=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity=`${d}`,this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let t=this._pos;if(!t||!this._map)return;let o=this._offset.mult(this._scale);this._element.style.transform=`
=======
${c.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(D=D.replaceAll("gl_InstanceID","u_instanceID"));let N=x.createShader(x.FRAGMENT_SHADER);if(x.isContextLost())return void(this.failedToCreate=!0);x.shaderSource(N,P),x.compileShader(N),x.attachShader(this.program,N);let F=x.createShader(x.VERTEX_SHADER);if(x.isContextLost())this.failedToCreate=!0;else{x.shaderSource(F,D),x.compileShader(F),x.attachShader(this.program,F),this.attributes={},this.numAttributes=M.length;for(let j=0;j<this.numAttributes;j++)if(M[j]){let U=M[j].startsWith("a_")?M[j]:`a_${M[j]}`;x.bindAttribLocation(this.program,j,U),this.attributes[U]=j}x.linkProgram(this.program),x.deleteShader(F),x.deleteShader(N),this.fixedUniforms=p(t),this.binderUniforms=d?d.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(j=>({u_instanceID:new n.cd(j)}))(t)),(_.includes("TERRAIN")||o.indexOf("symbol")!==-1||o.indexOf("circle")!==-1)&&(this.terrainUniforms=(j=>({u_dem:new n.cd(j),u_dem_prev:new n.cd(j),u_dem_tl:new n.cg(j),u_dem_scale:new n.cf(j),u_dem_tl_prev:new n.cg(j),u_dem_scale_prev:new n.cf(j),u_dem_size:new n.cf(j),u_dem_lerp:new n.cf(j),u_exaggeration:new n.cf(j),u_depth:new n.cd(j),u_depth_size_inv:new n.cg(j),u_depth_range_unpack:new n.cg(j),u_occluder_half_size:new n.cf(j),u_occlusion_depth_offset:new n.cf(j),u_meter_to_dem:new n.cf(j),u_label_plane_matrix_inv:new n.ch(j)}))(t)),_.includes("GLOBE")&&(this.globeUniforms=(j=>({u_tile_tl_up:new n.ce(j),u_tile_tr_up:new n.ce(j),u_tile_br_up:new n.ce(j),u_tile_bl_up:new n.ce(j),u_tile_up_scale:new n.cf(j)}))(t)),_.includes("FOG")&&(this.fogUniforms=(j=>({u_fog_matrix:new n.ch(j),u_fog_range:new n.cg(j),u_fog_color:new n.d0(j),u_fog_horizon_blend:new n.cf(j),u_fog_vertical_limit:new n.cg(j),u_fog_temporal_offset:new n.cf(j),u_frustum_tl:new n.ce(j),u_frustum_tr:new n.ce(j),u_frustum_br:new n.ce(j),u_frustum_bl:new n.ce(j),u_globe_pos:new n.ce(j),u_globe_radius:new n.cf(j),u_globe_transition:new n.cf(j),u_is_globe:new n.cd(j),u_viewport:new n.cg(j)}))(t)),_.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(j=>({u_cutoff_params:new n.d0(j)}))(t)),_.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(j=>({u_lighting_ambient_color:new n.ce(j),u_lighting_directional_dir:new n.ce(j),u_lighting_directional_color:new n.ce(j),u_ground_radiance:new n.ce(j)}))(t)),_.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(j=>({u_light_matrix_0:new n.ch(j),u_light_matrix_1:new n.ch(j),u_fade_range:new n.cg(j),u_shadow_normal_offset:new n.ce(j),u_shadow_intensity:new n.cf(j),u_shadow_texel_size:new n.cf(j),u_shadow_map_resolution:new n.cf(j),u_shadow_direction:new n.ce(j),u_shadow_bias:new n.ce(j),u_shadowmap_0:new n.cd(j),u_shadowmap_1:new n.cd(j)}))(t))}}setTerrainUniformValues(t,o){if(!this.terrainUniforms)return;let c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d]&&c[d].set(this.program,d,o[d])}}setGlobeUniformValues(t,o){if(!this.globeUniforms)return;let c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d]&&c[d].set(this.program,d,o[d])}}setFogUniformValues(t,o){if(!this.fogUniforms)return;let c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d].set(this.program,d,o[d])}}setCutoffUniformValues(t,o){if(!this.cutoffUniforms)return;let c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d].set(this.program,d,o[d])}}setLightsUniformValues(t,o){if(!this.lightsUniforms)return;let c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let d in o)c[d].set(this.program,d,o[d])}}setShadowUniformValues(t,o){if(this.failedToCreate||!this.shadowUniforms)return;let c=this.shadowUniforms;t.program.set(this.program);for(let d in o)c[d].set(this.program,d,o[d])}_drawDebugWireframe(t,o,c,d,p,_,x,b,M,C){let z=t.options.wireframe;if(z.terrain===!1&&z.layers2D===!1&&z.layers3D===!1)return;let P=t.context;if(!(!(!z.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!z.layers2D||t._terrain&&t._terrain.renderingToTexture||!Od.includes(this.name))||!(!z.layers3D||!Jh.includes(this.name))))return;let D=P.gl,N=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,p,P);if(!N)return;let F=[...this.fixedDefines];F.push("DEBUG_WIREFRAME");let j=t.getOrCreateProgram(this.name,{config:this.configuration,defines:F});P.program.set(j.program);let U=(Q,ne,he)=>{if(ne[Q]&&he[Q])for(let de in ne[Q])he[Q][de]&&he[Q][de].set(he.program,de,ne[Q][de].current)};M&&M.setUniforms(j.program,P,j.binderUniforms,x,{zoom:b}),U("fixedUniforms",this,j),U("terrainUniforms",this,j),U("globeUniforms",this,j),U("fogUniforms",this,j),U("lightsUniforms",this,j),U("shadowUniforms",this,j),N.bind(),P.setColorMode(new ti([D.ONE,D.ONE_MINUS_SRC_ALPHA,D.ZERO,D.ONE],n.am.transparent,[!0,!0,!0,!1])),P.setDepthMode(new bt(o.func===D.LESS?D.LEQUAL:o.func,bt.ReadOnly,o.range)),P.setStencilMode(Gt.disabled);let Z=3*_.primitiveLength*2,Y=3*_.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){let Q=C||1;for(let ne=0;ne<Q;++ne)j.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ne),D.drawElements(D.LINES,Z,D.UNSIGNED_SHORT,Y)}else C&&C>1?D.drawElementsInstanced(D.LINES,Z,D.UNSIGNED_SHORT,Y,C):D.drawElements(D.LINES,Z,D.UNSIGNED_SHORT,Y);p.bind(),P.program.set(this.program),P.setDepthMode(o),P.setStencilMode(c),P.setColorMode(d)}checkUniforms(t,o,c){if(this.fixedDefines.includes(o)){for(let d of Object.keys(c))if(!c[d].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${d} not set but required by ${o} being defined`)}}draw(t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j){let U=t.context,Z=U.gl;if(this.failedToCreate)return;U.program.set(this.program),U.setDepthMode(c),U.setStencilMode(d),U.setColorMode(p),U.setCullFace(_);for(let ne of Object.keys(this.fixedUniforms))this.fixedUniforms[ne].set(this.program,ne,x[ne]);N&&N.setUniforms(this.program,U,this.binderUniforms,P,{zoom:D});let Y={[Z.POINTS]:1,[Z.LINES]:2,[Z.TRIANGLES]:3,[Z.LINE_STRIP]:1}[o];this.checkUniforms(b,"RENDER_SHADOWS",this.shadowUniforms);let Q=j&&j>0?1:void 0;for(let ne of z.get()){let he=ne.vaos||(ne.vaos={});if((he[b]||(he[b]=new gg)).bind(U,this,M,N?N.getPaintVertexBuffers():[],C,ne.vertexOffset,F||[],Q),this.forceManualRenderingForInstanceIDShaders){let de=j||1;for(let oe=0;oe<de;++oe)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",oe),C?Z.drawElements(o,ne.primitiveLength*Y,Z.UNSIGNED_SHORT,ne.primitiveOffset*Y*2):Z.drawArrays(o,ne.vertexOffset,ne.vertexLength)}else j&&j>1?Z.drawElementsInstanced(o,ne.primitiveLength*Y,Z.UNSIGNED_SHORT,ne.primitiveOffset*Y*2,j):C?Z.drawElements(o,ne.primitiveLength*Y,Z.UNSIGNED_SHORT,ne.primitiveOffset*Y*2):Z.drawArrays(o,ne.vertexOffset,ne.vertexLength);o===Z.TRIANGLES&&C&&this._drawDebugWireframe(t,c,d,p,C,ne,P,D,N,j)}}}function eu(l,t,o=0){let c=Math.pow(2,t.tileID.overscaledZ),d=t.tileSize*Math.pow(2,l.transform.tileZoom)/c,p=d*(t.tileID.canonical.x+t.tileID.wrap*c),_=d*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/n.aw(t,1,l.transform.tileZoom),u_pixel_coord_upper:[p>>16,_>>16],u_pixel_coord_lower:[65535&p,65535&_],u_pattern_transition:o}}let La={terrain:0,flat:1},kd=n.bz(),Fd=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U)=>{let Z=t.style.light,Y=Z.properties.get("position"),Q=[Y.x,Y.y,Y.z],ne=n.dJ();Z.properties.get("anchor")==="viewport"&&(n.dK(ne,-t.transform.angle),n.dL(Q,Q,ne));let he=Z.properties.get("color").toPremultipliedRenderColor(null),de=t.transform,oe={u_matrix:l,u_lightpos:Q,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[he.r,he.g,he.b],u_vertical_gradient:+o,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:kd,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:La[M],u_base_type:La[C],u_ao:d,u_edge_radius:p,u_width_scale:_,u_flood_light_color:N,u_vertical_scale:F,u_flood_light_intensity:j,u_ground_shadow_factor:U};return de.projection.name==="globe"&&(oe.u_tile_id=[x.canonical.x,x.canonical.y,1<<x.canonical.z],oe.u_zoom_transition=z,oe.u_inv_rot_matrix=D,oe.u_merc_center=P,oe.u_up_dir=de.projection.upVector(new n.cA(0,0,0),P[0]*n.aj,P[1]*n.aj),oe.u_height_lift=b),oe},tm=(l,t,o,c,d,p)=>({u_matrix:l,u_edge_radius:t,u_width_scale:o,u_vertical_scale:c,u_height_type:La[d],u_base_type:La[p]}),xl=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U)=>{let Z=Fd(l,t,o,c,d,p,_,x,M,C,z,P,D,N,F,j,1,[0,0,0]),Y={u_height_factor:-Math.pow(2,x.overscaledZ)/b.tileSize/8};return n.h(Z,eu(t,b,U),Y)},im=(l,t,o)=>({u_matrix:l,u_emissive_strength:t,u_ground_shadow_factor:o}),rm=(l,t,o,c,d,p=0)=>n.h(im(l,t,d),eu(o,c,p)),Ig=(l,t,o,c)=>({u_matrix:l,u_world:o,u_emissive_strength:t,u_ground_shadow_factor:c}),Ag=(l,t,o,c,d,p,_=0)=>n.h(rm(l,t,o,c,p,_),{u_world:d}),Mg=(l,t)=>({u_matrix:l,u_ground_shadow_factor:t}),tu=(l,t,o,c,d)=>({u_matrix:l,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:o,u_height_scale:c,u_reset_depth:d}),Bd=(l,t)=>({u_matrix:l,u_normal_matrix:t,u_opacity:1}),Nd=l=>({u_matrix:l}),nm=l=>({u_matrix:l}),vl=(l,t,o,c,d,p,_,x)=>{let b=n.aj/p.tileSize;return{u_matrix:l,u_inv_rot_matrix:t,u_camera_to_center_distance:o.getCameraToCenterDistance(x),u_extrude_scale:[o.pixelsToGLUnits[0]/b,o.pixelsToGLUnits[1]/b],u_zoom_transition:c,u_tile_id:_,u_merc_center:d}},Vd=(l,t,o=1)=>({u_matrix:l,u_color:t,u_overlay:0,u_overlay_scale:o}),om=n.bz(),sm=(l,t,o,c,d,p,_)=>{let x=l.transform,b=x.projection.name==="globe",M=b?n.dM(x.zoom,t.canonical)*x._pixelsPerMercatorPixel:n.aw(o,1,p),C={u_matrix:t.projMatrix,u_extrude_scale:M,u_intensity:_,u_inv_rot_matrix:om,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(b){C.u_inv_rot_matrix=c,C.u_merc_center=d,C.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],C.u_zoom_transition=n.ah(x.zoom);let z=d[0]*n.aj,P=d[1]*n.aj;C.u_up_dir=x.projection.upVector(new n.cA(0,0,0),z,P)}return C};function iu(l,[t,o,c,d],[p,_]){if(p===_)return[0,0,0,0];let x=255*(l-1)/(l*(_-p));return[t*x,o*x,c*x,d*x]}function Ks(l,t,[o,c]){return o===c?0:.5/l+(t-o)*(l-1)/(l*(c-o))}let Ud=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y,Q)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:M,u_fade_t:C.mix,u_opacity:C.opacity*z.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:z.paint.get("raster-brightness-min"),u_brightness_high:z.paint.get("raster-brightness-max"),u_saturation_factor:n.dO(z.paint.get("raster-saturation")),u_contrast_factor:n.dN(z.paint.get("raster-contrast")),u_spin_weights:Js(z.paint.get("raster-hue-rotate")),u_perspective_transform:P,u_raster_elevation:D,u_zoom_transition:_,u_merc_center:x,u_cutoff_params:b,u_colorization_mix:iu(n.dP,F,U),u_colorization_offset:Ks(n.dP,j,U),u_color_ramp:N,u_texture_offset:[Y/(Z+2*Y),Z/(Z+2*Y)],u_texture_res:[Z+2*Y,Z+2*Y],u_emissive_strength:Q});function Js(l){l*=Math.PI/180;let t=Math.sin(l),o=Math.cos(l);return[(2*o+1)/3,(-Math.sqrt(3)*t-o+1)/3,(Math.sqrt(3)*t-o+1)/3]}let Qs=.05,ru=(l,t,o,c,d,p,_,x,b,M,C,z)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:c,u_grid_matrix:d,u_tl_parent:p,u_scale_parent:M,u_fade_t:C.mix,u_opacity:C.opacity,u_image0:0,u_image1:1,u_raster_elevation:z,u_zoom_transition:_,u_merc_center:x,u_cutoff_params:b}),am=(l,t,o,c,d,p,_,x,b,M)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:o,u_velocity:c,u_color_ramp:p,u_velocity_res:d,u_max_speed:_,u_uv_offset:x,u_data_scale:[255*b[0],255*b[1]],u_data_offset:M,u_particle_pos_scale:1.1,u_particle_pos_offset:[Qs,Qs]}),lm=(l,t,o,c,d,p,_,x,b,M)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:o,u_velocity_res:c,u_max_speed:d,u_speed_factor:p,u_reset_rate:_,u_rand_seed:Math.random(),u_uv_offset:x,u_data_scale:[255*b[0],255*b[1]],u_data_offset:M,u_particle_pos_scale:1.1,u_particle_pos_offset:[Qs,Qs]}),nu=n.bz(),ou=(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y,Q,ne,he,de)=>{let oe=d.transform,se={u_is_size_zoom_constant:+(l==="constant"||l==="source"),u_is_size_feature_constant:+(l==="constant"||l==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:oe.getCameraToCenterDistance(Z),u_rotate_symbol:+o,u_aspect_ratio:oe.width/oe.height,u_fade_change:d.options.fadeDuration?d.symbolFadeChange:1,u_matrix:p,u_label_plane_matrix:_,u_coord_matrix:x,u_is_text:+M,u_elevation_from_sea:b?1:0,u_pitch_with_map:+c,u_texsize:C,u_texsize_icon:z,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:nu,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:nu,u_up_vector:[0,-1,0],u_color_adj_mat:ne,u_icon_transition:he||0,u_gamma_scale:c?d.transform.getCameraToCenterDistance(Z)*Math.cos(d.terrain?0:d.transform._pitch):1,u_device_pixel_ratio:n.q.devicePixelRatio,u_is_halo:1,u_scale_factor:de||1,u_ground_shadow_factor:Y,u_inv_matrix:n.bi(n.bz(),_),u_normal_scale:Q};return Z.name==="globe"&&(se.u_tile_id=[D.canonical.x,D.canonical.y,1<<D.canonical.z],se.u_zoom_transition=N,se.u_inv_rot_matrix=j,se.u_merc_center=F,se.u_camera_forward=oe._camera.forward(),se.u_ecef_origin=n.dQ(oe.globeMatrix,D.toUnwrapped()),se.u_tile_matrix=Float32Array.from(oe.globeMatrix),se.u_up_vector=U),se},cm=(l,t,o,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:o,u_color:c}),jd=(l,t,o,c,d,p,_,x,b)=>n.h(function(M,C,z,P,D,N){let{width:F,height:j}=P.imageManager.getPixelSize(C),U=Math.pow(2,N.tileID.overscaledZ),Z=N.tileSize*Math.pow(2,P.transform.tileZoom)/U,Y=Z*(N.tileID.canonical.x+N.tileID.wrap*U),Q=Z*N.tileID.canonical.y;return{u_image:0,u_pattern_tl:z.tl,u_pattern_br:z.br,u_texsize:[F,j],u_pattern_size:z.displaySize,u_pattern_units_to_pixels:D?[P.transform.width,-1*P.transform.height]:[1/n.aw(N,1,P.transform.tileZoom),1/n.aw(N,1,P.transform.tileZoom)],u_pixel_coord_upper:[Y>>16,Q>>16],u_pixel_coord_lower:[65535&Y,65535&Q]}}(0,p,_,c,x,b),{u_matrix:l,u_emissive_strength:t,u_opacity:o}),za=new Float32Array(n.bx([])),Gd=(l,t,o,c,d,p,_,x,b,M,C,z,P,D=[0,0,0],N)=>{let F=d.style.light,j=F.properties.get("position"),U=[-j.x,-j.y,j.z],Z=n.dJ();F.properties.get("anchor")==="viewport"&&(n.dK(Z,-d.transform.angle),n.dL(U,U,Z));let Y=C.alphaMode==="MASK",Q=F.properties.get("color").toNonPremultipliedRenderColor(null),ne=P.paint.get("model-ambient-occlusion-intensity"),he=P.paint.get("model-color").constantOr(n.am.white).toNonPremultipliedRenderColor(null);return he.a=P.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:o,u_node_matrix:c||za,u_lightpos:U,u_lightintensity:F.properties.get("intensity"),u_lightcolor:[Q.r,Q.g,Q.b],u_camera_pos:D,u_opacity:p,u_baseTextureIsAlpha:0,u_alphaMask:+Y,u_alphaCutoff:C.alphaCutoff,u_baseColorFactor:_.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:x.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:b,u_roughnessFactor:M,u_baseColorTexture:zn.BaseColor,u_metallicRoughnessTexture:zn.MetallicRoughness,u_normalTexture:zn.Normal,u_occlusionTexture:zn.Occlusion,u_emissionTexture:zn.Emission,u_lutTexture:zn.LUT,u_color_mix:he.toArray01(),u_aoIntensity:ne,u_emissive_strength:z,u_occlusionTextureTransform:N||[0,0,0,0]}},hm=(l,t=za,o=za)=>({u_matrix:l,u_instance:t,u_node_matrix:o}),um={fillExtrusion:l=>({u_matrix:new n.ch(l),u_lightpos:new n.ce(l),u_lightintensity:new n.cf(l),u_lightcolor:new n.ce(l),u_vertical_gradient:new n.cf(l),u_opacity:new n.cf(l),u_edge_radius:new n.cf(l),u_width_scale:new n.cf(l),u_ao:new n.cg(l),u_height_type:new n.cd(l),u_base_type:new n.cd(l),u_tile_id:new n.ce(l),u_zoom_transition:new n.cf(l),u_inv_rot_matrix:new n.ch(l),u_merc_center:new n.cg(l),u_up_dir:new n.ce(l),u_height_lift:new n.cf(l),u_flood_light_color:new n.ce(l),u_vertical_scale:new n.cf(l),u_flood_light_intensity:new n.cf(l),u_ground_shadow_factor:new n.ce(l)}),fillExtrusionDepth:l=>({u_matrix:new n.ch(l),u_edge_radius:new n.cf(l),u_width_scale:new n.cf(l),u_vertical_scale:new n.cf(l),u_height_type:new n.cd(l),u_base_type:new n.cd(l)}),fillExtrusionPattern:l=>({u_matrix:new n.ch(l),u_lightpos:new n.ce(l),u_lightintensity:new n.cf(l),u_lightcolor:new n.ce(l),u_vertical_gradient:new n.cf(l),u_height_factor:new n.cf(l),u_edge_radius:new n.cf(l),u_width_scale:new n.cf(l),u_ao:new n.cg(l),u_height_type:new n.cd(l),u_base_type:new n.cd(l),u_tile_id:new n.ce(l),u_zoom_transition:new n.cf(l),u_inv_rot_matrix:new n.ch(l),u_merc_center:new n.cg(l),u_up_dir:new n.ce(l),u_height_lift:new n.cf(l),u_image:new n.cd(l),u_texsize:new n.cg(l),u_pixel_coord_upper:new n.cg(l),u_pixel_coord_lower:new n.cg(l),u_tile_units_to_pixels:new n.cf(l),u_opacity:new n.cf(l),u_pattern_transition:new n.cf(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new n.ch(l),u_opacity:new n.cf(l),u_ao_pass:new n.cf(l),u_meter_to_tile:new n.cf(l),u_ao:new n.cg(l),u_flood_light_intensity:new n.cf(l),u_flood_light_color:new n.ce(l),u_attenuation:new n.cf(l),u_edge_radius:new n.cf(l),u_fb:new n.cd(l),u_fb_size:new n.cf(l),u_dynamic_offset:new n.cf(l)}),fill:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_ground_shadow_factor:new n.ce(l)}),fillPattern:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_image:new n.cd(l),u_texsize:new n.cg(l),u_pixel_coord_upper:new n.cg(l),u_pixel_coord_lower:new n.cg(l),u_tile_units_to_pixels:new n.cf(l),u_ground_shadow_factor:new n.ce(l),u_pattern_transition:new n.cf(l)}),fillOutline:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_world:new n.cg(l),u_ground_shadow_factor:new n.ce(l)}),fillOutlinePattern:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_world:new n.cg(l),u_image:new n.cd(l),u_texsize:new n.cg(l),u_pixel_coord_upper:new n.cg(l),u_pixel_coord_lower:new n.cg(l),u_tile_units_to_pixels:new n.cf(l),u_ground_shadow_factor:new n.ce(l),u_pattern_transition:new n.cf(l)}),building:l=>({u_matrix:new n.ch(l),u_normal_matrix:new n.ch(l),u_opacity:new n.cf(l)}),buildingBloom:l=>({u_matrix:new n.ch(l)}),buildingDepth:l=>({u_matrix:new n.ch(l)}),elevatedStructuresDepth:l=>({u_matrix:new n.ch(l),u_depth_bias:new n.cf(l)}),elevatedStructures:l=>({u_matrix:new n.ch(l),u_ground_shadow_factor:new n.ce(l)}),elevatedStructuresDepthReconstruct:l=>({u_matrix:new n.ch(l),u_camera_pos:new n.ce(l),u_depth_bias:new n.cf(l),u_height_scale:new n.cf(l),u_reset_depth:new n.cf(l)}),circle:n.dT,collisionBox:l=>({u_matrix:new n.ch(l),u_inv_rot_matrix:new n.ch(l),u_camera_to_center_distance:new n.cf(l),u_extrude_scale:new n.cg(l),u_zoom_transition:new n.cf(l),u_merc_center:new n.cg(l),u_tile_id:new n.ce(l)}),collisionCircle:l=>({u_matrix:new n.ch(l),u_inv_matrix:new n.ch(l),u_camera_to_center_distance:new n.cf(l),u_viewport_size:new n.cg(l)}),debug:l=>({u_color:new n.dv(l),u_matrix:new n.ch(l),u_overlay:new n.cd(l),u_overlay_scale:new n.cf(l)}),clippingMask:l=>({u_matrix:new n.ch(l)}),heatmap:l=>({u_extrude_scale:new n.cf(l),u_intensity:new n.cf(l),u_matrix:new n.ch(l),u_inv_rot_matrix:new n.ch(l),u_merc_center:new n.cg(l),u_tile_id:new n.ce(l),u_zoom_transition:new n.cf(l),u_up_dir:new n.ce(l)}),heatmapTexture:l=>({u_image:new n.cd(l),u_color_ramp:new n.cd(l),u_opacity:new n.cf(l)}),hillshade:l=>({u_matrix:new n.ch(l),u_image:new n.cd(l),u_latrange:new n.cg(l),u_light:new n.cg(l),u_shadow:new n.dv(l),u_highlight:new n.dv(l),u_emissive_strength:new n.cf(l),u_accent:new n.dv(l)}),hillshadePrepare:l=>({u_matrix:new n.ch(l),u_image:new n.cd(l),u_dimension:new n.cg(l),u_zoom:new n.cf(l)}),line:n.dS,linePattern:n.dR,raster:l=>({u_matrix:new n.ch(l),u_normalize_matrix:new n.ch(l),u_globe_matrix:new n.ch(l),u_merc_matrix:new n.ch(l),u_grid_matrix:new n.dw(l),u_tl_parent:new n.cg(l),u_scale_parent:new n.cf(l),u_fade_t:new n.cf(l),u_opacity:new n.cf(l),u_image0:new n.cd(l),u_image1:new n.cd(l),u_brightness_low:new n.cf(l),u_brightness_high:new n.cf(l),u_saturation_factor:new n.cf(l),u_contrast_factor:new n.cf(l),u_spin_weights:new n.ce(l),u_perspective_transform:new n.cg(l),u_raster_elevation:new n.cf(l),u_zoom_transition:new n.cf(l),u_merc_center:new n.cg(l),u_cutoff_params:new n.d0(l),u_colorization_mix:new n.d0(l),u_colorization_offset:new n.cf(l),u_color_ramp:new n.cd(l),u_texture_offset:new n.cg(l),u_texture_res:new n.cg(l),u_emissive_strength:new n.cf(l)}),rasterParticle:l=>({u_matrix:new n.ch(l),u_normalize_matrix:new n.ch(l),u_globe_matrix:new n.ch(l),u_merc_matrix:new n.ch(l),u_grid_matrix:new n.dw(l),u_tl_parent:new n.cg(l),u_scale_parent:new n.cf(l),u_fade_t:new n.cf(l),u_opacity:new n.cf(l),u_image0:new n.cd(l),u_image1:new n.cd(l),u_raster_elevation:new n.cf(l),u_zoom_transition:new n.cf(l),u_merc_center:new n.cg(l),u_cutoff_params:new n.d0(l)}),rasterParticleTexture:l=>({u_texture:new n.cd(l),u_opacity:new n.cf(l)}),rasterParticleDraw:l=>({u_particle_texture:new n.cd(l),u_particle_texture_side_len:new n.cf(l),u_tile_offset:new n.cg(l),u_velocity:new n.cd(l),u_color_ramp:new n.cd(l),u_velocity_res:new n.cg(l),u_max_speed:new n.cf(l),u_uv_offset:new n.cg(l),u_data_scale:new n.cg(l),u_data_offset:new n.cf(l),u_particle_pos_scale:new n.cf(l),u_particle_pos_offset:new n.cg(l)}),rasterParticleUpdate:l=>({u_particle_texture:new n.cd(l),u_particle_texture_side_len:new n.cf(l),u_velocity:new n.cd(l),u_velocity_res:new n.cg(l),u_max_speed:new n.cf(l),u_speed_factor:new n.cf(l),u_reset_rate:new n.cf(l),u_rand_seed:new n.cf(l),u_uv_offset:new n.cg(l),u_data_scale:new n.cg(l),u_data_offset:new n.cf(l),u_particle_pos_scale:new n.cf(l),u_particle_pos_offset:new n.cg(l)}),symbol:l=>({u_is_size_zoom_constant:new n.cd(l),u_is_size_feature_constant:new n.cd(l),u_size_t:new n.cf(l),u_size:new n.cf(l),u_camera_to_center_distance:new n.cf(l),u_rotate_symbol:new n.cd(l),u_aspect_ratio:new n.cf(l),u_fade_change:new n.cf(l),u_matrix:new n.ch(l),u_label_plane_matrix:new n.ch(l),u_coord_matrix:new n.ch(l),u_is_text:new n.cd(l),u_elevation_from_sea:new n.cd(l),u_pitch_with_map:new n.cd(l),u_texsize:new n.cg(l),u_texsize_icon:new n.cg(l),u_texture:new n.cd(l),u_texture_icon:new n.cd(l),u_gamma_scale:new n.cf(l),u_device_pixel_ratio:new n.cf(l),u_tile_id:new n.ce(l),u_zoom_transition:new n.cf(l),u_inv_rot_matrix:new n.ch(l),u_merc_center:new n.cg(l),u_camera_forward:new n.ce(l),u_tile_matrix:new n.ch(l),u_up_vector:new n.ce(l),u_ecef_origin:new n.ce(l),u_is_halo:new n.cd(l),u_icon_transition:new n.cf(l),u_color_adj_mat:new n.ch(l),u_scale_factor:new n.cf(l),u_ground_shadow_factor:new n.ce(l),u_inv_matrix:new n.ch(l),u_normal_scale:new n.cf(l)}),background:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_opacity:new n.cf(l),u_color:new n.dv(l)}),backgroundPattern:l=>({u_matrix:new n.ch(l),u_emissive_strength:new n.cf(l),u_opacity:new n.cf(l),u_image:new n.cd(l),u_pattern_tl:new n.cg(l),u_pattern_br:new n.cg(l),u_texsize:new n.cg(l),u_pattern_size:new n.cg(l),u_pixel_coord_upper:new n.cg(l),u_pixel_coord_lower:new n.cg(l),u_pattern_units_to_pixels:new n.cg(l)}),terrainRaster:l=>({u_matrix:new n.ch(l),u_image0:new n.cd(l),u_skirt_height:new n.cf(l),u_ground_shadow_factor:new n.ce(l)}),skybox:l=>({u_matrix:new n.ch(l),u_sun_direction:new n.ce(l),u_cubemap:new n.cd(l),u_opacity:new n.cf(l),u_temporal_offset:new n.cf(l)}),skyboxGradient:l=>({u_matrix:new n.ch(l),u_color_ramp:new n.cd(l),u_center_direction:new n.ce(l),u_radius:new n.cf(l),u_opacity:new n.cf(l),u_temporal_offset:new n.cf(l)}),skyboxCapture:l=>({u_matrix_3f:new n.dw(l),u_sun_direction:new n.ce(l),u_sun_intensity:new n.cf(l),u_color_tint_r:new n.d0(l),u_color_tint_m:new n.d0(l),u_luminance:new n.cf(l)}),globeRaster:l=>({u_proj_matrix:new n.ch(l),u_globe_matrix:new n.ch(l),u_normalize_matrix:new n.ch(l),u_merc_matrix:new n.ch(l),u_zoom_transition:new n.cf(l),u_merc_center:new n.cg(l),u_image0:new n.cd(l),u_grid_matrix:new n.dw(l),u_skirt_height:new n.cf(l),u_far_z_cutoff:new n.cf(l),u_frustum_tl:new n.ce(l),u_frustum_tr:new n.ce(l),u_frustum_br:new n.ce(l),u_frustum_bl:new n.ce(l),u_globe_pos:new n.ce(l),u_globe_radius:new n.cf(l),u_viewport:new n.cg(l)}),globeAtmosphere:l=>({u_frustum_tl:new n.ce(l),u_frustum_tr:new n.ce(l),u_frustum_br:new n.ce(l),u_frustum_bl:new n.ce(l),u_horizon:new n.cf(l),u_transition:new n.cf(l),u_fadeout_range:new n.cf(l),u_color:new n.d0(l),u_high_color:new n.d0(l),u_space_color:new n.d0(l),u_temporal_offset:new n.cf(l),u_horizon_angle:new n.cf(l)}),model:l=>({u_matrix:new n.ch(l),u_lighting_matrix:new n.ch(l),u_normal_matrix:new n.ch(l),u_node_matrix:new n.ch(l),u_lightpos:new n.ce(l),u_lightintensity:new n.cf(l),u_lightcolor:new n.ce(l),u_camera_pos:new n.ce(l),u_opacity:new n.cf(l),u_baseColorFactor:new n.d0(l),u_emissiveFactor:new n.d0(l),u_metallicFactor:new n.cf(l),u_roughnessFactor:new n.cf(l),u_baseTextureIsAlpha:new n.cd(l),u_alphaMask:new n.cd(l),u_alphaCutoff:new n.cf(l),u_baseColorTexture:new n.cd(l),u_metallicRoughnessTexture:new n.cd(l),u_normalTexture:new n.cd(l),u_occlusionTexture:new n.cd(l),u_emissionTexture:new n.cd(l),u_lutTexture:new n.cd(l),u_color_mix:new n.d0(l),u_aoIntensity:new n.cf(l),u_emissive_strength:new n.cf(l),u_occlusionTextureTransform:new n.d0(l)}),modelDepth:l=>({u_matrix:new n.ch(l),u_instance:new n.ch(l),u_node_matrix:new n.ch(l)}),groundShadow:l=>({u_matrix:new n.ch(l),u_ground_shadow_factor:new n.ce(l)}),stars:l=>({u_matrix:new n.ch(l),u_up:new n.ce(l),u_right:new n.ce(l),u_intensity_multiplier:new n.cf(l)}),snowParticle:l=>({u_modelview:new n.ch(l),u_projection:new n.ch(l),u_time:new n.cf(l),u_cam_pos:new n.ce(l),u_velocityConeAperture:new n.cf(l),u_velocity:new n.cf(l),u_horizontalOscillationRadius:new n.cf(l),u_horizontalOscillationRate:new n.cf(l),u_boxSize:new n.cf(l),u_billboardSize:new n.cf(l),u_simpleShapeParameters:new n.cg(l),u_screenSize:new n.cg(l),u_thinningCenterPos:new n.cg(l),u_thinningShape:new n.ce(l),u_thinningAffectedRatio:new n.cf(l),u_thinningParticleOffset:new n.cf(l),u_particleColor:new n.d0(l),u_direction:new n.ce(l)}),rainParticle:l=>({u_modelview:new n.ch(l),u_projection:new n.ch(l),u_time:new n.cf(l),u_cam_pos:new n.ce(l),u_texScreen:new n.cd(l),u_velocityConeAperture:new n.cf(l),u_velocity:new n.cf(l),u_boxSize:new n.cf(l),u_rainDropletSize:new n.cg(l),u_distortionStrength:new n.cf(l),u_rainDirection:new n.ce(l),u_color:new n.d0(l),u_screenSize:new n.cg(l),u_thinningCenterPos:new n.cg(l),u_thinningShape:new n.ce(l),u_thinningAffectedRatio:new n.cf(l),u_thinningParticleOffset:new n.cf(l),u_shapeDirectionalPower:new n.cf(l),u_shapeNormalPower:new n.cf(l),u_mode:new n.cf(l)}),vignette:l=>({u_vignetteShape:new n.ce(l),u_vignetteColor:new n.d0(l)}),occlusion:l=>({u_matrix:new n.ch(l),u_anchorPos:new n.ce(l),u_screenSizePx:new n.cg(l),u_occluderSizePx:new n.cg(l),u_color:new n.d0(l)})};class ea{constructor(t,o,c,d){this.id=ea.uniqueIdxCounter,ea.uniqueIdxCounter++,this.context=t;let p=t.gl;this.buffer=p.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),p.bufferData(p.ELEMENT_ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?p.DYNAMIC_DRAW:p.STATIC_DRAW),this.dynamicDraw||d||o.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=ea.uniqueIdxCounter,ea.uniqueIdxCounter++;let o=this.context.gl;this.context.unbindVAO(),this.bind(),o.bufferSubData(o.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}ea.uniqueIdxCounter=0;let qd={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Hd{constructor(t,o,c,d,p,_){this.length=o.length,this.attributes=c,this.itemSize=o.bytesPerElement,this.dynamicDraw=d,this.instanceCount=_,this.context=t;let x=t.gl;this.buffer=x.createBuffer(),t.bindVertexBuffer.set(this.buffer),x.bufferData(x.ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?x.DYNAMIC_DRAW:x.STATIC_DRAW),this.dynamicDraw||p||o.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){let o=this.context.gl;this.bind(),o.bufferSubData(o.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,o){for(let c=0;c<this.attributes.length;c++){let d=o.attributes[this.attributes[c].name];d!==void 0&&t.enableVertexAttribArray(d)}}setVertexAttribPointers(t,o,c){for(let d=0;d<this.attributes.length;d++){let p=this.attributes[d],_=o.attributes[p.name];_!==void 0&&t.vertexAttribPointer(_,p.components,t[qd[p.type]],!1,this.itemSize,p.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,o,c){for(let d=0;d<this.attributes.length;d++){let p=o.attributes[this.attributes[d].name];p!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(p,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Da{constructor(t,o,c,d,p){this.context=t,this.width=o,this.height=c;let _=this.framebuffer=t.gl.createFramebuffer();d&&(this.colorAttachment=new Eg(t,_)),p&&(this.depthAttachmentType=p,this.depthAttachment=p==="renderbuffer"?new Qf(t,_):new Cd(t,_))}destroy(){let t=this.context.gl;if(this.colorAttachment){let o=this.colorAttachment.get();o&&t.deleteTexture(o)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){let o=this.depthAttachment.get();o&&t.deleteRenderbuffer(o)}else{let o=this.depthAttachment.get();o&&t.deleteTexture(o)}t.deleteFramebuffer(this.framebuffer)}}class su{constructor(t,o){this.gl=t,this.clearColor=new xg(this),this.clearDepth=new vg(this),this.clearStencil=new bg(this),this.colorMask=new wg(this),this.depthMask=new Hf(this),this.stencilMask=new Tg(this),this.stencilFunc=new Uh(this),this.stencilOp=new Sg(this),this.stencilTest=new $f(this),this.depthRange=new Sd(this),this.depthTest=new jh(this),this.depthFunc=new Ed(this),this.blend=new Pa(this),this.blendFunc=new fl(this),this.blendColor=new Gh(this),this.blendEquation=new qh(this),this.cullFace=new ml(this),this.cullFaceSide=new Zf(this),this.frontFace=new Id(this),this.program=new Wf(this),this.activeTexture=new _l(this),this.viewport=new Hh(this),this.bindFramebuffer=new $h(this),this.bindRenderbuffer=new Ad(this),this.bindTexture=new Zh(this),this.bindVertexBuffer=new Oc(this),this.bindElementBuffer=new Xf(this),this.bindVertexArrayOES=new Yf(this),this.pixelStoreUnpack=new Kf(this),this.pixelStoreUnpackPremultiplyAlpha=new gl(this),this.pixelStoreUnpackFlipY=new Jf(this),this.options=o?Object.assign({},o):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=o&&!!o.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,o,c){return new ea(this,t,o,c)}createVertexBuffer(t,o,c,d,p){return new Hd(this,t,o,c,d,p)}createRenderbuffer(t,o,c){let d=this.gl,p=d.createRenderbuffer();return this.bindRenderbuffer.set(p),d.renderbufferStorage(d.RENDERBUFFER,t,o,c),this.bindRenderbuffer.set(null),p}createFramebuffer(t,o,c,d){return new Da(this,t,o,c,d)}clear({color:t,depth:o,stencil:c,colorMask:d}){let p=this.gl,_=0;t&&(_|=p.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(d||[!0,!0,!0,!0])),o!==void 0&&(_|=p.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(o),this.depthMask.set(!0)),c!==void 0&&(_|=p.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),p.clear(_)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){n.bv(t.blendFunction,ti.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let ta;function $d(l,t,o,c,d,p,_){let x=l.context,b=x.gl,M=l.transform,C=[n.aD(M.center.lng),n.aH(M.center.lat)],z=o.layout.get("symbol-placement"),P=o.layout.get("text-variable-anchor"),D=o.layout.get("icon-rotation-alignment")==="map",N=o.layout.get("text-rotation-alignment")==="map",F=z!=="point",j=[],U=0,Z=0;for(let se=0;se<c.length;se++){let le=c[se],Me=t.getTile(le),_e=Me.getBucket(o);if(!_e)continue;let Ve=_e.getProjection().createInversionMatrix(M,le.canonical),ze=[],je=Lf(le,_e,M),rt=!_&&D&&F,Ce=_&&N&&F,me=P&&_e.hasTextData(),ke=_e.hasIconTextFit()&&me&&_e.hasIconData(),Pe=rt||Ce||_&&me||ke,$e=_e.projection.name==="globe",Ze=$e?n.ah(M.zoom):0;$e&&(ze.push("PROJECTION_GLOBE_VIEW"),Pe&&ze.push("PROJECTED_POS_ON_VIEWPORT"));let Ye=l.getOrCreateProgram("collisionBox",{defines:ze}),ct=je;d[0]===0&&d[1]===0||(ct=l.translatePosMatrix(je,Me,d,p));let Mt=_?_e.textCollisionBox:_e.iconCollisionBox,Ot=_e.collisionCircleArray;if(Ot.length>0){let zt=n.bz(),Rt=ct;n.cM(zt,_e.placementInvProjMatrix,M.glCoordMatrix),n.cM(zt,zt,_e.placementViewportMatrix),j.push({circleArray:Ot,circleOffset:Z,transform:Rt,invTransform:zt,projection:_e.getProjection()}),U+=Ot.length/4,Z=U}if(!Mt)continue;l.terrain&&l.terrain.setupElevationDraw(Me,Ye);let yt=$e?[le.canonical.x,le.canonical.y,1<<le.canonical.z]:[0,0,0];Ye.draw(l,b.LINES,bt.disabled,Gt.disabled,l.colorModeForRenderPass(),Nt.disabled,vl(ct,Ve,M,Ze,C,Me,yt,_e.getProjection()),o.id,Mt.layoutVertexBuffer,Mt.indexBuffer,Mt.segments,null,M.zoom,null,[Mt.collisionVertexBuffer,Mt.collisionVertexBufferExt])}if(!_||!j.length)return;let Y=l.getOrCreateProgram("collisionCircle"),Q=new n.dU;Q.resize(4*U),Q._trim();let ne=0;for(let se of j)for(let le=0;le<se.circleArray.length/4;le++){let Me=4*le,_e=se.circleArray[Me+0],Ve=se.circleArray[Me+1],ze=se.circleArray[Me+2],je=se.circleArray[Me+3];Q.emplace(ne++,_e,Ve,ze,je,0),Q.emplace(ne++,_e,Ve,ze,je,1),Q.emplace(ne++,_e,Ve,ze,je,2),Q.emplace(ne++,_e,Ve,ze,je,3)}(!ta||ta.length<2*U)&&(ta=function(se){let le=2*se,Me=new n.a_;Me.resize(le),Me._trim();for(let _e=0;_e<le;_e++){let Ve=6*_e;Me.uint16[Ve+0]=4*_e+0,Me.uint16[Ve+1]=4*_e+1,Me.uint16[Ve+2]=4*_e+2,Me.uint16[Ve+3]=4*_e+2,Me.uint16[Ve+4]=4*_e+3,Me.uint16[Ve+5]=4*_e+0}return Me}(U));let he=x.createIndexBuffer(ta,!0),de=x.createVertexBuffer(Q,n.dV.members,!0);for(let se of j){let le={u_matrix:se.transform,u_inv_matrix:se.invTransform,u_camera_to_center_distance:(oe=M).getCameraToCenterDistance(se.projection),u_viewport_size:[oe.width,oe.height]};Y.draw(l,b.TRIANGLES,bt.disabled,Gt.disabled,l.colorModeForRenderPass(),Nt.disabled,le,o.id,de,he,n.bd.simpleSegment(0,2*se.circleOffset,se.circleArray.length,se.circleArray.length/2),null,M.zoom)}var oe;de.destroy(),he.destroy()}let Oa=n.bz();function Bc(l){let t=l._camera.getWorldToCamera(l.worldSize,1),o=n.az([],t,l.globeMatrix);n.bi(o,o);let c=[0,0,0],d=[0,1,0,0];return n.aA(d,d,o),c[0]=d[0],c[1]=d[1],c[2]=d[2],n.au(c,c),c}function Zd({width:l,height:t,anchor:o,textOffset:c,textScale:d},p){let{horizontalAlign:_,verticalAlign:x}=n.bZ(o),b=-(_-.5)*l,M=-(x-.5)*t,C=n.b_(o,c);return new n.P((b/d+C[0])*p,(M/d+C[1])*p)}function dm(l,t,o,c,d,p,_,x,b,M){let C=l.text.placedSymbolArray,z=l.text.dynamicLayoutVertexArray,P=l.icon.dynamicLayoutVertexArray,D={},N=l.getProjection(),F=Ch(_,N,d),j=d.elevation,U=N.upVectorScale(_.canonical,d.center.lat,d.worldSize).metersToTile;z.clear();for(let Z=0;Z<C.length;Z++){let Y=C.get(Z),{tileAnchorX:Q,tileAnchorY:ne,numGlyphs:he}=Y,de=Y.hidden||!Y.crossTileID||l.allowVerticalPlacement&&!Y.placedOrientation?null:c[Y.crossTileID];if(de){let oe=0,se=0,le=0;if(j){let ke=j?j.getAtTileOffset(_,Q,ne):0,[Pe,$e,Ze]=N.upVector(_.canonical,Q,ne);oe=ke*Pe*U,se=ke*$e*U,le=ke*Ze*U}let[Me,_e,Ve,ze]=mo(Y.projectedAnchorX+oe,Y.projectedAnchorY+se,Y.projectedAnchorZ+le,o?F:p),je=ud(d.getCameraToCenterDistance(N),ze),rt=n.bJ(l.textSizeData,b,Y)*je/n.bU;o&&(rt*=l.tilePixelRatio/x);let Ce=Zd(de,rt);o?({x:Me,y:_e,z:Ve}=N.projectTilePoint(Q+Ce.x,ne+Ce.y,_.canonical),[Me,_e,Ve]=mo(Me+oe,_e+se,Ve+le,p)):(t&&Ce._rotate(-d.angle),Me+=Ce.x,_e+=Ce.y,Ve=0);let me=l.allowVerticalPlacement&&Y.placedOrientation===n.bI.vertical?Math.PI/2:0;for(let ke=0;ke<he;ke++)n.bL(z,Me,_e,Ve,me);M&&Y.associatedIconIndex>=0&&(D[Y.associatedIconIndex]={x:Me,y:_e,z:Ve,angle:me})}else ol(he,z)}if(M){P.clear();let Z=l.icon.placedSymbolArray;for(let Y=0;Y<Z.length;Y++){let Q=Z.get(Y),{numGlyphs:ne}=Q,he=D[Y];if(Q.hidden||!he)ol(ne,P);else{let{x:de,y:oe,z:se,angle:le}=he;for(let Me=0;Me<ne;Me++)n.bL(P,de,oe,se,le)}}l.icon.dynamicLayoutVertexBuffer.updateData(P)}l.text.dynamicLayoutVertexBuffer.updateData(z)}function Wd(l,t,o,c,d,p,_={}){let x=o.paint.get("icon-translate"),b=o.paint.get("text-translate"),M=o.paint.get("icon-translate-anchor"),C=o.paint.get("text-translate-anchor"),z=o.layout.get("icon-rotation-alignment"),P=o.layout.get("text-rotation-alignment"),D=o.layout.get("icon-pitch-alignment"),N=o.layout.get("text-pitch-alignment"),F=o.layout.get("icon-keep-upright"),j=o.layout.get("text-keep-upright"),U=o.paint.get("icon-color-saturation"),Z=o.paint.get("icon-color-contrast"),Y=o.paint.get("icon-color-brightness-min"),Q=o.paint.get("icon-color-brightness-max"),ne=o.layout.get("symbol-elevation-reference")==="sea",he=l.context,de=he.gl,oe=l.transform,se=z==="map",le=P==="map",Me=D==="map",_e=N==="map",Ve=o.layout.get("symbol-sort-key").constantOr(1)!==void 0,ze=!1,je=l.depthModeForSublayer(0,bt.ReadOnly),rt=new bt(l.context.gl.LEQUAL,bt.ReadOnly,l.depthRangeFor3D),Ce=[n.aD(oe.center.lng),n.aH(oe.center.lat)],me=o.layout.get("text-variable-anchor"),ke=oe.projection.name==="globe",Pe=[],$e=[0,-1,0];for(let Ze of c){let Ye=t.getTile(Ze),ct=Ye.getBucket(o);if(!ct||ct.projection.name==="mercator"&&ke||ct.fullyClipped)continue;let Mt=ct.projection.name==="globe",Ot=Mt?n.ah(oe.zoom):0,yt=Ch(Ze,ct.getProjection(),oe),zt=oe.calculatePixelsToTileUnitsMatrix(Ye),Rt=me&&ct.hasTextData(),$t=ct.hasIconTextFit()&&Rt&&ct.hasIconData(),Jt=ct.getProjection().createInversionMatrix(oe,Ze.canonical),ai=(1<<Ye.tileID.canonical.z)*n.aj/l.transform.worldSize,Ti=Vi=>{let Ci=[0,0,0];if(Vi){let yr=l.style.directionalLight,bi=l.style.ambientLight;yr&&bi&&(Ci=Ma(l.style,yr,bi))}return Ci},Yt=Vi=>{oe.depthOcclusionForSymbolsAndCircles&&(o.hasInitialOcclusionOpacityProperties||l.terrain)&&(Vi.push("DEPTH_D24"),Vi.push("DEPTH_OCCLUSION"))},Si=()=>{let Vi=se&&o.layout.get("symbol-placement")!=="point",Ci=[];Yt(Ci);let yr=Vi||$t,bi=ct.elevationType==="road",Li=l.shadowRenderer,$i=bi&&Me&&!!Li&&Li.enabled,kr=Ti($i),Dr=bi&&Me&&!l.terrain?rt:je,Br=o.paint.get("icon-image-cross-fade");l.terrainRenderModeElevated()&&Me&&Ci.push("PITCH_WITH_MAP_TERRAIN"),Mt&&(Ci.push("PROJECTION_GLOBE_VIEW"),yr&&Ci.push("PROJECTED_POS_ON_VIEWPORT")),Br>0&&ct.hasAnySecondaryIcon&&Ci.push("ICON_TRANSITION"),!ct.icon.zOffsetVertexBuffer||bi&&l.terrain||Ci.push("Z_OFFSET"),U===0&&Z===0&&Y===0&&Q===1||Ci.push("COLOR_ADJUSTMENT"),ct.sdfIcons&&Ci.push("RENDER_SDF"),$i&&Ci.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),bi&&Me&&!l.terrain&&ct.icon.orientationVertexBuffer&&Ci.push("ELEVATED_ROADS");let hn=ct.icon.programConfigurations.get(o.id),Jo=l.getOrCreateProgram("symbol",{config:hn,defines:Ci}),kn=Ye.imageAtlasTexture?Ye.imageAtlasTexture.size:[0,0],eo=ct.iconSizeData,yn=n.bH(eo,oe.zoom),bo=Me||!oe.isOrthographic,Vo=wc(yt,Ye.tileID.canonical,Me,se,oe,ct.getProjection(),zt),xn=As(yt,Ye.tileID.canonical,Me,se,oe,ct.getProjection(),zt),Cr=l.translatePosMatrix(xn,Ye,x,M,!0),Sr=l.translatePosMatrix(yt,Ye,x,M),Ki=yr?Oa:Vo,Wr=se&&!Me&&!Vi,un=$e;!ke&&!oe.mercatorFromTransition||se||(un=Bc(oe));let Pr=Mt?un:$e,wo=o.getColorAdjustmentMatrix(U,Z,Y,Q),Na=ou(eo.kind,yn,Wr,Me,l,Sr,Ki,Cr,ne,!1,kn,[0,0],0,Ze,Ot,Ce,Jt,Pr,ct.getProjection(),kr,ai,wo,Br,null),la=Ye.imageAtlasTexture?Ye.imageAtlasTexture:null,Ol=o.layout.get("icon-size").constantOr(0)!==1||ct.iconsNeedLinear,kl=ct.sdfIcons||l.options.rotating||l.options.zooming||Ol||bo?de.LINEAR:de.NEAREST,To=ct.sdfIcons&&o.paint.get("icon-halo-width").constantOr(1)!==0,us=l.terrain&&Me&&Vi?n.bi(n.bz(),Vo):Oa;if(Vi&&ct.icon){let Xr=oe.elevation,So=Xr?Xr.getAtTileOffsetFunc(Ze,oe.center.lat,oe.worldSize,ct.getProjection()):null,Va=nl(yt,Ye.tileID.canonical,Me,se,oe,ct.getProjection(),zt);Ea(ct,yt,l,!1,Va,xn,Me,F,So,Ze)}return{program:Jo,buffers:ct.icon,uniformValues:Na,atlasTexture:la,atlasTextureIcon:null,atlasInterpolation:kl,atlasInterpolationIcon:null,isSDF:ct.sdfIcons,hasHalo:To,depthMode:Dr,tile:Ye,renderWithShadows:$i,labelPlaneMatrixInv:us}},Mi=()=>{let Vi=le&&o.layout.get("symbol-placement")!=="point",Ci=[],yr=Vi||me||$t,bi=ct.elevationType==="road",Li=l.shadowRenderer,$i=bi&&_e&&!!Li&&Li.enabled,kr=Ti($i),Dr=bi&&_e&&!l.terrain?rt:je;l.terrainRenderModeElevated()&&_e&&Ci.push("PITCH_WITH_MAP_TERRAIN"),Mt&&(Ci.push("PROJECTION_GLOBE_VIEW"),yr&&Ci.push("PROJECTED_POS_ON_VIEWPORT")),!ct.text.zOffsetVertexBuffer||bi&&l.terrain||Ci.push("Z_OFFSET"),ct.iconsInText&&Ci.push("RENDER_TEXT_AND_SYMBOL"),Ci.push("RENDER_SDF"),$i&&Ci.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),bi&&_e&&!l.terrain&&ct.text.orientationVertexBuffer&&Ci.push("ELEVATED_ROADS"),Yt(Ci);let Br=ct.text.programConfigurations.get(o.id),hn=l.getOrCreateProgram("symbol",{config:Br,defines:Ci}),Jo,kn=[0,0],eo=null,yn=ct.textSizeData;ct.iconsInText&&(kn=Ye.imageAtlasTexture?Ye.imageAtlasTexture.size:[0,0],eo=Ye.imageAtlasTexture?Ye.imageAtlasTexture:null,Jo=_e||!oe.isOrthographic||l.options.rotating||l.options.zooming||yn.kind==="composite"||yn.kind==="camera"?de.LINEAR:de.NEAREST);let bo=Ye.glyphAtlasTexture?Ye.glyphAtlasTexture.size:[0,0],Vo=o.layout.get("text-size-scale-range"),xn=n.ay(l.scaleFactor,Vo[0],Vo[1]),Cr=n.bH(yn,oe.zoom,xn),Sr=wc(yt,Ye.tileID.canonical,_e,le,oe,ct.getProjection(),zt),Ki=As(yt,Ye.tileID.canonical,_e,le,oe,ct.getProjection(),zt),Wr=l.translatePosMatrix(Ki,Ye,b,C,!0),un=l.translatePosMatrix(yt,Ye,b,C),Pr=yr?Oa:Sr,wo=le&&!_e&&!Vi,Na=$e;!ke&&!oe.mercatorFromTransition||le||(Na=Bc(oe));let la=ou(yn.kind,Cr,wo,_e,l,un,Pr,Wr,ne,!0,bo,kn,0,Ze,Ot,Ce,Jt,Mt?Na:$e,ct.getProjection(),kr,ai,null,null,xn),Ol=Ye.glyphAtlasTexture?Ye.glyphAtlasTexture:null,kl=de.LINEAR,To=o.paint.get("text-halo-width").constantOr(1)!==0,us=l.terrain&&_e&&Vi?n.bi(n.bz(),Sr):Oa;if(Vi&&ct.text){let Xr=oe.elevation,So=Xr?Xr.getAtTileOffsetFunc(Ze,oe.center.lat,oe.worldSize,ct.getProjection()):null,Va=nl(yt,Ye.tileID.canonical,_e,le,oe,ct.getProjection(),zt);Ea(ct,yt,l,!0,Va,Ki,_e,j,So,Ze)}return{program:hn,buffers:ct.text,uniformValues:la,atlasTexture:Ol,atlasTextureIcon:eo,atlasInterpolation:kl,atlasInterpolationIcon:Jo,isSDF:!0,hasHalo:To,depthMode:Dr,tile:Ye,renderWithShadows:$i,labelPlaneMatrixInv:us}},Wi=ct.icon.segments.get().length,ni=ct.text.segments.get().length,Ei=Wi&&!_.onlyText?Si():null,Ii=ni&&!_.onlyIcons?Mi():null,Ri=o.paint.get("icon-opacity").constantOr(1),li=o.paint.get("text-opacity").constantOr(1);if(Ve&&ct.canOverlap){ze=!0;let Vi=Ri&&!_.onlyText?ct.icon.segments.get():[],Ci=li&&!_.onlyIcons?ct.text.segments.get():[];for(let yr of Vi)Pe.push({segments:new n.bd([yr]),sortKey:yr.sortKey,state:Ei});for(let yr of Ci)Pe.push({segments:new n.bd([yr]),sortKey:yr.sortKey,state:Ii})}else _.onlyText||Pe.push({segments:Ri?ct.icon.segments:new n.bd([]),sortKey:0,state:Ei}),_.onlyIcons||Pe.push({segments:li?ct.text.segments:new n.bd([]),sortKey:0,state:Ii})}ze&&Pe.sort((Ze,Ye)=>Ze.sortKey-Ye.sortKey);for(let Ze of Pe){let Ye=Ze.state;if(Ye)if(l.terrain?l.terrain.setupElevationDraw(Ye.tile,Ye.program,{useDepthForOcclusion:oe.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Ye.labelPlaneMatrixInv}):l.setupDepthForOcclusion(oe.depthOcclusionForSymbolsAndCircles,Ye.program),he.activeTexture.set(de.TEXTURE0),Ye.atlasTexture&&Ye.atlasTexture.bind(Ye.atlasInterpolation,de.CLAMP_TO_EDGE,!0),Ye.atlasTextureIcon&&(he.activeTexture.set(de.TEXTURE1),Ye.atlasTextureIcon&&Ye.atlasTextureIcon.bind(Ye.atlasInterpolationIcon,de.CLAMP_TO_EDGE,!0)),Ye.renderWithShadows&&l.shadowRenderer.setupShadows(Ye.tile.tileID.toUnwrapped(),Ye.program,"vector-tile"),l.uploadCommonLightUniforms(l.context,Ye.program),Ye.hasHalo){let ct=Ye.uniformValues;ct.u_is_halo=1,ia(Ye.buffers,Ze.segments,o,l,Ye.program,Ye.depthMode,d,p,ct,2),ct.u_is_halo=0}else{if(Ye.isSDF){let ct=Ye.uniformValues;Ye.hasHalo&&(ct.u_is_halo=1,ia(Ye.buffers,Ze.segments,o,l,Ye.program,Ye.depthMode,d,p,ct,1)),ct.u_is_halo=0}ia(Ye.buffers,Ze.segments,o,l,Ye.program,Ye.depthMode,d,p,Ye.uniformValues,1)}}}function ia(l,t,o,c,d,p,_,x,b,M){let C=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer,l.orientationVertexBuffer];d.draw(c,c.context.gl.TRIANGLES,p,_,x,Nt.disabled,b,o.id,l.layoutVertexBuffer,l.indexBuffer,t,o.paint,c.transform.zoom,l.programConfigurations.get(o.id),C,M)}function Nc(l,t){let o=1<<l.canonical.z,c=(t.x*o-l.canonical.x-l.wrap*o)*n.aj,d=(t.y*o-l.canonical.y)*n.aj,p=n.e2(t.z,t.y);return n.d2(c,d,p)}function Tt(l,t,o,c,d){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let p=l.context.gl,_=new bt(l.context.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),x=new bt(l.context.gl.GREATER,bt.ReadWrite,l.depthRangeFor3D),b=function(D){let N=n.cU(D.pitch),F=.01;return D.isOrthographic&&(F=n.ai(1e-4,F,n.cZ(N>=cn?1:N/cn))),2*F}(l.transform),M=l.transform.getFreeCameraOptions().position,C="elevatedStructuresDepthReconstruct",z=l.getOrCreateProgram(C,{defines:["DEPTH_RECONSTRUCTION"]}),P=l.getOrCreateProgram(C);for(let D of c){let N=t.getTile(D),F=N.getBucket(o);if(!F)continue;let j=F.elevatedStructures;if(!j)continue;let U=F.elevationBufferData.heightRange,Z=Nc(D.toUnwrapped(),M),Y=l.translatePosMatrix(D.projMatrix,N,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),Q,ne,he,de;if(d==="initialize"){if(!U||U.min>=1||j.depthSegments.segments[0].primitiveLength===0)continue;Q=tu(Y,Z,b,1,0),ne=_,he=j.depthSegments,de=z}else if(d==="reset"){if(!U||U.min>=0||j.maskSegments.segments[0].primitiveLength===0)continue;Q=tu(Y,Z,0,0,1),ne=x,he=j.maskSegments,de=z}else if(d==="geometry"){if(j.depthSegments.segments[0].primitiveLength===0)continue;Q=tu(Y,Z,b,1,0),ne=_,he=j.depthSegments,de=P}de.draw(l,p.TRIANGLES,ne,Gt.disabled,ti.disabled,Nt.disabled,Q,o.id,j.vertexBuffer,j.indexBuffer,he,o.paint,l.transform.zoom)}}function au(l,t,o){let{painter:c,sourceCache:d,layer:p,coords:_,colorMode:x,elevationType:b,terrainEnabled:M,pass:C}=l,z=c.context.gl,P=p.paint.get("fill-pattern"),D=p.paint.get("fill-pattern-cross-fade"),N=P.constantOr(null),F=b;b!=="road"||t&&!M||(F="none");let j=F==="road",U=l.painter.shadowRenderer,Z=j&&!!U&&U.enabled,Y=new bt(c.context.gl.LEQUAL,bt.ReadOnly,c.depthRangeFor3D),Q=[0,0,0];if(Z){let de=c.style.directionalLight,oe=c.style.ambientLight;de&&oe&&(Q=Ma(c.style,de,oe))}let ne=P&&P.constantOr(1),he=(de,oe)=>{let se,le,Me,_e,Ve;oe?(se=ne&&!p.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Me=z.LINES):(se=ne?"fillPattern":"fill",Me=z.TRIANGLES);for(let ze of _){let je=d.getTile(ze);if(ne&&!je.patternsLoaded())continue;let rt=je.getBucket(p);if(!rt)continue;let Ce=t?rt.elevationBufferData:rt.bufferData;if(Ce.isEmpty())continue;c.prepareDrawTile();let me=Ce.programConfigurations.get(p.id),ke=c.isTileAffectedByFog(ze),Pe=[],$e=[];j&&(Pe.push("ELEVATED_ROADS"),$e.push(Ce.elevatedLayoutVertexBuffer)),Z&&Pe.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ne&&(c.context.activeTexture.set(z.TEXTURE0),je.imageAtlasTexture&&je.imageAtlasTexture.bind(z.LINEAR,z.CLAMP_TO_EDGE),me.updatePaintBuffers());let Ze=!1;if(N&&je.imageAtlas){let yt=je.imageAtlas,zt=n.dZ.from(N),Rt=zt.getPrimary().scaleSelf(n.q.devicePixelRatio).toString(),$t=zt.getSecondary(),Jt=yt.patternPositions.get(Rt),ai=$t?yt.patternPositions.get($t.scaleSelf(n.q.devicePixelRatio).toString()):null;Ze=!!Jt&&!!ai,Jt&&me.setConstantPatternPositions(Jt,ai)}D>0&&(Ze||me.getPatternTransitionVertexBuffer("fill-pattern"))&&Pe.push("FILL_PATTERN_TRANSITION");let Ye=c.getOrCreateProgram(se,{config:me,overrideFog:ke,defines:Pe}),ct=c.translatePosMatrix(ze.projMatrix,je,p.paint.get("fill-translate"),p.paint.get("fill-translate-anchor"));Z&&U.setupShadows(je.tileID.toUnwrapped(),Ye,"vector-tile");let Mt=p.paint.get("fill-emissive-strength");if(oe){_e=Ce.lineIndexBuffer,Ve=Ce.lineSegments;let yt=c.terrain&&c.terrain.renderingToTexture?c.terrain.drapeBufferSize:[z.drawingBufferWidth,z.drawingBufferHeight];le=se==="fillOutlinePattern"&&ne?Ag(ct,Mt,c,je,yt,Q,D):Ig(ct,Mt,yt,Q)}else _e=Ce.indexBuffer,Ve=Ce.triangleSegments,le=ne?rm(ct,Mt,c,je,Q,D):im(ct,Mt,Q);c.uploadCommonUniforms(c.context,Ye,ze.toUnwrapped());let Ot=de;(b==="road"&&!M||b==="offset")&&(Ot=Y),Ye.draw(c,Me,Ot,o||c.stencilModeForClipping(ze),x,Nt.disabled,le,p.id,Ce.layoutVertexBuffer,_e,Ve,p.paint,c.transform.zoom,me,$e)}};c.renderPass===C&&he(c.depthModeForSublayer(1,c.renderPass==="opaque"?bt.ReadWrite:bt.ReadOnly),!1),F==="none"&&c.renderPass==="translucent"&&p.paint.get("fill-antialias")&&he(c.depthModeForSublayer(p.getPaintProperty("fill-outline-color")?2:0,bt.ReadOnly),!0)}function Vc(l,t,o,c,d,p,_,x){o.resetLayerRenderingStats(l);let b=l.context,M=b.gl,C=l.transform,z=o.paint.get("fill-extrusion-pattern"),P=o.paint.get("fill-extrusion-pattern-cross-fade"),D=z.constantOr(null),N=z.constantOr(1),F=o.paint.get("fill-extrusion-opacity"),j=l.style.enable3dLights(),U=o.paint.get(j&&!N?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Z=[o.paint.get("fill-extrusion-ambient-occlusion-intensity"),U],Y=o.layout.get("fill-extrusion-edge-radius"),Q=Y>0&&!o.paint.get("fill-extrusion-rounded-roof"),ne=Q?0:Y,he=C.projection.name==="globe"?n.e5():0,de=C.projection.name==="globe",oe=de?n.ah(C.zoom):0,se=[n.aD(C.center.lng),n.aH(C.center.lat)],le=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Me=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(le?null:o.lut).toArray01().slice(0,3),_e=o.paint.get("fill-extrusion-flood-light-intensity"),Ve=o.paint.get("fill-extrusion-vertical-scale"),ze=o.paint.get("fill-extrusion-line-width").constantOr(1)!==0,je=o.paint.get("fill-extrusion-height-alignment"),rt=o.paint.get("fill-extrusion-base-alignment"),Ce=ss(l,o.paint.get("fill-extrusion-cutoff-fade-range")),me=[],ke;de&&me.push("PROJECTION_GLOBE_VIEW"),Z[0]>0&&me.push("FAUX_AO"),Q&&me.push("ZERO_ROOF_RADIUS"),x&&me.push("HAS_CENTROID"),_e>0&&me.push("FLOOD_LIGHT"),Ce.shouldRenderCutoff&&me.push("RENDER_CUTOFF"),ze&&me.push("RENDER_WALL_MODE");let Pe=l.renderPass==="shadow",$e=l.shadowRenderer,Ze=Pe&&!!$e,Ye=Pe?Nt.disabled:Nt.backCCW;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let ct=[0,0,0];if($e){let yt=l.style.directionalLight,zt=l.style.ambientLight;yt&&zt&&(ct=Ma(l.style,yt,zt)),Pe||(me.push("RENDER_SHADOWS","DEPTH_TEXTURE"),$e.useNormalOffset&&me.push("NORMAL_OFFSET")),ke=me.concat(["SHADOWS_SINGLE_CASCADE"])}let Mt=Ze?"fillExtrusionDepth":N?"fillExtrusionPattern":"fillExtrusion",Ot=o.getLayerRenderingStats();for(let yt of c){let zt=t.getTile(yt),Rt=zt.getBucket(o);if(!Rt||Rt.projection.name!==C.projection.name)continue;let $t=!1;$e&&($t=$e.getMaxCascadeForTile(yt.toUnwrapped())===0);let Jt=l.isTileAffectedByFog(yt),ai=Rt.programConfigurations.get(o.id),Ti=!1;if(D&&zt.imageAtlas){let Ii=zt.imageAtlas,Ri=n.dZ.from(D),li=Ri.getPrimary().scaleSelf(n.q.devicePixelRatio).toString(),Vi=Ri.getSecondary(),Ci=Ii.patternPositions.get(li),yr=Vi?Ii.patternPositions.get(Vi.scaleSelf(n.q.devicePixelRatio).toString()):null;Ti=!!Ci&&!!yr,Ci&&ai.setConstantPatternPositions(Ci,yr)}P>0&&(Ti||ai.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&me.push("FILL_EXTRUSION_PATTERN_TRANSITION");let Yt=l.getOrCreateProgram(Mt,{config:ai,defines:$t?ke:me,overrideFog:Jt});if(l.terrain&&l.terrain.setupElevationDraw(zt,Yt,{useMeterToDem:!0}),!Rt.centroidVertexBuffer){let Ii=Yt.attributes.a_centroid_pos;Ii!==void 0&&M.vertexAttrib2f(Ii,0,0)}!Pe&&$e&&$e.setupShadows(zt.tileID.toUnwrapped(),Yt,"vector-tile"),N&&(l.context.activeTexture.set(M.TEXTURE0),zt.imageAtlasTexture&&zt.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),ai.updatePaintBuffers());let Si=o.paint.get("fill-extrusion-vertical-gradient"),Mi=1/Rt.tileToMeter,Wi;if(Pe&&$e){if(lu(zt.tileID,Rt.maxHeight,l))continue;let Ii=$e.calculateShadowPassMatrixFromTile(zt.tileID.toUnwrapped());Wi=tm(Ii,ne,Mi,Ve,je,rt)}else{let Ii=l.translatePosMatrix(yt.expandedProjMatrix,zt,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),Ri=C.projection.createInversionMatrix(C,yt.canonical);Wi=N?xl(Ii,l,Si,F,Z,ne,Mi,yt,zt,he,je,rt,oe,se,Ri,Me,Ve,P):Fd(Ii,l,Si,F,Z,ne,Mi,yt,he,je,rt,oe,se,Ri,Me,Ve,_e,ct)}l.uploadCommonUniforms(b,Yt,yt.toUnwrapped(),null,Ce);let ni=Rt.segments;if(C.projection.name==="mercator"&&!Pe&&(ni=Rt.getVisibleSegments(zt.tileID,l.terrain,l.transform.getFrustum(0)),!ni.get().length))continue;if(Ot)if(Pe)for(let Ii of ni.get())Ot.numRenderedVerticesInShadowPass+=Ii.primitiveLength;else for(let Ii of ni.get())Ot.numRenderedVerticesInTransparentPass+=Ii.primitiveLength;let Ei=[];(l.terrain||x)&&Ei.push(Rt.centroidVertexBuffer),de&&Ei.push(Rt.layoutVertexExtBuffer),ze&&Ei.push(Rt.wallVertexBuffer),Yt.draw(l,b.gl.TRIANGLES,d,p,_,Ye,Wi,o.id,Rt.layoutVertexBuffer,Rt.indexBuffer,ni,o.paint,l.transform.zoom,ai,Ei)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}class Ps{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function Hn(l,t,o,c,d,p,_,x,b,M,C,z,P,D,N,F,j,U,Z,Y){let Q=t.context,ne=Q.gl,he=t.transform,de=t.transform.zoom,oe=[],se=l.translate,le=l.translateAnchor,Me=l.edgeRadius,_e=ss(t,l.cutoffFadeRange);C==="clear"?(oe.push("CLEAR_SUBPASS"),Y&&(oe.push("CLEAR_FROM_TEXTURE"),Q.activeTexture.set(ne.TEXTURE0),Y.bind(ne.LINEAR,ne.CLAMP_TO_EDGE))):C==="sdf"&&oe.push("SDF_SUBPASS"),U&&oe.push("HAS_CENTROID"),_e.shouldRenderCutoff&&oe.push("RENDER_CUTOFF");let Ve=(ze,je,rt,Ce,me)=>{let ke=je.programConfigurations.get(c.id),Pe=t.isTileAffectedByFog(ze),$e=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:ke,defines:oe,overrideFog:Pe}),Ze=((ct,Mt,Ot,yt,zt,Rt,$t,Jt,ai,Ti,Yt)=>({u_matrix:Mt,u_opacity:Ot,u_ao_pass:yt?1:0,u_meter_to_tile:zt,u_ao:Rt,u_flood_light_intensity:$t,u_flood_light_color:Jt,u_attenuation:ai,u_edge_radius:Ti,u_fb:0,u_fb_size:Yt,u_dynamic_offset:1}))(0,Ce,z,M,me,[P,D*me],N,F,j,de>=17?0:Me*me,Y?Y.size[0]:0),Ye=[];U&&Ye.push(je.hiddenByLandmarkVertexBuffer),t.uploadCommonUniforms(Q,$e,ze.toUnwrapped(),null,_e),$e.draw(t,Q.gl.TRIANGLES,p,_,x,b,Ze,c.id,je.vertexBuffer,je.indexBuffer,rt,c.paint,de,ke,Ye)};for(let ze of d){let je=o.getTile(ze),rt=je.getBucket(c);if(!rt||rt.projection.name!==he.projection.name||!rt.groundEffect||rt.groundEffect&&!rt.groundEffect.hasData())continue;let Ce=rt.groundEffect,me=1/rt.tileToMeter;{let ke=t.translatePosMatrix(ze.projMatrix,je,se,le),Pe=Ce.getDefaultSegment();Ve(ze,Ce,Pe,ke,me)}if(Z)for(let ke=0;ke<4;ke++){let Pe=n.e3[ke](ze),$e=o.getTile(Pe);if(!$e)continue;let Ze=$e.getBucket(c);if(!Ze||Ze.projection.name!==he.projection.name||!Ze.groundEffect||Ze.groundEffect&&!Ze.groundEffect.hasData())continue;let Ye=Ze.groundEffect,ct,Mt;ke===0?(ct=[-n.aj,0,0],Mt=1):ke===1?(ct=[n.aj,0,0],Mt=0):ke===2?(ct=[0,-n.aj,0],Mt=3):(ct=[0,n.aj,0],Mt=2);let Ot=Ye.regionSegments[Mt];if(!Ot)continue;let yt=new Float32Array(16);n.bo(yt,ze.projMatrix,ct),Ve(ze,Ye,Ot,t.translatePosMatrix(yt,je,se,le),me)}}}function Ut(l,t,o,c,d,p,_){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();let x=p?p.findDEMTileFor(o):null;if(!(x&&x.dem||_))return;p&&x&&x.dem&&c.selfDEMTileTimestamp!==x.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=x.dem._timestamp);let b=U=>new n.P(Math.ceil((U+n.e7)*n.e8),0),M=U=>{let Z=t.getSource().minzoom,Y=ne=>{let he=t.getTileByID(ne);if(he&&he.hasData())return he.getBucket(d)},Q=[0,-1,1];for(let ne of Q){if(U.overscaledZ+ne<Z)continue;let he=Y(U.calculateScaledKey(U.overscaledZ+ne));if(he)return he}},C=[0,0,0],z=(U,Z)=>(C[0]=Math.min(U.min.y,Z.min.y),C[1]=Math.max(U.max.y,Z.max.y),C[2]=n.aj-Z.min.x>U.max.x?Z.min.x-n.aj:U.max.x,C),P=(U,Z)=>(C[0]=Math.min(U.min.x,Z.min.x),C[1]=Math.max(U.max.x,Z.max.x),C[2]=n.aj-Z.min.y>U.max.y?Z.min.y-n.aj:U.max.y,C),D=[(U,Z)=>z(U,Z),(U,Z)=>z(Z,U),(U,Z)=>P(U,Z),(U,Z)=>P(Z,U)],N=(U,Z,Y,Q,ne,he,de)=>{if(!p)return 0;let oe=[[he?Y:U,he?U:Y,0],[he?Y:Z,he?Z:Y,0]],se=de<0?n.aj+de:de,le=[he?se:(U+Z)/2,he?(U+Z)/2:se,0];return Y===0&&de<0||Y!==0&&de>0?p.getForTilePoints(ne,[le],!0,Q):oe.push(le),p.getForTilePoints(o,oe,!0,x),Math.max(oe[0][2],oe[1][2],le[2])/p.exaggeration()};for(let U=0;U<4;U++){let Z=c.borderFeatureIndices[U];if(Z.length===0)continue;let Y=n.e3[U](o),Q=M(Y);if(!(Q&&Q instanceof n.e4))continue;let ne=p?p.findDEMTileFor(Y):null;if(!(ne&&ne.dem||_)||(p&&ne&&ne.dem&&c.borderDEMTileTimestamp[U]!==ne.dem._timestamp&&(c.borderDoneWithNeighborZ[U]=-1,c.borderDEMTileTimestamp[U]=ne.dem._timestamp),c.borderDoneWithNeighborZ[U]===Q.canonical.z))continue;Q.centroidVertexArray.length===0&&Q.createCentroidsBuffer();let he=(U<2?1:5)-U,de=Q.borderDoneWithNeighborZ[he]!==c.canonical.z,oe=Q.borderFeatureIndices[he],se=0;if(c.canonical.z!==Q.canonical.z){for(let le of Z)c.showCentroid(c.featuresOnBorder[le]);if(de)for(let le of oe)Q.showCentroid(Q.featuresOnBorder[le]);c.borderDoneWithNeighborZ[U]=Q.canonical.z,Q.borderDoneWithNeighborZ[he]=c.canonical.z}for(let le of Z){let Me=c.featuresOnBorder[le],_e=c.centroidData[Me.centroidDataIndex],Ve=Me.borders[U],ze;for(;se<oe.length;){ze=Q.featuresOnBorder[oe[se]];let je=ze.borders[he];if(je[1]>Ve[0]+3||je[0]>Ve[0]-3)break;Q.showCentroid(ze),se++}if(ze&&se<oe.length){let je=se,rt=0;for(;!(ze.borders[he][0]>Ve[1]-3)&&(rt++,++se!==oe.length);)ze=Q.featuresOnBorder[oe[se]];ze=Q.featuresOnBorder[oe[je]];let Ce=!1;if(rt>=1){let Pe=ze.borders[he];Math.abs(Ve[0]-Pe[0])<3&&Math.abs(Ve[1]-Pe[1])<3&&(rt=1,Ce=!0,se=je+1)}else if(rt===0){c.showCentroid(Me);continue}let me=Q.centroidData[ze.centroidDataIndex];_&&Ce&&(((F=_e).flags|(j=me).flags)&n.e6?(F.flags|=n.e6,j.flags|=n.e6):(F.flags&=~n.e6,j.flags&=~n.e6));let ke=Me.intersectsCount()>1||ze.intersectsCount()>1;if(rt>1)se=je,_e.centroidXY=me.centroidXY=new n.P(0,0);else if(ne&&ne.dem&&!ke){let Pe=D[U](_e,me),$e=U%2?n.aj-1:0,Ze=N(Pe[0],Math.min(n.aj-1,Pe[1]),$e,ne,Y,U<2,Pe[2]);_e.centroidXY=me.centroidXY=b(Ze)}else ke?_e.centroidXY=me.centroidXY=new n.P(0,0):(_e.centroidXY=c.encodeBorderCentroid(Me),me.centroidXY=Q.encodeBorderCentroid(ze));c.writeCentroidToBuffer(_e),Q.writeCentroidToBuffer(me)}else c.showCentroid(Me)}c.borderDoneWithNeighborZ[U]=Q.canonical.z,Q.borderDoneWithNeighborZ[he]=c.canonical.z}var F,j;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(l)}let Xd=[1,0,0],Cg=[0,1,0],Pg=[0,0,1];function lu(l,t,o){let c=o.transform,d=o.shadowRenderer;if(!d)return!0;let p=l.toUnwrapped(),_=c.tileSize*d._cascades[o.currentShadowCascade].scale,x=t;if(c.elevation){let F=c.elevation.getMinMaxForTile(l);F&&(x+=F.max)}let b=[...d.shadowDirection];b[2]=-b[2];let M=d.computeSimplifiedTileShadowVolume(p,x,_,b);if(!M)return!1;let C=[Xd,Cg,Pg,b,[b[0],0,b[2]],[0,b[1],b[2]]],z=c.projection.name==="globe",P=c.scaleZoom(_),D=n.cy.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,P,!z),N=d.getCurrentCascadeFrustum();return D.intersectsPrecise(M.vertices,M.planes,C)===0||N.intersectsPrecise(M.vertices,M.planes,C)===0}function cu(l){let{painter:t,source:o,layer:c,coords:d}=l,p=l.defines,_=t.context,x=t.renderPass==="shadow",b=t.renderPass==="light-beam",M=t.shadowRenderer,C;M&&(C=p.concat(["SHADOWS_SINGLE_CASCADE"]));let z=n.e9(t.transform.center.lat,t.transform.zoom);for(let P of d){let D=o.getTile(P),N=D.getBucket(c);if(!N)continue;let F=!1;M&&(F=M.getMaxCascadeForTile(P.toUnwrapped())===0);let j=N.programConfigurations.get(c.id),U,Z,Y=t.translatePosMatrix(P.expandedProjMatrix,D,[0,0],"map");if(Y=n.cP(n.bz(),Y,[1,1,l.verticalScale]),x&&M){if(lu(D.tileID,N.maxHeight*z,t))continue;let Q=M.calculateShadowPassMatrixFromTile(D.tileID.toUnwrapped());Q=n.cP(n.bz(),Q,[1,1,l.verticalScale]),Z=nm(Q),U=t.getOrCreateProgram("buildingDepth",{config:j,defines:F?C:p,overrideFog:!1})}else if(b)U=t.getOrCreateProgram("buildingBloom",{config:j,defines:F?C:p,overrideFog:!1}),Z=Nd(Y);else{let Q=t.transform.calculatePosMatrix(P.toUnwrapped(),t.transform.worldSize);n.cP(Q,Q,[1,1,l.verticalScale]);let ne=n.bz();n.cP(ne,Q,[1,-1,1/z]),n.bi(ne,ne),n.ea(ne,ne),Z=Bd(Y,ne),U=t.getOrCreateProgram("building",{config:j,defines:F?C:p,overrideFog:!1}),M&&M.setupShadowsFromMatrix(Q,U,!0)}if(t.uploadCommonUniforms(_,U,P.toUnwrapped(),null,null),b){let Q=N.bloomGeometry;U.draw(t,_.gl.TRIANGLES,l.depthMode,Gt.disabled,l.blendMode,Nt.disabled,Z,c.id,Q.layoutVertexBuffer,Q.indexBuffer,Q.segmentsBucket,c.paint,t.transform.zoom,j,[Q.layoutAttenuationBuffer,Q.layoutColorBuffer])}else U.draw(t,_.gl.TRIANGLES,l.depthMode,Gt.disabled,l.blendMode,x?Nt.disabled:Nt.backCW,Z,c.id,N.layoutVertexBuffer,N.indexBuffer,N.segments,c.paint,t.transform.zoom,j,[N.layoutNormalBuffer,N.layoutColorBuffer])}}function pm(l){return[l[0]*n.eb,l[1]*n.eb,l[2]*n.eb,0]}function hu(l,t,o,c,d,p,_,x,b){let M=c.getSource(),C=o.globeSharedBuffers;if(!C)return;let z,P,D;if(t&&(z=c.getTile(t)),M instanceof n.aP?(P=M.texture,D=n.dE(0,0,o.transform)):z&&t&&(P=z.texture,D=n.dE(t.canonical.z,t.canonical.x,o.transform)),!P||!D)return;l||(D=n.cP(n.bz(),D,[1,-1,1]));let N=o.context,F=N.gl,j=d.paint.get("raster-resampling")==="nearest"?F.NEAREST:F.LINEAR,U=o.colorModeForDrapableLayerRenderPass(p),Z=_.defines;Z.push("GLOBE_POLES");let Y=new bt(F.LEQUAL,bt.ReadWrite,o.depthRangeFor3D),Q=Float32Array.from(o.transform.expandedFarZProjMatrix),ne=Float32Array.from(n.bh(n.dD(new n.cA(0,0,0))));o.terrain&&o.terrain.prepareDrawTile(),N.activeTexture.set(F.TEXTURE0),P.bind(j,F.CLAMP_TO_EDGE),N.activeTexture.set(F.TEXTURE1),P.bind(j,F.CLAMP_TO_EDGE),"useMipmap"in P&&N.extTextureFilterAnisotropic&&o.transform.pitch>20&&F.texParameterf(F.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);let[he,de,oe,se]=t?C.getPoleBuffers(t.canonical.z,!1):C.getPoleBuffers(0,!0),le=d.paint.get("raster-elevation"),Me;l?(Me=he,o.renderDefaultNorthPole=le!==0):(Me=de,o.renderDefaultSouthPole=le!==0);let _e=pm(_.mix),Ve=((je,rt,Ce,me,ke,Pe,$e,Ze,Ye,ct,Mt,Ot,yt)=>Ud(je,rt,Ce,new Float32Array(16),new Float32Array(9),[0,0],me,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Pe,[0,0],Ze,2,ct,Mt,Ot,1,0,yt))(Q,ne,D,n.ah(o.transform.zoom),0,d,0,le,0,_e,_.offset,_.range,p),ze=o.getOrCreateProgram("raster",{defines:Z});o.uploadCommonUniforms(N,ze,null),ze.draw(o,F.TRIANGLES,Y,b,U,x,Ve,d.id,Me,oe,se)}function Rg(l){let t=l._nearZ,o=l.projection.farthestPixelDistance(l),c=o-t,d=.2*l.height,p=t+d;return[t,o,(p-d-t)/c,(p-t)/c]}function Lg(l,t,o,c){if(l)return t instanceof js&&l instanceof el?t.getTextureDescriptor(l,o,!0):{texture:l.texture,mix:pm(c.mix),offset:c.offset,buffer:0,tileSize:1}}var Qn=n.ec([{name:"a_index",type:"Int16",components:1}]);class Yd{constructor(t,o,c,d){let p={width:c[0],height:c[1],data:null},_=t.gl;this.targetColorTexture=new n.T(t,p,_.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new n.T(t,p,_.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(o,d),this.lastInvalidatedAt=0}updateParticleTexture(t,o){if(this.particleTextureDimension===o.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let c=this.context.gl,d=o.width*o.height;this.particleTexture0=new n.T(this.context,o,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new n.T(this.context,o,c.RGBA8,{premultiply:!1,useMipmap:!1});let p=new n.ed;p.reserve(d);for(let _=0;_<d;_++)p.emplaceBack(_);this.particleIndexBuffer=this.context.createVertexBuffer(p,Qn.members,!0),this.particleSegment=n.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=o.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=n.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Dn(l,t,o){if(!l)return null;let c=t.getTextureDescriptor(l,o,!0);if(!c)return null;let{texture:d,mix:p,offset:_,tileSize:x,buffer:b,format:M}=c;if(!d||!M)return null;let C=!1;return M==="uint32"&&(C=!0,p[3]=0,p=iu(n.ee,p,[0,o.paint.get("raster-particle-max-speed")]),_=Ks(n.ee,_,[0,o.paint.get("raster-particle-max-speed")])),{texture:d,textureOffset:[b/(x+2*b),x/(x+2*b)],tileSize:x,scalarData:C,scale:p,offset:_,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[M]]}}function ra(l){let t=l._nearZ,o=l.projection.farthestPixelDistance(l),c=o-t,d=.2*l.height,p=t+d;return[t,o,(p-d-t)/c,(p-t)/c]}let fm=new n.am(1,0,0,1),Kd=new n.am(0,1,0,1),Jd=new n.am(0,0,1,1),Qd=new n.am(1,0,1,1),mm=new n.am(0,1,1,1);function as(l,t,o,c,d,p){for(let _=0;_<o.length;_++)if(d){let M=new n.am(c.r*.8,c.g*.8,c.b*.8,1);ji(l,t,o[_],c,-1,-1,p),ji(l,t,o[_],c,-1,1,p),ji(l,t,o[_],c,1,1,p),ji(l,t,o[_],c,1,-1,p),ji(l,t,o[_],M,0,0,p)}else ji(l,t,o[_],c,0,0,p)}function ji(l,t,o,c,d,p,_){let x=l.context,b=l.transform,M=x.gl,C=b.projection.name==="globe",z=C?["PROJECTION_GLOBE_VIEW"]:[],P=n.bw(o.projMatrix);if(C&&n.ah(b.zoom)>0){let _e=n.bg(o.canonical,b),Ve=n.ef(_e);P=n.az(new Float32Array(16),b.globeMatrix,Ve),n.az(P,b.projMatrix,P)}let D=n.bz();D[12]+=2*d/(n.q.devicePixelRatio*b.width),D[13]+=2*p/(n.q.devicePixelRatio*b.height),n.az(P,D,P);let N=l.getOrCreateProgram("debug",{defines:z}),F=t.getTileByID(o.key);l.terrain&&l.terrain.setupElevationDraw(F,N);let j=bt.disabled,U=Gt.disabled,Z=l.colorModeForRenderPass(),Y="$debug";x.activeTexture.set(M.TEXTURE0),l.emptyTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),C?F._makeGlobeTileDebugBuffers(l.context,b):F._makeDebugTileBoundsBuffers(l.context,b.projection);let Q=F._tileDebugBuffer||l.debugBuffer,ne=F._tileDebugIndexBuffer||l.debugIndexBuffer,he=F._tileDebugSegments||l.debugSegments;if(N.draw(l,M.LINE_STRIP,j,U,Z,Nt.disabled,Vd(P,c.toPremultipliedRenderColor(null)),Y,Q,ne,he,null,null,null,[F._globeTileDebugBorderBuffer]),_){let _e=F.latestRawTileData,Ve=Math.floor((_e&&_e.byteLength||0)/1024),ze=o.canonical.toString();o.overscaledZ!==o.canonical.z&&(ze+=` => ${o.overscaledZ}`),ze+=` ${F.state}`,ze+=` ${Ve}kb`,function(je,rt){je.initDebugOverlayCanvas();let Ce=je.debugOverlayCanvas,me=je.context.gl,ke=je.debugOverlayCanvas.getContext("2d");ke.clearRect(0,0,Ce.width,Ce.height),ke.shadowColor="white",ke.shadowBlur=2,ke.lineWidth=1.5,ke.strokeStyle="white",ke.textBaseline="top",ke.font="bold 36px Open Sans, sans-serif",ke.fillText(rt,5,5),ke.strokeText(rt,5,5),je.debugOverlayTexture.update(Ce),je.debugOverlayTexture.bind(me.LINEAR,me.CLAMP_TO_EDGE)}(l,ze)}let de=t.getTile(o).tileSize,oe=512/Math.min(de,512)*(o.overscaledZ/b.zoom)*.5,se=F._tileDebugTextBuffer||l.debugBuffer,le=F._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,Me=F._tileDebugTextSegments||l.debugSegments;N.draw(l,M.TRIANGLES,j,U,ti.alphaBlended,Nt.disabled,Vd(P,n.am.transparent.toPremultipliedRenderColor(null),oe),Y,se,le,Me,null,null,null,[F._globeTileDebugTextBuffer])}function Uc(l,t,o,c){jc(l,0,t+o/2,l.transform.width,o,c)}function uu(l,t,o,c){jc(l,t-o/2,0,o,l.transform.height,c)}function jc(l,t,o,c,d,p){let _=l.context,x=_.gl;x.enable(x.SCISSOR_TEST),x.scissor(t*n.q.devicePixelRatio,o*n.q.devicePixelRatio,c*n.q.devicePixelRatio,d*n.q.devicePixelRatio),_.clear({color:p}),x.disable(x.SCISSOR_TEST)}let _m=n.ec([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:gm}=_m;function na(l,t,o,c){l.emplaceBack(t,o,c)}class ka{constructor(t){this.vertexArray=new n.eg,this.indices=new n.a_,na(this.vertexArray,-1,-1,1),na(this.vertexArray,1,-1,1),na(this.vertexArray,-1,1,1),na(this.vertexArray,1,1,1),na(this.vertexArray,-1,-1,-1),na(this.vertexArray,1,-1,-1),na(this.vertexArray,-1,1,-1),na(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,gm),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=n.bd.simpleSegment(0,0,36,12)}}function Ko(l,t,o,c,d,p){let _=l.context.gl,x=t.paint.get("sky-atmosphere-color"),b=t.paint.get("sky-atmosphere-halo-color"),M=t.paint.get("sky-atmosphere-sun-intensity"),C=((z,P,D,N,F)=>({u_matrix_3f:z,u_sun_direction:P,u_sun_intensity:D,u_color_tint_r:[N.r,N.g,N.b,N.a],u_color_tint_m:[F.r,F.g,F.b,F.a],u_luminance:5e-5}))(n.ei(n.dJ(),c),d,M,x.toPremultipliedRenderColor(null),b.toPremultipliedRenderColor(null));_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+p,t.skyboxTexture,0),o.draw(l,_.TRIANGLES,bt.disabled,Gt.disabled,ti.unblended,Nt.frontCW,C,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}let ot=n.ec([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class gt{constructor(t){let o=new n.ej;o.emplaceBack(-1,1,1,0,0),o.emplaceBack(1,1,1,1,0),o.emplaceBack(1,-1,1,1,1),o.emplaceBack(-1,-1,1,0,1);let c=new n.a_;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(o,ot.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=n.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}let bl=n.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Ar{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Se{constructor(t){this.colorModeAlphaBlendedWriteRGB=new ti([1,Aa,1,Aa],n.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ti([1,0,1,0],n.am.transparent,[!1,!1,!1,!0]),this.params=new Ar,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){let o=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new gt(o);let c=this.params.sizeRange,d=this.params.intensityRange,p=function(C){let z=n.el(30),P=[];for(let D=0;D<C;++D){let N=2*Math.PI*z(),F=Math.acos(1-2*z())-.5*Math.PI;P.push(n.d2(Math.cos(F)*Math.cos(N),Math.cos(F)*Math.sin(N),Math.sin(F)))}return P}(this.params.starsCount),_=n.el(300),x=new n.ek,b=new n.a_,M=0;for(let C=0;C<p.length;++C){let z=n.c1([],p[C],200),P=Math.max(0,1+.01*c*(1*_()-.5)),D=Math.max(0,1+.01*d*(1*_()-.5));x.emplaceBack(z[0],z[1],z[2],-1,-1,P,D),x.emplaceBack(z[0],z[1],z[2],1,-1,P,D),x.emplaceBack(z[0],z[1],z[2],1,1,P,D),x.emplaceBack(z[0],z[1],z[2],-1,1,P,D),b.emplaceBack(M+0,M+1,M+2),b.emplaceBack(M+0,M+2,M+3),M+=4}this.starsVx=o.createVertexBuffer(x,bl.members),this.starsIdx=o.createIndexBuffer(b),this.starsSegments=n.bd.simpleSegment(0,0,x.length,b.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,o){let c=t.context,d=c.gl,p=t.transform,_=new bt(d.LEQUAL,bt.ReadOnly,[0,1]),x=n.ah(p.zoom),b=t.style.getLut(o.scope),M=o.properties.get("color-use-theme")==="none",C=o.properties.get("color").toNonPremultipliedRenderColor(M?null:b).toArray01(),z=o.properties.get("high-color-use-theme")==="none",P=o.properties.get("high-color").toNonPremultipliedRenderColor(z?null:b).toArray01(),D=o.properties.get("space-color-use-theme")==="none",N=o.properties.get("space-color").toNonPremultipliedRenderColor(D?null:b).toArray01(),F=5e-4,j=n.em(o.properties.get("horizon-blend"),0,1,F,.25),U=n.dy(t,c,p)&&j===F?p.worldSize/(2*Math.PI*1.025)-1:p.globeRadius,Z=t.frameCounter/1e3%1,Y=n.ae(p.globeCenterInViewSpace),Q=Math.sqrt(Math.pow(Y,2)-Math.pow(U,2)),ne=Math.acos(Q/Y),he=de=>{let oe=p.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];de&&oe.push("ALPHA_PASS");let se=t.getOrCreateProgram("globeAtmosphere",{defines:oe}),le=((_e,Ve,ze,je,rt,Ce,me,ke,Pe,$e,Ze,Ye)=>({u_frustum_tl:_e,u_frustum_tr:Ve,u_frustum_br:ze,u_frustum_bl:je,u_horizon:rt,u_transition:Ce,u_fadeout_range:me,u_color:ke,u_high_color:Pe,u_space_color:$e,u_temporal_offset:Ze,u_horizon_angle:Ye}))(p.frustumCorners.TL,p.frustumCorners.TR,p.frustumCorners.BR,p.frustumCorners.BL,p.frustumCorners.horizon,x,j,C,P,N,Z,ne);t.uploadCommonUniforms(c,se);let Me=this.atmosphereBuffer;Me&&se.draw(t,d.TRIANGLES,_,Gt.disabled,de?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Nt.backCW,le,de?"atmosphere_glow_alpha":"atmosphere_glow",Me.vertexBuffer,Me.indexBuffer,Me.segments)};he(!1),he(!0)}drawStars(t,o){let c=n.ay(o.properties.get("star-intensity"),0,1);if(c===0)return;let d=t.context,p=d.gl,_=t.transform,x=t.getOrCreateProgram("stars"),b=n.c3([]);n.c5(b,b,-_._pitch),n.c4(b,b,-_.angle),n.c5(b,b,n.al(_._center.lat)),n.en(b,b,-n.al(_._center.lng));let M=n.c8(new Float32Array(16),b),C=n.az([],_.starsProjMatrix,M),z=n.ei([],M),P=n.eo([],z),D=[0,1,0];n.dL(D,D,P),n.c1(D,D,this.params.sizeMultiplier);let N=[1,0,0];n.dL(N,N,P),n.c1(N,N,this.params.sizeMultiplier);let F=(j=D,U=N,Z=c,{u_matrix:Float32Array.from(C),u_up:j,u_right:U,u_intensity_multiplier:Z});var j,U,Z;t.uploadCommonUniforms(d,x),this.starsVx&&this.starsIdx&&x.draw(t,p.TRIANGLES,bt.disabled,Gt.disabled,this.colorModeAlphaBlendedWriteRGB,Nt.disabled,F,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class ym{constructor(){this.visibleTiles=[]}updateBorders(t,o){let c=[],d=[],p=t._getRenderableCoordinates(!1,!0);for(let b of p){let M=t.getTile(b);if(!M.hasData())continue;let C=M.getBucket(o);C&&(C.isEmpty()||(c.push(b.key),d.push({bucket:C,tileID:b.canonical})))}let _=c.length!==this.visibleTiles.length;if(!_){c.sort();for(let b=0;b<c.length;b++)if(c[b]!==this.visibleTiles[b]){_=!0;break}}if(!_)return;let x=new Set;this.visibleTiles=c,d.sort((b,M)=>b.tileID.z-M.tileID.z||b.tileID.x-M.tileID.x||b.tileID.y-M.tileID.y);for(let b of d){let M=new Array,C=new Array,z=b.bucket;for(let P of z.featuresOnBorder)x.has(P.featureId)?C.push(P.footprintIndex):(x.add(P.featureId),M.push(P.footprintIndex));z.updateFootprintHiddenFlags(M,n.ep,!1),z.updateFootprintHiddenFlags(C,n.ep,!0)}}}function Gc(l,t){let o=[...l],c=t.cameraWorldSizeForFog/t.worldSize,d=n.bx([]);return n.cP(d,d,[c,c,1]),n.az(o,d,o),n.az(o,t.worldToFogMatrix,o),o}function qc(l,t,o,c,d){let p=o.material,_=c.context,{baseColorTexture:x,metallicRoughnessTexture:b}=p.pbrMetallicRoughness,{normalTexture:M,occlusionTexture:C,emissionTexture:z}=p;function P(N,F,j){if(N&&(l.push(F),_.activeTexture.set(_.gl.TEXTURE0+j),N.gfxTexture)){let{minFilter:U,magFilter:Z,wrapS:Y,wrapT:Q}=N.sampler;N.gfxTexture.bindExtraParam(U,Z,Y,Q)}}P(x,"HAS_TEXTURE_u_baseColorTexture",zn.BaseColor),P(b,"HAS_TEXTURE_u_metallicRoughnessTexture",zn.MetallicRoughness),P(M,"HAS_TEXTURE_u_normalTexture",zn.Normal),P(C,"HAS_TEXTURE_u_occlusionTexture",zn.Occlusion),P(z,"HAS_TEXTURE_u_emissionTexture",zn.Emission),d&&(d.texture||(d.texture=new n.et(c.context,d.image,[d.image.height,d.image.height,d.image.height],_.gl.RGBA8)),_.activeTexture.set(_.gl.TEXTURE0+zn.LUT),d.texture&&d.texture.bind(_.gl.LINEAR,_.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),o.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(o.texcoordBuffer)),o.colorBuffer&&(l.push(o.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(o.colorBuffer)),o.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(o.normalBuffer)),o.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(o.pbrBuffer)),p.alphaMode!=="OPAQUE"&&p.alphaMode!=="MASK"||l.push("UNPREMULT_TEXTURE_IN_SHADER"),p.defined||l.push("DIFFUSE_SHADED");let D=c.shadowRenderer;D&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),D.useNormalOffset&&l.push("NORMAL_OFFSET"))}function wl(l,t,o,c,d,p){let _=o.paint.get("model-opacity").constantOr(1),x=t.context,b=new bt(t.context.gl.LEQUAL,bt.ReadWrite,t.depthRangeFor3D),M=t.transform,C=l.mesh,z=C.material,P=z.pbrMetallicRoughness,D=t.style.fog,N;N=t.transform.projection.zAxisUnit==="pixels"?[...l.nodeModelMatrix]:n.az([],c.zScaleMatrix,l.nodeModelMatrix),n.az(N,c.negCameraPosMatrix,N);let F=n.bi([],N);n.ea(F,F);let j=o.paint.get("model-color-use-theme").constantOr("default")==="none",U=o.paint.get("model-emissive-strength").constantOr(0),Z=Gd(new Float32Array(l.worldViewProjection),new Float32Array(N),new Float32Array(F),null,t,_,P.baseColorFactor,z.emissiveFactor,P.metallicFactor,P.roughnessFactor,z,U,o),Y={defines:[]},Q=[],ne=t.shadowRenderer;ne&&(ne.useNormalOffset=!1),qc(Y.defines,Q,C,t,j?null:o.lut);let he=null;if(D){let se=Gc(l.nodeModelMatrix,t.transform);if(he=new Float32Array(se),M.projection.name!=="globe"){let le=C.aabb.min,Me=C.aabb.max,[_e,Ve]=D.getOpacityForBounds(se,le[0],le[1],Me[0],Me[1]);Y.overrideFog=_e>=He||Ve>=He}}let de=ss(t,o.paint.get("model-cutoff-fade-range"));de.shouldRenderCutoff&&Y.defines.push("RENDER_CUTOFF");let oe=t.getOrCreateProgram("model",Y);t.uploadCommonUniforms(x,oe,null,he,de),t.renderPass!=="shadow"&&ne&&ne.setupShadowsFromMatrix(l.nodeModelMatrix,oe),oe.draw(t,x.gl.TRIANGLES,b,d,p,C.material.doubleSided?Nt.disabled:Nt.backCCW,Z,o.id,C.vertexBuffer,C.indexBuffer,C.segments,o.paint,t.transform.zoom,void 0,Q)}function ep(l,t,o,c,d,p,_){let x;x=l.projection.name==="globe"?n.er(o,l):[...o],n.az(x,x,t.matrix);let b=n.az([],c,x);if(t.meshes)for(let M of t.meshes){if(M.material.alphaMode!=="BLEND"){_.push({mesh:M,depth:0,modelIndex:d,worldViewProjection:b,nodeModelMatrix:x});continue}let C=n.ad([],M.centroid,b);!l.isOrthographic&&C[2]<=0||p.push({mesh:M,depth:C[2],modelIndex:d,worldViewProjection:b,nodeModelMatrix:x})}if(t.children)for(let M of t.children)ep(l,M,o,c,d,p,_)}function du(l,t,o,c){let d=o.shadowRenderer;if(!d)return;let p=d.getShadowPassDepthMode(),_=d.getShadowPassColorMode(),x=d.calculateShadowPassMatrixFromMatrix(t),b=hm(x);o.getOrCreateProgram("modelDepth",{defines:o._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(o,o.context.gl.TRIANGLES,p,Gt.disabled,_,Nt.backCCW,b,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,o.transform.zoom,void 0,void 0)}function Tl(l,t,o){let c=t.updateZoomBasedPaintProperties(),d=function(p,_,x){let b,M,C,z=p.terrain?p.terrain.exaggeration():0;if(p.terrain&&z>0){let P=p.terrain,D=P.findDEMTileFor(x);D&&D.dem?b=n.eu.create(P,x,D):z=0}if(z===0&&(_.terrainElevationMin=0,_.terrainElevationMax=0),z===_.validForExaggeration&&(z===0||b&&b._demTile&&b._demTile.tileID===_.validForDEMTile.id&&b._dem._timestamp===_.validForDEMTile.timestamp))return!1;for(let P in _.instancesPerModel){let D=_.instancesPerModel[P];for(let N=0;N<D.instancedDataArray.length;++N){let F=(b?z*b.getElevationAt(0|D.instancedDataArray.float32[16*N],0|D.instancedDataArray.float32[16*N+1],!0,!0):0)+D.instancesEvaluatedElevation[N];D.instancedDataArray.float32[16*N+6]=F,M=M?Math.min(_.terrainElevationMin,F):F,C=C?Math.max(_.terrainElevationMax,F):F}}return _.terrainElevationMin=M||0,_.terrainElevationMax=C||0,_.validForExaggeration=z,_.validForDEMTile=b&&b._demTile?{id:b._demTile.tileID,timestamp:b._dem._timestamp}:{id:void 0,timestamp:0},!0}(l,t,o);(c||d)&&(t.uploaded=!1,t.upload(l.context))}let ls={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new n.d6([0,0,0],[n.aj,n.aj,0])};function zg(l,t){let o=1<<l.canonical.z,c=t.getFreeCameraOptions().position,d=t.elevation,p=l.canonical.x/o,_=(l.canonical.x+1)/o,x=l.canonical.y/o,b=(l.canonical.y+1)/o,M=t._centerAltitude;if(d){let D=d.getMinMaxForTile(l);D&&D.max>M&&(M=D.max)}let C=n.ay(c.x,p,_)-c.x,z=n.ay(c.y,x,b)-c.y,P=n.cb(M,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(C*C+z*z+P*P))}function tp(l,t,o,c,d,p,_){let x=l.context,b=l.renderPass==="shadow",M=l.shadowRenderer,C=b&&M?M.getShadowPassDepthMode():new bt(x.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),z=l.isTileAffectedByFog(p);if(o.meshes)for(let P of o.meshes){let D=["MODEL_POSITION_ON_GPU"],N=[],F,j,U;c.instancedDataArray.length>20&&D.push("INSTANCED_ARRAYS");let Z=ss(l,t.paint.get("model-cutoff-fade-range"));if(Z.shouldRenderCutoff&&D.push("RENDER_CUTOFF"),b&&M)F=l.getOrCreateProgram("modelDepth",{defines:D}),j=hm(_.shadowTileMatrix,_.shadowTileMatrix,Float32Array.from(o.matrix)),U=M.getShadowPassColorMode();else{qc(D,N,P,l,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),F=l.getOrCreateProgram("model",{defines:D,overrideFog:z});let Q=P.material,ne=Q.pbrMetallicRoughness,he=t.paint.get("model-opacity").constantOr(1),de=t.paint.get("model-emissive-strength").constantOr(0);j=Gd(p.expandedProjMatrix,Float32Array.from(o.matrix),new Float32Array(16),null,l,he,ne.baseColorFactor,Q.emissiveFactor,ne.metallicFactor,ne.roughnessFactor,Q,de,t,d),M&&(_.shadowUniformsInitialized?F.setShadowUniformValues(x,M.getShadowUniformValues()):(M.setupShadows(p.toUnwrapped(),F,"model-tile"),_.shadowUniformsInitialized=!0)),U=Z.shouldRenderCutoff||he<1||Q.alphaMode!=="OPAQUE"?ti.alphaBlended:ti.unblended}l.uploadCommonUniforms(x,F,p.toUnwrapped(),null,Z);let Y=P.material.doubleSided?Nt.disabled:Nt.backCCW;if(c.instancedDataArray.length>20)N.push(c.instancedDataBuffer),F.draw(l,x.gl.TRIANGLES,C,Gt.disabled,U,Y,j,t.id,P.vertexBuffer,P.indexBuffer,P.segments,t.paint,l.transform.zoom,void 0,N,c.instancedDataArray.length);else{let Q=b?"u_instance":"u_normal_matrix";for(let ne=0;ne<c.instancedDataArray.length;++ne)j[Q]=new Float32Array(c.instancedDataArray.arrayBuffer,64*ne,16),F.draw(l,x.gl.TRIANGLES,C,Gt.disabled,U,Y,j,t.id,P.vertexBuffer,P.indexBuffer,P.segments,t.paint,l.transform.zoom,void 0,N)}}if(o.children)for(let P of o.children)tp(l,t,P,c,d,p,_)}let pu=[1,-1,1];function ip(l,t,o,c){if(!o.modelManager)return!0;let d=o.modelManager;if(!o.shadowRenderer)return!0;let p=o.shadowRenderer,_=t.aabb,x=!0,b=l.maxHeight;if(b===0){let C=0;for(let z in l.instancesPerModel){let P=d.getModel(z,c);P?C=Math.max(C,Math.max(Math.max(P.aabb.max[0],P.aabb.max[1]),P.aabb.max[2])):x=!1}b=l.maxScale*C*1.41+l.maxVerticalOffset,x&&(l.maxHeight=b)}_.max[2]=b,_.min[2]+=l.terrainElevationMin,_.max[2]+=l.terrainElevationMax,n.ad(_.min,_.min,t.tileMatrix),n.ad(_.max,_.max,t.tileMatrix);let M=_.intersects(p.getCurrentCascadeFrustum());return o.currentShadowCascade===0&&(l.isInsideFirstShadowMapFrustum=M===2),M===0}function xm(l,t){let o=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],d=l.uniformValues.u_cutoff_params[2],p=l.uniformValues.u_cutoff_params[3];return c===o||p===d?1:n.ay(((t-o)/(c-o)-d)/(p-d),0,1)}function vm(l,t,o,c){if(t.pitch<20)return 1;let d=t.getWorldToCameraMatrix();n.az(d,d,l);let p=n.bR(o.min[0],o.min[1],o.min[2],1),_=n.aA(n.ev(),p,d),x=_,b=_;p[1]=o.max[1],_=n.aA(n.ev(),p,d),x=_[1]<x[1]?_:x,b=_[1]>b[1]?_:b,p[0]=o.max[0],_=n.aA(n.ev(),p,d),x=_[1]<x[1]?_:x,b=_[1]>b[1]?_:b,p[1]=o.min[1],_=n.aA(n.ev(),p,d),x=_[1]<x[1]?_:x,b=_[1]>b[1]?_:b;let M=n.ay(c[0],0,1),C=100*t.pixelsPerMeter*n.ay(c[1],0,1),z=n.ay(c[2],0,1),P=n.ew(n.ev(),x,b,M),D=Math.tan(.5*t.fovX),N=-P[2]*D;if(C===0)return P[1]<-Math.abs(N)?z:1;let F=(-Math.abs(N)-P[1])/C,j=(Z,Y,Q)=>(1-Q)*Z+Q*Y,U=n.ay(j(1,z,F),z,1);return j(1,U,n.ay((t.pitch-20)/20,0,1))}class fu{}class Hc{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,o,c){{let z=this._storage.get(o.id);if(z)return z.lastUsedFrameIdx=t,z.buf}let d=c.gl,p=d.getBufferParameter(d.ELEMENT_ARRAY_BUFFER,d.BUFFER_SIZE),_=new ArrayBuffer(p),x=new Int16Array(_);d.getBufferSubData(d.ELEMENT_ARRAY_BUFFER,0,new Int16Array(_));let b=new n.ey;for(let z=0;z<p/2;z+=3){let P=x[z],D=x[z+1],N=x[z+2];b.emplaceBack(P,D),b.emplaceBack(D,N),b.emplaceBack(N,P)}let M=c.bindVertexArrayOES.current,C=new fu;return C.buf=new ea(c,b),C.lastUsedFrameIdx=t,this._storage.set(o.id,C),c.bindVertexArrayOES.set(M),C.buf}update(t){for(let[o,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(o))}destroy(){for(let[t,o]of this._storage)o.buf.destroy(),this._storage.delete(t)}}class Sl{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}let bm=n.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Dg{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Mn{constructor(t,o){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...o,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...o,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}let Og=n.ec([{type:"Float32",name:"a_pos_2f",components:2}]);class $c{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,o){let c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){let _=new n.ez,x=new n.a_;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(1,1),_.emplaceBack(-1,1),x.emplaceBack(0,1,2),x.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(_,Og.members),this.vignetteIdx=t.context.createIndexBuffer(x)}let d=n.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);let _={u_vignetteShape:(p={vignetteShape:[o.start,o.range,Math.pow(10,o.fadePower)],vignetteColor:[o.color.r,o.color.g,o.color.b,o.color.a*o.strength]}).vignetteShape,u_vignetteColor:p.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,_,"vignette",this.vignetteVx,this.vignetteIdx,d)}var p}}class sr{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,o){let c=t.getFreeCameraOptions().position,d=c.toAltitude(),p=c.toLngLat(),_=n.al(p.lng),x=n.al(p.lat),b=t.pixelsPerMeter/o,M=_*n.eB,C=n.eB*Math.log(Math.tan(Math.PI/4+x/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{let z=-this._offsetYPrev+C,P=-this._elevationPrev+d;this._accumulatedOffsetX+=(-this._offsetXPrev+M)*b,this._accumulatedOffsetY+=z*b,this._accumulatedElevation+=P*b,this._offsetXPrev=M,this._offsetYPrev=C,this._elevationPrev=d}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function gi(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function rp(l){let t=n.el(1323123451230),o=[];for(let c=0;c<l;++c){let d=2*t()-1,p=2*t()-1,_=2*t()-1;o.push(n.d2(d,p,_))}return o}function $n(l,t,o,c,d){let p=n.ay((d-o)/(c-o),0,1);return(1-p)*l+p*t}class El{constructor(t){this._movement=new sr,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new $c,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,o){let c=t.transform;this._movement.update(c,this._ppmScaleFactor);let d=c.starsProjMatrix,p=n.c3([]);n.c5(p,p,n.al(90)-c._pitch),n.c4(p,p,-c.angle);let _=n.c8(new Float32Array(16),p),x=n.eA(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),b=n.ea([],x),M=n.az([],b,_),C=Date.now()/1e3;return this._accumulatedTimeFromStart+=(C-this._prevTime)*o,this._prevTime=C,{projectionMatrix:d,modelviewMatrix:M}}}class Il extends El{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Mn(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let c=rp(this.particlesCount),d=new n.eC,p=new n.a_,_=0,x=n.el(1323123451230);for(let b=0;b<c.length;++b){let M=c[b],C=[2*x()-1,x(),x(),x()];d.emplaceBack(M[0],M[1],M[2],-1,-1,...C),d.emplaceBack(M[0],M[1],M[2],1,-1,...C),d.emplaceBack(M[0],M[1],M[2],1,1,...C),d.emplaceBack(M[0],M[1],M[2],-1,1,...C),p.emplaceBack(_+0,_+1,_+2),p.emplaceBack(_+0,_+2,_+3),_+=4}this.particlesVx=o.createVertexBuffer(d,bm.members),this.particlesIdx=o.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;let o=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(o.revealStart>c)return;let d=$n(0,1,o.revealStart,o.revealStart+o.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;let p=structuredClone(this._params),_=[-p.direction.x,p.direction.y,-100];n.au(_,_);let x=structuredClone(this._vignetteParams);x.strength*=d,p.overrideStyleParameters||(p.intensity=t.style.rain.state.density,p.timeFactor=t.style.rain.state.intensity,p.color=structuredClone(t.style.rain.state.color),_=structuredClone(t.style.rain.state.direction),p.screenThinning.intensity=t.style.rain.state.centerThinning,p.dropletSizeX=t.style.rain.state.dropletSize[0],p.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],p.distortionStrength=100*t.style.rain.state.distortionStrength,x.strength=1,x.color=structuredClone(t.style.rain.state.vignetteColor));let b=this.updateOnRender(t,p.timeFactor),M=t.context,C=M.gl,z=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new n.T(M,{width:t.width,height:t.height,data:null},C.RGBA8)),p.distortionStrength>0&&(M.activeTexture.set(C.TEXTURE0),this.screenTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),C.copyTexSubImage2D(C.TEXTURE_2D,0,0,0,0,0,t.width,t.height));let P=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(M,P),M.activeTexture.set(C.TEXTURE0),this.screenTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE);let D=[p.color.r,p.color.g,p.color.b,p.color.a],N=(F,j)=>{let U=gi(this._movement.getPosition(),F),Z=p.dropletSizeX,Y=p.dropletSizeX*p.dropletSizeYScale,Q=t.width/2,ne=t.height/2,he=$n(0,p.screenThinning.start,0,1,p.screenThinning.intensity),de=$n(.001,p.screenThinning.range,0,1,p.screenThinning.intensity),oe=$n(0,p.screenThinning.particleOffset,0,1,p.screenThinning.intensity),se=(le={modelview:b.modelviewMatrix,projection:b.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:U,velocityConeAperture:p.velocityConeAperture,velocity:p.velocity,boxSize:F,rainDropletSize:[Z,Y],distortionStrength:p.distortionStrength,rainDirection:_,color:D,screenSize:[z.width,z.height],thinningCenterPos:[Q,ne],thinningShape:[he,de,Math.pow(10,p.screenThinning.fadePower)],thinningAffectedRatio:p.screenThinning.affectedRatio,thinningParticleOffset:oe,shapeDirectionalPower:p.shapeDirPower,shapeNormalPower:p.shapeNormalPower,mode:j?0:1},{u_modelview:Float32Array.from(le.modelview),u_projection:Float32Array.from(le.projection),u_time:le.time,u_cam_pos:le.camPos,u_texScreen:0,u_velocityConeAperture:le.velocityConeAperture,u_velocity:le.velocity,u_boxSize:le.boxSize,u_rainDropletSize:le.rainDropletSize,u_distortionStrength:le.distortionStrength,u_rainDirection:le.rainDirection,u_color:le.color,u_screenSize:le.screenSize,u_thinningCenterPos:le.thinningCenterPos,u_thinningShape:le.thinningShape,u_thinningAffectedRatio:le.thinningAffectedRatio,u_thinningParticleOffset:le.thinningParticleOffset,u_shapeDirectionalPower:le.shapeDirectionalPower,u_shapeNormalPower:le.shapeNormalPower,u_mode:le.mode});var le;let Me=Math.round(p.intensity*this.particlesCount),_e=n.bd.simpleSegment(0,0,4*Me,2*Me);P.draw(t,C.TRIANGLES,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,se,"rain_particles",this.particlesVx,this.particlesIdx,_e)};p.distortionStrength>0&&N(p.boxSize,!0),N(p.boxSize,!1),this._vignette.draw(t,x)}}let Fa=n.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class np extends El{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Mn(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let c=rp(this.particlesCount),d=new n.eD,p=new n.a_,_=0,x=n.el(1323123451230);for(let b=0;b<c.length;++b){let M=c[b],C=x(),z=x(),P=x(),D=[b/c.length,C,z,P],N=[x(),x()];d.emplaceBack(M[0],M[1],M[2],-1,-1,...D,...N),d.emplaceBack(M[0],M[1],M[2],1,-1,...D,...N),d.emplaceBack(M[0],M[1],M[2],1,1,...D,...N),d.emplaceBack(M[0],M[1],M[2],-1,1,...D,...N),p.emplaceBack(_+0,_+1,_+2),p.emplaceBack(_+0,_+2,_+3),_+=4}this.particlesVx=o.createVertexBuffer(d,Fa.members),this.particlesIdx=o.createIndexBuffer(p)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;let o=structuredClone(this._params),c=[-o.direction.x,o.direction.y,-100];n.au(c,c);let d=structuredClone(this._vignetteParams),p=o.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},_=t.transform.zoom;if(p.revealStart>_)return;let x=$n(0,1,p.revealStart,p.revealStart+p.revealRange,_);d.strength*=x,o.overrideStyleParameters||(o.intensity=t.style.snow.state.density,o.timeFactor=t.style.snow.state.intensity,o.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),o.screenThinning.intensity=t.style.snow.state.centerThinning,o.billboardSize=2.79*t.style.snow.state.flakeSize,d.strength=1,d.color=structuredClone(t.style.snow.state.vignetteColor));let b=this.updateOnRender(t,o.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;let M=t.context,C=M.gl,z=t.transform,P=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(M,P),((D,N,F)=>{let j=gi(this._movement.getPosition(),D),U=z.width/2,Z=z.height/2,Y=$n(0,F.screenThinning.start,0,1,F.screenThinning.intensity),Q=$n(.001,F.screenThinning.range,0,1,F.screenThinning.intensity),ne=$n(0,F.screenThinning.particleOffset,0,1,F.screenThinning.intensity),he=(de={modelview:b.modelviewMatrix,projection:b.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:j,velocityConeAperture:F.velocityConeAperture,velocity:F.velocity,horizontalOscillationRadius:F.horizontalOscillationRadius,horizontalOscillationRate:F.horizontalOscillationRate,boxSize:D,billboardSize:1*F.billboardSize,simpleShapeParameters:[F.shapeFadeStart,F.shapeFadePower],screenSize:[z.width,z.height],thinningCenterPos:[U,Z],thinningShape:[Y,Q,Math.pow(10,F.screenThinning.fadePower)],thinningAffectedRatio:F.screenThinning.affectedRatio,thinningParticleOffset:ne,color:[F.color.r,F.color.g,F.color.b,F.color.a],direction:c},{u_modelview:Float32Array.from(de.modelview),u_projection:Float32Array.from(de.projection),u_time:de.time,u_cam_pos:de.camPos,u_velocityConeAperture:de.velocityConeAperture,u_velocity:de.velocity,u_horizontalOscillationRadius:de.horizontalOscillationRadius,u_horizontalOscillationRate:de.horizontalOscillationRate,u_boxSize:de.boxSize,u_billboardSize:de.billboardSize,u_simpleShapeParameters:de.simpleShapeParameters,u_screenSize:de.screenSize,u_thinningCenterPos:de.thinningCenterPos,u_thinningShape:de.thinningShape,u_thinningAffectedRatio:de.thinningAffectedRatio,u_thinningParticleOffset:de.thinningParticleOffset,u_particleColor:de.color,u_direction:de.direction});var de;let oe=Math.round(F.intensity*this.particlesCount),se=n.bd.simpleSegment(0,0,4*oe,2*oe);this.particlesVx&&this.particlesIdx&&P.draw(t,C.TRIANGLES,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,he,"snow_particles",this.particlesVx,this.particlesIdx,se)})(o.boxSize,0,o),this._vignette.draw(t,d)}}let op={symbol:function(l,t,o,c,d){if(l.renderPass!=="translucent")return;let p=Gt.disabled,_=l.colorModeForRenderPass(),x=o.layout.get("text-variable-anchor"),b=o.layout.get("text-size-scale-range"),M=n.ay(l.scaleFactor,b[0],b[1]);x&&function(P,D,N,F,j,U,Z,Y){let Q=D.transform,ne=j==="map",he=U==="map";for(let de of P){let oe=F.getTile(de),se=oe.getBucket(N);if(!se||!se.text||!se.text.segments.get().length)continue;let le=n.bH(se.textSizeData,Q.zoom,Y),Me=Ch(de,se.getProjection(),Q),_e=Q.calculatePixelsToTileUnitsMatrix(oe),Ve=wc(Me,oe.tileID.canonical,he,ne,Q,se.getProjection(),_e),ze=se.hasIconTextFit()&&se.hasIconData();le&&dm(se,ne,he,Z,Q,Ve,de,Math.pow(2,Q.zoom-oe.tileID.overscaledZ),le,ze)}}(c,l,o,t,o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),d,M);let C=o.paint.get("icon-opacity").constantOr(1)!==0,z=o.paint.get("text-opacity").constantOr(1)!==0;o.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(C||z)?Wd(l,t,o,c,p,_):(C&&Wd(l,t,o,c,p,_,{onlyIcons:!0}),z&&Wd(l,t,o,c,p,_,{onlyText:!0})),t.map.showCollisionBoxes&&($d(l,t,o,c,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),!0),$d(l,t,o,c,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,o,c){if(l.renderPass!=="translucent")return;let d=o.paint.get("circle-opacity"),p=o.paint.get("circle-stroke-width"),_=o.paint.get("circle-stroke-opacity"),x=o.layout.get("circle-sort-key").constantOr(1)!==void 0,b=o.paint.get("circle-emissive-strength");if(d.constantOr(1)===0&&(p.constantOr(1)===0||_.constantOr(1)===0))return;let M=l.context,C=M.gl,z=l.transform,P=!(!l.terrain||!l.terrain.enabled),D=o.layout.get("circle-elevation-reference"),N=l.depthModeForSublayer(0,bt.ReadOnly),F=new bt(l.context.gl.LEQUAL,bt.ReadOnly,l.depthRangeFor3D),j=D==="none"||P?N:F,U=Gt.disabled,Z=l.colorModeForDrapableLayerRenderPass(b),Y=z.projection.name==="globe",Q=[n.aD(z.center.lng),n.aH(z.center.lat)],ne=[];for(let de=0;de<c.length;de++){let oe=c[de],se=t.getTile(oe),le=se.getBucket(o);if(!le||le.projection.name!==z.projection.name)continue;let Me=le.programConfigurations.get(o.id),_e=le.layoutVertexBuffer,Ve=le.globeExtVertexBuffer,ze=le.indexBuffer,je=n.dW(o),rt=[Ve],Ce=l.isTileAffectedByFog(oe);Y&&je.push("PROJECTION_GLOBE_VIEW"),je.push("DEPTH_D24"),l.terrain&&z.depthOcclusionForSymbolsAndCircles&&je.push("DEPTH_OCCLUSION"),le.hasElevation&&!l.terrain&&(je.push("ELEVATED_ROADS"),rt.push(le.elevatedLayoutVertexBuffer));let me=l.getOrCreateProgram("circle",{config:Me,defines:je,overrideFog:Ce}),ke=z.projection.createInversionMatrix(z,oe.canonical),Pe={programConfiguration:Me,program:me,layoutVertexBuffer:_e,dynamicBuffers:rt,indexBuffer:ze,uniformValues:n.dX(l,oe,se,ke,Q,o),tile:se};if(x){let $e=le.segments.get();for(let Ze of $e)ne.push({segments:new n.bd([Ze]),sortKey:Ze.sortKey,state:Pe})}else ne.push({segments:le.segments,sortKey:0,state:Pe})}x&&ne.sort((de,oe)=>de.sortKey-oe.sortKey);let he={useDepthForOcclusion:z.depthOcclusionForSymbolsAndCircles};for(let de of ne){let{programConfiguration:oe,program:se,layoutVertexBuffer:le,dynamicBuffers:Me,indexBuffer:_e,uniformValues:Ve,tile:ze}=de.state,je=de.segments;l.terrain&&l.terrain.setupElevationDraw(ze,se,he),l.uploadCommonUniforms(M,se,ze.tileID.toUnwrapped()),se.draw(l,C.TRIANGLES,j,U,Z,Nt.disabled,Ve,o.id,le,_e,je,o.paint,z.zoom,oe,Me)}},heatmap:function(l,t,o,c){if(o.paint.get("heatmap-opacity")!==0)if(l.renderPass==="offscreen"){let d=l.context,p=d.gl,_=Gt.disabled,x=new ti([p.ONE,p.ONE,p.ONE,p.ONE],n.am.transparent,[!0,!0,!0,!0]);(function(D,N,F,j){let U=D.gl,Z=N.width*j,Y=N.height*j;D.activeTexture.set(U.TEXTURE1),D.viewport.set([0,0,Z,Y]);let Q=F.heatmapFbo;if(!Q||Q&&(Q.width!==Z||Q.height!==Y)){Q&&Q.destroy();let ne=U.createTexture();U.bindTexture(U.TEXTURE_2D,ne),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_WRAP_S,U.CLAMP_TO_EDGE),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_WRAP_T,U.CLAMP_TO_EDGE),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MIN_FILTER,U.LINEAR),U.texParameteri(U.TEXTURE_2D,U.TEXTURE_MAG_FILTER,U.LINEAR),Q=F.heatmapFbo=D.createFramebuffer(Z,Y,!0,null),function(he,de,oe,se,le,Me){let _e=he.gl;_e.texImage2D(_e.TEXTURE_2D,0,he.extRenderToTextureHalfFloat?_e.RGBA16F:_e.RGBA,le,Me,0,_e.RGBA,he.extRenderToTextureHalfFloat?_e.HALF_FLOAT:_e.UNSIGNED_BYTE,null),se.colorAttachment.set(oe)}(D,0,ne,Q,Z,Y)}else U.bindTexture(U.TEXTURE_2D,Q.colorAttachment.get()),D.bindFramebuffer.set(Q.framebuffer)})(d,l,o,l.transform.projection.name==="globe"?.5:.25),d.clear({color:n.am.transparent});let b=l.transform,M=b.projection.name==="globe",C=M?["PROJECTION_GLOBE_VIEW"]:[],z=M?Nt.frontCCW:Nt.disabled,P=[n.aD(b.center.lng),n.aH(b.center.lat)];for(let D=0;D<c.length;D++){let N=c[D];if(t.hasRenderableParent(N))continue;let F=t.getTile(N),j=F.getBucket(o);if(!j||j.projection.name!==b.projection.name)continue;let U=l.isTileAffectedByFog(N),Z=j.programConfigurations.get(o.id),Y=l.getOrCreateProgram("heatmap",{config:Z,defines:C,overrideFog:U}),{zoom:Q}=l.transform;l.terrain&&l.terrain.setupElevationDraw(F,Y),l.uploadCommonUniforms(d,Y,N.toUnwrapped());let ne=b.projection.createInversionMatrix(b,N.canonical);Y.draw(l,p.TRIANGLES,bt.disabled,_,x,z,sm(l,N,F,ne,P,Q,o.paint.get("heatmap-intensity")),o.id,j.layoutVertexBuffer,j.indexBuffer,j.segments,o.paint,l.transform.zoom,Z,M?[j.globeExtVertexBuffer]:null)}d.viewport.set([0,0,l.width,l.height])}else l.renderPass==="translucent"&&(l.context.setColorMode(l.colorModeForRenderPass()),function(d,p){let _=d.context,x=_.gl,b=p.heatmapFbo;if(!b)return;_.activeTexture.set(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,b.colorAttachment.get()),_.activeTexture.set(x.TEXTURE1);let M=p.colorRampTexture;M||(M=p.colorRampTexture=new n.T(_,p.colorRamp,x.RGBA8)),M.bind(x.LINEAR,x.CLAMP_TO_EDGE),d.getOrCreateProgram("heatmapTexture").draw(d,x.TRIANGLES,bt.disabled,Gt.disabled,d.colorModeForRenderPass(),Nt.disabled,((C,z,P,D)=>({u_image:0,u_color_ramp:1,u_opacity:z.paint.get("heatmap-opacity")}))(0,p),p.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments,p.paint,d.transform.zoom)}(l,o))},line:function(l,t,o,c){if(l.renderPass!=="translucent")return;let d=o.paint.get("line-opacity"),p=o.paint.get("line-width");if(d.constantOr(1)===0||p.constantOr(1)===0)return;let _=o.paint.get("line-emissive-strength"),x=o.paint.get("line-occlusion-opacity"),b=o.layout.get("line-elevation-reference"),M=o.layout.get("line-width-unit")==="meters",C=b==="sea",z=!(!l.terrain||!l.terrain.enabled),P=l.context,D=P.gl;if(o.hasElevatedBuckets&&l.transform.projection.name==="globe")return;let N=o.layout.get("line-cross-slope"),F=N!==void 0,j=N<1,U=l.colorModeForDrapableLayerRenderPass(_),Z=l.terrain&&l.terrain.renderingToTexture,Y=Z?1:n.q.devicePixelRatio,Q=o.paint.get("line-dasharray"),ne=Q.constantOr(1),he=o.layout.get("line-cap"),de=Q.constantOr(null),oe=he.constantOr(null),se=o.paint.get("line-pattern"),le=se.constantOr(1),Me=o.paint.get("line-pattern-cross-fade"),_e=se.constantOr(null),Ve=o.paint.get("line-opacity").constantOr(1),ze=!le&&Ve!==1||l.depthOcclusion&&x>0&&x<1,je=o.paint.get("line-gradient"),rt=le?"linePattern":"line",Ce=n.dY(o),me;if(Z&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(ze=!1),x!==0&&l.depthOcclusion){let Ze=o.paint._values["line-opacity"];Ze&&Ze.value&&Ze.value.kind==="constant"?me=Ze.value:n.w(`Occlusion opacity for layer ${o.id} is supported only when line-opacity isn't data-driven.`)}p.value.kind!=="constant"&&p.value.isLineProgressConstant===!1&&Ce.push("VARIABLE_LINE_WIDTH");let ke=(Ze,Ye,ct,Mt,Ot,yt)=>{for(let zt of Ze){let Rt=t.getTile(zt);if(le&&!Rt.patternsLoaded())continue;let $t=Rt.getBucket(o);if(!$t||$t.elevationType!=="none"&&!Ot||$t.elevationType==="none"&&Ot)continue;l.prepareDrawTile();let Jt=[...Ye],ai=l.shadowRenderer,Ti=$t.elevationType==="road"&&!!ai&&ai.enabled,Yt=[0,0,0];if(Ti){let bi=l.style.directionalLight,Li=l.style.ambientLight;bi&&Li&&(Yt=Ma(l.style,bi,Li)),Jt.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}let Si=$t.programConfigurations.get(o.id),Mi=!1;if(_e&&Rt.imageAtlas){let bi=n.dZ.from(_e),Li=bi.getPrimary().scaleSelf(Y).toString(),$i=Rt.imageAtlas.patternPositions.get(Li),kr=bi.getSecondary(),Dr=kr?Rt.imageAtlas.patternPositions.get(kr.scaleSelf(Y).toString()):null;Mi=!!$i&&!!Dr,$i&&Si.setConstantPatternPositions($i,Dr)}Me>0&&(Mi||Si.getPatternTransitionVertexBuffer("line-pattern"))&&Jt.push("LINE_PATTERN_TRANSITION");let Wi=l.isTileAffectedByFog(zt),ni=l.getOrCreateProgram(rt,{config:Si,defines:Jt,overrideFog:Wi});if(!le&&de&&oe&&Rt.lineAtlas){let bi=Rt.lineAtlas.getDash(de,oe);bi&&Si.setConstantPatternPositions(bi)}Ti&&ai.setupShadows(Rt.tileID.toUnwrapped(),ni,"vector-tile");let[Ei,Ii]=o.paint.get("line-trim-offset");(oe==="round"||oe==="square")&&Ei!==Ii&&(Ei===0&&(Ei-=1),Ii===1&&(Ii+=1));let Ri=Z?zt.projMatrix:null,li=M?1/$t.tileToMeter/n.aw(Rt,1,l.transform.zoom):1,Vi=M?1/$t.tileToMeter/n.aw(Rt,1,Math.floor(l.transform.zoom)):1,Ci=le?n.d_(l,Rt,o,Ri,Y,li,Vi,[Ei,Ii],Yt,Me):n.d$(l,Rt,o,Ri,$t.lineClipsArray.length,Y,li,Vi,[Ei,Ii],Yt);if(je){let bi=$t.gradients[o.id],Li=bi.texture;if(o.gradientVersion!==bi.version){let $i=256;if(o.stepInterpolant){let kr=t.getSource().maxzoom,Dr=zt.canonical.z===kr?Math.ceil(1<<l.transform.maxZoom-zt.canonical.z):1;$i=n.ay(n.e0($t.maxLineLength/n.aj*1024*Dr),256,P.maxTextureSize)}bi.gradient=n.e1({expression:o.gradientExpression(),evaluationKey:"lineProgress",resolution:$i,image:bi.gradient||void 0,clips:$t.lineClipsArray}),bi.texture?bi.texture.update(bi.gradient):bi.texture=new n.T(P,bi.gradient,D.RGBA8),bi.version=o.gradientVersion,Li=bi.texture}P.activeTexture.set(D.TEXTURE1),Li.bind(o.stepInterpolant?D.NEAREST:D.LINEAR,D.CLAMP_TO_EDGE)}ne&&(P.activeTexture.set(D.TEXTURE0),Rt.lineAtlasTexture&&Rt.lineAtlasTexture.bind(D.LINEAR,D.REPEAT),Si.updatePaintBuffers()),le&&(P.activeTexture.set(D.TEXTURE0),Rt.imageAtlasTexture&&Rt.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),Si.updatePaintBuffers()),Ot&&!C&&l.terrain.setupElevationDraw(Rt,ni),l.uploadCommonUniforms(P,ni,zt.toUnwrapped());let yr=bi=>{me!=null&&(me.value=Ve*x),ni.draw(l,D.TRIANGLES,ct,bi,U,Nt.disabled,Ci,o.id,$t.layoutVertexBuffer,$t.indexBuffer,$t.segments,o.paint,l.transform.zoom,Si,[$t.layoutVertexBuffer2,$t.patternVertexBuffer,$t.zOffsetVertexBuffer]),me!=null&&(me.value=Ve)};if(ze&&!Ot){let bi=l.stencilModeForClipping(zt).ref;bi===0&&Z&&P.clear({stencil:0});let Li={func:D.EQUAL,mask:255};Ci.u_alpha_discard_threshold=.8,yr(new Gt(Li,bi,255,D.KEEP,D.KEEP,D.INVERT)),Ci.u_alpha_discard_threshold=0,yr(new Gt(Li,bi,255,D.KEEP,D.KEEP,D.KEEP))}else Ci.u_alpha_discard_threshold=ze&&Ot&&yt?.8:0,yr(Ot?Mt:l.stencilModeForClipping(zt))}},Pe=l.depthModeForSublayer(0,bt.ReadOnly),$e=new bt(l.depthOcclusion?D.GREATER:D.LEQUAL,bt.ReadOnly,l.depthRangeFor3D);if(o.hasNonElevatedBuckets){let Ze=!Z&&l.terrain;x!==0&&Ze?n.w(`Occlusion opacity for layer ${o.id} is supported on terrain only if the layer has line-z-offset enabled.`):Ze?n.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${o.id}.`):ke(c,Ce,Pe,Gt.disabled,!1,!0)}if(o.hasElevatedBuckets){b==="hd-road-markup"?z||(Pe=$e,Ce.push("ELEVATED_ROADS")):(Ce.push("ELEVATED"),Pe=$e,F&&Ce.push(j?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),C&&Ce.push("ELEVATION_REFERENCE_SEA"));let Ze=ze?l.stencilModeFor3D():Gt.disabled;l.forceTerrainMode=!0,ke(c,Ce,Pe,Ze,!0,!0),ze&&ke(c,Ce,Pe,Ze,!0,!1),l.forceTerrainMode=!1}ze&&(l.resetStencilClippingMasks(),Z&&P.clear({stencil:0})),x===0||l.depthOcclusion||Z||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,o,c){let d=o.paint.get("fill-color"),p=o.paint.get("fill-opacity");if(p.constantOr(1)===0)return;let _=o.paint.get("fill-emissive-strength"),x=l.colorModeForDrapableLayerRenderPass(_),b=o.paint.get("fill-pattern"),M=l.opaquePassEnabledForLayer()&&!b.constantOr(1)&&d.constantOr(n.am.transparent).a===1&&p.constantOr(0)===1?"opaque":"translucent",C="none";o.layout.get("fill-elevation-reference")!=="none"?C="road":o.paint.get("fill-z-offset").constantOr(1)!==0&&(C="offset");let z=!(!l.terrain||!l.terrain.enabled),P={painter:l,sourceCache:t,layer:o,coords:c,colorMode:x,elevationType:C,terrainEnabled:z,pass:M};if(l.renderPass!=="shadow")if(C!=="offset"){if(au(P,!1),C==="road"){let D=!z&&l.renderPass==="translucent";D&&Tt(l,t,o,c,"geometry"),au(P,!0,Gt.disabled),D&&function(N){let{painter:F,sourceCache:j,layer:U,coords:Z,colorMode:Y}=N,Q=F.context.gl,ne=N.painter.shadowRenderer,he=!!ne&&ne.enabled,de=new bt(F.context.gl.LEQUAL,bt.ReadOnly,F.depthRangeFor3D),oe=[0,0,0];if(he){let le=F.style.directionalLight,Me=F.style.ambientLight;le&&Me&&(oe=Ma(F.style,le,Me))}let se=le=>{for(let Me of Z){let _e=j.getTile(Me),Ve=_e.getBucket(U);if(!Ve)continue;let ze=Ve.elevatedStructures;if(!ze)continue;let je,rt;if(le?(je=ze.renderableBridgeSegments,rt=ze.bridgeProgramConfigurations.get(U.id)):(je=ze.renderableTunnelSegments,rt=ze.tunnelProgramConfigurations.get(U.id)),!je||je.segments[0].primitiveLength===0)continue;rt.updatePaintBuffers(),F.prepareDrawTile();let Ce=F.isTileAffectedByFog(Me),me=[];he&&me.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");let ke=F.getOrCreateProgram("elevatedStructures",{config:rt,overrideFog:Ce,defines:me}),Pe=F.translatePosMatrix(Me.projMatrix,_e,U.paint.get("fill-translate"),U.paint.get("fill-translate-anchor"));he&&ne.setupShadows(_e.tileID.toUnwrapped(),ke,"vector-tile");let $e=Mg(Pe,oe);F.uploadCommonUniforms(F.context,ke,Me.toUnwrapped()),ke.draw(F,Q.TRIANGLES,de,Gt.disabled,Y,Nt.backCCW,$e,U.id,ze.vertexBuffer,ze.indexBuffer,je,U.paint,F.transform.zoom,rt,[ze.vertexBufferNormal])}};se(!0),se(!1)}(P)}}else au(P,!1,l.stencilModeFor3D());else l.shadowRenderer&&C==="road"&&!z&&function(D){let{painter:N,sourceCache:F,layer:j,coords:U}=D,Z=N.context.gl,Y=D.painter.shadowRenderer;for(let Q of U){let ne=F.getTile(Q),he=ne.getBucket(j);if(!he)continue;let de=he.elevatedStructures;if(!de||!de.shadowCasterSegments||de.shadowCasterSegments.segments[0].primitiveLength===0)continue;N.prepareDrawTile();let oe=he.bufferData.programConfigurations.get(j.id),se=N.isTileAffectedByFog(Q),le=N.getOrCreateProgram("elevatedStructuresDepth",{config:oe,overrideFog:se}),Me=Y.calculateShadowPassMatrixFromTile(ne.tileID.toUnwrapped());N.uploadCommonUniforms(N.context,le,Q.toUnwrapped());let _e={u_matrix:Me,u_depth_bias:0};le.draw(N,Z.TRIANGLES,Y.getShadowPassDepthMode(),Gt.disabled,Y.getShadowPassColorMode(),Nt.disabled,_e,j.id,de.vertexBuffer,de.indexBuffer,de.shadowCasterSegments,j.paint,N.transform.zoom,oe)}}(P)},"fill-extrusion":function(l,t,o,c){let d=o.paint.get("fill-extrusion-opacity"),p=l.context,_=p.gl,x=l.terrain,b=x&&x.renderingToTexture;if(d===0)return;let M=l.conflationActive&&l.style.isLayerClipped(o,t.getSource()),C=l.style.order.indexOf(o.fqid);if(M&&function(z,P,D,N,F){for(let j of N){let U=P.getTile(j).getBucket(D);U&&(U.updateReplacement(j,z.replacementSource,F),U.uploadCentroid(z.context))}}(l,t,o,c,C),x||M)for(let z of c){let P=t.getTile(z).getBucket(o);P&&Ut(l.context,t,z,P,o,x,M)}if(l.renderPass==="shadow"&&l.shadowRenderer){let z=l.shadowRenderer;if(x&&d<.65&&o._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof n.ab)return;let P=z.getShadowPassDepthMode(),D=z.getShadowPassColorMode();Vc(l,t,o,c,P,Gt.disabled,D,M)}else if(l.renderPass==="translucent"){let z=!o.paint.get("fill-extrusion-pattern").constantOr(1),P=o.paint.get("fill-extrusion-color").constantOr(n.am.white);if(!b&&P.a!==0){let D=new bt(l.context.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D);d===1&&z?Vc(l,t,o,c,D,Gt.disabled,ti.unblended,M):(Vc(l,t,o,c,D,Gt.disabled,ti.disabled,M),Vc(l,t,o,c,D,l.stencilModeFor3D(),l.colorModeForRenderPass(),M),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&z&&(!x&&l.transform.projection.name!=="globe"||b)){let D=o.paint.get("fill-extrusion-opacity"),N=o.paint.get("fill-extrusion-ambient-occlusion-intensity"),F=o.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),j=o.paint.get("fill-extrusion-flood-light-intensity"),U=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Z=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(U?null:o.lut).toArray01().slice(0,3),Y=N>0&&F>0,Q=j>0,ne=(oe,se,le)=>(1-le)*oe+le*se,he=new Ps;he.translate=o.paint.get("fill-extrusion-translate"),he.translateAnchor=o.paint.get("fill-extrusion-translate-anchor"),he.edgeRadius=o.layout.get("fill-extrusion-edge-radius"),he.cutoffFadeRange=o.paint.get("fill-extrusion-cutoff-fade-range");let de=oe=>{let se=l.depthModeForSublayer(1,bt.ReadOnly,_.LEQUAL,!0),le=o.paint.get(oe?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Me=ne(.1,3,le),_e=l._showOverdrawInspector;if(!_e){let Ve=new Gt({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),ze=new ti([_.ONE,_.ONE,_.ONE,_.ONE],n.am.transparent,[!1,!1,!1,!0],_.MIN);Hn(he,l,t,o,c,se,Ve,ze,Nt.disabled,oe,"sdf",D,N,F,j,Z,Me,M,!1)}{let Ve=_e?Gt.disabled:new Gt({func:_.EQUAL,mask:255},255,255,_.KEEP,_.DECR,_.DECR),ze=_e?l.colorModeForRenderPass():new ti([_.ONE_MINUS_DST_ALPHA,_.DST_ALPHA,_.ONE,_.ONE],n.am.transparent,[!0,!0,!0,!0]);Hn(he,l,t,o,c,se,Ve,ze,Nt.disabled,oe,"color",D,N,F,j,Z,Me,M,!1)}};if(b){let oe=(se,le,Me)=>{let _e=l.depthModeForSublayer(1,bt.ReadOnly,_.LEQUAL,!1),Ve=o.paint.get(se?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ze=ne(.1,3,Ve);{let je=new ti([_.ONE,_.ONE,_.ONE,_.ONE],n.am.transparent,[!1,!1,!1,!0]);Hn(he,l,t,o,c,_e,Gt.disabled,je,Nt.disabled,se,"clear",D,N,F,j,Z,ze,M,le)}{let je=new Gt({func:_.ALWAYS,mask:255},255,255,_.KEEP,_.KEEP,_.REPLACE),rt=new ti([_.ONE,_.ONE,_.ONE,_.ONE],n.am.transparent,[!1,!1,!1,!0],_.MIN);Hn(he,l,t,o,c,_e,je,rt,Nt.disabled,se,"sdf",D,N,F,j,Z,ze,M,le)}{let je=se?_.ZERO:_.ONE_MINUS_DST_ALPHA,rt=new Gt({func:_.EQUAL,mask:255},255,255,_.KEEP,_.DECR,_.DECR),Ce=new ti([je,_.DST_ALPHA,_.ONE_MINUS_DST_ALPHA,_.ZERO],n.am.transparent,[!0,!0,!0,!0]);Hn(he,l,t,o,c,_e,rt,Ce,Nt.disabled,se,"color",D,N,F,j,Z,ze,M,le)}{let je=new ti([_.ONE,_.ONE,_.ONE,se?_.ZERO:_.ONE],n.am.transparent,[!1,!1,!1,!0],se?_.FUNC_ADD:_.MAX);Hn(he,l,t,o,c,_e,Gt.disabled,je,Nt.disabled,se,"clear",D,N,F,j,Z,ze,M,le,Me)}};if(Y||Q){let se;if(l.prepareDrawTile(),x){let le=x.drapeBufferSize[0],Me=x.drapeBufferSize[1];se=x.framebufferCopyTexture,se&&(!se||se.size[0]===le&&se.size[1]===Me)||(se&&se.destroy(),se=x.framebufferCopyTexture=new n.T(p,new n.r({width:le,height:Me}),_.RGBA8)),se.bind(_.LINEAR,_.CLAMP_TO_EDGE),_.copyTexSubImage2D(_.TEXTURE_2D,0,0,0,0,0,le,Me)}Y&&oe(!0,!1,se),Q&&oe(!1,!0,se)}}else Y&&de(!0),Q&&de(!1),(Y||Q)&&l.resetStencilClippingMasks()}}},building:function(l,t,o,c){l.currentLayer<l.firstLightBeamLayer&&(l.firstLightBeamLayer=l.currentLayer);let d=o.paint.get("building-ambient-occlusion-ground-intensity"),p=o.paint.get("building-ambient-occlusion-ground-radius"),_=o.paint.get("building-ambient-occlusion-ground-attenuation"),x=d>0&&p>0,b=!0,M=o.paint.get("building-vertical-scale");M<1&&(b=!1);let C=l.conflationActive&&l.style.isLayerClipped(o,t.getSource()),z=l.style.order.indexOf(o.fqid);if(function(P,D,N,F,j,U){for(let Z of U){let Y=D.getTile(Z).getBucket(N);Y&&(j&&Y.updateReplacement(Z,P.replacementSource,F),Y.uploadUpdatedIndexBuffer(P.context))}}(l,t,o,z,C,c),function(P,D,N,F){for(let j of F){let U=D.getTile(j).getBucket(N);U&&U.needsEvaluation(P,N)&&(U.evaluate(N),U.uploadUpdatedColorBuffer(P.context))}}(l,t,o,c),o.resetLayerRenderingStats(l),l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0),l.renderPass==="shadow"&&l.shadowRenderer){let P=l.shadowRenderer,D=[],N=P.getShadowPassDepthMode();cu({painter:l,source:t,layer:o,coords:c,defines:D,blendMode:P.getShadowPassColorMode(),depthMode:N,verticalScale:M})}else if(l.renderPass==="translucent"){x&&function(F,j,U,Z,Y,Q,ne,he,de,oe,se,le,Me){let _e=F.context.gl,Ve=F.depthModeForSublayer(1,bt.ReadOnly,_e.LEQUAL,!0),ze=.1*(1-(je=se))+3*je;var je;let rt=F._showOverdrawInspector,Ce=le,me=new Ps;rt||Hn(me,F,j,U,Z,Ve,new Gt({func:_e.ALWAYS,mask:255},255,255,_e.KEEP,_e.KEEP,_e.REPLACE),new ti([_e.ONE,_e.ONE,_e.ONE,_e.ONE],n.am.transparent,[!1,!1,!1,!0],_e.MIN),Nt.disabled,Y,"sdf",1,ne,he,0,oe,ze,Ce,!1);{let ke=rt?Gt.disabled:new Gt({func:_e.EQUAL,mask:255},255,255,_e.KEEP,_e.DECR,_e.DECR),Pe=rt?F.colorModeForRenderPass():new ti([_e.ONE_MINUS_DST_ALPHA,_e.DST_ALPHA,_e.ONE,_e.ONE],n.am.transparent,[!0,!0,!0,!0]);Hn(me,F,j,U,Z,Ve,ke,Pe,Nt.disabled,Y,"color",1,ne,he,0,oe,ze,Ce,!1)}}(l,t,o,c,!0,0,d,p,0,[0,0,0],_,C);let P=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];b&&(P=P.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),l.shadowRenderer.useNormalOffset&&(P=P.concat("NORMAL_OFFSET"));let D=new bt(l.context.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),N=l.colorModeForRenderPass();cu({painter:l,source:t,layer:o,coords:c,defines:P,blendMode:N,depthMode:D,verticalScale:M})}else if(l.renderPass==="light-beam"){let P=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],D=new bt(l.context.gl.LEQUAL,bt.ReadOnly,l.depthRangeFor3D);cu({painter:l,source:t,layer:o,coords:c,defines:P,blendMode:ti.alphaBlended,depthMode:D,verticalScale:M})}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1),l.resetStencilClippingMasks()},hillshade:function(l,t,o,c){if(l.renderPass!=="offscreen"&&l.renderPass!=="translucent"||l.style.disableElevatedTerrain)return;let d=l.context,p=l.terrain&&l.terrain.renderingToTexture,[_,x]=l.renderPass!=="translucent"||p?[{},c]:l.stencilConfigForOverlap(c);for(let b of x){let M=t.getTile(b);if(M.needsHillshadePrepare&&l.renderPass==="offscreen")qf(l,M,o);else if(l.renderPass==="translucent"){let C=l.depthModeForSublayer(0,bt.ReadOnly),z=o.paint.get("hillshade-emissive-strength"),P=l.colorModeForDrapableLayerRenderPass(z),D=p&&l.terrain?l.terrain.stencilModeForRTTOverlap(b):_[b.overscaledZ];yg(l,b,M,o,C,D,P)}}d.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,o,c,d,p){if(l.renderPass!=="translucent"||o.paint.get("raster-opacity")===0)return;let _=l.transform.projection.name==="globe",x=o.paint.get("raster-elevation")!==0,b=x&&_;if(l.renderElevatedRasterBackface&&!b)return;let M=l.context,C=M.gl,z=t.getSource(),P=function(he,de,oe,se){let le=de.paint.get("raster-color"),Me=he.type==="raster-array",_e=[],Ve=de.paint.get("raster-resampling"),ze=de.paint.get("raster-color-mix"),je=de.paint.get("raster-color-range"),rt=[ze[0],ze[1],ze[2],0],Ce=ze[3],me=Ve==="nearest"?se.NEAREST:se.LINEAR;if(Me&&(_e.push("RASTER_ARRAY"),le||_e.push("RASTER_COLOR"),Ve==="linear"&&_e.push("RASTER_ARRAY_LINEAR"),me=se.NEAREST,!je&&he.rasterLayers)){let ke=he.rasterLayers.find(({id:Pe})=>Pe===de.sourceLayer);ke&&ke.fields&&ke.fields.range&&(je=ke.fields.range)}if(je=je||[0,1],le){_e.push("RASTER_COLOR"),oe.activeTexture.set(se.TEXTURE2),de.updateColorRamp(je);let ke=de.colorRampTexture;ke||(ke=de.colorRampTexture=new n.T(oe,de.colorRamp,se.RGBA8)),ke.bind(se.LINEAR,se.CLAMP_TO_EDGE)}return{mix:rt,range:je,offset:Ce,defines:_e,resampling:me}}(z,o,M,C);if(z instanceof n.aP&&!c.length&&!_)return;let D=o.paint.get("raster-emissive-strength"),N=l.colorModeForDrapableLayerRenderPass(D),F=l.terrain&&l.terrain.renderingToTexture,j=!l.options.moving,U=o.paint.get("raster-resampling")==="nearest"?C.NEAREST:C.LINEAR;if(z instanceof n.aP&&!c.length&&(z.onNorthPole||z.onSouthPole)){let he=x?l.stencilModeFor3D():Gt.disabled;return void hu(!!z.onNorthPole,null,l,t,o,D,P,Nt.disabled,he)}if(!c.length)return;let[Z,Y]=z instanceof n.aP||F?[{},c]:l.stencilConfigForOverlap(c),Q=Y[Y.length-1].overscaledZ;b&&P.defines.push("PROJECTION_GLOBE_VIEW"),x&&P.defines.push("RENDER_CUTOFF");let ne=(he,de,oe)=>{for(let se of he){let le=se.toUnwrapped(),Me=t.getTile(se);if(F&&(!Me||!Me.hasData()))continue;M.activeTexture.set(C.TEXTURE0);let _e=Lg(Me,z,o,P);if(!_e||!_e.texture)continue;let{texture:Ve,mix:ze,offset:je,tileSize:rt,buffer:Ce}=_e,me,ke;F?(me=bt.disabled,ke=se.projMatrix):x?(me=new bt(C.LEQUAL,bt.ReadWrite,l.depthRangeFor3D),ke=_?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(le,j)):(me=l.depthModeForSublayer(se.overscaledZ-Q,o.paint.get("raster-opacity")===1?bt.ReadWrite:bt.ReadOnly,C.LESS),ke=l.transform.calculateProjMatrix(le,j));let Pe=l.terrain&&F?l.terrain.stencilModeForRTTOverlap(se):Z[se.overscaledZ],$e=p?0:o.paint.get("raster-fade-duration");Me.registerFadeDuration($e);let Ze=t.findLoadedParent(se,0),Ye=qn(Me,Ze,t,l.transform,$e),ct,Mt;l.terrain&&l.terrain.prepareDrawTile(),M.activeTexture.set(C.TEXTURE0),Ve.bind(U,C.CLAMP_TO_EDGE),M.activeTexture.set(C.TEXTURE1),Ze?(Ze.texture&&Ze.texture.bind(U,C.CLAMP_TO_EDGE),ct=Math.pow(2,Ze.tileID.overscaledZ-Me.tileID.overscaledZ),Mt=[Me.tileID.canonical.x*ct%1,Me.tileID.canonical.y*ct%1]):Ve.bind(U,C.CLAMP_TO_EDGE),"useMipmap"in Ve&&M.extTextureFilterAnisotropic&&l.transform.pitch>20&&C.texParameterf(C.TEXTURE_2D,M.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,M.extTextureFilterAnisotropicMax);let Ot=l.transform,yt,zt=x?Rg(Ot):[0,0,0,0],Rt,$t,Jt,ai,Ti,Yt=0;if(b&&z instanceof n.aP&&z.coordinates.length>3)Rt=Float32Array.from(n.bh(n.dD(new n.cA(0,0,0)))),$t=Float32Array.from(Ot.globeMatrix),Jt=Float32Array.from(n.dz(Ot)),ai=[n.aD(Ot.center.lng),n.aH(Ot.center.lat)],yt=z.elevatedGlobePerspectiveTransform,Ti=z.elevatedGlobeGridMatrix||new Float32Array(9);else if(b){let ni=n.dA(se.canonical);Yt=n.dB(ni.getCenter().lat),Rt=Float32Array.from(n.bh(n.dD(se.canonical))),$t=Float32Array.from(Ot.globeMatrix),Jt=Float32Array.from(n.dz(Ot)),ai=[n.aD(Ot.center.lng),n.aH(Ot.center.lat)],yt=[0,0],Ti=Float32Array.from(n.dC(se.canonical,ni,Yt,Ot.worldSize/Ot._pixelsPerMercatorPixel))}else yt=z instanceof n.aP?z.perspectiveTransform:[0,0],Rt=new Float32Array(16),$t=new Float32Array(9),Jt=new Float32Array(16),ai=[0,0],Ti=new Float32Array(9);let Si=Ud(ke,Rt,$t,Jt,Ti,Mt||[0,0],n.ah(l.transform.zoom),ai,zt,ct||1,Ye,o,yt,x?o.paint.get("raster-elevation"):0,2,ze,je,P.range,rt,Ce,D),Mi=l.isTileAffectedByFog(se),Wi=l.getOrCreateProgram("raster",{defines:P.defines,overrideFog:Mi});if(l.uploadCommonUniforms(M,Wi,le),z instanceof n.aP){let ni=z.elevatedGlobeVertexBuffer,Ei=z.elevatedGlobeIndexBuffer;if(F||!_)z.boundsBuffer&&z.boundsSegments&&Wi.draw(l,C.TRIANGLES,me,Gt.disabled,N,Nt.disabled,Si,o.id,z.boundsBuffer,l.quadTriangleIndexBuffer,z.boundsSegments);else if(ni&&Ei){let Ii=Ot.zoom<=n.cX?z.elevatedGlobeSegments:z.getSegmentsForLongitude(Ot.center.lng);Ii&&Wi.draw(l,C.TRIANGLES,me,Gt.disabled,N,de,Si,o.id,ni,Ei,Ii)}}else if(b){me=new bt(C.LEQUAL,bt.ReadOnly,l.depthRangeFor3D);let ni=l.globeSharedBuffers;if(ni){let[Ei,Ii,Ri]=ni.getGridBuffers(Yt,!1);Wi.draw(l,C.TRIANGLES,me,oe||Pe,l.colorModeForRenderPass(),de,Si,o.id,Ei,Ii,Ri)}}else{let{tileBoundsBuffer:ni,tileBoundsIndexBuffer:Ei,tileBoundsSegments:Ii}=l.getTileBoundsBuffers(Me);Wi.draw(l,C.TRIANGLES,me,Pe,N,Nt.disabled,Si,o.id,ni,Ei,Ii)}}if(!(z instanceof n.aP)&&b)for(let se of he){let le=se.canonical.y===(1<<se.canonical.z)-1;se.canonical.y===0&&hu(!0,se,l,t,o,D,P,de,oe||Gt.disabled),le&&hu(!1,se,l,t,o,D,P,de===Nt.frontCW?Nt.backCW:Nt.frontCW,oe||Gt.disabled)}};b?ne(Y,l.renderElevatedRasterBackface?Nt.backCW:Nt.frontCW,l.stencilModeFor3D()):ne(Y,Nt.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,o,c,d,p){l.renderPass==="offscreen"&&function(_,x,b,M){if(!M.length)return;let C=_.context,z=C.gl,P=x.getSource();if(!(P instanceof js))return;let D=Math.ceil(Math.sqrt(b.paint.get("raster-particle-count"))),N=b.particlePositionRGBAImage;if(!N||N.width!==D){let Y=function(Q){let ne=Q*Q,he=new Uint8Array(4*ne),de=function(se){return se|=0,se=Math.imul(2747636419^se,2654435769),se=Math.imul(se^se>>>16,2654435769),((se=Math.imul(se^se>>>16,2654435769))>>>0)/4294967296},oe=1/1.1;for(let se=0;se<ne;se++){let le=oe*(de(2*se+0)+Qs),Me=oe*(de(2*se+1)+Qs),_e=255*le%1,Ve=255*Me%1,ze=_e,je=Me-Ve/255,rt=Ve;he[4*se+0]=255*(le-_e/255),he[4*se+1]=255*ze,he[4*se+2]=255*je,he[4*se+3]=255*rt}return he}(D);N=b.particlePositionRGBAImage=new n.r({width:D,height:D},Y)}let F=b.particleFramebuffer;F?F.width!==D&&(F.destroy(),F=b.particleFramebuffer=C.createFramebuffer(D,D,!0,null)):F=b.particleFramebuffer=C.createFramebuffer(D,D,!0,null);let j=[];for(let Y of M){let Q=x.getTile(Y);if(!(Q instanceof el))continue;let ne=Dn(Q,P,b);if(!ne)continue;let he=[Q.tileSize,Q.tileSize],de=b.tileFramebuffer;de||(de=b.tileFramebuffer=C.createFramebuffer(he[0],he[1],!0,null));let oe=Q.rasterParticleState;oe||(oe=Q.rasterParticleState=new Yd(C,Y,he,N));let se=oe.update(b.lastInvalidatedAt);oe.particleTextureDimension!==D&&oe.updateParticleTexture(Y,N);let le=oe.targetColorTexture;oe.targetColorTexture=oe.backgroundColorTexture,oe.backgroundColorTexture=le;let Me=oe.particleTexture0;oe.particleTexture0=oe.particleTexture1,oe.particleTexture1=Me,j.push([Y,ne,oe,se])}if(j.length===0)return;let U=n.q.now(),Z=b.previousDrawTimestamp?.001*(U-b.previousDrawTimestamp):.0167;if(b.previousDrawTimestamp=U,b.hasColorMap()){C.activeTexture.set(z.TEXTURE0+2);let Y=b.colorRampTexture;Y||(Y=b.colorRampTexture=new n.T(C,b.colorRamp,z.RGBA8)),Y.bind(z.LINEAR,z.CLAMP_TO_EDGE)}C.bindFramebuffer.set(b.tileFramebuffer.framebuffer),function(Y,Q,ne){let he=Y.context,de=he.gl,oe=Q.tileFramebuffer;he.activeTexture.set(de.TEXTURE0);let se={u_texture:0,u_opacity:1.05*(Me=Q.paint.get("raster-particle-fade-opacity-factor"))/(Me+.05)},le=Y.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Me;for(let _e of ne){let[,,Ve,ze]=_e;oe.colorAttachment.set(Ve.targetColorTexture.texture),he.viewport.set([0,0,oe.width,oe.height]),he.clear({color:n.am.transparent}),ze&&(Ve.backgroundColorTexture.bind(de.NEAREST,de.CLAMP_TO_EDGE),le.draw(Y,de.TRIANGLES,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,se,Q.id,Y.viewportBuffer,Y.quadTriangleIndexBuffer,Y.viewportSegments))}}(_,b,j),function(Y,Q,ne,he){let de=Y.context,oe=de.gl,se=ne.tileFramebuffer,le=Y.transform.projection.name==="globe",Me=ne.paint.get("raster-particle-max-speed");for(let _e of he){let[Ve,ze,je]=_e;de.activeTexture.set(oe.TEXTURE0+0),ze.texture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE),se.colorAttachment.set(je.targetColorTexture.texture);let rt=Y.getOrCreateProgram("rasterParticleDraw",{defines:ze.defines,overrideFog:!1});de.activeTexture.set(oe.TEXTURE0+1);let Ce=ze.scalarData?[]:[0,1,2,3].map(Pe=>n.e3[Pe](Ve));Ce.push(Ve);let me=Ve.canonical.x,ke=Ve.canonical.y;for(let Pe of Ce){let $e=Q.getTile(le?Pe.wrapped():Pe);if(!$e)continue;let Ze=$e.rasterParticleState;if(!Ze)continue;let Ye=Pe.canonical.x+(1<<Pe.canonical.z)*(Pe.wrap-Ve.wrap),ct=Pe.canonical.y;Ze.particleTexture0.bind(oe.NEAREST,oe.CLAMP_TO_EDGE);let Mt=am(1,Ze.particleTexture0.size[0],[Ye-me,ct-ke],0,ze.texture.size,2,Me,ze.textureOffset,ze.scale,ze.offset);rt.draw(Y,oe.POINTS,bt.disabled,Gt.disabled,ti.alphaBlended,Nt.disabled,Mt,ne.id,Ze.particleIndexBuffer,void 0,Ze.particleSegment)}}}(_,x,b,j),C.bindFramebuffer.set(b.particleFramebuffer.framebuffer),function(Y,Q,ne,he){let de=Y.context,oe=de.gl,se=Q.paint.get("raster-particle-max-speed"),le=he*Q.paint.get("raster-particle-speed-factor")*.15,Me=function(Ve){return Math.pow(Ve,6)}(.01+1*Q.paint.get("raster-particle-reset-rate-factor")),_e=Q.particleFramebuffer;de.viewport.set([0,0,_e.width,_e.height]);for(let Ve of ne){let[,ze,je]=Ve;de.activeTexture.set(oe.TEXTURE0+0),ze.texture.bind(oe.LINEAR,oe.CLAMP_TO_EDGE),de.activeTexture.set(oe.TEXTURE0+1);let rt=je.particleTexture0;rt.bind(oe.NEAREST,oe.CLAMP_TO_EDGE);let Ce=lm(1,rt.size[0],0,ze.texture.size,se,le,Me,ze.textureOffset,ze.scale,ze.offset);_e.colorAttachment.set(je.particleTexture1.texture),de.clear({color:n.am.transparent}),Y.getOrCreateProgram("rasterParticleUpdate",{defines:ze.defines}).draw(Y,oe.TRIANGLES,bt.disabled,Gt.disabled,ti.unblended,Nt.disabled,Ce,Q.id,Y.viewportBuffer,Y.quadTriangleIndexBuffer,Y.viewportSegments)}}(_,b,j,Z)}(l,t,o,c),l.renderPass==="translucent"&&(function(_,x,b,M,C){let z=_.context,P=z.gl,D=x.getSource().tileSize,N=5*(1-n.af(n.cI,n.cI+1,_.transform.zoom))*D+b.paint.get("raster-particle-elevation"),F=!_.options.moving,j=_.transform.projection.name==="globe";if(!M.length)return;let[U,Z]=_.stencilConfigForOverlap(M),Y=[];j&&Y.push("PROJECTION_GLOBE_VIEW");let Q=_.stencilModeFor3D();for(let ne of Z){let he=ne.toUnwrapped(),de=x.getTile(ne);if(!de.rasterParticleState)continue;let oe=de.rasterParticleState,se=100;de.registerFadeDuration(se);let le=x.findLoadedParent(ne,0),Me=qn(de,le,x,_.transform,se),_e,Ve;_.terrain&&_.terrain.prepareDrawTile(),z.activeTexture.set(P.TEXTURE0),oe.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),z.activeTexture.set(P.TEXTURE1),le&&le.rasterParticleState?(le.rasterParticleState.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE),_e=Math.pow(2,le.tileID.overscaledZ-de.tileID.overscaledZ),Ve=[de.tileID.canonical.x*_e%1,de.tileID.canonical.y*_e%1]):oe.targetColorTexture.bind(P.LINEAR,P.CLAMP_TO_EDGE);let ze=j?Float32Array.from(_.transform.expandedFarZProjMatrix):_.transform.calculateProjMatrix(he,F),je=_.transform,rt=ra(je),Ce=n.dA(ne.canonical),me=n.dB(Ce.getCenter().lat),ke,Pe,$e,Ze,Ye;j?(ke=Float32Array.from(n.bh(n.dD(ne.canonical))),Pe=Float32Array.from(je.globeMatrix),$e=Float32Array.from(n.dz(je)),Ze=[n.aD(je.center.lng),n.aH(je.center.lat)],Ye=Float32Array.from(n.dC(ne.canonical,Ce,me,je.worldSize/je._pixelsPerMercatorPixel))):(ke=new Float32Array(16),Pe=new Float32Array(9),$e=new Float32Array(16),Ze=[0,0],Ye=new Float32Array(9));let ct=ru(ze,ke,Pe,$e,Ye,Ve||[0,0],n.ah(_.transform.zoom),Ze,rt,_e||1,Me,N),Mt=_.isTileAffectedByFog(ne),Ot=_.getOrCreateProgram("rasterParticle",{defines:Y,overrideFog:Mt});if(_.uploadCommonUniforms(z,Ot,he),j){let yt=new bt(P.LEQUAL,bt.ReadOnly,_.depthRangeFor3D),zt=0,Rt=_.globeSharedBuffers;if(Rt){let[$t,Jt,ai]=Rt.getGridBuffers(me,zt!==0);Ot.draw(_,P.TRIANGLES,yt,Q,ti.alphaBlended,_.renderElevatedRasterBackface?Nt.frontCCW:Nt.backCCW,ct,b.id,$t,Jt,ai)}}else{let yt=_.depthModeForSublayer(0,bt.ReadOnly),zt=U[ne.overscaledZ],{tileBoundsBuffer:Rt,tileBoundsIndexBuffer:$t,tileBoundsSegments:Jt}=_.getTileBoundsBuffers(de);Ot.draw(_,P.TRIANGLES,yt,zt,ti.alphaBlended,Nt.disabled,ct,b.id,Rt,$t,Jt)}}_.resetStencilClippingMasks()}(l,t,o,c),l.style.map.triggerRepaint())},background:function(l,t,o,c){let d=o.paint.get("background-color"),p=o.paint.get("background-color-use-theme").constantOr("default")==="none",_=o.paint.get("background-opacity"),x=o.paint.get("background-emissive-strength"),b=o.paint.get("background-pitch-alignment")==="viewport";if(_===0)return;let M=l.context,C=M.gl,z=l.transform,P=z.tileSize,D=o.paint.get("background-pattern"),N;if(D!==void 0&&(D===null||(N=l.imageManager.getPattern(n.I.from(D.toString()),o.scope,l.style.getLut(o.scope)),!N)))return;let F=!D&&d.a===1&&_===1&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==F)return;let j=Gt.disabled,U=l.depthModeForSublayer(0,F==="opaque"?bt.ReadWrite:bt.ReadOnly),Z=l.colorModeForDrapableLayerRenderPass(x),Y=D?"backgroundPattern":"background",Q,ne=c;if(ne||(Q=l.getBackgroundTiles(),ne=Object.values(Q).map(he=>he.tileID)),D&&(M.activeTexture.set(C.TEXTURE0),l.imageManager.bind(l.context,o.scope)),b){let he=l.getOrCreateProgram(Y,{overrideFog:!1,overrideRtt:!0}),de=new Float32Array(n.bx([])),oe=new n.aM(0,0,0,0,0),se=D?jd(de,x,_,l,0,o.scope,N,b,{tileID:oe,tileSize:P}):cm(de,x,_,d.toPremultipliedRenderColor(p?null:o.lut));he.draw(l,C.TRIANGLES,U,j,Z,Nt.disabled,se,o.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(let he of ne){let de=l.isTileAffectedByFog(he),oe=l.getOrCreateProgram(Y,{overrideFog:de}),se=he.toUnwrapped(),le=c?he.projMatrix:l.transform.calculateProjMatrix(se);l.prepareDrawTile();let Me=t?t.getTile(he):Q?Q[he.key]:new ba(he,P,z.zoom,l),_e=D?jd(le,x,_,l,0,o.scope,N,b,{tileID:he,tileSize:P}):cm(le,x,_,d.toPremultipliedRenderColor(p?null:o.lut));l.uploadCommonUniforms(M,oe,se);let{tileBoundsBuffer:Ve,tileBoundsIndexBuffer:ze,tileBoundsSegments:je}=l.getTileBoundsBuffers(Me);oe.draw(l,C.TRIANGLES,U,j,Z,Nt.disabled,_e,o.id,Ve,ze,je)}},sky:function(l,t,o){let c=l._atmosphere?n.ah(l.transform.zoom):1,d=o.paint.get("sky-opacity")*c;if(d===0)return;let p=l.context,_=o.paint.get("sky-type"),x=new bt(p.gl.LEQUAL,bt.ReadOnly,[0,1]),b=l.frameCounter/1e3%1;_==="atmosphere"?l.renderPass==="offscreen"?o.needsSkyboxCapture(l)&&(function(M,C,z,P){let D=M.context,N=D.gl,F=C.skyboxFbo;if(!F){F=C.skyboxFbo=D.createFramebuffer(32,32,!0,null),C.skyboxGeometry=new ka(D),C.skyboxTexture=D.gl.createTexture(),N.bindTexture(N.TEXTURE_CUBE_MAP,C.skyboxTexture),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MIN_FILTER,N.LINEAR),N.texParameteri(N.TEXTURE_CUBE_MAP,N.TEXTURE_MAG_FILTER,N.LINEAR);for(let Y=0;Y<6;++Y)N.texImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+Y,0,N.RGBA,32,32,0,N.RGBA,N.UNSIGNED_BYTE,null)}D.bindFramebuffer.set(F.framebuffer),D.viewport.set([0,0,32,32]);let j=C.getCenter(M,!0),U=M.getOrCreateProgram("skyboxCapture"),Z=new Float64Array(16);n.bx(Z),n.eh(Z,Z,.5*-Math.PI),Ko(M,C,U,Z,j,0),n.bx(Z),n.eh(Z,Z,.5*Math.PI),Ko(M,C,U,Z,j,1),n.bx(Z),n.cR(Z,Z,.5*-Math.PI),Ko(M,C,U,Z,j,2),n.bx(Z),n.cR(Z,Z,.5*Math.PI),Ko(M,C,U,Z,j,3),n.bx(Z),Ko(M,C,U,Z,j,4),n.bx(Z),n.eh(Z,Z,Math.PI),Ko(M,C,U,Z,j,5),D.viewport.set([0,0,M.width,M.height])}(l,o),o.markSkyboxValid(l)):l.renderPass==="sky"&&function(M,C,z,P,D){let N=M.context,F=N.gl,j=M.transform,U=M.getOrCreateProgram("skybox");N.activeTexture.set(F.TEXTURE0),F.bindTexture(F.TEXTURE_CUBE_MAP,C.skyboxTexture);let Z=((Y,Q,ne,he,de)=>({u_matrix:Y,u_sun_direction:Q,u_cubemap:0,u_opacity:he,u_temporal_offset:de}))(j.skyboxMatrix,C.getCenter(M,!1),0,P,D);M.uploadCommonUniforms(N,U),U.draw(M,F.TRIANGLES,z,Gt.disabled,M.colorModeForRenderPass(),Nt.backCW,Z,"skybox",C.skyboxGeometry.vertexBuffer,C.skyboxGeometry.indexBuffer,C.skyboxGeometry.segment)}(l,o,x,d,b):_==="gradient"&&l.renderPass==="sky"&&function(M,C,z,P,D){let N=M.context,F=N.gl,j=M.transform,U=M.getOrCreateProgram("skyboxGradient");C.skyboxGeometry||(C.skyboxGeometry=new ka(N)),N.activeTexture.set(F.TEXTURE0);let Z=C.colorRampTexture;Z||(Z=C.colorRampTexture=new n.T(N,C.colorRamp,F.RGBA8)),Z.bind(F.LINEAR,F.CLAMP_TO_EDGE);let Y=((Q,ne,he,de,oe)=>({u_matrix:Q,u_color_ramp:0,u_center_direction:ne,u_radius:n.al(he),u_opacity:de,u_temporal_offset:oe}))(j.skyboxMatrix,C.getCenter(M,!1),C.paint.get("sky-gradient-radius"),P,D);M.uploadCommonUniforms(N,U),U.draw(M,F.TRIANGLES,z,Gt.disabled,M.colorModeForRenderPass(),Nt.backCW,Y,"skyboxGradient",C.skyboxGeometry.vertexBuffer,C.skyboxGeometry.indexBuffer,C.skyboxGeometry.segment)}(l,o,x,d,b)},custom:function(l,t,o,c){let d=l.context,p=o.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||l.renderPass==="offscreen")&&o.isDraped(t)){if(l.renderPass==="offscreen"){let _=p.prerender;if(_){if(l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),l.transform.projection.name==="globe"){let x=l.transform.pointMerc;_.call(p,d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),n.ah(l.transform.zoom),[x.x,x.y],l.transform.pixelsPerMeterRatio)}else _.call(p,d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState()}}else if(l.renderPass==="translucent"){if(l.terrain&&l.terrain.renderingToTexture){let x=p.renderToTile;if(x){let b=c[0].canonical,M={x:b.x+c[0].wrap*(p.wrapTileId?0:1<<b.z),y:b.y,z:b.z};d.setDepthMode(bt.disabled),d.setStencilMode(Gt.disabled),d.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),x.call(p,d.gl,M),d.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),d.setColorMode(l.colorModeForRenderPass()),d.setStencilMode(Gt.disabled);let _=p.renderingMode==="3d"?new bt(l.context.gl.LEQUAL,bt.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,bt.ReadOnly);if(d.setDepthMode(_),l.transform.projection.name==="globe"){let x=l.transform.pointMerc;p.render(d.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),n.ah(l.transform.zoom),[x.x,x.y],l.transform.pixelsPerMeterRatio)}else p.render(d.gl,l.transform.customLayerMatrix());d.setDirty(),l.setBaseState(),d.bindFramebuffer.set(null)}}else n.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,o,c){if(l.renderPass==="opaque")return;let d=o.paint.get("model-opacity").constantOr(1);if(d===0)return;let p=o.paint.get("model-cast-shadows");if(l.renderPass==="shadow"&&(!p||l.terrain&&d<.65&&o._transitionablePaint._values["model-opacity"].value.expression instanceof n.ab))return;let _=l.shadowRenderer,x=o.paint.get("model-receive-shadows");_&&(_.useNormalOffset=!0,x||(_.enabled=!1));let b=()=>{_&&(_.useNormalOffset=!0,x||(_.enabled=!0))},M=t.getSource();if(l.renderPass==="light-beam"&&M.type!=="batched-model")return;if(M.type==="vector"||M.type==="geojson")return function(U,Z,Y,Q,ne){let he=U.transform;if(he.projection.name!=="mercator")return void n.w(`Drawing 3D models for ${he.projection.name} projection is not yet implemented`);let de=he.getFreeCameraOptions().position;if(!U.modelManager)return;let oe=U.modelManager;Y.modelManager=oe;let se=U.shadowRenderer;if(!Y._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let le=Y._unevaluatedLayout._values["model-id"],Me=Object.assign({},Y.layout.get("model-id").parameters),_e=U.style.order.indexOf(Y.fqid);for(let Ve of Q){let ze=Z.getTile(Ve).getBucket(Y);if(!ze||ze.projection.name!==he.projection.name)continue;let je=ze.getModelUris();je&&!ze.modelsRequested&&(oe.addModelsFromBucket(je,ne),ze.modelsRequested=!0);let rt=zg(Ve,he);Me.zoom=rt;let Ce=le.possiblyEvaluate(Me);if(Tl(U,ze,Ve),ls.shadowUniformsInitialized=!1,ls.useSingleShadowCascade=!!se&&se.getMaxCascadeForTile(Ve.toUnwrapped())===0,U.renderPass==="shadow"&&se){if(U.currentShadowCascade===1&&ze.isInsideFirstShadowMapFrustum)continue;let Pe=he.calculatePosMatrix(Ve.toUnwrapped(),he.worldSize);if(ls.tileMatrix.set(Pe),ls.shadowTileMatrix=Float32Array.from(se.calculateShadowPassMatrixFromMatrix(Pe)),ls.aabb.min.fill(0),ls.aabb.max[0]=ls.aabb.max[1]=n.aj,ls.aabb.max[2]=0,ip(ze,ls,U,Y.scope))continue}let me=1<<Ve.canonical.z,ke=[((de.x-Ve.wrap)*me-Ve.canonical.x)*n.aj,(de.y*me-Ve.canonical.y)*n.aj,de.z*me*n.aj];U.conflationActive&&Object.keys(ze.instancesPerModel).length>0&&U.style.isLayerClipped(Y,Z.getSource())&&ze.updateReplacement(Ve,U.replacementSource,_e,ne)&&(ze.uploaded=!1,ze.upload(U.context));for(let Pe in ze.instancesPerModel){let $e=ze.instancesPerModel[Pe];$e.features.length>0&&(Pe=Ce.evaluate($e.features[0].feature,{}));let Ze=oe.getModel(Pe,ne);if(Ze||oe.hasURLBeenRequested(Pe)||ze.modelUris.includes(Pe)||(ze.modelUris.push(Pe),ze.modelsRequested=!1),Ze&&Ze.uploaded)for(let Ye of Ze.nodes)tp(U,Y,Ye,$e,ke,Ve,ls)}}}(l,t,o,c,M.type==="vector"?o.scope:""),void b();if(!M.loaded())return;if(M.type==="batched-model")return function(U,Z,Y,Q){Y.resetLayerRenderingStats(U);let ne=U.context,he=U.transform,de=U.style.fog,oe=U.shadowRenderer;if(he.projection.name!=="mercator")return void n.w(`Drawing 3D landmark models for ${he.projection.name} projection is not yet implemented`);let se=U.transform.getFreeCameraOptions().position,le=n.c1([],[se.x,se.y,se.z],U.transform.worldSize),Me=n.eq([],le),_e=n.bx([]),Ve=n.e9(he.center.lat,he.zoom),ze=n.bn([],[1,1,1/Ve]);n.bo(_e,_e,Me);let je=Y.paint.get("model-opacity").constantOr(1),rt=new bt(ne.gl.LEQUAL,bt.ReadWrite,U.depthRangeFor3D),Ce=new bt(ne.gl.LEQUAL,bt.ReadOnly,U.depthRangeFor3D),me=new n.d6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),ke=U.renderPass==="shadow",Pe=ke&&oe?oe.getCurrentCascadeFrustum():he.getFrustum(he.scaleZoom(he.worldSize)),$e=Y.paint.get("model-front-cutoff"),Ze=$e[2]<1,Ye=ss(U,Y.paint.get("model-cutoff-fade-range")),ct=Y.getLayerRenderingStats();(function(Mt,Ot,yt,zt){let Rt=Mt.terrain?Mt.terrain.exaggeration():0,$t=Mt.transform.zoom;for(let Jt of zt){let ai=Ot.getTile(Jt).getBucket(yt);ai&&(ai.setFilter(yt.filter),Mt.conflationActive&&ai.updateReplacement(Jt,Mt.replacementSource),ai.evaluateTransform(Mt,yt),Mt.terrain&&Rt>0&&ai.elevationUpdate(Mt.terrain,Rt,Jt,yt.source),ai.needsReEvaluation(Mt,$t,yt)&&ai.evaluate(yt))}})(U,Z,Y,Q),function(){let Mt,Ot,yt;Ze?(Mt=Q.length-1,Ot=-1,yt=-1):(Mt=0,Ot=Q.length,yt=1);let zt=new Float64Array(16),Rt=n.cx(),$t=new n.P(0,0);for(let Jt=Mt;Jt!==Ot;Jt+=yt){let ai=Q[Jt],Ti=Z.getTile(ai).getBucket(Y);if(!Ti||!Ti.uploaded)continue;let Yt=!1;oe&&(Yt=oe.getMaxCascadeForTile(ai.toUnwrapped())===0);let Si=he.calculatePosMatrix(ai.toUnwrapped(),he.worldSize),Mi=Ti.modelTraits;!ke&&Ze&&(n.bi(zt,Si),n.ad(Rt,le,zt),$t.x=Rt[0],$t.y=Rt[1]);let Wi=[];Ti.setFilter(Y.filter);for(let ni of Ti.getNodesInfo()){if(ni.hiddenByReplacement||!ni.node.meshes)continue;let Ei=ni.node,Ii=0;U.terrain&&Ei.elevation&&(Ii=Ei.elevation*U.terrain.exaggeration());let Ri=(()=>{let hn=ni.aabb;return me.min=[...hn.min],me.max=[...hn.max],me.min[2]+=Ii,me.max[2]+=Ii,n.ad(me.min,me.min,Si),n.ad(me.max,me.max,Si),me})(),li=ni.evaluatedScale;if(li[0]<=1&&li[1]<=1&&li[2]<=1&&Ri.intersects(Pe)===0)continue;if(!ke&&Ze){let hn=.16666666666666666;ni.cameraCollisionOpacity=le[0]>Ri.min[0]&&le[0]<Ri.max[0]&&le[1]>Ri.min[1]&&le[1]<Ri.max[1]&&le[2]*Ve<Ri.max[2]&&Ei.footprint&&n.bY($t,Ei.footprint)?Math.max(ni.cameraCollisionOpacity-hn,0):Math.min(1,ni.cameraCollisionOpacity+hn)}let Vi=[...Si],Ci=1/n.d4(ai.canonical),yr=Ei.anchor?Ei.anchor[0]:0,bi=Ei.anchor?Ei.anchor[1]:0;n.bo(Vi,Vi,[yr*(li[0]-1)+ni.evaluatedTranslation[0]*Ci,bi*(li[1]-1)+ni.evaluatedTranslation[1]*Ci,Ii+ni.evaluatedTranslation[2]]),n.cn(li,n.es)||n.cP(Vi,Vi,li);let Li=n.az([],Vi,Ei.matrix),$i=n.az([],he.expandedFarZProjMatrix,Li),kr=n.az([],he.expandedFarZProjMatrix,Vi),Dr=n.aA([],[yr,bi,Ii,1],$i)[2];Ei.hidden=!1;let Br=je;ke||(Ze&&(Br*=ni.cameraCollisionOpacity,Br*=vm(Vi,he,ni.aabb,$e)),Br*=xm(Ye,Dr)),Br!==0?Wi.push({nodeInfo:ni,depth:Dr,opacity:Br,wvpForNode:$i,wvpForTile:kr,nodeModelMatrix:Li,tileModelMatrix:Vi}):Ei.hidden=!0}ke||Wi.sort((ni,Ei)=>!Ze||ni.opacity===1&&Ei.opacity===1?ni.depth<Ei.depth?-1:1:ni.opacity===1?-1:Ei.opacity===1?1:ni.depth>Ei.depth?-1:1);for(let ni of Wi){let Ei=ni.nodeInfo,Ii=Ei.node,Ri=n.az([],ze,ni.tileModelMatrix);n.az(Ri,_e,Ri);let li=n.bi([],Ri);n.ea(li,li),n.cP(li,li,pu),Ri=n.az(Ri,Ri,Ii.matrix);let Vi=U.renderPass==="light-beam",Ci=Y.paint.get("model-color-use-theme").constantOr("default")==="none",yr=Mi&n.ex.HasMapboxMeshFeatures,bi=yr?0:Ei.evaluatedRMEA[0][2];for(let Li=0;Li<Ii.meshes.length;++Li){let $i=Ii.meshes[Li],kr=Li===Ii.lightMeshIndex,Dr=ni.wvpForNode;if(kr){if(!Vi&&!U.terrain&&U.shadowRenderer){U.currentLayer<U.firstLightBeamLayer&&(U.firstLightBeamLayer=U.currentLayer);continue}Dr=ni.wvpForTile}else if(Vi)continue;let Br={defines:[]},hn=[];if(!ke&&oe&&(oe.useNormalOffset=!!$i.normalBuffer),qc(Br.defines,hn,$i,U,Ci?null:Y.lut),yr||Br.defines.push("DIFFUSE_SHADED"),Yt&&Br.defines.push("SHADOWS_SINGLE_CASCADE"),ct&&(ke?ct.numRenderedVerticesInShadowPass+=$i.vertexArray.length:ct.numRenderedVerticesInTransparentPass+=$i.vertexArray.length),ke){du($i,ni.nodeModelMatrix,U,Y);continue}let Jo=null;if(de){let xn=Gc(ni.nodeModelMatrix,U.transform);if(Jo=new Float32Array(xn),he.projection.name!=="globe"){let Cr=$i.aabb.min,Sr=$i.aabb.max,[Ki,Wr]=de.getOpacityForBounds(xn,Cr[0],Cr[1],Sr[0],Sr[1]);Br.overrideFog=Ki>=He||Wr>=He}}let kn=$i.material,eo;kn.occlusionTexture&&kn.occlusionTexture.offsetScale&&(eo=kn.occlusionTexture.offsetScale,Br.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));let yn=U.getOrCreateProgram("model",Br);!ke&&oe&&oe.setupShadowsFromMatrix(ni.tileModelMatrix,yn,oe.useNormalOffset),U.uploadCommonUniforms(ne,yn,null,Jo);let bo=kn.pbrMetallicRoughness;bo.metallicFactor=.9,bo.roughnessFactor=.5;let Vo=Gd(new Float32Array(Dr),new Float32Array(Ri),new Float32Array(li),new Float32Array(Ii.matrix),U,ni.opacity,bo.baseColorFactor,kn.emissiveFactor,bo.metallicFactor,bo.roughnessFactor,kn,bi,Y,[0,0,0],eo);!kr&&(Ei.hasTranslucentParts||ni.opacity<1)&&yn.draw(U,ne.gl.TRIANGLES,rt,Gt.disabled,ti.disabled,Nt.backCCW,Vo,Y.id,$i.vertexBuffer,$i.indexBuffer,$i.segments,Y.paint,U.transform.zoom,void 0,hn),yn.draw(U,ne.gl.TRIANGLES,kr?Ce:rt,Gt.disabled,kr||ni.opacity<1||Ei.hasTranslucentParts?ti.alphaBlended:ti.unblended,Nt.backCCW,Vo,Y.id,$i.vertexBuffer,$i.indexBuffer,$i.segments,Y.paint,U.transform.zoom,void 0,hn)}}}}()}(l,t,o,c),void b();if(M.type!=="model")return;let C=M.getModels(),z=[],P=l.transform.getFreeCameraOptions().position,D=n.c1([],[P.x,P.y,P.z],l.transform.worldSize);n.eq(D,D);let N=[],F=[],j=0;for(let U of C){let Z=o.paint.get("model-rotation").constantOr(null),Y=o.paint.get("model-scale").constantOr(null),Q=o.paint.get("model-translation").constantOr(null);U.computeModelMatrix(l,Z,Y,Q,!0,!0,!1);let ne=n.bx([]),he=n.e9(U.position.lat,l.transform.zoom),de=n.bn([],[1,1,1/he]);n.bo(ne,ne,D),z.push({zScaleMatrix:de,negCameraPosMatrix:ne});for(let oe of U.nodes)ep(l.transform,oe,U.matrix,l.transform.expandedFarZProjMatrix,j,N,F);j++}if(N.sort((U,Z)=>Z.depth-U.depth),l.renderPass!=="shadow"){if(d===1)for(let U of F)wl(U,l,o,z[U.modelIndex],Gt.disabled,l.colorModeForRenderPass());else{for(let U of F)wl(U,l,o,z[U.modelIndex],Gt.disabled,ti.disabled);for(let U of F)wl(U,l,o,z[U.modelIndex],l.stencilModeFor3D(),l.colorModeForRenderPass());l.resetStencilClippingMasks()}for(let U of N)wl(U,l,o,z[U.modelIndex],Gt.disabled,l.colorModeForRenderPass());b()}else{for(let U of F)du(U.mesh,U.nodeModelMatrix,l,o);for(let U of N)du(U.mesh,U.nodeModelMatrix,l,o);b()}}},mu={line:function(l,t,o){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,l._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||l._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){let c=t.getVisibleCoordinates();for(let d of c){let p=t.getTile(d).getBucket(l);if(p&&(p.elevationType!=="none"?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,o){let c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson")return void(o.modelManager&&o.modelManager.upload(o,c.type==="vector"?l.scope:""));if(c.type==="batched-model"||c.type!=="model")return;let d=c.getModels();for(let p of d)p.upload(o.context)},raster:function(l,t,o){let c=t.getSource();if(!(c instanceof js&&c.loaded()))return;let d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;let p=l.paint.get("raster-array-band")||c.getInitialBand(d);if(p==null)return;let _=t.getIds().map(x=>t.getTileByID(x));for(let x of _)x.updateNeeded(l.id,p)&&c.prepareTile(x,d,l.id,p)},"raster-particle":function(l,t,o){let c=t.getSource();if(!(c instanceof js&&c.loaded()))return;let d=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!d)return;let p=l.paint.get("raster-particle-array-band")||c.getInitialBand(d);if(p==null)return;let _=t.getIds().map(x=>t.getTileByID(x));for(let x of _)x.updateNeeded(l.id,p)&&c.prepareTile(x,d,l.id,p)}},_u={fill:Tt},yo={fill:function(l,t,o,c){if(!o.layout||o.layout.get("fill-elevation-reference")==="none")return;let d=l.context.gl,p=new bt(d.LEQUAL,bt.ReadOnly,l.depthRangeFor3D),_=new Gt({func:d.ALWAYS,mask:255},255,255,d.KEEP,d.KEEP,d.REPLACE),x=l.transform.getFreeCameraOptions().position,b=l.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(let M of c){let C=t.getTile(M),z=C.getBucket(o);if(!z)continue;let P=z.elevatedStructures;if(!P||P.depthSegments.segments[0].primitiveLength===0)continue;let D=Nc(M.toUnwrapped(),x),N=l.translatePosMatrix(M.projMatrix,C,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),F=tu(N,D,0,1,0);b.draw(l,d.TRIANGLES,p,_,ti.disabled,Nt.disabled,F,o.id,P.vertexBuffer,P.indexBuffer,P.depthSegments,o.paint,l.transform.zoom)}}};class oa{constructor(t,o,c,d,p,_){this.context=new su(t,o),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=p,this._timeStamp=n.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let x=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(let M of x)this._debugParams.enabledLayers[M]=!0;p.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),p.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),p.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),p.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),p.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(let M of x)p.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],M);this.occlusionParams=new Sl(p),this.setup(),this.numSublayers=jn.maxUnderzooming+jn.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new n.eE,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new fg(this),this._wireframeDebugCache=new Hc,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let b=new n.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new n.T(this.context,b,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=d,this.worldview=_}updateTerrain(t,o){let c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Kh(this,t));let d=this._terrain;this.transform.elevation=c?d:null,d.update(t,this.transform,o),this.transform.elevation&&!d.enabled&&(this.transform.elevation=null)}_updateFog(t){let o=t.fog;if(!o||this.transform.projection.name==="globe"||o.getOpacity(this.transform.pitch)<1||o.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);let[c,d]=o.getFovAdjustedRange(this.transform._fov);if(c>d)return void(this.transform.fogCullDistSq=null);let p=c+.78*(d-c);this.transform.fogCullDistSq=p*p}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Kh(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,o){if(this.width=t*n.q.devicePixelRatio,this.height=o*n.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let c of this.style.order)this.style._mergedLayers[c].resize()}setup(){let t=this.context,o=new n.ba;o.emplaceBack(0,0),o.emplaceBack(n.aj,0),o.emplaceBack(0,n.aj),o.emplaceBack(n.aj,n.aj),this.tileExtentBuffer=t.createVertexBuffer(o,n.bc.members),this.tileExtentSegments=n.bd.simpleSegment(0,0,4,2);let c=new n.ba;c.emplaceBack(0,0),c.emplaceBack(n.aj,0),c.emplaceBack(0,n.aj),c.emplaceBack(n.aj,n.aj),this.debugBuffer=t.createVertexBuffer(c,n.bc.members),this.debugSegments=n.bd.simpleSegment(0,0,4,5);let d=new n.ba;d.emplaceBack(-1,-1),d.emplaceBack(1,-1),d.emplaceBack(-1,1),d.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(d,n.bc.members),this.viewportSegments=n.bd.simpleSegment(0,0,4,2);let p=new n.aZ;p.emplaceBack(0,0,0,0),p.emplaceBack(n.aj,0,n.aj,0),p.emplaceBack(0,n.aj,0,n.aj),p.emplaceBack(n.aj,n.aj,n.aj,n.aj),this.mercatorBoundsBuffer=t.createVertexBuffer(p,n.bf.members),this.mercatorBoundsSegments=n.bd.simpleSegment(0,0,4,2);let _=new n.a_;_.emplaceBack(0,1,2),_.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(_);let x=new n.bb;for(let M of[0,1,3,2,0])x.emplaceBack(M);this.debugIndexBuffer=t.createIndexBuffer(x),this.emptyTexture=new n.T(t,new n.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=n.bz();let b=this.context.gl;this.stencilClearMode=new Gt({func:b.ALWAYS,mask:0},0,255,b.ZERO,b.ZERO,b.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,bt.disabled,this.stencilClearMode,ti.disabled,Nt.disabled,Xh(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,o,c){if(!o||this.currentStencilSource===o.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let x=!1;for(let b of c)if(this._tileClippingMaskIDs[b.key]===void 0){x=!0;break}if(!x)return}this.currentStencilSource=o.id;let d=this.context,p=d.gl;this.nextStencilID+c.length>256&&this.clearStencil(),d.setColorMode(ti.disabled),d.setDepthMode(bt.disabled);let _=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(let x of c){let b=o.getTile(x),M=this._tileClippingMaskIDs[x.key]=this.nextStencilID++,{tileBoundsBuffer:C,tileBoundsIndexBuffer:z,tileBoundsSegments:P}=this.getTileBoundsBuffers(b);_.draw(this,p.TRIANGLES,bt.disabled,new Gt({func:p.ALWAYS,mask:0},M,255,p.KEEP,p.KEEP,p.REPLACE),ti.disabled,Nt.disabled,Xh(x.projMatrix),"$clipping",C,z,P)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let t=this.nextStencilID++,o=this.context.gl;return new Gt({func:o.NOTEQUAL,mask:255},t,255,o.KEEP,o.KEEP,o.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);let o=this.context.gl;return new Gt({func:o.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,o.KEEP,o.KEEP,o.REPLACE)}stencilConfigForOverlap(t){let o=this.context.gl,c=t.sort((_,x)=>x.overscaledZ-_.overscaledZ),d=c[c.length-1].overscaledZ,p=c[0].overscaledZ-d+1;if(p>1){this.currentStencilSource=void 0,this.nextStencilID+p>256&&this.clearStencil();let _={};for(let x=0;x<p;x++)_[x+d]=new Gt({func:o.GEQUAL,mask:255},x+this.nextStencilID,255,o.KEEP,o.KEEP,o.REPLACE);return this.nextStencilID+=p,[_,c]}return[{[d]:Gt.disabled},c]}colorModeForRenderPass(){let t=this.context.gl;return this._showOverdrawInspector?new ti([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new n.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ti.unblended:ti.alphaBlended}colorModeForDrapableLayerRenderPass(t){let o=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new ti([o.ONE,o.ONE_MINUS_SRC_ALPHA,o.CONSTANT_ALPHA,o.ONE_MINUS_SRC_ALPHA],new n.am(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,o,c,d=!1){if(this.depthOcclusion)return new bt(this.context.gl.GREATER,bt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!d)return bt.disabled;let p=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new bt(c||this.context.gl.LEQUAL,o,[p,p])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let t=this.context.gl,o=Math.ceil(this.width),c=Math.ceil(this.height),d=this.context.bindFramebuffer.get(),p=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===o&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),o!==0&&c!==0&&(this.depthFBO=new Da(this.context,o,c,!1,"texture"),this.depthTexture=new n.T(this.context,{width:o,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(d),t.bindTexture(t.TEXTURE_2D,p),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,o,c,0,0,o,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,o)=>t+o/this._fpsHistory.length,0))}render(t,o){let c=n.q.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=o;let d=this.style._mergedLayers,p=!(!this.terrain||!this.terrain.enabled),_=()=>this.style._getOrder(p).filter(Ce=>{let me=d[Ce];return!(me.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[me.type]}),x=_(),b=!1,M=!1,C=null;for(let Ce of x){let me=d[Ce];me.type==="circle"?b=!0:me.type==="building"?C=me:me.type==="symbol"&&(me.hasInitialOcclusionOpacityProperties?M=!0:b=!0)}let z=x.map(Ce=>d[Ce]),P=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(n.q.now()),this.imageManager.beginFrame();let D=0,N=!1;for(let Ce in P){let me=P[Ce];me.used&&(me.prepare(this.context),me.getSource().usedInConflation&&++D)}let F=!1;for(let Ce of z)Ce.isHidden(this.transform.zoom)||(Ce.type==="clip"&&(F=!0),this.prepareLayer(Ce));let j={},U={},Z={},Y={},Q={};for(let Ce in P){let me=P[Ce];j[Ce]=me.getVisibleCoordinates(),U[Ce]=j[Ce].slice().reverse(),Z[Ce]=me.getVisibleCoordinates(!0).reverse(),Y[Ce]=me.getShadowCasterCoordinates(),Q[Ce]=me.sortCoordinatesByDistance(j[Ce])}let ne=Ce=>{let me=this.style.getLayerSourceCache(Ce);return me&&me.used?me.getSource():null};if(D||F||this._clippingActiveLastFrame){let Ce=[],me=[],ke=0;for(let Pe of z)this.isSourceForClippingOrConflation(Pe,ne(Pe))&&(Ce.push(Pe),me.push(ke)),ke++;if(Ce&&(F||Ce.length>1)||this._clippingActiveLastFrame){F=!1;let Pe=[];for(let $e=0;$e<Ce.length;$e++){let Ze=Ce[$e],Ye=me[$e],ct=this.style.getLayerSourceCache(Ze);if(!ct||!ct.used||!ct.getSource().usedInConflation&&Ze.type!=="clip"&&Ze.type!=="building")continue;let Mt=n.eF,Ot=n.bW.None,yt=[],zt=!0;if(Ze.type==="building")Mt=n.eH;else if(Ze.type==="clip"){Mt=Ye;for(let Rt of Ze.layout.get("clip-layer-types"))Ot|=Rt==="model"?n.bW.Model:Rt==="symbol"?n.bW.Symbol:n.bW.FillExtrusion;for(let Rt of Ze.layout.get("clip-layer-scope"))yt.push(Rt);Ze.isHidden(this.transform.zoom)?zt=!1:F=!0}zt&&Pe.push({layer:Ze.fqid,cache:ct,order:Mt,clipMask:Ot,clipScope:yt})}this.replacementSource.setSources(Pe),N=!0}}this._clippingActiveLastFrame=F,N||this.replacementSource.clear(),this.conflationActive=N,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Ce=0;Ce<z.length;Ce++){let me=z[Ce],ke=me.cutoffRange();if(this.longestCutoffRange=Math.max(ke,this.longestCutoffRange),ke>0){let Pe=ne(me);Pe&&(this.minCutoffZoom=Math.max(Pe.minzoom,this.minCutoffZoom)),me.minzoom&&(this.minCutoffZoom=Math.max(me.minzoom,this.minCutoffZoom))}me.is3D(p)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Ce),this._lastOcclusionLayer=Ce)}let he=this.style&&this.style.fog;he?(this._fogVisible=he.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=he.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Z),this.opaquePassCutoff=0,x=_(),z=x.map(Ce=>d[Ce]));let de=this._shadowRenderer;if(de){de.updateShadowParameters(this.transform,this.style.directionalLight);for(let Ce in P)for(let me of j[Ce]){let ke={min:0,max:0};this.terrain&&(ke=this.terrain.getMinMaxForTile(me)||ke),de.addShadowReceiver(me.toUnwrapped(),ke.min,ke.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new n.eG(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Se(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);let oe=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),se=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(oe&&!this._snow&&(this._snow=new np(this)),!oe&&this._snow&&(this._snow.destroy(),delete this._snow),se&&!this._rain&&(this._rain=new Il(this)),!se&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),C){this.buildingTileBorderManager||(this.buildingTileBorderManager=new ym);let Ce=this.style.getLayerSourceCache(C);this.buildingTileBorderManager.updateBorders(Ce,C)}if(!ks.has(this.context.gl))return;this.renderPass="offscreen";for(let Ce of z){let me=t.getLayerSourceCache(Ce);if(!Ce.hasOffscreenPass()||Ce.isHidden(this.transform.zoom))continue;let ke=me?U[me.id]:void 0;(Ce.type==="custom"||Ce.type==="raster"||Ce.type==="raster-particle"||Ce.isSky()||ke&&ke.length)&&this.renderLayer(this,me,Ce,ke)}this.depthRangeFor3D=[0,1-(z.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Y)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let le=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Me=(()=>{if(o.showOverdrawInspector)return n.am.black;let Ce=this.style.fog;if(Ce&&this.transform.projection.supportsFog){let me=this.style.getLut(Ce.scope);if(!le){let ke=Ce.properties.get("color-use-theme")==="none",Pe=Ce.properties.get("color").toNonPremultipliedRenderColor(ke?null:me).toArray01();return new n.am(...Pe)}if(le){let ke=Ce.properties.get("space-color-use-theme")==="none",Pe=Ce.properties.get("space-color").toNonPremultipliedRenderColor(ke?null:me).toArray01();return new n.am(...Pe)}}return n.am.transparent})();if(this.context.clear({color:Me,depth:1}),this.clearStencil(),this._showOverdrawInspector=o.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&le&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=x.length-1;this.currentLayer>=0;this.currentLayer--){let Ce=z[this.currentLayer],me=t.getLayerSourceCache(Ce);if(Ce.isSky())continue;let ke=me?(Ce.is3D(p)?Q:U)[me.id]:void 0;this._renderTileClippingMasks(Ce,me,ke),this.renderLayer(this,me,Ce,ke)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&le&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||n.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<x.length;this.currentLayer++){let Ce=z[this.currentLayer],me=t.getLayerSourceCache(Ce);Ce.isSky()&&this.renderLayer(this,me,Ce,me?U[me.id]:void 0)}function _e(Ce,me){let ke;return me&&(ke=(Ce.type==="symbol"?Z:Ce.is3D(p)?Q:U)[me.id]),ke}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<x.length;){let Ce=z[this.currentLayer];if(Ce.type==="raster"||Ce.type==="raster-particle"){let me=t.getLayerSourceCache(Ce);this.renderLayer(this,me,Ce,_e(Ce,me))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ve=0;de&&(Ve=de.getShadowCastingLayerCount());let ze=!1,je=-1;for(let Ce=0;Ce<x.length;++Ce){let me=z[Ce];me.isHidden(this.transform.zoom)||me.is3D(p)&&(je=Ce)}M&&je===-1&&(b=!0);let rt=!1;for(;this.currentLayer<x.length;){let Ce=z[this.currentLayer],me=t.getLayerSourceCache(Ce);if(Ce.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Ce)){if(Ce.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!rt&&Ce.is3D(p)&&!p){let ke=this.currentLayer,Pe=$e=>{for(this.currentLayer=0;this.currentLayer<z.length;this.currentLayer++){let Ze=z[this.currentLayer];if(_u[Ze.type]){let Ye=this.style.getLayerSourceCache(Ze);_u[Ze.type](this,Ye,Ze,_e(Ze,Ye),$e)}}};Pe("initialize"),Pe("reset"),this.currentLayer=ke,rt=!0}if(b&&!ze&&this.terrain&&!this.transform.isOrthographic&&(ze=!0,this.blitDepth()),M&&je!==-1&&this.currentLayer===je+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(Ce,me,me?j[me.id]:void 0),this.renderLayer(this,me,Ce,_e(Ce,me)),!this.terrain&&de&&Ve>0&&Ce.hasShadowPass()&&--Ve==0){{this.clearStencil(),this.resetStencilClippingMasks();let ke=this.currentLayer;for(this.currentLayer=0;this.currentLayer<z.length;this.currentLayer++){let Pe=z[this.currentLayer];if(yo[Pe.type]){let $e=this.style.getLayerSourceCache(Pe);yo[Pe.type](this,$e,Pe,_e(Pe,$e))}}this.currentLayer=ke}if(de.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){let ke=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=ke;this.currentLayer++){let Pe=z[this.currentLayer];if(!Pe.hasLightBeamPass())continue;let $e=t.getLayerSourceCache(Pe);this.renderLayer(this,$e,Pe,$e?U[$e.id]:void 0)}this.currentLayer=ke,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let ke=this.currentLayer;this.depthOcclusion=!0;for(let Pe of this.layersWithOcclusionOpacity){this.currentLayer=Pe;let $e=z[this.currentLayer],Ze=t.getLayerSourceCache($e),Ye=Ze?U[Ze.id]:void 0;this.terrain||this._renderTileClippingMasks($e,Ze,Ze?j[Ze.id]:void 0),this.renderLayer(this,Ze,$e,Ye)}this.depthOcclusion=!1,this.currentLayer=ke,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Ce=null;z.forEach(me=>{let ke=t.getLayerSourceCache(me);ke&&!me.isHidden(this.transform.zoom)&&ke.getVisibleCoordinates().length&&(!Ce||Ce.getSource().maxzoom<ke.getSource().maxzoom)&&(Ce=ke)}),Ce&&this.options.showTileBoundaries&&as(this,Ce,Ce.getVisibleCoordinates(),n.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&as(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new n.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Ce){let me=Ce.transform.padding;Uc(Ce,Ce.transform.height-(me.top||0),3,fm),Uc(Ce,me.bottom||0,3,Kd),uu(Ce,me.left||0,3,Jd),uu(Ce,Ce.transform.width-(me.right||0),3,Qd);let ke=Ce.transform.centerPoint;(function(Pe,$e,Ze,Ye){jc(Pe,$e-1,Ze-10,2,20,Ye),jc(Pe,$e-10,Ze-1,20,2,Ye)})(Ce,ke.x,Ce.transform.height-ke.y,mm)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),N||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);let{unsupportedLayers:o}=this.transform.projection,c=!o||!o.includes(t.type);if(mu[t.type]&&(c||this.terrain&&t.type==="custom")){let d=this.style.getLayerSourceCache(t);mu[t.type](t,d,this)}this.gpuTimingEnd()}renderLayer(t,o,c,d){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||d&&d.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||op[c.type](t,o,c,d,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;let o=this.context.extTimerQuery,c=this.context.gl,d=this.gpuTimers[t.id];d||(d=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),d.calls++,c.beginQuery(o.TIME_ELAPSED_EXT,d.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let t=this.context.extTimerQuery,o=this.context.gl,c=o.createQuery();this.deferredRenderGpuTimeQueries.push(c),o.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){let t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){let o={};for(let c in t){let d=t[c],p=this.context.extTimerQuery,_=p.getQueryParameter(d.query,this.context.gl.QUERY_RESULT)/1e6;p.deleteQueryEXT(d.query),o[c]=_}return o}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;let o=this.context.gl,c=0;for(let d of t)c+=o.getQueryParameter(d,o.QUERY_RESULT)/1e6,o.deleteQuery(d);return c}translatePosMatrix(t,o,c,d,p){if(!c[0]&&!c[1])return t;let _=p?d==="map"?this.transform.angle:0:d==="viewport"?-this.transform.angle:0;if(_){let M=Math.sin(_),C=Math.cos(_);c=[c[0]*C-c[1]*M,c[0]*M+c[1]*C]}let x=[p?c[0]:n.aw(o,c[0],this.transform.zoom),p?c[1]:n.aw(o,c[1],this.transform.zoom),0],b=new Float32Array(16);return n.bo(b,t,x),b}saveTileTexture(t){if(t.context!==this.context)return;let o=t.size[0],c=this._tileTextures[o];c?c.push(t):this._tileTextures[o]=[t]}getTileTexture(t){let o=this._tileTextures[t];return o&&o.length>0?o.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,o,c){let d=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,p=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(p.push("LIGHTING_3D_MODE"),p.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):d||p.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||p.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(p.push("TERRAIN"),this.linearFloatFilteringSupported()&&p.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&p.push("GLOBE"),!this._fogVisible||d||o!==void 0&&!o||p.push("FOG","FOG_DITHERING"),d&&p.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&p.push("OVERDRAW_INSPECTOR"),p}getOrCreateProgram(t,o){this.cache=this.cache||{};let c=o&&o.defines||[],d=o&&o.config,p=this.currentGlobalDefines(t,o&&o.overrideFog,o&&o.overrideRtt).concat(c),_=Qh.cacheKey(Dc[t],t,p,d);return this.cache[_]||(this.cache[_]=new Qh(this.context,t,Dc[t],d,um[t],p)),this.cache[_]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new n.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,o){if(this.style.enable3dLights()){let c=this.style.directionalLight,d=this.style.ambientLight;if(c&&d){let p=((_,x,b)=>{let M=_.properties.get("direction"),C=_.properties.get("color-use-theme")==="none",z=_.properties.get("color").toNonPremultipliedRenderColor(C?null:b.getLut(_.scope)).toArray01(),P=_.properties.get("intensity"),D=x.properties.get("color-use-theme")==="none",N=x.properties.get("color").toNonPremultipliedRenderColor(D?null:b.getLut(x.scope)).toArray01(),F=x.properties.get("intensity"),j=[M.x,M.y,M.z],U=n.dI(N,F),Z=n.dI(z,P);return{u_lighting_ambient_color:U,u_lighting_directional_dir:j,u_lighting_directional_color:Z,u_ground_radiance:Dd(j,Z,U)}})(c,d,this.style);o.setLightsUniformValues(t,p)}}}uploadCommonUniforms(t,o,c,d,p){if(this.uploadCommonLightUniforms(t,o),this.terrain&&this.terrain.renderingToTexture)return;let _=this.style.fog;if(_){let x=_.getOpacity(this.transform.pitch),b=((M,C,z,P,D,N,F,j,U,Z,Y,Q)=>{let ne=M.transform,he=C.properties.get("color-use-theme")==="none",de=C.properties.get("color").toNonPremultipliedRenderColor(he?null:M.style.getLut(C.scope)).toArray01();de[3]=P;let oe=M.frameCounter/1e3%1,[se,le]=C.properties.get("vertical-range");return{u_fog_matrix:z?ne.calculateFogTileMatrix(z):Q||M.identityMat,u_fog_range:C.getFovAdjustedRange(ne._fov),u_fog_color:de,u_fog_horizon_blend:C.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(se,le),le],u_fog_temporal_offset:oe,u_frustum_tl:D,u_frustum_tr:N,u_frustum_br:F,u_frustum_bl:j,u_globe_pos:U,u_globe_radius:Z,u_viewport:Y,u_globe_transition:n.ah(ne.zoom),u_is_globe:+(ne.projection.name==="globe")}})(this,_,c,x,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*n.q.devicePixelRatio,this.transform.height*n.q.devicePixelRatio],d);o.setFogUniformValues(t,b)}p&&o.setCutoffUniformValues(t,p.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){let t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){let t=this.context.gl,o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),o}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){let t=this._backgroundTiles,o=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(let d of c)o[d.key]=t[d.key]||new ba(d,512,this.transform.tileZoom,this,void 0,this.worldview);return o}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,o){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!o||o.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let o=this._cachedTileFogOpacities[t.key];return o||(this._cachedTileFogOpacities[t.key]=o=this.style.fog.getOpacityForTile(t)),o[0]>=He||o[1]>=He}setupDepthForOcclusion(t,o,c){let d=this.context,p=d.gl,_=!!c;var x;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),d.activeTexture.set(p.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((x=this.depthRangeFor3D)[1]-x[0]),-1-2*x[0]/(x[1]-x[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE),d.activeTexture.set(p.TEXTURE0),_||o.setTerrainUniformValues(d,c)}}function Al(l,t){let o=!1,c=null,d=()=>{c=null,o&&(l(),c=setTimeout(d,t),o=!1)};return()=>(o=!0,c||d(),c)}class gu{constructor(t){this._hashName=t&&encodeURIComponent(t),n.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Al(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){let t=this._map;if(!t)return"";let o=yu(t);if(this._hashName){let c=this._hashName,d=!1,p=location.hash.slice(1).split("&").map(_=>{let x=_.split("=")[0];return x===c?(d=!0,`${x}=${o}`):_}).filter(_=>_);return d||p.push(`${c}=${o}`),`#${p.join("&")}`}return`#${o}`}_getCurrentHash(){let t=location.hash.replace("#","");if(this._hashName){let o;return t.split("&").map(c=>c.split("=")).forEach(c=>{c[0]===this._hashName&&(o=c)}),(o&&o[1]||"").split("/")}return t.split("/")}_onHashChange(){let t=this._map;if(!t)return!1;let o=this._getCurrentHash();if(o.length>=3&&!o.some(c=>isNaN(Number(c)))){let c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(o[3]||0):t.getBearing();return t.jumpTo({center:[+o[2],+o[1]],zoom:+o[0],bearing:c,pitch:+(o[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function yu(l,t){let o=l.getCenter(),c=Math.round(100*l.getZoom())/100,d=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),p=Math.pow(10,d),_=Math.round(o.lng*p)/p,x=Math.round(o.lat*p)/p,b=l.getBearing(),M=l.getPitch(),C=t?`/${_}/${x}/${c}`:`${c}/${x}/${_}`;return(b||M)&&(C+="/"+Math.round(10*b)/10),M&&(C+=`/${Math.round(M)}`),C}let Ml={linearity:.3,easing:n.eI(0,0,.3,1)},sa=n.h({deceleration:2500,maxSpeed:1400},Ml),sp=n.h({deceleration:20,maxSpeed:1400},Ml),cs=n.h({deceleration:1e3,maxSpeed:360},Ml),ap=n.h({deceleration:1e3,maxSpeed:90},Ml);class xu{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:n.q.now(),settings:t})}_drainInertiaBuffer(){let t=this._inertiaBuffer,o=n.q.now();for(;t.length>0&&o-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let o={zoom:0,bearing:0,pitch:0,pan:new n.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:p}of this._inertiaBuffer)o.zoom+=p.zoomDelta||0,o.bearing+=p.bearingDelta||0,o.pitch+=p.pitchDelta||0,p.panDelta&&o.pan._add(p.panDelta),p.around&&(o.around=p.around),p.pinchAround&&(o.pinchAround=p.pinchAround);let c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,d={};if(o.pan.mag()){let p=Pl(o.pan.mag(),c,n.h({},sa,t||{}));d.offset=o.pan.mult(p.amount/o.pan.mag()),d.center=this._map.transform.center,Cl(d,p)}if(o.zoom){let p=Pl(o.zoom,c,sp);d.zoom=this._map.transform.zoom+p.amount,Cl(d,p)}if(o.bearing){let p=Pl(o.bearing,c,cs);d.bearing=this._map.transform.bearing+n.ay(p.amount,-179,179),Cl(d,p)}if(o.pitch){let p=Pl(o.pitch,c,ap);d.pitch=this._map.transform.pitch+p.amount,Cl(d,p)}if(d.zoom||d.bearing){let p=o.pinchAround===void 0?o.around:o.pinchAround;d.around=p?this._map.unproject(p):this._map.getCenter()}return this.clear(),d.noMoveStart=!0,d}}function Cl(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function Pl(l,t,o){let{maxSpeed:c,linearity:d,deceleration:p}=o,_=n.ay(l*d/(t/1e3),-c,c),x=Math.abs(_)/(p*d);return{easing:o.easing,duration:1e3*x,amount:_*(x/2)}}class ur extends n.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,c,d={}){let p=Ct(o.getCanvasContainer(),c),_=o.unproject(p);super(t,n.h({point:p,lngLat:_,originalEvent:c},d)),this._defaultPrevented=!1,this.target=o}}class Rl extends n.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,c){let d=t==="touchend"?c.changedTouches:c.touches,p=Ft(o.getCanvasContainer(),d),_=p.map(b=>o.unproject(b)),x=p.reduce((b,M,C,z)=>b.add(M.div(z.length)),new n.P(0,0));super(t,{points:p,point:x,lngLats:_,lngLat:o.unproject(x),originalEvent:c}),this._defaultPrevented=!1}}class lp extends n.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o){super("wheel",{originalEvent:o}),this._defaultPrevented=!1}}class cp{constructor(t,o){this._map=t,this._clickTolerance=o.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new lp(this._map,t))}mousedown(t,o){return this._mousedownPos=o,this._firePreventable(new ur(t.type,this._map,t))}mouseup(t){this._map.fire(new ur(t.type,this._map,t))}preclick(t){let o=n.h({},t);o.type="preclick",this._map.fire(new ur(o.type,this._map,o))}click(t,o){this._mousedownPos&&this._mousedownPos.dist(o)>=this._clickTolerance||(this.preclick(t),this._map.fire(new ur(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new ur(t.type,this._map,t))}mouseover(t){this._map.fire(new ur(t.type,this._map,t))}mouseout(t){this._map.fire(new ur(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Rl(t.type,this._map,t))}touchmove(t){this._map.fire(new Rl(t.type,this._map,t))}touchend(t){this._map.fire(new Rl(t.type,this._map,t))}touchcancel(t){this._map.fire(new Rl(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ba{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new ur(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ur("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new ur(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class hp{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=o.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,o){this.isEnabled()&&t.shiftKey&&t.button===0&&(_t(),this._startPos=this._lastPos=o,this._active=!0)}mousemoveWindow(t,o){if(!this._active)return;let c=o,d=this._startPos,p=this._lastPos;if(!d||!p||p.equals(c)||!this._box&&c.dist(d)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=xe("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));let _=Math.min(d.x,c.x),x=Math.max(d.x,c.x),b=Math.min(d.y,c.y),M=Math.max(d.y,c.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${_}px,${b}px)`,this._box.style.width=x-_+"px",this._box.style.height=M-b+"px")})}mouseupWindow(t,o){if(!this._active)return;let c=this._startPos,d=o;if(c&&t.button===0){if(this.reset(),wt(),c.x!==d.x||c.y!==d.y)return this._map.fire(new n.A("boxzoomend",{originalEvent:t})),{cameraAnimation:p=>p.fitScreenCoordinates(c,d,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Pt(),delete this._startPos,delete this._lastPos}_fireEvent(t,o){return this._map.fire(new n.A(t,{originalEvent:o}))}}function Zc(l,t){let o={};for(let c=0;c<l.length;c++)o[l[c].identifier]=t[c];return o}class up{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,o,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=function(d){let p=new n.P(0,0);for(let _ of d)p._add(_);return p.div(d.length)}(o),this.touches=Zc(c,o)))}touchmove(t,o,c){if(this.aborted||!this.centroid)return;let d=Zc(c,o);for(let p in this.touches){let _=d[p];(!_||_.dist(this.touches[p])>30)&&(this.aborted=!0)}}touchend(t,o,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){let d=!this.aborted&&this.centroid;if(this.reset(),d)return d}}}class aa{constructor(t){this.singleTap=new up(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,o,c){this.singleTap.touchstart(t,o,c)}touchmove(t,o,c){this.singleTap.touchmove(t,o,c)}touchend(t,o,c){let d=this.singleTap.touchend(t,o,c);if(d){let p=t.timeStamp-this.lastTime<500,_=!this.lastTap||this.lastTap.dist(d)<30;if(p&&_||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=d,this.count===this.numTaps)return this.reset(),d}}}class dp{constructor(){this._zoomIn=new aa({numTouches:1,numTaps:2}),this._zoomOut=new aa({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,o,c){this._zoomIn.touchstart(t,o,c),this._zoomOut.touchstart(t,o,c)}touchmove(t,o,c){this._zoomIn.touchmove(t,o,c),this._zoomOut.touchmove(t,o,c)}touchend(t,o,c){let d=this._zoomIn.touchend(t,o,c),p=this._zoomOut.touchend(t,o,c);return d?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:_=>_.easeTo({duration:300,zoom:_.getZoom()+1,around:_.unproject(d)},{originalEvent:t})}):p?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:_=>_.easeTo({duration:300,zoom:_.getZoom()-1,around:_.unproject(p)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}let pp={0:1,2:2},vu={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Ll{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,o){return!1}_move(t,o){return{}}mousedown(t,o){if(this._lastPoint)return;let c=Wt(t);this._correctButton(t,c)&&(this._lastPoint=o,this._eventButton=c)}mousemoveWindow(t,o){let c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&function(d,p){let _=pp[p];return d.buttons===void 0||(d.buttons&_)!==_}(t,this._eventButton))this.reset();else if(this._moved||!(o.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=o,this._move(c,o)}}mouseupWindow(t){this._lastPoint&&Wt(t)===this._eventButton&&(this._moved&&wt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class fp extends Ll{mousedown(t,o){super.mousedown(t,o),this._lastPoint&&(this._active=!0)}_correctButton(t,o){return o===0&&!t.ctrlKey}_move(t,o){return{around:o,panDelta:o.sub(t)}}}class bu extends Ll{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?vu[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let c=.8*(o.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class mp extends Ll{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?vu[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let c=-.5*(o.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class wm{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=o.clickTolerance||1,this.reset(),n.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new n.P(0,0)}touchstart(t,o,c){return this._calculateTransform(t,o,c)}touchmove(t,o,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!n.eJ())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,o,c)}}touchend(t,o,c){this._calculateTransform(t,o,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,o,c){c.length>0&&(this._active=!0);let d=Zc(c,o),p=new n.P(0,0),_=new n.P(0,0),x=0;for(let M in d){let C=d[M],z=this._touches[M];z&&(p._add(C),_._add(C.sub(z)),x++,d[M]=C)}if(this._touches=d,x<this._minTouches||!_.mag())return;let b=_.div(x);return this._sum._add(b),this._sum.mag()<this._clickTolerance?void 0:{around:p.div(x),panDelta:b}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=xe("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class wu{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,o,c){return{}}touchstart(t,o,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([o[0],o[1]]))}touchmove(t,o,c){let d=this._firstTwoTouches;if(!d)return;t.preventDefault();let[p,_]=d,x=Wc(c,o,p),b=Wc(c,o,_);if(!x||!b)return;let M=this._aroundCenter?null:x.add(b).div(2);return this._move([x,b],M,t)}touchend(t,o,c){if(!this._firstTwoTouches)return;let[d,p]=this._firstTwoTouches,_=Wc(c,o,d),x=Wc(c,o,p);_&&x||(this._active&&wt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Wc(l,t,o){for(let c=0;c<l.length;c++)if(l[c].identifier===o)return t[c]}function _p(l,t){return Math.log(l/t)/Math.LN2}class Tm extends wu{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,o){let c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(_p(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:_p(this._distance,c),pinchAround:o}}}function gp(l,t){return 180*l.angleWith(t)/Math.PI}class Sm extends wu{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,o){let c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:gp(this._vector,c),pinchAround:o}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());let o=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;let d=gp(t,c);return Math.abs(d)<o}}function Tu(l){return Math.abs(l.y)>Math.abs(l.x)}class Em extends wu{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Tu(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,o,c){let d=this._lastPoints;if(!d)return;let p=t[0].sub(d[0]),_=t[1].sub(d[1]);return this._map._cooperativeGestures&&!n.eJ()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(p,_,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(p.y+_.y)/2*-.5})}gestureBeginsVertically(t,o,c){if(this._valid!==void 0)return this._valid;let d=t.mag()>=2,p=o.mag()>=2;if(!d&&!p)return;if(!d||!p)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;let _=t.y>0==o.y>0;return Tu(t)&&Tu(o)&&_}}let Im={panStep:100,bearingStep:15,pitchStep:10};class Am{constructor(){let t=Im;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let o=0,c=0,d=0,p=0,_=0;switch(t.keyCode){case 61:case 107:case 171:case 187:o=1;break;case 189:case 109:case 173:o=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),p=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),p=1);break;case 38:t.shiftKey?d=1:(t.preventDefault(),_=-1);break;case 40:t.shiftKey?d=-1:(t.preventDefault(),_=1);break;default:return}return this._rotationDisabled&&(c=0,d=0),{cameraAnimation:x=>{let b=x.getZoom();x.easeTo({duration:300,easeId:"keyboardHandler",easing:Mm,zoom:o?Math.round(b)+o*(t.shiftKey?2:1):b,bearing:x.getBearing()+c*this._bearingStep,pitch:x.getPitch()+d*this._pitchStep,offset:[-p*this._panStep,-_*this._panStep],center:x.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Mm(l){return l*(2-l)}let Cm=4.000244140625,kg=1/450;class Fg{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._handler=o,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=kg,n.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||n.eJ()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let o=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY,c=n.q.now(),d=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,o!==0&&o%Cm==0?this._type="wheel":o!==0&&Math.abs(o)<4?this._type="trackpad":d>400?(this._type=null,this._lastValue=o,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(d*o)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,o+=this._lastValue)),t.shiftKey&&o&&(o/=4),this._type&&(this._lastWheelEvent=t,this._delta-=o,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let o=Ct(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:o,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let o=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){let M=this._type==="wheel"&&Math.abs(this._delta)>Cm?this._wheelZoomRate:this._defaultZoomRate,C=2/(1+Math.exp(-Math.abs(this._delta*M)));this._delta<0&&C!==0&&(C=1/C);let z=o(),P=Math.pow(2,z),D=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):P;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(D*C))),this._type==="wheel"&&(this._startZoom=z,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let c=typeof this._targetZoom=="number"?this._targetZoom:o(),d=this._startZoom,p=this._easing,_,x=!1;if(this._type==="wheel"&&d&&p){let M=Math.min((n.q.now()-this._lastWheelEventTime)/200,1),C=p(M);_=n.ai(d,c,C),M<1?this._frameId||(this._frameId=!0):x=!0}else _=c,x=!0;this._active=!0,x&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let b=_-o();return b*this._lastDelta<0&&(b=0),{noInertia:!0,needsRenderFrame:!x,zoomDelta:b,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let o=n.eK;if(this._prevEase){let c=this._prevEase,d=(n.q.now()-c.start)/c.duration,p=c.easing(d+.01)-c.easing(d),_=.27/Math.sqrt(p*p+1e-4)*.01,x=Math.sqrt(.0729-_*_);o=n.eI(_,x,.25,1)}return this._prevEase={start:n.q.now(),duration:t,easing:o},o}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=xe("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class gr{constructor(t,o){this._clickZoom=t,this._tapZoom=o}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Pm{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,o){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(o)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Bg{constructor(){this._tap=new aa({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,o,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=o[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,o,c))}touchmove(t,o,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;let d=o[0],p=d.y-this._swipePoint.y;return this._swipePoint=d,t.preventDefault(),this._active=!0,{zoomDelta:p/128}}}else this._tap.touchmove(t,o,c)}touchend(t,o,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,o,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class yp{constructor(t,o,c){this._el=t,this._mousePan=o,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Ng{constructor(t,o,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=o,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Xc{constructor(t,o,c,d){this._el=t,this._touchZoom=o,this._touchRotate=c,this._tapDragZoom=d,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}let Yc=l=>l.zoom||l.drag||l.pitch||l.rotate;class xp extends n.A{}class Su{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,o){let c=n.at([],o,t);this.radius=n.ae(c[2]<0?n.eM([],c,this.constants):[c[0],c[1],0])}projectRay(t){n.eM(t,t,this.constants),n.au(t,t),n.eN(t,t,this.constants);let o=n.c1([],t,this.radius);if(o[2]>0){let c=n.c1([],[0,0,1],n.bG(o,[0,0,1])),d=n.c1([],n.au([],[o[0],o[1],0]),this.radius),p=n.d5([],o,n.c1([],n.at([],n.d5([],d,c),o),2));o[0]=p[0],o[1]=p[1]}return o}}function Bo(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class Eu{constructor(t,o){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new xu(t),this._bearingSnap=o.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Su,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(o),n.aV(["handleEvent","handleWindowEvent"],this);let c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(let[d,p,_]of this._listeners){let x=d===document?this.handleWindowEvent:this.handleEvent;d.addEventListener(p,x,_)}}destroy(){for(let[t,o,c]of this._listeners){let d=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(o,d,c)}}_addDefaultHandlers(t){let o=this._map,c=o.getCanvasContainer();this._add("mapEvent",new cp(o,t));let d=o.boxZoom=new hp(o,t);this._add("boxZoom",d);let p=new dp,_=new Pm;o.doubleClickZoom=new gr(_,p),this._add("tapZoom",p),this._add("clickZoom",_);let x=new Bg;this._add("tapDragZoom",x);let b=o.touchPitch=new Em(o);this._add("touchPitch",b);let M=new bu(t),C=new mp(t);o.dragRotate=new Ng(t,M,C),this._add("mouseRotate",M,["mousePitch"]),this._add("mousePitch",C,["mouseRotate"]);let z=new fp(t),P=new wm(o,t);o.dragPan=new yp(c,z,P),this._add("mousePan",z),this._add("touchPan",P,["touchZoom","touchRotate"]);let D=new Sm,N=new Tm;o.touchZoomRotate=new Xc(c,N,D,x),this._add("touchRotate",D,["touchPan","touchZoom"]),this._add("touchZoom",N,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Ba(o));let F=o.scrollZoom=new Fg(o,this);this._add("scrollZoom",F,["mousePan"]);let j=o.keyboard=new Am;this._add("keyboard",j);for(let U of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[U]&&o[U].enable(t[U])}_add(t,o,c){this._handlers.push({handlerName:t,handler:o,allowed:c}),this._handlersById[t]=o}stop(t){if(!this._updatingCamera){for(let{handler:o}of this._handlers)o.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Yc(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,o,c){for(let d in t)if(d!==c&&(!o||o.indexOf(d)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){let o=[];for(let c of t)this._el.contains(c.target)&&o.push(c);return o}handleEvent(t,o){this._updatingCamera=!0;let c=t.type==="renderFrame",d=c?void 0:t,p={needsRenderFrame:!1},_={},x={},b=t.touches?this._getMapTouches(t.touches):void 0,M=b?Ft(this._el,b):c?void 0:Ct(this._el,t);for(let{handlerName:P,handler:D,allowed:N}of this._handlers){if(!D.isEnabled())continue;let F;this._blockedByActive(x,N,P)?D.reset():D[o||t.type]&&(F=D[o||t.type](t,M,b),this.mergeHandlerResult(p,_,F,P,d),F&&F.needsRenderFrame&&this._triggerRenderFrame()),(F||D.isActive())&&(x[P]=D)}let C={};for(let P in this._previousActiveHandlers)x[P]||(C[P]=d);this._previousActiveHandlers=x,(Object.keys(C).length||Bo(p))&&(this._changes.push([p,_,C]),this._triggerRenderFrame()),(Object.keys(x).length||Bo(p))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:z}=p;z&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],z(this._map))}mergeHandlerResult(t,o,c,d,p){if(!c)return;n.h(t,c);let _={handlerName:d,originalEvent:c.originalEvent||p};c.zoomDelta!==void 0&&(o.zoom=_),c.panDelta!==void 0&&(o.drag=_),c.pitchDelta!==void 0&&(o.pitch=_),c.bearingDelta!==void 0&&(o.rotate=_)}_applyChanges(){let t={},o={},c={};for(let[d,p,_]of this._changes)d.panDelta&&(t.panDelta=(t.panDelta||new n.P(0,0))._add(d.panDelta)),d.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+d.zoomDelta),d.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+d.bearingDelta),d.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+d.pitchDelta),d.around!==void 0&&(t.around=d.around),d.aroundCoord!==void 0&&(t.aroundCoord=d.aroundCoord),d.pinchAround!==void 0&&(t.pinchAround=d.pinchAround),d.noInertia&&(t.noInertia=d.noInertia),n.h(o,p),n.h(c,_);this._updateMapTransform(t,o,c),this._changes=[]}_updateMapTransform(t,o,c){let d=this._map,p=d.transform,_=Z=>[Z.x,Z.y,Z.z];if((Z=>{let Y=this._eventsInProgress.drag;return Y&&!this._handlersById[Y.handlerName].isActive()})()&&!Bo(t)){let Z=p.zoom;p.cameraElevationReference="sea",this._originalZoom!=null&&p._orthographicProjectionAtLowPitch&&p.projection.name!=="globe"&&p.pitch===0?(p.cameraElevationReference="ground",p.zoom=this._originalZoom):(p.recenterOnTerrain(),p.cameraElevationReference="ground"),Z!==p.zoom&&this._map._update(!0)}if(p._isCameraConstrained&&d._stop(!0),!Bo(t))return void this._fireEvents(o,c,!0);let{panDelta:x,zoomDelta:b,bearingDelta:M,pitchDelta:C,around:z,aroundCoord:P,pinchAround:D}=t;p._isCameraConstrained&&(b>0&&(b=0),p._isCameraConstrained=!1),D!==void 0&&(z=D),(b||(Z=>o[Z]&&!this._eventsInProgress[Z])("drag"))&&z&&(this._dragOrigin=_(p.pointCoordinate3D(z)),this._originalZoom=p.zoom,this._trackingEllipsoid.setup(p._camera.position,this._dragOrigin)),p.cameraElevationReference="sea",d._stop(!0),z=z||d.transform.centerPoint,M&&(p.bearing+=M),C&&(p.pitch+=C),p._updateCameraState();let N=[0,0,0];if(x)if(p.projection.name==="mercator"){let Z=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(z).dir),Y=this._trackingEllipsoid.projectRay(p.screenPointToMercatorRay(z.sub(x)).dir);N[0]=Y[0]-Z[0],N[1]=Y[1]-Z[1]}else{let Z=p.pointCoordinate(z);if(p.projection.name==="globe"){x=x.rotate(-p.angle);let Y=p._pixelsPerMercatorPixel/p.worldSize;N[0]=-x.x*n.eL(n.aY(Z.y))*Y,N[1]=-x.y*n.eL(p.center.lat)*Y}else{let Y=p.pointCoordinate(z.sub(x));Z&&Y&&(N[0]=Y.x-Z.x,N[1]=Y.y-Z.y)}}let F=p.zoom,j=[0,0,0];if(b){let Z=_(P||p.pointCoordinate3D(z)),Y={dir:n.au([],n.at([],Z,p._camera.position))};if(Y.dir[2]<0){let Q=p.zoomDeltaToMovement(Z,b);n.c1(j,Y.dir,Q)}}let U=n.d5(N,N,j);p._translateCameraConstrained(U),b&&Math.abs(p.zoom-F)>1e-4&&p.recenterOnTerrain(),p.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(o,c,!0)}_fireEvents(t,o,c){let d=Yc(this._eventsInProgress),p=Yc(t),_={};for(let C in t){let{originalEvent:z}=t[C];this._eventsInProgress[C]||(_[`${C}start`]=z),this._eventsInProgress[C]=t[C]}!d&&p&&this._fireEvent("movestart",p.originalEvent);for(let C in _)this._fireEvent(C,_[C]);p&&this._fireEvent("move",p.originalEvent);for(let C in t){let{originalEvent:z}=t[C];this._fireEvent(C,z)}let x={},b;for(let C in this._eventsInProgress){let{handlerName:z,originalEvent:P}=this._eventsInProgress[C];this._handlersById[z].isActive()||(delete this._eventsInProgress[C],b=o[z]||P,x[`${C}end`]=b)}for(let C in x)this._fireEvent(C,x[C]);let M=Yc(this._eventsInProgress);if(c&&(d||p)&&!M){this._updatingCamera=!0;let C=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),z=P=>P!==0&&-this._bearingSnap<P&&P<this._bearingSnap;C?(z(C.bearing||this._map.getBearing())&&(C.bearing=0),this._map.easeTo(C,{originalEvent:b})):(this._map.fire(new n.A("moveend",{originalEvent:b})),z(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,o){this._map.fire(new n.A(t,o?{originalEvent:o}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new xp("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}let Or="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class hs extends n.E{constructor(t,o){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=o.bearingSnap,this._respectPrefersReducedMotion=o.respectPrefersReducedMotion!==!1,n.aV(["_renderFrameCallback"],this)}getCenter(){return new n.ci(this.transform.center.lng,this.transform.center.lat)}setCenter(t,o){return this.jumpTo({center:t},o)}panBy(t,o,c){return t=n.P.convert(t).mult(-1),this.panTo(this.transform.center,n.h({offset:t},o),c)}panTo(t,o,c){return this.easeTo(n.h({center:t},o),c)}getZoom(){return this.transform.zoom}setZoom(t,o){return this.jumpTo({zoom:t},o),this}zoomTo(t,o,c){return this.easeTo(n.h({zoom:t},o),c)}zoomIn(t,o){return this.zoomTo(this.getZoom()+1,t,o),this}zoomOut(t,o){return this.zoomTo(this.getZoom()-1,t,o),this}getBearing(){return this.transform.bearing}setBearing(t,o){return this.jumpTo({bearing:t},o),this}getPadding(){return this.transform.padding}setPadding(t,o){return this.jumpTo({padding:t},o),this}rotateTo(t,o,c){return this.easeTo(n.h({bearing:t},o),c)}resetNorth(t,o){return this.rotateTo(0,n.h({duration:1e3},t),o),this}resetNorthPitch(t,o){return this.easeTo(n.h({bearing:0,pitch:0,duration:1e3},t),o),this}snapToNorth(t,o){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,o):this}getPitch(){return this.transform.pitch}setPitch(t,o){return this.jumpTo({pitch:t},o),this}cameraForBounds(t,o){t=n.aG.convert(t);let c=o&&o.bearing||0,d=o&&o.pitch||0,p=t.getNorthWest(),_=t.getSouthEast();return this._cameraForBounds(this.transform,p,_,c,d,o)}_extendPadding(t){let o={top:0,right:0,bottom:0,left:0};return t==null?n.h({},o,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:n.h({},o,t)}_extendCameraOptions(t){return(t=n.h({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,o){let c=o.max[0]-o.min[0],d=o.max[1]-o.min[1];return c/d>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):d/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,o,c,d,p,_){let x=t.clone(),b=this._extendCameraOptions(_);x.bearing=d,x.pitch=p;let M=n.ci.convert(o),C=n.ci.convert(c),z=.5*(M.lat+C.lat),P=.5*(M.lng+C.lng),D=n.eO(z,P),N=n.au([],D),F=n.au([],n.bF([],N,[0,1,0])),j=n.bF([],F,N),U=[F[0],F[1],F[2],0,j[0],j[1],j[2],0,N[0],N[1],N[2],0,0,0,0,1],Z=[D,n.eO(M.lat,M.lng),n.eO(C.lat,M.lng),n.eO(C.lat,C.lng),n.eO(M.lat,C.lng),n.eO(z,M.lng),n.eO(z,C.lng),n.eO(M.lat,P),n.eO(C.lat,P)],Y=n.d6.fromPoints(Z.map(Pe=>[n.bG(F,Pe),n.bG(j,Pe),n.bG(N,Pe)])),Q=n.ad([],Y.center,U);n.eP(Q)===0&&n.eQ(Q,0,0,1),n.au(Q,Q),n.c1(Q,Q,n.aB),x.center=n.eR(Q);let ne=x.getWorldToCameraMatrix(),he=n.bi(new Float64Array(16),ne);Y=n.d6.applyTransform(Y,n.az([],ne,U));let de=this._extendAABB(Y,x,b,d);if(!de)return void n.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Y=de,n.ad(Q,Q,ne);let oe=.5*(Y.max[2]-Y.min[2]),se=this._minimumAABBFrustumDistance(x,Y),le=n.c1([],[0,0,1],oe),Me=n.d5(le,Q,le),_e=se+(x.pitch===0?0:n.bD(Q,Me)),Ve=x.globeCenterInViewSpace,ze=n.at([],Q,[Ve[0],Ve[1],Ve[2]]);n.au(ze,ze),n.c1(ze,ze,_e);let je=n.d5([],Q,ze);n.ad(je,je,he);let rt=n.eB/n.aB,Ce=n.ae(je),me=n.cb(Math.max(Ce*rt-n.eB,Number.EPSILON),0),ke=Math.min(x.zoomFromMercatorZAdjusted(me),b.maxZoom);return ke>.5*(n.cX+n.cI)?(x.setProjection({name:"mercator"}),x.zoom=ke,this._cameraForBounds(x,o,c,d,p,_)):{center:x.center,zoom:ke,bearing:d,pitch:p}}_extendAABB(t,o,c,d){let p=.5*((c.padding.left||0)+(c.padding.right||0)),_=.5*((c.padding.top||0)+(c.padding.bottom||0)),x=_,b=p,M=p,C=_,z=o.width-(b+M),P=o.height-(x+C),D=n.at([],t.max,t.min),N=Math.min(z/D[0],P/D[1]),F=Math.min(o.scaleZoom(o.scale*N),c.maxZoom);if(isNaN(F))return null;let j=o.scale/o.zoomScale(F),U=new n.d6([t.min[0]-b*j,t.min[1]-C*j,t.min[2]],[t.max[0]+M*j,t.max[1]+x*j,t.max[2]]),Z=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new n.P(c.offset.x,c.offset.y):n.P.convert(c.offset)).rotate(-n.al(d));return U.center[0]-=Z.x*j,U.center[1]+=Z.y*j,U}queryTerrainElevation(t,o){let c=this.transform.elevation;return c?(o=n.h({},{exaggerated:!0},o),c.getAtPoint(n.ac.fromLngLat(t),null,o.exaggerated)):null}_cameraForBounds(t,o,c,d,p,_){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,o,c,d,p,_);let x=t.clone(),b=this._extendCameraOptions(_);x.bearing=d,x.pitch=p;let M=n.ci.convert(o),C=n.ci.convert(c),z=new n.ci(M.lng,C.lat),P=new n.ci(C.lng,M.lat),D=x.project(M),N=x.project(C),F=this.queryTerrainElevation(M),j=this.queryTerrainElevation(C),U=this.queryTerrainElevation(z),Z=this.queryTerrainElevation(P),Y=[[D.x,D.y,Math.min(F||0,j||0,U||0,Z||0)],[N.x,N.y,Math.max(F||0,j||0,U||0,Z||0)]],Q=n.d6.fromPoints(Y),ne=x.getWorldToCameraMatrix(),he=n.bi(new Float64Array(16),ne);Q=n.d6.applyTransform(Q,ne);let de=this._extendAABB(Q,x,b,d);if(!de)return void n.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Q=de;let oe=.5*n.at([],Q.max,Q.min)[2],se=this._minimumAABBFrustumDistance(x,Q),le=[0,0,1,0];n.aA(le,le,ne),n.eS(le,le);let Me=n.c1([],le,se+oe),_e=n.d5([],Q.center,Me);n.ad(Q.center,Q.center,he),n.ad(_e,_e,he);let Ve=x.unproject(new n.P(Q.center[0],Q.center[1])),ze=n.eT(x.projection,Ve),je=Math.pow(2,ze),rt=Math.min(x._zoomFromMercatorZ(_e[2]*x.pixelsPerMeter*je/x.worldSize),b.maxZoom);return x.mercatorFromTransition&&rt<.5*(n.cX+n.cI)?(x.setProjection({name:"globe"}),x.zoom=rt,this._cameraForBounds(x,o,c,d,p,_)):{center:Ve,zoom:rt,bearing:d,pitch:p}}fitBounds(t,o,c){let d=this.cameraForBounds(t,o);return this._fitInternal(d,o,c)}fitScreenCoordinates(t,o,c,d,p){let _=n.P.convert(t),x=n.P.convert(o),b=new n.P(Math.min(_.x,x.x),Math.min(_.y,x.y)),M=new n.P(Math.max(_.x,x.x),Math.max(_.y,x.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(_,x))return this;let C=this.transform.pointLocation3D(b),z=this.transform.pointLocation3D(M),P=this.transform.pointLocation3D(new n.P(b.x,M.y)),D=this.transform.pointLocation3D(new n.P(M.x,b.y)),N=[Math.min(C.lng,z.lng,P.lng,D.lng),Math.min(C.lat,z.lat,P.lat,D.lat)],F=[Math.max(C.lng,z.lng,P.lng,D.lng),Math.max(C.lat,z.lat,P.lat,D.lat)],j=d&&d.pitch?d.pitch:this.getPitch(),U=this._cameraForBounds(this.transform,N,F,c,j,d);return this._fitInternal(U,d,p)}_fitInternal(t,o,c){return t?(o=n.h(t,o)).linear?this.easeTo(o,c):this.flyTo(o,c):this}jumpTo(t,o){this.stop();let c=t.preloadOnly?this.transform.clone():this.transform,d=!1,p=!1,_=!1;"zoom"in t&&c.zoom!==+t.zoom&&(d=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=n.ci.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(p=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(_=!0,c.pitch=+t.pitch);let x=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(x))if(t.retainPadding===!1){let b=c.clone();b.padding=x,c.setLocationAtPoint(c.center,b.centerPoint)}else c.padding=x;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new n.A("movestart",o)).fire(new n.A("move",o)),d&&this.fire(new n.A("zoomstart",o)).fire(new n.A("zoom",o)).fire(new n.A("zoomend",o)),p&&this.fire(new n.A("rotatestart",o)).fire(new n.A("rotate",o)).fire(new n.A("rotateend",o)),_&&this.fire(new n.A("pitchstart",o)).fire(new n.A("pitch",o)).fire(new n.A("pitchend",o)),this.fire(new n.A("moveend",o)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||n.w(Or),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,o){let c=this.transform;if(!c.projection.supportsFreeCamera)return n.w(Or),this;this.stop();let d=c.zoom,p=c.pitch,_=c.bearing;c.setFreeCameraOptions(t);let x=d!==c.zoom,b=p!==c.pitch,M=_!==c.bearing;return this.fire(new n.A("movestart",o)).fire(new n.A("move",o)),x&&this.fire(new n.A("zoomstart",o)).fire(new n.A("zoom",o)).fire(new n.A("zoomend",o)),M&&this.fire(new n.A("rotatestart",o)).fire(new n.A("rotate",o)).fire(new n.A("rotateend",o)),b&&this.fire(new n.A("pitchstart",o)).fire(new n.A("pitch",o)).fire(new n.A("pitchend",o)),this.fire(new n.A("moveend",o)),this}easeTo(t,o){this._stop(!1,t.easeId),((t=n.h({offset:[0,0],duration:500,easing:n.eK},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);let c=this.transform,d=this.getZoom(),p=this.getBearing(),_=this.getPitch(),x=this.getPadding(),b="zoom"in t?+t.zoom:d,M="bearing"in t?this._normalizeBearing(t.bearing,p):p,C="pitch"in t?+t.pitch:_,z=this._extendPadding(t.padding),P=n.P.convert(t.offset),D,N,F;if(c.projection.name==="globe"){let le=n.ac.fromLngLat(c.center),Me=P.rotate(-c.angle);le.x+=Me.x/c.worldSize,le.y+=Me.y/c.worldSize;let _e=le.toLngLat(),Ve=n.ci.convert(t.center||_e);this._normalizeCenter(Ve),D=c.centerPoint.add(Me),N=new n.P(le.x,le.y).mult(c.worldSize),F=new n.P(n.aD(Ve.lng),n.aH(Ve.lat)).mult(c.worldSize).sub(N)}else{D=c.centerPoint.add(P);let le=c.pointLocation(D),Me=n.ci.convert(t.center||le);this._normalizeCenter(Me),N=c.project(le),F=c.project(Me).sub(N)}let j=c.zoomScale(b-d),U,Z;t.around&&(U=n.ci.convert(t.around),Z=c.locationPoint(U));let Y=this._zooming||b!==d,Q=this._rotating||p!==M,ne=this._pitching||C!==_,he=!c.isPaddingEqual(z),de=t.retainPadding===!1?c.clone():c,oe=le=>Me=>{if(Y&&(le.zoom=n.ai(d,b,Me)),Q&&(le.bearing=n.ai(p,M,Me)),ne&&(le.pitch=n.ai(_,C,Me)),he&&(de.interpolatePadding(x,z,Me),D=de.centerPoint.add(P)),U)le.setLocationAtPoint(U,Z);else{let _e=le.zoomScale(le.zoom-d),Ve=b>d?Math.min(2,j):Math.max(.5,j),ze=Math.pow(Ve,1-Me),je=le.unproject(N.add(F.mult(Me*ze)).mult(_e));le.setLocationAtPoint(le.renderWorldCopies?je.wrap():je,D)}return t.preloadOnly||this._fireMoveEvents(o),le};if(t.preloadOnly){let le=this._emulate(oe,t.duration,c);return this._preloadTiles(le),this}let se={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=Y,this._rotating=Q,this._pitching=ne,this._padding=he,this._easeId=t.easeId,this._prepareEase(o,t.noMoveStart,se),this._ease(oe(c),le=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(o,le)},t),this}_prepareEase(t,o,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),o||c.moving||this.fire(new n.A("movestart",t)),this._zooming&&!c.zooming&&this.fire(new n.A("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new n.A("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new n.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new n.A("move",t)),this._zooming&&this.fire(new n.A("zoom",t)),this._rotating&&this.fire(new n.A("rotate",t)),this._pitching&&this.fire(new n.A("pitch",t))}_afterEase(t,o){if(this._easeId&&o&&this._easeId===o)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let c=this._zooming,d=this._rotating,p=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new n.A("zoomend",t)),d&&this.fire(new n.A("rotateend",t)),p&&this.fire(new n.A("pitchend",t)),this.fire(new n.A("moveend",t))}flyTo(t,o){if(this._prefersReducedMotion(t)){let Pe=n.aF(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Pe,o)}this.stop(),t=n.h({offset:[0,0],speed:1.2,curve:1.42,easing:n.eK},t);let c=this.transform,d=this.getZoom(),p=this.getBearing(),_=this.getPitch(),x=this.getPadding(),b="zoom"in t?n.ay(+t.zoom,c.minZoom,c.maxZoom):d,M="bearing"in t?this._normalizeBearing(t.bearing,p):p,C="pitch"in t?+t.pitch:_,z=this._extendPadding(t.padding),P=c.zoomScale(b-d),D=n.P.convert(t.offset),N=c.centerPoint.add(D),F=c.pointLocation(N),j=n.ci.convert(t.center||F);this._normalizeCenter(j);let U=c.project(F),Z=c.project(j).sub(U),Y=t.curve,Q=Math.max(c.width,c.height),ne=Q/P,he=Z.mag();if("minZoom"in t){let Pe=n.ay(Math.min(t.minZoom,d,b),c.minZoom,c.maxZoom),$e=Q/c.zoomScale(Pe-d);Y=Math.sqrt($e/he*2)}let de=Y*Y;function oe(Pe){let $e=(ne*ne-Q*Q+(Pe?-1:1)*de*de*he*he)/(2*(Pe?ne:Q)*de*he);return Math.log(Math.sqrt($e*$e+1)-$e)}function se(Pe){return(Math.exp(Pe)-Math.exp(-Pe))/2}function le(Pe){return(Math.exp(Pe)+Math.exp(-Pe))/2}let Me=oe(0),_e=function(Pe){return le(Me)/le(Me+Y*Pe)},Ve=function(Pe){return Q*((le(Me)*(se($e=Me+Y*Pe)/le($e))-se(Me))/de)/he;var $e},ze=(oe(1)-Me)/Y;if(Math.abs(he)<1e-6||!isFinite(ze)){if(Math.abs(Q-ne)<1e-6)return this.easeTo(t,o);let Pe=ne<Q?-1:1;ze=Math.abs(Math.log(ne/Q))/Y,Ve=function(){return 0},_e=function($e){return Math.exp(Pe*Y*$e)}}t.duration="duration"in t?+t.duration:1e3*ze/("screenSpeed"in t?+t.screenSpeed/Y:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);let je=p!==M,rt=C!==_,Ce=!c.isPaddingEqual(z),me=t.retainPadding===!1?c.clone():c,ke=Pe=>$e=>{let Ze=$e*ze,Ye=1/_e(Ze);Pe.zoom=$e===1?b:d+Pe.scaleZoom(Ye),je&&(Pe.bearing=n.ai(p,M,$e)),rt&&(Pe.pitch=n.ai(_,C,$e)),Ce&&(me.interpolatePadding(x,z,$e),N=me.centerPoint.add(D));let ct=$e===1?j:Pe.unproject(U.add(Z.mult(Ve(Ze))).mult(Ye));return Pe.setLocationAtPoint(Pe.renderWorldCopies?ct.wrap():ct,N),Pe._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(o),Pe};if(t.preloadOnly){let Pe=this._emulate(ke,t.duration,c);return this._preloadTiles(Pe),this}return this._zooming=!0,this._rotating=je,this._pitching=rt,this._padding=Ce,this._prepareEase(o,!1),this._ease(ke(c),()=>this._afterEase(o),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,o){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,o)}if(!t){let c=this.handlers;c&&c.stop(!1)}return this}_ease(t,o,c){c.animate===!1||c.duration===0?(t(1),o()):(this._easeStart=n.q.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=o,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let t=Math.min((n.q.now()-this._easeStart)/this._easeOptions.duration,1),o=this._onEaseFrame;o&&o(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,o){t=n.bQ(t,-180,180);let c=Math.abs(t-o);return Math.abs(t-360-o)<c&&(t-=360),Math.abs(t+360-o)<c&&(t+=360),t}_normalizeCenter(t){let o=this.transform;if(o.maxBounds||o.projection.name!=="globe"&&!o.renderWorldCopies)return;let c=t.lng-o.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&n.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,o,c){let d=Math.ceil(15*o/1e3),p=[],_=t(c.clone());for(let x=0;x<=d;x++){let b=_(x/d);p.push(b.clone())}return p}_preloadTiles(t,o){}}class zl{constructor(t={}){this.options=t,n.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){let o=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=xe("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);let d=xe("span","mapboxgl-ctrl-icon",this._compactButton);return d.setAttribute("aria-hidden","true"),d.setAttribute("title",c),this._innerContainer=xe("div","mapboxgl-ctrl-attrib-inner",this._container),o&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),o===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));let o=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||n.e.ACCESS_TOKEN}];if(t){let c=o.reduce((d,p,_)=>(p.value&&(d+=`${p.key}=${p.value}${_<o.length-1?"&":""}`),d),"?");t.href=`${n.e.FEEDBACK_URL}/${c}#${yu(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){let d=this._map.style.stylesheet;this.styleOwner=d.owner,this.styleId=d.id}let o=this._map.style._mergedSourceCaches;for(let d in o){let p=o[d];if(p.used){let _=p.getSource();_.attribution&&t.indexOf(_.attribution)<0&&t.push(_.attribution)}}t.sort((d,p)=>d.length-p.length),t=t.filter((d,p)=>{for(let _=p+1;_<t.length;_++)if(t[_].indexOf(d)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));let c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Kc{constructor(){n.aV(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=xe("div","mapboxgl-ctrl");let o=xe("a","mapboxgl-ctrl-logo");return o.target="_blank",o.rel="noopener nofollow",o.href="https://www.mapbox.com/",o.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),o.setAttribute("rel","noopener nofollow"),this._container.appendChild(o),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(let o in t){let c=t[o].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){let t=this._container.children;if(t.length){let o=t[0];this._map.getCanvasContainer().offsetWidth<250?o.classList.add("mapboxgl-compact"):o.classList.remove("mapboxgl-compact")}}}class vp{constructor(){n.aV(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("indoorupdate",o=>this._onIndoorUpdate({selectedFloorId:o.selectedFloorId,floors:o.floors})),this._container}_createButton(t,o){let c=xe("button",t,this._container);return c.type="button",c.addEventListener("click",o),c}_setButtonTitle(t,o){this._map&&(t.setAttribute("aria-label",o),t.innerHTML=`<strong>${o}</strong>`,t.firstElementChild&&t.firstElementChild.setAttribute("title",o))}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("indoorupdate",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return void(this._container.style.display="none");let o=this._model;this._model=t,this._container.style.display="inline-block";let c=t.floors.sort((d,p)=>d.levelOrder-p.levelOrder);o?(Array.from(this._container.children).forEach(d=>d.remove()),this.addCurrentFloors(c)):this.addCurrentFloors(c)}addCurrentFloors(t){for(let o of t){let c=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(o.id),Array.from(this._container.children).forEach(d=>{d.classList.remove("mapboxgl-ctrl-level-button-selected")}),c.classList.add("mapboxgl-ctrl-level-button-selected")});this._setButtonTitle(c,o.shortName),this._model&&o.id===this._model.selectedFloorId&&(this._map._selectIndoorFloor(o.id),c.classList.add("mapboxgl-ctrl-level-button-selected")),this._container.append(c)}}}class Rm{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){let o=++this._id;return this._queue.push({callback:t,id:o,cancelled:!1}),o}remove(t){let o=this._currentlyRunning,c=o?this._queue.concat(o):this._queue;for(let d of c)if(d.id===t)return void(d.cancelled=!0)}run(t=0){let o=this._currentlyRunning=this._queue;this._queue=[];for(let c of o)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Jc{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;let o=n.dx((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-o)+this._end*o}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,o,c){this._start=this.getValue(o),this._end=t,this._startTime=o,this._endTime=o+c}}let Vg={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Lm extends n.A{constructor(t,o,c,d){let{point:p,lngLat:_,originalEvent:x,target:b}=t;super(t.type,{point:p,lngLat:_,originalEvent:x,target:b}),this.preventDefault=()=>{t.preventDefault()},this.id=o,this.interaction=c,this.feature=d}}class bp{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,o){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);let c=o.filter,d=o.type;c&&this.filters.set(t,n.b3(c)),d==="mouseover"&&(d="mouseenter"),d==="mouseout"&&(d="mouseleave");let p=this.interactionsByType.get(d)||new Map;d==="mouseenter"||d==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,o)):p.size===0&&this.map.on(d,this.handleType),p.size===0&&this.interactionsByType.set(d,p),p.set(t,o),this.typeById.set(t,d)}get(t){let o=this.typeById.get(t);if(!o)return;let c=this.interactionsByType.get(o);return c?c.get(t):void 0}remove(t){let o=this.typeById.get(t);if(!o)return;this.typeById.delete(t),this.filters.delete(t);let c=this.interactionsByType.get(o);c&&(c.delete(t),o==="mouseenter"||o==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(o,this.handleType))}queryTargets(t,o){let c=[];for(let[d,p]of o)p.target&&c.push({targetId:d,target:p.target,filter:this.filters.get(d)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;let o=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());o.length&&(t.type="mouseenter",this.handleType(t,o));let c=new Map;for(let[d,{feature:p}]of this.prevHoveredFeatures)this.hoveredFeatures.has(d)||c.set(p.id,p);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){let o=Array.from(this.hoveredFeatures.values()).map(({feature:c})=>c);o.length&&(t.type="mouseleave",this.handleType(t,o)),this.hoveredFeatures.clear()}handleType(t,o){let c=t.type==="mouseenter";if(c&&!this.interactionsByType.has(t.type))return void n.w("mouseenter interaction required for mouseleave to work.");let d=Array.from(this.interactionsByType.get(t.type)).reverse(),p=!!o;o=o||this.queryTargets(t.point,d);let _=!1,x=new Set;for(let b of o){for(let[M,C]of d){if(!C.target)continue;let z=b.variants?b.variants[M]:null;if(z){for(let P of z){if(Eh(P,b,x,M))continue;let D=new n.dr(b,P),N=pc(P,b,M);p&&(D.state=this.map.getFeatureState(D));let F=c?this.prevHoveredFeatures.get(N):null,j=new Lm(t,M,C,D),U=F?F.stop:C.handler(j);if(c&&this.hoveredFeatures.set(N,{feature:b,stop:U}),U!==!1){_=!0;break}}if(_)break}}if(_)break}if(!_)for(let[b,M]of d){let{handler:C,target:z}=M;if(!z&&C(new Lm(t,b,M,null))!==!1)break}}}function wp(l,t){if(Array.isArray(l)&&Array.isArray(t)){let o=new Set(l),c=new Set(t);return o.size===c.size&&l.every(d=>c.has(d))}return n.bv(l,t)}let Qc={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Dl={showCompass:!0,showZoom:!0,visualizePitch:!1};class Rs{constructor(t,o,c=!1){this._clickTolerance=10,this.element=o,this.mouseRotate=new bu({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new mp({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),n.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),o.addEventListener("mousedown",this.mousedown),o.addEventListener("touchstart",this.touchstart,{passive:!1}),o.addEventListener("touchmove",this.touchmove),o.addEventListener("touchend",this.touchend),o.addEventListener("touchcancel",this.reset)}down(t,o){this.mouseRotate.mousedown(t,o),this.mousePitch&&this.mousePitch.mousedown(t,o),_t()}move(t,o){let c=this.map,d=this.mouseRotate.mousemoveWindow(t,o),p=d&&d.bearingDelta;if(p&&c.setBearing(c.getBearing()+p),this.mousePitch){let _=this.mousePitch.mousemoveWindow(t,o),x=_&&_.pitchDelta;x&&c.setPitch(c.getPitch()+x)}}off(){let t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Pt(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(n.h({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Ct(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Ct(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Ft(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=Ft(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function No(l,t,o){if(l=new n.ci(l.lng,l.lat),t){let c=new n.ci(l.lng-360,l.lat),d=new n.ci(l.lng+360,l.lat),p=360*Math.ceil(Math.abs(l.lng-o.center.lng)/360),_=o.locationPoint3D(l).distSqr(t),x=t.x<0||t.y<0||t.x>o.width||t.y>o.height;o.locationPoint3D(c).distSqr(t)<_&&(x||Math.abs(c.lng-o.center.lng)<p)?l=c:o.locationPoint3D(d).distSqr(t)<_&&(x||Math.abs(d.lng-o.center.lng)<p)&&(l=d)}for(;Math.abs(l.lng-o.center.lng)>180;){let c=o.locationPoint3D(l);if(c.x>=0&&c.y>=0&&c.x<=o.width&&c.y<=o.height)break;l.lng>o.center.lng?l.lng-=360:l.lng+=360}return l}let xo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},On={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class vo extends n.E{constructor(t,o){super(),(t instanceof HTMLElement||o)&&(t=n.h({element:t},o)),n.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);let{anchor:c="center",color:d="#3FB1CE",scale:p=1,draggable:_=!1,clickTolerance:x=0,rotation:b=On.rotation,rotationAlignment:M=On.rotationAlignment,pitchAlignment:C=On.pitchAlignment,occludedOpacity:z=On.occludedOpacity,altitude:P=On.altitude}=t||{};this._anchor=c,this._color=d,this._scale=p,this._draggable=_,this._clickTolerance=x,this._rotation=b,this._rotationAlignment=M,this._pitchAlignment=C,this._occludedOpacity=z,this._altitude=P,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=n.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=n.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",F=>{F.preventDefault()}),this._element.addEventListener("mousedown",F=>{F.preventDefault()});let D=this._element.classList;for(let F in xo)D.remove(`mapboxgl-marker-anchor-${F}`);D.add(`mapboxgl-marker-anchor-${this._anchor}`);let N=t&&t.className?t.className.trim().split(/\s+/):[];D.add(...N),this._popup=null}_createDefaultMarker(){let t=xe("div"),o=Ge("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){let c=Ge("radialGradient",{id:"shadowGradient"},Ge("defs",{},o));Ge("stop",{offset:"10%","stop-opacity":.4},c),Ge("stop",{offset:"100%","stop-opacity":.05},c),Ge("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},o)}return Ge("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},o),Ge("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},o),Ge("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},o),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){let t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=n.ci.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||On.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){let d=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[d,-1*(38.1-13.5+d)],"bottom-right":[-d,-1*(38.1-13.5+d)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){let o=t.code,c=t.charCode||t.keyCode;o!=="Space"&&o!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){let o=t.originalEvent.target,c=this._element;this._popup&&(o===c||c.contains(o))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){let t=this._map,o=this._pos;if(!t||!o)return!1;let c=t.unproject(o,this._altitude),d=t.getFreeCameraOptions();if(!d.position)return!1;let p=d.position.toLngLat();return p.distanceTo(c)<.9*p.distanceTo(this._lngLat)}_evaluateOpacity(){let t=this._map;if(!t)return;let o=this._pos;if(!o||o.x<0||o.x>t.transform.width||o.y<0||o.y>t.transform.height)return void this._clearFadeTimer();let c=t.unproject(o,this._altitude),d;t._showingGlobe()&&n.eW(t.transform,this._lngLat)?d=0:(d=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(d*=this._occludedOpacity)),this._element.style.opacity=`${d}`,this._element.style.pointerEvents=d>0?"auto":"none",this._popup&&this._popup._setOpacity(d),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let t=this._pos;if(!t||!this._map)return;let o=this._offset.mult(this._scale);this._element.style.transform=`
>>>>>>> a526947f4e024d155ff980808ddb8c37daf4d8a2
            translate(${t.x}px,${t.y}px)
            ${xo[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${o.x}px,${o.y}px)
<<<<<<< HEAD
        `}_calculateXYTransform(){let t=this._pos,o=this._map,c=this.getPitchAlignment();if(!o||!t||c!=="map")return"";if(!o._showingGlobe()){let b=o.getPitch();return b?`rotateX(${b}deg)`:""}let d=n.cU(n.eX(o.transform,this._lngLat)),p=t.sub(n.eY(o.transform)),_=Math.abs(p.x)+Math.abs(p.y);if(_===0)return"";let x=d/_;return`rotateX(${-p.y*x}deg) rotateY(${p.x*x}deg)`}_calculateZTransform(){let t=this._pos,o=this._map;if(!o||!t)return"";let c=0,d=this.getRotationAlignment();if(d==="map")if(o._showingGlobe()){let p=o.project(new n.ci(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),_=o.project(new n.ci(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(p);c=n.cU(Math.atan2(_.y,_.x))-90}else c=-o.getBearing();else if(d==="horizon"){let p=n.af(4,6,o.getZoom()),_=n.eY(o.transform);_.y+=p*o.transform.height;let x=t.sub(_),b=n.cU(Math.atan2(x.y,x.x));c=(b>90?b-270:b+90)*(1-p)}return c+=this._rotation,c?`rotateZ(${c}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);let o=this._map;o&&(o.transform.renderWorldCopies&&(this._lngLat=No(this._lngLat,this._pos,o.transform)),this._pos=o.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),o._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(o._showingGlobe()||o.getTerrain()||o.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=n.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){let o=this._map;if(!o)return;let c=this._pointerdownPos,d=this._positionDelta;if(c&&d){if(!this._isDragging){let p=this._clickTolerance||o._clickTolerance;if(t.point.dist(c)<p)return;this._isDragging=!0}this._pos=t.point.sub(d),this._lngLat=o.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new n.A("dragstart"))),this.fire(new n.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new n.A("dragend")),this._state="inactive"}_addDragHandler(t){let o=this._map,c=this._pos;o&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",o.on("mousemove",this._onMove),o.on("touchmove",this._onMove),o.once("mouseup",this._onUp),o.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;let o=this._map;return o&&(t?(o.on("mousedown",this._addDragHandler),o.on("touchstart",this._addDragHandler)):(o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||On.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||On.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||On.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||On.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}let jg={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Gg={maxWidth:100,unit:"metric"},qg={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Hg={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},Dm=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Cn(l=new n.P(0,0),t="bottom"){if(typeof l=="number"){let o=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new n.P(0,l);case"top-left":return new n.P(o,o);case"top-right":return new n.P(-o,o);case"bottom":return new n.P(0,-l);case"bottom-left":return new n.P(o,-o);case"bottom-right":return new n.P(-o,-o);case"left":return new n.P(l,0);case"right":return new n.P(-l,0)}return new n.P(0,0)}return l instanceof n.P||Array.isArray(l)?n.P.convert(l):n.P.convert(l[t]||[0,0])}return{version:O,supported:Ae.supported,setRTLTextPlugin:n.f0,getRTLTextPluginStatus:n.e$,Map:class extends hs{constructor(l){H.mark(V.create);let t=l;if((l=n.h({},eh,l)).minZoom!=null&&l.maxZoom!=null&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(l.minPitch!=null&&l.maxPitch!=null&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(l.minPitch!=null&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(l.maxPitch!=null&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&n.eU(window)&&(l.antialias=!1,n.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new gd(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies,null,null),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new Lm,this._domRenderTaskQueue=new Lm,this._controls=[],this._markers=[],this._popups=[],this._mapId=n.a$(),this._locale=n.h({},Ug,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Qc(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new yi(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},typeof l.container=="string"){let o=document.getElementById(l.container);if(!o)throw new Error(`Container '${l.container.toString()}' not found.`);this._container=o}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&n.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,n.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Og),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Iu(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||n.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),this.indoor=new gg(this),l.hash&&(this._hash=new yu(typeof l.hash=="string"&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});let o=l.bounds;o&&(this.resize(),this.fitBounds(o,n.h({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new Dl({customAttribution:l.customAttribution})),this._logoControl=new Jc,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",o=>{this._update(o.dataType==="style"),this.fire(new n.A(`${o.dataType}data`,o))}),this.on("dataloading",o=>{this.fire(new n.A(`${o.dataType}dataloading`,o))}),this._interactions=new wp(this)}_getMapId(){return this._mapId}addControl(l,t){if(t===void 0&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new n.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let o=l.onAdd(this);this._controls.push(l);let c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(o,c.firstChild):c.appendChild(o),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new n.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let t=!this._moving;return t&&this.fire(new n.A("movestart",l)).fire(new n.A("move",l)),this.fire(new n.A("resize",l)),t&&this.fire(new n.A("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(n.aG.convert(l)),this._update()}setMinZoom(l){if((l=l??-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new n.A("zoomstart")).fire(new n.A("zoom")).fire(new n.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l??22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new n.A("zoomstart")).fire(new n.A("zoom")).fire(new n.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new n.A("pitchstart")).fire(new n.A("pitch")).fire(new n.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new n.A("pitchstart")).fire(new n.A("pitch")).fire(new n.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return l==="auto"?navigator.language:Array.isArray(l)?l.length===0?void 0:l.map(t=>t==="auto"?navigator.language:t):l}setLanguage(l){let t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(let o of this._controls)o._setLanguage&&o._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(l){return this._lazyInitEmptyStyle(),l?typeof l=="string"&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;let l=this.transform,t=l.projection.name,o;t==="globe"&&l.zoom>=n.cI?(l.setMercatorFromTransition(),o=!0):t==="mercator"&&l.zoom<n.cI&&(l.setProjection({name:"globe"}),o=!0),o&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;return t=l.name==="globe"&&this.transform.zoom>=n.cI?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l,t){return this.transform.locationPoint3D(n.ci.convert(l),t)}unproject(l,t){return this.transform.pointLocation3D(n.P.convert(l),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,o){let c=d=>{let p=[];if(Array.isArray(t)){let _=t.filter(x=>this.getLayer(x));p=_.length?this.queryRenderedFeatures(d,{layers:_}):[]}else p=this.queryRenderedFeatures(d,{target:t});return p};if(l==="mouseenter"||l==="mouseover"){let d=!1;return{listener:o,targets:t,delegates:{mousemove:_=>{let x=c(_.point);x.length?d||(d=!0,o.call(this,new ur(l,this,_.originalEvent,{features:x}))):d=!1},mouseout:()=>{d=!1}}}}if(l==="mouseleave"||l==="mouseout"){let d=!1;return{listener:o,targets:t,delegates:{mousemove:x=>{c(x.point).length?d=!0:d&&(d=!1,o.call(this,new ur(l,this,x.originalEvent)))},mouseout:x=>{d&&(d=!1,o.call(this,new ur(l,this,x.originalEvent)))}}}}{let d=p=>{let _=c(p.point);_.length&&(p.features=_,o.call(this,p),delete p.features)};return{listener:o,targets:t,delegates:{[l]:d}}}}on(l,t,o){if(typeof t=="function"||o===void 0)return super.on(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let c=this._createDelegatedListener(l,t,o);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(let d in c.delegates)this.on(d,c.delegates[d]);return this}once(l,t,o){if(typeof t=="function"||o===void 0)return super.once(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let c=this._createDelegatedListener(l,t,o);for(let d in c.delegates)this.once(d,c.delegates[d]);return this}off(l,t,o){if(typeof t=="function"||o===void 0)return super.off(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(d=>{for(let p=0;p<d.length;p++){let _=d[p];if(_.listener===o&&Tp(_.targets,t)){for(let x in _.delegates)this.off(x,_.delegates[x]);return d.splice(p,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(l===void 0||l instanceof n.P||Array.isArray(l)||t!==void 0||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){let p=this.style.queryRenderedFeatures(l,void 0,this.transform),_=this.style.queryRenderedFeatureset(l,void 0,this.transform);return p.concat(_)}let o=!0;if(t.target&&(o=this._isTargetValid(t.target),o&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(let p of t.layers)if(!this._isValidId(p)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let d=[];return c&&(d=d.concat(this.style.queryRenderedFeatures(l,t,this.transform))),o&&(d=d.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),d}querySourceFeatures(l,t){return!l||typeof l=="string"&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}isPointOnSurface(l){let{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&n.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(n.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(l){return this._cooperativeGestures=l,this}setStyle(l,t){return t=n.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,(o,c)=>{if(o){let d=typeof o=="string"?o:o instanceof Error?o.message:o.error;n.w(`Unable to perform style diff: ${d}. Rebuilding the style from scratch.`),this._updateStyle(l,t)}else c&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){let t=this._locale[l];if(t==null)throw new Error(`Missing UI string '${l}'`);return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){let o=n.h({},t);t&&t.config&&(o.initialConfig=t.config,delete o.config),this.style=new ko(this,o).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new ko(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(n.w("There is no style added to the map."),!1)}_isValidId(l){return l==null?(this.fire(new n.z(new Error("IDs can't be empty."))),!1):!n.dk(l)||(this.fire(new n.z(new Error(`IDs can't contain special symbols: "${l}".`))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(let t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,o){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,o)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:o=1,sdf:c=!1,stretchX:d,stretchY:p,content:_}={}){this._lazyInitEmptyStyle();let x=n.I.from(l);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){let{width:b,height:M,data:C}=n.q.getImageData(t);this.style.addImage(x,{data:new n.r({width:b,height:M},C),pixelRatio:o,stretchX:d,stretchY:p,content:_,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new n.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:b,height:M}=t,C=t;this.style.addImage(x,{data:new n.r({width:b,height:M},new Uint8Array(C.data)),pixelRatio:o,stretchX:d,stretchY:p,content:_,sdf:c,usvg:!1,version:0,userImage:C}),C.onAdd&&C.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();let o=n.I.from(l),c=this.style.getImage(o);if(!c)return void this.fire(new n.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let d=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?n.q.getImageData(t):t,{width:p,height:_,data:x}=d;if(p===void 0||_===void 0)return void this.fire(new n.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(p!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||_!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new n.z(new Error(`The width and height of the updated image (${p}, ${_})
                must be that same as the previous version of the image
                (${c.data.width}, ${c.data.height})`)));let b=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap),M=!1;c.usvg?(c.data=new n.r({width:p,height:_},new Uint8Array(x)),c.usvg=!1,c.icon=void 0,M=!0):c.data.replace(x,b),this.style.updateImage(o,c,M)}hasImage(l){return l?!!this.style&&!!this.style.getImage(n.I.from(l)):(this.fire(new n.z(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(n.I.from(l))}loadImage(l,t){n.o(this._requestManager.transformRequest(l,n.R.Image),(o,c)=>{t(o,c instanceof HTMLImageElement?n.q.getImageData(c):c)})}listImages(){return this.style.listImages().map(l=>l.name)}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new n.z(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){let t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t).catch(o=>this.fire(new n.z(new Error("Failed to add import",o)))),this}updateImport(l,t){return typeof t!="string"&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;let t=this.style.getOwnLayer(l);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,o){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,o),this._update(!0)):this}setFilter(l,t,o={}){return this._isValidId(l)?(this.style.setFilter(l,t,o),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,o,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,o,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,o,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,o,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(l){return this.style.setGlyphsUrl(l),this._update(!0)}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,o){return this.style.setConfigProperty(l,t,o),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&l.length===1&&l[0].type==="flat"){let t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let l=this.style.getLights()||[];return l.length===0&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch(l["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(n.ci.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_selectIndoorFloor(l){this.indoor.selectFloor(l)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new bp),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;let l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300,o,c,d,p=this._container;for(;p&&(!c||!d);){let _=window.getComputedStyle(p).transform;_&&_!=="none"&&(o=_.match(/matrix.*\((.+)\)/)[1].split(", "),o[0]&&o[0]!=="0"&&o[0]!=="1"&&(c=o[0]),o[3]&&o[3]!=="0"&&o[3]!=="1"&&(d=o[3])),p=p.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=d?Math.abs(t/d):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&n.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=xe("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();let t=this._canvasContainer=xe("div","mapboxgl-canvas-container",l);this._canvas=xe("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let o=this._controlContainer=xe("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(d=>{c[d]=xe("div",`mapboxgl-ctrl-${d}`,o)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){let o=n.q.devicePixelRatio||1;this._canvas.width=o*Math.ceil(l),this._canvas.height=o*Math.ceil(t),this._canvas.style.width=`${l}px`,this._canvas.style.height=`${t}px`}_addMarker(l){this._markers.push(l)}_removeMarker(l){let t=this._markers.indexOf(l);t!==-1&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){let t=this._popups.indexOf(l);t!==-1&&this._popups.splice(t,1)}_setupPainter(){let l=n.h({},Ae.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(Bs(t,!0),this.painter=new sa(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",o=>{o.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),n.l.testSupport(t)):this.fire(new n.z(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new n.A("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new n.A("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new n.A("renderstart")),++this._frameId;let o=this.painter.context.extTimerQuery,c=n.q.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=d.createQuery(),d.beginQuery(o.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();let p=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let M=this.transform.zoom,C=this.transform.pitch,z=n.q.now(),P=new n.aa(M,{now:z,fadeDuration:p,pitch:C,transition:this.style.transition,worldview:this._worldview});this.style.update(P)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let _=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),_=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):_=this._updateAverageElevation(c);let x=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,p,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),x&&(this._placementDirty=x.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:p,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new n.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,H.mark(V.load),this.fire(new n.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){let M=n.q.now()-c;d.endQuery(o.TIME_ELAPSED_EXT),setTimeout(()=>{let C=d.getQueryParameter(t,d.QUERY_RESULT)/1e6;d.deleteQuery(t),this.fire(new n.A("gpu-timing-frame",{cpuTime:M,gpuTime:C}))},50)}if(this.listens("gpu-timing-layer")){let M=this.painter.collectGpuTimers();setTimeout(()=>{let C=this.painter.queryGpuTimers(M);this.fire(new n.A("gpu-timing-layer",{layerTimes:C}))},50)}if(this.listens("gpu-timing-deferred-render")){let M=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let C=this.painter.queryGpuTimeDeferredRender(M);this.fire(new n.A("gpu-timing-deferred-render",{gpuTime:C}))},50)}let b=this._sourcesDirty||this._styleDirty||this._placementDirty||_;if(b||this._repaint)this.triggerRepaint();else{let M=this.idle();if(M&&(_=this._updateAverageElevation(c,!0)),_)this.triggerRepaint();else if(this._triggerFrame(!1),M&&(this.fire(new n.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let C=this._calculateSpeedIndex();this.fire(new n.A("speedindexcompleted",{speedIndex:C})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||b||(this._fullyLoaded=!0,H.mark(V.fullLoad),this._performanceMetricsCollection&&Vr(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(let t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(let t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){let o=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&o(0);let c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){let d=this.transform.averageElevation,p=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(p)?p=0:this._averageElevationLastSampledAt=l;let _=Math.abs(d-p);if(_>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(p),o(p);this._averageElevation.easeTo(p,l,300)}else if(_>1e-4)return this._averageElevation.jumpTo(p),o(p)}return!!this._averageElevation.isEasing(l)&&o(this._averageElevation.getValue(l))}_authenticate(){Lr(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,l=>{if(l&&(l.message===Ni||l.status===401)){let t=this.painter.context.gl;Bs(t,!1),this._logoControl instanceof Jc&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new n.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),Ro(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Oi(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){let l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){let l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());let o=this.painter.context.gl,c=o.createFramebuffer();function d(p){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,p,0);let _=new Uint8Array(o.drawingBufferWidth*o.drawingBufferHeight*4);return o.readPixels(0,0,o.drawingBufferWidth,o.drawingBufferHeight,o.RGBA,o.UNSIGNED_BYTE,_),_}return o.bindFramebuffer(o.FRAMEBUFFER,c),this._canvasPixelComparison(d(l),t.canvasCopies.map(d),t.timeStamps)}_canvasPixelComparison(l,t,o){let c=o[1]-o[0],d=l.length/4;for(let p=0;p<t.length;p++){let _=t[p],x=0;for(let b=0;b<_.length;b+=4)_[b]===l[b]&&_[b+1]===l[b+1]&&_[b+2]===l[b+2]&&_[b+3]===l[b+3]&&(x+=1);c+=(o[p+2]-o[p+1])*(1-x/d)}return c}remove(){this._hash&&this._hash.remove();for(let t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Fs.delete(this.painter.context.gl),Nn.remove(),Po.remove(),this._removed=!0,this.fire(new n.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=n.q.frame(t=>{let o=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,o&&this._render(t)}))}_preloadTiles(l){let t=this.style?this.style.getSourceCaches():[];return n.bt(t,(o,c)=>o._preloadTiles(l,c),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this._tp.refreshUI(),l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,this._tp.refreshUI(),l&&this._update())}_setCacheLimits(l,t){n.eV(l,t)}get version(){return O}},NavigationControl:class{constructor(l={}){this.options=n.h({},Ol,l),this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(n.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),xe("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),xe("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(n.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{let o=this._map;o&&(this.options.visualizePitch?o.resetNorthPitch({},{originalEvent:t}):o.resetNorth({},{originalEvent:t}))}),this._compassIcon=xe("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let l=this._map;if(!l)return;let t=l.getZoom(),o=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=o,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",o.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){let l=this._map;if(!l)return;let t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5)}) rotateX(${l.transform.pitch}deg) rotateZ(${l.transform.angle*(180/Math.PI)}deg)`:`rotate(${l.transform.angle*(180/Math.PI)}deg)`;l._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Ls(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){let l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){let o=xe("button",l,this._container);return o.type="button",o.addEventListener("click",t),o}_setButtonTitle(l,t){if(!this._map)return;let o=this._map._getUIString(`NavigationControl.${t}`);l.setAttribute("aria-label",o),l.firstElementChild&&l.firstElementChild.setAttribute("title",o)}},GeolocateControl:class extends n.E{constructor(l={}){super();let t=navigator.geolocation;this.options=n.h({geolocation:t},jg,l),n.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ml(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){let t=(o=!!this.options.geolocation)=>{this._supportsGeolocation=o,l(o)};this._supportsGeolocation!==void 0?l(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(o=>t(o.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(l){let t=this._map.getMaxBounds(),o=l.coords;return!!t&&(o.longitude<t.getWest()||o.longitude>t.getEast()||o.latitude<t.getSouth()||o.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new n.A("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new n.A("geolocate",l)),this._finish()}}_updateCamera(l){let t=new n.ci(l.coords.longitude,l.coords.latitude),o=l.coords.accuracy,c=this._map.getBearing(),d=n.h({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(o),d,{geolocateSource:!0})}_updateMarker(l){if(l){let t=new n.ci(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let l=this._map.transform,t=n.cb(1,l._center.lat)*l.worldSize,o=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new n.A("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=xe("button","mapboxgl-ctrl-geolocate",this._container),xe("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",l===!1){n.w("Geolocation support is not available so the GeolocateControl will be disabled.");let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{let t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=xe("div","mapboxgl-user-location"),this._dotElement.appendChild(xe("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(xe("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new vo({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=xe("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new vo({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new n.A("trackuserlocationend")))})}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:l.absolute===!0&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return n.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new n.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new n.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new n.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&l()}).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Dl,ScaleControl:class{constructor(l={}){this.options=n.h({},Gg,l),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),n.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let l=this.options.maxWidth||100,t=this._map,o=t._containerHeight/2,c=t._containerWidth/2-l/2,d=t.unproject([c,o]),p=t.unproject([c+l,o]),_=d.distanceTo(p);if(this.options.unit==="imperial"){let x=3.2808*_;x>5280?this._setScale(l,x/5280,"mile"):this._setScale(l,x,"foot")}else this.options.unit==="nautical"?this._setScale(l,_/1852,"nautical-mile"):_>=1e3?this._setScale(l,_/1e3,"kilometer"):this._setScale(l,_,"meter")}_setScale(l,t,o){this._map._requestDomTask(()=>{let c=function(p){let _=Math.pow(10,`${Math.floor(p)}`.length-1),x=p/_;return x=x>=10?10:x>=5?5:x>=3?3:x>=2?2:x>=1?1:function(b){let M=Math.pow(10,Math.ceil(-Math.log(b)/Math.LN10));return Math.round(b*M)/M}(x),_*x}(t),d=c/t;this._container.innerHTML=this._isNumberFormatSupported&&o!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:o}).format(c):`${c}&nbsp;${qg[o]}`,this._container.style.width=l*d+"px"})}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:n.w("Full screen control 'container' must be a DOM element.")),n.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=xe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",n.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let l=this._fullscreenButton=xe("button","mapboxgl-ctrl-fullscreen",this._controlContainer);xe("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:bp,Popup:class extends n.E{constructor(l){super(),this.options=n.h(Object.create(Hg),l),this._altitude=this.options.altitude,n.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new n.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new n.A("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=n.ci.convert(l),this._pos=null,this._trackPointer=!1,this._update();let t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(l){return this._altitude=l,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){let t=document.createDocumentFragment(),o=document.createElement("body"),c;for(o.innerHTML=l;c=o.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=xe("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){let o=this._closeButton=xe("button","mapboxgl-popup-close-button",t);o.type="button",o.setAttribute("aria-label","Close popup"),o.innerHTML='<span aria-hidden="true">&#215;</span>',o.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;let t=this._map,o=this._container,c=this._pos;if(!t||!o||!c)return"bottom";let d=o.offsetWidth,p=o.offsetHeight,_=c.x<d/2,x=c.x>t.transform.width-d/2;if(c.y+l<p)return _?"top-left":x?"top-right":"top";if(c.y>t.transform.height-p){if(_)return"bottom-left";if(x)return"bottom-right"}return _?"left":x?"right":"bottom"}_updateClassList(){let l=this._container;if(!l)return;let t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){let t=this._map,o=this._content;if(!t||!this._lngLat&&!this._trackPointer||!o)return;let c=this._container;if(c||(c=this._container=xe("div","mapboxgl-popup",t.getContainer()),this._tip=xe("div","mapboxgl-popup-tip",c),c.appendChild(o)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=No(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){let d=this._pos=this._trackPointer&&l instanceof n.P?l:t.project(this._lngLat,this._altitude),p=Cn(this.options.offset),_=this._anchor=this._getAnchor(p.y),x=Cn(this.options.offset,_),b=d.add(x).round();t._requestDomTask(()=>{this._container&&_&&(this._container.style.transform=`${xo[_]} translate(${b.x}px,${b.y}px)`)})}if(!this._marker&&t._showingGlobe()){let d=n.eW(t.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let l=this._container.querySelector(Dm);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity=`${l}`),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:vo,Style:ko,LngLat:n.ci,LngLatBounds:n.aG,Point:n.P,MercatorCoordinate:n.ac,FreeCameraOptions:Bf,Evented:n.E,config:n.e,prewarm:n.e_,clearPrewarmedResources:n.eZ,get accessToken(){return n.e.ACCESS_TOKEN},set accessToken(l){n.e.ACCESS_TOKEN=l},get baseApiUrl(){return n.e.API_URL},set baseApiUrl(l){n.e.API_URL=l},get workerCount(){return n.f7.workerCount},set workerCount(l){n.f7.workerCount=l},get maxParallelImageRequests(){return n.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){n.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){n.f6(l)},get workerUrl(){return n.f5.workerUrl},set workerUrl(l){n.f5.workerUrl=l},get workerClass(){return n.f5.workerClass},set workerClass(l){n.f5.workerClass=l},get workerParams(){return n.f5.workerParams},set workerParams(l){n.f5.workerParams=l},get dracoUrl(){return n.f4()},set dracoUrl(l){n.f3(l)},get meshoptUrl(){return n.f2()},set meshoptUrl(l){n.f1(l)},setNow:n.q.setNow,restoreNow:n.q.restoreNow}});var I=v;return I})});var wh=cr((xD,i2)=>{i2.exports=pR;var dR=Object.prototype.hasOwnProperty;function pR(){for(var S={},m=0;m<arguments.length;m++){var v=arguments[m];for(var w in v)dR.call(v,w)&&(S[w]=v[w])}return S}});var o2=cr((r2,n2)=>{(function(){var S=this,m={};typeof r2<"u"?n2.exports=m:S.fuzzy=m,m.simpleFilter=function(v,w){return w.filter(function(I){return m.test(v,I)})},m.test=function(v,w){return m.match(v,w)!==null},m.match=function(v,w,I){I=I||{};var n=0,O=[],V=w.length,H=0,J=0,ae=I.pre||"",we=I.post||"",Ae=I.caseSensitive&&w||w.toLowerCase(),xe;v=I.caseSensitive&&v||v.toLowerCase();for(var Ge=0;Ge<V;Ge++)xe=w[Ge],Ae[Ge]===v[n]?(xe=ae+xe+we,n+=1,J+=1+J):J=0,H+=J,O[O.length]=xe;return n===v.length?(H=Ae===v?1/0:H,{rendered:O.join(""),score:H}):null},m.filter=function(v,w,I){return!w||w.length===0?[]:typeof v!="string"?w:(I=I||{},w.reduce(function(n,O,V,H){var J=O;I.extract&&(J=I.extract(O));var ae=m.match(v,J,I);return ae!=null&&(n[n.length]={string:ae.rendered,score:ae.score,index:V,original:O}),n},[]).sort(function(n,O){var V=O.score-n.score;return V||n.index-O.index}))}})()});var a2=cr((vD,s2)=>{"use strict";var $o=function(S){return this.component=S,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,S.el.parentNode.insertBefore(this.wrapper,S.el.nextSibling),this};$o.prototype.show=function(){this.element.style.display="block"};$o.prototype.hide=function(){this.element.style.display="none"};$o.prototype.add=function(S){this.items.push(S)};$o.prototype.clear=function(){this.items=[],this.active=0};$o.prototype.isEmpty=function(){return!this.items.length};$o.prototype.isVisible=function(){return this.element.style.display==="block"};$o.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var S=0;S<this.items.length;S++)this.drawItem(this.items[S],this.active===S);this.show()};$o.prototype.drawItem=function(S,m){var v=document.createElement("li"),w=document.createElement("a");m&&(v.className+=" active"),w.innerHTML=S.string,v.appendChild(w),this.element.appendChild(v),v.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),v.addEventListener("mouseup",function(){this.handleMouseUp.call(this,S)}.bind(this))};$o.prototype.handleMouseUp=function(S){this.selectingListItem=!1,this.component.value(S.original),this.clear(),this.draw()};$o.prototype.move=function(S){this.active=S,this.draw()};$o.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};$o.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};$o.prototype.drawError=function(S){var m=document.createElement("li");m.innerHTML=S,this.element.appendChild(m),this.show()};s2.exports=$o});var c2=cr((bD,l2)=>{"use strict";var fR=wh(),mR=o2(),_R=a2(),ao=function(S,m,v){return v=v||{},this.options=fR({minLength:2,limit:5,filter:!0,hideOnBlur:!0},v),this.el=S,this.data=m||[],this.list=new _R(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",function(w){this.handleKeyUp(w.keyCode)}.bind(this),!1),this.el.addEventListener("keydown",function(w){this.handleKeyDown(w)}.bind(this)),this.el.addEventListener("focus",function(){this.handleFocus()}.bind(this)),this.el.addEventListener("blur",function(){this.handleBlur()}.bind(this)),this.el.addEventListener("paste",function(w){this.handlePaste(w)}.bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};ao.prototype.handleKeyUp=function(S){S===40||S===38||S===27||S===13||S===9||this.handleInputChange(this.el.value)};ao.prototype.handleKeyDown=function(S){switch(S.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&S.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};ao.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};ao.prototype.handlePaste=function(S){if(S.clipboardData)this.handleInputChange(S.clipboardData.getData("Text"));else{var m=this;setTimeout(function(){m.handleInputChange(S.target.value)},100)}};ao.prototype.handleInputChange=function(S){if(this.query=this.normalize(S),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates(function(m){for(var v=0;v<m.length&&(this.list.add(m[v]),v!==this.options.limit-1);v++);this.list.draw()}.bind(this))};ao.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};ao.prototype.update=function(S){this.data=S,this.handleKeyUp()};ao.prototype.clear=function(){this.data=[],this.list.clear()};ao.prototype.normalize=function(S){return S=S.toLowerCase(),S};ao.prototype.match=function(S,m){return S.indexOf(m)>-1};ao.prototype.value=function(S){if(this.selected=S,this.el.value=this.getItemValue(S),document.createEvent){var m=document.createEvent("HTMLEvents");m.initEvent("change",!0,!1),this.el.dispatchEvent(m)}else this.el.fireEvent("onchange")};ao.prototype.getCandidates=function(S){var m={pre:"<strong>",post:"</strong>",extract:function(w){return this.getItemValue(w)}.bind(this)},v;this.options.filter?(v=mR.filter(this.query,this.data,m),v=v.map(function(w){return{original:w.original,string:this.render(w.original,w.string)}}.bind(this))):v=this.data.map(function(w){var I=this.render(w);return{original:w,string:I}}.bind(this)),S(v)};ao.prototype.getItemValue=function(S){return S};ao.prototype.render=function(S,m){if(m)return m;for(var v=S.original?this.getItemValue(S.original):this.getItemValue(S),w=this.normalize(v),I=w.lastIndexOf(this.query);I>-1;){var n=I+this.query.length;v=v.slice(0,I)+"<strong>"+v.slice(I,n)+"</strong>"+v.slice(n),I=w.slice(0,I).lastIndexOf(this.query)}return v};ao.prototype.renderError=function(S){this.list.drawError(S)};l2.exports=ao});var d2=cr((wD,u2)=>{"use strict";var h2=c2();u2.exports=h2;typeof window<"u"&&(window.Suggestions=h2)});var _2=cr((TD,m2)=>{var gR="Expected a function",p2=NaN,yR="[object Symbol]",xR=/^\s+|\s+$/g,vR=/^[-+]0x[0-9a-f]+$/i,bR=/^0b[01]+$/i,wR=/^0o[0-7]+$/i,TR=parseInt,SR=typeof global=="object"&&global&&global.Object===Object&&global,ER=typeof self=="object"&&self&&self.Object===Object&&self,IR=SR||ER||Function("return this")(),AR=Object.prototype,MR=AR.toString,CR=Math.max,PR=Math.min,dx=function(){return IR.Date.now()};function RR(S,m,v){var w,I,n,O,V,H,J=0,ae=!1,we=!1,Ae=!0;if(typeof S!="function")throw new TypeError(gR);m=f2(m)||0,px(v)&&(ae=!!v.leading,we="maxWait"in v,n=we?CR(f2(v.maxWait)||0,m):n,Ae="trailing"in v?!!v.trailing:Ae);function xe(Ct){var Ft=w,Wt=I;return w=I=void 0,J=Ct,O=S.apply(Wt,Ft),O}function Ge(Ct){return J=Ct,V=setTimeout(ft,m),ae?xe(Ct):O}function Te(Ct){var Ft=Ct-H,Wt=Ct-J,mt=m-Ft;return we?PR(mt,n-Wt):mt}function We(Ct){var Ft=Ct-H,Wt=Ct-J;return H===void 0||Ft>=m||Ft<0||we&&Wt>=n}function ft(){var Ct=dx();if(We(Ct))return _t(Ct);V=setTimeout(ft,Te(Ct))}function _t(Ct){return V=void 0,Ae&&w?xe(Ct):(w=I=void 0,O)}function Pt(){V!==void 0&&clearTimeout(V),J=0,w=H=I=V=void 0}function At(){return V===void 0?O:_t(dx())}function wt(){var Ct=dx(),Ft=We(Ct);if(w=arguments,I=this,H=Ct,Ft){if(V===void 0)return Ge(H);if(we)return V=setTimeout(ft,m),xe(H)}return V===void 0&&(V=setTimeout(ft,m)),O}return wt.cancel=Pt,wt.flush=At,wt}function px(S){var m=typeof S;return!!S&&(m=="object"||m=="function")}function LR(S){return!!S&&typeof S=="object"}function zR(S){return typeof S=="symbol"||LR(S)&&MR.call(S)==yR}function f2(S){if(typeof S=="number")return S;if(zR(S))return p2;if(px(S)){var m=typeof S.valueOf=="function"?S.valueOf():S;S=px(m)?m+"":m}if(typeof S!="string")return S===0?S:+S;S=S.replace(xR,"");var v=bR.test(S);return v||wR.test(S)?TR(S.slice(2),v?2:8):vR.test(S)?p2:+S}m2.exports=RR});var A2=cr((SD,fx)=>{"use strict";var rd=typeof Reflect=="object"?Reflect:null,g2=rd&&typeof rd.apply=="function"?rd.apply:function(m,v,w){return Function.prototype.apply.call(m,v,w)},tg;rd&&typeof rd.ownKeys=="function"?tg=rd.ownKeys:Object.getOwnPropertySymbols?tg=function(m){return Object.getOwnPropertyNames(m).concat(Object.getOwnPropertySymbols(m))}:tg=function(m){return Object.getOwnPropertyNames(m)};function DR(S){console&&console.warn&&console.warn(S)}var x2=Number.isNaN||function(m){return m!==m};function Nr(){Nr.init.call(this)}fx.exports=Nr;fx.exports.once=BR;Nr.EventEmitter=Nr;Nr.prototype._events=void 0;Nr.prototype._eventsCount=0;Nr.prototype._maxListeners=void 0;var y2=10;function ig(S){if(typeof S!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof S)}Object.defineProperty(Nr,"defaultMaxListeners",{enumerable:!0,get:function(){return y2},set:function(S){if(typeof S!="number"||S<0||x2(S))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+S+".");y2=S}});Nr.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};Nr.prototype.setMaxListeners=function(m){if(typeof m!="number"||m<0||x2(m))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+m+".");return this._maxListeners=m,this};function v2(S){return S._maxListeners===void 0?Nr.defaultMaxListeners:S._maxListeners}Nr.prototype.getMaxListeners=function(){return v2(this)};Nr.prototype.emit=function(m){for(var v=[],w=1;w<arguments.length;w++)v.push(arguments[w]);var I=m==="error",n=this._events;if(n!==void 0)I=I&&n.error===void 0;else if(!I)return!1;if(I){var O;if(v.length>0&&(O=v[0]),O instanceof Error)throw O;var V=new Error("Unhandled error."+(O?" ("+O.message+")":""));throw V.context=O,V}var H=n[m];if(H===void 0)return!1;if(typeof H=="function")g2(H,this,v);else for(var J=H.length,ae=E2(H,J),w=0;w<J;++w)g2(ae[w],this,v);return!0};function b2(S,m,v,w){var I,n,O;if(ig(v),n=S._events,n===void 0?(n=S._events=Object.create(null),S._eventsCount=0):(n.newListener!==void 0&&(S.emit("newListener",m,v.listener?v.listener:v),n=S._events),O=n[m]),O===void 0)O=n[m]=v,++S._eventsCount;else if(typeof O=="function"?O=n[m]=w?[v,O]:[O,v]:w?O.unshift(v):O.push(v),I=v2(S),I>0&&O.length>I&&!O.warned){O.warned=!0;var V=new Error("Possible EventEmitter memory leak detected. "+O.length+" "+String(m)+" listeners added. Use emitter.setMaxListeners() to increase limit");V.name="MaxListenersExceededWarning",V.emitter=S,V.type=m,V.count=O.length,DR(V)}return S}Nr.prototype.addListener=function(m,v){return b2(this,m,v,!1)};Nr.prototype.on=Nr.prototype.addListener;Nr.prototype.prependListener=function(m,v){return b2(this,m,v,!0)};function OR(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function w2(S,m,v){var w={fired:!1,wrapFn:void 0,target:S,type:m,listener:v},I=OR.bind(w);return I.listener=v,w.wrapFn=I,I}Nr.prototype.once=function(m,v){return ig(v),this.on(m,w2(this,m,v)),this};Nr.prototype.prependOnceListener=function(m,v){return ig(v),this.prependListener(m,w2(this,m,v)),this};Nr.prototype.removeListener=function(m,v){var w,I,n,O,V;if(ig(v),I=this._events,I===void 0)return this;if(w=I[m],w===void 0)return this;if(w===v||w.listener===v)--this._eventsCount===0?this._events=Object.create(null):(delete I[m],I.removeListener&&this.emit("removeListener",m,w.listener||v));else if(typeof w!="function"){for(n=-1,O=w.length-1;O>=0;O--)if(w[O]===v||w[O].listener===v){V=w[O].listener,n=O;break}if(n<0)return this;n===0?w.shift():kR(w,n),w.length===1&&(I[m]=w[0]),I.removeListener!==void 0&&this.emit("removeListener",m,V||v)}return this};Nr.prototype.off=Nr.prototype.removeListener;Nr.prototype.removeAllListeners=function(m){var v,w,I;if(w=this._events,w===void 0)return this;if(w.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):w[m]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete w[m]),this;if(arguments.length===0){var n=Object.keys(w),O;for(I=0;I<n.length;++I)O=n[I],O!=="removeListener"&&this.removeAllListeners(O);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(v=w[m],typeof v=="function")this.removeListener(m,v);else if(v!==void 0)for(I=v.length-1;I>=0;I--)this.removeListener(m,v[I]);return this};function T2(S,m,v){var w=S._events;if(w===void 0)return[];var I=w[m];return I===void 0?[]:typeof I=="function"?v?[I.listener||I]:[I]:v?FR(I):E2(I,I.length)}Nr.prototype.listeners=function(m){return T2(this,m,!0)};Nr.prototype.rawListeners=function(m){return T2(this,m,!1)};Nr.listenerCount=function(S,m){return typeof S.listenerCount=="function"?S.listenerCount(m):S2.call(S,m)};Nr.prototype.listenerCount=S2;function S2(S){var m=this._events;if(m!==void 0){var v=m[S];if(typeof v=="function")return 1;if(v!==void 0)return v.length}return 0}Nr.prototype.eventNames=function(){return this._eventsCount>0?tg(this._events):[]};function E2(S,m){for(var v=new Array(m),w=0;w<m;++w)v[w]=S[w];return v}function kR(S,m){for(;m+1<S.length;m++)S[m]=S[m+1];S.pop()}function FR(S){for(var m=new Array(S.length),v=0;v<m.length;++v)m[v]=S[v].listener||S[v];return m}function BR(S,m){return new Promise(function(v,w){function I(O){S.removeListener(m,n),w(O)}function n(){typeof S.removeListener=="function"&&S.removeListener("error",I),v([].slice.call(arguments))}I2(S,m,n,{once:!0}),m!=="error"&&NR(S,I,{once:!0})})}function NR(S,m,v){typeof S.on=="function"&&I2(S,"error",m,v)}function I2(S,m,v,w){if(typeof S.on=="function")w.once?S.once(m,v):S.on(m,v);else if(typeof S.addEventListener=="function")S.addEventListener(m,function I(n){w.once&&S.removeEventListener(m,I),v(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof S)}});var C2=cr((ED,M2)=>{M2.exports={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}}});var R2=cr((ID,P2)=>{"use strict";function VR(S){var m=S.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return m?{key:m[1],value:m[2]}:null}function UR(S){var m=S.match(/<?([^>]*)>(.*)/);if(!m)return null;var v=m[1],w=m[2].split(";"),I=null,n=w.reduce(function(O,V){var H=VR(V);return H?H.key==="rel"?(I||(I=H.value),O):(O[H.key]=H.value,O):O},{});return I?{url:v,rel:I,params:n}:null}function jR(S){return S?S.split(/,\s*</).reduce(function(m,v){var w=UR(v);if(!w)return m;var I=w.rel.split(/\s+/);return I.forEach(function(n){m[n]||(m[n]={url:w.url,params:w.params})}),m},{}):{}}P2.exports=jR});var z2=cr((AD,L2)=>{"use strict";var GR=R2();function mx(S,m){this.request=S,this.headers=m.headers,this.rawBody=m.body,this.statusCode=m.statusCode;try{this.body=JSON.parse(m.body||"{}")}catch{this.body=m.body}this.links=GR(this.headers.link)}mx.prototype.hasNextPage=function(){return!!this.links.next};mx.prototype.nextPage=function(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};L2.exports=mx});var Af=cr((MD,D2)=>{"use strict";D2.exports={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"}});var F2=cr((CD,k2)=>{"use strict";var O2=Af();function qR(S){var m=S.type||O2.ERROR_HTTP,v;if(S.body)try{v=JSON.parse(S.body)}catch{v=S.body}else v=null;var w=S.message||null;w||(typeof v=="string"?w=v:v&&typeof v.message=="string"?w=v.message:m===O2.ERROR_REQUEST_ABORTED&&(w="Request aborted")),this.message=w,this.type=m,this.statusCode=S.statusCode||null,this.request=S.request,this.body=v}k2.exports=qR});var N2=cr((PD,B2)=>{"use strict";function HR(S){var m=S.indexOf(":"),v=S.substring(0,m).trim().toLowerCase(),w=S.substring(m+1).trim();return{name:v,value:w}}function $R(S){var m={};return S&&S.trim().split(/[\r|\n]+/).forEach(function(v){var w=HR(v);m[w.name]=w.value}),m}B2.exports=$R});var H2=cr((RD,q2)=>{"use strict";var ZR=z2(),V2=F2(),_x=Af(),WR=N2(),rg={};function XR(S){var m=rg[S.id];m&&(m.abort(),delete rg[S.id])}function YR(S,m){return new ZR(S,{body:m.response,headers:WR(m.getAllResponseHeaders()),statusCode:m.status})}function U2(S){var m=S.total,v=S.loaded,w=100*v/m;return{total:m,transferred:v,percent:w}}function j2(S,m){return new Promise(function(v,w){m.onprogress=function(O){S.emitter.emit(_x.EVENT_PROGRESS_DOWNLOAD,U2(O))};var I=S.file;I&&(m.upload.onprogress=function(O){S.emitter.emit(_x.EVENT_PROGRESS_UPLOAD,U2(O))}),m.onerror=function(O){w(O)},m.onabort=function(){var O=new V2({request:S,type:_x.ERROR_REQUEST_ABORTED});w(O)},m.onload=function(){if(delete rg[S.id],m.status<200||m.status>=400){var O=new V2({request:S,body:m.response,statusCode:m.status});w(O);return}v(m)};var n=S.body;typeof n=="string"?m.send(n):n?m.send(JSON.stringify(n)):I?m.send(I):m.send(),rg[S.id]=m}).then(function(v){return YR(S,v)})}function G2(S,m){var v=S.url(m),w=new window.XMLHttpRequest;return w.open(S.method,v),Object.keys(S.headers).forEach(function(I){w.setRequestHeader(I,S.headers[I])}),w}function KR(S){return Promise.resolve().then(function(){var m=G2(S,S.client.accessToken);return j2(S,m)})}q2.exports={browserAbort:XR,sendRequestXhr:j2,browserSend:KR,createRequestXhr:G2}});var $2=cr((ng,Mf)=>{(function(S){var m=typeof ng=="object"&&ng,v=typeof Mf=="object"&&Mf&&Mf.exports==m&&Mf,w=typeof global=="object"&&global;(w.global===w||w.window===w)&&(S=w);var I=function(Ae){this.message=Ae};I.prototype=new Error,I.prototype.name="InvalidCharacterError";var n=function(Ae){throw new I(Ae)},O="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",V=/[\t\n\f\r ]/g,H=function(Ae){Ae=String(Ae).replace(V,"");var xe=Ae.length;xe%4==0&&(Ae=Ae.replace(/==?$/,""),xe=Ae.length),(xe%4==1||/[^+a-zA-Z0-9/]/.test(Ae))&&n("Invalid character: the string to be decoded is not correctly encoded.");for(var Ge=0,Te,We,ft="",_t=-1;++_t<xe;)We=O.indexOf(Ae.charAt(_t)),Te=Ge%4?Te*64+We:We,Ge++%4&&(ft+=String.fromCharCode(255&Te>>(-2*Ge&6)));return ft},J=function(Ae){Ae=String(Ae),/[^\0-\xFF]/.test(Ae)&&n("The string to be encoded contains characters outside of the Latin1 range.");for(var xe=Ae.length%3,Ge="",Te=-1,We,ft,_t,Pt,At,wt=Ae.length-xe;++Te<wt;)We=Ae.charCodeAt(Te)<<16,ft=Ae.charCodeAt(++Te)<<8,_t=Ae.charCodeAt(++Te),At=We+ft+_t,Ge+=O.charAt(At>>18&63)+O.charAt(At>>12&63)+O.charAt(At>>6&63)+O.charAt(At&63);return xe==2?(We=Ae.charCodeAt(Te)<<8,ft=Ae.charCodeAt(++Te),At=We+ft,Ge+=O.charAt(At>>10)+O.charAt(At>>4&63)+O.charAt(At<<2&63)+"="):xe==1&&(At=Ae.charCodeAt(Te),Ge+=O.charAt(At>>2)+O.charAt(At<<4&63)+"=="),Ge},ae={encode:J,decode:H,version:"0.1.0"};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd)define(function(){return ae});else if(m&&!m.nodeType)if(v)v.exports=ae;else for(var we in ae)ae.hasOwnProperty(we)&&(m[we]=ae[we]);else S.base64=ae})(ng)});var yx=cr((LD,Z2)=>{"use strict";var JR=$2(),gx={};function QR(S){if(gx[S])return gx[S];var m=S.split("."),v=m[0],w=m[1];if(!w)throw new Error("Invalid token");var I=eL(w),n={usage:v,user:I.u};return Th(I,"a")&&(n.authorization=I.a),Th(I,"exp")&&(n.expires=I.exp*1e3),Th(I,"iat")&&(n.created=I.iat*1e3),Th(I,"scopes")&&(n.scopes=I.scopes),Th(I,"client")&&(n.client=I.client),Th(I,"ll")&&(n.lastLogin=I.ll),Th(I,"iu")&&(n.impersonator=I.iu),gx[S]=n,n}function eL(S){try{return JSON.parse(JR.decode(S))}catch{throw new Error("Invalid token")}}function Th(S,m){return Object.prototype.hasOwnProperty.call(S,m)}Z2.exports=QR});var X2=cr((zD,xx)=>{"use strict";var tL=Object.prototype.hasOwnProperty,Co="~";function Cf(){}Object.create&&(Cf.prototype=Object.create(null),new Cf().__proto__||(Co=!1));function iL(S,m,v){this.fn=S,this.context=m,this.once=v||!1}function W2(S,m,v,w,I){if(typeof v!="function")throw new TypeError("The listener must be a function");var n=new iL(v,w||S,I),O=Co?Co+m:m;return S._events[O]?S._events[O].fn?S._events[O]=[S._events[O],n]:S._events[O].push(n):(S._events[O]=n,S._eventsCount++),S}function og(S,m){--S._eventsCount===0?S._events=new Cf:delete S._events[m]}function lo(){this._events=new Cf,this._eventsCount=0}lo.prototype.eventNames=function(){var m=[],v,w;if(this._eventsCount===0)return m;for(w in v=this._events)tL.call(v,w)&&m.push(Co?w.slice(1):w);return Object.getOwnPropertySymbols?m.concat(Object.getOwnPropertySymbols(v)):m};lo.prototype.listeners=function(m){var v=Co?Co+m:m,w=this._events[v];if(!w)return[];if(w.fn)return[w.fn];for(var I=0,n=w.length,O=new Array(n);I<n;I++)O[I]=w[I].fn;return O};lo.prototype.listenerCount=function(m){var v=Co?Co+m:m,w=this._events[v];return w?w.fn?1:w.length:0};lo.prototype.emit=function(m,v,w,I,n,O){var V=Co?Co+m:m;if(!this._events[V])return!1;var H=this._events[V],J=arguments.length,ae,we;if(H.fn){switch(H.once&&this.removeListener(m,H.fn,void 0,!0),J){case 1:return H.fn.call(H.context),!0;case 2:return H.fn.call(H.context,v),!0;case 3:return H.fn.call(H.context,v,w),!0;case 4:return H.fn.call(H.context,v,w,I),!0;case 5:return H.fn.call(H.context,v,w,I,n),!0;case 6:return H.fn.call(H.context,v,w,I,n,O),!0}for(we=1,ae=new Array(J-1);we<J;we++)ae[we-1]=arguments[we];H.fn.apply(H.context,ae)}else{var Ae=H.length,xe;for(we=0;we<Ae;we++)switch(H[we].once&&this.removeListener(m,H[we].fn,void 0,!0),J){case 1:H[we].fn.call(H[we].context);break;case 2:H[we].fn.call(H[we].context,v);break;case 3:H[we].fn.call(H[we].context,v,w);break;case 4:H[we].fn.call(H[we].context,v,w,I);break;default:if(!ae)for(xe=1,ae=new Array(J-1);xe<J;xe++)ae[xe-1]=arguments[xe];H[we].fn.apply(H[we].context,ae)}}return!0};lo.prototype.on=function(m,v,w){return W2(this,m,v,w,!1)};lo.prototype.once=function(m,v,w){return W2(this,m,v,w,!0)};lo.prototype.removeListener=function(m,v,w,I){var n=Co?Co+m:m;if(!this._events[n])return this;if(!v)return og(this,n),this;var O=this._events[n];if(O.fn)O.fn===v&&(!I||O.once)&&(!w||O.context===w)&&og(this,n);else{for(var V=0,H=[],J=O.length;V<J;V++)(O[V].fn!==v||I&&!O[V].once||w&&O[V].context!==w)&&H.push(O[V]);H.length?this._events[n]=H.length===1?H[0]:H:og(this,n)}return this};lo.prototype.removeAllListeners=function(m){var v;return m?(v=Co?Co+m:m,this._events[v]&&og(this,v)):(this._events=new Cf,this._eventsCount=0),this};lo.prototype.off=lo.prototype.removeListener;lo.prototype.addListener=lo.prototype.on;lo.prefixed=Co;lo.EventEmitter=lo;typeof xx<"u"&&(xx.exports=lo)});var Q2=cr((DD,J2)=>{"use strict";function rL(S){return S.map(encodeURIComponent).join(",")}function Y2(S){return Array.isArray(S)?rL(S):encodeURIComponent(String(S))}function K2(S,m,v){if(v===!1||v===null)return S;var w=/\?/.test(S)?"&":"?",I=encodeURIComponent(m);return v!==void 0&&v!==""&&v!==!0&&(I+="="+Y2(v)),""+S+w+I}function nL(S,m){if(!m)return S;var v=S;return Object.keys(m).forEach(function(w){var I=m[w];I!==void 0&&(Array.isArray(I)&&(I=I.filter(function(n){return n!=null}).join(",")),v=K2(v,w,I))}),v}function oL(S,m){if(!m||S.slice(0,4)==="http")return S;var v=S[0]==="/"?"":"/";return""+m.replace(/\/$/,"")+v+S}function sL(S,m){return m?S.replace(/\/:([a-zA-Z0-9]+)/g,function(v,w){var I=m[w];if(I===void 0)throw new Error("Unspecified route parameter "+w);var n=Y2(I);return"/"+n}):S}J2.exports={appendQueryObject:nL,appendQueryParam:K2,prependOrigin:oL,interpolateRouteParams:sL}});var iS=cr((OD,tS)=>{"use strict";var aL=yx(),vx=wh(),lL=X2(),sg=Q2(),eS=Af(),cL=1;function ic(S,m){if(!S)throw new Error("MapiRequest requires a client");if(!m||!m.path||!m.method)throw new Error("MapiRequest requires an options object with path and method properties");var v={};m.body&&(v["content-type"]="application/json");var w=vx(v,m.headers),I=Object.keys(w).reduce(function(n,O){return n[O.toLowerCase()]=w[O],n},{});this.id=cL++,this._options=m,this.emitter=new lL,this.client=S,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=m.path,this.method=m.method,this.origin=m.origin||S.origin,this.query=m.query||{},this.params=m.params||{},this.body=m.body||null,this.file=m.file||null,this.encoding=m.encoding||"utf8",this.sendFileAs=m.sendFileAs||null,this.headers=I}ic.prototype.url=function(m){var v=sg.prependOrigin(this.path,this.origin);v=sg.appendQueryObject(v,this.query);var w=this.params,I=m??this.client.accessToken;if(I){v=sg.appendQueryParam(v,"access_token",I);var n=aL(I).user;w=vx({ownerId:n},w)}return v=sg.interpolateRouteParams(v,w),v};ic.prototype.send=function(){var m=this;if(m.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return m.sent=!0,m.client.sendRequest(m).then(function(v){return m.response=v,m.emitter.emit(eS.EVENT_RESPONSE,v),v},function(v){throw m.error=v,m.emitter.emit(eS.EVENT_ERROR,v),v})};ic.prototype.abort=function(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};ic.prototype.eachPage=function(m){var v=this;function w(O){function V(){delete v._nextPageRequest;var H=O.nextPage();H&&(v._nextPageRequest=H,n(H))}m(null,O,V)}function I(O){m(O,null,function(){})}function n(O){O.send().then(w,I)}n(this)};ic.prototype.clone=function(){return this._extend()};ic.prototype._extend=function(m){var v=vx(this._options,m);return new ic(this.client,v)};tS.exports=ic});var bx=cr((kD,nS)=>{"use strict";var hL=yx(),uL=iS(),dL=Af();function rS(S){if(!S||!S.accessToken)throw new Error("Cannot create a client without an access token");hL(S.accessToken),this.accessToken=S.accessToken,this.origin=S.origin||dL.API_ORIGIN}rS.prototype.createRequest=function(m){return new uL(this,m)};nS.exports=rS});var wx=cr((FD,aS)=>{"use strict";var oS=H2(),sS=bx();function nd(S){sS.call(this,S)}nd.prototype=Object.create(sS.prototype);nd.prototype.constructor=nd;nd.prototype.sendRequest=oS.browserSend;nd.prototype.abortRequest=oS.browserAbort;function pL(S){return new nd(S)}aS.exports=pL});var cS=cr((BD,lS)=>{"use strict";var fL=wx();lS.exports=fL});var uS=cr((ND,hS)=>{"use strict";var mL=Object.prototype.toString;hS.exports=function(S){var m;return mL.call(S)==="[object Object]"&&(m=Object.getPrototypeOf(S),m===null||m===Object.getPrototypeOf({}))}});var gS=cr((VD,_S)=>{"use strict";var _L=uS(),gL=wh(),dS="value",Tx=`
  `,Jr={};Jr.assert=function(S,m){return m=m||{},function(v){var w=rc(S,v);if(w){var I=Sx(w,m);throw m.apiName&&(I=m.apiName+": "+I),new Error(I)}}};Jr.shape=function(m){var v=bL(m);return function(I){var n=rc(Jr.plainObject,I);if(n)return n;for(var O,V,H=[],J=0;J<v.length;J++)O=v[J].key,V=v[J].value,n=rc(V,I[O]),n&&H.push([O].concat(n));return H.length<2?H[0]:function(ae){H=H.map(function(xe){var Ge=xe[0],Te=Sx(xe,ae).split(`
`).join(Tx);return"- "+Ge+": "+Te});var we=ae.path.join("."),Ae=we===dS?"":" of "+we;return"The following properties"+Ae+" have invalid values:"+Tx+H.join(Tx)}}};Jr.strictShape=function(m){var v=Jr.shape(m);return function(I){var n=v(I);if(n)return n;var O=Object.keys(I).reduce(function(V,H){return m[H]===void 0&&V.push(H),V},[]);if(O.length!==0)return function(){return"The following keys are invalid: "+O.join(", ")}}};Jr.arrayOf=function(m){return pS(m)};Jr.tuple=function(){var m=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return pS(m)};function pS(S){var m=Array.isArray(S),v=function(w){return m?S[w]:S};return function(I){var n=rc(Jr.plainArray,I);if(n)return n;if(m&&I.length!==S.length)return"an array with "+S.length+" items";for(var O=0;O<I.length;O++)if(n=rc(v(O),I[O]),n)return[O].concat(n)}}Jr.required=function(m){function v(w){return w==null?function(I){return fS(I,mS(I.path)?"cannot be undefined/null.":"is required.")}:m.apply(this,arguments)}return v.__required=!0,v};Jr.oneOfType=function(){var m=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(w){var I=m.map(function(n){return rc(n,w)}).filter(Boolean);if(I.length===m.length)return I.every(function(n){return n.length===1&&typeof n[0]=="string"})?yL(I.map(function(n){return n[0]})):I.reduce(function(n,O){return O.length>n.length?O:n})}};Jr.equal=function(m){return function(w){if(w!==m)return JSON.stringify(m)}};Jr.oneOf=function(){var m=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),v=m.map(function(w){return Jr.equal(w)});return Jr.oneOfType.apply(this,v)};Jr.range=function(m){var v=m[0],w=m[1];return function(n){var O=rc(Jr.number,n);if(O||n<v||n>w)return"number between "+v+" & "+w+" (inclusive)"}};Jr.any=function(){};Jr.boolean=function(m){if(typeof m!="boolean")return"boolean"};Jr.number=function(m){if(typeof m!="number")return"number"};Jr.plainArray=function(m){if(!Array.isArray(m))return"array"};Jr.plainObject=function(m){if(!_L(m))return"object"};Jr.string=function(m){if(typeof m!="string")return"string"};Jr.func=function(m){if(typeof m!="function")return"function"};function rc(S,m){if(!(m==null&&!S.hasOwnProperty("__required"))){var v=S(m);if(v)return Array.isArray(v)?v:[v]}}function Sx(S,m){var v=S.length,w=S[v-1],I=S.slice(0,v-1);return I.length===0&&(I=[dS]),m=gL(m,{path:I}),typeof w=="function"?w(m):fS(m,xL(w))}function yL(S){return S.length<2?S[0]:S.length===2?S.join(" or "):S.slice(0,-1).join(", ")+", or "+S.slice(-1)}function xL(S){return"must be "+vL(S)+"."}function vL(S){return/^an? /.test(S)?S:/^[aeiou]/i.test(S)?"an "+S:/^[a-z]/i.test(S)?"a "+S:S}function fS(S,m){var v=mS(S.path),w=S.path.join(".")+" "+m,I=v?"Item at position ":"";return I+w}function mS(S){return typeof S[S.length-1]=="number"||typeof S[0]=="number"}function bL(S){return Object.keys(S||{}).map(function(m){return{key:m,value:S[m]}})}Jr.validate=rc;Jr.processMessage=Sx;_S.exports=Jr});var xS=cr((UD,yS)=>{"use strict";var wL=wh(),od=gS();function TL(S){if(typeof window<"u")return S instanceof global.Blob||S instanceof global.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof S=="string"||S.pipe!==void 0))return"Filename or Readable stream"}function SL(S,m){return od.assert(od.strictShape(S),m)}function EL(S){var m="date";if(typeof S=="boolean")return m;try{var v=new Date(S);if(v.getTime&&isNaN(v.getTime()))return m}catch{return m}}function IL(S){return od.tuple(od.number,od.number)(S)}yS.exports=wL(od,{file:TL,date:EL,coordinates:IL,assertShape:SL})});var bS=cr((jD,vS)=>{"use strict";function AL(S,m){var v=function(w,I){return m.indexOf(w)!==-1&&I!==void 0};return typeof m=="function"&&(v=m),Object.keys(S).filter(function(w){return v(w,S[w])}).reduce(function(w,I){return w[I]=S[I],w},{})}vS.exports=AL});var TS=cr((GD,wS)=>{"use strict";function ML(S,m){return Object.keys(S).reduce(function(v,w){return v[w]=m(w,S[w]),v},{})}wS.exports=ML});var ES=cr((qD,SS)=>{"use strict";var CL=TS();function PL(S){return CL(S,function(m,v){return typeof v=="boolean"?JSON.stringify(v):v})}SS.exports=PL});var AS=cr((HD,IS)=>{"use strict";var RL=bx(),LL=wx();function zL(S){return function(m){var v;RL.prototype.isPrototypeOf(m)?v=m:v=LL(m);var w=Object.create(S);return w.client=v,w}}IS.exports=zL});var LS=cr(($D,RS)=>{"use strict";var MS=wh(),dr=xS(),ag=bS(),CS=ES(),DL=AS(),Ex={},PS=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Ex.forwardGeocode=function(S){dr.assertShape({query:dr.required(dr.string),mode:dr.oneOf("mapbox.places","mapbox.places-permanent"),countries:dr.arrayOf(dr.string),proximity:dr.oneOf(dr.coordinates,"ip"),types:dr.arrayOf(dr.oneOf(PS)),autocomplete:dr.boolean,bbox:dr.arrayOf(dr.number),limit:dr.number,language:dr.arrayOf(dr.string),routing:dr.boolean,fuzzyMatch:dr.boolean,worldview:dr.string,session_token:dr.string})(S),S.mode=S.mode||"mapbox.places";var m=CS(MS({country:S.countries},ag(S,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:ag(S,["mode","query"]),query:m})};Ex.reverseGeocode=function(S){dr.assertShape({query:dr.required(dr.coordinates),mode:dr.oneOf("mapbox.places","mapbox.places-permanent"),countries:dr.arrayOf(dr.string),types:dr.arrayOf(dr.oneOf(PS)),bbox:dr.arrayOf(dr.number),limit:dr.number,language:dr.arrayOf(dr.string),reverseMode:dr.oneOf("distance","score"),routing:dr.boolean,worldview:dr.string,session_token:dr.string})(S),S.mode=S.mode||"mapbox.places";var m=CS(MS({country:S.countries},ag(S,["country","types","bbox","limit","language","reverseMode","routing","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:ag(S,["mode","query"]),query:m})};RS.exports=DL(Ex)});var zS,DS=Sw(()=>{zS="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"});var FS={};oC(FS,{customAlphabet:()=>OL,customRandom:()=>kS,nanoid:()=>kL,random:()=>OS,urlAlphabet:()=>zS});var OS,kS,OL,kL,BS=Sw(()=>{DS();OS=S=>crypto.getRandomValues(new Uint8Array(S)),kS=(S,m,v)=>{let w=(2<<Math.log(S.length-1)/Math.LN2)-1,I=-~(1.6*w*m/S.length);return(n=m)=>{let O="";for(;;){let V=v(I),H=I|0;for(;H--;)if(O+=S[V[H]&w]||"",O.length===n)return O}}},OL=(S,m=21)=>kS(S,m,OS),kL=(S=21)=>crypto.getRandomValues(new Uint8Array(S)).reduce((m,v)=>(v&=63,v<36?m+=v.toString(36):v<62?m+=(v-26).toString(36).toUpperCase():v>62?m+="-":m+="_",m),"")});var US=cr((XD,VS)=>{"use strict";var FL=(BS(),sC(FS)).nanoid;function NS(S){this.origin=S.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=S.accessToken,this.version="0.3.0",this.pluginSessionID=this.generateSessionID(),this.sessionIncrementer=0,this.userAgent=this.getUserAgent(),this.options=S,this.send=this.send.bind(this),this.countries=S.countries?S.countries.split(","):null,this.types=S.types?S.types.split(","):null,this.bbox=S.bbox?S.bbox:null,this.language=S.language?S.language.split(","):null,this.limit=S.limit?+S.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(S),this.eventQueue=new Array,this.flushInterval=S.flushInterval||1e3,this.maxQueueSize=S.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}NS.prototype={select:function(S,m){var v=this.getEventPayload("search.select",m,{selectedFeature:S});if(v&&!(v.resultIndex===this.lastSentIndex&&v.queryString===this.lastSentInput||v.resultIndex==-1))return this.lastSentIndex=v.resultIndex,this.lastSentInput=v.queryString,this.push(v)},start:function(S){var m=this.getEventPayload("search.start",S);if(m)return this.push(m)},keyevent:function(S,m){if(S.key&&!(S.metaKey||[9,27,37,39,13,38,40].indexOf(S.keyCode)!==-1)){var v=this.getEventPayload("search.keystroke",m,{key:S.key});if(v)return this.push(v)}},send:function(S,m){if(!this.enableEventLogging)return m?m():void 0;var v=this.getRequestOptions(S);this.request(v,function(w){if(w)return this.handleError(w,m);if(m)return m()}.bind(this))},getRequestOptions:function(S){Array.isArray(S)||(S=[S]);var m={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(S)};return m},getEventPayload:function(S,m,v={}){if(S==="search.select"&&!v.selectedFeature||S==="search.keystroke"&&!v.key)return null;var w;if(!m.options.proximity)w=null;else if(typeof m.options.proximity=="object")w=[m.options.proximity.longitude,m.options.proximity.latitude];else if(m.options.proximity==="ip"){var I=m._headers?m._headers["ip-proximity"]:null;I&&typeof I=="string"?w=I.split(",").map(parseFloat):w=[999,999]}else w=m.options.proximity;var n=m._map?m._map.getZoom():void 0,O={event:S,version:this.getEventSchemaVersion(S),created:+new Date,sessionIdentifier:this.getSessionId(),country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:m.options.autocomplete,fuzzyMatch:m.options.fuzzyMatch,proximity:w,limit:m.options.limit,routing:m.options.routing,worldview:m.options.worldview,mapZoom:n,keyboardLocale:this.locale};if(S==="search.select"?O.queryString=m.inputString:S!="search.select"&&m._inputEl?O.queryString=m._inputEl.value:O.queryString=m.inputString,["search.keystroke","search.select"].includes(S)&&(O.path="geocoding/v5/mapbox.places"),S==="search.keystroke"&&v.key)O.lastAction=v.key;else if(S==="search.select"&&v.selectedFeature){var V=v.selectedFeature,H=this.getSelectedIndex(V,m);if(O.resultIndex=H,O.resultPlaceName=V.place_name,O.resultId=V.id,V.properties&&(O.resultMapboxId=V.properties.mapbox_id),m._typeahead){var J=m._typeahead.data;J&&J.length>0&&(O.suggestionIds=this.getSuggestionIds(J),O.suggestionNames=this.getSuggestionNames(J),O.suggestionTypes=this.getSuggestionTypes(J),O.suggestionSources=this.getSuggestionSources(J))}}return this.validatePayload(O)?O:null},request:function(S,m){var v=new XMLHttpRequest;v.onreadystatechange=function(){if(this.readyState==4)return this.status==204?m(null):m(this.statusText)},v.open(S.method,S.host+"/"+S.path,!0);for(var w in S.headers){var I=S.headers[w];v.setRequestHeader(w,I)}v.send(S.body)},handleError:function(S,m){if(m)return m(S)},generateSessionID:function(){return FL()},getSessionId:function(){return this.pluginSessionID+"."+this.sessionIncrementer},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(S,m){if(m._typeahead){var v=m._typeahead.data,w=S.id,I=v.map(function(O){return O.id}),n=I.indexOf(w);return n}},getSuggestionIds:function(S){return S.map(function(m){return m.properties?m.properties.mapbox_id||"":m.id||""})},getSuggestionNames:function(S){return S.map(function(m){return m.place_name||""})},getSuggestionTypes:function(S){return S.map(function(m){return m.place_type&&Array.isArray(m.place_type)&&m.place_type[0]||""})},getSuggestionSources:function(S){return S.map(function(m){return m._source||""})},getEventSchemaVersion:function(S){return["search.keystroke","search.select"].includes(S)?"2.2":"2.0"},validatePayload:function(S){if(!S||!S.event)return!1;var m=["event","created","sessionIdentifier","queryString"],v=["event","created","sessionIdentifier","queryString","lastAction"],w=["event","created","sessionIdentifier","queryString","resultIndex","path","suggestionIds"],I=S.event;return I==="search.start"?this.objectHasRequiredProps(S,m):I==="search.keystroke"?this.objectHasRequiredProps(S,v):I==="search.select"?this.objectHasRequiredProps(S,w):!0},objectHasRequiredProps:function(S,m){return m.every(function(v){return v==="queryString"?typeof S[v]=="string"&&S[v].length>0:S[v]!==void 0})},shouldEnableLogging:function(S){return!(S.enableEventLogging===!1||S.origin&&S.origin!=="https://api.mapbox.com")},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(S,m){this.eventQueue.push(S),(this.eventQueue.length>=this.maxQueueSize||m)&&this.flush()},remove:function(){this.flush()}};VS.exports=NS});var GS=cr((YD,jS)=>{"use strict";var BL={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"\u05DC\u05D7\u05E4\u05E9",ja:"\u30B5\u30FC\u30C1",lv:"Mekl\u0113t",pt:"Procurar",sr:"\u041F\u0440\u0435\u0442\u0440\u0430\u0433\u0430",zh:"\u641C\u7D22",cs:"Vyhled\xE1v\xE1n\xED",hu:"Keres\xE9s",ka:"\u10EB\u10D8\u10D4\u10D1\u10D0",nb:"S\xF8ke",sk:"Vyh\u013Ead\xE1vanie",th:"\u0E04\u0E49\u0E19\u0E2B\u0E32",fi:"Hae",is:"Leita",ko:"\uC218\uC0C9",pl:"Szukaj",sl:"Iskanje",fa:"\u062C\u0633\u062A\u062C\u0648",ru:"\u041F\u043E\u0438\u0441\u043A"};jS.exports={placeholder:BL}});var HS=cr((qS,lg)=>{(function(S,m,v){typeof lg<"u"&&lg.exports?lg.exports=v():S[m]=v()})(qS,"subtag",function(){var S="",m=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function v(V){return V.match(m)||[]}function w(V){return v(V).filter(function(H,J){return H&&J})}function I(V){return V=v(V),{language:V[1]||S,extlang:V[2]||S,script:V[3]||S,region:V[4]||S}}function n(V,H,J){Object.defineProperty(V,H,{value:J,enumerable:!0})}function O(V,H,J){function ae(we){return v(we)[V]||S}n(ae,"pattern",H),n(I,J,ae)}return O(1,/^[a-zA-Z]{2,3}$/,"language"),O(2,/^[a-zA-Z]{3}$/,"extlang"),O(3,/^[a-zA-Z]{4}$/,"script"),O(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),n(I,"split",w),I})});var WS=cr((KD,ZS)=>{function $S(){}$S.prototype={isSupport:function(){return!!window.navigator.geolocation},getCurrentPosition:function(){let S={enableHighAccuracy:!0};return new Promise(function(m,v){window.navigator.geolocation.getCurrentPosition(m,v,S)})}};ZS.exports=$S});var KS=cr((JD,YS)=>{function NL(S,m){let v=XS(S),w=["address","street","place","country"];var I;if(typeof m=="function")return m(v);let n=w.indexOf(m);return n===-1?I=w:I=w.slice(n),I.reduce(function(O,V){return v[V]?(O!==""&&(O=O+", "),O+v[V]):O},"")}function XS(S){let m=S.address||"",v=S.text||"",w=S.place_name||"",n={address:w.split(",")[0],houseNumber:m,street:v,placeName:w};return S.context.forEach(function(O){let V=O.id.split(".")[0];n[V]=O.text}),n}var VL=/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/;YS.exports={transformFeatureToGeolocationText:NL,getAddressInfo:XS,REVERSE_GEOCODE_COORD_RGX:VL}});var iE=cr((QD,tE)=>{"use strict";var UL=d2(),jL=_2(),Sh=wh(),GL=A2().EventEmitter,JS=C2(),Ix=cS(),Ax=LS(),qL=US(),HL=GS(),$L=HS(),ZL=WS(),QS=KS(),nc={FORWARD:0,LOCAL:1,REVERSE:2};function WL(){var S=document.createElement("div");return S.className="mapboxgl-ctrl-geocoder--powered-by",S.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',S}function eE(S){this._eventEmitter=new GL,this.options=Sh({},this.options,S),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new ZL}function XL(S){return S?String(S).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}eE.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",useBrowserFocus:!1,getItemValue:function(S){return S.place_name},render:function(S){var m=XL(S.place_name).split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+m[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+m.splice(1,m.length).join(",")+"</div></div>"}},_headers:{},addTo:function(S){function m(v,w){if(!document.body.contains(w))throw new Error("Element provided to #addTo() exists, but is not in the DOM");let I=v.onAdd();w.appendChild(I)}if(S._controlContainer)S.addControl(this);else if(S instanceof HTMLElement)m(this,S);else if(typeof S=="string"){let v=document.querySelectorAll(S);if(v.length===0)throw new Error("Element ",S,"not found.");if(v.length>1)throw new Error("Geocoder can only be added to a single html element");m(this,v[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(S){if(S&&typeof S!="string"&&(this._map=S),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=Ax(Ix({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new qL(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this),this._onSuggestionItemFocus=this._onSuggestionItemFocus.bind(this),this._onSuggestionItemKeyDown=this._onSuggestionItemKeydown.bind(this);var m=this.container=document.createElement("div");m.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var v=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",jL(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",function(Ae){this.eventManager.keyevent(Ae,this)}.bind(this));var w=document.createElement("div");w.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var I=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(I),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),w.appendChild(this._clearEl),w.appendChild(this._loadingEl),m.appendChild(v),m.appendChild(this._inputEl),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var n=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(n),w.appendChild(this._geolocateEl),this._showGeolocateButton()}var O=this._typeahead=new UL(this._inputEl,[],{hideOnBlur:!this.options.useBrowserFocus,filter:!1,minLength:this.options.minLength,limit:this.options.limit});m.insertBefore(w,O.list.wrapper),this.setRenderFunction(this.options.render),O.getItemValue=this.options.getItemValue;let V=this._typeahead.handleKeyDown.bind(this._typeahead),H=this._typeahead.handleKeyUp.bind(this._typeahead);this._typeahead.handleKeyUp,this.options.useBrowserFocus&&(this._typeahead.handleKeyDown=function(Ae){if(!(Ae.keyCode===9&&!O.list.isEmpty())){if(Ae.keyCode===40){this._typeahead.list.active=0,this._typeahead.list.element.querySelectorAll("li").forEach(function(xe){xe.classList.remove("active")}),this._typeahead.list.element.querySelectorAll("li")[0].classList.add("active"),this._typeahead.list.element.querySelectorAll("li")[0].focus();return}else if(Ae.keyCode===38){this._typeahead.list.active=O.list.items.length-1,this._typeahead.list.element.querySelectorAll("li").forEach(function(xe){xe.classList.remove("active")}),this._typeahead.list.element.querySelectorAll("li")[this._typeahead.list.active].classList.add("active"),this._typeahead.list.element.querySelectorAll("li")[this._typeahead.list.active].focus();return}V(Ae)}}.bind(this),this._typeahead.handleKeyUp=function(Ae){if(Ae&&Ae.keyCode===16){Ae.preventDefault();return}H(Ae)});var J=O.list.draw,ae=this._footerNode=WL(),we=this;return O.list.draw=function(){we.options.useBrowserFocus&&O.list.element.querySelectorAll("li").forEach(function(Ae){Ae.removeEventListener("focus",we._onSuggestionItemFocus),Ae.removeEventListener("keydown",we._onSuggestionItemKeyDown)}),J.call(this),we.options.useBrowserFocus&&O.list.element.querySelectorAll("li").forEach(function(Ae,xe){xe===0&&Ae.focus(),Ae.setAttribute("data-index",xe),Ae.tabIndex=0,Ae.addEventListener("focus",this._onSuggestionItemFocus),Ae.addEventListener("keydown",this._onSuggestionItemKeyDown)}.bind(we)),ae.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),ae.addEventListener("mouseup",function(){this.selectingListItem=!1}.bind(this)),this.element.appendChild(ae)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),m},_onSuggestionItemKeydown(S){let m=S.keyCode;if(m!==9){if(m===13){S.preventDefault();let v=this._typeahead.list.element.querySelector(".active");if(v){let w=v.getAttribute("data-index"),I=this._typeahead.list.items[w];I&&(this._typeahead.value(I.original),this._typeahead.list.hide())}}else if(m===38||m===40){let v=this._typeahead.list.element.querySelectorAll("li");if(v.length>0){if(m===38)if(this._typeahead.list.active>0)S.preventDefault(),this._typeahead.list.active--;else{this._typeahead.el.focus();return}else if(m===40)if(S.preventDefault(),this._typeahead.list.active<v.length-1)this._typeahead.list.active++;else return;v.forEach(function(I){I.classList.remove("active")});let w=v[this._typeahead.list.active];w&&(w.classList.add("active"),w.focus())}}}},_onSuggestionItemFocus(S){this._typeahead.list.active=S.target.getAttribute("data-index"),this._typeahead.list.element.querySelectorAll("li").forEach(function(m){m.classList.remove("active")}),S.target.classList.add("active")},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then(function(S){this._hideLoadingIcon();let m={geometry:{type:"Point",coordinates:[S.coords.longitude,S.coords.latitude]}};this._handleMarker(m),this._fly(m),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(m),this._showClearButton(),this.fresh=!1;let v={limit:1,language:[this.options.language],query:m.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){let w=m.geometry.coordinates[0]+","+m.geometry.coordinates[1];this._setInputValue(w),this._eventEmitter.emit("result",{result:m})}else this.geocoderService.reverseGeocode(v).send().then(function(w){let I=w.body.features[0];if(I){let n=QS.transformFeatureToGeolocationText(I,this.options.addressAccuracy);this._setInputValue(n),I.user_coordinates=m.geometry.coordinates,this._eventEmitter.emit("result",{result:I})}else this._eventEmitter.emit("result",{result:{user_coordinates:m.geometry.coordinates}})}.bind(this))}.bind(this)).catch(function(S){S.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}.bind(this))},createIcon:function(S,m){var v=document.createElementNS("http://www.w3.org/2000/svg","svg");return v.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+S),v.setAttribute("viewBox","0 0 18 18"),v.setAttribute("xml:space","preserve"),v.setAttribute("width",18),v.setAttribute("height",18),v.innerHTML=m,v},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(S){this._inputEl.value=S,setTimeout(function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}.bind(this),1)},_onPaste:function(S){var m=(S.clipboardData||window.clipboardData).getData("text");m.length>=this.options.minLength&&this._geocode(m)},_onKeyDown:function(S){var m=27,v=9;if(S.keyCode===m&&this.options.clearAndBlurOnEsc)return this._clear(S),this._inputEl.blur();var w=S.target&&S.target.shadowRoot?S.target.shadowRoot.activeElement:S.target,I=w?w.value:"";if(!I)return this.fresh=!0,S.keyCode!==v&&this.clear(S),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(S.metaKey||[v,m,37,39,13,38,40].indexOf(S.keyCode)!==-1)&&w.value.length>=this.options.minLength&&this._geocode(w.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(S){this.options.clearOnBlur&&this._clearOnBlur(S),this.options.collapsed&&this._collapse()},_onChange:function(){var S=this._typeahead.selected;S&&JSON.stringify(S)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(S),this.options.marker&&this._mapboxgl&&this._handleMarker(S),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(S),this._eventEmitter.emit("result",{result:S}),this.eventManager.select(S,this))},_fly:function(S){var m;if(S.properties&&JS[S.properties.short_code])m=Sh({},this.options.flyTo),this._map&&this._map.fitBounds(JS[S.properties.short_code].bbox,m);else if(S.bbox){var v=S.bbox;m=Sh({},this.options.flyTo),this._map&&this._map.fitBounds([[v[0],v[1]],[v[2],v[3]]],m)}else{var w={zoom:this.options.zoom};m=Sh({},w,this.options.flyTo),S.center?m.center=S.center:S.geometry&&S.geometry.type&&S.geometry.type==="Point"&&S.geometry.coordinates&&(m.center=S.geometry.coordinates),this._map&&this._map.flyTo(m)}},_requestType:function(S,m){var v;return S.localGeocoderOnly?v=nc.LOCAL:S.reverseGeocode&&QS.REVERSE_GEOCODE_COORD_RGX.test(m)?v=nc.REVERSE:v=nc.FORWARD,v},_setupConfig:function(S,m){let v=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],w=/[\s,]+/;var I=this,n=v.reduce(function(V,H){if(I.options[H]===void 0||I.options[H]===null)return V;["countries","types","language"].indexOf(H)>-1?V[H]=I.options[H].split(w):V[H]=I.options[H];let J=typeof I.options[H].longitude=="number"&&typeof I.options[H].latitude=="number";if(H==="proximity"&&J){let ae=I.options[H].longitude,we=I.options[H].latitude;V[H]=[ae,we]}return V},{});switch(S){case nc.REVERSE:{var O=m.split(w).map(function(V){return parseFloat(V,10)});I.options.flipCoordinates||O.reverse(),n.types&&n.types[0],n=Sh(n,{query:O,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(V){V in n&&delete n[V]})}break;case nc.FORWARD:{let V=m.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(V)&&(m=m.replace(/,/g," ")),n=Sh(n,{query:m})}break}return n.session_token=this.eventManager.getSessionId(),n},_geocode:function(S){this.inputString=S,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:S});let m=this._requestType(this.options,S),v=this._setupConfig(m,S);var w;switch(m){case nc.LOCAL:w=Promise.resolve();break;case nc.FORWARD:w=this.geocoderService.forwardGeocode(v).send();break;case nc.REVERSE:w=this.geocoderService.reverseGeocode(v).send();break}var I=this.options.localGeocoder?this.options.localGeocoder(S)||[]:[],n=[],O=null;return w.catch(function(V){O=V}.bind(this)).then(function(V){this._hideLoadingIcon();var H={};return V?V.statusCode=="200"&&(H=V.body,H.request=V.request,H.headers=V.headers,this._headers=V.headers):H={type:"FeatureCollection",features:[]},H.config=v,this.fresh&&(this.eventManager.start(this),this.fresh=!1),H.features&&H.features.length&&H.features.map(function(J){J._source="mapbox"}),H.features=H.features?I.concat(H.features):I,this.options.externalGeocoder?(n=this.options.externalGeocoder(S,H.features)||Promise.resolve([]),n.then(function(J){return H.features=H.features?J.concat(H.features):J,H},function(){return H})):H}.bind(this)).then(function(V){if(O)throw O;this.options.filter&&V.features.length&&(V.features=V.features.filter(this.options.filter)),V.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",V),this._typeahead.update(V.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",V))}.bind(this)).catch(function(V){this._hideLoadingIcon(),this._hideAttribution(),I.length&&this.options.localGeocoder||n.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(I)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:I}),this._eventEmitter.emit("error",{error:V})}.bind(this)),w},_clear:function(S){S&&S.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this.eventManager.sessionIncrementer++,this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(S){this._clear(S),this._inputEl.focus(),this.options.useBrowserFocus&&this._typeahead.list.hide()},_clearOnBlur:function(S){var m=this;S.relatedTarget&&m._clear(S)},_onQueryResult:function(S){var m=S.body;if(m.features.length){var v=m.features[0];this._typeahead.selected=v,this._inputEl.value=v.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var S=this._map.getCenter().wrap();this.setProximity({longitude:S.lng,latitude:S.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(S){return this._geocode(S).then(this._onQueryResult),this},_renderError:function(){var S="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(S)},_renderLocationError:function(){var S="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(S)},_renderNoResults:function(){var S="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(S)},_renderUserDeniedGeolocationError:function(){var S="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(S)},_renderMessage:function(S){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(S)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var S=this.options.language.split(",")[0],m=$L.language(S),v=HL.placeholder[m];if(v)return v}return"Search"},setInput:function(S,m){return m===void 0&&(m=!1),this._inputEl.value=S,this._typeahead.selected=null,this._typeahead.clear(),S.length>=this.options.minLength&&(m?this._geocode(S):this._onChange()),this},setProximity:function(S,m=!0){return this.options.proximity=S,m&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(S){return S&&typeof S=="function"&&(this._typeahead.render=S),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(S){var m=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=S||this.options.language||m,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(S){return this.options.zoom=S,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(S){return this.options.flyTo=S,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(S){return this.options.placeholder=S||this._getPlaceholderText(),this._inputEl.placeholder=this.options.placeholder,this._inputEl.setAttribute("aria-label",this.options.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(S){return this.options.bbox=S,this},getCountries:function(){return this.options.countries},setCountries:function(S){return this.options.countries=S,this},getTypes:function(){return this.options.types},setTypes:function(S){return this.options.types=S,this},getMinLength:function(){return this.options.minLength},setMinLength:function(S){return this.options.minLength=S,this._typeahead&&(this._typeahead.options.minLength=S),this},getLimit:function(){return this.options.limit},setLimit:function(S){return this.options.limit=S,this._typeahead&&(this._typeahead.options.limit=S),this},getFilter:function(){return this.options.filter},setFilter:function(S){return this.options.filter=S,this},setOrigin:function(S){return this.options.origin=S,this.geocoderService=Ax(Ix({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(S){return this.options.accessToken=S,this.geocoderService=Ax(Ix({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(S){return this.options.autocomplete=S,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(S){return this.options.fuzzyMatch=S,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(S){return this.options.routing=S,this},getRouting:function(){return this.options.routing},setWorldview:function(S){return this.options.worldview=S,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(S){if(this._map){this._removeMarker();var m={color:"#4668F2"},v=Sh({},m,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(v),S.center?this.mapMarker.setLngLat(S.center).addTo(this._map):S.geometry&&S.geometry.type&&S.geometry.type==="Point"&&S.geometry.coordinates&&this.mapMarker.setLngLat(S.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(S,m){return this._eventEmitter.on(S,m),this},off:function(S,m){return this._eventEmitter.removeListener(S,m),this.eventManager.remove(),this}};tE.exports=eE});var Iw=S=>{let m,v=new Set,w=(J,ae)=>{let we=typeof J=="function"?J(m):J;if(!Object.is(we,m)){let Ae=m;m=ae??(typeof we!="object"||we===null)?we:Object.assign({},m,we),v.forEach(xe=>xe(m,Ae))}},I=()=>m,V={setState:w,getState:I,getInitialState:()=>H,subscribe:J=>(v.add(J),()=>v.delete(J))},H=m=S(w,I,V);return V},R_=S=>S?Iw(S):Iw;window.__GLOBAL_DATA_STORE__||(window.__GLOBAL_DATA_STORE__=R_((S,m)=>({sites:[],kdIndex:[],points:[],sitesFiltered:[],organizations:[],lang:"en",initialized:!1,accessibility:!1,userLocMarker:void 0,mapStyle:"mapbox://styles/rodonnell-ctriver/cme050tqw018g01qpa23h8jj3",colors:{},setKdIndex:v=>S(()=>({kdIndex:v})),setPoints:v=>S(()=>({points:v})),setUserLocMarker:v=>S(()=>({userLocMarker:v})),setSites:v=>S(()=>({sites:v})),setSitesFiltered:v=>S(()=>({sitesFiltered:v})),setOrganizations:v=>S(()=>({organizations:v})),setLang:v=>S(()=>({lang:v})),setInitialized:v=>S(()=>({initialized:v})),setAccessibility:v=>S(()=>({accessibility:v})),toggleAccessibility:()=>S(v=>({accessibility:!v.accessibility})),setColors:v=>S(()=>({colors:v})),setMapStyle:v=>S(()=>({mapStyle:v})),getSites:()=>m().sites,getSitesFiltered:()=>m().sitesFiltered,getOrganizations:()=>m().organizations,getLang:()=>m().lang,getColors:()=>m().colors,getInitialized:()=>m().initialized,getAccessibility:()=>m().accessibility,getKdIndex:()=>m().kdIndex,getPoints:()=>m().points,getUserLocMarker:()=>m().userLocMarker,getMapStyle:()=>m().mapStyle})));var Bn=window.__GLOBAL_DATA_STORE__;var{setColors:aC,getColors:fs}=Bn.getState(),ps=new Map;gC();function Aw(S=fs().cloudDark.default,m="white",v=1,w="#ffffffff"){let O=`
=======
        `}_calculateXYTransform(){let t=this._pos,o=this._map,c=this.getPitchAlignment();if(!o||!t||c!=="map")return"";if(!o._showingGlobe()){let b=o.getPitch();return b?`rotateX(${b}deg)`:""}let d=n.cU(n.eX(o.transform,this._lngLat)),p=t.sub(n.eY(o.transform)),_=Math.abs(p.x)+Math.abs(p.y);if(_===0)return"";let x=d/_;return`rotateX(${-p.y*x}deg) rotateY(${p.x*x}deg)`}_calculateZTransform(){let t=this._pos,o=this._map;if(!o||!t)return"";let c=0,d=this.getRotationAlignment();if(d==="map")if(o._showingGlobe()){let p=o.project(new n.ci(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),_=o.project(new n.ci(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(p);c=n.cU(Math.atan2(_.y,_.x))-90}else c=-o.getBearing();else if(d==="horizon"){let p=n.af(4,6,o.getZoom()),_=n.eY(o.transform);_.y+=p*o.transform.height;let x=t.sub(_),b=n.cU(Math.atan2(x.y,x.x));c=(b>90?b-270:b+90)*(1-p)}return c+=this._rotation,c?`rotateZ(${c}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);let o=this._map;o&&(o.transform.renderWorldCopies&&(this._lngLat=No(this._lngLat,this._pos,o.transform)),this._pos=o.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),o._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(o._showingGlobe()||o.getTerrain()||o.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=n.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){let o=this._map;if(!o)return;let c=this._pointerdownPos,d=this._positionDelta;if(c&&d){if(!this._isDragging){let p=this._clickTolerance||o._clickTolerance;if(t.point.dist(c)<p)return;this._isDragging=!0}this._pos=t.point.sub(d),this._lngLat=o.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new n.A("dragstart"))),this.fire(new n.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new n.A("dragend")),this._state="inactive"}_addDragHandler(t){let o=this._map,c=this._pos;o&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",o.on("mousemove",this._onMove),o.on("touchmove",this._onMove),o.once("mouseup",this._onUp),o.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;let o=this._map;return o&&(t?(o.on("mousedown",this._addDragHandler),o.on("touchstart",this._addDragHandler)):(o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||On.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||On.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||On.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||On.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}let Ug={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},jg={maxWidth:100,unit:"metric"},Gg={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},qg={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},zm=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Cn(l=new n.P(0,0),t="bottom"){if(typeof l=="number"){let o=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new n.P(0,l);case"top-left":return new n.P(o,o);case"top-right":return new n.P(-o,o);case"bottom":return new n.P(0,-l);case"bottom-left":return new n.P(o,-o);case"bottom-right":return new n.P(-o,-o);case"left":return new n.P(l,0);case"right":return new n.P(-l,0)}return new n.P(0,0)}return l instanceof n.P||Array.isArray(l)?n.P.convert(l):n.P.convert(l[t]||[0,0])}return{version:O,supported:Ae.supported,setRTLTextPlugin:n.f0,getRTLTextPluginStatus:n.e$,Map:class extends hs{constructor(l){H.mark(V.create);let t=l;if((l=n.h({},Qc,l)).minZoom!=null&&l.maxZoom!=null&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(l.minPitch!=null&&l.maxPitch!=null&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(l.minPitch!=null&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(l.maxPitch!=null&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&n.eU(window)&&(l.antialias=!1,n.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new _d(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies,null,null),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new Rm,this._domRenderTaskQueue=new Rm,this._controls=[],this._markers=[],this._popups=[],this._mapId=n.a$(),this._locale=n.h({},Vg,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Jc(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new yi(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},typeof l.container=="string"){let o=document.getElementById(l.container);if(!o)throw new Error(`Container '${l.container.toString()}' not found.`);this._container=o}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&n.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,n.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Dg),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Eu(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||n.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),this.indoor=new _g(this),l.hash&&(this._hash=new gu(typeof l.hash=="string"&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});let o=l.bounds;o&&(this.resize(),this.fitBounds(o,n.h({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new zl({customAttribution:l.customAttribution})),this._logoControl=new Kc,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",o=>{this._update(o.dataType==="style"),this.fire(new n.A(`${o.dataType}data`,o))}),this.on("dataloading",o=>{this.fire(new n.A(`${o.dataType}dataloading`,o))}),this._interactions=new bp(this)}_getMapId(){return this._mapId}addControl(l,t){if(t===void 0&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new n.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let o=l.onAdd(this);this._controls.push(l);let c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(o,c.firstChild):c.appendChild(o),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new n.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let t=!this._moving;return t&&this.fire(new n.A("movestart",l)).fire(new n.A("move",l)),this.fire(new n.A("resize",l)),t&&this.fire(new n.A("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(n.aG.convert(l)),this._update()}setMinZoom(l){if((l=l??-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new n.A("zoomstart")).fire(new n.A("zoom")).fire(new n.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l??22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new n.A("zoomstart")).fire(new n.A("zoom")).fire(new n.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new n.A("pitchstart")).fire(new n.A("pitch")).fire(new n.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new n.A("pitchstart")).fire(new n.A("pitch")).fire(new n.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return l==="auto"?navigator.language:Array.isArray(l)?l.length===0?void 0:l.map(t=>t==="auto"?navigator.language:t):l}setLanguage(l){let t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(let o of this._controls)o._setLanguage&&o._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(l){return this._lazyInitEmptyStyle(),l?typeof l=="string"&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;let l=this.transform,t=l.projection.name,o;t==="globe"&&l.zoom>=n.cI?(l.setMercatorFromTransition(),o=!0):t==="mercator"&&l.zoom<n.cI&&(l.setProjection({name:"globe"}),o=!0),o&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;return t=l.name==="globe"&&this.transform.zoom>=n.cI?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l,t){return this.transform.locationPoint3D(n.ci.convert(l),t)}unproject(l,t){return this.transform.pointLocation3D(n.P.convert(l),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,o){let c=d=>{let p=[];if(Array.isArray(t)){let _=t.filter(x=>this.getLayer(x));p=_.length?this.queryRenderedFeatures(d,{layers:_}):[]}else p=this.queryRenderedFeatures(d,{target:t});return p};if(l==="mouseenter"||l==="mouseover"){let d=!1;return{listener:o,targets:t,delegates:{mousemove:_=>{let x=c(_.point);x.length?d||(d=!0,o.call(this,new ur(l,this,_.originalEvent,{features:x}))):d=!1},mouseout:()=>{d=!1}}}}if(l==="mouseleave"||l==="mouseout"){let d=!1;return{listener:o,targets:t,delegates:{mousemove:x=>{c(x.point).length?d=!0:d&&(d=!1,o.call(this,new ur(l,this,x.originalEvent)))},mouseout:x=>{d&&(d=!1,o.call(this,new ur(l,this,x.originalEvent)))}}}}{let d=p=>{let _=c(p.point);_.length&&(p.features=_,o.call(this,p),delete p.features)};return{listener:o,targets:t,delegates:{[l]:d}}}}on(l,t,o){if(typeof t=="function"||o===void 0)return super.on(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let c=this._createDelegatedListener(l,t,o);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(let d in c.delegates)this.on(d,c.delegates[d]);return this}once(l,t,o){if(typeof t=="function"||o===void 0)return super.once(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let c=this._createDelegatedListener(l,t,o);for(let d in c.delegates)this.once(d,c.delegates[d]);return this}off(l,t,o){if(typeof t=="function"||o===void 0)return super.off(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(d=>{for(let p=0;p<d.length;p++){let _=d[p];if(_.listener===o&&wp(_.targets,t)){for(let x in _.delegates)this.off(x,_.delegates[x]);return d.splice(p,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(l===void 0||l instanceof n.P||Array.isArray(l)||t!==void 0||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){let p=this.style.queryRenderedFeatures(l,void 0,this.transform),_=this.style.queryRenderedFeatureset(l,void 0,this.transform);return p.concat(_)}let o=!0;if(t.target&&(o=this._isTargetValid(t.target),o&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(let p of t.layers)if(!this._isValidId(p)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let d=[];return c&&(d=d.concat(this.style.queryRenderedFeatures(l,t,this.transform))),o&&(d=d.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),d}querySourceFeatures(l,t){return!l||typeof l=="string"&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}isPointOnSurface(l){let{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&n.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(n.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(l){return this._cooperativeGestures=l,this}setStyle(l,t){return t=n.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,(o,c)=>{if(o){let d=typeof o=="string"?o:o instanceof Error?o.message:o.error;n.w(`Unable to perform style diff: ${d}. Rebuilding the style from scratch.`),this._updateStyle(l,t)}else c&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){let t=this._locale[l];if(t==null)throw new Error(`Missing UI string '${l}'`);return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){let o=n.h({},t);t&&t.config&&(o.initialConfig=t.config,delete o.config),this.style=new ko(this,o).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new ko(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(n.w("There is no style added to the map."),!1)}_isValidId(l){return l==null?(this.fire(new n.z(new Error("IDs can't be empty."))),!1):!n.dk(l)||(this.fire(new n.z(new Error(`IDs can't contain special symbols: "${l}".`))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(let t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,o){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,o)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:o=1,sdf:c=!1,stretchX:d,stretchY:p,content:_}={}){this._lazyInitEmptyStyle();let x=n.I.from(l);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){let{width:b,height:M,data:C}=n.q.getImageData(t);this.style.addImage(x,{data:new n.r({width:b,height:M},C),pixelRatio:o,stretchX:d,stretchY:p,content:_,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new n.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:b,height:M}=t,C=t;this.style.addImage(x,{data:new n.r({width:b,height:M},new Uint8Array(C.data)),pixelRatio:o,stretchX:d,stretchY:p,content:_,sdf:c,usvg:!1,version:0,userImage:C}),C.onAdd&&C.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();let o=n.I.from(l),c=this.style.getImage(o);if(!c)return void this.fire(new n.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let d=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?n.q.getImageData(t):t,{width:p,height:_,data:x}=d;if(p===void 0||_===void 0)return void this.fire(new n.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(p!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||_!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new n.z(new Error(`The width and height of the updated image (${p}, ${_})
                must be that same as the previous version of the image
                (${c.data.width}, ${c.data.height})`)));let b=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap),M=!1;c.usvg?(c.data=new n.r({width:p,height:_},new Uint8Array(x)),c.usvg=!1,c.icon=void 0,M=!0):c.data.replace(x,b),this.style.updateImage(o,c,M)}hasImage(l){return l?!!this.style&&!!this.style.getImage(n.I.from(l)):(this.fire(new n.z(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(n.I.from(l))}loadImage(l,t){n.o(this._requestManager.transformRequest(l,n.R.Image),(o,c)=>{t(o,c instanceof HTMLImageElement?n.q.getImageData(c):c)})}listImages(){return this.style.listImages().map(l=>l.name)}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new n.z(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){let t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t).catch(o=>this.fire(new n.z(new Error("Failed to add import",o)))),this}updateImport(l,t){return typeof t!="string"&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;let t=this.style.getOwnLayer(l);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,o){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,o),this._update(!0)):this}setFilter(l,t,o={}){return this._isValidId(l)?(this.style.setFilter(l,t,o),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,o,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,o,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,o,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,o,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(l){return this.style.setGlyphsUrl(l),this._update(!0)}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,o){return this.style.setConfigProperty(l,t,o),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&l.length===1&&l[0].type==="flat"){let t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let l=this.style.getLights()||[];return l.length===0&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch(l["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(n.ci.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_selectIndoorFloor(l){this.indoor.selectFloor(l)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new vp),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;let l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300,o,c,d,p=this._container;for(;p&&(!c||!d);){let _=window.getComputedStyle(p).transform;_&&_!=="none"&&(o=_.match(/matrix.*\((.+)\)/)[1].split(", "),o[0]&&o[0]!=="0"&&o[0]!=="1"&&(c=o[0]),o[3]&&o[3]!=="0"&&o[3]!=="1"&&(d=o[3])),p=p.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=d?Math.abs(t/d):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&n.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=xe("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();let t=this._canvasContainer=xe("div","mapboxgl-canvas-container",l);this._canvas=xe("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let o=this._controlContainer=xe("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(d=>{c[d]=xe("div",`mapboxgl-ctrl-${d}`,o)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){let o=n.q.devicePixelRatio||1;this._canvas.width=o*Math.ceil(l),this._canvas.height=o*Math.ceil(t),this._canvas.style.width=`${l}px`,this._canvas.style.height=`${t}px`}_addMarker(l){this._markers.push(l)}_removeMarker(l){let t=this._markers.indexOf(l);t!==-1&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){let t=this._popups.indexOf(l);t!==-1&&this._popups.splice(t,1)}_setupPainter(){let l=n.h({},Ae.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(Fs(t,!0),this.painter=new oa(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",o=>{o.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),n.l.testSupport(t)):this.fire(new n.z(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new n.A("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new n.A("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new n.A("renderstart")),++this._frameId;let o=this.painter.context.extTimerQuery,c=n.q.now(),d=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=d.createQuery(),d.beginQuery(o.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();let p=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let M=this.transform.zoom,C=this.transform.pitch,z=n.q.now(),P=new n.aa(M,{now:z,fadeDuration:p,pitch:C,transition:this.style.transition,worldview:this._worldview});this.style.update(P)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let _=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),_=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):_=this._updateAverageElevation(c);let x=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,p,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),x&&(this._placementDirty=x.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:p,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new n.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,H.mark(V.load),this.fire(new n.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){let M=n.q.now()-c;d.endQuery(o.TIME_ELAPSED_EXT),setTimeout(()=>{let C=d.getQueryParameter(t,d.QUERY_RESULT)/1e6;d.deleteQuery(t),this.fire(new n.A("gpu-timing-frame",{cpuTime:M,gpuTime:C}))},50)}if(this.listens("gpu-timing-layer")){let M=this.painter.collectGpuTimers();setTimeout(()=>{let C=this.painter.queryGpuTimers(M);this.fire(new n.A("gpu-timing-layer",{layerTimes:C}))},50)}if(this.listens("gpu-timing-deferred-render")){let M=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let C=this.painter.queryGpuTimeDeferredRender(M);this.fire(new n.A("gpu-timing-deferred-render",{gpuTime:C}))},50)}let b=this._sourcesDirty||this._styleDirty||this._placementDirty||_;if(b||this._repaint)this.triggerRepaint();else{let M=this.idle();if(M&&(_=this._updateAverageElevation(c,!0)),_)this.triggerRepaint();else if(this._triggerFrame(!1),M&&(this.fire(new n.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let C=this._calculateSpeedIndex();this.fire(new n.A("speedindexcompleted",{speedIndex:C})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||b||(this._fullyLoaded=!0,H.mark(V.fullLoad),this._performanceMetricsCollection&&Vr(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(let t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(let t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){let o=d=>(this.transform.averageElevation=d,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&o(0);let c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){let d=this.transform.averageElevation,p=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(p)?p=0:this._averageElevationLastSampledAt=l;let _=Math.abs(d-p);if(_>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(p),o(p);this._averageElevation.easeTo(p,l,300)}else if(_>1e-4)return this._averageElevation.jumpTo(p),o(p)}return!!this._averageElevation.isEasing(l)&&o(this._averageElevation.getValue(l))}_authenticate(){Lr(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,l=>{if(l&&(l.message===Ni||l.status===401)){let t=this.painter.context.gl;Fs(t,!1),this._logoControl instanceof Kc&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new n.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),Ro(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Oi(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){let l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){let l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());let o=this.painter.context.gl,c=o.createFramebuffer();function d(p){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,p,0);let _=new Uint8Array(o.drawingBufferWidth*o.drawingBufferHeight*4);return o.readPixels(0,0,o.drawingBufferWidth,o.drawingBufferHeight,o.RGBA,o.UNSIGNED_BYTE,_),_}return o.bindFramebuffer(o.FRAMEBUFFER,c),this._canvasPixelComparison(d(l),t.canvasCopies.map(d),t.timeStamps)}_canvasPixelComparison(l,t,o){let c=o[1]-o[0],d=l.length/4;for(let p=0;p<t.length;p++){let _=t[p],x=0;for(let b=0;b<_.length;b+=4)_[b]===l[b]&&_[b+1]===l[b+1]&&_[b+2]===l[b+2]&&_[b+3]===l[b+3]&&(x+=1);c+=(o[p+2]-o[p+1])*(1-x/d)}return c}remove(){this._hash&&this._hash.remove();for(let t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),ks.delete(this.painter.context.gl),Bn.remove(),Po.remove(),this._removed=!0,this.fire(new n.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=n.q.frame(t=>{let o=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,o&&this._render(t)}))}_preloadTiles(l){let t=this.style?this.style.getSourceCaches():[];return n.bt(t,(o,c)=>o._preloadTiles(l,c),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this._tp.refreshUI(),l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,this._tp.refreshUI(),l&&this._update())}_setCacheLimits(l,t){n.eV(l,t)}get version(){return O}},NavigationControl:class{constructor(l={}){this.options=n.h({},Dl,l),this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(n.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),xe("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),xe("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(n.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{let o=this._map;o&&(this.options.visualizePitch?o.resetNorthPitch({},{originalEvent:t}):o.resetNorth({},{originalEvent:t}))}),this._compassIcon=xe("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let l=this._map;if(!l)return;let t=l.getZoom(),o=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=o,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",o.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){let l=this._map;if(!l)return;let t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5)}) rotateX(${l.transform.pitch}deg) rotateZ(${l.transform.angle*(180/Math.PI)}deg)`:`rotate(${l.transform.angle*(180/Math.PI)}deg)`;l._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Rs(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){let l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){let o=xe("button",l,this._container);return o.type="button",o.addEventListener("click",t),o}_setButtonTitle(l,t){if(!this._map)return;let o=this._map._getUIString(`NavigationControl.${t}`);l.setAttribute("aria-label",o),l.firstElementChild&&l.firstElementChild.setAttribute("title",o)}},GeolocateControl:class extends n.E{constructor(l={}){super();let t=navigator.geolocation;this.options=n.h({geolocation:t},Ug,l),n.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Al(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){let t=(o=!!this.options.geolocation)=>{this._supportsGeolocation=o,l(o)};this._supportsGeolocation!==void 0?l(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(o=>t(o.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(l){let t=this._map.getMaxBounds(),o=l.coords;return!!t&&(o.longitude<t.getWest()||o.longitude>t.getEast()||o.latitude<t.getSouth()||o.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new n.A("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new n.A("geolocate",l)),this._finish()}}_updateCamera(l){let t=new n.ci(l.coords.longitude,l.coords.latitude),o=l.coords.accuracy,c=this._map.getBearing(),d=n.h({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(o),d,{geolocateSource:!0})}_updateMarker(l){if(l){let t=new n.ci(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let l=this._map.transform,t=n.cb(1,l._center.lat)*l.worldSize,o=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new n.A("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=xe("button","mapboxgl-ctrl-geolocate",this._container),xe("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",l===!1){n.w("Geolocation support is not available so the GeolocateControl will be disabled.");let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{let t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=xe("div","mapboxgl-user-location"),this._dotElement.appendChild(xe("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(xe("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new vo({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=xe("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new vo({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new n.A("trackuserlocationend")))})}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:l.absolute===!0&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return n.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new n.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new n.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new n.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&l()}).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:zl,ScaleControl:class{constructor(l={}){this.options=n.h({},jg,l),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),n.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let l=this.options.maxWidth||100,t=this._map,o=t._containerHeight/2,c=t._containerWidth/2-l/2,d=t.unproject([c,o]),p=t.unproject([c+l,o]),_=d.distanceTo(p);if(this.options.unit==="imperial"){let x=3.2808*_;x>5280?this._setScale(l,x/5280,"mile"):this._setScale(l,x,"foot")}else this.options.unit==="nautical"?this._setScale(l,_/1852,"nautical-mile"):_>=1e3?this._setScale(l,_/1e3,"kilometer"):this._setScale(l,_,"meter")}_setScale(l,t,o){this._map._requestDomTask(()=>{let c=function(p){let _=Math.pow(10,`${Math.floor(p)}`.length-1),x=p/_;return x=x>=10?10:x>=5?5:x>=3?3:x>=2?2:x>=1?1:function(b){let M=Math.pow(10,Math.ceil(-Math.log(b)/Math.LN10));return Math.round(b*M)/M}(x),_*x}(t),d=c/t;this._container.innerHTML=this._isNumberFormatSupported&&o!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:o}).format(c):`${c}&nbsp;${Gg[o]}`,this._container.style.width=l*d+"px"})}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=xe("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:n.w("Full screen control 'container' must be a DOM element.")),n.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=xe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",n.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let l=this._fullscreenButton=xe("button","mapboxgl-ctrl-fullscreen",this._controlContainer);xe("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:vp,Popup:class extends n.E{constructor(l){super(),this.options=n.h(Object.create(qg),l),this._altitude=this.options.altitude,n.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new n.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new n.A("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=n.ci.convert(l),this._pos=null,this._trackPointer=!1,this._update();let t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(l){return this._altitude=l,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){let t=document.createDocumentFragment(),o=document.createElement("body"),c;for(o.innerHTML=l;c=o.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=xe("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){let o=this._closeButton=xe("button","mapboxgl-popup-close-button",t);o.type="button",o.setAttribute("aria-label","Close popup"),o.innerHTML='<span aria-hidden="true">&#215;</span>',o.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;let t=this._map,o=this._container,c=this._pos;if(!t||!o||!c)return"bottom";let d=o.offsetWidth,p=o.offsetHeight,_=c.x<d/2,x=c.x>t.transform.width-d/2;if(c.y+l<p)return _?"top-left":x?"top-right":"top";if(c.y>t.transform.height-p){if(_)return"bottom-left";if(x)return"bottom-right"}return _?"left":x?"right":"bottom"}_updateClassList(){let l=this._container;if(!l)return;let t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){let t=this._map,o=this._content;if(!t||!this._lngLat&&!this._trackPointer||!o)return;let c=this._container;if(c||(c=this._container=xe("div","mapboxgl-popup",t.getContainer()),this._tip=xe("div","mapboxgl-popup-tip",c),c.appendChild(o)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=No(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){let d=this._pos=this._trackPointer&&l instanceof n.P?l:t.project(this._lngLat,this._altitude),p=Cn(this.options.offset),_=this._anchor=this._getAnchor(p.y),x=Cn(this.options.offset,_),b=d.add(x).round();t._requestDomTask(()=>{this._container&&_&&(this._container.style.transform=`${xo[_]} translate(${b.x}px,${b.y}px)`)})}if(!this._marker&&t._showingGlobe()){let d=n.eW(t.transform,this._lngLat)?0:1;this._setOpacity(d)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let l=this._container.querySelector(zm);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity=`${l}`),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:vo,Style:ko,LngLat:n.ci,LngLatBounds:n.aG,Point:n.P,MercatorCoordinate:n.ac,FreeCameraOptions:Ff,Evented:n.E,config:n.e,prewarm:n.e_,clearPrewarmedResources:n.eZ,get accessToken(){return n.e.ACCESS_TOKEN},set accessToken(l){n.e.ACCESS_TOKEN=l},get baseApiUrl(){return n.e.API_URL},set baseApiUrl(l){n.e.API_URL=l},get workerCount(){return n.f7.workerCount},set workerCount(l){n.f7.workerCount=l},get maxParallelImageRequests(){return n.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){n.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){n.f6(l)},get workerUrl(){return n.f5.workerUrl},set workerUrl(l){n.f5.workerUrl=l},get workerClass(){return n.f5.workerClass},set workerClass(l){n.f5.workerClass=l},get workerParams(){return n.f5.workerParams},set workerParams(l){n.f5.workerParams=l},get dracoUrl(){return n.f4()},set dracoUrl(l){n.f3(l)},get meshoptUrl(){return n.f2()},set meshoptUrl(l){n.f1(l)},setNow:n.q.setNow,restoreNow:n.q.restoreNow}});var A=v;return A})});var bh=cr((mD,t2)=>{t2.exports=hR;var cR=Object.prototype.hasOwnProperty;function hR(){for(var S={},m=0;m<arguments.length;m++){var v=arguments[m];for(var T in v)cR.call(v,T)&&(S[T]=v[T])}return S}});var n2=cr((i2,r2)=>{(function(){var S=this,m={};typeof i2<"u"?r2.exports=m:S.fuzzy=m,m.simpleFilter=function(v,T){return T.filter(function(A){return m.test(v,A)})},m.test=function(v,T){return m.match(v,T)!==null},m.match=function(v,T,A){A=A||{};var n=0,O=[],V=T.length,H=0,J=0,ae=A.pre||"",we=A.post||"",Ae=A.caseSensitive&&T||T.toLowerCase(),xe;v=A.caseSensitive&&v||v.toLowerCase();for(var Ge=0;Ge<V;Ge++)xe=T[Ge],Ae[Ge]===v[n]?(xe=ae+xe+we,n+=1,J+=1+J):J=0,H+=J,O[O.length]=xe;return n===v.length?(H=Ae===v?1/0:H,{rendered:O.join(""),score:H}):null},m.filter=function(v,T,A){return!T||T.length===0?[]:typeof v!="string"?T:(A=A||{},T.reduce(function(n,O,V,H){var J=O;A.extract&&(J=A.extract(O));var ae=m.match(v,J,A);return ae!=null&&(n[n.length]={string:ae.rendered,score:ae.score,index:V,original:O}),n},[]).sort(function(n,O){var V=O.score-n.score;return V||n.index-O.index}))}})()});var s2=cr((_D,o2)=>{"use strict";var $o=function(S){return this.component=S,this.items=[],this.active=0,this.wrapper=document.createElement("div"),this.wrapper.className="suggestions-wrapper",this.element=document.createElement("ul"),this.element.className="suggestions",this.wrapper.appendChild(this.element),this.selectingListItem=!1,S.el.parentNode.insertBefore(this.wrapper,S.el.nextSibling),this};$o.prototype.show=function(){this.element.style.display="block"};$o.prototype.hide=function(){this.element.style.display="none"};$o.prototype.add=function(S){this.items.push(S)};$o.prototype.clear=function(){this.items=[],this.active=0};$o.prototype.isEmpty=function(){return!this.items.length};$o.prototype.isVisible=function(){return this.element.style.display==="block"};$o.prototype.draw=function(){if(this.element.innerHTML="",this.items.length===0){this.hide();return}for(var S=0;S<this.items.length;S++)this.drawItem(this.items[S],this.active===S);this.show()};$o.prototype.drawItem=function(S,m){var v=document.createElement("li"),T=document.createElement("a");m&&(v.className+=" active"),T.innerHTML=S.string,v.appendChild(T),this.element.appendChild(v),v.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),v.addEventListener("mouseup",function(){this.handleMouseUp.call(this,S)}.bind(this))};$o.prototype.handleMouseUp=function(S){this.selectingListItem=!1,this.component.value(S.original),this.clear(),this.draw()};$o.prototype.move=function(S){this.active=S,this.draw()};$o.prototype.previous=function(){this.move(this.active===0?this.items.length-1:this.active-1)};$o.prototype.next=function(){this.move(this.active===this.items.length-1?0:this.active+1)};$o.prototype.drawError=function(S){var m=document.createElement("li");m.innerHTML=S,this.element.appendChild(m),this.show()};o2.exports=$o});var l2=cr((gD,a2)=>{"use strict";var uR=bh(),dR=n2(),pR=s2(),ao=function(S,m,v){return v=v||{},this.options=uR({minLength:2,limit:5,filter:!0,hideOnBlur:!0},v),this.el=S,this.data=m||[],this.list=new pR(this),this.query="",this.selected=null,this.list.draw(),this.el.addEventListener("keyup",function(T){this.handleKeyUp(T.keyCode)}.bind(this),!1),this.el.addEventListener("keydown",function(T){this.handleKeyDown(T)}.bind(this)),this.el.addEventListener("focus",function(){this.handleFocus()}.bind(this)),this.el.addEventListener("blur",function(){this.handleBlur()}.bind(this)),this.el.addEventListener("paste",function(T){this.handlePaste(T)}.bind(this)),this.render=this.options.render?this.options.render.bind(this):this.render.bind(this),this.getItemValue=this.options.getItemValue?this.options.getItemValue.bind(this):this.getItemValue.bind(this),this};ao.prototype.handleKeyUp=function(S){S===40||S===38||S===27||S===13||S===9||this.handleInputChange(this.el.value)};ao.prototype.handleKeyDown=function(S){switch(S.keyCode){case 13:case 9:this.list.isEmpty()||(this.list.isVisible()&&S.preventDefault(),this.value(this.list.items[this.list.active].original),this.list.hide());break;case 27:this.list.isEmpty()||this.list.hide();break;case 38:this.list.previous();break;case 40:this.list.next();break}};ao.prototype.handleBlur=function(){!this.list.selectingListItem&&this.options.hideOnBlur&&this.list.hide()};ao.prototype.handlePaste=function(S){if(S.clipboardData)this.handleInputChange(S.clipboardData.getData("Text"));else{var m=this;setTimeout(function(){m.handleInputChange(S.target.value)},100)}};ao.prototype.handleInputChange=function(S){if(this.query=this.normalize(S),this.list.clear(),this.query.length<this.options.minLength){this.list.draw();return}this.getCandidates(function(m){for(var v=0;v<m.length&&(this.list.add(m[v]),v!==this.options.limit-1);v++);this.list.draw()}.bind(this))};ao.prototype.handleFocus=function(){this.list.isEmpty()||this.list.show(),this.list.selectingListItem=!1};ao.prototype.update=function(S){this.data=S,this.handleKeyUp()};ao.prototype.clear=function(){this.data=[],this.list.clear()};ao.prototype.normalize=function(S){return S=S.toLowerCase(),S};ao.prototype.match=function(S,m){return S.indexOf(m)>-1};ao.prototype.value=function(S){if(this.selected=S,this.el.value=this.getItemValue(S),document.createEvent){var m=document.createEvent("HTMLEvents");m.initEvent("change",!0,!1),this.el.dispatchEvent(m)}else this.el.fireEvent("onchange")};ao.prototype.getCandidates=function(S){var m={pre:"<strong>",post:"</strong>",extract:function(T){return this.getItemValue(T)}.bind(this)},v;this.options.filter?(v=dR.filter(this.query,this.data,m),v=v.map(function(T){return{original:T.original,string:this.render(T.original,T.string)}}.bind(this))):v=this.data.map(function(T){var A=this.render(T);return{original:T,string:A}}.bind(this)),S(v)};ao.prototype.getItemValue=function(S){return S};ao.prototype.render=function(S,m){if(m)return m;for(var v=S.original?this.getItemValue(S.original):this.getItemValue(S),T=this.normalize(v),A=T.lastIndexOf(this.query);A>-1;){var n=A+this.query.length;v=v.slice(0,A)+"<strong>"+v.slice(A,n)+"</strong>"+v.slice(n),A=T.slice(0,A).lastIndexOf(this.query)}return v};ao.prototype.renderError=function(S){this.list.drawError(S)};a2.exports=ao});var u2=cr((yD,h2)=>{"use strict";var c2=l2();h2.exports=c2;typeof window<"u"&&(window.Suggestions=c2)});var m2=cr((xD,f2)=>{var fR="Expected a function",d2=NaN,mR="[object Symbol]",_R=/^\s+|\s+$/g,gR=/^[-+]0x[0-9a-f]+$/i,yR=/^0b[01]+$/i,xR=/^0o[0-7]+$/i,vR=parseInt,bR=typeof global=="object"&&global&&global.Object===Object&&global,wR=typeof self=="object"&&self&&self.Object===Object&&self,TR=bR||wR||Function("return this")(),SR=Object.prototype,ER=SR.toString,IR=Math.max,AR=Math.min,ux=function(){return TR.Date.now()};function MR(S,m,v){var T,A,n,O,V,H,J=0,ae=!1,we=!1,Ae=!0;if(typeof S!="function")throw new TypeError(fR);m=p2(m)||0,dx(v)&&(ae=!!v.leading,we="maxWait"in v,n=we?IR(p2(v.maxWait)||0,m):n,Ae="trailing"in v?!!v.trailing:Ae);function xe(Ct){var Ft=T,Wt=A;return T=A=void 0,J=Ct,O=S.apply(Wt,Ft),O}function Ge(Ct){return J=Ct,V=setTimeout(ft,m),ae?xe(Ct):O}function Te(Ct){var Ft=Ct-H,Wt=Ct-J,mt=m-Ft;return we?AR(mt,n-Wt):mt}function We(Ct){var Ft=Ct-H,Wt=Ct-J;return H===void 0||Ft>=m||Ft<0||we&&Wt>=n}function ft(){var Ct=ux();if(We(Ct))return _t(Ct);V=setTimeout(ft,Te(Ct))}function _t(Ct){return V=void 0,Ae&&T?xe(Ct):(T=A=void 0,O)}function Pt(){V!==void 0&&clearTimeout(V),J=0,T=H=A=V=void 0}function At(){return V===void 0?O:_t(ux())}function wt(){var Ct=ux(),Ft=We(Ct);if(T=arguments,A=this,H=Ct,Ft){if(V===void 0)return Ge(H);if(we)return V=setTimeout(ft,m),xe(H)}return V===void 0&&(V=setTimeout(ft,m)),O}return wt.cancel=Pt,wt.flush=At,wt}function dx(S){var m=typeof S;return!!S&&(m=="object"||m=="function")}function CR(S){return!!S&&typeof S=="object"}function PR(S){return typeof S=="symbol"||CR(S)&&ER.call(S)==mR}function p2(S){if(typeof S=="number")return S;if(PR(S))return d2;if(dx(S)){var m=typeof S.valueOf=="function"?S.valueOf():S;S=dx(m)?m+"":m}if(typeof S!="string")return S===0?S:+S;S=S.replace(_R,"");var v=yR.test(S);return v||xR.test(S)?vR(S.slice(2),v?2:8):gR.test(S)?d2:+S}f2.exports=MR});var I2=cr((vD,px)=>{"use strict";var id=typeof Reflect=="object"?Reflect:null,_2=id&&typeof id.apply=="function"?id.apply:function(m,v,T){return Function.prototype.apply.call(m,v,T)},eg;id&&typeof id.ownKeys=="function"?eg=id.ownKeys:Object.getOwnPropertySymbols?eg=function(m){return Object.getOwnPropertyNames(m).concat(Object.getOwnPropertySymbols(m))}:eg=function(m){return Object.getOwnPropertyNames(m)};function RR(S){console&&console.warn&&console.warn(S)}var y2=Number.isNaN||function(m){return m!==m};function Nr(){Nr.init.call(this)}px.exports=Nr;px.exports.once=OR;Nr.EventEmitter=Nr;Nr.prototype._events=void 0;Nr.prototype._eventsCount=0;Nr.prototype._maxListeners=void 0;var g2=10;function tg(S){if(typeof S!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof S)}Object.defineProperty(Nr,"defaultMaxListeners",{enumerable:!0,get:function(){return g2},set:function(S){if(typeof S!="number"||S<0||y2(S))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+S+".");g2=S}});Nr.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};Nr.prototype.setMaxListeners=function(m){if(typeof m!="number"||m<0||y2(m))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+m+".");return this._maxListeners=m,this};function x2(S){return S._maxListeners===void 0?Nr.defaultMaxListeners:S._maxListeners}Nr.prototype.getMaxListeners=function(){return x2(this)};Nr.prototype.emit=function(m){for(var v=[],T=1;T<arguments.length;T++)v.push(arguments[T]);var A=m==="error",n=this._events;if(n!==void 0)A=A&&n.error===void 0;else if(!A)return!1;if(A){var O;if(v.length>0&&(O=v[0]),O instanceof Error)throw O;var V=new Error("Unhandled error."+(O?" ("+O.message+")":""));throw V.context=O,V}var H=n[m];if(H===void 0)return!1;if(typeof H=="function")_2(H,this,v);else for(var J=H.length,ae=S2(H,J),T=0;T<J;++T)_2(ae[T],this,v);return!0};function v2(S,m,v,T){var A,n,O;if(tg(v),n=S._events,n===void 0?(n=S._events=Object.create(null),S._eventsCount=0):(n.newListener!==void 0&&(S.emit("newListener",m,v.listener?v.listener:v),n=S._events),O=n[m]),O===void 0)O=n[m]=v,++S._eventsCount;else if(typeof O=="function"?O=n[m]=T?[v,O]:[O,v]:T?O.unshift(v):O.push(v),A=x2(S),A>0&&O.length>A&&!O.warned){O.warned=!0;var V=new Error("Possible EventEmitter memory leak detected. "+O.length+" "+String(m)+" listeners added. Use emitter.setMaxListeners() to increase limit");V.name="MaxListenersExceededWarning",V.emitter=S,V.type=m,V.count=O.length,RR(V)}return S}Nr.prototype.addListener=function(m,v){return v2(this,m,v,!1)};Nr.prototype.on=Nr.prototype.addListener;Nr.prototype.prependListener=function(m,v){return v2(this,m,v,!0)};function LR(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function b2(S,m,v){var T={fired:!1,wrapFn:void 0,target:S,type:m,listener:v},A=LR.bind(T);return A.listener=v,T.wrapFn=A,A}Nr.prototype.once=function(m,v){return tg(v),this.on(m,b2(this,m,v)),this};Nr.prototype.prependOnceListener=function(m,v){return tg(v),this.prependListener(m,b2(this,m,v)),this};Nr.prototype.removeListener=function(m,v){var T,A,n,O,V;if(tg(v),A=this._events,A===void 0)return this;if(T=A[m],T===void 0)return this;if(T===v||T.listener===v)--this._eventsCount===0?this._events=Object.create(null):(delete A[m],A.removeListener&&this.emit("removeListener",m,T.listener||v));else if(typeof T!="function"){for(n=-1,O=T.length-1;O>=0;O--)if(T[O]===v||T[O].listener===v){V=T[O].listener,n=O;break}if(n<0)return this;n===0?T.shift():zR(T,n),T.length===1&&(A[m]=T[0]),A.removeListener!==void 0&&this.emit("removeListener",m,V||v)}return this};Nr.prototype.off=Nr.prototype.removeListener;Nr.prototype.removeAllListeners=function(m){var v,T,A;if(T=this._events,T===void 0)return this;if(T.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):T[m]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete T[m]),this;if(arguments.length===0){var n=Object.keys(T),O;for(A=0;A<n.length;++A)O=n[A],O!=="removeListener"&&this.removeAllListeners(O);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(v=T[m],typeof v=="function")this.removeListener(m,v);else if(v!==void 0)for(A=v.length-1;A>=0;A--)this.removeListener(m,v[A]);return this};function w2(S,m,v){var T=S._events;if(T===void 0)return[];var A=T[m];return A===void 0?[]:typeof A=="function"?v?[A.listener||A]:[A]:v?DR(A):S2(A,A.length)}Nr.prototype.listeners=function(m){return w2(this,m,!0)};Nr.prototype.rawListeners=function(m){return w2(this,m,!1)};Nr.listenerCount=function(S,m){return typeof S.listenerCount=="function"?S.listenerCount(m):T2.call(S,m)};Nr.prototype.listenerCount=T2;function T2(S){var m=this._events;if(m!==void 0){var v=m[S];if(typeof v=="function")return 1;if(v!==void 0)return v.length}return 0}Nr.prototype.eventNames=function(){return this._eventsCount>0?eg(this._events):[]};function S2(S,m){for(var v=new Array(m),T=0;T<m;++T)v[T]=S[T];return v}function zR(S,m){for(;m+1<S.length;m++)S[m]=S[m+1];S.pop()}function DR(S){for(var m=new Array(S.length),v=0;v<m.length;++v)m[v]=S[v].listener||S[v];return m}function OR(S,m){return new Promise(function(v,T){function A(O){S.removeListener(m,n),T(O)}function n(){typeof S.removeListener=="function"&&S.removeListener("error",A),v([].slice.call(arguments))}E2(S,m,n,{once:!0}),m!=="error"&&kR(S,A,{once:!0})})}function kR(S,m,v){typeof S.on=="function"&&E2(S,"error",m,v)}function E2(S,m,v,T){if(typeof S.on=="function")T.once?S.once(m,v):S.on(m,v);else if(typeof S.addEventListener=="function")S.addEventListener(m,function A(n){T.once&&S.removeEventListener(m,A),v(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof S)}});var M2=cr((bD,A2)=>{A2.exports={fr:{name:"France",bbox:[[-4.59235,41.380007],[9.560016,51.148506]]},us:{name:"United States",bbox:[[-171.791111,18.91619],[-66.96466,71.357764]]},ru:{name:"Russia",bbox:[[19.66064,41.151416],[190.10042,81.2504]]},ca:{name:"Canada",bbox:[[-140.99778,41.675105],[-52.648099,83.23324]]}}});var P2=cr((wD,C2)=>{"use strict";function FR(S){var m=S.match(/\s*(.+)\s*=\s*"?([^"]+)"?/);return m?{key:m[1],value:m[2]}:null}function BR(S){var m=S.match(/<?([^>]*)>(.*)/);if(!m)return null;var v=m[1],T=m[2].split(";"),A=null,n=T.reduce(function(O,V){var H=FR(V);return H?H.key==="rel"?(A||(A=H.value),O):(O[H.key]=H.value,O):O},{});return A?{url:v,rel:A,params:n}:null}function NR(S){return S?S.split(/,\s*</).reduce(function(m,v){var T=BR(v);if(!T)return m;var A=T.rel.split(/\s+/);return A.forEach(function(n){m[n]||(m[n]={url:T.url,params:T.params})}),m},{}):{}}C2.exports=NR});var L2=cr((TD,R2)=>{"use strict";var VR=P2();function fx(S,m){this.request=S,this.headers=m.headers,this.rawBody=m.body,this.statusCode=m.statusCode;try{this.body=JSON.parse(m.body||"{}")}catch{this.body=m.body}this.links=VR(this.headers.link)}fx.prototype.hasNextPage=function(){return!!this.links.next};fx.prototype.nextPage=function(){return this.hasNextPage()?this.request._extend({path:this.links.next.url}):null};R2.exports=fx});var If=cr((SD,z2)=>{"use strict";z2.exports={API_ORIGIN:"https://api.mapbox.com",EVENT_PROGRESS_DOWNLOAD:"downloadProgress",EVENT_PROGRESS_UPLOAD:"uploadProgress",EVENT_ERROR:"error",EVENT_RESPONSE:"response",ERROR_HTTP:"HttpError",ERROR_REQUEST_ABORTED:"RequestAbortedError"}});var k2=cr((ED,O2)=>{"use strict";var D2=If();function UR(S){var m=S.type||D2.ERROR_HTTP,v;if(S.body)try{v=JSON.parse(S.body)}catch{v=S.body}else v=null;var T=S.message||null;T||(typeof v=="string"?T=v:v&&typeof v.message=="string"?T=v.message:m===D2.ERROR_REQUEST_ABORTED&&(T="Request aborted")),this.message=T,this.type=m,this.statusCode=S.statusCode||null,this.request=S.request,this.body=v}O2.exports=UR});var B2=cr((ID,F2)=>{"use strict";function jR(S){var m=S.indexOf(":"),v=S.substring(0,m).trim().toLowerCase(),T=S.substring(m+1).trim();return{name:v,value:T}}function GR(S){var m={};return S&&S.trim().split(/[\r|\n]+/).forEach(function(v){var T=jR(v);m[T.name]=T.value}),m}F2.exports=GR});var q2=cr((AD,G2)=>{"use strict";var qR=L2(),N2=k2(),mx=If(),HR=B2(),ig={};function $R(S){var m=ig[S.id];m&&(m.abort(),delete ig[S.id])}function ZR(S,m){return new qR(S,{body:m.response,headers:HR(m.getAllResponseHeaders()),statusCode:m.status})}function V2(S){var m=S.total,v=S.loaded,T=100*v/m;return{total:m,transferred:v,percent:T}}function U2(S,m){return new Promise(function(v,T){m.onprogress=function(O){S.emitter.emit(mx.EVENT_PROGRESS_DOWNLOAD,V2(O))};var A=S.file;A&&(m.upload.onprogress=function(O){S.emitter.emit(mx.EVENT_PROGRESS_UPLOAD,V2(O))}),m.onerror=function(O){T(O)},m.onabort=function(){var O=new N2({request:S,type:mx.ERROR_REQUEST_ABORTED});T(O)},m.onload=function(){if(delete ig[S.id],m.status<200||m.status>=400){var O=new N2({request:S,body:m.response,statusCode:m.status});T(O);return}v(m)};var n=S.body;typeof n=="string"?m.send(n):n?m.send(JSON.stringify(n)):A?m.send(A):m.send(),ig[S.id]=m}).then(function(v){return ZR(S,v)})}function j2(S,m){var v=S.url(m),T=new window.XMLHttpRequest;return T.open(S.method,v),Object.keys(S.headers).forEach(function(A){T.setRequestHeader(A,S.headers[A])}),T}function WR(S){return Promise.resolve().then(function(){var m=j2(S,S.client.accessToken);return U2(S,m)})}G2.exports={browserAbort:$R,sendRequestXhr:U2,browserSend:WR,createRequestXhr:j2}});var H2=cr((rg,Af)=>{(function(S){var m=typeof rg=="object"&&rg,v=typeof Af=="object"&&Af&&Af.exports==m&&Af,T=typeof global=="object"&&global;(T.global===T||T.window===T)&&(S=T);var A=function(Ae){this.message=Ae};A.prototype=new Error,A.prototype.name="InvalidCharacterError";var n=function(Ae){throw new A(Ae)},O="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",V=/[\t\n\f\r ]/g,H=function(Ae){Ae=String(Ae).replace(V,"");var xe=Ae.length;xe%4==0&&(Ae=Ae.replace(/==?$/,""),xe=Ae.length),(xe%4==1||/[^+a-zA-Z0-9/]/.test(Ae))&&n("Invalid character: the string to be decoded is not correctly encoded.");for(var Ge=0,Te,We,ft="",_t=-1;++_t<xe;)We=O.indexOf(Ae.charAt(_t)),Te=Ge%4?Te*64+We:We,Ge++%4&&(ft+=String.fromCharCode(255&Te>>(-2*Ge&6)));return ft},J=function(Ae){Ae=String(Ae),/[^\0-\xFF]/.test(Ae)&&n("The string to be encoded contains characters outside of the Latin1 range.");for(var xe=Ae.length%3,Ge="",Te=-1,We,ft,_t,Pt,At,wt=Ae.length-xe;++Te<wt;)We=Ae.charCodeAt(Te)<<16,ft=Ae.charCodeAt(++Te)<<8,_t=Ae.charCodeAt(++Te),At=We+ft+_t,Ge+=O.charAt(At>>18&63)+O.charAt(At>>12&63)+O.charAt(At>>6&63)+O.charAt(At&63);return xe==2?(We=Ae.charCodeAt(Te)<<8,ft=Ae.charCodeAt(++Te),At=We+ft,Ge+=O.charAt(At>>10)+O.charAt(At>>4&63)+O.charAt(At<<2&63)+"="):xe==1&&(At=Ae.charCodeAt(Te),Ge+=O.charAt(At>>2)+O.charAt(At<<4&63)+"=="),Ge},ae={encode:J,decode:H,version:"0.1.0"};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd)define(function(){return ae});else if(m&&!m.nodeType)if(v)v.exports=ae;else for(var we in ae)ae.hasOwnProperty(we)&&(m[we]=ae[we]);else S.base64=ae})(rg)});var gx=cr((MD,$2)=>{"use strict";var XR=H2(),_x={};function YR(S){if(_x[S])return _x[S];var m=S.split("."),v=m[0],T=m[1];if(!T)throw new Error("Invalid token");var A=KR(T),n={usage:v,user:A.u};return wh(A,"a")&&(n.authorization=A.a),wh(A,"exp")&&(n.expires=A.exp*1e3),wh(A,"iat")&&(n.created=A.iat*1e3),wh(A,"scopes")&&(n.scopes=A.scopes),wh(A,"client")&&(n.client=A.client),wh(A,"ll")&&(n.lastLogin=A.ll),wh(A,"iu")&&(n.impersonator=A.iu),_x[S]=n,n}function KR(S){try{return JSON.parse(XR.decode(S))}catch{throw new Error("Invalid token")}}function wh(S,m){return Object.prototype.hasOwnProperty.call(S,m)}$2.exports=YR});var W2=cr((CD,yx)=>{"use strict";var JR=Object.prototype.hasOwnProperty,Co="~";function Mf(){}Object.create&&(Mf.prototype=Object.create(null),new Mf().__proto__||(Co=!1));function QR(S,m,v){this.fn=S,this.context=m,this.once=v||!1}function Z2(S,m,v,T,A){if(typeof v!="function")throw new TypeError("The listener must be a function");var n=new QR(v,T||S,A),O=Co?Co+m:m;return S._events[O]?S._events[O].fn?S._events[O]=[S._events[O],n]:S._events[O].push(n):(S._events[O]=n,S._eventsCount++),S}function ng(S,m){--S._eventsCount===0?S._events=new Mf:delete S._events[m]}function lo(){this._events=new Mf,this._eventsCount=0}lo.prototype.eventNames=function(){var m=[],v,T;if(this._eventsCount===0)return m;for(T in v=this._events)JR.call(v,T)&&m.push(Co?T.slice(1):T);return Object.getOwnPropertySymbols?m.concat(Object.getOwnPropertySymbols(v)):m};lo.prototype.listeners=function(m){var v=Co?Co+m:m,T=this._events[v];if(!T)return[];if(T.fn)return[T.fn];for(var A=0,n=T.length,O=new Array(n);A<n;A++)O[A]=T[A].fn;return O};lo.prototype.listenerCount=function(m){var v=Co?Co+m:m,T=this._events[v];return T?T.fn?1:T.length:0};lo.prototype.emit=function(m,v,T,A,n,O){var V=Co?Co+m:m;if(!this._events[V])return!1;var H=this._events[V],J=arguments.length,ae,we;if(H.fn){switch(H.once&&this.removeListener(m,H.fn,void 0,!0),J){case 1:return H.fn.call(H.context),!0;case 2:return H.fn.call(H.context,v),!0;case 3:return H.fn.call(H.context,v,T),!0;case 4:return H.fn.call(H.context,v,T,A),!0;case 5:return H.fn.call(H.context,v,T,A,n),!0;case 6:return H.fn.call(H.context,v,T,A,n,O),!0}for(we=1,ae=new Array(J-1);we<J;we++)ae[we-1]=arguments[we];H.fn.apply(H.context,ae)}else{var Ae=H.length,xe;for(we=0;we<Ae;we++)switch(H[we].once&&this.removeListener(m,H[we].fn,void 0,!0),J){case 1:H[we].fn.call(H[we].context);break;case 2:H[we].fn.call(H[we].context,v);break;case 3:H[we].fn.call(H[we].context,v,T);break;case 4:H[we].fn.call(H[we].context,v,T,A);break;default:if(!ae)for(xe=1,ae=new Array(J-1);xe<J;xe++)ae[xe-1]=arguments[xe];H[we].fn.apply(H[we].context,ae)}}return!0};lo.prototype.on=function(m,v,T){return Z2(this,m,v,T,!1)};lo.prototype.once=function(m,v,T){return Z2(this,m,v,T,!0)};lo.prototype.removeListener=function(m,v,T,A){var n=Co?Co+m:m;if(!this._events[n])return this;if(!v)return ng(this,n),this;var O=this._events[n];if(O.fn)O.fn===v&&(!A||O.once)&&(!T||O.context===T)&&ng(this,n);else{for(var V=0,H=[],J=O.length;V<J;V++)(O[V].fn!==v||A&&!O[V].once||T&&O[V].context!==T)&&H.push(O[V]);H.length?this._events[n]=H.length===1?H[0]:H:ng(this,n)}return this};lo.prototype.removeAllListeners=function(m){var v;return m?(v=Co?Co+m:m,this._events[v]&&ng(this,v)):(this._events=new Mf,this._eventsCount=0),this};lo.prototype.off=lo.prototype.removeListener;lo.prototype.addListener=lo.prototype.on;lo.prefixed=Co;lo.EventEmitter=lo;typeof yx<"u"&&(yx.exports=lo)});var J2=cr((PD,K2)=>{"use strict";function eL(S){return S.map(encodeURIComponent).join(",")}function X2(S){return Array.isArray(S)?eL(S):encodeURIComponent(String(S))}function Y2(S,m,v){if(v===!1||v===null)return S;var T=/\?/.test(S)?"&":"?",A=encodeURIComponent(m);return v!==void 0&&v!==""&&v!==!0&&(A+="="+X2(v)),""+S+T+A}function tL(S,m){if(!m)return S;var v=S;return Object.keys(m).forEach(function(T){var A=m[T];A!==void 0&&(Array.isArray(A)&&(A=A.filter(function(n){return n!=null}).join(",")),v=Y2(v,T,A))}),v}function iL(S,m){if(!m||S.slice(0,4)==="http")return S;var v=S[0]==="/"?"":"/";return""+m.replace(/\/$/,"")+v+S}function rL(S,m){return m?S.replace(/\/:([a-zA-Z0-9]+)/g,function(v,T){var A=m[T];if(A===void 0)throw new Error("Unspecified route parameter "+T);var n=X2(A);return"/"+n}):S}K2.exports={appendQueryObject:tL,appendQueryParam:Y2,prependOrigin:iL,interpolateRouteParams:rL}});var tS=cr((RD,eS)=>{"use strict";var nL=gx(),xx=bh(),oL=W2(),og=J2(),Q2=If(),sL=1;function tc(S,m){if(!S)throw new Error("MapiRequest requires a client");if(!m||!m.path||!m.method)throw new Error("MapiRequest requires an options object with path and method properties");var v={};m.body&&(v["content-type"]="application/json");var T=xx(v,m.headers),A=Object.keys(T).reduce(function(n,O){return n[O.toLowerCase()]=T[O],n},{});this.id=sL++,this._options=m,this.emitter=new oL,this.client=S,this.response=null,this.error=null,this.sent=!1,this.aborted=!1,this.path=m.path,this.method=m.method,this.origin=m.origin||S.origin,this.query=m.query||{},this.params=m.params||{},this.body=m.body||null,this.file=m.file||null,this.encoding=m.encoding||"utf8",this.sendFileAs=m.sendFileAs||null,this.headers=A}tc.prototype.url=function(m){var v=og.prependOrigin(this.path,this.origin);v=og.appendQueryObject(v,this.query);var T=this.params,A=m??this.client.accessToken;if(A){v=og.appendQueryParam(v,"access_token",A);var n=nL(A).user;T=xx({ownerId:n},T)}return v=og.interpolateRouteParams(v,T),v};tc.prototype.send=function(){var m=this;if(m.sent)throw new Error("This request has already been sent. Check the response and error properties. Create a new request with clone().");return m.sent=!0,m.client.sendRequest(m).then(function(v){return m.response=v,m.emitter.emit(Q2.EVENT_RESPONSE,v),v},function(v){throw m.error=v,m.emitter.emit(Q2.EVENT_ERROR,v),v})};tc.prototype.abort=function(){this._nextPageRequest&&(this._nextPageRequest.abort(),delete this._nextPageRequest),!(this.response||this.error||this.aborted)&&(this.aborted=!0,this.client.abortRequest(this))};tc.prototype.eachPage=function(m){var v=this;function T(O){function V(){delete v._nextPageRequest;var H=O.nextPage();H&&(v._nextPageRequest=H,n(H))}m(null,O,V)}function A(O){m(O,null,function(){})}function n(O){O.send().then(T,A)}n(this)};tc.prototype.clone=function(){return this._extend()};tc.prototype._extend=function(m){var v=xx(this._options,m);return new tc(this.client,v)};eS.exports=tc});var vx=cr((LD,rS)=>{"use strict";var aL=gx(),lL=tS(),cL=If();function iS(S){if(!S||!S.accessToken)throw new Error("Cannot create a client without an access token");aL(S.accessToken),this.accessToken=S.accessToken,this.origin=S.origin||cL.API_ORIGIN}iS.prototype.createRequest=function(m){return new lL(this,m)};rS.exports=iS});var bx=cr((zD,sS)=>{"use strict";var nS=q2(),oS=vx();function rd(S){oS.call(this,S)}rd.prototype=Object.create(oS.prototype);rd.prototype.constructor=rd;rd.prototype.sendRequest=nS.browserSend;rd.prototype.abortRequest=nS.browserAbort;function hL(S){return new rd(S)}sS.exports=hL});var lS=cr((DD,aS)=>{"use strict";var uL=bx();aS.exports=uL});var hS=cr((OD,cS)=>{"use strict";var dL=Object.prototype.toString;cS.exports=function(S){var m;return dL.call(S)==="[object Object]"&&(m=Object.getPrototypeOf(S),m===null||m===Object.getPrototypeOf({}))}});var _S=cr((kD,mS)=>{"use strict";var pL=hS(),fL=bh(),uS="value",wx=`
  `,Jr={};Jr.assert=function(S,m){return m=m||{},function(v){var T=ic(S,v);if(T){var A=Tx(T,m);throw m.apiName&&(A=m.apiName+": "+A),new Error(A)}}};Jr.shape=function(m){var v=yL(m);return function(A){var n=ic(Jr.plainObject,A);if(n)return n;for(var O,V,H=[],J=0;J<v.length;J++)O=v[J].key,V=v[J].value,n=ic(V,A[O]),n&&H.push([O].concat(n));return H.length<2?H[0]:function(ae){H=H.map(function(xe){var Ge=xe[0],Te=Tx(xe,ae).split(`
`).join(wx);return"- "+Ge+": "+Te});var we=ae.path.join("."),Ae=we===uS?"":" of "+we;return"The following properties"+Ae+" have invalid values:"+wx+H.join(wx)}}};Jr.strictShape=function(m){var v=Jr.shape(m);return function(A){var n=v(A);if(n)return n;var O=Object.keys(A).reduce(function(V,H){return m[H]===void 0&&V.push(H),V},[]);if(O.length!==0)return function(){return"The following keys are invalid: "+O.join(", ")}}};Jr.arrayOf=function(m){return dS(m)};Jr.tuple=function(){var m=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return dS(m)};function dS(S){var m=Array.isArray(S),v=function(T){return m?S[T]:S};return function(A){var n=ic(Jr.plainArray,A);if(n)return n;if(m&&A.length!==S.length)return"an array with "+S.length+" items";for(var O=0;O<A.length;O++)if(n=ic(v(O),A[O]),n)return[O].concat(n)}}Jr.required=function(m){function v(T){return T==null?function(A){return pS(A,fS(A.path)?"cannot be undefined/null.":"is required.")}:m.apply(this,arguments)}return v.__required=!0,v};Jr.oneOfType=function(){var m=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments);return function(T){var A=m.map(function(n){return ic(n,T)}).filter(Boolean);if(A.length===m.length)return A.every(function(n){return n.length===1&&typeof n[0]=="string"})?mL(A.map(function(n){return n[0]})):A.reduce(function(n,O){return O.length>n.length?O:n})}};Jr.equal=function(m){return function(T){if(T!==m)return JSON.stringify(m)}};Jr.oneOf=function(){var m=Array.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments),v=m.map(function(T){return Jr.equal(T)});return Jr.oneOfType.apply(this,v)};Jr.range=function(m){var v=m[0],T=m[1];return function(n){var O=ic(Jr.number,n);if(O||n<v||n>T)return"number between "+v+" & "+T+" (inclusive)"}};Jr.any=function(){};Jr.boolean=function(m){if(typeof m!="boolean")return"boolean"};Jr.number=function(m){if(typeof m!="number")return"number"};Jr.plainArray=function(m){if(!Array.isArray(m))return"array"};Jr.plainObject=function(m){if(!pL(m))return"object"};Jr.string=function(m){if(typeof m!="string")return"string"};Jr.func=function(m){if(typeof m!="function")return"function"};function ic(S,m){if(!(m==null&&!S.hasOwnProperty("__required"))){var v=S(m);if(v)return Array.isArray(v)?v:[v]}}function Tx(S,m){var v=S.length,T=S[v-1],A=S.slice(0,v-1);return A.length===0&&(A=[uS]),m=fL(m,{path:A}),typeof T=="function"?T(m):pS(m,_L(T))}function mL(S){return S.length<2?S[0]:S.length===2?S.join(" or "):S.slice(0,-1).join(", ")+", or "+S.slice(-1)}function _L(S){return"must be "+gL(S)+"."}function gL(S){return/^an? /.test(S)?S:/^[aeiou]/i.test(S)?"an "+S:/^[a-z]/i.test(S)?"a "+S:S}function pS(S,m){var v=fS(S.path),T=S.path.join(".")+" "+m,A=v?"Item at position ":"";return A+T}function fS(S){return typeof S[S.length-1]=="number"||typeof S[0]=="number"}function yL(S){return Object.keys(S||{}).map(function(m){return{key:m,value:S[m]}})}Jr.validate=ic;Jr.processMessage=Tx;mS.exports=Jr});var yS=cr((FD,gS)=>{"use strict";var xL=bh(),nd=_S();function vL(S){if(typeof window<"u")return S instanceof global.Blob||S instanceof global.ArrayBuffer?void 0:"Blob or ArrayBuffer";if(!(typeof S=="string"||S.pipe!==void 0))return"Filename or Readable stream"}function bL(S,m){return nd.assert(nd.strictShape(S),m)}function wL(S){var m="date";if(typeof S=="boolean")return m;try{var v=new Date(S);if(v.getTime&&isNaN(v.getTime()))return m}catch{return m}}function TL(S){return nd.tuple(nd.number,nd.number)(S)}gS.exports=xL(nd,{file:vL,date:wL,coordinates:TL,assertShape:bL})});var vS=cr((BD,xS)=>{"use strict";function SL(S,m){var v=function(T,A){return m.indexOf(T)!==-1&&A!==void 0};return typeof m=="function"&&(v=m),Object.keys(S).filter(function(T){return v(T,S[T])}).reduce(function(T,A){return T[A]=S[A],T},{})}xS.exports=SL});var wS=cr((ND,bS)=>{"use strict";function EL(S,m){return Object.keys(S).reduce(function(v,T){return v[T]=m(T,S[T]),v},{})}bS.exports=EL});var SS=cr((VD,TS)=>{"use strict";var IL=wS();function AL(S){return IL(S,function(m,v){return typeof v=="boolean"?JSON.stringify(v):v})}TS.exports=AL});var IS=cr((UD,ES)=>{"use strict";var ML=vx(),CL=bx();function PL(S){return function(m){var v;ML.prototype.isPrototypeOf(m)?v=m:v=CL(m);var T=Object.create(S);return T.client=v,T}}ES.exports=PL});var RS=cr((jD,PS)=>{"use strict";var AS=bh(),dr=yS(),sg=vS(),MS=SS(),RL=IS(),Sx={},CS=["country","region","postcode","district","place","locality","neighborhood","address","poi","poi.landmark"];Sx.forwardGeocode=function(S){dr.assertShape({query:dr.required(dr.string),mode:dr.oneOf("mapbox.places","mapbox.places-permanent"),countries:dr.arrayOf(dr.string),proximity:dr.oneOf(dr.coordinates,"ip"),types:dr.arrayOf(dr.oneOf(CS)),autocomplete:dr.boolean,bbox:dr.arrayOf(dr.number),limit:dr.number,language:dr.arrayOf(dr.string),routing:dr.boolean,fuzzyMatch:dr.boolean,worldview:dr.string,session_token:dr.string})(S),S.mode=S.mode||"mapbox.places";var m=MS(AS({country:S.countries},sg(S,["proximity","types","autocomplete","bbox","limit","language","routing","fuzzyMatch","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:sg(S,["mode","query"]),query:m})};Sx.reverseGeocode=function(S){dr.assertShape({query:dr.required(dr.coordinates),mode:dr.oneOf("mapbox.places","mapbox.places-permanent"),countries:dr.arrayOf(dr.string),types:dr.arrayOf(dr.oneOf(CS)),bbox:dr.arrayOf(dr.number),limit:dr.number,language:dr.arrayOf(dr.string),reverseMode:dr.oneOf("distance","score"),routing:dr.boolean,worldview:dr.string,session_token:dr.string})(S),S.mode=S.mode||"mapbox.places";var m=MS(AS({country:S.countries},sg(S,["country","types","bbox","limit","language","reverseMode","routing","worldview","session_token"])));return this.client.createRequest({method:"GET",path:"/geocoding/v5/:mode/:query.json",params:sg(S,["mode","query"]),query:m})};PS.exports=RL(Sx)});var LS,zS=Tw(()=>{LS="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"});var kS={};nC(kS,{customAlphabet:()=>LL,customRandom:()=>OS,nanoid:()=>zL,random:()=>DS,urlAlphabet:()=>LS});var DS,OS,LL,zL,FS=Tw(()=>{zS();DS=S=>crypto.getRandomValues(new Uint8Array(S)),OS=(S,m,v)=>{let T=(2<<Math.log(S.length-1)/Math.LN2)-1,A=-~(1.6*T*m/S.length);return(n=m)=>{let O="";for(;;){let V=v(A),H=A|0;for(;H--;)if(O+=S[V[H]&T]||"",O.length===n)return O}}},LL=(S,m=21)=>OS(S,m,DS),zL=(S=21)=>crypto.getRandomValues(new Uint8Array(S)).reduce((m,v)=>(v&=63,v<36?m+=v.toString(36):v<62?m+=(v-26).toString(36).toUpperCase():v>62?m+="-":m+="_",m),"")});var VS=cr((HD,NS)=>{"use strict";var DL=(FS(),oC(kS)).nanoid;function BS(S){this.origin=S.origin||"https://api.mapbox.com",this.endpoint="events/v2",this.access_token=S.accessToken,this.version="0.3.0",this.pluginSessionID=this.generateSessionID(),this.sessionIncrementer=0,this.userAgent=this.getUserAgent(),this.options=S,this.send=this.send.bind(this),this.countries=S.countries?S.countries.split(","):null,this.types=S.types?S.types.split(","):null,this.bbox=S.bbox?S.bbox:null,this.language=S.language?S.language.split(","):null,this.limit=S.limit?+S.limit:null,this.locale=navigator.language||null,this.enableEventLogging=this.shouldEnableLogging(S),this.eventQueue=new Array,this.flushInterval=S.flushInterval||1e3,this.maxQueueSize=S.maxQueueSize||100,this.timer=this.flushInterval?setTimeout(this.flush.bind(this),this.flushInterval):null,this.lastSentInput="",this.lastSentIndex=0}BS.prototype={select:function(S,m){var v=this.getEventPayload("search.select",m,{selectedFeature:S});if(v&&!(v.resultIndex===this.lastSentIndex&&v.queryString===this.lastSentInput||v.resultIndex==-1))return this.lastSentIndex=v.resultIndex,this.lastSentInput=v.queryString,this.push(v)},start:function(S){var m=this.getEventPayload("search.start",S);if(m)return this.push(m)},keyevent:function(S,m){if(S.key&&!(S.metaKey||[9,27,37,39,13,38,40].indexOf(S.keyCode)!==-1)){var v=this.getEventPayload("search.keystroke",m,{key:S.key});if(v)return this.push(v)}},send:function(S,m){if(!this.enableEventLogging)return m?m():void 0;var v=this.getRequestOptions(S);this.request(v,function(T){if(T)return this.handleError(T,m);if(m)return m()}.bind(this))},getRequestOptions:function(S){Array.isArray(S)||(S=[S]);var m={method:"POST",host:this.origin,path:this.endpoint+"?access_token="+this.access_token,headers:{"Content-Type":"application/json"},body:JSON.stringify(S)};return m},getEventPayload:function(S,m,v={}){if(S==="search.select"&&!v.selectedFeature||S==="search.keystroke"&&!v.key)return null;var T;if(!m.options.proximity)T=null;else if(typeof m.options.proximity=="object")T=[m.options.proximity.longitude,m.options.proximity.latitude];else if(m.options.proximity==="ip"){var A=m._headers?m._headers["ip-proximity"]:null;A&&typeof A=="string"?T=A.split(",").map(parseFloat):T=[999,999]}else T=m.options.proximity;var n=m._map?m._map.getZoom():void 0,O={event:S,version:this.getEventSchemaVersion(S),created:+new Date,sessionIdentifier:this.getSessionId(),country:this.countries,userAgent:this.userAgent,language:this.language,bbox:this.bbox,types:this.types,endpoint:"mapbox.places",autocomplete:m.options.autocomplete,fuzzyMatch:m.options.fuzzyMatch,proximity:T,limit:m.options.limit,routing:m.options.routing,worldview:m.options.worldview,mapZoom:n,keyboardLocale:this.locale};if(S==="search.select"?O.queryString=m.inputString:S!="search.select"&&m._inputEl?O.queryString=m._inputEl.value:O.queryString=m.inputString,["search.keystroke","search.select"].includes(S)&&(O.path="geocoding/v5/mapbox.places"),S==="search.keystroke"&&v.key)O.lastAction=v.key;else if(S==="search.select"&&v.selectedFeature){var V=v.selectedFeature,H=this.getSelectedIndex(V,m);if(O.resultIndex=H,O.resultPlaceName=V.place_name,O.resultId=V.id,V.properties&&(O.resultMapboxId=V.properties.mapbox_id),m._typeahead){var J=m._typeahead.data;J&&J.length>0&&(O.suggestionIds=this.getSuggestionIds(J),O.suggestionNames=this.getSuggestionNames(J),O.suggestionTypes=this.getSuggestionTypes(J),O.suggestionSources=this.getSuggestionSources(J))}}return this.validatePayload(O)?O:null},request:function(S,m){var v=new XMLHttpRequest;v.onreadystatechange=function(){if(this.readyState==4)return this.status==204?m(null):m(this.statusText)},v.open(S.method,S.host+"/"+S.path,!0);for(var T in S.headers){var A=S.headers[T];v.setRequestHeader(T,A)}v.send(S.body)},handleError:function(S,m){if(m)return m(S)},generateSessionID:function(){return DL()},getSessionId:function(){return this.pluginSessionID+"."+this.sessionIncrementer},getUserAgent:function(){return"mapbox-gl-geocoder."+this.version+"."+navigator.userAgent},getSelectedIndex:function(S,m){if(m._typeahead){var v=m._typeahead.data,T=S.id,A=v.map(function(O){return O.id}),n=A.indexOf(T);return n}},getSuggestionIds:function(S){return S.map(function(m){return m.properties?m.properties.mapbox_id||"":m.id||""})},getSuggestionNames:function(S){return S.map(function(m){return m.place_name||""})},getSuggestionTypes:function(S){return S.map(function(m){return m.place_type&&Array.isArray(m.place_type)&&m.place_type[0]||""})},getSuggestionSources:function(S){return S.map(function(m){return m._source||""})},getEventSchemaVersion:function(S){return["search.keystroke","search.select"].includes(S)?"2.2":"2.0"},validatePayload:function(S){if(!S||!S.event)return!1;var m=["event","created","sessionIdentifier","queryString"],v=["event","created","sessionIdentifier","queryString","lastAction"],T=["event","created","sessionIdentifier","queryString","resultIndex","path","suggestionIds"],A=S.event;return A==="search.start"?this.objectHasRequiredProps(S,m):A==="search.keystroke"?this.objectHasRequiredProps(S,v):A==="search.select"?this.objectHasRequiredProps(S,T):!0},objectHasRequiredProps:function(S,m){return m.every(function(v){return v==="queryString"?typeof S[v]=="string"&&S[v].length>0:S[v]!==void 0})},shouldEnableLogging:function(S){return!(S.enableEventLogging===!1||S.origin&&S.origin!=="https://api.mapbox.com")},flush:function(){this.eventQueue.length>0&&(this.send(this.eventQueue),this.eventQueue=new Array),this.timer&&clearTimeout(this.timer),this.flushInterval&&(this.timer=setTimeout(this.flush.bind(this),this.flushInterval))},push:function(S,m){this.eventQueue.push(S),(this.eventQueue.length>=this.maxQueueSize||m)&&this.flush()},remove:function(){this.flush()}};NS.exports=BS});var jS=cr(($D,US)=>{"use strict";var OL={de:"Suche",it:"Ricerca",en:"Search",nl:"Zoeken",fr:"Chercher",ca:"Cerca",he:"\u05DC\u05D7\u05E4\u05E9",ja:"\u30B5\u30FC\u30C1",lv:"Mekl\u0113t",pt:"Procurar",sr:"\u041F\u0440\u0435\u0442\u0440\u0430\u0433\u0430",zh:"\u641C\u7D22",cs:"Vyhled\xE1v\xE1n\xED",hu:"Keres\xE9s",ka:"\u10EB\u10D8\u10D4\u10D1\u10D0",nb:"S\xF8ke",sk:"Vyh\u013Ead\xE1vanie",th:"\u0E04\u0E49\u0E19\u0E2B\u0E32",fi:"Hae",is:"Leita",ko:"\uC218\uC0C9",pl:"Szukaj",sl:"Iskanje",fa:"\u062C\u0633\u062A\u062C\u0648",ru:"\u041F\u043E\u0438\u0441\u043A"};US.exports={placeholder:OL}});var qS=cr((GS,ag)=>{(function(S,m,v){typeof ag<"u"&&ag.exports?ag.exports=v():S[m]=v()})(GS,"subtag",function(){var S="",m=/^([a-zA-Z]{2,3})(?:[_-]+([a-zA-Z]{3})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{4})(?=$|[_-]+))?(?:[_-]+([a-zA-Z]{2}|[0-9]{3})(?=$|[_-]+))?/;function v(V){return V.match(m)||[]}function T(V){return v(V).filter(function(H,J){return H&&J})}function A(V){return V=v(V),{language:V[1]||S,extlang:V[2]||S,script:V[3]||S,region:V[4]||S}}function n(V,H,J){Object.defineProperty(V,H,{value:J,enumerable:!0})}function O(V,H,J){function ae(we){return v(we)[V]||S}n(ae,"pattern",H),n(A,J,ae)}return O(1,/^[a-zA-Z]{2,3}$/,"language"),O(2,/^[a-zA-Z]{3}$/,"extlang"),O(3,/^[a-zA-Z]{4}$/,"script"),O(4,/^[a-zA-Z]{2}$|^[0-9]{3}$/,"region"),n(A,"split",T),A})});var ZS=cr((ZD,$S)=>{function HS(){}HS.prototype={isSupport:function(){return!!window.navigator.geolocation},getCurrentPosition:function(){let S={enableHighAccuracy:!0};return new Promise(function(m,v){window.navigator.geolocation.getCurrentPosition(m,v,S)})}};$S.exports=HS});var YS=cr((WD,XS)=>{function kL(S,m){let v=WS(S),T=["address","street","place","country"];var A;if(typeof m=="function")return m(v);let n=T.indexOf(m);return n===-1?A=T:A=T.slice(n),A.reduce(function(O,V){return v[V]?(O!==""&&(O=O+", "),O+v[V]):O},"")}function WS(S){let m=S.address||"",v=S.text||"",T=S.place_name||"",n={address:T.split(",")[0],houseNumber:m,street:v,placeName:T};return S.context.forEach(function(O){let V=O.id.split(".")[0];n[V]=O.text}),n}var FL=/^[ ]*(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)[ ]*$/;XS.exports={transformFeatureToGeolocationText:kL,getAddressInfo:WS,REVERSE_GEOCODE_COORD_RGX:FL}});var tE=cr((XD,eE)=>{"use strict";var BL=u2(),NL=m2(),Th=bh(),VL=I2().EventEmitter,KS=M2(),Ex=lS(),Ix=RS(),UL=VS(),jL=jS(),GL=qS(),qL=ZS(),JS=YS(),rc={FORWARD:0,LOCAL:1,REVERSE:2};function HL(){var S=document.createElement("div");return S.className="mapboxgl-ctrl-geocoder--powered-by",S.innerHTML='<a href="https://www.mapbox.com/search-service" target="_blank">Powered by Mapbox</a>',S}function QS(S){this._eventEmitter=new VL,this.options=Th({},this.options,S),this.inputString="",this.fresh=!0,this.lastSelected=null,this.geolocation=new qL}function $L(S){return S?String(S).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""}QS.prototype={options:{zoom:16,flyTo:!0,trackProximity:!0,minLength:2,reverseGeocode:!1,flipCoordinates:!1,limit:5,origin:"https://api.mapbox.com",enableEventLogging:!0,marker:!0,mapboxgl:null,collapsed:!1,clearAndBlurOnEsc:!1,clearOnBlur:!1,enableGeolocation:!1,addressAccuracy:"street",useBrowserFocus:!1,getItemValue:function(S){return S.place_name},render:function(S){var m=$L(S.place_name).split(",");return'<div class="mapboxgl-ctrl-geocoder--suggestion"><div class="mapboxgl-ctrl-geocoder--suggestion-title">'+m[0]+'</div><div class="mapboxgl-ctrl-geocoder--suggestion-address">'+m.splice(1,m.length).join(",")+"</div></div>"}},_headers:{},addTo:function(S){function m(v,T){if(!document.body.contains(T))throw new Error("Element provided to #addTo() exists, but is not in the DOM");let A=v.onAdd();T.appendChild(A)}if(S._controlContainer)S.addControl(this);else if(S instanceof HTMLElement)m(this,S);else if(typeof S=="string"){let v=document.querySelectorAll(S);if(v.length===0)throw new Error("Element ",S,"not found.");if(v.length>1)throw new Error("Geocoder can only be added to a single html element");m(this,v[0])}else throw new Error("Error: addTo must be a mapbox-gl-js map, an html element, or a CSS selector query for a single html element")},onAdd:function(S){if(S&&typeof S!="string"&&(this._map=S),this.setLanguage(),this.options.localGeocoderOnly||(this.geocoderService=Ix(Ex({accessToken:this.options.accessToken,origin:this.options.origin}))),this.options.localGeocoderOnly&&!this.options.localGeocoder)throw new Error("A localGeocoder function must be specified to use localGeocoderOnly mode");this.eventManager=new UL(this.options),this._onChange=this._onChange.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onPaste=this._onPaste.bind(this),this._onBlur=this._onBlur.bind(this),this._showButton=this._showButton.bind(this),this._hideButton=this._hideButton.bind(this),this._onQueryResult=this._onQueryResult.bind(this),this.clear=this.clear.bind(this),this._updateProximity=this._updateProximity.bind(this),this._collapse=this._collapse.bind(this),this._unCollapse=this._unCollapse.bind(this),this._clear=this._clear.bind(this),this._clearOnBlur=this._clearOnBlur.bind(this),this._geolocateUser=this._geolocateUser.bind(this),this._onSuggestionItemFocus=this._onSuggestionItemFocus.bind(this),this._onSuggestionItemKeyDown=this._onSuggestionItemKeydown.bind(this);var m=this.container=document.createElement("div");m.className="mapboxgl-ctrl-geocoder mapboxgl-ctrl";var v=this.createIcon("search",'<path d="M7.4 2.5c-2.7 0-4.9 2.2-4.9 4.9s2.2 4.9 4.9 4.9c1 0 1.8-.2 2.5-.8l3.7 3.7c.2.2.4.3.8.3.7 0 1.1-.4 1.1-1.1 0-.3-.1-.5-.3-.8L11.4 10c.4-.8.8-1.6.8-2.5.1-2.8-2.1-5-4.8-5zm0 1.6c1.8 0 3.2 1.4 3.2 3.2s-1.4 3.2-3.2 3.2-3.3-1.3-3.3-3.1 1.4-3.3 3.3-3.3z"/>');this._inputEl=document.createElement("input"),this._inputEl.type="text",this._inputEl.className="mapboxgl-ctrl-geocoder--input",this.setPlaceholder(),this.options.collapsed&&(this._collapse(),this.container.addEventListener("mouseenter",this._unCollapse),this.container.addEventListener("mouseleave",this._collapse),this._inputEl.addEventListener("focus",this._unCollapse)),(this.options.collapsed||this.options.clearOnBlur)&&this._inputEl.addEventListener("blur",this._onBlur),this._inputEl.addEventListener("keydown",NL(this._onKeyDown,200)),this._inputEl.addEventListener("paste",this._onPaste),this._inputEl.addEventListener("change",this._onChange),this.container.addEventListener("mouseenter",this._showButton),this.container.addEventListener("mouseleave",this._hideButton),this._inputEl.addEventListener("keyup",function(Ae){this.eventManager.keyevent(Ae,this)}.bind(this));var T=document.createElement("div");T.classList.add("mapboxgl-ctrl-geocoder--pin-right"),this._clearEl=document.createElement("button"),this._clearEl.setAttribute("aria-label","Clear"),this._clearEl.addEventListener("click",this.clear),this._clearEl.className="mapboxgl-ctrl-geocoder--button";var A=this.createIcon("close",'<path d="M3.8 2.5c-.6 0-1.3.7-1.3 1.3 0 .3.2.7.5.8L7.2 9 3 13.2c-.3.3-.5.7-.5 1 0 .6.7 1.3 1.3 1.3.3 0 .7-.2 1-.5L9 10.8l4.2 4.2c.2.3.7.3 1 .3.6 0 1.3-.7 1.3-1.3 0-.3-.2-.7-.3-1l-4.4-4L15 4.6c.3-.2.5-.5.5-.8 0-.7-.7-1.3-1.3-1.3-.3 0-.7.2-1 .3L9 7.1 4.8 2.8c-.3-.1-.7-.3-1-.3z"/>');if(this._clearEl.appendChild(A),this._loadingEl=this.createIcon("loading",'<path fill="#333" d="M4.4 4.4l.8.8c2.1-2.1 5.5-2.1 7.6 0l.8-.8c-2.5-2.5-6.7-2.5-9.2 0z"/><path opacity=".1" d="M12.8 12.9c-2.1 2.1-5.5 2.1-7.6 0-2.1-2.1-2.1-5.5 0-7.7l-.8-.8c-2.5 2.5-2.5 6.7 0 9.2s6.6 2.5 9.2 0 2.5-6.6 0-9.2l-.8.8c2.2 2.1 2.2 5.6 0 7.7z"/>'),T.appendChild(this._clearEl),T.appendChild(this._loadingEl),m.appendChild(v),m.appendChild(this._inputEl),this.options.enableGeolocation&&this.geolocation.isSupport()){this._geolocateEl=document.createElement("button"),this._geolocateEl.setAttribute("aria-label","Geolocate"),this._geolocateEl.addEventListener("click",this._geolocateUser),this._geolocateEl.className="mapboxgl-ctrl-geocoder--button";var n=this.createIcon("geolocate",'<path d="M12.999 3.677L2.042 8.269c-.962.403-.747 1.823.29 1.912l5.032.431.431 5.033c.089 1.037 1.509 1.252 1.912.29l4.592-10.957c.345-.822-.477-1.644-1.299-1.299z" fill="#4264fb"/>');this._geolocateEl.appendChild(n),T.appendChild(this._geolocateEl),this._showGeolocateButton()}var O=this._typeahead=new BL(this._inputEl,[],{hideOnBlur:!this.options.useBrowserFocus,filter:!1,minLength:this.options.minLength,limit:this.options.limit});m.insertBefore(T,O.list.wrapper),this.setRenderFunction(this.options.render),O.getItemValue=this.options.getItemValue;let V=this._typeahead.handleKeyDown.bind(this._typeahead),H=this._typeahead.handleKeyUp.bind(this._typeahead);this._typeahead.handleKeyUp,this.options.useBrowserFocus&&(this._typeahead.handleKeyDown=function(Ae){if(!(Ae.keyCode===9&&!O.list.isEmpty())){if(Ae.keyCode===40){this._typeahead.list.active=0,this._typeahead.list.element.querySelectorAll("li").forEach(function(xe){xe.classList.remove("active")}),this._typeahead.list.element.querySelectorAll("li")[0].classList.add("active"),this._typeahead.list.element.querySelectorAll("li")[0].focus();return}else if(Ae.keyCode===38){this._typeahead.list.active=O.list.items.length-1,this._typeahead.list.element.querySelectorAll("li").forEach(function(xe){xe.classList.remove("active")}),this._typeahead.list.element.querySelectorAll("li")[this._typeahead.list.active].classList.add("active"),this._typeahead.list.element.querySelectorAll("li")[this._typeahead.list.active].focus();return}V(Ae)}}.bind(this),this._typeahead.handleKeyUp=function(Ae){if(Ae&&Ae.keyCode===16){Ae.preventDefault();return}H(Ae)});var J=O.list.draw,ae=this._footerNode=HL(),we=this;return O.list.draw=function(){we.options.useBrowserFocus&&O.list.element.querySelectorAll("li").forEach(function(Ae){Ae.removeEventListener("focus",we._onSuggestionItemFocus),Ae.removeEventListener("keydown",we._onSuggestionItemKeyDown)}),J.call(this),we.options.useBrowserFocus&&O.list.element.querySelectorAll("li").forEach(function(Ae,xe){xe===0&&Ae.focus(),Ae.setAttribute("data-index",xe),Ae.tabIndex=0,Ae.addEventListener("focus",this._onSuggestionItemFocus),Ae.addEventListener("keydown",this._onSuggestionItemKeyDown)}.bind(we)),ae.addEventListener("mousedown",function(){this.selectingListItem=!0}.bind(this)),ae.addEventListener("mouseup",function(){this.selectingListItem=!1}.bind(this)),this.element.appendChild(ae)},this.mapMarker=null,this._handleMarker=this._handleMarker.bind(this),this._map&&(this.options.trackProximity&&(this._updateProximity(),this._map.on("moveend",this._updateProximity)),this._mapboxgl=this.options.mapboxgl,!this._mapboxgl&&this.options.marker&&(console.error("No mapboxgl detected in options. Map markers are disabled. Please set options.mapboxgl."),this.options.marker=!1)),m},_onSuggestionItemKeydown(S){let m=S.keyCode;if(m!==9){if(m===13){S.preventDefault();let v=this._typeahead.list.element.querySelector(".active");if(v){let T=v.getAttribute("data-index"),A=this._typeahead.list.items[T];A&&(this._typeahead.value(A.original),this._typeahead.list.hide())}}else if(m===38||m===40){let v=this._typeahead.list.element.querySelectorAll("li");if(v.length>0){if(m===38)if(this._typeahead.list.active>0)S.preventDefault(),this._typeahead.list.active--;else{this._typeahead.el.focus();return}else if(m===40)if(S.preventDefault(),this._typeahead.list.active<v.length-1)this._typeahead.list.active++;else return;v.forEach(function(A){A.classList.remove("active")});let T=v[this._typeahead.list.active];T&&(T.classList.add("active"),T.focus())}}}},_onSuggestionItemFocus(S){this._typeahead.list.active=S.target.getAttribute("data-index"),this._typeahead.list.element.querySelectorAll("li").forEach(function(m){m.classList.remove("active")}),S.target.classList.add("active")},_geolocateUser:function(){this._hideGeolocateButton(),this._showLoadingIcon(),this.geolocation.getCurrentPosition().then(function(S){this._hideLoadingIcon();let m={geometry:{type:"Point",coordinates:[S.coords.longitude,S.coords.latitude]}};this._handleMarker(m),this._fly(m),this._typeahead.clear(),this._typeahead.selected=!0,this.lastSelected=JSON.stringify(m),this._showClearButton(),this.fresh=!1;let v={limit:1,language:[this.options.language],query:m.geometry.coordinates,types:["address"]};if(this.options.localGeocoderOnly){let T=m.geometry.coordinates[0]+","+m.geometry.coordinates[1];this._setInputValue(T),this._eventEmitter.emit("result",{result:m})}else this.geocoderService.reverseGeocode(v).send().then(function(T){let A=T.body.features[0];if(A){let n=JS.transformFeatureToGeolocationText(A,this.options.addressAccuracy);this._setInputValue(n),A.user_coordinates=m.geometry.coordinates,this._eventEmitter.emit("result",{result:A})}else this._eventEmitter.emit("result",{result:{user_coordinates:m.geometry.coordinates}})}.bind(this))}.bind(this)).catch(function(S){S.code===1?this._renderUserDeniedGeolocationError():this._renderLocationError(),this._hideLoadingIcon(),this._showGeolocateButton(),this._hideAttribution()}.bind(this))},createIcon:function(S,m){var v=document.createElementNS("http://www.w3.org/2000/svg","svg");return v.setAttribute("class","mapboxgl-ctrl-geocoder--icon mapboxgl-ctrl-geocoder--icon-"+S),v.setAttribute("viewBox","0 0 18 18"),v.setAttribute("xml:space","preserve"),v.setAttribute("width",18),v.setAttribute("height",18),v.innerHTML=m,v},onRemove:function(){return this.container.parentNode.removeChild(this.container),this.options.trackProximity&&this._map&&this._map.off("moveend",this._updateProximity),this._removeMarker(),this._map=null,this},_setInputValue:function(S){this._inputEl.value=S,setTimeout(function(){this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0)}.bind(this),1)},_onPaste:function(S){var m=(S.clipboardData||window.clipboardData).getData("text");m.length>=this.options.minLength&&this._geocode(m)},_onKeyDown:function(S){var m=27,v=9;if(S.keyCode===m&&this.options.clearAndBlurOnEsc)return this._clear(S),this._inputEl.blur();var T=S.target&&S.target.shadowRoot?S.target.shadowRoot.activeElement:S.target,A=T?T.value:"";if(!A)return this.fresh=!0,S.keyCode!==v&&this.clear(S),this._showGeolocateButton(),this._hideClearButton();this._hideGeolocateButton(),!(S.metaKey||[v,m,37,39,13,38,40].indexOf(S.keyCode)!==-1)&&T.value.length>=this.options.minLength&&this._geocode(T.value)},_showButton:function(){this._typeahead.selected&&this._showClearButton()},_hideButton:function(){this._typeahead.selected&&this._hideClearButton()},_showClearButton:function(){this._clearEl.style.display="block"},_hideClearButton:function(){this._clearEl.style.display="none"},_showGeolocateButton:function(){this._geolocateEl&&this.geolocation.isSupport()&&(this._geolocateEl.style.display="block")},_hideGeolocateButton:function(){this._geolocateEl&&(this._geolocateEl.style.display="none")},_showLoadingIcon:function(){this._loadingEl.style.display="block"},_hideLoadingIcon:function(){this._loadingEl.style.display="none"},_showAttribution:function(){this._footerNode.style.display="block"},_hideAttribution:function(){this._footerNode.style.display="none"},_onBlur:function(S){this.options.clearOnBlur&&this._clearOnBlur(S),this.options.collapsed&&this._collapse()},_onChange:function(){var S=this._typeahead.selected;S&&JSON.stringify(S)!==this.lastSelected&&(this._hideClearButton(),this.options.flyTo&&this._fly(S),this.options.marker&&this._mapboxgl&&this._handleMarker(S),this._inputEl.focus(),this._inputEl.scrollLeft=0,this._inputEl.setSelectionRange(0,0),this.lastSelected=JSON.stringify(S),this._eventEmitter.emit("result",{result:S}),this.eventManager.select(S,this))},_fly:function(S){var m;if(S.properties&&KS[S.properties.short_code])m=Th({},this.options.flyTo),this._map&&this._map.fitBounds(KS[S.properties.short_code].bbox,m);else if(S.bbox){var v=S.bbox;m=Th({},this.options.flyTo),this._map&&this._map.fitBounds([[v[0],v[1]],[v[2],v[3]]],m)}else{var T={zoom:this.options.zoom};m=Th({},T,this.options.flyTo),S.center?m.center=S.center:S.geometry&&S.geometry.type&&S.geometry.type==="Point"&&S.geometry.coordinates&&(m.center=S.geometry.coordinates),this._map&&this._map.flyTo(m)}},_requestType:function(S,m){var v;return S.localGeocoderOnly?v=rc.LOCAL:S.reverseGeocode&&JS.REVERSE_GEOCODE_COORD_RGX.test(m)?v=rc.REVERSE:v=rc.FORWARD,v},_setupConfig:function(S,m){let v=["bbox","limit","proximity","countries","types","language","reverseMode","mode","autocomplete","fuzzyMatch","routing","worldview"],T=/[\s,]+/;var A=this,n=v.reduce(function(V,H){if(A.options[H]===void 0||A.options[H]===null)return V;["countries","types","language"].indexOf(H)>-1?V[H]=A.options[H].split(T):V[H]=A.options[H];let J=typeof A.options[H].longitude=="number"&&typeof A.options[H].latitude=="number";if(H==="proximity"&&J){let ae=A.options[H].longitude,we=A.options[H].latitude;V[H]=[ae,we]}return V},{});switch(S){case rc.REVERSE:{var O=m.split(T).map(function(V){return parseFloat(V,10)});A.options.flipCoordinates||O.reverse(),n.types&&n.types[0],n=Th(n,{query:O,limit:1}),["proximity","autocomplete","fuzzyMatch","bbox"].forEach(function(V){V in n&&delete n[V]})}break;case rc.FORWARD:{let V=m.trim();/^(-?\d{1,3}(\.\d{0,256})?)[, ]+(-?\d{1,3}(\.\d{0,256})?)?$/.test(V)&&(m=m.replace(/,/g," ")),n=Th(n,{query:m})}break}return n.session_token=this.eventManager.getSessionId(),n},_geocode:function(S){this.inputString=S,this._showLoadingIcon(),this._eventEmitter.emit("loading",{query:S});let m=this._requestType(this.options,S),v=this._setupConfig(m,S);var T;switch(m){case rc.LOCAL:T=Promise.resolve();break;case rc.FORWARD:T=this.geocoderService.forwardGeocode(v).send();break;case rc.REVERSE:T=this.geocoderService.reverseGeocode(v).send();break}var A=this.options.localGeocoder?this.options.localGeocoder(S)||[]:[],n=[],O=null;return T.catch(function(V){O=V}.bind(this)).then(function(V){this._hideLoadingIcon();var H={};return V?V.statusCode=="200"&&(H=V.body,H.request=V.request,H.headers=V.headers,this._headers=V.headers):H={type:"FeatureCollection",features:[]},H.config=v,this.fresh&&(this.eventManager.start(this),this.fresh=!1),H.features&&H.features.length&&H.features.map(function(J){J._source="mapbox"}),H.features=H.features?A.concat(H.features):A,this.options.externalGeocoder?(n=this.options.externalGeocoder(S,H.features)||Promise.resolve([]),n.then(function(J){return H.features=H.features?J.concat(H.features):J,H},function(){return H})):H}.bind(this)).then(function(V){if(O)throw O;this.options.filter&&V.features.length&&(V.features=V.features.filter(this.options.filter)),V.features.length?(this._showClearButton(),this._hideGeolocateButton(),this._showAttribution(),this._eventEmitter.emit("results",V),this._typeahead.update(V.features)):(this._hideClearButton(),this._hideAttribution(),this._typeahead.selected=null,this._renderNoResults(),this._eventEmitter.emit("results",V))}.bind(this)).catch(function(V){this._hideLoadingIcon(),this._hideAttribution(),A.length&&this.options.localGeocoder||n.length&&this.options.externalGeocoder?(this._showClearButton(),this._hideGeolocateButton(),this._typeahead.update(A)):(this._hideClearButton(),this._typeahead.selected=null,this._renderError()),this._eventEmitter.emit("results",{features:A}),this._eventEmitter.emit("error",{error:V})}.bind(this)),T},_clear:function(S){S&&S.preventDefault(),this._inputEl.value="",this._typeahead.selected=null,this._typeahead.clear(),this.eventManager.sessionIncrementer++,this._onChange(),this._hideClearButton(),this._showGeolocateButton(),this._removeMarker(),this.lastSelected=null,this._eventEmitter.emit("clear"),this.fresh=!0},clear:function(S){this._clear(S),this._inputEl.focus(),this.options.useBrowserFocus&&this._typeahead.list.hide()},_clearOnBlur:function(S){var m=this;S.relatedTarget&&m._clear(S)},_onQueryResult:function(S){var m=S.body;if(m.features.length){var v=m.features[0];this._typeahead.selected=v,this._inputEl.value=v.place_name,this._onChange()}},_updateProximity:function(){if(!(!this._map||!this.options.trackProximity))if(this._map.getZoom()>9){var S=this._map.getCenter().wrap();this.setProximity({longitude:S.lng,latitude:S.lat},!1)}else this.setProximity(null,!1)},_collapse:function(){!this._inputEl.value&&this._inputEl!==document.activeElement&&this.container.classList.add("mapboxgl-ctrl-geocoder--collapsed")},_unCollapse:function(){this.container.classList.remove("mapboxgl-ctrl-geocoder--collapsed")},query:function(S){return this._geocode(S).then(this._onQueryResult),this},_renderError:function(){var S="<div class='mapbox-gl-geocoder--error'>There was an error reaching the server</div>";this._renderMessage(S)},_renderLocationError:function(){var S="<div class='mapbox-gl-geocoder--error'>A location error has occurred</div>";this._renderMessage(S)},_renderNoResults:function(){var S="<div class='mapbox-gl-geocoder--error mapbox-gl-geocoder--no-results'>No results found</div>";this._renderMessage(S)},_renderUserDeniedGeolocationError:function(){var S="<div class='mapbox-gl-geocoder--error'>Geolocation permission denied</div>";this._renderMessage(S)},_renderMessage:function(S){this._typeahead.update([]),this._typeahead.selected=null,this._typeahead.clear(),this._typeahead.renderError(S)},_getPlaceholderText:function(){if(this.options.placeholder)return this.options.placeholder;if(this.options.language){var S=this.options.language.split(",")[0],m=GL.language(S),v=jL.placeholder[m];if(v)return v}return"Search"},setInput:function(S,m){return m===void 0&&(m=!1),this._inputEl.value=S,this._typeahead.selected=null,this._typeahead.clear(),S.length>=this.options.minLength&&(m?this._geocode(S):this._onChange()),this},setProximity:function(S,m=!0){return this.options.proximity=S,m&&(this.options.trackProximity=!1),this},getProximity:function(){return this.options.proximity},setRenderFunction:function(S){return S&&typeof S=="function"&&(this._typeahead.render=S),this},getRenderFunction:function(){return this._typeahead.render},setLanguage:function(S){var m=navigator.language||navigator.userLanguage||navigator.browserLanguage;return this.options.language=S||this.options.language||m,this},getLanguage:function(){return this.options.language},getZoom:function(){return this.options.zoom},setZoom:function(S){return this.options.zoom=S,this},getFlyTo:function(){return this.options.flyTo},setFlyTo:function(S){return this.options.flyTo=S,this},getPlaceholder:function(){return this.options.placeholder},setPlaceholder:function(S){return this.options.placeholder=S||this._getPlaceholderText(),this._inputEl.placeholder=this.options.placeholder,this._inputEl.setAttribute("aria-label",this.options.placeholder),this},getBbox:function(){return this.options.bbox},setBbox:function(S){return this.options.bbox=S,this},getCountries:function(){return this.options.countries},setCountries:function(S){return this.options.countries=S,this},getTypes:function(){return this.options.types},setTypes:function(S){return this.options.types=S,this},getMinLength:function(){return this.options.minLength},setMinLength:function(S){return this.options.minLength=S,this._typeahead&&(this._typeahead.options.minLength=S),this},getLimit:function(){return this.options.limit},setLimit:function(S){return this.options.limit=S,this._typeahead&&(this._typeahead.options.limit=S),this},getFilter:function(){return this.options.filter},setFilter:function(S){return this.options.filter=S,this},setOrigin:function(S){return this.options.origin=S,this.geocoderService=Ix(Ex({accessToken:this.options.accessToken,origin:this.options.origin})),this},getOrigin:function(){return this.options.origin},setAccessToken:function(S){return this.options.accessToken=S,this.geocoderService=Ix(Ex({accessToken:this.options.accessToken,origin:this.options.origin})),this},setAutocomplete:function(S){return this.options.autocomplete=S,this},getAutocomplete:function(){return this.options.autocomplete},setFuzzyMatch:function(S){return this.options.fuzzyMatch=S,this},getFuzzyMatch:function(){return this.options.fuzzyMatch},setRouting:function(S){return this.options.routing=S,this},getRouting:function(){return this.options.routing},setWorldview:function(S){return this.options.worldview=S,this},getWorldview:function(){return this.options.worldview},_handleMarker:function(S){if(this._map){this._removeMarker();var m={color:"#4668F2"},v=Th({},m,this.options.marker);return this.mapMarker=new this._mapboxgl.Marker(v),S.center?this.mapMarker.setLngLat(S.center).addTo(this._map):S.geometry&&S.geometry.type&&S.geometry.type==="Point"&&S.geometry.coordinates&&this.mapMarker.setLngLat(S.geometry.coordinates).addTo(this._map),this}},_removeMarker:function(){this.mapMarker&&(this.mapMarker.remove(),this.mapMarker=null)},on:function(S,m){return this._eventEmitter.on(S,m),this},off:function(S,m){return this._eventEmitter.removeListener(S,m),this.eventManager.remove(),this}};eE.exports=QS});var ps=new Map;function Ew(S="#063D57",m="white",v=1,T="#ffffffff"){let O=`
>>>>>>> a526947f4e024d155ff980808ddb8c37daf4d8a2
    <svg width="${18*v}px" height="${25*v}" viewBox="0 0 18 25" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path fill-rule="evenodd" clip-rule="evenodd"
        d="M8.75 1C12.48 1 15.51 4.03 15.51 7.76C15.51 11.05 13.81 12.86 12 15.79L8.75 21L5.51 15.79C3.7 12.86 2 11.05 2 7.76C2 4.03 5.03 1 8.75 1ZM8.75 3.77C10.83 3.77 12.48 5.47 12.48 7.49C12.48 9.56 10.83 11.21 8.75 11.21C6.68 11.21 5.03 9.56 5.03 7.49C5.03 5.47 6.68 3.77 8.75 3.77Z"
        fill="${S}" />
      <path
        d="M8.75 0.5C12.75 0.5 16 3.76 16 7.75C16 11.24 14.18 13.21 12.43 16.05L9.18 21.26L8.75 21.95L8.33 21.26L5.08 16.05C3.33 13.21 1.5 11.24 1.5 7.75C1.5 3.76 4.76 0.5 8.75 0.5ZM8.75 4.27C6.96 4.27 5.53 5.74 5.53 7.49C5.53 9.29 6.96 10.71 8.75 10.71C10.55 10.71 11.98 9.29 11.98 7.49C11.98 5.74 10.55 4.27 8.75 4.27Z"
        stroke="${m}" stroke-width="1" fill="none"/>
        <circle cx="8.75" cy="7.5" r="3.5" fill="${w}" />
    </svg>
  `;return`data:image/svg+xml;base64,${btoa(O)}`}function lC(S=fs().cloudMain.default){let m=`<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M1.97266 6.17103H6.75501V1.38867H8.39108V6.17103H13.1734V7.8071H8.39108V12.5895H6.75501V7.8071H1.97266V6.17103Z" fill="${S}"/>
</svg>
`;return`data:image/svg+xml;base64,${btoa(m)}`}function cC(S=fs().cloudMain.default){let m=`<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12.4867 7.89492H2.88672V6.29492H12.4867V7.89492Z" fill="${S}"/>
</svg>`;return`data:image/svg+xml;base64,${btoa(m)}`}function hC(S=fs().cloudMain.default){let m=`<svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <g clip-path="url(#clip0_1191_9756)">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M7.98403 11.6673C7.35203 11.6747 6.9647 12.2647 6.66536 12.7393C6.02203 13.7627 5.32536 14.8467 4.72603 15.7587C4.51803 16.0753 4.2927 16.3313 3.91336 16.334C3.53336 16.3367 3.21203 15.8773 3.39536 15.4907C3.8827 14.4647 5.9987 10.7727 5.9987 7.66732C5.9987 6.59198 5.4267 6.33398 4.66536 6.33398H1.9987C1.6307 6.33398 1.33203 6.03532 1.33203 5.66732C1.33203 5.29932 1.6307 5.00065 1.9987 5.00065H13.9987C14.3674 5.00065 14.6654 5.29998 14.6654 5.66732C14.6654 6.03465 14.3674 6.33398 13.9987 6.33398H11.332C10.5714 6.33398 9.9987 6.59198 9.9987 7.66732C9.9987 10.7727 12.1154 14.4647 12.6027 15.4907C12.786 15.8773 12.4647 16.3367 12.0847 16.334C11.7054 16.3313 11.4794 16.0753 11.272 15.7587C10.6727 14.8467 9.97603 13.7627 9.33203 12.7393C9.03136 12.2613 8.64003 11.6653 7.9987 11.6673H7.98403ZM7.9987 0.333984C9.10336 0.333984 9.9987 1.22998 9.9987 2.33398C9.9987 3.43798 9.10336 4.33398 7.9987 4.33398C6.89536 4.33398 5.9987 3.43798 5.9987 2.33398C5.9987 1.22998 6.89536 0.333984 7.9987 0.333984Z" fill="${S}"/>
                  </g>
                  <defs>
                  <clipPath id="clip0_1191_9756">
                  <rect width="16" height="16" fill="white" transform="translate(0 0.333984)"/>
                  </clipPath>
                  </defs>
                  </svg>`;return`data:image/svg+xml;base64,${btoa(m)}`}function uC(S=fs().cloudMain.default){let m=`<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M0.571615 7.66602H2.12717V2.22157H7.57162V0.666016H0.571615V7.66602ZM7.57162 19.3327V17.7771H2.12717V12.3327H0.571615V19.3327H7.57162ZM19.2383 12.3327H17.6827V17.7771H12.2383V19.3327H19.2383V12.3327ZM12.2383 0.666016V2.22157H17.6827V7.66602H19.2383V0.666016H12.2383Z" fill="${S}"/>
    </svg>`;return`data:image/svg+xml;base64,${btoa(m)}`}function dC(S=fs().cloudMain.default){let m=`<svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M13.0494 14.9801L8.54682 10.4776C7.7008 11.0103 6.70362 11.323 5.63025 11.323C2.6003 11.323 0.144531 8.86722 0.144531 5.83728C0.144531 2.80733 2.6003 0.351562 5.63025 0.351562C8.66019 0.351562 11.116 2.80733 11.116 5.83728C11.116 6.91065 10.8027 7.90844 10.2706 8.75385L14.7731 13.2564L13.0494 14.9801ZM5.63025 10.1039C7.9824 10.1039 9.89691 8.19004 9.89691 5.83728C9.89691 3.48451 7.9824 1.57061 5.63025 1.57061C3.27809 1.57061 1.36358 3.48451 1.36358 5.83728C1.36358 8.19004 3.27809 10.1039 5.63025 10.1039Z" fill="${S}"/>
    </svg>`;return`data:image/svg+xml;base64,${btoa(m)}`}function pC(S=fs().cloudMain.default){let m=`${S}a4`,v=`<svg xmlns='http://www.w3.org/2000/svg' fill='${S}' viewBox='0 0 29 29'><path d='M10.5 14l4-8 4 8h-8z'/><path id='south' d='M10.5 16l4 8 4-8h-8z' fill='${m}'/></svg>`;return`data:image/svg+xml;base64,${btoa(v)}`}function fC(S=fs().cloudMain.default){let m=`<svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.1091 7.62475L16.6876 8.54498L8.45767 13.345L0.230469 8.54498L1.8083 7.62475L8.45767 11.5045L15.1091 7.62475ZM8.45767 14.9324L1.8083 11.0526L0.230469 11.9735L8.45767 16.7736L16.6876 11.9735L15.1091 11.0533L8.45767 14.9324ZM8.45767 1.90383L13.9653 5.11641L8.45767 8.32898L2.95207 5.11641L8.45767 1.90383ZM8.45767 0.316406L0.230469 5.11641L8.45767 9.91641L16.6876 5.11641L8.45767 0.316406Z" fill="${S}"/>
    </svg>`;return`data:image/svg+xml;base64,${btoa(m)}`}function mC(S=fs().cloudMain.default){let m=`<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M4.75651 4.28746L8.56918 0.474125C8.66651 0.376792 8.79518 0.328125 8.92318 0.328125C9.19251 0.328125 9.42318 0.544125 9.42318 0.827458C9.42318 0.956125 9.37451 1.08412 9.27718 1.18212L5.46384 4.99479L9.27651 8.80746C9.37451 8.90546 9.42318 9.03346 9.42318 9.16146C9.42318 9.44613 9.19051 9.66146 8.92318 9.66146C8.79518 9.66146 8.66651 9.61279 8.56918 9.51546L4.75651 5.70279L0.943844 9.51546C0.84651 9.61279 0.717844 9.66146 0.589844 9.66146C0.32251 9.66146 0.0898438 9.44613 0.0898438 9.16146C0.0898438 9.03346 0.13851 8.90546 0.23651 8.80746L4.04918 4.99479L0.235844 1.18212C0.13851 1.08412 0.0898438 0.956125 0.0898438 0.827458C0.0898438 0.544125 0.32051 0.328125 0.589844 0.328125C0.717844 0.328125 0.84651 0.376792 0.943844 0.474125L4.75651 4.28746Z" fill="${S}"/>
</svg>`;return`data:image/svg+xml;base64,${btoa(m)}`}function _C(S=fs().cloudMain.default){let m=`<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
		<g clip-path="url(#clip0_423_11269)">
		<path d="M13.2578 6.45833H12.1469C11.8928 3.89896 9.85885 1.865 7.29948 1.61042V0.5H6.21615V1.61042C3.65677 1.865 1.62281 3.89896 1.36877 6.45833H0.257812V7.54167H1.36877C1.62281 10.101 3.65677 12.135 6.21615 12.3896V13.5H7.29948V12.3896C9.85885 12.1355 11.8928 10.101 12.1469 7.54167H13.2578V6.45833ZM7.29948 11.296V9.16667H6.21615V11.296C4.26019 11.05 2.70723 9.49763 2.46185 7.54167H4.59115V6.45833H2.46185C2.70723 4.50238 4.26019 2.94996 6.21615 2.70404V4.83333H7.29948V2.70404C9.25544 2.94996 10.8084 4.50183 11.0538 6.45833H8.92448V7.54167H11.0538C10.8084 9.49763 9.25544 11.05 7.29948 11.296ZM7.84115 7C7.84115 7.598 7.35581 8.08333 6.75781 8.08333C6.15981 8.08333 5.67448 7.598 5.67448 7C5.67448 6.402 6.15981 5.91667 6.75781 5.91667C7.35581 5.91667 7.84115 6.402 7.84115 7Z" fill="${S}"/>
		</g>
		<defs>
		<clipPath id="clip0_423_11269">
		<rect width="13" height="13" fill="white" transform="translate(0.257812 0.5)"/>
		</clipPath>
		</defs>
<<<<<<< HEAD
		</svg>`;return`data:image/svg+xml;base64,${btoa(m)}`}function Mw(){let S="marker",m=fs().cloudDark.default,v="white",w="#ffffffff",I=Aw(m,v,1,w),n=Aw(m,v,1.5,w);ps.set(S,I),ps.set(`${S}-hightlighted`,n)}function Cw(){let S=fs(),m={cloudDark:S.cloudDark.default,cloudMain:S.cloudMain.default,waterMain:S.waterMain.default,waterMainAccess:S.waterMain.access},v={active:m.waterMain,activeAccess:m.waterMainAccess,initial:m.cloudMain,hover:m.cloudDark},w={zoomIn:lC,zoomOut:cC,search:dC,fullScreen:uC,compass:pC,access:hC,mapStyle:fC,location:_C},I="controll";for(let[O,V]of Object.entries(w))for(let[H,J]of Object.entries(v)){let ae=V(J);ps.set(`${I}-${O}-${H}`,ae)}let n=mC();ps.set("controll-reset-search",n)}function gC(){let S={cloudDark:{access:"--color--cloud-dark",default:"--color--cloud-dark"},cloudMain:{access:"--color--cloud-main",default:"--color--cloud-main"},waterMain:{access:"--_accessibility-colors---accessibility--water-main",default:"--color--water-main"},sandMain:{access:"--_accessibility-colors---accessibility--sand-main",default:"--color--sand-main"},buoyMain:{access:"--_accessibility-colors---accessibility--buoy-main",default:"--color--buoy-main"}},m={},v=document.documentElement,w=getComputedStyle(v);for(let[I,n]of Object.entries(S)){let O=w.getPropertyValue(n.default).trim(),V=w.getPropertyValue(n.access).trim();m[I]={default:O,access:V}}aC(m)}function qa(S){if(S===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return S}function Fw(S,m){S.prototype=Object.create(m.prototype),S.prototype.constructor=S,S.__proto__=m}var qo={autoSleep:120,force3D:"auto",nullTargetWarn:1,units:{lineHeight:""}},Hu={duration:.5,overwrite:!1,delay:0},I0,Xn,nn,_s=1e8,qr=1/_s,m0=Math.PI*2,yC=m0/4,xC=0,Bw=Math.sqrt,vC=Math.cos,bC=Math.sin,Rn=function(m){return typeof m=="string"},pn=function(m){return typeof m=="function"},$a=function(m){return typeof m=="number"},U_=function(m){return typeof m>"u"},_a=function(m){return typeof m=="object"},Go=function(m){return m!==!1},A0=function(){return typeof window<"u"},L_=function(m){return pn(m)||Rn(m)},Nw=typeof ArrayBuffer=="function"&&ArrayBuffer.isView||function(){},no=Array.isArray,_0=/(?:-?\.?\d|\.)+/gi,M0=/[-+=.]*\d+[.e\-+]*\d*[e\-+]*\d*/g,dh=/[-+=.]*\d+[.e-]*\d*[a-z%]*/g,l0=/[-+=.]*\d+\.?\d*(?:e-|e\+)?\d*/gi,C0=/[+-]=-?[.\d]+/,Vw=/[^,'"\[\]\s]+/gi,wC=/^[+\-=e\s\d]*\d+[.\d]*([a-z]*|%)\s*$/i,sn,fa,g0,P0,ts={},k_={},Uw,jw=function(m){return(k_=$u(m,ts))&&oo},j_=function(m,v){return console.warn("Invalid property",m,"set to",v,"Missing plugin? gsap.registerPlugin()")},ff=function(m,v){return!v&&console.warn(m)},Gw=function(m,v){return m&&(ts[m]=v)&&k_&&(k_[m]=v)||ts},mf=function(){return 0},TC={suppressEvents:!0,isStart:!0,kill:!1},z_={suppressEvents:!0,kill:!1},SC={suppressEvents:!0},R0={},Wl=[],y0={},qw,Uo={},c0={},Pw=30,D_=[],L0="",z0=function(m){var v=m[0],w,I;if(_a(v)||pn(v)||(m=[m]),!(w=(v._gsap||{}).harness)){for(I=D_.length;I--&&!D_[I].targetTest(v););w=D_[I]}for(I=m.length;I--;)m[I]&&(m[I]._gsap||(m[I]._gsap=new F0(m[I],w)))||m.splice(I,1);return m},Xl=function(m){return m._gsap||z0(gs(m))[0]._gsap},D0=function(m,v,w){return(w=m[v])&&pn(w)?m[v]():U_(w)&&m.getAttribute&&m.getAttribute(v)||w},Ao=function(m,v){return(m=m.split(",")).forEach(v)||m},fn=function(m){return Math.round(m*1e5)/1e5||0},Tn=function(m){return Math.round(m*1e7)/1e7||0},ph=function(m,v){var w=v.charAt(0),I=parseFloat(v.substr(2));return m=parseFloat(m),w==="+"?m+I:w==="-"?m-I:w==="*"?m*I:m/I},EC=function(m,v){for(var w=v.length,I=0;m.indexOf(v[I])<0&&++I<w;);return I<w},F_=function(){var m=Wl.length,v=Wl.slice(0),w,I;for(y0={},Wl.length=0,w=0;w<m;w++)I=v[w],I&&I._lazy&&(I.render(I._lazy[0],I._lazy[1],!0)._lazy=0)},O0=function(m){return!!(m._initted||m._startAt||m.add)},Hw=function(m,v,w,I){Wl.length&&!Xn&&F_(),m.render(v,w,I||!!(Xn&&v<0&&O0(m))),Wl.length&&!Xn&&F_()},$w=function(m){var v=parseFloat(m);return(v||v===0)&&(m+"").match(Vw).length<2?v:Rn(m)?m.trim():m},Zw=function(m){return m},is=function(m,v){for(var w in v)w in m||(m[w]=v[w]);return m},IC=function(m){return function(v,w){for(var I in w)I in v||I==="duration"&&m||I==="ease"||(v[I]=w[I])}},$u=function(m,v){for(var w in v)m[w]=v[w];return m},Rw=function S(m,v){for(var w in v)w!=="__proto__"&&w!=="constructor"&&w!=="prototype"&&(m[w]=_a(v[w])?S(m[w]||(m[w]={}),v[w]):v[w]);return m},B_=function(m,v){var w={},I;for(I in m)I in v||(w[I]=m[I]);return w},uf=function(m){var v=m.parent||sn,w=m.keyframes?IC(no(m.keyframes)):is;if(Go(m.inherit))for(;v;)w(m,v.vars.defaults),v=v.parent||v._dp;return m},AC=function(m,v){for(var w=m.length,I=w===v.length;I&&w--&&m[w]===v[w];);return w<0},Ww=function(m,v,w,I,n){w===void 0&&(w="_first"),I===void 0&&(I="_last");var O=m[I],V;if(n)for(V=v[n];O&&O[n]>V;)O=O._prev;return O?(v._next=O._next,O._next=v):(v._next=m[w],m[w]=v),v._next?v._next._prev=v:m[I]=v,v._prev=O,v.parent=v._dp=m,v},G_=function(m,v,w,I){w===void 0&&(w="_first"),I===void 0&&(I="_last");var n=v._prev,O=v._next;n?n._next=O:m[w]===v&&(m[w]=O),O?O._prev=n:m[I]===v&&(m[I]=n),v._next=v._prev=v.parent=null},Yl=function(m,v){m.parent&&(!v||m.parent.autoRemoveChildren)&&m.parent.remove&&m.parent.remove(m),m._act=0},ch=function(m,v){if(m&&(!v||v._end>m._dur||v._start<0))for(var w=m;w;)w._dirty=1,w=w.parent;return m},MC=function(m){for(var v=m.parent;v&&v.parent;)v._dirty=1,v.totalDuration(),v=v.parent;return m},x0=function(m,v,w,I){return m._startAt&&(Xn?m._startAt.revert(z_):m.vars.immediateRender&&!m.vars.autoRevert||m._startAt.render(v,!0,I))},CC=function S(m){return!m||m._ts&&S(m.parent)},Lw=function(m){return m._repeat?Zu(m._tTime,m=m.duration()+m._rDelay)*m:0},Zu=function(m,v){var w=Math.floor(m=Tn(m/v));return m&&w===m?w-1:w},N_=function(m,v){return(m-v._start)*v._ts+(v._ts>=0?0:v._dirty?v.totalDuration():v._tDur)},q_=function(m){return m._end=Tn(m._start+(m._tDur/Math.abs(m._ts||m._rts||qr)||0))},H_=function(m,v){var w=m._dp;return w&&w.smoothChildTiming&&m._ts&&(m._start=Tn(w._time-(m._ts>0?v/m._ts:((m._dirty?m.totalDuration():m._tDur)-v)/-m._ts)),q_(m),w._dirty||ch(w,m)),m},Xw=function(m,v){var w;if((v._time||!v._dur&&v._initted||v._start<m._time&&(v._dur||!v.add))&&(w=N_(m.rawTime(),v),(!v._dur||yf(0,v.totalDuration(),w)-v._tTime>qr)&&v.render(w,!0)),ch(m,v)._dp&&m._initted&&m._time>=m._dur&&m._ts){if(m._dur<m.duration())for(w=m;w._dp;)w.rawTime()>=0&&w.totalTime(w._tTime),w=w._dp;m._zTime=-qr}},ma=function(m,v,w,I){return v.parent&&Yl(v),v._start=Tn(($a(w)?w:w||m!==sn?ms(m,w,v):m._time)+v._delay),v._end=Tn(v._start+(v.totalDuration()/Math.abs(v.timeScale())||0)),Ww(m,v,"_first","_last",m._sort?"_start":0),v0(v)||(m._recent=v),I||Xw(m,v),m._ts<0&&H_(m,m._tTime),m},Yw=function(m,v){return(ts.ScrollTrigger||j_("scrollTrigger",v))&&ts.ScrollTrigger.create(v,m)},Kw=function(m,v,w,I,n){if(V0(m,v,n),!m._initted)return 1;if(!w&&m._pt&&!Xn&&(m._dur&&m.vars.lazy!==!1||!m._dur&&m.vars.lazy)&&qw!==jo.frame)return Wl.push(m),m._lazy=[n,I],1},PC=function S(m){var v=m.parent;return v&&v._ts&&v._initted&&!v._lock&&(v.rawTime()<0||S(v))},v0=function(m){var v=m.data;return v==="isFromStart"||v==="isStart"},RC=function(m,v,w,I){var n=m.ratio,O=v<0||!v&&(!m._start&&PC(m)&&!(!m._initted&&v0(m))||(m._ts<0||m._dp._ts<0)&&!v0(m))?0:1,V=m._rDelay,H=0,J,ae,we;if(V&&m._repeat&&(H=yf(0,m._tDur,v),ae=Zu(H,V),m._yoyo&&ae&1&&(O=1-O),ae!==Zu(m._tTime,V)&&(n=1-O,m.vars.repeatRefresh&&m._initted&&m.invalidate())),O!==n||Xn||I||m._zTime===qr||!v&&m._zTime){if(!m._initted&&Kw(m,v,I,w,H))return;for(we=m._zTime,m._zTime=v||(w?qr:0),w||(w=v&&!we),m.ratio=O,m._from&&(O=1-O),m._time=0,m._tTime=H,J=m._pt;J;)J.r(O,J.d),J=J._next;v<0&&x0(m,v,w,!0),m._onUpdate&&!w&&es(m,"onUpdate"),H&&m._repeat&&!w&&m.parent&&es(m,"onRepeat"),(v>=m._tDur||v<0)&&m.ratio===O&&(O&&Yl(m,1),!w&&!Xn&&(es(m,O?"onComplete":"onReverseComplete",!0),m._prom&&m._prom()))}else m._zTime||(m._zTime=v)},LC=function(m,v,w){var I;if(w>v)for(I=m._first;I&&I._start<=w;){if(I.data==="isPause"&&I._start>v)return I;I=I._next}else for(I=m._last;I&&I._start>=w;){if(I.data==="isPause"&&I._start<v)return I;I=I._prev}},Wu=function(m,v,w,I){var n=m._repeat,O=Tn(v)||0,V=m._tTime/m._tDur;return V&&!I&&(m._time*=O/m._dur),m._dur=O,m._tDur=n?n<0?1e10:Tn(O*(n+1)+m._rDelay*n):O,V>0&&!I&&H_(m,m._tTime=m._tDur*V),m.parent&&q_(m),w||ch(m.parent,m),m},zw=function(m){return m instanceof Wn?ch(m):Wu(m,m._dur)},zC={_start:0,endTime:mf,totalDuration:mf},ms=function S(m,v,w){var I=m.labels,n=m._recent||zC,O=m.duration()>=_s?n.endTime(!1):m._dur,V,H,J;return Rn(v)&&(isNaN(v)||v in I)?(H=v.charAt(0),J=v.substr(-1)==="%",V=v.indexOf("="),H==="<"||H===">"?(V>=0&&(v=v.replace(/=/,"")),(H==="<"?n._start:n.endTime(n._repeat>=0))+(parseFloat(v.substr(1))||0)*(J?(V<0?n:w).totalDuration()/100:1)):V<0?(v in I||(I[v]=O),I[v]):(H=parseFloat(v.charAt(V-1)+v.substr(V+1)),J&&w&&(H=H/100*(no(w)?w[0]:w).totalDuration()),V>1?S(m,v.substr(0,V-1),w)+H:O+H)):v==null?O:+v},df=function(m,v,w){var I=$a(v[1]),n=(I?2:1)+(m<2?0:1),O=v[n],V,H;if(I&&(O.duration=v[1]),O.parent=w,m){for(V=O,H=w;H&&!("immediateRender"in V);)V=H.vars.defaults||{},H=Go(H.vars.inherit)&&H.parent;O.immediateRender=Go(V.immediateRender),m<2?O.runBackwards=1:O.startAt=v[n-1]}return new gn(v[0],O,v[n+1])},Kl=function(m,v){return m||m===0?v(m):v},yf=function(m,v,w){return w<m?m:w>v?v:w},Yn=function(m,v){return!Rn(m)||!(v=wC.exec(m))?"":v[1]},DC=function(m,v,w){return Kl(w,function(I){return yf(m,v,I)})},b0=[].slice,Jw=function(m,v){return m&&_a(m)&&"length"in m&&(!v&&!m.length||m.length-1 in m&&_a(m[0]))&&!m.nodeType&&m!==fa},OC=function(m,v,w){return w===void 0&&(w=[]),m.forEach(function(I){var n;return Rn(I)&&!v||Jw(I,1)?(n=w).push.apply(n,gs(I)):w.push(I)})||w},gs=function(m,v,w){return nn&&!v&&nn.selector?nn.selector(m):Rn(m)&&!w&&(g0||!Xu())?b0.call((v||P0).querySelectorAll(m),0):no(m)?OC(m,w):Jw(m)?b0.call(m,0):m?[m]:[]},w0=function(m){return m=gs(m)[0]||ff("Invalid scope")||{},function(v){var w=m.current||m.nativeElement||m;return gs(v,w.querySelectorAll?w:w===m?ff("Invalid scope")||P0.createElement("div"):m)}},Qw=function(m){return m.sort(function(){return .5-Math.random()})},eT=function(m){if(pn(m))return m;var v=_a(m)?m:{each:m},w=hh(v.ease),I=v.from||0,n=parseFloat(v.base)||0,O={},V=I>0&&I<1,H=isNaN(I)||V,J=v.axis,ae=I,we=I;return Rn(I)?ae=we={center:.5,edges:.5,end:1}[I]||0:!V&&H&&(ae=I[0],we=I[1]),function(Ae,xe,Ge){var Te=(Ge||v).length,We=O[Te],ft,_t,Pt,At,wt,Ct,Ft,Wt,mt;if(!We){if(mt=v.grid==="auto"?0:(v.grid||[1,_s])[1],!mt){for(Ft=-_s;Ft<(Ft=Ge[mt++].getBoundingClientRect().left)&&mt<Te;);mt<Te&&mt--}for(We=O[Te]=[],ft=H?Math.min(mt,Te)*ae-.5:I%mt,_t=mt===_s?0:H?Te*we/mt-.5:I/mt|0,Ft=0,Wt=_s,Ct=0;Ct<Te;Ct++)Pt=Ct%mt-ft,At=_t-(Ct/mt|0),We[Ct]=wt=J?Math.abs(J==="y"?At:Pt):Bw(Pt*Pt+At*At),wt>Ft&&(Ft=wt),wt<Wt&&(Wt=wt);I==="random"&&Qw(We),We.max=Ft-Wt,We.min=Wt,We.v=Te=(parseFloat(v.amount)||parseFloat(v.each)*(mt>Te?Te-1:J?J==="y"?Te/mt:mt:Math.max(mt,Te/mt))||0)*(I==="edges"?-1:1),We.b=Te<0?n-Te:n,We.u=Yn(v.amount||v.each)||0,w=w&&Te<0?cT(w):w}return Te=(We[Ae]-We.min)/We.max||0,Tn(We.b+(w?w(Te):Te)*We.v)+We.u}},T0=function(m){var v=Math.pow(10,((m+"").split(".")[1]||"").length);return function(w){var I=Tn(Math.round(parseFloat(w)/m)*m*v);return(I-I%1)/v+($a(w)?0:Yn(w))}},tT=function(m,v){var w=no(m),I,n;return!w&&_a(m)&&(I=w=m.radius||_s,m.values?(m=gs(m.values),(n=!$a(m[0]))&&(I*=I)):m=T0(m.increment)),Kl(v,w?pn(m)?function(O){return n=m(O),Math.abs(n-O)<=I?n:O}:function(O){for(var V=parseFloat(n?O.x:O),H=parseFloat(n?O.y:0),J=_s,ae=0,we=m.length,Ae,xe;we--;)n?(Ae=m[we].x-V,xe=m[we].y-H,Ae=Ae*Ae+xe*xe):Ae=Math.abs(m[we]-V),Ae<J&&(J=Ae,ae=we);return ae=!I||J<=I?m[ae]:O,n||ae===O||$a(O)?ae:ae+Yn(O)}:T0(m))},iT=function(m,v,w,I){return Kl(no(m)?!v:w===!0?!!(w=0):!I,function(){return no(m)?m[~~(Math.random()*m.length)]:(w=w||1e-5)&&(I=w<1?Math.pow(10,(w+"").length-2):1)&&Math.floor(Math.round((m-w/2+Math.random()*(v-m+w*.99))/w)*w*I)/I})},kC=function(){for(var m=arguments.length,v=new Array(m),w=0;w<m;w++)v[w]=arguments[w];return function(I){return v.reduce(function(n,O){return O(n)},I)}},FC=function(m,v){return function(w){return m(parseFloat(w))+(v||Yn(w))}},BC=function(m,v,w){return nT(m,v,0,1,w)},rT=function(m,v,w){return Kl(w,function(I){return m[~~v(I)]})},NC=function S(m,v,w){var I=v-m;return no(m)?rT(m,S(0,m.length),v):Kl(w,function(n){return(I+(n-m)%I)%I+m})},VC=function S(m,v,w){var I=v-m,n=I*2;return no(m)?rT(m,S(0,m.length-1),v):Kl(w,function(O){return O=(n+(O-m)%n)%n||0,m+(O>I?n-O:O)})},Yu=function(m){for(var v=0,w="",I,n,O,V;~(I=m.indexOf("random(",v));)O=m.indexOf(")",I),V=m.charAt(I+7)==="[",n=m.substr(I+7,O-I-7).match(V?Vw:_0),w+=m.substr(v,I-v)+iT(V?n:+n[0],V?0:+n[1],+n[2]||1e-5),v=O+1;return w+m.substr(v,m.length-v)},nT=function(m,v,w,I,n){var O=v-m,V=I-w;return Kl(n,function(H){return w+((H-m)/O*V||0)})},UC=function S(m,v,w,I){var n=isNaN(m+v)?0:function(xe){return(1-xe)*m+xe*v};if(!n){var O=Rn(m),V={},H,J,ae,we,Ae;if(w===!0&&(I=1)&&(w=null),O)m={p:m},v={p:v};else if(no(m)&&!no(v)){for(ae=[],we=m.length,Ae=we-2,J=1;J<we;J++)ae.push(S(m[J-1],m[J]));we--,n=function(Ge){Ge*=we;var Te=Math.min(Ae,~~Ge);return ae[Te](Ge-Te)},w=v}else I||(m=$u(no(m)?[]:{},m));if(!ae){for(H in v)B0.call(V,m,H,"get",v[H]);n=function(Ge){return G0(Ge,V)||(O?m.p:m)}}}return Kl(w,n)},Dw=function(m,v,w){var I=m.labels,n=_s,O,V,H;for(O in I)V=I[O]-v,V<0==!!w&&V&&n>(V=Math.abs(V))&&(H=O,n=V);return H},es=function(m,v,w){var I=m.vars,n=I[v],O=nn,V=m._ctx,H,J,ae;if(n)return H=I[v+"Params"],J=I.callbackScope||m,w&&Wl.length&&F_(),V&&(nn=V),ae=H?n.apply(J,H):n.call(J),nn=O,ae},cf=function(m){return Yl(m),m.scrollTrigger&&m.scrollTrigger.kill(!!Xn),m.progress()<1&&es(m,"onInterrupt"),m},qu,oT=[],sT=function(m){if(m)if(m=!m.name&&m.default||m,A0()||m.headless){var v=m.name,w=pn(m),I=v&&!w&&m.init?function(){this._props=[]}:m,n={init:mf,render:G0,add:B0,kill:rP,modifier:iP,rawVars:0},O={targetTest:0,get:0,getSetter:$_,aliases:{},register:0};if(Xu(),m!==I){if(Uo[v])return;is(I,is(B_(m,n),O)),$u(I.prototype,$u(n,B_(m,O))),Uo[I.prop=v]=I,m.targetTest&&(D_.push(I),R0[v]=1),v=(v==="css"?"CSS":v.charAt(0).toUpperCase()+v.substr(1))+"Plugin"}Gw(v,I),m.register&&m.register(oo,I,Mo)}else oT.push(m)},Gr=255,hf={aqua:[0,Gr,Gr],lime:[0,Gr,0],silver:[192,192,192],black:[0,0,0],maroon:[128,0,0],teal:[0,128,128],blue:[0,0,Gr],navy:[0,0,128],white:[Gr,Gr,Gr],olive:[128,128,0],yellow:[Gr,Gr,0],orange:[Gr,165,0],gray:[128,128,128],purple:[128,0,128],green:[0,128,0],red:[Gr,0,0],pink:[Gr,192,203],cyan:[0,Gr,Gr],transparent:[Gr,Gr,Gr,0]},h0=function(m,v,w){return m+=m<0?1:m>1?-1:0,(m*6<1?v+(w-v)*m*6:m<.5?w:m*3<2?v+(w-v)*(2/3-m)*6:v)*Gr+.5|0},aT=function(m,v,w){var I=m?$a(m)?[m>>16,m>>8&Gr,m&Gr]:0:hf.black,n,O,V,H,J,ae,we,Ae,xe,Ge;if(!I){if(m.substr(-1)===","&&(m=m.substr(0,m.length-1)),hf[m])I=hf[m];else if(m.charAt(0)==="#"){if(m.length<6&&(n=m.charAt(1),O=m.charAt(2),V=m.charAt(3),m="#"+n+n+O+O+V+V+(m.length===5?m.charAt(4)+m.charAt(4):"")),m.length===9)return I=parseInt(m.substr(1,6),16),[I>>16,I>>8&Gr,I&Gr,parseInt(m.substr(7),16)/255];m=parseInt(m.substr(1),16),I=[m>>16,m>>8&Gr,m&Gr]}else if(m.substr(0,3)==="hsl"){if(I=Ge=m.match(_0),!v)H=+I[0]%360/360,J=+I[1]/100,ae=+I[2]/100,O=ae<=.5?ae*(J+1):ae+J-ae*J,n=ae*2-O,I.length>3&&(I[3]*=1),I[0]=h0(H+1/3,n,O),I[1]=h0(H,n,O),I[2]=h0(H-1/3,n,O);else if(~m.indexOf("="))return I=m.match(M0),w&&I.length<4&&(I[3]=1),I}else I=m.match(_0)||hf.transparent;I=I.map(Number)}return v&&!Ge&&(n=I[0]/Gr,O=I[1]/Gr,V=I[2]/Gr,we=Math.max(n,O,V),Ae=Math.min(n,O,V),ae=(we+Ae)/2,we===Ae?H=J=0:(xe=we-Ae,J=ae>.5?xe/(2-we-Ae):xe/(we+Ae),H=we===n?(O-V)/xe+(O<V?6:0):we===O?(V-n)/xe+2:(n-O)/xe+4,H*=60),I[0]=~~(H+.5),I[1]=~~(J*100+.5),I[2]=~~(ae*100+.5)),w&&I.length<4&&(I[3]=1),I},lT=function(m){var v=[],w=[],I=-1;return m.split(Ha).forEach(function(n){var O=n.match(dh)||[];v.push.apply(v,O),w.push(I+=O.length+1)}),v.c=w,v},Ow=function(m,v,w){var I="",n=(m+I).match(Ha),O=v?"hsla(":"rgba(",V=0,H,J,ae,we;if(!n)return m;if(n=n.map(function(Ae){return(Ae=aT(Ae,v,1))&&O+(v?Ae[0]+","+Ae[1]+"%,"+Ae[2]+"%,"+Ae[3]:Ae.join(","))+")"}),w&&(ae=lT(m),H=w.c,H.join(I)!==ae.c.join(I)))for(J=m.replace(Ha,"1").split(dh),we=J.length-1;V<we;V++)I+=J[V]+(~H.indexOf(V)?n.shift()||O+"0,0,0,0)":(ae.length?ae:n.length?n:w).shift());if(!J)for(J=m.split(Ha),we=J.length-1;V<we;V++)I+=J[V]+n[V];return I+J[we]},Ha=function(){var S="(?:\\b(?:(?:rgb|rgba|hsl|hsla)\\(.+?\\))|\\B#(?:[0-9a-f]{3,4}){1,2}\\b",m;for(m in hf)S+="|"+m+"\\b";return new RegExp(S+")","gi")}(),jC=/hsl[a]?\(/,k0=function(m){var v=m.join(" "),w;if(Ha.lastIndex=0,Ha.test(v))return w=jC.test(v),m[1]=Ow(m[1],w),m[0]=Ow(m[0],w,lT(m[1])),!0},_f,jo=function(){var S=Date.now,m=500,v=33,w=S(),I=w,n=1e3/240,O=n,V=[],H,J,ae,we,Ae,xe,Ge=function Te(We){var ft=S()-I,_t=We===!0,Pt,At,wt,Ct;if((ft>m||ft<0)&&(w+=ft-v),I+=ft,wt=I-w,Pt=wt-O,(Pt>0||_t)&&(Ct=++we.frame,Ae=wt-we.time*1e3,we.time=wt=wt/1e3,O+=Pt+(Pt>=n?4:n-Pt),At=1),_t||(H=J(Te)),At)for(xe=0;xe<V.length;xe++)V[xe](wt,Ae,Ct,We)};return we={time:0,frame:0,tick:function(){Ge(!0)},deltaRatio:function(We){return Ae/(1e3/(We||60))},wake:function(){Uw&&(!g0&&A0()&&(fa=g0=window,P0=fa.document||{},ts.gsap=oo,(fa.gsapVersions||(fa.gsapVersions=[])).push(oo.version),jw(k_||fa.GreenSockGlobals||!fa.gsap&&fa||{}),oT.forEach(sT)),ae=typeof requestAnimationFrame<"u"&&requestAnimationFrame,H&&we.sleep(),J=ae||function(We){return setTimeout(We,O-we.time*1e3+1|0)},_f=1,Ge(2))},sleep:function(){(ae?cancelAnimationFrame:clearTimeout)(H),_f=0,J=mf},lagSmoothing:function(We,ft){m=We||1/0,v=Math.min(ft||33,m)},fps:function(We){n=1e3/(We||240),O=we.time*1e3+n},add:function(We,ft,_t){var Pt=ft?function(At,wt,Ct,Ft){We(At,wt,Ct,Ft),we.remove(Pt)}:We;return we.remove(We),V[_t?"unshift":"push"](Pt),Xu(),Pt},remove:function(We,ft){~(ft=V.indexOf(We))&&V.splice(ft,1)&&xe>=ft&&xe--},_listeners:V},we}(),Xu=function(){return!_f&&jo.wake()},br={},GC=/^[\d.\-M][\d.\-,\s]/,qC=/["']/g,HC=function(m){for(var v={},w=m.substr(1,m.length-3).split(":"),I=w[0],n=1,O=w.length,V,H,J;n<O;n++)H=w[n],V=n!==O-1?H.lastIndexOf(","):H.length,J=H.substr(0,V),v[I]=isNaN(J)?J.replace(qC,"").trim():+J,I=H.substr(V+1).trim();return v},$C=function(m){var v=m.indexOf("(")+1,w=m.indexOf(")"),I=m.indexOf("(",v);return m.substring(v,~I&&I<w?m.indexOf(")",w+1):w)},ZC=function(m){var v=(m+"").split("("),w=br[v[0]];return w&&v.length>1&&w.config?w.config.apply(null,~m.indexOf("{")?[HC(v[1])]:$C(m).split(",").map($w)):br._CE&&GC.test(m)?br._CE("",m):w},cT=function(m){return function(v){return 1-m(1-v)}},hT=function S(m,v){for(var w=m._first,I;w;)w instanceof Wn?S(w,v):w.vars.yoyoEase&&(!w._yoyo||!w._repeat)&&w._yoyo!==v&&(w.timeline?S(w.timeline,v):(I=w._ease,w._ease=w._yEase,w._yEase=I,w._yoyo=v)),w=w._next},hh=function(m,v){return m&&(pn(m)?m:br[m]||ZC(m))||v},fh=function(m,v,w,I){w===void 0&&(w=function(H){return 1-v(1-H)}),I===void 0&&(I=function(H){return H<.5?v(H*2)/2:1-v((1-H)*2)/2});var n={easeIn:v,easeOut:w,easeInOut:I},O;return Ao(m,function(V){br[V]=ts[V]=n,br[O=V.toLowerCase()]=w;for(var H in n)br[O+(H==="easeIn"?".in":H==="easeOut"?".out":".inOut")]=br[V+"."+H]=n[H]}),n},uT=function(m){return function(v){return v<.5?(1-m(1-v*2))/2:.5+m((v-.5)*2)/2}},u0=function S(m,v,w){var I=v>=1?v:1,n=(w||(m?.3:.45))/(v<1?v:1),O=n/m0*(Math.asin(1/I)||0),V=function(ae){return ae===1?1:I*Math.pow(2,-10*ae)*bC((ae-O)*n)+1},H=m==="out"?V:m==="in"?function(J){return 1-V(1-J)}:uT(V);return n=m0/n,H.config=function(J,ae){return S(m,J,ae)},H},d0=function S(m,v){v===void 0&&(v=1.70158);var w=function(O){return O?--O*O*((v+1)*O+v)+1:0},I=m==="out"?w:m==="in"?function(n){return 1-w(1-n)}:uT(w);return I.config=function(n){return S(m,n)},I};Ao("Linear,Quad,Cubic,Quart,Quint,Strong",function(S,m){var v=m<5?m+1:m;fh(S+",Power"+(v-1),m?function(w){return Math.pow(w,v)}:function(w){return w},function(w){return 1-Math.pow(1-w,v)},function(w){return w<.5?Math.pow(w*2,v)/2:1-Math.pow((1-w)*2,v)/2})});br.Linear.easeNone=br.none=br.Linear.easeIn;fh("Elastic",u0("in"),u0("out"),u0());(function(S,m){var v=1/m,w=2*v,I=2.5*v,n=function(V){return V<v?S*V*V:V<w?S*Math.pow(V-1.5/m,2)+.75:V<I?S*(V-=2.25/m)*V+.9375:S*Math.pow(V-2.625/m,2)+.984375};fh("Bounce",function(O){return 1-n(1-O)},n)})(7.5625,2.75);fh("Expo",function(S){return Math.pow(2,10*(S-1))*S+S*S*S*S*S*S*(1-S)});fh("Circ",function(S){return-(Bw(1-S*S)-1)});fh("Sine",function(S){return S===1?1:-vC(S*yC)+1});fh("Back",d0("in"),d0("out"),d0());br.SteppedEase=br.steps=ts.SteppedEase={config:function(m,v){m===void 0&&(m=1);var w=1/m,I=m+(v?0:1),n=v?1:0,O=1-qr;return function(V){return((I*yf(0,O,V)|0)+n)*w}}};Hu.ease=br["quad.out"];Ao("onComplete,onUpdate,onStart,onRepeat,onReverseComplete,onInterrupt",function(S){return L0+=S+","+S+"Params,"});var F0=function(m,v){this.id=xC++,m._gsap=this,this.target=m,this.harness=v,this.get=v?v.get:D0,this.set=v?v.getSetter:$_},gf=function(){function S(v){this.vars=v,this._delay=+v.delay||0,(this._repeat=v.repeat===1/0?-2:v.repeat||0)&&(this._rDelay=v.repeatDelay||0,this._yoyo=!!v.yoyo||!!v.yoyoEase),this._ts=1,Wu(this,+v.duration,1,1),this.data=v.data,nn&&(this._ctx=nn,nn.data.push(this)),_f||jo.wake()}var m=S.prototype;return m.delay=function(w){return w||w===0?(this.parent&&this.parent.smoothChildTiming&&this.startTime(this._start+w-this._delay),this._delay=w,this):this._delay},m.duration=function(w){return arguments.length?this.totalDuration(this._repeat>0?w+(w+this._rDelay)*this._repeat:w):this.totalDuration()&&this._dur},m.totalDuration=function(w){return arguments.length?(this._dirty=0,Wu(this,this._repeat<0?w:(w-this._repeat*this._rDelay)/(this._repeat+1))):this._tDur},m.totalTime=function(w,I){if(Xu(),!arguments.length)return this._tTime;var n=this._dp;if(n&&n.smoothChildTiming&&this._ts){for(H_(this,w),!n._dp||n.parent||Xw(n,this);n&&n.parent;)n.parent._time!==n._start+(n._ts>=0?n._tTime/n._ts:(n.totalDuration()-n._tTime)/-n._ts)&&n.totalTime(n._tTime,!0),n=n.parent;!this.parent&&this._dp.autoRemoveChildren&&(this._ts>0&&w<this._tDur||this._ts<0&&w>0||!this._tDur&&!w)&&ma(this._dp,this,this._start-this._delay)}return(this._tTime!==w||!this._dur&&!I||this._initted&&Math.abs(this._zTime)===qr||!w&&!this._initted&&(this.add||this._ptLookup))&&(this._ts||(this._pTime=w),Hw(this,w,I)),this},m.time=function(w,I){return arguments.length?this.totalTime(Math.min(this.totalDuration(),w+Lw(this))%(this._dur+this._rDelay)||(w?this._dur:0),I):this._time},m.totalProgress=function(w,I){return arguments.length?this.totalTime(this.totalDuration()*w,I):this.totalDuration()?Math.min(1,this._tTime/this._tDur):this.rawTime()>=0&&this._initted?1:0},m.progress=function(w,I){return arguments.length?this.totalTime(this.duration()*(this._yoyo&&!(this.iteration()&1)?1-w:w)+Lw(this),I):this.duration()?Math.min(1,this._time/this._dur):this.rawTime()>0?1:0},m.iteration=function(w,I){var n=this.duration()+this._rDelay;return arguments.length?this.totalTime(this._time+(w-1)*n,I):this._repeat?Zu(this._tTime,n)+1:1},m.timeScale=function(w,I){if(!arguments.length)return this._rts===-qr?0:this._rts;if(this._rts===w)return this;var n=this.parent&&this._ts?N_(this.parent._time,this):this._tTime;return this._rts=+w||0,this._ts=this._ps||w===-qr?0:this._rts,this.totalTime(yf(-Math.abs(this._delay),this.totalDuration(),n),I!==!1),q_(this),MC(this)},m.paused=function(w){return arguments.length?(this._ps!==w&&(this._ps=w,w?(this._pTime=this._tTime||Math.max(-this._delay,this.rawTime()),this._ts=this._act=0):(Xu(),this._ts=this._rts,this.totalTime(this.parent&&!this.parent.smoothChildTiming?this.rawTime():this._tTime||this._pTime,this.progress()===1&&Math.abs(this._zTime)!==qr&&(this._tTime-=qr)))),this):this._ps},m.startTime=function(w){if(arguments.length){this._start=w;var I=this.parent||this._dp;return I&&(I._sort||!this.parent)&&ma(I,this,w-this._delay),this}return this._start},m.endTime=function(w){return this._start+(Go(w)?this.totalDuration():this.duration())/Math.abs(this._ts||1)},m.rawTime=function(w){var I=this.parent||this._dp;return I?w&&(!this._ts||this._repeat&&this._time&&this.totalProgress()<1)?this._tTime%(this._dur+this._rDelay):this._ts?N_(I.rawTime(w),this):this._tTime:this._tTime},m.revert=function(w){w===void 0&&(w=SC);var I=Xn;return Xn=w,O0(this)&&(this.timeline&&this.timeline.revert(w),this.totalTime(-.01,w.suppressEvents)),this.data!=="nested"&&w.kill!==!1&&this.kill(),Xn=I,this},m.globalTime=function(w){for(var I=this,n=arguments.length?w:I.rawTime();I;)n=I._start+n/(Math.abs(I._ts)||1),I=I._dp;return!this.parent&&this._sat?this._sat.globalTime(w):n},m.repeat=function(w){return arguments.length?(this._repeat=w===1/0?-2:w,zw(this)):this._repeat===-2?1/0:this._repeat},m.repeatDelay=function(w){if(arguments.length){var I=this._time;return this._rDelay=w,zw(this),I?this.time(I):this}return this._rDelay},m.yoyo=function(w){return arguments.length?(this._yoyo=w,this):this._yoyo},m.seek=function(w,I){return this.totalTime(ms(this,w),Go(I))},m.restart=function(w,I){return this.play().totalTime(w?-this._delay:0,Go(I)),this._dur||(this._zTime=-qr),this},m.play=function(w,I){return w!=null&&this.seek(w,I),this.reversed(!1).paused(!1)},m.reverse=function(w,I){return w!=null&&this.seek(w||this.totalDuration(),I),this.reversed(!0).paused(!1)},m.pause=function(w,I){return w!=null&&this.seek(w,I),this.paused(!0)},m.resume=function(){return this.paused(!1)},m.reversed=function(w){return arguments.length?(!!w!==this.reversed()&&this.timeScale(-this._rts||(w?-qr:0)),this):this._rts<0},m.invalidate=function(){return this._initted=this._act=0,this._zTime=-qr,this},m.isActive=function(){var w=this.parent||this._dp,I=this._start,n;return!!(!w||this._ts&&this._initted&&w.isActive()&&(n=w.rawTime(!0))>=I&&n<this.endTime(!0)-qr)},m.eventCallback=function(w,I,n){var O=this.vars;return arguments.length>1?(I?(O[w]=I,n&&(O[w+"Params"]=n),w==="onUpdate"&&(this._onUpdate=I)):delete O[w],this):O[w]},m.then=function(w){var I=this;return new Promise(function(n){var O=pn(w)?w:Zw,V=function(){var J=I.then;I.then=null,pn(O)&&(O=O(I))&&(O.then||O===I)&&(I.then=J),n(O),I.then=J};I._initted&&I.totalProgress()===1&&I._ts>=0||!I._tTime&&I._ts<0?V():I._prom=V})},m.kill=function(){cf(this)},S}();is(gf.prototype,{_time:0,_start:0,_end:0,_tTime:0,_tDur:0,_dirty:0,_repeat:0,_yoyo:!1,parent:null,_initted:!1,_rDelay:0,_ts:1,_dp:0,ratio:0,_zTime:-qr,_prom:0,_ps:!1,_rts:1});var Wn=function(S){Fw(m,S);function m(w,I){var n;return w===void 0&&(w={}),n=S.call(this,w)||this,n.labels={},n.smoothChildTiming=!!w.smoothChildTiming,n.autoRemoveChildren=!!w.autoRemoveChildren,n._sort=Go(w.sortChildren),sn&&ma(w.parent||sn,qa(n),I),w.reversed&&n.reverse(),w.paused&&n.paused(!0),w.scrollTrigger&&Yw(qa(n),w.scrollTrigger),n}var v=m.prototype;return v.to=function(I,n,O){return df(0,arguments,this),this},v.from=function(I,n,O){return df(1,arguments,this),this},v.fromTo=function(I,n,O,V){return df(2,arguments,this),this},v.set=function(I,n,O){return n.duration=0,n.parent=this,uf(n).repeatDelay||(n.repeat=0),n.immediateRender=!!n.immediateRender,new gn(I,n,ms(this,O),1),this},v.call=function(I,n,O){return ma(this,gn.delayedCall(0,I,n),O)},v.staggerTo=function(I,n,O,V,H,J,ae){return O.duration=n,O.stagger=O.stagger||V,O.onComplete=J,O.onCompleteParams=ae,O.parent=this,new gn(I,O,ms(this,H)),this},v.staggerFrom=function(I,n,O,V,H,J,ae){return O.runBackwards=1,uf(O).immediateRender=Go(O.immediateRender),this.staggerTo(I,n,O,V,H,J,ae)},v.staggerFromTo=function(I,n,O,V,H,J,ae,we){return V.startAt=O,uf(V).immediateRender=Go(V.immediateRender),this.staggerTo(I,n,V,H,J,ae,we)},v.render=function(I,n,O){var V=this._time,H=this._dirty?this.totalDuration():this._tDur,J=this._dur,ae=I<=0?0:Tn(I),we=this._zTime<0!=I<0&&(this._initted||!J),Ae,xe,Ge,Te,We,ft,_t,Pt,At,wt,Ct,Ft;if(this!==sn&&ae>H&&I>=0&&(ae=H),ae!==this._tTime||O||we){if(V!==this._time&&J&&(ae+=this._time-V,I+=this._time-V),Ae=ae,At=this._start,Pt=this._ts,ft=!Pt,we&&(J||(V=this._zTime),(I||!n)&&(this._zTime=I)),this._repeat){if(Ct=this._yoyo,We=J+this._rDelay,this._repeat<-1&&I<0)return this.totalTime(We*100+I,n,O);if(Ae=Tn(ae%We),ae===H?(Te=this._repeat,Ae=J):(wt=Tn(ae/We),Te=~~wt,Te&&Te===wt&&(Ae=J,Te--),Ae>J&&(Ae=J)),wt=Zu(this._tTime,We),!V&&this._tTime&&wt!==Te&&this._tTime-wt*We-this._dur<=0&&(wt=Te),Ct&&Te&1&&(Ae=J-Ae,Ft=1),Te!==wt&&!this._lock){var Wt=Ct&&wt&1,mt=Wt===(Ct&&Te&1);if(Te<wt&&(Wt=!Wt),V=Wt?0:ae%J?J:ae,this._lock=1,this.render(V||(Ft?0:Tn(Te*We)),n,!J)._lock=0,this._tTime=ae,!n&&this.parent&&es(this,"onRepeat"),this.vars.repeatRefresh&&!Ft&&(this.invalidate()._lock=1),V&&V!==this._time||ft!==!this._ts||this.vars.onRepeat&&!this.parent&&!this._act)return this;if(J=this._dur,H=this._tDur,mt&&(this._lock=2,V=Wt?J:-1e-4,this.render(V,!0),this.vars.repeatRefresh&&!Ft&&this.invalidate()),this._lock=0,!this._ts&&!ft)return this;hT(this,Ft)}}if(this._hasPause&&!this._forcing&&this._lock<2&&(_t=LC(this,Tn(V),Tn(Ae)),_t&&(ae-=Ae-(Ae=_t._start))),this._tTime=ae,this._time=Ae,this._act=!Pt,this._initted||(this._onUpdate=this.vars.onUpdate,this._initted=1,this._zTime=I,V=0),!V&&ae&&!n&&!wt&&(es(this,"onStart"),this._tTime!==ae))return this;if(Ae>=V&&I>=0)for(xe=this._first;xe;){if(Ge=xe._next,(xe._act||Ae>=xe._start)&&xe._ts&&_t!==xe){if(xe.parent!==this)return this.render(I,n,O);if(xe.render(xe._ts>0?(Ae-xe._start)*xe._ts:(xe._dirty?xe.totalDuration():xe._tDur)+(Ae-xe._start)*xe._ts,n,O),Ae!==this._time||!this._ts&&!ft){_t=0,Ge&&(ae+=this._zTime=-qr);break}}xe=Ge}else{xe=this._last;for(var er=I<0?I:Ae;xe;){if(Ge=xe._prev,(xe._act||er<=xe._end)&&xe._ts&&_t!==xe){if(xe.parent!==this)return this.render(I,n,O);if(xe.render(xe._ts>0?(er-xe._start)*xe._ts:(xe._dirty?xe.totalDuration():xe._tDur)+(er-xe._start)*xe._ts,n,O||Xn&&O0(xe)),Ae!==this._time||!this._ts&&!ft){_t=0,Ge&&(ae+=this._zTime=er?-qr:qr);break}}xe=Ge}}if(_t&&!n&&(this.pause(),_t.render(Ae>=V?0:-qr)._zTime=Ae>=V?1:-1,this._ts))return this._start=At,q_(this),this.render(I,n,O);this._onUpdate&&!n&&es(this,"onUpdate",!0),(ae===H&&this._tTime>=this.totalDuration()||!ae&&V)&&(At===this._start||Math.abs(Pt)!==Math.abs(this._ts))&&(this._lock||((I||!J)&&(ae===H&&this._ts>0||!ae&&this._ts<0)&&Yl(this,1),!n&&!(I<0&&!V)&&(ae||V||!H)&&(es(this,ae===H&&I>=0?"onComplete":"onReverseComplete",!0),this._prom&&!(ae<H&&this.timeScale()>0)&&this._prom())))}return this},v.add=function(I,n){var O=this;if($a(n)||(n=ms(this,n,I)),!(I instanceof gf)){if(no(I))return I.forEach(function(V){return O.add(V,n)}),this;if(Rn(I))return this.addLabel(I,n);if(pn(I))I=gn.delayedCall(0,I);else return this}return this!==I?ma(this,I,n):this},v.getChildren=function(I,n,O,V){I===void 0&&(I=!0),n===void 0&&(n=!0),O===void 0&&(O=!0),V===void 0&&(V=-_s);for(var H=[],J=this._first;J;)J._start>=V&&(J instanceof gn?n&&H.push(J):(O&&H.push(J),I&&H.push.apply(H,J.getChildren(!0,n,O)))),J=J._next;return H},v.getById=function(I){for(var n=this.getChildren(1,1,1),O=n.length;O--;)if(n[O].vars.id===I)return n[O]},v.remove=function(I){return Rn(I)?this.removeLabel(I):pn(I)?this.killTweensOf(I):(I.parent===this&&G_(this,I),I===this._recent&&(this._recent=this._last),ch(this))},v.totalTime=function(I,n){return arguments.length?(this._forcing=1,!this._dp&&this._ts&&(this._start=Tn(jo.time-(this._ts>0?I/this._ts:(this.totalDuration()-I)/-this._ts))),S.prototype.totalTime.call(this,I,n),this._forcing=0,this):this._tTime},v.addLabel=function(I,n){return this.labels[I]=ms(this,n),this},v.removeLabel=function(I){return delete this.labels[I],this},v.addPause=function(I,n,O){var V=gn.delayedCall(0,n||mf,O);return V.data="isPause",this._hasPause=1,ma(this,V,ms(this,I))},v.removePause=function(I){var n=this._first;for(I=ms(this,I);n;)n._start===I&&n.data==="isPause"&&Yl(n),n=n._next},v.killTweensOf=function(I,n,O){for(var V=this.getTweensOf(I,O),H=V.length;H--;)Zl!==V[H]&&V[H].kill(I,n);return this},v.getTweensOf=function(I,n){for(var O=[],V=gs(I),H=this._first,J=$a(n),ae;H;)H instanceof gn?EC(H._targets,V)&&(J?(!Zl||H._initted&&H._ts)&&H.globalTime(0)<=n&&H.globalTime(H.totalDuration())>n:!n||H.isActive())&&O.push(H):(ae=H.getTweensOf(V,n)).length&&O.push.apply(O,ae),H=H._next;return O},v.tweenTo=function(I,n){n=n||{};var O=this,V=ms(O,I),H=n,J=H.startAt,ae=H.onStart,we=H.onStartParams,Ae=H.immediateRender,xe,Ge=gn.to(O,is({ease:n.ease||"none",lazy:!1,immediateRender:!1,time:V,overwrite:"auto",duration:n.duration||Math.abs((V-(J&&"time"in J?J.time:O._time))/O.timeScale())||qr,onStart:function(){if(O.pause(),!xe){var We=n.duration||Math.abs((V-(J&&"time"in J?J.time:O._time))/O.timeScale());Ge._dur!==We&&Wu(Ge,We,0,1).render(Ge._time,!0,!0),xe=1}ae&&ae.apply(Ge,we||[])}},n));return Ae?Ge.render(0):Ge},v.tweenFromTo=function(I,n,O){return this.tweenTo(n,is({startAt:{time:ms(this,I)}},O))},v.recent=function(){return this._recent},v.nextLabel=function(I){return I===void 0&&(I=this._time),Dw(this,ms(this,I))},v.previousLabel=function(I){return I===void 0&&(I=this._time),Dw(this,ms(this,I),1)},v.currentLabel=function(I){return arguments.length?this.seek(I,!0):this.previousLabel(this._time+qr)},v.shiftChildren=function(I,n,O){O===void 0&&(O=0);for(var V=this._first,H=this.labels,J;V;)V._start>=O&&(V._start+=I,V._end+=I),V=V._next;if(n)for(J in H)H[J]>=O&&(H[J]+=I);return ch(this)},v.invalidate=function(I){var n=this._first;for(this._lock=0;n;)n.invalidate(I),n=n._next;return S.prototype.invalidate.call(this,I)},v.clear=function(I){I===void 0&&(I=!0);for(var n=this._first,O;n;)O=n._next,this.remove(n),n=O;return this._dp&&(this._time=this._tTime=this._pTime=0),I&&(this.labels={}),ch(this)},v.totalDuration=function(I){var n=0,O=this,V=O._last,H=_s,J,ae,we;if(arguments.length)return O.timeScale((O._repeat<0?O.duration():O.totalDuration())/(O.reversed()?-I:I));if(O._dirty){for(we=O.parent;V;)J=V._prev,V._dirty&&V.totalDuration(),ae=V._start,ae>H&&O._sort&&V._ts&&!O._lock?(O._lock=1,ma(O,V,ae-V._delay,1)._lock=0):H=ae,ae<0&&V._ts&&(n-=ae,(!we&&!O._dp||we&&we.smoothChildTiming)&&(O._start+=ae/O._ts,O._time-=ae,O._tTime-=ae),O.shiftChildren(-ae,!1,-1/0),H=0),V._end>n&&V._ts&&(n=V._end),V=J;Wu(O,O===sn&&O._time>n?O._time:n,1,1),O._dirty=0}return O._tDur},m.updateRoot=function(I){if(sn._ts&&(Hw(sn,N_(I,sn)),qw=jo.frame),jo.frame>=Pw){Pw+=qo.autoSleep||120;var n=sn._first;if((!n||!n._ts)&&qo.autoSleep&&jo._listeners.length<2){for(;n&&!n._ts;)n=n._next;n||jo.sleep()}}},m}(gf);is(Wn.prototype,{_lock:0,_hasPause:0,_forcing:0});var WC=function(m,v,w,I,n,O,V){var H=new Mo(this._pt,m,v,0,1,j0,null,n),J=0,ae=0,we,Ae,xe,Ge,Te,We,ft,_t;for(H.b=w,H.e=I,w+="",I+="",(ft=~I.indexOf("random("))&&(I=Yu(I)),O&&(_t=[w,I],O(_t,m,v),w=_t[0],I=_t[1]),Ae=w.match(l0)||[];we=l0.exec(I);)Ge=we[0],Te=I.substring(J,we.index),xe?xe=(xe+1)%5:Te.substr(-5)==="rgba("&&(xe=1),Ge!==Ae[ae++]&&(We=parseFloat(Ae[ae-1])||0,H._pt={_next:H._pt,p:Te||ae===1?Te:",",s:We,c:Ge.charAt(1)==="="?ph(We,Ge)-We:parseFloat(Ge)-We,m:xe&&xe<4?Math.round:0},J=l0.lastIndex);return H.c=J<I.length?I.substring(J,I.length):"",H.fp=V,(C0.test(I)||ft)&&(H.e=0),this._pt=H,H},B0=function(m,v,w,I,n,O,V,H,J,ae){pn(I)&&(I=I(n||0,m,O));var we=m[v],Ae=w!=="get"?w:pn(we)?J?m[v.indexOf("set")||!pn(m["get"+v.substr(3)])?v:"get"+v.substr(3)](J):m[v]():we,xe=pn(we)?J?QC:fT:U0,Ge;if(Rn(I)&&(~I.indexOf("random(")&&(I=Yu(I)),I.charAt(1)==="="&&(Ge=ph(Ae,I)+(Yn(Ae)||0),(Ge||Ge===0)&&(I=Ge))),!ae||Ae!==I||S0)return!isNaN(Ae*I)&&I!==""?(Ge=new Mo(this._pt,m,v,+Ae||0,I-(Ae||0),typeof we=="boolean"?tP:mT,0,xe),J&&(Ge.fp=J),V&&Ge.modifier(V,this,m),this._pt=Ge):(!we&&!(v in m)&&j_(v,I),WC.call(this,m,v,Ae,I,xe,H||qo.stringFilter,J))},XC=function(m,v,w,I,n){if(pn(m)&&(m=pf(m,n,v,w,I)),!_a(m)||m.style&&m.nodeType||no(m)||Nw(m))return Rn(m)?pf(m,n,v,w,I):m;var O={},V;for(V in m)O[V]=pf(m[V],n,v,w,I);return O},N0=function(m,v,w,I,n,O){var V,H,J,ae;if(Uo[m]&&(V=new Uo[m]).init(n,V.rawVars?v[m]:XC(v[m],I,n,O,w),w,I,O)!==!1&&(w._pt=H=new Mo(w._pt,n,m,0,1,V.render,V,0,V.priority),w!==qu))for(J=w._ptLookup[w._targets.indexOf(n)],ae=V._props.length;ae--;)J[V._props[ae]]=H;return V},Zl,S0,V0=function S(m,v,w){var I=m.vars,n=I.ease,O=I.startAt,V=I.immediateRender,H=I.lazy,J=I.onUpdate,ae=I.runBackwards,we=I.yoyoEase,Ae=I.keyframes,xe=I.autoRevert,Ge=m._dur,Te=m._startAt,We=m._targets,ft=m.parent,_t=ft&&ft.data==="nested"?ft.vars.targets:We,Pt=m._overwrite==="auto"&&!I0,At=m.timeline,wt,Ct,Ft,Wt,mt,er,Ni,yi,mi,vi,mr,Fr,Rr;if(At&&(!Ae||!n)&&(n="none"),m._ease=hh(n,Hu.ease),m._yEase=we?cT(hh(we===!0?n:we,Hu.ease)):0,we&&m._yoyo&&!m._repeat&&(we=m._yEase,m._yEase=m._ease,m._ease=we),m._from=!At&&!!I.runBackwards,!At||Ae&&!I.stagger){if(yi=We[0]?Xl(We[0]).harness:0,Fr=yi&&I[yi.prop],wt=B_(I,R0),Te&&(Te._zTime<0&&Te.progress(1),v<0&&ae&&V&&!xe?Te.render(-1,!0):Te.revert(ae&&Ge?z_:TC),Te._lazy=0),O){if(Yl(m._startAt=gn.set(We,is({data:"isStart",overwrite:!1,parent:ft,immediateRender:!0,lazy:!Te&&Go(H),startAt:null,delay:0,onUpdate:J&&function(){return es(m,"onUpdate")},stagger:0},O))),m._startAt._dp=0,m._startAt._sat=m,v<0&&(Xn||!V&&!xe)&&m._startAt.revert(z_),V&&Ge&&v<=0&&w<=0){v&&(m._zTime=v);return}}else if(ae&&Ge&&!Te){if(v&&(V=!1),Ft=is({overwrite:!1,data:"isFromStart",lazy:V&&!Te&&Go(H),immediateRender:V,stagger:0,parent:ft},wt),Fr&&(Ft[yi.prop]=Fr),Yl(m._startAt=gn.set(We,Ft)),m._startAt._dp=0,m._startAt._sat=m,v<0&&(Xn?m._startAt.revert(z_):m._startAt.render(-1,!0)),m._zTime=v,!V)S(m._startAt,qr,qr);else if(!v)return}for(m._pt=m._ptCache=0,H=Ge&&Go(H)||H&&!Ge,Ct=0;Ct<We.length;Ct++){if(mt=We[Ct],Ni=mt._gsap||z0(We)[Ct]._gsap,m._ptLookup[Ct]=vi={},y0[Ni.id]&&Wl.length&&F_(),mr=_t===We?Ct:_t.indexOf(mt),yi&&(mi=new yi).init(mt,Fr||wt,m,mr,_t)!==!1&&(m._pt=Wt=new Mo(m._pt,mt,mi.name,0,1,mi.render,mi,0,mi.priority),mi._props.forEach(function(Hr){vi[Hr]=Wt}),mi.priority&&(er=1)),!yi||Fr)for(Ft in wt)Uo[Ft]&&(mi=N0(Ft,wt,m,mr,mt,_t))?mi.priority&&(er=1):vi[Ft]=Wt=B0.call(m,mt,Ft,"get",wt[Ft],mr,_t,0,I.stringFilter);m._op&&m._op[Ct]&&m.kill(mt,m._op[Ct]),Pt&&m._pt&&(Zl=m,sn.killTweensOf(mt,vi,m.globalTime(v)),Rr=!m.parent,Zl=0),m._pt&&H&&(y0[Ni.id]=1)}er&&q0(m),m._onInit&&m._onInit(m)}m._onUpdate=J,m._initted=(!m._op||m._pt)&&!Rr,Ae&&v<=0&&At.render(_s,!0,!0)},YC=function(m,v,w,I,n,O,V,H){var J=(m._pt&&m._ptCache||(m._ptCache={}))[v],ae,we,Ae,xe;if(!J)for(J=m._ptCache[v]=[],Ae=m._ptLookup,xe=m._targets.length;xe--;){if(ae=Ae[xe][v],ae&&ae.d&&ae.d._pt)for(ae=ae.d._pt;ae&&ae.p!==v&&ae.fp!==v;)ae=ae._next;if(!ae)return S0=1,m.vars[v]="+=0",V0(m,V),S0=0,H?ff(v+" not eligible for reset"):1;J.push(ae)}for(xe=J.length;xe--;)we=J[xe],ae=we._pt||we,ae.s=(I||I===0)&&!n?I:ae.s+(I||0)+O*ae.c,ae.c=w-ae.s,we.e&&(we.e=fn(w)+Yn(we.e)),we.b&&(we.b=ae.s+Yn(we.b))},KC=function(m,v){var w=m[0]?Xl(m[0]).harness:0,I=w&&w.aliases,n,O,V,H;if(!I)return v;n=$u({},v);for(O in I)if(O in n)for(H=I[O].split(","),V=H.length;V--;)n[H[V]]=n[O];return n},JC=function(m,v,w,I){var n=v.ease||I||"power1.inOut",O,V;if(no(v))V=w[m]||(w[m]=[]),v.forEach(function(H,J){return V.push({t:J/(v.length-1)*100,v:H,e:n})});else for(O in v)V=w[O]||(w[O]=[]),O==="ease"||V.push({t:parseFloat(m),v:v[O],e:n})},pf=function(m,v,w,I,n){return pn(m)?m.call(v,w,I,n):Rn(m)&&~m.indexOf("random(")?Yu(m):m},dT=L0+"repeat,repeatDelay,yoyo,repeatRefresh,yoyoEase,autoRevert",pT={};Ao(dT+",id,stagger,delay,duration,paused,scrollTrigger",function(S){return pT[S]=1});var gn=function(S){Fw(m,S);function m(w,I,n,O){var V;typeof I=="number"&&(n.duration=I,I=n,n=null),V=S.call(this,O?I:uf(I))||this;var H=V.vars,J=H.duration,ae=H.delay,we=H.immediateRender,Ae=H.stagger,xe=H.overwrite,Ge=H.keyframes,Te=H.defaults,We=H.scrollTrigger,ft=H.yoyoEase,_t=I.parent||sn,Pt=(no(w)||Nw(w)?$a(w[0]):"length"in I)?[w]:gs(w),At,wt,Ct,Ft,Wt,mt,er,Ni;if(V._targets=Pt.length?z0(Pt):ff("GSAP target "+w+" not found. https://gsap.com",!qo.nullTargetWarn)||[],V._ptLookup=[],V._overwrite=xe,Ge||Ae||L_(J)||L_(ae)){if(I=V.vars,At=V.timeline=new Wn({data:"nested",defaults:Te||{},targets:_t&&_t.data==="nested"?_t.vars.targets:Pt}),At.kill(),At.parent=At._dp=qa(V),At._start=0,Ae||L_(J)||L_(ae)){if(Ft=Pt.length,er=Ae&&eT(Ae),_a(Ae))for(Wt in Ae)~dT.indexOf(Wt)&&(Ni||(Ni={}),Ni[Wt]=Ae[Wt]);for(wt=0;wt<Ft;wt++)Ct=B_(I,pT),Ct.stagger=0,ft&&(Ct.yoyoEase=ft),Ni&&$u(Ct,Ni),mt=Pt[wt],Ct.duration=+pf(J,qa(V),wt,mt,Pt),Ct.delay=(+pf(ae,qa(V),wt,mt,Pt)||0)-V._delay,!Ae&&Ft===1&&Ct.delay&&(V._delay=ae=Ct.delay,V._start+=ae,Ct.delay=0),At.to(mt,Ct,er?er(wt,mt,Pt):0),At._ease=br.none;At.duration()?J=ae=0:V.timeline=0}else if(Ge){uf(is(At.vars.defaults,{ease:"none"})),At._ease=hh(Ge.ease||I.ease||"none");var yi=0,mi,vi,mr;if(no(Ge))Ge.forEach(function(Fr){return At.to(Pt,Fr,">")}),At.duration();else{Ct={};for(Wt in Ge)Wt==="ease"||Wt==="easeEach"||JC(Wt,Ge[Wt],Ct,Ge.easeEach);for(Wt in Ct)for(mi=Ct[Wt].sort(function(Fr,Rr){return Fr.t-Rr.t}),yi=0,wt=0;wt<mi.length;wt++)vi=mi[wt],mr={ease:vi.e,duration:(vi.t-(wt?mi[wt-1].t:0))/100*J},mr[Wt]=vi.v,At.to(Pt,mr,yi),yi+=mr.duration;At.duration()<J&&At.to({},{duration:J-At.duration()})}}J||V.duration(J=At.duration())}else V.timeline=0;return xe===!0&&!I0&&(Zl=qa(V),sn.killTweensOf(Pt),Zl=0),ma(_t,qa(V),n),I.reversed&&V.reverse(),I.paused&&V.paused(!0),(we||!J&&!Ge&&V._start===Tn(_t._time)&&Go(we)&&CC(qa(V))&&_t.data!=="nested")&&(V._tTime=-qr,V.render(Math.max(0,-ae)||0)),We&&Yw(qa(V),We),V}var v=m.prototype;return v.render=function(I,n,O){var V=this._time,H=this._tDur,J=this._dur,ae=I<0,we=I>H-qr&&!ae?H:I<qr?0:I,Ae,xe,Ge,Te,We,ft,_t,Pt,At;if(!J)RC(this,I,n,O);else if(we!==this._tTime||!I||O||!this._initted&&this._tTime||this._startAt&&this._zTime<0!==ae||this._lazy){if(Ae=we,Pt=this.timeline,this._repeat){if(Te=J+this._rDelay,this._repeat<-1&&ae)return this.totalTime(Te*100+I,n,O);if(Ae=Tn(we%Te),we===H?(Ge=this._repeat,Ae=J):(We=Tn(we/Te),Ge=~~We,Ge&&Ge===We?(Ae=J,Ge--):Ae>J&&(Ae=J)),ft=this._yoyo&&Ge&1,ft&&(At=this._yEase,Ae=J-Ae),We=Zu(this._tTime,Te),Ae===V&&!O&&this._initted&&Ge===We)return this._tTime=we,this;Ge!==We&&(Pt&&this._yEase&&hT(Pt,ft),this.vars.repeatRefresh&&!ft&&!this._lock&&Ae!==Te&&this._initted&&(this._lock=O=1,this.render(Tn(Te*Ge),!0).invalidate()._lock=0))}if(!this._initted){if(Kw(this,ae?I:Ae,O,n,we))return this._tTime=0,this;if(V!==this._time&&!(O&&this.vars.repeatRefresh&&Ge!==We))return this;if(J!==this._dur)return this.render(I,n,O)}if(this._tTime=we,this._time=Ae,!this._act&&this._ts&&(this._act=1,this._lazy=0),this.ratio=_t=(At||this._ease)(Ae/J),this._from&&(this.ratio=_t=1-_t),!V&&we&&!n&&!We&&(es(this,"onStart"),this._tTime!==we))return this;for(xe=this._pt;xe;)xe.r(_t,xe.d),xe=xe._next;Pt&&Pt.render(I<0?I:Pt._dur*Pt._ease(Ae/this._dur),n,O)||this._startAt&&(this._zTime=I),this._onUpdate&&!n&&(ae&&x0(this,I,n,O),es(this,"onUpdate")),this._repeat&&Ge!==We&&this.vars.onRepeat&&!n&&this.parent&&es(this,"onRepeat"),(we===this._tDur||!we)&&this._tTime===we&&(ae&&!this._onUpdate&&x0(this,I,!0,!0),(I||!J)&&(we===this._tDur&&this._ts>0||!we&&this._ts<0)&&Yl(this,1),!n&&!(ae&&!V)&&(we||V||ft)&&(es(this,we===H?"onComplete":"onReverseComplete",!0),this._prom&&!(we<H&&this.timeScale()>0)&&this._prom()))}return this},v.targets=function(){return this._targets},v.invalidate=function(I){return(!I||!this.vars.runBackwards)&&(this._startAt=0),this._pt=this._op=this._onUpdate=this._lazy=this.ratio=0,this._ptLookup=[],this.timeline&&this.timeline.invalidate(I),S.prototype.invalidate.call(this,I)},v.resetTo=function(I,n,O,V,H){_f||jo.wake(),this._ts||this.play();var J=Math.min(this._dur,(this._dp._time-this._start)*this._ts),ae;return this._initted||V0(this,J),ae=this._ease(J/this._dur),YC(this,I,n,O,V,ae,J,H)?this.resetTo(I,n,O,V,1):(H_(this,0),this.parent||Ww(this._dp,this,"_first","_last",this._dp._sort?"_start":0),this.render(0))},v.kill=function(I,n){if(n===void 0&&(n="all"),!I&&(!n||n==="all"))return this._lazy=this._pt=0,this.parent?cf(this):this.scrollTrigger&&this.scrollTrigger.kill(!!Xn),this;if(this.timeline){var O=this.timeline.totalDuration();return this.timeline.killTweensOf(I,n,Zl&&Zl.vars.overwrite!==!0)._first||cf(this),this.parent&&O!==this.timeline.totalDuration()&&Wu(this,this._dur*this.timeline._tDur/O,0,1),this}var V=this._targets,H=I?gs(I):V,J=this._ptLookup,ae=this._pt,we,Ae,xe,Ge,Te,We,ft;if((!n||n==="all")&&AC(V,H))return n==="all"&&(this._pt=0),cf(this);for(we=this._op=this._op||[],n!=="all"&&(Rn(n)&&(Te={},Ao(n,function(_t){return Te[_t]=1}),n=Te),n=KC(V,n)),ft=V.length;ft--;)if(~H.indexOf(V[ft])){Ae=J[ft],n==="all"?(we[ft]=n,Ge=Ae,xe={}):(xe=we[ft]=we[ft]||{},Ge=n);for(Te in Ge)We=Ae&&Ae[Te],We&&((!("kill"in We.d)||We.d.kill(Te)===!0)&&G_(this,We,"_pt"),delete Ae[Te]),xe!=="all"&&(xe[Te]=1)}return this._initted&&!this._pt&&ae&&cf(this),this},m.to=function(I,n){return new m(I,n,arguments[2])},m.from=function(I,n){return df(1,arguments)},m.delayedCall=function(I,n,O,V){return new m(n,0,{immediateRender:!1,lazy:!1,overwrite:!1,delay:I,onComplete:n,onReverseComplete:n,onCompleteParams:O,onReverseCompleteParams:O,callbackScope:V})},m.fromTo=function(I,n,O){return df(2,arguments)},m.set=function(I,n){return n.duration=0,n.repeatDelay||(n.repeat=0),new m(I,n)},m.killTweensOf=function(I,n,O){return sn.killTweensOf(I,n,O)},m}(gf);is(gn.prototype,{_targets:[],_lazy:0,_startAt:0,_op:0,_onInit:0});Ao("staggerTo,staggerFrom,staggerFromTo",function(S){gn[S]=function(){var m=new Wn,v=b0.call(arguments,0);return v.splice(S==="staggerFromTo"?5:4,0,0),m[S].apply(m,v)}});var U0=function(m,v,w){return m[v]=w},fT=function(m,v,w){return m[v](w)},QC=function(m,v,w,I){return m[v](I.fp,w)},eP=function(m,v,w){return m.setAttribute(v,w)},$_=function(m,v){return pn(m[v])?fT:U_(m[v])&&m.setAttribute?eP:U0},mT=function(m,v){return v.set(v.t,v.p,Math.round((v.s+v.c*m)*1e6)/1e6,v)},tP=function(m,v){return v.set(v.t,v.p,!!(v.s+v.c*m),v)},j0=function(m,v){var w=v._pt,I="";if(!m&&v.b)I=v.b;else if(m===1&&v.e)I=v.e;else{for(;w;)I=w.p+(w.m?w.m(w.s+w.c*m):Math.round((w.s+w.c*m)*1e4)/1e4)+I,w=w._next;I+=v.c}v.set(v.t,v.p,I,v)},G0=function(m,v){for(var w=v._pt;w;)w.r(m,w.d),w=w._next},iP=function(m,v,w,I){for(var n=this._pt,O;n;)O=n._next,n.p===I&&n.modifier(m,v,w),n=O},rP=function(m){for(var v=this._pt,w,I;v;)I=v._next,v.p===m&&!v.op||v.op===m?G_(this,v,"_pt"):v.dep||(w=1),v=I;return!w},nP=function(m,v,w,I){I.mSet(m,v,I.m.call(I.tween,w,I.mt),I)},q0=function(m){for(var v=m._pt,w,I,n,O;v;){for(w=v._next,I=n;I&&I.pr>v.pr;)I=I._next;(v._prev=I?I._prev:O)?v._prev._next=v:n=v,(v._next=I)?I._prev=v:O=v,v=w}m._pt=n},Mo=function(){function S(v,w,I,n,O,V,H,J,ae){this.t=w,this.s=n,this.c=O,this.p=I,this.r=V||mT,this.d=H||this,this.set=J||U0,this.pr=ae||0,this._next=v,v&&(v._prev=this)}var m=S.prototype;return m.modifier=function(w,I,n){this.mSet=this.mSet||this.set,this.set=nP,this.m=w,this.mt=n,this.tween=I},S}();Ao(L0+"parent,duration,ease,delay,overwrite,runBackwards,startAt,yoyo,immediateRender,repeat,repeatDelay,data,paused,reversed,lazy,callbackScope,stringFilter,id,yoyoEase,stagger,inherit,repeatRefresh,keyframes,autoRevert,scrollTrigger",function(S){return R0[S]=1});ts.TweenMax=ts.TweenLite=gn;ts.TimelineLite=ts.TimelineMax=Wn;sn=new Wn({sortChildren:!1,defaults:Hu,autoRemoveChildren:!0,id:"root",smoothChildTiming:!0});qo.stringFilter=k0;var uh=[],O_={},oP=[],kw=0,sP=0,p0=function(m){return(O_[m]||oP).map(function(v){return v()})},E0=function(){var m=Date.now(),v=[];m-kw>2&&(p0("matchMediaInit"),uh.forEach(function(w){var I=w.queries,n=w.conditions,O,V,H,J;for(V in I)O=fa.matchMedia(I[V]).matches,O&&(H=1),O!==n[V]&&(n[V]=O,J=1);J&&(w.revert(),H&&v.push(w))}),p0("matchMediaRevert"),v.forEach(function(w){return w.onMatch(w,function(I){return w.add(null,I)})}),kw=m,p0("matchMedia"))},_T=function(){function S(v,w){this.selector=w&&w0(w),this.data=[],this._r=[],this.isReverted=!1,this.id=sP++,v&&this.add(v)}var m=S.prototype;return m.add=function(w,I,n){pn(w)&&(n=I,I=w,w=pn);var O=this,V=function(){var J=nn,ae=O.selector,we;return J&&J!==O&&J.data.push(O),n&&(O.selector=w0(n)),nn=O,we=I.apply(O,arguments),pn(we)&&O._r.push(we),nn=J,O.selector=ae,O.isReverted=!1,we};return O.last=V,w===pn?V(O,function(H){return O.add(null,H)}):w?O[w]=V:V},m.ignore=function(w){var I=nn;nn=null,w(this),nn=I},m.getTweens=function(){var w=[];return this.data.forEach(function(I){return I instanceof S?w.push.apply(w,I.getTweens()):I instanceof gn&&!(I.parent&&I.parent.data==="nested")&&w.push(I)}),w},m.clear=function(){this._r.length=this.data.length=0},m.kill=function(w,I){var n=this;if(w?function(){for(var V=n.getTweens(),H=n.data.length,J;H--;)J=n.data[H],J.data==="isFlip"&&(J.revert(),J.getChildren(!0,!0,!1).forEach(function(ae){return V.splice(V.indexOf(ae),1)}));for(V.map(function(ae){return{g:ae._dur||ae._delay||ae._sat&&!ae._sat.vars.immediateRender?ae.globalTime(0):-1/0,t:ae}}).sort(function(ae,we){return we.g-ae.g||-1/0}).forEach(function(ae){return ae.t.revert(w)}),H=n.data.length;H--;)J=n.data[H],J instanceof Wn?J.data!=="nested"&&(J.scrollTrigger&&J.scrollTrigger.revert(),J.kill()):!(J instanceof gn)&&J.revert&&J.revert(w);n._r.forEach(function(ae){return ae(w,n)}),n.isReverted=!0}():this.data.forEach(function(V){return V.kill&&V.kill()}),this.clear(),I)for(var O=uh.length;O--;)uh[O].id===this.id&&uh.splice(O,1)},m.revert=function(w){this.kill(w||{})},S}(),aP=function(){function S(v){this.contexts=[],this.scope=v,nn&&nn.data.push(this)}var m=S.prototype;return m.add=function(w,I,n){_a(w)||(w={matches:w});var O=new _T(0,n||this.scope),V=O.conditions={},H,J,ae;nn&&!O.selector&&(O.selector=nn.selector),this.contexts.push(O),I=O.add("onMatch",I),O.queries=w;for(J in w)J==="all"?ae=1:(H=fa.matchMedia(w[J]),H&&(uh.indexOf(O)<0&&uh.push(O),(V[J]=H.matches)&&(ae=1),H.addListener?H.addListener(E0):H.addEventListener("change",E0)));return ae&&I(O,function(we){return O.add(null,we)}),this},m.revert=function(w){this.kill(w||{})},m.kill=function(w){this.contexts.forEach(function(I){return I.kill(w,!0)})},S}(),V_={registerPlugin:function(){for(var m=arguments.length,v=new Array(m),w=0;w<m;w++)v[w]=arguments[w];v.forEach(function(I){return sT(I)})},timeline:function(m){return new Wn(m)},getTweensOf:function(m,v){return sn.getTweensOf(m,v)},getProperty:function(m,v,w,I){Rn(m)&&(m=gs(m)[0]);var n=Xl(m||{}).get,O=w?Zw:$w;return w==="native"&&(w=""),m&&(v?O((Uo[v]&&Uo[v].get||n)(m,v,w,I)):function(V,H,J){return O((Uo[V]&&Uo[V].get||n)(m,V,H,J))})},quickSetter:function(m,v,w){if(m=gs(m),m.length>1){var I=m.map(function(ae){return oo.quickSetter(ae,v,w)}),n=I.length;return function(ae){for(var we=n;we--;)I[we](ae)}}m=m[0]||{};var O=Uo[v],V=Xl(m),H=V.harness&&(V.harness.aliases||{})[v]||v,J=O?function(ae){var we=new O;qu._pt=0,we.init(m,w?ae+w:ae,qu,0,[m]),we.render(1,we),qu._pt&&G0(1,qu)}:V.set(m,H);return O?J:function(ae){return J(m,H,w?ae+w:ae,V,1)}},quickTo:function(m,v,w){var I,n=oo.to(m,is((I={},I[v]="+=0.1",I.paused=!0,I.stagger=0,I),w||{})),O=function(H,J,ae){return n.resetTo(v,H,J,ae)};return O.tween=n,O},isTweening:function(m){return sn.getTweensOf(m,!0).length>0},defaults:function(m){return m&&m.ease&&(m.ease=hh(m.ease,Hu.ease)),Rw(Hu,m||{})},config:function(m){return Rw(qo,m||{})},registerEffect:function(m){var v=m.name,w=m.effect,I=m.plugins,n=m.defaults,O=m.extendTimeline;(I||"").split(",").forEach(function(V){return V&&!Uo[V]&&!ts[V]&&ff(v+" effect requires "+V+" plugin.")}),c0[v]=function(V,H,J){return w(gs(V),is(H||{},n),J)},O&&(Wn.prototype[v]=function(V,H,J){return this.add(c0[v](V,_a(H)?H:(J=H)&&{},this),J)})},registerEase:function(m,v){br[m]=hh(v)},parseEase:function(m,v){return arguments.length?hh(m,v):br},getById:function(m){return sn.getById(m)},exportRoot:function(m,v){m===void 0&&(m={});var w=new Wn(m),I,n;for(w.smoothChildTiming=Go(m.smoothChildTiming),sn.remove(w),w._dp=0,w._time=w._tTime=sn._time,I=sn._first;I;)n=I._next,(v||!(!I._dur&&I instanceof gn&&I.vars.onComplete===I._targets[0]))&&ma(w,I,I._start-I._delay),I=n;return ma(sn,w,0),w},context:function(m,v){return m?new _T(m,v):nn},matchMedia:function(m){return new aP(m)},matchMediaRefresh:function(){return uh.forEach(function(m){var v=m.conditions,w,I;for(I in v)v[I]&&(v[I]=!1,w=1);w&&m.revert()})||E0()},addEventListener:function(m,v){var w=O_[m]||(O_[m]=[]);~w.indexOf(v)||w.push(v)},removeEventListener:function(m,v){var w=O_[m],I=w&&w.indexOf(v);I>=0&&w.splice(I,1)},utils:{wrap:NC,wrapYoyo:VC,distribute:eT,random:iT,snap:tT,normalize:BC,getUnit:Yn,clamp:DC,splitColor:aT,toArray:gs,selector:w0,mapRange:nT,pipe:kC,unitize:FC,interpolate:UC,shuffle:Qw},install:jw,effects:c0,ticker:jo,updateRoot:Wn.updateRoot,plugins:Uo,globalTimeline:sn,core:{PropTween:Mo,globals:Gw,Tween:gn,Timeline:Wn,Animation:gf,getCache:Xl,_removeLinkedListItem:G_,reverting:function(){return Xn},context:function(m){return m&&nn&&(nn.data.push(m),m._ctx=nn),nn},suppressOverwrites:function(m){return I0=m}}};Ao("to,from,fromTo,delayedCall,set,killTweensOf",function(S){return V_[S]=gn[S]});jo.add(Wn.updateRoot);qu=V_.to({},{duration:0});var lP=function(m,v){for(var w=m._pt;w&&w.p!==v&&w.op!==v&&w.fp!==v;)w=w._next;return w},cP=function(m,v){var w=m._targets,I,n,O;for(I in v)for(n=w.length;n--;)O=m._ptLookup[n][I],O&&(O=O.d)&&(O._pt&&(O=lP(O,I)),O&&O.modifier&&O.modifier(v[I],m,w[n],I))},f0=function(m,v){return{name:m,headless:1,rawVars:1,init:function(I,n,O){O._onInit=function(V){var H,J;if(Rn(n)&&(H={},Ao(n,function(ae){return H[ae]=1}),n=H),v){H={};for(J in n)H[J]=v(n[J]);n=H}cP(V,n)}}}},oo=V_.registerPlugin({name:"attr",init:function(m,v,w,I,n){var O,V,H;this.tween=w;for(O in v)H=m.getAttribute(O)||"",V=this.add(m,"setAttribute",(H||0)+"",v[O],I,n,0,0,O),V.op=O,V.b=H,this._props.push(O)},render:function(m,v){for(var w=v._pt;w;)Xn?w.set(w.t,w.p,w.b,w):w.r(m,w.d),w=w._next}},{name:"endArray",headless:1,init:function(m,v){for(var w=v.length;w--;)this.add(m,w,m[w]||0,v[w],0,0,0,0,0,1)}},f0("roundProps",T0),f0("modifiers"),f0("snap",tT))||V_;gn.version=Wn.version=oo.version="3.13.0";Uw=1;A0()&&Xu();var hP=br.Power0,uP=br.Power1,dP=br.Power2,pP=br.Power3,fP=br.Power4,mP=br.Linear,_P=br.Quad,gP=br.Cubic,yP=br.Quart,xP=br.Quint,vP=br.Strong,bP=br.Elastic,wP=br.Back,TP=br.SteppedEase,SP=br.Bounce,EP=br.Sine,IP=br.Expo,AP=br.Circ;var gT,Jl,Ju,Y0,yh,MP,yT,K0,CP=function(){return typeof window<"u"},Wa={},gh=180/Math.PI,Qu=Math.PI/180,Ku=Math.atan2,xT=1e8,J0=/([A-Z])/g,PP=/(left|right|width|margin|padding|x)/i,RP=/[\s,\(]\S/,ga={autoAlpha:"opacity,visibility",scale:"scaleX,scaleY",alpha:"opacity"},$0=function(m,v){return v.set(v.t,v.p,Math.round((v.s+v.c*m)*1e4)/1e4+v.u,v)},LP=function(m,v){return v.set(v.t,v.p,m===1?v.e:Math.round((v.s+v.c*m)*1e4)/1e4+v.u,v)},zP=function(m,v){return v.set(v.t,v.p,m?Math.round((v.s+v.c*m)*1e4)/1e4+v.u:v.b,v)},DP=function(m,v){var w=v.s+v.c*m;v.set(v.t,v.p,~~(w+(w<0?-.5:.5))+v.u,v)},AT=function(m,v){return v.set(v.t,v.p,m?v.e:v.b,v)},MT=function(m,v){return v.set(v.t,v.p,m!==1?v.b:v.e,v)},OP=function(m,v,w){return m.style[v]=w},kP=function(m,v,w){return m.style.setProperty(v,w)},FP=function(m,v,w){return m._gsap[v]=w},BP=function(m,v,w){return m._gsap.scaleX=m._gsap.scaleY=w},NP=function(m,v,w,I,n){var O=m._gsap;O.scaleX=O.scaleY=w,O.renderTransform(n,O)},VP=function(m,v,w,I,n){var O=m._gsap;O[v]=w,O.renderTransform(n,O)},an="transform",Ho=an+"Origin",UP=function S(m,v){var w=this,I=this.target,n=I.style,O=I._gsap;if(m in Wa&&n){if(this.tfm=this.tfm||{},m!=="transform")m=ga[m]||m,~m.indexOf(",")?m.split(",").forEach(function(V){return w.tfm[V]=Za(I,V)}):this.tfm[m]=O.x?O[m]:Za(I,m),m===Ho&&(this.tfm.zOrigin=O.zOrigin);else return ga.transform.split(",").forEach(function(V){return S.call(w,V,v)});if(this.props.indexOf(an)>=0)return;O.svg&&(this.svgo=I.getAttribute("data-svg-origin"),this.props.push(Ho,v,"")),m=an}(n||v)&&this.props.push(m,v,n[m])},CT=function(m){m.translate&&(m.removeProperty("translate"),m.removeProperty("scale"),m.removeProperty("rotate"))},jP=function(){var m=this.props,v=this.target,w=v.style,I=v._gsap,n,O;for(n=0;n<m.length;n+=3)m[n+1]?m[n+1]===2?v[m[n]](m[n+2]):v[m[n]]=m[n+2]:m[n+2]?w[m[n]]=m[n+2]:w.removeProperty(m[n].substr(0,2)==="--"?m[n]:m[n].replace(J0,"-$1").toLowerCase());if(this.tfm){for(O in this.tfm)I[O]=this.tfm[O];I.svg&&(I.renderTransform(),v.setAttribute("data-svg-origin",this.svgo||"")),n=K0(),(!n||!n.isStart)&&!w[an]&&(CT(w),I.zOrigin&&w[Ho]&&(w[Ho]+=" "+I.zOrigin+"px",I.zOrigin=0,I.renderTransform()),I.uncache=1)}},PT=function(m,v){var w={target:m,props:[],revert:jP,save:UP};return m._gsap||oo.core.getCache(m),v&&m.style&&m.nodeType&&v.split(",").forEach(function(I){return w.save(I)}),w},RT,Z0=function(m,v){var w=Jl.createElementNS?Jl.createElementNS((v||"http://www.w3.org/1999/xhtml").replace(/^https/,"http"),m):Jl.createElement(m);return w&&w.style?w:Jl.createElement(m)},ys=function S(m,v,w){var I=getComputedStyle(m);return I[v]||I.getPropertyValue(v.replace(J0,"-$1").toLowerCase())||I.getPropertyValue(v)||!w&&S(m,ed(v)||v,1)||""},vT="O,Moz,ms,Ms,Webkit".split(","),ed=function(m,v,w){var I=v||yh,n=I.style,O=5;if(m in n&&!w)return m;for(m=m.charAt(0).toUpperCase()+m.substr(1);O--&&!(vT[O]+m in n););return O<0?null:(O===3?"ms":O>=0?vT[O]:"")+m},W0=function(){CP()&&window.document&&(gT=window,Jl=gT.document,Ju=Jl.documentElement,yh=Z0("div")||{style:{}},MP=Z0("div"),an=ed(an),Ho=an+"Origin",yh.style.cssText="border-width:0;line-height:0;position:absolute;padding:0",RT=!!ed("perspective"),K0=oo.core.reverting,Y0=1)},bT=function(m){var v=m.ownerSVGElement,w=Z0("svg",v&&v.getAttribute("xmlns")||"http://www.w3.org/2000/svg"),I=m.cloneNode(!0),n;I.style.display="block",w.appendChild(I),Ju.appendChild(w);try{n=I.getBBox()}catch{}return w.removeChild(I),Ju.removeChild(w),n},wT=function(m,v){for(var w=v.length;w--;)if(m.hasAttribute(v[w]))return m.getAttribute(v[w])},LT=function(m){var v,w;try{v=m.getBBox()}catch{v=bT(m),w=1}return v&&(v.width||v.height)||w||(v=bT(m)),v&&!v.width&&!v.x&&!v.y?{x:+wT(m,["x","cx","x1"])||0,y:+wT(m,["y","cy","y1"])||0,width:0,height:0}:v},zT=function(m){return!!(m.getCTM&&(!m.parentNode||m.ownerSVGElement)&&LT(m))},xh=function(m,v){if(v){var w=m.style,I;v in Wa&&v!==Ho&&(v=an),w.removeProperty?(I=v.substr(0,2),(I==="ms"||v.substr(0,6)==="webkit")&&(v="-"+v),w.removeProperty(I==="--"?v:v.replace(J0,"-$1").toLowerCase())):w.removeAttribute(v)}},Ql=function(m,v,w,I,n,O){var V=new Mo(m._pt,v,w,0,1,O?MT:AT);return m._pt=V,V.b=I,V.e=n,m._props.push(w),V},TT={deg:1,rad:1,turn:1},GP={grid:1,flex:1},ec=function S(m,v,w,I){var n=parseFloat(w)||0,O=(w+"").trim().substr((n+"").length)||"px",V=yh.style,H=PP.test(v),J=m.tagName.toLowerCase()==="svg",ae=(J?"client":"offset")+(H?"Width":"Height"),we=100,Ae=I==="px",xe=I==="%",Ge,Te,We,ft;if(I===O||!n||TT[I]||TT[O])return n;if(O!=="px"&&!Ae&&(n=S(m,v,w,"px")),ft=m.getCTM&&zT(m),(xe||O==="%")&&(Wa[v]||~v.indexOf("adius")))return Ge=ft?m.getBBox()[H?"width":"height"]:m[ae],fn(xe?n/Ge*we:n/100*Ge);if(V[H?"width":"height"]=we+(Ae?O:I),Te=I!=="rem"&&~v.indexOf("adius")||I==="em"&&m.appendChild&&!J?m:m.parentNode,ft&&(Te=(m.ownerSVGElement||{}).parentNode),(!Te||Te===Jl||!Te.appendChild)&&(Te=Jl.body),We=Te._gsap,We&&xe&&We.width&&H&&We.time===jo.time&&!We.uncache)return fn(n/We.width*we);if(xe&&(v==="height"||v==="width")){var _t=m.style[v];m.style[v]=we+I,Ge=m[ae],_t?m.style[v]=_t:xh(m,v)}else(xe||O==="%")&&!GP[ys(Te,"display")]&&(V.position=ys(m,"position")),Te===m&&(V.position="static"),Te.appendChild(yh),Ge=yh[ae],Te.removeChild(yh),V.position="absolute";return H&&xe&&(We=Xl(Te),We.time=jo.time,We.width=Te[ae]),fn(Ae?Ge*n/we:Ge&&n?we/Ge*n:0)},Za=function(m,v,w,I){var n;return Y0||W0(),v in ga&&v!=="transform"&&(v=ga[v],~v.indexOf(",")&&(v=v.split(",")[0])),Wa[v]&&v!=="transform"?(n=bf(m,I),n=v!=="transformOrigin"?n[v]:n.svg?n.origin:W_(ys(m,Ho))+" "+n.zOrigin+"px"):(n=m.style[v],(!n||n==="auto"||I||~(n+"").indexOf("calc("))&&(n=Z_[v]&&Z_[v](m,v,w)||ys(m,v)||D0(m,v)||(v==="opacity"?1:0))),w&&!~(n+"").trim().indexOf(" ")?ec(m,v,n,w)+w:n},qP=function(m,v,w,I){if(!w||w==="none"){var n=ed(v,m,1),O=n&&ys(m,n,1);O&&O!==w?(v=n,w=O):v==="borderColor"&&(w=ys(m,"borderTopColor"))}var V=new Mo(this._pt,m.style,v,0,1,j0),H=0,J=0,ae,we,Ae,xe,Ge,Te,We,ft,_t,Pt,At,wt;if(V.b=w,V.e=I,w+="",I+="",I.substring(0,6)==="var(--"&&(I=ys(m,I.substring(4,I.indexOf(")")))),I==="auto"&&(Te=m.style[v],m.style[v]=I,I=ys(m,v)||I,Te?m.style[v]=Te:xh(m,v)),ae=[w,I],k0(ae),w=ae[0],I=ae[1],Ae=w.match(dh)||[],wt=I.match(dh)||[],wt.length){for(;we=dh.exec(I);)We=we[0],_t=I.substring(H,we.index),Ge?Ge=(Ge+1)%5:(_t.substr(-5)==="rgba("||_t.substr(-5)==="hsla(")&&(Ge=1),We!==(Te=Ae[J++]||"")&&(xe=parseFloat(Te)||0,At=Te.substr((xe+"").length),We.charAt(1)==="="&&(We=ph(xe,We)+At),ft=parseFloat(We),Pt=We.substr((ft+"").length),H=dh.lastIndex-Pt.length,Pt||(Pt=Pt||qo.units[v]||At,H===I.length&&(I+=Pt,V.e+=Pt)),At!==Pt&&(xe=ec(m,v,Te,Pt)||0),V._pt={_next:V._pt,p:_t||J===1?_t:",",s:xe,c:ft-xe,m:Ge&&Ge<4||v==="zIndex"?Math.round:0});V.c=H<I.length?I.substring(H,I.length):""}else V.r=v==="display"&&I==="none"?MT:AT;return C0.test(I)&&(V.e=0),this._pt=V,V},ST={top:"0%",bottom:"100%",left:"0%",right:"100%",center:"50%"},HP=function(m){var v=m.split(" "),w=v[0],I=v[1]||"50%";return(w==="top"||w==="bottom"||I==="left"||I==="right")&&(m=w,w=I,I=m),v[0]=ST[w]||w,v[1]=ST[I]||I,v.join(" ")},$P=function(m,v){if(v.tween&&v.tween._time===v.tween._dur){var w=v.t,I=w.style,n=v.u,O=w._gsap,V,H,J;if(n==="all"||n===!0)I.cssText="",H=1;else for(n=n.split(","),J=n.length;--J>-1;)V=n[J],Wa[V]&&(H=1,V=V==="transformOrigin"?Ho:an),xh(w,V);H&&(xh(w,an),O&&(O.svg&&w.removeAttribute("transform"),I.scale=I.rotate=I.translate="none",bf(w,1),O.uncache=1,CT(I)))}},Z_={clearProps:function(m,v,w,I,n){if(n.data!=="isFromStart"){var O=m._pt=new Mo(m._pt,v,w,0,0,$P);return O.u=I,O.pr=-10,O.tween=n,m._props.push(w),1}}},vf=[1,0,0,1,0,0],DT={},OT=function(m){return m==="matrix(1, 0, 0, 1, 0, 0)"||m==="none"||!m},ET=function(m){var v=ys(m,an);return OT(v)?vf:v.substr(7).match(M0).map(fn)},Q0=function(m,v){var w=m._gsap||Xl(m),I=m.style,n=ET(m),O,V,H,J;return w.svg&&m.getAttribute("transform")?(H=m.transform.baseVal.consolidate().matrix,n=[H.a,H.b,H.c,H.d,H.e,H.f],n.join(",")==="1,0,0,1,0,0"?vf:n):(n===vf&&!m.offsetParent&&m!==Ju&&!w.svg&&(H=I.display,I.display="block",O=m.parentNode,(!O||!m.offsetParent&&!m.getBoundingClientRect().width)&&(J=1,V=m.nextElementSibling,Ju.appendChild(m)),n=ET(m),H?I.display=H:xh(m,"display"),J&&(V?O.insertBefore(m,V):O?O.appendChild(m):Ju.removeChild(m))),v&&n.length>6?[n[0],n[1],n[4],n[5],n[12],n[13]]:n)},X0=function(m,v,w,I,n,O){var V=m._gsap,H=n||Q0(m,!0),J=V.xOrigin||0,ae=V.yOrigin||0,we=V.xOffset||0,Ae=V.yOffset||0,xe=H[0],Ge=H[1],Te=H[2],We=H[3],ft=H[4],_t=H[5],Pt=v.split(" "),At=parseFloat(Pt[0])||0,wt=parseFloat(Pt[1])||0,Ct,Ft,Wt,mt;w?H!==vf&&(Ft=xe*We-Ge*Te)&&(Wt=At*(We/Ft)+wt*(-Te/Ft)+(Te*_t-We*ft)/Ft,mt=At*(-Ge/Ft)+wt*(xe/Ft)-(xe*_t-Ge*ft)/Ft,At=Wt,wt=mt):(Ct=LT(m),At=Ct.x+(~Pt[0].indexOf("%")?At/100*Ct.width:At),wt=Ct.y+(~(Pt[1]||Pt[0]).indexOf("%")?wt/100*Ct.height:wt)),I||I!==!1&&V.smooth?(ft=At-J,_t=wt-ae,V.xOffset=we+(ft*xe+_t*Te)-ft,V.yOffset=Ae+(ft*Ge+_t*We)-_t):V.xOffset=V.yOffset=0,V.xOrigin=At,V.yOrigin=wt,V.smooth=!!I,V.origin=v,V.originIsAbsolute=!!w,m.style[Ho]="0px 0px",O&&(Ql(O,V,"xOrigin",J,At),Ql(O,V,"yOrigin",ae,wt),Ql(O,V,"xOffset",we,V.xOffset),Ql(O,V,"yOffset",Ae,V.yOffset)),m.setAttribute("data-svg-origin",At+" "+wt)},bf=function(m,v){var w=m._gsap||new F0(m);if("x"in w&&!v&&!w.uncache)return w;var I=m.style,n=w.scaleX<0,O="px",V="deg",H=getComputedStyle(m),J=ys(m,Ho)||"0",ae,we,Ae,xe,Ge,Te,We,ft,_t,Pt,At,wt,Ct,Ft,Wt,mt,er,Ni,yi,mi,vi,mr,Fr,Rr,Hr,Xi,tn,Po,Ro,Zo,Oi,or;return ae=we=Ae=Te=We=ft=_t=Pt=At=0,xe=Ge=1,w.svg=!!(m.getCTM&&zT(m)),H.translate&&((H.translate!=="none"||H.scale!=="none"||H.rotate!=="none")&&(I[an]=(H.translate!=="none"?"translate3d("+(H.translate+" 0 0").split(" ").slice(0,3).join(", ")+") ":"")+(H.rotate!=="none"?"rotate("+H.rotate+") ":"")+(H.scale!=="none"?"scale("+H.scale.split(" ").join(",")+") ":"")+(H[an]!=="none"?H[an]:"")),I.scale=I.rotate=I.translate="none"),Ft=Q0(m,w.svg),w.svg&&(w.uncache?(Hr=m.getBBox(),J=w.xOrigin-Hr.x+"px "+(w.yOrigin-Hr.y)+"px",Rr=""):Rr=!v&&m.getAttribute("data-svg-origin"),X0(m,Rr||J,!!Rr||w.originIsAbsolute,w.smooth!==!1,Ft)),wt=w.xOrigin||0,Ct=w.yOrigin||0,Ft!==vf&&(Ni=Ft[0],yi=Ft[1],mi=Ft[2],vi=Ft[3],ae=mr=Ft[4],we=Fr=Ft[5],Ft.length===6?(xe=Math.sqrt(Ni*Ni+yi*yi),Ge=Math.sqrt(vi*vi+mi*mi),Te=Ni||yi?Ku(yi,Ni)*gh:0,_t=mi||vi?Ku(mi,vi)*gh+Te:0,_t&&(Ge*=Math.abs(Math.cos(_t*Qu))),w.svg&&(ae-=wt-(wt*Ni+Ct*mi),we-=Ct-(wt*yi+Ct*vi))):(or=Ft[6],Zo=Ft[7],tn=Ft[8],Po=Ft[9],Ro=Ft[10],Oi=Ft[11],ae=Ft[12],we=Ft[13],Ae=Ft[14],Wt=Ku(or,Ro),We=Wt*gh,Wt&&(mt=Math.cos(-Wt),er=Math.sin(-Wt),Rr=mr*mt+tn*er,Hr=Fr*mt+Po*er,Xi=or*mt+Ro*er,tn=mr*-er+tn*mt,Po=Fr*-er+Po*mt,Ro=or*-er+Ro*mt,Oi=Zo*-er+Oi*mt,mr=Rr,Fr=Hr,or=Xi),Wt=Ku(-mi,Ro),ft=Wt*gh,Wt&&(mt=Math.cos(-Wt),er=Math.sin(-Wt),Rr=Ni*mt-tn*er,Hr=yi*mt-Po*er,Xi=mi*mt-Ro*er,Oi=vi*er+Oi*mt,Ni=Rr,yi=Hr,mi=Xi),Wt=Ku(yi,Ni),Te=Wt*gh,Wt&&(mt=Math.cos(Wt),er=Math.sin(Wt),Rr=Ni*mt+yi*er,Hr=mr*mt+Fr*er,yi=yi*mt-Ni*er,Fr=Fr*mt-mr*er,Ni=Rr,mr=Hr),We&&Math.abs(We)+Math.abs(Te)>359.9&&(We=Te=0,ft=180-ft),xe=fn(Math.sqrt(Ni*Ni+yi*yi+mi*mi)),Ge=fn(Math.sqrt(Fr*Fr+or*or)),Wt=Ku(mr,Fr),_t=Math.abs(Wt)>2e-4?Wt*gh:0,At=Oi?1/(Oi<0?-Oi:Oi):0),w.svg&&(Rr=m.getAttribute("transform"),w.forceCSS=m.setAttribute("transform","")||!OT(ys(m,an)),Rr&&m.setAttribute("transform",Rr))),Math.abs(_t)>90&&Math.abs(_t)<270&&(n?(xe*=-1,_t+=Te<=0?180:-180,Te+=Te<=0?180:-180):(Ge*=-1,_t+=_t<=0?180:-180)),v=v||w.uncache,w.x=ae-((w.xPercent=ae&&(!v&&w.xPercent||(Math.round(m.offsetWidth/2)===Math.round(-ae)?-50:0)))?m.offsetWidth*w.xPercent/100:0)+O,w.y=we-((w.yPercent=we&&(!v&&w.yPercent||(Math.round(m.offsetHeight/2)===Math.round(-we)?-50:0)))?m.offsetHeight*w.yPercent/100:0)+O,w.z=Ae+O,w.scaleX=fn(xe),w.scaleY=fn(Ge),w.rotation=fn(Te)+V,w.rotationX=fn(We)+V,w.rotationY=fn(ft)+V,w.skewX=_t+V,w.skewY=Pt+V,w.transformPerspective=At+O,(w.zOrigin=parseFloat(J.split(" ")[2])||!v&&w.zOrigin||0)&&(I[Ho]=W_(J)),w.xOffset=w.yOffset=0,w.force3D=qo.force3D,w.renderTransform=w.svg?WP:RT?kT:ZP,w.uncache=0,w},W_=function(m){return(m=m.split(" "))[0]+" "+m[1]},H0=function(m,v,w){var I=Yn(v);return fn(parseFloat(v)+parseFloat(ec(m,"x",w+"px",I)))+I},ZP=function(m,v){v.z="0px",v.rotationY=v.rotationX="0deg",v.force3D=0,kT(m,v)},mh="0deg",xf="0px",_h=") ",kT=function(m,v){var w=v||this,I=w.xPercent,n=w.yPercent,O=w.x,V=w.y,H=w.z,J=w.rotation,ae=w.rotationY,we=w.rotationX,Ae=w.skewX,xe=w.skewY,Ge=w.scaleX,Te=w.scaleY,We=w.transformPerspective,ft=w.force3D,_t=w.target,Pt=w.zOrigin,At="",wt=ft==="auto"&&m&&m!==1||ft===!0;if(Pt&&(we!==mh||ae!==mh)){var Ct=parseFloat(ae)*Qu,Ft=Math.sin(Ct),Wt=Math.cos(Ct),mt;Ct=parseFloat(we)*Qu,mt=Math.cos(Ct),O=H0(_t,O,Ft*mt*-Pt),V=H0(_t,V,-Math.sin(Ct)*-Pt),H=H0(_t,H,Wt*mt*-Pt+Pt)}We!==xf&&(At+="perspective("+We+_h),(I||n)&&(At+="translate("+I+"%, "+n+"%) "),(wt||O!==xf||V!==xf||H!==xf)&&(At+=H!==xf||wt?"translate3d("+O+", "+V+", "+H+") ":"translate("+O+", "+V+_h),J!==mh&&(At+="rotate("+J+_h),ae!==mh&&(At+="rotateY("+ae+_h),we!==mh&&(At+="rotateX("+we+_h),(Ae!==mh||xe!==mh)&&(At+="skew("+Ae+", "+xe+_h),(Ge!==1||Te!==1)&&(At+="scale("+Ge+", "+Te+_h),_t.style[an]=At||"translate(0, 0)"},WP=function(m,v){var w=v||this,I=w.xPercent,n=w.yPercent,O=w.x,V=w.y,H=w.rotation,J=w.skewX,ae=w.skewY,we=w.scaleX,Ae=w.scaleY,xe=w.target,Ge=w.xOrigin,Te=w.yOrigin,We=w.xOffset,ft=w.yOffset,_t=w.forceCSS,Pt=parseFloat(O),At=parseFloat(V),wt,Ct,Ft,Wt,mt;H=parseFloat(H),J=parseFloat(J),ae=parseFloat(ae),ae&&(ae=parseFloat(ae),J+=ae,H+=ae),H||J?(H*=Qu,J*=Qu,wt=Math.cos(H)*we,Ct=Math.sin(H)*we,Ft=Math.sin(H-J)*-Ae,Wt=Math.cos(H-J)*Ae,J&&(ae*=Qu,mt=Math.tan(J-ae),mt=Math.sqrt(1+mt*mt),Ft*=mt,Wt*=mt,ae&&(mt=Math.tan(ae),mt=Math.sqrt(1+mt*mt),wt*=mt,Ct*=mt)),wt=fn(wt),Ct=fn(Ct),Ft=fn(Ft),Wt=fn(Wt)):(wt=we,Wt=Ae,Ct=Ft=0),(Pt&&!~(O+"").indexOf("px")||At&&!~(V+"").indexOf("px"))&&(Pt=ec(xe,"x",O,"px"),At=ec(xe,"y",V,"px")),(Ge||Te||We||ft)&&(Pt=fn(Pt+Ge-(Ge*wt+Te*Ft)+We),At=fn(At+Te-(Ge*Ct+Te*Wt)+ft)),(I||n)&&(mt=xe.getBBox(),Pt=fn(Pt+I/100*mt.width),At=fn(At+n/100*mt.height)),mt="matrix("+wt+","+Ct+","+Ft+","+Wt+","+Pt+","+At+")",xe.setAttribute("transform",mt),_t&&(xe.style[an]=mt)},XP=function(m,v,w,I,n){var O=360,V=Rn(n),H=parseFloat(n)*(V&&~n.indexOf("rad")?gh:1),J=H-I,ae=I+J+"deg",we,Ae;return V&&(we=n.split("_")[1],we==="short"&&(J%=O,J!==J%(O/2)&&(J+=J<0?O:-O)),we==="cw"&&J<0?J=(J+O*xT)%O-~~(J/O)*O:we==="ccw"&&J>0&&(J=(J-O*xT)%O-~~(J/O)*O)),m._pt=Ae=new Mo(m._pt,v,w,I,J,LP),Ae.e=ae,Ae.u="deg",m._props.push(w),Ae},IT=function(m,v){for(var w in v)m[w]=v[w];return m},YP=function(m,v,w){var I=IT({},w._gsap),n="perspective,force3D,transformOrigin,svgOrigin",O=w.style,V,H,J,ae,we,Ae,xe,Ge;I.svg?(J=w.getAttribute("transform"),w.setAttribute("transform",""),O[an]=v,V=bf(w,1),xh(w,an),w.setAttribute("transform",J)):(J=getComputedStyle(w)[an],O[an]=v,V=bf(w,1),O[an]=J);for(H in Wa)J=I[H],ae=V[H],J!==ae&&n.indexOf(H)<0&&(xe=Yn(J),Ge=Yn(ae),we=xe!==Ge?ec(w,H,J,Ge):parseFloat(J),Ae=parseFloat(ae),m._pt=new Mo(m._pt,V,H,we,Ae-we,$0),m._pt.u=Ge||0,m._props.push(H));IT(V,I)};Ao("padding,margin,Width,Radius",function(S,m){var v="Top",w="Right",I="Bottom",n="Left",O=(m<3?[v,w,I,n]:[v+n,v+w,I+w,I+n]).map(function(V){return m<2?S+V:"border"+V+S});Z_[m>1?"border"+S:S]=function(V,H,J,ae,we){var Ae,xe;if(arguments.length<4)return Ae=O.map(function(Ge){return Za(V,Ge,J)}),xe=Ae.join(" "),xe.split(Ae[0]).length===5?Ae[0]:xe;Ae=(ae+"").split(" "),xe={},O.forEach(function(Ge,Te){return xe[Ge]=Ae[Te]=Ae[Te]||Ae[(Te-1)/2|0]}),V.init(H,xe,we)}});var ex={name:"css",register:W0,targetTest:function(m){return m.style&&m.nodeType},init:function(m,v,w,I,n){var O=this._props,V=m.style,H=w.vars.startAt,J,ae,we,Ae,xe,Ge,Te,We,ft,_t,Pt,At,wt,Ct,Ft,Wt;Y0||W0(),this.styles=this.styles||PT(m),Wt=this.styles.props,this.tween=w;for(Te in v)if(Te!=="autoRound"&&(ae=v[Te],!(Uo[Te]&&N0(Te,v,w,I,m,n)))){if(xe=typeof ae,Ge=Z_[Te],xe==="function"&&(ae=ae.call(w,I,m,n),xe=typeof ae),xe==="string"&&~ae.indexOf("random(")&&(ae=Yu(ae)),Ge)Ge(this,m,Te,ae,w)&&(Ft=1);else if(Te.substr(0,2)==="--")J=(getComputedStyle(m).getPropertyValue(Te)+"").trim(),ae+="",Ha.lastIndex=0,Ha.test(J)||(We=Yn(J),ft=Yn(ae)),ft?We!==ft&&(J=ec(m,Te,J,ft)+ft):We&&(ae+=We),this.add(V,"setProperty",J,ae,I,n,0,0,Te),O.push(Te),Wt.push(Te,0,V[Te]);else if(xe!=="undefined"){if(H&&Te in H?(J=typeof H[Te]=="function"?H[Te].call(w,I,m,n):H[Te],Rn(J)&&~J.indexOf("random(")&&(J=Yu(J)),Yn(J+"")||J==="auto"||(J+=qo.units[Te]||Yn(Za(m,Te))||""),(J+"").charAt(1)==="="&&(J=Za(m,Te))):J=Za(m,Te),Ae=parseFloat(J),_t=xe==="string"&&ae.charAt(1)==="="&&ae.substr(0,2),_t&&(ae=ae.substr(2)),we=parseFloat(ae),Te in ga&&(Te==="autoAlpha"&&(Ae===1&&Za(m,"visibility")==="hidden"&&we&&(Ae=0),Wt.push("visibility",0,V.visibility),Ql(this,V,"visibility",Ae?"inherit":"hidden",we?"inherit":"hidden",!we)),Te!=="scale"&&Te!=="transform"&&(Te=ga[Te],~Te.indexOf(",")&&(Te=Te.split(",")[0]))),Pt=Te in Wa,Pt){if(this.styles.save(Te),xe==="string"&&ae.substring(0,6)==="var(--"&&(ae=ys(m,ae.substring(4,ae.indexOf(")"))),we=parseFloat(ae)),At||(wt=m._gsap,wt.renderTransform&&!v.parseTransform||bf(m,v.parseTransform),Ct=v.smoothOrigin!==!1&&wt.smooth,At=this._pt=new Mo(this._pt,V,an,0,1,wt.renderTransform,wt,0,-1),At.dep=1),Te==="scale")this._pt=new Mo(this._pt,wt,"scaleY",wt.scaleY,(_t?ph(wt.scaleY,_t+we):we)-wt.scaleY||0,$0),this._pt.u=0,O.push("scaleY",Te),Te+="X";else if(Te==="transformOrigin"){Wt.push(Ho,0,V[Ho]),ae=HP(ae),wt.svg?X0(m,ae,0,Ct,0,this):(ft=parseFloat(ae.split(" ")[2])||0,ft!==wt.zOrigin&&Ql(this,wt,"zOrigin",wt.zOrigin,ft),Ql(this,V,Te,W_(J),W_(ae)));continue}else if(Te==="svgOrigin"){X0(m,ae,1,Ct,0,this);continue}else if(Te in DT){XP(this,wt,Te,Ae,_t?ph(Ae,_t+ae):ae);continue}else if(Te==="smoothOrigin"){Ql(this,wt,"smooth",wt.smooth,ae);continue}else if(Te==="force3D"){wt[Te]=ae;continue}else if(Te==="transform"){YP(this,ae,m);continue}}else Te in V||(Te=ed(Te)||Te);if(Pt||(we||we===0)&&(Ae||Ae===0)&&!RP.test(ae)&&Te in V)We=(J+"").substr((Ae+"").length),we||(we=0),ft=Yn(ae)||(Te in qo.units?qo.units[Te]:We),We!==ft&&(Ae=ec(m,Te,J,ft)),this._pt=new Mo(this._pt,Pt?wt:V,Te,Ae,(_t?ph(Ae,_t+we):we)-Ae,!Pt&&(ft==="px"||Te==="zIndex")&&v.autoRound!==!1?DP:$0),this._pt.u=ft||0,We!==ft&&ft!=="%"&&(this._pt.b=J,this._pt.r=zP);else if(Te in V)qP.call(this,m,Te,J,_t?_t+ae:ae);else if(Te in m)this.add(m,Te,J||m[Te],_t?_t+ae:ae,I,n);else if(Te!=="parseTransform"){j_(Te,ae);continue}Pt||(Te in V?Wt.push(Te,0,V[Te]):typeof m[Te]=="function"?Wt.push(Te,2,m[Te]()):Wt.push(Te,1,J||m[Te])),O.push(Te)}}Ft&&q0(this)},render:function(m,v){if(v.tween._time||!K0())for(var w=v._pt;w;)w.r(m,w.d),w=w._next;else v.styles.revert()},get:Za,aliases:ga,getSetter:function(m,v,w){var I=ga[v];return I&&I.indexOf(",")<0&&(v=I),v in Wa&&v!==Ho&&(m._gsap.x||Za(m,"x"))?w&&yT===w?v==="scale"?BP:FP:(yT=w||{})&&(v==="scale"?NP:VP):m.style&&!U_(m.style[v])?OP:~v.indexOf("-")?kP:$_(m,v)},core:{_removeProperty:xh,_getMatrix:Q0}};oo.utils.checkPrefix=ed;oo.core.getStyleSaver=PT;(function(S,m,v,w){var I=Ao(S+","+m+","+v,function(n){Wa[n]=1});Ao(m,function(n){qo.units[n]="deg",DT[n]=1}),ga[I[13]]=S+","+m,Ao(w,function(n){var O=n.split(":");ga[O[1]]=I[O[0]]})})("x,y,z,scale,scaleX,scaleY,xPercent,yPercent","rotation,rotationX,rotationY,skewX,skewY","transform,transformOrigin,svgOrigin,force3D,smoothOrigin,transformPerspective","0:translateX,1:translateY,2:translateZ,8:rotate,8:rotationZ,8:rotateZ,9:rotateX,10:rotateY");Ao("x,y,z,top,right,bottom,left,width,height,fontSize,padding,margin,perspective",function(S){qo.units[S]="px"});oo.registerPlugin(ex);var X_=oo.registerPlugin(ex)||oo,Nz=X_.core.Tween;var so,NT,Xa,ya,tc,VT,td,Y_,UT=function(){return typeof window<"u"},jT=function(){return so||UT()&&(so=window.gsap)&&so.registerPlugin&&so},GT=function(m){return typeof m=="string"},FT=function(m){return typeof m=="function"},wf=function(m,v){var w=v==="x"?"Width":"Height",I="scroll"+w,n="client"+w;return m===Xa||m===ya||m===tc?Math.max(ya[I],tc[I])-(Xa["inner"+w]||ya[n]||tc[n]):m[I]-m["offset"+w]},Tf=function(m,v){var w="scroll"+(v==="x"?"Left":"Top");return m===Xa&&(m.pageXOffset!=null?w="page"+v.toUpperCase()+"Offset":m=ya[w]!=null?ya:tc),function(){return m[w]}},KP=function(m,v,w,I){if(FT(m)&&(m=m(v,w,I)),typeof m!="object")return GT(m)&&m!=="max"&&m.charAt(1)!=="="?{x:m,y:m}:{y:m};if(m.nodeType)return{y:m,x:m};var n={},O;for(O in m)n[O]=O!=="onAutoKill"&&FT(m[O])?m[O](v,w,I):m[O];return n},qT=function(m,v){if(m=VT(m)[0],!m||!m.getBoundingClientRect)return console.warn("scrollTo target doesn't exist. Using 0")||{x:0,y:0};var w=m.getBoundingClientRect(),I=!v||v===Xa||v===tc,n=I?{top:ya.clientTop-(Xa.pageYOffset||ya.scrollTop||tc.scrollTop||0),left:ya.clientLeft-(Xa.pageXOffset||ya.scrollLeft||tc.scrollLeft||0)}:v.getBoundingClientRect(),O={x:w.left-n.left,y:w.top-n.top};return!I&&v&&(O.x+=Tf(v,"x")(),O.y+=Tf(v,"y")()),O},BT=function(m,v,w,I,n){return!isNaN(m)&&typeof m!="object"?parseFloat(m)-n:GT(m)&&m.charAt(1)==="="?parseFloat(m.substr(2))*(m.charAt(0)==="-"?-1:1)+I-n:m==="max"?wf(v,w)-n:Math.min(wf(v,w),qT(m,v)[w]-n)},tx=function(){so=jT(),UT()&&so&&typeof document<"u"&&document.body&&(Xa=window,tc=document.body,ya=document.documentElement,VT=so.utils.toArray,so.config({autoKillThreshold:7}),td=so.config(),NT=1)},vh={version:"3.13.0",name:"scrollTo",rawVars:1,register:function(m){so=m,tx()},init:function(m,v,w,I,n){NT||tx();var O=this,V=so.getProperty(m,"scrollSnapType");O.isWin=m===Xa,O.target=m,O.tween=w,v=KP(v,I,m,n),O.vars=v,O.autoKill=!!("autoKill"in v?v:td).autoKill,O.getX=Tf(m,"x"),O.getY=Tf(m,"y"),O.x=O.xPrev=O.getX(),O.y=O.yPrev=O.getY(),Y_||(Y_=so.core.globals().ScrollTrigger),so.getProperty(m,"scrollBehavior")==="smooth"&&so.set(m,{scrollBehavior:"auto"}),V&&V!=="none"&&(O.snap=1,O.snapInline=m.style.scrollSnapType,m.style.scrollSnapType="none"),v.x!=null?(O.add(O,"x",O.x,BT(v.x,m,"x",O.x,v.offsetX||0),I,n),O._props.push("scrollTo_x")):O.skipX=1,v.y!=null?(O.add(O,"y",O.y,BT(v.y,m,"y",O.y,v.offsetY||0),I,n),O._props.push("scrollTo_y")):O.skipY=1},render:function(m,v){for(var w=v._pt,I=v.target,n=v.tween,O=v.autoKill,V=v.xPrev,H=v.yPrev,J=v.isWin,ae=v.snap,we=v.snapInline,Ae,xe,Ge,Te,We;w;)w.r(m,w.d),w=w._next;Ae=J||!v.skipX?v.getX():V,xe=J||!v.skipY?v.getY():H,Ge=xe-H,Te=Ae-V,We=td.autoKillThreshold,v.x<0&&(v.x=0),v.y<0&&(v.y=0),O&&(!v.skipX&&(Te>We||Te<-We)&&Ae<wf(I,"x")&&(v.skipX=1),!v.skipY&&(Ge>We||Ge<-We)&&xe<wf(I,"y")&&(v.skipY=1),v.skipX&&v.skipY&&(n.kill(),v.vars.onAutoKill&&v.vars.onAutoKill.apply(n,v.vars.onAutoKillParams||[]))),J?Xa.scrollTo(v.skipX?Ae:v.x,v.skipY?xe:v.y):(v.skipY||(I.scrollTop=v.y),v.skipX||(I.scrollLeft=v.x)),ae&&(m===1||m===0)&&(xe=I.scrollTop,Ae=I.scrollLeft,we?I.style.scrollSnapType=we:I.style.removeProperty("scroll-snap-type"),I.scrollTop=xe+1,I.scrollLeft=Ae+1,I.scrollTop=xe,I.scrollLeft=Ae),v.xPrev=v.x,v.yPrev=v.y,Y_&&Y_.update()},kill:function(m){var v=m==="scrollTo",w=this._props.indexOf(m);return(v||m==="scrollTo_x")&&(this.skipX=1),(v||m==="scrollTo_y")&&(this.skipY=1),w>-1&&this._props.splice(w,1),!this._props.length}};vh.max=wf;vh.getOffset=qT;vh.buildGetter=Tf;vh.config=function(S){td||tx()||(td=so.config());for(var m in S)td[m]=S[m]};jT()&&so.registerPlugin(vh);X_.registerPlugin(vh);window.__GLOBAL_GSAP=X_;var ix=window.__GLOBAL_GSAP;var $z=document.querySelector("#viewport"),Zz=document.querySelector(".map_filters-content"),Wz=document.querySelector(".map_image-bar"),Xz=document.querySelector(".map_loader"),Yz=document.querySelector(".map_loader-drop");window.stop=!1;function HT(){window.stop=!0}var K_=class extends Error{constructor(m){super(m),this.name="ValidationError"}},Sf=class extends Error{constructor(m,v){super(m),this.name="NetworkError",this.status=v}},id=class extends Error{constructor(m,v){super(m),this.name="ApiError",this.code=v}},J_=class extends Error{constructor(m,v){super(m),this.name="NotFoundError",this.code=v}};var JP="pk.eyJ1Ijoicm9kb25uZWxsLWN0cml2ZXIiLCJhIjoiY21kaGoxb3dwMDI5NDJscHp6djk0aHIzZiJ9.SAf5EWG05FFg3-5Vkd1c6A";async function rx(S){if(!QP(S))throw new K_("Zip code is not valid");let m=`https://api.mapbox.com/search/geocode/v6/forward?q=${S}&access_token=${JP}&country=US`,v,w;try{w=await fetch(m)}catch(I){throw new Sf(I.message)}if(!w.ok)throw new Sf("Mapbox service error",w.status);if(v=await w.json(),!Array.isArray(v?.features))throw new id("Result structure is unknown","WRONG_RESULTS");if(!v.features.length>0)throw new id("No results found for provided ZIP","NO_RESULTS");if(!v.features[0]?.geometry?.coordinates)throw new id("Result structure is unknown","WRONG_RESULTS");return v.features[0].geometry.coordinates}function QP(S){return/^\d{5}(-\d{4})?$/.test(S)}var XT=a0($T(),1),eR=6371,xa=Math.PI/180;function YT(S,m,v,w=1/0,I=1/0,n){let O=1,V=[];w===void 0&&(w=1/0),I!==void 0&&(O=bh(I/eR));let H=new XT.default([],tR),J={left:0,right:S.ids.length-1,axis:0,dist:0,minLng:-180,minLat:-90,maxLng:180,maxLat:90},ae=Math.cos(v*xa);for(;J;){let we=J.right,Ae=J.left;if(we-Ae<=S.nodeSize)for(let xe=Ae;xe<=we;xe++){let Ge=S.ids[xe];if(!n||n(Ge)){let Te=WT(m,v,S.coords[2*xe],S.coords[2*xe+1],ae);H.push({id:Ge,dist:Te})}}else{let xe=Ae+we>>1,Ge=S.coords[2*xe],Te=S.coords[2*xe+1],We=S.ids[xe];if(!n||n(We)){let At=WT(m,v,Ge,Te,ae);H.push({id:We,dist:At})}let ft=(J.axis+1)%2,_t={left:Ae,right:xe-1,axis:ft,minLng:J.minLng,minLat:J.minLat,maxLng:J.axis===0?Ge:J.maxLng,maxLat:J.axis===1?Te:J.maxLat,dist:0},Pt={left:xe+1,right:we,axis:ft,minLng:J.axis===0?Ge:J.minLng,minLat:J.axis===1?Te:J.minLat,maxLng:J.maxLng,maxLat:J.maxLat,dist:0};_t.dist=ZT(m,v,ae,_t),Pt.dist=ZT(m,v,ae,Pt),H.push(_t),H.push(Pt)}for(;H.length&&H.peek().id!=null;){let xe=H.pop();if(xe.dist>O||(V.push(xe.id),V.length===w))return V}J=H.pop()}return V}function ZT(S,m,v,w){let I=w.minLng,n=w.maxLng,O=w.minLat,V=w.maxLat;if(S>=I&&S<=n)return m<O?bh((m-O)*xa):m>V?bh((m-V)*xa):0;let H=Math.min(bh((S-I)*xa),bh((S-n)*xa)),J=iR(m,H);return J>O&&J<V?Q_(H,v,m,J):Math.min(Q_(H,v,m,O),Q_(H,v,m,V))}function tR(S,m){return S.dist-m.dist}function bh(S){let m=Math.sin(S/2);return m*m}function Q_(S,m,v,w){return m*Math.cos(w*xa)*S+bh((v-w)*xa)}function WT(S,m,v,w,I){let n=bh((S-v)*xa);return Q_(n,I,m,w)}function iR(S,m){let v=1-2*m;return v<=0?S>0?90:-90:Math.atan(Math.tan(S*xa)/v)/xa}var rs=63710088e-1,nR={centimeters:rs*100,centimetres:rs*100,degrees:360/(2*Math.PI),feet:rs*3.28084,inches:rs*39.37,kilometers:rs/1e3,kilometres:rs/1e3,meters:rs,metres:rs,miles:rs/1609.344,millimeters:rs*1e3,millimetres:rs*1e3,nauticalmiles:rs/1852,radians:1,yards:rs*1.0936};function oR(S,m,v={}){let w={type:"Feature"};return(v.id===0||v.id)&&(w.id=v.id),v.bbox&&(w.bbox=v.bbox),w.properties=m||{},w.geometry=S,w}function sx(S,m,v={}){if(!S)throw new Error("coordinates is required");if(!Array.isArray(S))throw new Error("coordinates must be an Array");if(S.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!KT(S[0])||!KT(S[1]))throw new Error("coordinates must contain numbers");return oR({type:"Point",coordinates:S},m,v)}function JT(S,m="kilometers"){let v=nR[m];if(!v)throw new Error(m+" units is invalid");return S*v}function Ef(S){return S%360*Math.PI/180}function KT(S){return!isNaN(S)&&S!==null&&!Array.isArray(S)}function ax(S){if(!S)throw new Error("coord is required");if(!Array.isArray(S)){if(S.type==="Feature"&&S.geometry!==null&&S.geometry.type==="Point")return[...S.geometry.coordinates];if(S.type==="Point")return[...S.coordinates]}if(Array.isArray(S)&&S.length>=2&&!Array.isArray(S[0])&&!Array.isArray(S[1]))return[...S];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function lx(S,m,v={}){var w=ax(S),I=ax(m),n=Ef(I[1]-w[1]),O=Ef(I[0]-w[0]),V=Ef(w[1]),H=Ef(I[1]),J=Math.pow(Math.sin(n/2),2)+Math.pow(Math.sin(O/2),2)*Math.cos(V)*Math.cos(H);return JT(2*Math.atan2(Math.sqrt(J),Math.sqrt(1-J)),v.units)}var{getKdIndex:aR,getPoints:lR}=Bn.getState();function QT(S,m,{limit:v=10,maxDistanceMiles:w=50}={}){let I=aR(),n=lR();return YT(I,S,m,v).map(H=>{let J=n[H],ae=lx(sx([S,m]),sx([J.lon,J.lat]),{units:"miles"});return{...J,distanceMl:ae}}).filter(H=>H.distanceMl<=w).sort((H,J)=>H.distanceMl-J.distanceMl)}function cx(S){let m=10,v=[];do v=QT(S[0],S[1],{limit:100,maxDistanceMiles:m}),m+=10;while(m<=50&&!v.length>0);return v}var xs=a0(t2(),1);var{getMapStyle:cR,setMapStyle:hR,getSitesFiltered:uR}=Bn.getState(),If=class{onAdd(m){this.map=m,this.container=document.createElement("div"),this.container.className="mapboxgl-ctrl mapboxgl-ctrl-group";let v="mapboxgl-ctrl-map-style",w="mapboxgl-ctrl-map-style--active",I=document.createElement("button");I.type="button";let n=document.createElement("span");n.classList.add("mapboxgl-ctrl-icon"),I.classList.add(v),I.setAttribute("aria-label","Toggle Accessibility Mode"),I.append(n);let O="mapbox://styles/rodonnell-ctriver/cme050tqw018g01qpa23h8jj3",V="mapbox://styles/mapbox/satellite-v9";return I.addEventListener("click",()=>{let H=cR(),J;H===O?J=V:J=O;let ae=uR();m.setStyle(J),hR(J);let we=async()=>{await eg(ae,!1),I.classList.toggle(w),m.off("style.load",we)};m.on("style.load",we)}),this.container.appendChild(I),this.container}onRemove(){this.container.parentNode.removeChild(this.container),this.map=void 0}};var rE=a0(iE(),1);var{getUserLocMarker:YL}=Bn.getState(),Pf=class{onAdd(m){this.map=m,this.container=document.createElement("div"),this.container.className="mapboxgl-ctrl mapboxgl-ctrl-group";let v="mapboxgl-ctrl-location",w=document.createElement("button");w.type="button";let I=document.createElement("span");return I.classList.add("mapboxgl-ctrl-icon"),w.classList.add(v),w.setAttribute("aria-label","Toggle Accessibility Mode"),w.append(I),w.addEventListener("click",()=>{let n=YL();if(n){let O=n.getLngLat();cg([{longitude:O.lng,latitude:O.lat}])}else document.querySelector("#zip").focus()}),this.container.appendChild(w),this.container}onRemove(){this.container.parentNode.removeChild(this.container),this.map=void 0}};var{getMapStyle:KL}=Bn.getState();Cw();function JL(){let S=KL();return xs.default.accessToken="pk.eyJ1Ijoicm9kb25uZWxsLWN0cml2ZXIiLCJhIjoiY21kaGoxb3dwMDI5NDJscHp6djk0aHIzZiJ9.SAf5EWG05FFg3-5Vkd1c6A",new xs.default.Map({container:"viewport",projection:"mercator",style:S,center:[-72.61177,42.58554],zoom:6.3,attributionControl:!1,pixelRatio:window.devicePixelRatio||1,cooperativeGestures:!0})}var fr=JL(),QL=document.querySelectorAll(".mapboxgl-ctrl-bottom-left");QL.forEach(S=>{S.classList.replace("mapboxgl-ctrl-bottom-left","mapboxgl-ctrl-top-left")});var ez=fr.getCanvas();ez.style.position="relative";fr.addControl(new xs.default.AttributionControl,"top-right");fr.addControl(new rE.default({accessToken:xs.default.accessToken,mapboxgl:xs.default,marker:!1,limit:3,placeholder:" ",collapsed:!0}));fr.addControl(new xs.default.NavigationControl,"top-right");fr.addControl(new If,"top-right");fr.addControl(new Pf,"top-right");tz();iz();function tz(){document.querySelectorAll(".mapboxgl-ctrl-bottom-left").forEach(Ge=>{Ge.classList.replace("mapboxgl-ctrl-bottom-left","mapboxgl-ctrl-top-left")});let m=".mapboxgl-ctrl button.$base .mapboxgl-ctrl-icon",v=".mapboxgl-ctrl button.$base:not(.$base--active) .mapboxgl-ctrl-icon:$pseudo",w=".mapboxgl-ctrl button.$base.$base--active .mapboxgl-ctrl-icon",I=".mapboxgl-ctrl button.$base.$base--access.$base--active .mapboxgl-ctrl-icon",n="{ background-image: url($icon) }",O=".mapboxgl-ctrl button.$base.$base--access .mapboxgl-ctrl-icon",V=`@media (hover: hover) and (pointer: fine) {
$selectors}
`,H=`@media (hover: none) and (pointer: coarse) {
$selectors}
`,J={hover:[{class:"mapboxgl-ctrl-zoom-in",icon:"controll-zoomIn-hover"},{class:"mapboxgl-ctrl-zoom-out",icon:"controll-zoomOut-hover"},{class:"mapboxgl-ctrl-compass",icon:"controll-compass-hover"},{class:"mapboxgl-ctrl-fullscreen",icon:"controll-fullScreen-hover"},{class:"mapboxgl-ctrl-access",icon:"controll-access-hover"},{class:"mapboxgl-ctrl-map-style",icon:"controll-mapStyle-hover"},{class:"mapboxgl-ctrl-location",icon:"controll-location-hover"}],active:[{class:"mapboxgl-ctrl-access",icon:"controll-access-active"},{class:"mapboxgl-ctrl-map-style",icon:"controll-mapStyle-active"}],activeAccess:[{class:"mapboxgl-ctrl-access",icon:"controll-access-activeAccess"},{class:"mapboxgl-ctrl-map-style",icon:"controll-mapStyle-activeAccess"}],initial:[{class:"mapboxgl-ctrl-zoom-in",icon:"controll-zoomIn-initial"},{class:"mapboxgl-ctrl-zoom-out",icon:"controll-zoomOut-initial"},{class:"mapboxgl-ctrl-compass",icon:"controll-compass-initial"},{class:"mapboxgl-ctrl-fullscreen",icon:"controll-fullScreen-initial"},{class:"mapboxgl-ctrl-shrink",icon:"controll-fullScreen-active"},{class:"mapboxgl-ctrl-access",icon:"controll-access-initial"},{class:"mapboxgl-ctrl-map-style",icon:"controll-mapStyle-initial"},{class:"mapboxgl-ctrl-location",icon:"controll-location-initial"}],access:[{class:"mapboxgl-ctrl-shrink",icon:"controll-fullScreen-activeAccess"}]},ae="",we="",Ae="";for(let[Ge,Te]of Object.entries(J))for(let{class:We,icon:ft}of Te){let _t;Ge==="hover"&&(_t=v),Ge==="active"&&(_t=w),Ge==="activeAccess"&&(_t=I),Ge==="access"&&(_t=O),_t||(_t=m);let Pt=ps.get(ft),wt=`${_t.replaceAll("$base",We).replaceAll("$pseudo","hover")}${n.replace("$icon",Pt)}
=======
		</svg>`;return`data:image/svg+xml;base64,${btoa(m)}`}function Iw(){let S="marker",m="#063D57",v="white",T="#ffffffff",A=Ew(m,v,1,T),n=Ew(m,v,1.5,T);ps.set(S,A),ps.set(`${S}-hightlighted`,n)}function Aw(){let S={cloudDark:"#063D57",cloudMain:"#566981",waterMain:"#1E90FF",waterMainAccess:"#0000FF"},m={active:S.waterMain,activeAccess:S.waterMainAccess,initial:S.cloudMain,hover:S.cloudDark},v={zoomIn:sC,zoomOut:aC,search:hC,fullScreen:cC,compass:uC,access:lC,mapStyle:dC,location:fC},T="controll";for(let[n,O]of Object.entries(v))for(let[V,H]of Object.entries(m)){let J=O(H);ps.set(`${T}-${n}-${V}`,J)}let A=pC();ps.set("controll-reset-search",A)}function Ga(S){if(S===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return S}function Ow(S,m){S.prototype=Object.create(m.prototype),S.prototype.constructor=S,S.__proto__=m}var qo={autoSleep:120,force3D:"auto",nullTargetWarn:1,units:{lineHeight:""}},qu={duration:.5,overwrite:!1,delay:0},E0,Wn,nn,ms=1e8,qr=1/ms,f0=Math.PI*2,mC=f0/4,_C=0,kw=Math.sqrt,gC=Math.cos,yC=Math.sin,Rn=function(m){return typeof m=="string"},pn=function(m){return typeof m=="function"},Ha=function(m){return typeof m=="number"},N_=function(m){return typeof m>"u"},ma=function(m){return typeof m=="object"},Go=function(m){return m!==!1},I0=function(){return typeof window<"u"},P_=function(m){return pn(m)||Rn(m)},Fw=typeof ArrayBuffer=="function"&&ArrayBuffer.isView||function(){},ro=Array.isArray,m0=/(?:-?\.?\d|\.)+/gi,A0=/[-+=.]*\d+[.e\-+]*\d*[e\-+]*\d*/g,uh=/[-+=.]*\d+[.e-]*\d*[a-z%]*/g,a0=/[-+=.]*\d+\.?\d*(?:e-|e\+)?\d*/gi,M0=/[+-]=-?[.\d]+/,Bw=/[^,'"\[\]\s]+/gi,xC=/^[+\-=e\s\d]*\d+[.\d]*([a-z]*|%)\s*$/i,sn,pa,_0,C0,ts={},D_={},Nw,Vw=function(m){return(D_=Hu(m,ts))&&no},V_=function(m,v){return console.warn("Invalid property",m,"set to",v,"Missing plugin? gsap.registerPlugin()")},pf=function(m,v){return!v&&console.warn(m)},Uw=function(m,v){return m&&(ts[m]=v)&&D_&&(D_[m]=v)||ts},ff=function(){return 0},vC={suppressEvents:!0,isStart:!0,kill:!1},R_={suppressEvents:!0,kill:!1},bC={suppressEvents:!0},P0={},Zl=[],g0={},jw,Uo={},l0={},Mw=30,L_=[],R0="",L0=function(m){var v=m[0],T,A;if(ma(v)||pn(v)||(m=[m]),!(T=(v._gsap||{}).harness)){for(A=L_.length;A--&&!L_[A].targetTest(v););T=L_[A]}for(A=m.length;A--;)m[A]&&(m[A]._gsap||(m[A]._gsap=new k0(m[A],T)))||m.splice(A,1);return m},Wl=function(m){return m._gsap||L0(_s(m))[0]._gsap},z0=function(m,v,T){return(T=m[v])&&pn(T)?m[v]():N_(T)&&m.getAttribute&&m.getAttribute(v)||T},Ao=function(m,v){return(m=m.split(",")).forEach(v)||m},fn=function(m){return Math.round(m*1e5)/1e5||0},Tn=function(m){return Math.round(m*1e7)/1e7||0},dh=function(m,v){var T=v.charAt(0),A=parseFloat(v.substr(2));return m=parseFloat(m),T==="+"?m+A:T==="-"?m-A:T==="*"?m*A:m/A},wC=function(m,v){for(var T=v.length,A=0;m.indexOf(v[A])<0&&++A<T;);return A<T},O_=function(){var m=Zl.length,v=Zl.slice(0),T,A;for(g0={},Zl.length=0,T=0;T<m;T++)A=v[T],A&&A._lazy&&(A.render(A._lazy[0],A._lazy[1],!0)._lazy=0)},D0=function(m){return!!(m._initted||m._startAt||m.add)},Gw=function(m,v,T,A){Zl.length&&!Wn&&O_(),m.render(v,T,A||!!(Wn&&v<0&&D0(m))),Zl.length&&!Wn&&O_()},qw=function(m){var v=parseFloat(m);return(v||v===0)&&(m+"").match(Bw).length<2?v:Rn(m)?m.trim():m},Hw=function(m){return m},is=function(m,v){for(var T in v)T in m||(m[T]=v[T]);return m},TC=function(m){return function(v,T){for(var A in T)A in v||A==="duration"&&m||A==="ease"||(v[A]=T[A])}},Hu=function(m,v){for(var T in v)m[T]=v[T];return m},Cw=function S(m,v){for(var T in v)T!=="__proto__"&&T!=="constructor"&&T!=="prototype"&&(m[T]=ma(v[T])?S(m[T]||(m[T]={}),v[T]):v[T]);return m},k_=function(m,v){var T={},A;for(A in m)A in v||(T[A]=m[A]);return T},hf=function(m){var v=m.parent||sn,T=m.keyframes?TC(ro(m.keyframes)):is;if(Go(m.inherit))for(;v;)T(m,v.vars.defaults),v=v.parent||v._dp;return m},SC=function(m,v){for(var T=m.length,A=T===v.length;A&&T--&&m[T]===v[T];);return T<0},$w=function(m,v,T,A,n){T===void 0&&(T="_first"),A===void 0&&(A="_last");var O=m[A],V;if(n)for(V=v[n];O&&O[n]>V;)O=O._prev;return O?(v._next=O._next,O._next=v):(v._next=m[T],m[T]=v),v._next?v._next._prev=v:m[A]=v,v._prev=O,v.parent=v._dp=m,v},U_=function(m,v,T,A){T===void 0&&(T="_first"),A===void 0&&(A="_last");var n=v._prev,O=v._next;n?n._next=O:m[T]===v&&(m[T]=O),O?O._prev=n:m[A]===v&&(m[A]=n),v._next=v._prev=v.parent=null},Xl=function(m,v){m.parent&&(!v||m.parent.autoRemoveChildren)&&m.parent.remove&&m.parent.remove(m),m._act=0},lh=function(m,v){if(m&&(!v||v._end>m._dur||v._start<0))for(var T=m;T;)T._dirty=1,T=T.parent;return m},EC=function(m){for(var v=m.parent;v&&v.parent;)v._dirty=1,v.totalDuration(),v=v.parent;return m},y0=function(m,v,T,A){return m._startAt&&(Wn?m._startAt.revert(R_):m.vars.immediateRender&&!m.vars.autoRevert||m._startAt.render(v,!0,A))},IC=function S(m){return!m||m._ts&&S(m.parent)},Pw=function(m){return m._repeat?$u(m._tTime,m=m.duration()+m._rDelay)*m:0},$u=function(m,v){var T=Math.floor(m=Tn(m/v));return m&&T===m?T-1:T},F_=function(m,v){return(m-v._start)*v._ts+(v._ts>=0?0:v._dirty?v.totalDuration():v._tDur)},j_=function(m){return m._end=Tn(m._start+(m._tDur/Math.abs(m._ts||m._rts||qr)||0))},G_=function(m,v){var T=m._dp;return T&&T.smoothChildTiming&&m._ts&&(m._start=Tn(T._time-(m._ts>0?v/m._ts:((m._dirty?m.totalDuration():m._tDur)-v)/-m._ts)),j_(m),T._dirty||lh(T,m)),m},Zw=function(m,v){var T;if((v._time||!v._dur&&v._initted||v._start<m._time&&(v._dur||!v.add))&&(T=F_(m.rawTime(),v),(!v._dur||gf(0,v.totalDuration(),T)-v._tTime>qr)&&v.render(T,!0)),lh(m,v)._dp&&m._initted&&m._time>=m._dur&&m._ts){if(m._dur<m.duration())for(T=m;T._dp;)T.rawTime()>=0&&T.totalTime(T._tTime),T=T._dp;m._zTime=-qr}},fa=function(m,v,T,A){return v.parent&&Xl(v),v._start=Tn((Ha(T)?T:T||m!==sn?fs(m,T,v):m._time)+v._delay),v._end=Tn(v._start+(v.totalDuration()/Math.abs(v.timeScale())||0)),$w(m,v,"_first","_last",m._sort?"_start":0),x0(v)||(m._recent=v),A||Zw(m,v),m._ts<0&&G_(m,m._tTime),m},Ww=function(m,v){return(ts.ScrollTrigger||V_("scrollTrigger",v))&&ts.ScrollTrigger.create(v,m)},Xw=function(m,v,T,A,n){if(N0(m,v,n),!m._initted)return 1;if(!T&&m._pt&&!Wn&&(m._dur&&m.vars.lazy!==!1||!m._dur&&m.vars.lazy)&&jw!==jo.frame)return Zl.push(m),m._lazy=[n,A],1},AC=function S(m){var v=m.parent;return v&&v._ts&&v._initted&&!v._lock&&(v.rawTime()<0||S(v))},x0=function(m){var v=m.data;return v==="isFromStart"||v==="isStart"},MC=function(m,v,T,A){var n=m.ratio,O=v<0||!v&&(!m._start&&AC(m)&&!(!m._initted&&x0(m))||(m._ts<0||m._dp._ts<0)&&!x0(m))?0:1,V=m._rDelay,H=0,J,ae,we;if(V&&m._repeat&&(H=gf(0,m._tDur,v),ae=$u(H,V),m._yoyo&&ae&1&&(O=1-O),ae!==$u(m._tTime,V)&&(n=1-O,m.vars.repeatRefresh&&m._initted&&m.invalidate())),O!==n||Wn||A||m._zTime===qr||!v&&m._zTime){if(!m._initted&&Xw(m,v,A,T,H))return;for(we=m._zTime,m._zTime=v||(T?qr:0),T||(T=v&&!we),m.ratio=O,m._from&&(O=1-O),m._time=0,m._tTime=H,J=m._pt;J;)J.r(O,J.d),J=J._next;v<0&&y0(m,v,T,!0),m._onUpdate&&!T&&es(m,"onUpdate"),H&&m._repeat&&!T&&m.parent&&es(m,"onRepeat"),(v>=m._tDur||v<0)&&m.ratio===O&&(O&&Xl(m,1),!T&&!Wn&&(es(m,O?"onComplete":"onReverseComplete",!0),m._prom&&m._prom()))}else m._zTime||(m._zTime=v)},CC=function(m,v,T){var A;if(T>v)for(A=m._first;A&&A._start<=T;){if(A.data==="isPause"&&A._start>v)return A;A=A._next}else for(A=m._last;A&&A._start>=T;){if(A.data==="isPause"&&A._start<v)return A;A=A._prev}},Zu=function(m,v,T,A){var n=m._repeat,O=Tn(v)||0,V=m._tTime/m._tDur;return V&&!A&&(m._time*=O/m._dur),m._dur=O,m._tDur=n?n<0?1e10:Tn(O*(n+1)+m._rDelay*n):O,V>0&&!A&&G_(m,m._tTime=m._tDur*V),m.parent&&j_(m),T||lh(m.parent,m),m},Rw=function(m){return m instanceof Zn?lh(m):Zu(m,m._dur)},PC={_start:0,endTime:ff,totalDuration:ff},fs=function S(m,v,T){var A=m.labels,n=m._recent||PC,O=m.duration()>=ms?n.endTime(!1):m._dur,V,H,J;return Rn(v)&&(isNaN(v)||v in A)?(H=v.charAt(0),J=v.substr(-1)==="%",V=v.indexOf("="),H==="<"||H===">"?(V>=0&&(v=v.replace(/=/,"")),(H==="<"?n._start:n.endTime(n._repeat>=0))+(parseFloat(v.substr(1))||0)*(J?(V<0?n:T).totalDuration()/100:1)):V<0?(v in A||(A[v]=O),A[v]):(H=parseFloat(v.charAt(V-1)+v.substr(V+1)),J&&T&&(H=H/100*(ro(T)?T[0]:T).totalDuration()),V>1?S(m,v.substr(0,V-1),T)+H:O+H)):v==null?O:+v},uf=function(m,v,T){var A=Ha(v[1]),n=(A?2:1)+(m<2?0:1),O=v[n],V,H;if(A&&(O.duration=v[1]),O.parent=T,m){for(V=O,H=T;H&&!("immediateRender"in V);)V=H.vars.defaults||{},H=Go(H.vars.inherit)&&H.parent;O.immediateRender=Go(V.immediateRender),m<2?O.runBackwards=1:O.startAt=v[n-1]}return new gn(v[0],O,v[n+1])},Yl=function(m,v){return m||m===0?v(m):v},gf=function(m,v,T){return T<m?m:T>v?v:T},Xn=function(m,v){return!Rn(m)||!(v=xC.exec(m))?"":v[1]},RC=function(m,v,T){return Yl(T,function(A){return gf(m,v,A)})},v0=[].slice,Yw=function(m,v){return m&&ma(m)&&"length"in m&&(!v&&!m.length||m.length-1 in m&&ma(m[0]))&&!m.nodeType&&m!==pa},LC=function(m,v,T){return T===void 0&&(T=[]),m.forEach(function(A){var n;return Rn(A)&&!v||Yw(A,1)?(n=T).push.apply(n,_s(A)):T.push(A)})||T},_s=function(m,v,T){return nn&&!v&&nn.selector?nn.selector(m):Rn(m)&&!T&&(_0||!Wu())?v0.call((v||C0).querySelectorAll(m),0):ro(m)?LC(m,T):Yw(m)?v0.call(m,0):m?[m]:[]},b0=function(m){return m=_s(m)[0]||pf("Invalid scope")||{},function(v){var T=m.current||m.nativeElement||m;return _s(v,T.querySelectorAll?T:T===m?pf("Invalid scope")||C0.createElement("div"):m)}},Kw=function(m){return m.sort(function(){return .5-Math.random()})},Jw=function(m){if(pn(m))return m;var v=ma(m)?m:{each:m},T=ch(v.ease),A=v.from||0,n=parseFloat(v.base)||0,O={},V=A>0&&A<1,H=isNaN(A)||V,J=v.axis,ae=A,we=A;return Rn(A)?ae=we={center:.5,edges:.5,end:1}[A]||0:!V&&H&&(ae=A[0],we=A[1]),function(Ae,xe,Ge){var Te=(Ge||v).length,We=O[Te],ft,_t,Pt,At,wt,Ct,Ft,Wt,mt;if(!We){if(mt=v.grid==="auto"?0:(v.grid||[1,ms])[1],!mt){for(Ft=-ms;Ft<(Ft=Ge[mt++].getBoundingClientRect().left)&&mt<Te;);mt<Te&&mt--}for(We=O[Te]=[],ft=H?Math.min(mt,Te)*ae-.5:A%mt,_t=mt===ms?0:H?Te*we/mt-.5:A/mt|0,Ft=0,Wt=ms,Ct=0;Ct<Te;Ct++)Pt=Ct%mt-ft,At=_t-(Ct/mt|0),We[Ct]=wt=J?Math.abs(J==="y"?At:Pt):kw(Pt*Pt+At*At),wt>Ft&&(Ft=wt),wt<Wt&&(Wt=wt);A==="random"&&Kw(We),We.max=Ft-Wt,We.min=Wt,We.v=Te=(parseFloat(v.amount)||parseFloat(v.each)*(mt>Te?Te-1:J?J==="y"?Te/mt:mt:Math.max(mt,Te/mt))||0)*(A==="edges"?-1:1),We.b=Te<0?n-Te:n,We.u=Xn(v.amount||v.each)||0,T=T&&Te<0?aT(T):T}return Te=(We[Ae]-We.min)/We.max||0,Tn(We.b+(T?T(Te):Te)*We.v)+We.u}},w0=function(m){var v=Math.pow(10,((m+"").split(".")[1]||"").length);return function(T){var A=Tn(Math.round(parseFloat(T)/m)*m*v);return(A-A%1)/v+(Ha(T)?0:Xn(T))}},Qw=function(m,v){var T=ro(m),A,n;return!T&&ma(m)&&(A=T=m.radius||ms,m.values?(m=_s(m.values),(n=!Ha(m[0]))&&(A*=A)):m=w0(m.increment)),Yl(v,T?pn(m)?function(O){return n=m(O),Math.abs(n-O)<=A?n:O}:function(O){for(var V=parseFloat(n?O.x:O),H=parseFloat(n?O.y:0),J=ms,ae=0,we=m.length,Ae,xe;we--;)n?(Ae=m[we].x-V,xe=m[we].y-H,Ae=Ae*Ae+xe*xe):Ae=Math.abs(m[we]-V),Ae<J&&(J=Ae,ae=we);return ae=!A||J<=A?m[ae]:O,n||ae===O||Ha(O)?ae:ae+Xn(O)}:w0(m))},eT=function(m,v,T,A){return Yl(ro(m)?!v:T===!0?!!(T=0):!A,function(){return ro(m)?m[~~(Math.random()*m.length)]:(T=T||1e-5)&&(A=T<1?Math.pow(10,(T+"").length-2):1)&&Math.floor(Math.round((m-T/2+Math.random()*(v-m+T*.99))/T)*T*A)/A})},zC=function(){for(var m=arguments.length,v=new Array(m),T=0;T<m;T++)v[T]=arguments[T];return function(A){return v.reduce(function(n,O){return O(n)},A)}},DC=function(m,v){return function(T){return m(parseFloat(T))+(v||Xn(T))}},OC=function(m,v,T){return iT(m,v,0,1,T)},tT=function(m,v,T){return Yl(T,function(A){return m[~~v(A)]})},kC=function S(m,v,T){var A=v-m;return ro(m)?tT(m,S(0,m.length),v):Yl(T,function(n){return(A+(n-m)%A)%A+m})},FC=function S(m,v,T){var A=v-m,n=A*2;return ro(m)?tT(m,S(0,m.length-1),v):Yl(T,function(O){return O=(n+(O-m)%n)%n||0,m+(O>A?n-O:O)})},Xu=function(m){for(var v=0,T="",A,n,O,V;~(A=m.indexOf("random(",v));)O=m.indexOf(")",A),V=m.charAt(A+7)==="[",n=m.substr(A+7,O-A-7).match(V?Bw:m0),T+=m.substr(v,A-v)+eT(V?n:+n[0],V?0:+n[1],+n[2]||1e-5),v=O+1;return T+m.substr(v,m.length-v)},iT=function(m,v,T,A,n){var O=v-m,V=A-T;return Yl(n,function(H){return T+((H-m)/O*V||0)})},BC=function S(m,v,T,A){var n=isNaN(m+v)?0:function(xe){return(1-xe)*m+xe*v};if(!n){var O=Rn(m),V={},H,J,ae,we,Ae;if(T===!0&&(A=1)&&(T=null),O)m={p:m},v={p:v};else if(ro(m)&&!ro(v)){for(ae=[],we=m.length,Ae=we-2,J=1;J<we;J++)ae.push(S(m[J-1],m[J]));we--,n=function(Ge){Ge*=we;var Te=Math.min(Ae,~~Ge);return ae[Te](Ge-Te)},T=v}else A||(m=Hu(ro(m)?[]:{},m));if(!ae){for(H in v)F0.call(V,m,H,"get",v[H]);n=function(Ge){return j0(Ge,V)||(O?m.p:m)}}}return Yl(T,n)},Lw=function(m,v,T){var A=m.labels,n=ms,O,V,H;for(O in A)V=A[O]-v,V<0==!!T&&V&&n>(V=Math.abs(V))&&(H=O,n=V);return H},es=function(m,v,T){var A=m.vars,n=A[v],O=nn,V=m._ctx,H,J,ae;if(n)return H=A[v+"Params"],J=A.callbackScope||m,T&&Zl.length&&O_(),V&&(nn=V),ae=H?n.apply(J,H):n.call(J),nn=O,ae},lf=function(m){return Xl(m),m.scrollTrigger&&m.scrollTrigger.kill(!!Wn),m.progress()<1&&es(m,"onInterrupt"),m},Gu,rT=[],nT=function(m){if(m)if(m=!m.name&&m.default||m,I0()||m.headless){var v=m.name,T=pn(m),A=v&&!T&&m.init?function(){this._props=[]}:m,n={init:ff,render:j0,add:F0,kill:eP,modifier:QC,rawVars:0},O={targetTest:0,get:0,getSetter:q_,aliases:{},register:0};if(Wu(),m!==A){if(Uo[v])return;is(A,is(k_(m,n),O)),Hu(A.prototype,Hu(n,k_(m,O))),Uo[A.prop=v]=A,m.targetTest&&(L_.push(A),P0[v]=1),v=(v==="css"?"CSS":v.charAt(0).toUpperCase()+v.substr(1))+"Plugin"}Uw(v,A),m.register&&m.register(no,A,Mo)}else rT.push(m)},Gr=255,cf={aqua:[0,Gr,Gr],lime:[0,Gr,0],silver:[192,192,192],black:[0,0,0],maroon:[128,0,0],teal:[0,128,128],blue:[0,0,Gr],navy:[0,0,128],white:[Gr,Gr,Gr],olive:[128,128,0],yellow:[Gr,Gr,0],orange:[Gr,165,0],gray:[128,128,128],purple:[128,0,128],green:[0,128,0],red:[Gr,0,0],pink:[Gr,192,203],cyan:[0,Gr,Gr],transparent:[Gr,Gr,Gr,0]},c0=function(m,v,T){return m+=m<0?1:m>1?-1:0,(m*6<1?v+(T-v)*m*6:m<.5?T:m*3<2?v+(T-v)*(2/3-m)*6:v)*Gr+.5|0},oT=function(m,v,T){var A=m?Ha(m)?[m>>16,m>>8&Gr,m&Gr]:0:cf.black,n,O,V,H,J,ae,we,Ae,xe,Ge;if(!A){if(m.substr(-1)===","&&(m=m.substr(0,m.length-1)),cf[m])A=cf[m];else if(m.charAt(0)==="#"){if(m.length<6&&(n=m.charAt(1),O=m.charAt(2),V=m.charAt(3),m="#"+n+n+O+O+V+V+(m.length===5?m.charAt(4)+m.charAt(4):"")),m.length===9)return A=parseInt(m.substr(1,6),16),[A>>16,A>>8&Gr,A&Gr,parseInt(m.substr(7),16)/255];m=parseInt(m.substr(1),16),A=[m>>16,m>>8&Gr,m&Gr]}else if(m.substr(0,3)==="hsl"){if(A=Ge=m.match(m0),!v)H=+A[0]%360/360,J=+A[1]/100,ae=+A[2]/100,O=ae<=.5?ae*(J+1):ae+J-ae*J,n=ae*2-O,A.length>3&&(A[3]*=1),A[0]=c0(H+1/3,n,O),A[1]=c0(H,n,O),A[2]=c0(H-1/3,n,O);else if(~m.indexOf("="))return A=m.match(A0),T&&A.length<4&&(A[3]=1),A}else A=m.match(m0)||cf.transparent;A=A.map(Number)}return v&&!Ge&&(n=A[0]/Gr,O=A[1]/Gr,V=A[2]/Gr,we=Math.max(n,O,V),Ae=Math.min(n,O,V),ae=(we+Ae)/2,we===Ae?H=J=0:(xe=we-Ae,J=ae>.5?xe/(2-we-Ae):xe/(we+Ae),H=we===n?(O-V)/xe+(O<V?6:0):we===O?(V-n)/xe+2:(n-O)/xe+4,H*=60),A[0]=~~(H+.5),A[1]=~~(J*100+.5),A[2]=~~(ae*100+.5)),T&&A.length<4&&(A[3]=1),A},sT=function(m){var v=[],T=[],A=-1;return m.split(qa).forEach(function(n){var O=n.match(uh)||[];v.push.apply(v,O),T.push(A+=O.length+1)}),v.c=T,v},zw=function(m,v,T){var A="",n=(m+A).match(qa),O=v?"hsla(":"rgba(",V=0,H,J,ae,we;if(!n)return m;if(n=n.map(function(Ae){return(Ae=oT(Ae,v,1))&&O+(v?Ae[0]+","+Ae[1]+"%,"+Ae[2]+"%,"+Ae[3]:Ae.join(","))+")"}),T&&(ae=sT(m),H=T.c,H.join(A)!==ae.c.join(A)))for(J=m.replace(qa,"1").split(uh),we=J.length-1;V<we;V++)A+=J[V]+(~H.indexOf(V)?n.shift()||O+"0,0,0,0)":(ae.length?ae:n.length?n:T).shift());if(!J)for(J=m.split(qa),we=J.length-1;V<we;V++)A+=J[V]+n[V];return A+J[we]},qa=function(){var S="(?:\\b(?:(?:rgb|rgba|hsl|hsla)\\(.+?\\))|\\B#(?:[0-9a-f]{3,4}){1,2}\\b",m;for(m in cf)S+="|"+m+"\\b";return new RegExp(S+")","gi")}(),NC=/hsl[a]?\(/,O0=function(m){var v=m.join(" "),T;if(qa.lastIndex=0,qa.test(v))return T=NC.test(v),m[1]=zw(m[1],T),m[0]=zw(m[0],T,sT(m[1])),!0},mf,jo=function(){var S=Date.now,m=500,v=33,T=S(),A=T,n=1e3/240,O=n,V=[],H,J,ae,we,Ae,xe,Ge=function Te(We){var ft=S()-A,_t=We===!0,Pt,At,wt,Ct;if((ft>m||ft<0)&&(T+=ft-v),A+=ft,wt=A-T,Pt=wt-O,(Pt>0||_t)&&(Ct=++we.frame,Ae=wt-we.time*1e3,we.time=wt=wt/1e3,O+=Pt+(Pt>=n?4:n-Pt),At=1),_t||(H=J(Te)),At)for(xe=0;xe<V.length;xe++)V[xe](wt,Ae,Ct,We)};return we={time:0,frame:0,tick:function(){Ge(!0)},deltaRatio:function(We){return Ae/(1e3/(We||60))},wake:function(){Nw&&(!_0&&I0()&&(pa=_0=window,C0=pa.document||{},ts.gsap=no,(pa.gsapVersions||(pa.gsapVersions=[])).push(no.version),Vw(D_||pa.GreenSockGlobals||!pa.gsap&&pa||{}),rT.forEach(nT)),ae=typeof requestAnimationFrame<"u"&&requestAnimationFrame,H&&we.sleep(),J=ae||function(We){return setTimeout(We,O-we.time*1e3+1|0)},mf=1,Ge(2))},sleep:function(){(ae?cancelAnimationFrame:clearTimeout)(H),mf=0,J=ff},lagSmoothing:function(We,ft){m=We||1/0,v=Math.min(ft||33,m)},fps:function(We){n=1e3/(We||240),O=we.time*1e3+n},add:function(We,ft,_t){var Pt=ft?function(At,wt,Ct,Ft){We(At,wt,Ct,Ft),we.remove(Pt)}:We;return we.remove(We),V[_t?"unshift":"push"](Pt),Wu(),Pt},remove:function(We,ft){~(ft=V.indexOf(We))&&V.splice(ft,1)&&xe>=ft&&xe--},_listeners:V},we}(),Wu=function(){return!mf&&jo.wake()},br={},VC=/^[\d.\-M][\d.\-,\s]/,UC=/["']/g,jC=function(m){for(var v={},T=m.substr(1,m.length-3).split(":"),A=T[0],n=1,O=T.length,V,H,J;n<O;n++)H=T[n],V=n!==O-1?H.lastIndexOf(","):H.length,J=H.substr(0,V),v[A]=isNaN(J)?J.replace(UC,"").trim():+J,A=H.substr(V+1).trim();return v},GC=function(m){var v=m.indexOf("(")+1,T=m.indexOf(")"),A=m.indexOf("(",v);return m.substring(v,~A&&A<T?m.indexOf(")",T+1):T)},qC=function(m){var v=(m+"").split("("),T=br[v[0]];return T&&v.length>1&&T.config?T.config.apply(null,~m.indexOf("{")?[jC(v[1])]:GC(m).split(",").map(qw)):br._CE&&VC.test(m)?br._CE("",m):T},aT=function(m){return function(v){return 1-m(1-v)}},lT=function S(m,v){for(var T=m._first,A;T;)T instanceof Zn?S(T,v):T.vars.yoyoEase&&(!T._yoyo||!T._repeat)&&T._yoyo!==v&&(T.timeline?S(T.timeline,v):(A=T._ease,T._ease=T._yEase,T._yEase=A,T._yoyo=v)),T=T._next},ch=function(m,v){return m&&(pn(m)?m:br[m]||qC(m))||v},ph=function(m,v,T,A){T===void 0&&(T=function(H){return 1-v(1-H)}),A===void 0&&(A=function(H){return H<.5?v(H*2)/2:1-v((1-H)*2)/2});var n={easeIn:v,easeOut:T,easeInOut:A},O;return Ao(m,function(V){br[V]=ts[V]=n,br[O=V.toLowerCase()]=T;for(var H in n)br[O+(H==="easeIn"?".in":H==="easeOut"?".out":".inOut")]=br[V+"."+H]=n[H]}),n},cT=function(m){return function(v){return v<.5?(1-m(1-v*2))/2:.5+m((v-.5)*2)/2}},h0=function S(m,v,T){var A=v>=1?v:1,n=(T||(m?.3:.45))/(v<1?v:1),O=n/f0*(Math.asin(1/A)||0),V=function(ae){return ae===1?1:A*Math.pow(2,-10*ae)*yC((ae-O)*n)+1},H=m==="out"?V:m==="in"?function(J){return 1-V(1-J)}:cT(V);return n=f0/n,H.config=function(J,ae){return S(m,J,ae)},H},u0=function S(m,v){v===void 0&&(v=1.70158);var T=function(O){return O?--O*O*((v+1)*O+v)+1:0},A=m==="out"?T:m==="in"?function(n){return 1-T(1-n)}:cT(T);return A.config=function(n){return S(m,n)},A};Ao("Linear,Quad,Cubic,Quart,Quint,Strong",function(S,m){var v=m<5?m+1:m;ph(S+",Power"+(v-1),m?function(T){return Math.pow(T,v)}:function(T){return T},function(T){return 1-Math.pow(1-T,v)},function(T){return T<.5?Math.pow(T*2,v)/2:1-Math.pow((1-T)*2,v)/2})});br.Linear.easeNone=br.none=br.Linear.easeIn;ph("Elastic",h0("in"),h0("out"),h0());(function(S,m){var v=1/m,T=2*v,A=2.5*v,n=function(V){return V<v?S*V*V:V<T?S*Math.pow(V-1.5/m,2)+.75:V<A?S*(V-=2.25/m)*V+.9375:S*Math.pow(V-2.625/m,2)+.984375};ph("Bounce",function(O){return 1-n(1-O)},n)})(7.5625,2.75);ph("Expo",function(S){return Math.pow(2,10*(S-1))*S+S*S*S*S*S*S*(1-S)});ph("Circ",function(S){return-(kw(1-S*S)-1)});ph("Sine",function(S){return S===1?1:-gC(S*mC)+1});ph("Back",u0("in"),u0("out"),u0());br.SteppedEase=br.steps=ts.SteppedEase={config:function(m,v){m===void 0&&(m=1);var T=1/m,A=m+(v?0:1),n=v?1:0,O=1-qr;return function(V){return((A*gf(0,O,V)|0)+n)*T}}};qu.ease=br["quad.out"];Ao("onComplete,onUpdate,onStart,onRepeat,onReverseComplete,onInterrupt",function(S){return R0+=S+","+S+"Params,"});var k0=function(m,v){this.id=_C++,m._gsap=this,this.target=m,this.harness=v,this.get=v?v.get:z0,this.set=v?v.getSetter:q_},_f=function(){function S(v){this.vars=v,this._delay=+v.delay||0,(this._repeat=v.repeat===1/0?-2:v.repeat||0)&&(this._rDelay=v.repeatDelay||0,this._yoyo=!!v.yoyo||!!v.yoyoEase),this._ts=1,Zu(this,+v.duration,1,1),this.data=v.data,nn&&(this._ctx=nn,nn.data.push(this)),mf||jo.wake()}var m=S.prototype;return m.delay=function(T){return T||T===0?(this.parent&&this.parent.smoothChildTiming&&this.startTime(this._start+T-this._delay),this._delay=T,this):this._delay},m.duration=function(T){return arguments.length?this.totalDuration(this._repeat>0?T+(T+this._rDelay)*this._repeat:T):this.totalDuration()&&this._dur},m.totalDuration=function(T){return arguments.length?(this._dirty=0,Zu(this,this._repeat<0?T:(T-this._repeat*this._rDelay)/(this._repeat+1))):this._tDur},m.totalTime=function(T,A){if(Wu(),!arguments.length)return this._tTime;var n=this._dp;if(n&&n.smoothChildTiming&&this._ts){for(G_(this,T),!n._dp||n.parent||Zw(n,this);n&&n.parent;)n.parent._time!==n._start+(n._ts>=0?n._tTime/n._ts:(n.totalDuration()-n._tTime)/-n._ts)&&n.totalTime(n._tTime,!0),n=n.parent;!this.parent&&this._dp.autoRemoveChildren&&(this._ts>0&&T<this._tDur||this._ts<0&&T>0||!this._tDur&&!T)&&fa(this._dp,this,this._start-this._delay)}return(this._tTime!==T||!this._dur&&!A||this._initted&&Math.abs(this._zTime)===qr||!T&&!this._initted&&(this.add||this._ptLookup))&&(this._ts||(this._pTime=T),Gw(this,T,A)),this},m.time=function(T,A){return arguments.length?this.totalTime(Math.min(this.totalDuration(),T+Pw(this))%(this._dur+this._rDelay)||(T?this._dur:0),A):this._time},m.totalProgress=function(T,A){return arguments.length?this.totalTime(this.totalDuration()*T,A):this.totalDuration()?Math.min(1,this._tTime/this._tDur):this.rawTime()>=0&&this._initted?1:0},m.progress=function(T,A){return arguments.length?this.totalTime(this.duration()*(this._yoyo&&!(this.iteration()&1)?1-T:T)+Pw(this),A):this.duration()?Math.min(1,this._time/this._dur):this.rawTime()>0?1:0},m.iteration=function(T,A){var n=this.duration()+this._rDelay;return arguments.length?this.totalTime(this._time+(T-1)*n,A):this._repeat?$u(this._tTime,n)+1:1},m.timeScale=function(T,A){if(!arguments.length)return this._rts===-qr?0:this._rts;if(this._rts===T)return this;var n=this.parent&&this._ts?F_(this.parent._time,this):this._tTime;return this._rts=+T||0,this._ts=this._ps||T===-qr?0:this._rts,this.totalTime(gf(-Math.abs(this._delay),this.totalDuration(),n),A!==!1),j_(this),EC(this)},m.paused=function(T){return arguments.length?(this._ps!==T&&(this._ps=T,T?(this._pTime=this._tTime||Math.max(-this._delay,this.rawTime()),this._ts=this._act=0):(Wu(),this._ts=this._rts,this.totalTime(this.parent&&!this.parent.smoothChildTiming?this.rawTime():this._tTime||this._pTime,this.progress()===1&&Math.abs(this._zTime)!==qr&&(this._tTime-=qr)))),this):this._ps},m.startTime=function(T){if(arguments.length){this._start=T;var A=this.parent||this._dp;return A&&(A._sort||!this.parent)&&fa(A,this,T-this._delay),this}return this._start},m.endTime=function(T){return this._start+(Go(T)?this.totalDuration():this.duration())/Math.abs(this._ts||1)},m.rawTime=function(T){var A=this.parent||this._dp;return A?T&&(!this._ts||this._repeat&&this._time&&this.totalProgress()<1)?this._tTime%(this._dur+this._rDelay):this._ts?F_(A.rawTime(T),this):this._tTime:this._tTime},m.revert=function(T){T===void 0&&(T=bC);var A=Wn;return Wn=T,D0(this)&&(this.timeline&&this.timeline.revert(T),this.totalTime(-.01,T.suppressEvents)),this.data!=="nested"&&T.kill!==!1&&this.kill(),Wn=A,this},m.globalTime=function(T){for(var A=this,n=arguments.length?T:A.rawTime();A;)n=A._start+n/(Math.abs(A._ts)||1),A=A._dp;return!this.parent&&this._sat?this._sat.globalTime(T):n},m.repeat=function(T){return arguments.length?(this._repeat=T===1/0?-2:T,Rw(this)):this._repeat===-2?1/0:this._repeat},m.repeatDelay=function(T){if(arguments.length){var A=this._time;return this._rDelay=T,Rw(this),A?this.time(A):this}return this._rDelay},m.yoyo=function(T){return arguments.length?(this._yoyo=T,this):this._yoyo},m.seek=function(T,A){return this.totalTime(fs(this,T),Go(A))},m.restart=function(T,A){return this.play().totalTime(T?-this._delay:0,Go(A)),this._dur||(this._zTime=-qr),this},m.play=function(T,A){return T!=null&&this.seek(T,A),this.reversed(!1).paused(!1)},m.reverse=function(T,A){return T!=null&&this.seek(T||this.totalDuration(),A),this.reversed(!0).paused(!1)},m.pause=function(T,A){return T!=null&&this.seek(T,A),this.paused(!0)},m.resume=function(){return this.paused(!1)},m.reversed=function(T){return arguments.length?(!!T!==this.reversed()&&this.timeScale(-this._rts||(T?-qr:0)),this):this._rts<0},m.invalidate=function(){return this._initted=this._act=0,this._zTime=-qr,this},m.isActive=function(){var T=this.parent||this._dp,A=this._start,n;return!!(!T||this._ts&&this._initted&&T.isActive()&&(n=T.rawTime(!0))>=A&&n<this.endTime(!0)-qr)},m.eventCallback=function(T,A,n){var O=this.vars;return arguments.length>1?(A?(O[T]=A,n&&(O[T+"Params"]=n),T==="onUpdate"&&(this._onUpdate=A)):delete O[T],this):O[T]},m.then=function(T){var A=this;return new Promise(function(n){var O=pn(T)?T:Hw,V=function(){var J=A.then;A.then=null,pn(O)&&(O=O(A))&&(O.then||O===A)&&(A.then=J),n(O),A.then=J};A._initted&&A.totalProgress()===1&&A._ts>=0||!A._tTime&&A._ts<0?V():A._prom=V})},m.kill=function(){lf(this)},S}();is(_f.prototype,{_time:0,_start:0,_end:0,_tTime:0,_tDur:0,_dirty:0,_repeat:0,_yoyo:!1,parent:null,_initted:!1,_rDelay:0,_ts:1,_dp:0,ratio:0,_zTime:-qr,_prom:0,_ps:!1,_rts:1});var Zn=function(S){Ow(m,S);function m(T,A){var n;return T===void 0&&(T={}),n=S.call(this,T)||this,n.labels={},n.smoothChildTiming=!!T.smoothChildTiming,n.autoRemoveChildren=!!T.autoRemoveChildren,n._sort=Go(T.sortChildren),sn&&fa(T.parent||sn,Ga(n),A),T.reversed&&n.reverse(),T.paused&&n.paused(!0),T.scrollTrigger&&Ww(Ga(n),T.scrollTrigger),n}var v=m.prototype;return v.to=function(A,n,O){return uf(0,arguments,this),this},v.from=function(A,n,O){return uf(1,arguments,this),this},v.fromTo=function(A,n,O,V){return uf(2,arguments,this),this},v.set=function(A,n,O){return n.duration=0,n.parent=this,hf(n).repeatDelay||(n.repeat=0),n.immediateRender=!!n.immediateRender,new gn(A,n,fs(this,O),1),this},v.call=function(A,n,O){return fa(this,gn.delayedCall(0,A,n),O)},v.staggerTo=function(A,n,O,V,H,J,ae){return O.duration=n,O.stagger=O.stagger||V,O.onComplete=J,O.onCompleteParams=ae,O.parent=this,new gn(A,O,fs(this,H)),this},v.staggerFrom=function(A,n,O,V,H,J,ae){return O.runBackwards=1,hf(O).immediateRender=Go(O.immediateRender),this.staggerTo(A,n,O,V,H,J,ae)},v.staggerFromTo=function(A,n,O,V,H,J,ae,we){return V.startAt=O,hf(V).immediateRender=Go(V.immediateRender),this.staggerTo(A,n,V,H,J,ae,we)},v.render=function(A,n,O){var V=this._time,H=this._dirty?this.totalDuration():this._tDur,J=this._dur,ae=A<=0?0:Tn(A),we=this._zTime<0!=A<0&&(this._initted||!J),Ae,xe,Ge,Te,We,ft,_t,Pt,At,wt,Ct,Ft;if(this!==sn&&ae>H&&A>=0&&(ae=H),ae!==this._tTime||O||we){if(V!==this._time&&J&&(ae+=this._time-V,A+=this._time-V),Ae=ae,At=this._start,Pt=this._ts,ft=!Pt,we&&(J||(V=this._zTime),(A||!n)&&(this._zTime=A)),this._repeat){if(Ct=this._yoyo,We=J+this._rDelay,this._repeat<-1&&A<0)return this.totalTime(We*100+A,n,O);if(Ae=Tn(ae%We),ae===H?(Te=this._repeat,Ae=J):(wt=Tn(ae/We),Te=~~wt,Te&&Te===wt&&(Ae=J,Te--),Ae>J&&(Ae=J)),wt=$u(this._tTime,We),!V&&this._tTime&&wt!==Te&&this._tTime-wt*We-this._dur<=0&&(wt=Te),Ct&&Te&1&&(Ae=J-Ae,Ft=1),Te!==wt&&!this._lock){var Wt=Ct&&wt&1,mt=Wt===(Ct&&Te&1);if(Te<wt&&(Wt=!Wt),V=Wt?0:ae%J?J:ae,this._lock=1,this.render(V||(Ft?0:Tn(Te*We)),n,!J)._lock=0,this._tTime=ae,!n&&this.parent&&es(this,"onRepeat"),this.vars.repeatRefresh&&!Ft&&(this.invalidate()._lock=1),V&&V!==this._time||ft!==!this._ts||this.vars.onRepeat&&!this.parent&&!this._act)return this;if(J=this._dur,H=this._tDur,mt&&(this._lock=2,V=Wt?J:-1e-4,this.render(V,!0),this.vars.repeatRefresh&&!Ft&&this.invalidate()),this._lock=0,!this._ts&&!ft)return this;lT(this,Ft)}}if(this._hasPause&&!this._forcing&&this._lock<2&&(_t=CC(this,Tn(V),Tn(Ae)),_t&&(ae-=Ae-(Ae=_t._start))),this._tTime=ae,this._time=Ae,this._act=!Pt,this._initted||(this._onUpdate=this.vars.onUpdate,this._initted=1,this._zTime=A,V=0),!V&&ae&&!n&&!wt&&(es(this,"onStart"),this._tTime!==ae))return this;if(Ae>=V&&A>=0)for(xe=this._first;xe;){if(Ge=xe._next,(xe._act||Ae>=xe._start)&&xe._ts&&_t!==xe){if(xe.parent!==this)return this.render(A,n,O);if(xe.render(xe._ts>0?(Ae-xe._start)*xe._ts:(xe._dirty?xe.totalDuration():xe._tDur)+(Ae-xe._start)*xe._ts,n,O),Ae!==this._time||!this._ts&&!ft){_t=0,Ge&&(ae+=this._zTime=-qr);break}}xe=Ge}else{xe=this._last;for(var er=A<0?A:Ae;xe;){if(Ge=xe._prev,(xe._act||er<=xe._end)&&xe._ts&&_t!==xe){if(xe.parent!==this)return this.render(A,n,O);if(xe.render(xe._ts>0?(er-xe._start)*xe._ts:(xe._dirty?xe.totalDuration():xe._tDur)+(er-xe._start)*xe._ts,n,O||Wn&&D0(xe)),Ae!==this._time||!this._ts&&!ft){_t=0,Ge&&(ae+=this._zTime=er?-qr:qr);break}}xe=Ge}}if(_t&&!n&&(this.pause(),_t.render(Ae>=V?0:-qr)._zTime=Ae>=V?1:-1,this._ts))return this._start=At,j_(this),this.render(A,n,O);this._onUpdate&&!n&&es(this,"onUpdate",!0),(ae===H&&this._tTime>=this.totalDuration()||!ae&&V)&&(At===this._start||Math.abs(Pt)!==Math.abs(this._ts))&&(this._lock||((A||!J)&&(ae===H&&this._ts>0||!ae&&this._ts<0)&&Xl(this,1),!n&&!(A<0&&!V)&&(ae||V||!H)&&(es(this,ae===H&&A>=0?"onComplete":"onReverseComplete",!0),this._prom&&!(ae<H&&this.timeScale()>0)&&this._prom())))}return this},v.add=function(A,n){var O=this;if(Ha(n)||(n=fs(this,n,A)),!(A instanceof _f)){if(ro(A))return A.forEach(function(V){return O.add(V,n)}),this;if(Rn(A))return this.addLabel(A,n);if(pn(A))A=gn.delayedCall(0,A);else return this}return this!==A?fa(this,A,n):this},v.getChildren=function(A,n,O,V){A===void 0&&(A=!0),n===void 0&&(n=!0),O===void 0&&(O=!0),V===void 0&&(V=-ms);for(var H=[],J=this._first;J;)J._start>=V&&(J instanceof gn?n&&H.push(J):(O&&H.push(J),A&&H.push.apply(H,J.getChildren(!0,n,O)))),J=J._next;return H},v.getById=function(A){for(var n=this.getChildren(1,1,1),O=n.length;O--;)if(n[O].vars.id===A)return n[O]},v.remove=function(A){return Rn(A)?this.removeLabel(A):pn(A)?this.killTweensOf(A):(A.parent===this&&U_(this,A),A===this._recent&&(this._recent=this._last),lh(this))},v.totalTime=function(A,n){return arguments.length?(this._forcing=1,!this._dp&&this._ts&&(this._start=Tn(jo.time-(this._ts>0?A/this._ts:(this.totalDuration()-A)/-this._ts))),S.prototype.totalTime.call(this,A,n),this._forcing=0,this):this._tTime},v.addLabel=function(A,n){return this.labels[A]=fs(this,n),this},v.removeLabel=function(A){return delete this.labels[A],this},v.addPause=function(A,n,O){var V=gn.delayedCall(0,n||ff,O);return V.data="isPause",this._hasPause=1,fa(this,V,fs(this,A))},v.removePause=function(A){var n=this._first;for(A=fs(this,A);n;)n._start===A&&n.data==="isPause"&&Xl(n),n=n._next},v.killTweensOf=function(A,n,O){for(var V=this.getTweensOf(A,O),H=V.length;H--;)$l!==V[H]&&V[H].kill(A,n);return this},v.getTweensOf=function(A,n){for(var O=[],V=_s(A),H=this._first,J=Ha(n),ae;H;)H instanceof gn?wC(H._targets,V)&&(J?(!$l||H._initted&&H._ts)&&H.globalTime(0)<=n&&H.globalTime(H.totalDuration())>n:!n||H.isActive())&&O.push(H):(ae=H.getTweensOf(V,n)).length&&O.push.apply(O,ae),H=H._next;return O},v.tweenTo=function(A,n){n=n||{};var O=this,V=fs(O,A),H=n,J=H.startAt,ae=H.onStart,we=H.onStartParams,Ae=H.immediateRender,xe,Ge=gn.to(O,is({ease:n.ease||"none",lazy:!1,immediateRender:!1,time:V,overwrite:"auto",duration:n.duration||Math.abs((V-(J&&"time"in J?J.time:O._time))/O.timeScale())||qr,onStart:function(){if(O.pause(),!xe){var We=n.duration||Math.abs((V-(J&&"time"in J?J.time:O._time))/O.timeScale());Ge._dur!==We&&Zu(Ge,We,0,1).render(Ge._time,!0,!0),xe=1}ae&&ae.apply(Ge,we||[])}},n));return Ae?Ge.render(0):Ge},v.tweenFromTo=function(A,n,O){return this.tweenTo(n,is({startAt:{time:fs(this,A)}},O))},v.recent=function(){return this._recent},v.nextLabel=function(A){return A===void 0&&(A=this._time),Lw(this,fs(this,A))},v.previousLabel=function(A){return A===void 0&&(A=this._time),Lw(this,fs(this,A),1)},v.currentLabel=function(A){return arguments.length?this.seek(A,!0):this.previousLabel(this._time+qr)},v.shiftChildren=function(A,n,O){O===void 0&&(O=0);for(var V=this._first,H=this.labels,J;V;)V._start>=O&&(V._start+=A,V._end+=A),V=V._next;if(n)for(J in H)H[J]>=O&&(H[J]+=A);return lh(this)},v.invalidate=function(A){var n=this._first;for(this._lock=0;n;)n.invalidate(A),n=n._next;return S.prototype.invalidate.call(this,A)},v.clear=function(A){A===void 0&&(A=!0);for(var n=this._first,O;n;)O=n._next,this.remove(n),n=O;return this._dp&&(this._time=this._tTime=this._pTime=0),A&&(this.labels={}),lh(this)},v.totalDuration=function(A){var n=0,O=this,V=O._last,H=ms,J,ae,we;if(arguments.length)return O.timeScale((O._repeat<0?O.duration():O.totalDuration())/(O.reversed()?-A:A));if(O._dirty){for(we=O.parent;V;)J=V._prev,V._dirty&&V.totalDuration(),ae=V._start,ae>H&&O._sort&&V._ts&&!O._lock?(O._lock=1,fa(O,V,ae-V._delay,1)._lock=0):H=ae,ae<0&&V._ts&&(n-=ae,(!we&&!O._dp||we&&we.smoothChildTiming)&&(O._start+=ae/O._ts,O._time-=ae,O._tTime-=ae),O.shiftChildren(-ae,!1,-1/0),H=0),V._end>n&&V._ts&&(n=V._end),V=J;Zu(O,O===sn&&O._time>n?O._time:n,1,1),O._dirty=0}return O._tDur},m.updateRoot=function(A){if(sn._ts&&(Gw(sn,F_(A,sn)),jw=jo.frame),jo.frame>=Mw){Mw+=qo.autoSleep||120;var n=sn._first;if((!n||!n._ts)&&qo.autoSleep&&jo._listeners.length<2){for(;n&&!n._ts;)n=n._next;n||jo.sleep()}}},m}(_f);is(Zn.prototype,{_lock:0,_hasPause:0,_forcing:0});var HC=function(m,v,T,A,n,O,V){var H=new Mo(this._pt,m,v,0,1,U0,null,n),J=0,ae=0,we,Ae,xe,Ge,Te,We,ft,_t;for(H.b=T,H.e=A,T+="",A+="",(ft=~A.indexOf("random("))&&(A=Xu(A)),O&&(_t=[T,A],O(_t,m,v),T=_t[0],A=_t[1]),Ae=T.match(a0)||[];we=a0.exec(A);)Ge=we[0],Te=A.substring(J,we.index),xe?xe=(xe+1)%5:Te.substr(-5)==="rgba("&&(xe=1),Ge!==Ae[ae++]&&(We=parseFloat(Ae[ae-1])||0,H._pt={_next:H._pt,p:Te||ae===1?Te:",",s:We,c:Ge.charAt(1)==="="?dh(We,Ge)-We:parseFloat(Ge)-We,m:xe&&xe<4?Math.round:0},J=a0.lastIndex);return H.c=J<A.length?A.substring(J,A.length):"",H.fp=V,(M0.test(A)||ft)&&(H.e=0),this._pt=H,H},F0=function(m,v,T,A,n,O,V,H,J,ae){pn(A)&&(A=A(n||0,m,O));var we=m[v],Ae=T!=="get"?T:pn(we)?J?m[v.indexOf("set")||!pn(m["get"+v.substr(3)])?v:"get"+v.substr(3)](J):m[v]():we,xe=pn(we)?J?YC:dT:V0,Ge;if(Rn(A)&&(~A.indexOf("random(")&&(A=Xu(A)),A.charAt(1)==="="&&(Ge=dh(Ae,A)+(Xn(Ae)||0),(Ge||Ge===0)&&(A=Ge))),!ae||Ae!==A||T0)return!isNaN(Ae*A)&&A!==""?(Ge=new Mo(this._pt,m,v,+Ae||0,A-(Ae||0),typeof we=="boolean"?JC:pT,0,xe),J&&(Ge.fp=J),V&&Ge.modifier(V,this,m),this._pt=Ge):(!we&&!(v in m)&&V_(v,A),HC.call(this,m,v,Ae,A,xe,H||qo.stringFilter,J))},$C=function(m,v,T,A,n){if(pn(m)&&(m=df(m,n,v,T,A)),!ma(m)||m.style&&m.nodeType||ro(m)||Fw(m))return Rn(m)?df(m,n,v,T,A):m;var O={},V;for(V in m)O[V]=df(m[V],n,v,T,A);return O},B0=function(m,v,T,A,n,O){var V,H,J,ae;if(Uo[m]&&(V=new Uo[m]).init(n,V.rawVars?v[m]:$C(v[m],A,n,O,T),T,A,O)!==!1&&(T._pt=H=new Mo(T._pt,n,m,0,1,V.render,V,0,V.priority),T!==Gu))for(J=T._ptLookup[T._targets.indexOf(n)],ae=V._props.length;ae--;)J[V._props[ae]]=H;return V},$l,T0,N0=function S(m,v,T){var A=m.vars,n=A.ease,O=A.startAt,V=A.immediateRender,H=A.lazy,J=A.onUpdate,ae=A.runBackwards,we=A.yoyoEase,Ae=A.keyframes,xe=A.autoRevert,Ge=m._dur,Te=m._startAt,We=m._targets,ft=m.parent,_t=ft&&ft.data==="nested"?ft.vars.targets:We,Pt=m._overwrite==="auto"&&!E0,At=m.timeline,wt,Ct,Ft,Wt,mt,er,Ni,yi,mi,vi,mr,Fr,Rr;if(At&&(!Ae||!n)&&(n="none"),m._ease=ch(n,qu.ease),m._yEase=we?aT(ch(we===!0?n:we,qu.ease)):0,we&&m._yoyo&&!m._repeat&&(we=m._yEase,m._yEase=m._ease,m._ease=we),m._from=!At&&!!A.runBackwards,!At||Ae&&!A.stagger){if(yi=We[0]?Wl(We[0]).harness:0,Fr=yi&&A[yi.prop],wt=k_(A,P0),Te&&(Te._zTime<0&&Te.progress(1),v<0&&ae&&V&&!xe?Te.render(-1,!0):Te.revert(ae&&Ge?R_:vC),Te._lazy=0),O){if(Xl(m._startAt=gn.set(We,is({data:"isStart",overwrite:!1,parent:ft,immediateRender:!0,lazy:!Te&&Go(H),startAt:null,delay:0,onUpdate:J&&function(){return es(m,"onUpdate")},stagger:0},O))),m._startAt._dp=0,m._startAt._sat=m,v<0&&(Wn||!V&&!xe)&&m._startAt.revert(R_),V&&Ge&&v<=0&&T<=0){v&&(m._zTime=v);return}}else if(ae&&Ge&&!Te){if(v&&(V=!1),Ft=is({overwrite:!1,data:"isFromStart",lazy:V&&!Te&&Go(H),immediateRender:V,stagger:0,parent:ft},wt),Fr&&(Ft[yi.prop]=Fr),Xl(m._startAt=gn.set(We,Ft)),m._startAt._dp=0,m._startAt._sat=m,v<0&&(Wn?m._startAt.revert(R_):m._startAt.render(-1,!0)),m._zTime=v,!V)S(m._startAt,qr,qr);else if(!v)return}for(m._pt=m._ptCache=0,H=Ge&&Go(H)||H&&!Ge,Ct=0;Ct<We.length;Ct++){if(mt=We[Ct],Ni=mt._gsap||L0(We)[Ct]._gsap,m._ptLookup[Ct]=vi={},g0[Ni.id]&&Zl.length&&O_(),mr=_t===We?Ct:_t.indexOf(mt),yi&&(mi=new yi).init(mt,Fr||wt,m,mr,_t)!==!1&&(m._pt=Wt=new Mo(m._pt,mt,mi.name,0,1,mi.render,mi,0,mi.priority),mi._props.forEach(function(Hr){vi[Hr]=Wt}),mi.priority&&(er=1)),!yi||Fr)for(Ft in wt)Uo[Ft]&&(mi=B0(Ft,wt,m,mr,mt,_t))?mi.priority&&(er=1):vi[Ft]=Wt=F0.call(m,mt,Ft,"get",wt[Ft],mr,_t,0,A.stringFilter);m._op&&m._op[Ct]&&m.kill(mt,m._op[Ct]),Pt&&m._pt&&($l=m,sn.killTweensOf(mt,vi,m.globalTime(v)),Rr=!m.parent,$l=0),m._pt&&H&&(g0[Ni.id]=1)}er&&G0(m),m._onInit&&m._onInit(m)}m._onUpdate=J,m._initted=(!m._op||m._pt)&&!Rr,Ae&&v<=0&&At.render(ms,!0,!0)},ZC=function(m,v,T,A,n,O,V,H){var J=(m._pt&&m._ptCache||(m._ptCache={}))[v],ae,we,Ae,xe;if(!J)for(J=m._ptCache[v]=[],Ae=m._ptLookup,xe=m._targets.length;xe--;){if(ae=Ae[xe][v],ae&&ae.d&&ae.d._pt)for(ae=ae.d._pt;ae&&ae.p!==v&&ae.fp!==v;)ae=ae._next;if(!ae)return T0=1,m.vars[v]="+=0",N0(m,V),T0=0,H?pf(v+" not eligible for reset"):1;J.push(ae)}for(xe=J.length;xe--;)we=J[xe],ae=we._pt||we,ae.s=(A||A===0)&&!n?A:ae.s+(A||0)+O*ae.c,ae.c=T-ae.s,we.e&&(we.e=fn(T)+Xn(we.e)),we.b&&(we.b=ae.s+Xn(we.b))},WC=function(m,v){var T=m[0]?Wl(m[0]).harness:0,A=T&&T.aliases,n,O,V,H;if(!A)return v;n=Hu({},v);for(O in A)if(O in n)for(H=A[O].split(","),V=H.length;V--;)n[H[V]]=n[O];return n},XC=function(m,v,T,A){var n=v.ease||A||"power1.inOut",O,V;if(ro(v))V=T[m]||(T[m]=[]),v.forEach(function(H,J){return V.push({t:J/(v.length-1)*100,v:H,e:n})});else for(O in v)V=T[O]||(T[O]=[]),O==="ease"||V.push({t:parseFloat(m),v:v[O],e:n})},df=function(m,v,T,A,n){return pn(m)?m.call(v,T,A,n):Rn(m)&&~m.indexOf("random(")?Xu(m):m},hT=R0+"repeat,repeatDelay,yoyo,repeatRefresh,yoyoEase,autoRevert",uT={};Ao(hT+",id,stagger,delay,duration,paused,scrollTrigger",function(S){return uT[S]=1});var gn=function(S){Ow(m,S);function m(T,A,n,O){var V;typeof A=="number"&&(n.duration=A,A=n,n=null),V=S.call(this,O?A:hf(A))||this;var H=V.vars,J=H.duration,ae=H.delay,we=H.immediateRender,Ae=H.stagger,xe=H.overwrite,Ge=H.keyframes,Te=H.defaults,We=H.scrollTrigger,ft=H.yoyoEase,_t=A.parent||sn,Pt=(ro(T)||Fw(T)?Ha(T[0]):"length"in A)?[T]:_s(T),At,wt,Ct,Ft,Wt,mt,er,Ni;if(V._targets=Pt.length?L0(Pt):pf("GSAP target "+T+" not found. https://gsap.com",!qo.nullTargetWarn)||[],V._ptLookup=[],V._overwrite=xe,Ge||Ae||P_(J)||P_(ae)){if(A=V.vars,At=V.timeline=new Zn({data:"nested",defaults:Te||{},targets:_t&&_t.data==="nested"?_t.vars.targets:Pt}),At.kill(),At.parent=At._dp=Ga(V),At._start=0,Ae||P_(J)||P_(ae)){if(Ft=Pt.length,er=Ae&&Jw(Ae),ma(Ae))for(Wt in Ae)~hT.indexOf(Wt)&&(Ni||(Ni={}),Ni[Wt]=Ae[Wt]);for(wt=0;wt<Ft;wt++)Ct=k_(A,uT),Ct.stagger=0,ft&&(Ct.yoyoEase=ft),Ni&&Hu(Ct,Ni),mt=Pt[wt],Ct.duration=+df(J,Ga(V),wt,mt,Pt),Ct.delay=(+df(ae,Ga(V),wt,mt,Pt)||0)-V._delay,!Ae&&Ft===1&&Ct.delay&&(V._delay=ae=Ct.delay,V._start+=ae,Ct.delay=0),At.to(mt,Ct,er?er(wt,mt,Pt):0),At._ease=br.none;At.duration()?J=ae=0:V.timeline=0}else if(Ge){hf(is(At.vars.defaults,{ease:"none"})),At._ease=ch(Ge.ease||A.ease||"none");var yi=0,mi,vi,mr;if(ro(Ge))Ge.forEach(function(Fr){return At.to(Pt,Fr,">")}),At.duration();else{Ct={};for(Wt in Ge)Wt==="ease"||Wt==="easeEach"||XC(Wt,Ge[Wt],Ct,Ge.easeEach);for(Wt in Ct)for(mi=Ct[Wt].sort(function(Fr,Rr){return Fr.t-Rr.t}),yi=0,wt=0;wt<mi.length;wt++)vi=mi[wt],mr={ease:vi.e,duration:(vi.t-(wt?mi[wt-1].t:0))/100*J},mr[Wt]=vi.v,At.to(Pt,mr,yi),yi+=mr.duration;At.duration()<J&&At.to({},{duration:J-At.duration()})}}J||V.duration(J=At.duration())}else V.timeline=0;return xe===!0&&!E0&&($l=Ga(V),sn.killTweensOf(Pt),$l=0),fa(_t,Ga(V),n),A.reversed&&V.reverse(),A.paused&&V.paused(!0),(we||!J&&!Ge&&V._start===Tn(_t._time)&&Go(we)&&IC(Ga(V))&&_t.data!=="nested")&&(V._tTime=-qr,V.render(Math.max(0,-ae)||0)),We&&Ww(Ga(V),We),V}var v=m.prototype;return v.render=function(A,n,O){var V=this._time,H=this._tDur,J=this._dur,ae=A<0,we=A>H-qr&&!ae?H:A<qr?0:A,Ae,xe,Ge,Te,We,ft,_t,Pt,At;if(!J)MC(this,A,n,O);else if(we!==this._tTime||!A||O||!this._initted&&this._tTime||this._startAt&&this._zTime<0!==ae||this._lazy){if(Ae=we,Pt=this.timeline,this._repeat){if(Te=J+this._rDelay,this._repeat<-1&&ae)return this.totalTime(Te*100+A,n,O);if(Ae=Tn(we%Te),we===H?(Ge=this._repeat,Ae=J):(We=Tn(we/Te),Ge=~~We,Ge&&Ge===We?(Ae=J,Ge--):Ae>J&&(Ae=J)),ft=this._yoyo&&Ge&1,ft&&(At=this._yEase,Ae=J-Ae),We=$u(this._tTime,Te),Ae===V&&!O&&this._initted&&Ge===We)return this._tTime=we,this;Ge!==We&&(Pt&&this._yEase&&lT(Pt,ft),this.vars.repeatRefresh&&!ft&&!this._lock&&Ae!==Te&&this._initted&&(this._lock=O=1,this.render(Tn(Te*Ge),!0).invalidate()._lock=0))}if(!this._initted){if(Xw(this,ae?A:Ae,O,n,we))return this._tTime=0,this;if(V!==this._time&&!(O&&this.vars.repeatRefresh&&Ge!==We))return this;if(J!==this._dur)return this.render(A,n,O)}if(this._tTime=we,this._time=Ae,!this._act&&this._ts&&(this._act=1,this._lazy=0),this.ratio=_t=(At||this._ease)(Ae/J),this._from&&(this.ratio=_t=1-_t),!V&&we&&!n&&!We&&(es(this,"onStart"),this._tTime!==we))return this;for(xe=this._pt;xe;)xe.r(_t,xe.d),xe=xe._next;Pt&&Pt.render(A<0?A:Pt._dur*Pt._ease(Ae/this._dur),n,O)||this._startAt&&(this._zTime=A),this._onUpdate&&!n&&(ae&&y0(this,A,n,O),es(this,"onUpdate")),this._repeat&&Ge!==We&&this.vars.onRepeat&&!n&&this.parent&&es(this,"onRepeat"),(we===this._tDur||!we)&&this._tTime===we&&(ae&&!this._onUpdate&&y0(this,A,!0,!0),(A||!J)&&(we===this._tDur&&this._ts>0||!we&&this._ts<0)&&Xl(this,1),!n&&!(ae&&!V)&&(we||V||ft)&&(es(this,we===H?"onComplete":"onReverseComplete",!0),this._prom&&!(we<H&&this.timeScale()>0)&&this._prom()))}return this},v.targets=function(){return this._targets},v.invalidate=function(A){return(!A||!this.vars.runBackwards)&&(this._startAt=0),this._pt=this._op=this._onUpdate=this._lazy=this.ratio=0,this._ptLookup=[],this.timeline&&this.timeline.invalidate(A),S.prototype.invalidate.call(this,A)},v.resetTo=function(A,n,O,V,H){mf||jo.wake(),this._ts||this.play();var J=Math.min(this._dur,(this._dp._time-this._start)*this._ts),ae;return this._initted||N0(this,J),ae=this._ease(J/this._dur),ZC(this,A,n,O,V,ae,J,H)?this.resetTo(A,n,O,V,1):(G_(this,0),this.parent||$w(this._dp,this,"_first","_last",this._dp._sort?"_start":0),this.render(0))},v.kill=function(A,n){if(n===void 0&&(n="all"),!A&&(!n||n==="all"))return this._lazy=this._pt=0,this.parent?lf(this):this.scrollTrigger&&this.scrollTrigger.kill(!!Wn),this;if(this.timeline){var O=this.timeline.totalDuration();return this.timeline.killTweensOf(A,n,$l&&$l.vars.overwrite!==!0)._first||lf(this),this.parent&&O!==this.timeline.totalDuration()&&Zu(this,this._dur*this.timeline._tDur/O,0,1),this}var V=this._targets,H=A?_s(A):V,J=this._ptLookup,ae=this._pt,we,Ae,xe,Ge,Te,We,ft;if((!n||n==="all")&&SC(V,H))return n==="all"&&(this._pt=0),lf(this);for(we=this._op=this._op||[],n!=="all"&&(Rn(n)&&(Te={},Ao(n,function(_t){return Te[_t]=1}),n=Te),n=WC(V,n)),ft=V.length;ft--;)if(~H.indexOf(V[ft])){Ae=J[ft],n==="all"?(we[ft]=n,Ge=Ae,xe={}):(xe=we[ft]=we[ft]||{},Ge=n);for(Te in Ge)We=Ae&&Ae[Te],We&&((!("kill"in We.d)||We.d.kill(Te)===!0)&&U_(this,We,"_pt"),delete Ae[Te]),xe!=="all"&&(xe[Te]=1)}return this._initted&&!this._pt&&ae&&lf(this),this},m.to=function(A,n){return new m(A,n,arguments[2])},m.from=function(A,n){return uf(1,arguments)},m.delayedCall=function(A,n,O,V){return new m(n,0,{immediateRender:!1,lazy:!1,overwrite:!1,delay:A,onComplete:n,onReverseComplete:n,onCompleteParams:O,onReverseCompleteParams:O,callbackScope:V})},m.fromTo=function(A,n,O){return uf(2,arguments)},m.set=function(A,n){return n.duration=0,n.repeatDelay||(n.repeat=0),new m(A,n)},m.killTweensOf=function(A,n,O){return sn.killTweensOf(A,n,O)},m}(_f);is(gn.prototype,{_targets:[],_lazy:0,_startAt:0,_op:0,_onInit:0});Ao("staggerTo,staggerFrom,staggerFromTo",function(S){gn[S]=function(){var m=new Zn,v=v0.call(arguments,0);return v.splice(S==="staggerFromTo"?5:4,0,0),m[S].apply(m,v)}});var V0=function(m,v,T){return m[v]=T},dT=function(m,v,T){return m[v](T)},YC=function(m,v,T,A){return m[v](A.fp,T)},KC=function(m,v,T){return m.setAttribute(v,T)},q_=function(m,v){return pn(m[v])?dT:N_(m[v])&&m.setAttribute?KC:V0},pT=function(m,v){return v.set(v.t,v.p,Math.round((v.s+v.c*m)*1e6)/1e6,v)},JC=function(m,v){return v.set(v.t,v.p,!!(v.s+v.c*m),v)},U0=function(m,v){var T=v._pt,A="";if(!m&&v.b)A=v.b;else if(m===1&&v.e)A=v.e;else{for(;T;)A=T.p+(T.m?T.m(T.s+T.c*m):Math.round((T.s+T.c*m)*1e4)/1e4)+A,T=T._next;A+=v.c}v.set(v.t,v.p,A,v)},j0=function(m,v){for(var T=v._pt;T;)T.r(m,T.d),T=T._next},QC=function(m,v,T,A){for(var n=this._pt,O;n;)O=n._next,n.p===A&&n.modifier(m,v,T),n=O},eP=function(m){for(var v=this._pt,T,A;v;)A=v._next,v.p===m&&!v.op||v.op===m?U_(this,v,"_pt"):v.dep||(T=1),v=A;return!T},tP=function(m,v,T,A){A.mSet(m,v,A.m.call(A.tween,T,A.mt),A)},G0=function(m){for(var v=m._pt,T,A,n,O;v;){for(T=v._next,A=n;A&&A.pr>v.pr;)A=A._next;(v._prev=A?A._prev:O)?v._prev._next=v:n=v,(v._next=A)?A._prev=v:O=v,v=T}m._pt=n},Mo=function(){function S(v,T,A,n,O,V,H,J,ae){this.t=T,this.s=n,this.c=O,this.p=A,this.r=V||pT,this.d=H||this,this.set=J||V0,this.pr=ae||0,this._next=v,v&&(v._prev=this)}var m=S.prototype;return m.modifier=function(T,A,n){this.mSet=this.mSet||this.set,this.set=tP,this.m=T,this.mt=n,this.tween=A},S}();Ao(R0+"parent,duration,ease,delay,overwrite,runBackwards,startAt,yoyo,immediateRender,repeat,repeatDelay,data,paused,reversed,lazy,callbackScope,stringFilter,id,yoyoEase,stagger,inherit,repeatRefresh,keyframes,autoRevert,scrollTrigger",function(S){return P0[S]=1});ts.TweenMax=ts.TweenLite=gn;ts.TimelineLite=ts.TimelineMax=Zn;sn=new Zn({sortChildren:!1,defaults:qu,autoRemoveChildren:!0,id:"root",smoothChildTiming:!0});qo.stringFilter=O0;var hh=[],z_={},iP=[],Dw=0,rP=0,d0=function(m){return(z_[m]||iP).map(function(v){return v()})},S0=function(){var m=Date.now(),v=[];m-Dw>2&&(d0("matchMediaInit"),hh.forEach(function(T){var A=T.queries,n=T.conditions,O,V,H,J;for(V in A)O=pa.matchMedia(A[V]).matches,O&&(H=1),O!==n[V]&&(n[V]=O,J=1);J&&(T.revert(),H&&v.push(T))}),d0("matchMediaRevert"),v.forEach(function(T){return T.onMatch(T,function(A){return T.add(null,A)})}),Dw=m,d0("matchMedia"))},fT=function(){function S(v,T){this.selector=T&&b0(T),this.data=[],this._r=[],this.isReverted=!1,this.id=rP++,v&&this.add(v)}var m=S.prototype;return m.add=function(T,A,n){pn(T)&&(n=A,A=T,T=pn);var O=this,V=function(){var J=nn,ae=O.selector,we;return J&&J!==O&&J.data.push(O),n&&(O.selector=b0(n)),nn=O,we=A.apply(O,arguments),pn(we)&&O._r.push(we),nn=J,O.selector=ae,O.isReverted=!1,we};return O.last=V,T===pn?V(O,function(H){return O.add(null,H)}):T?O[T]=V:V},m.ignore=function(T){var A=nn;nn=null,T(this),nn=A},m.getTweens=function(){var T=[];return this.data.forEach(function(A){return A instanceof S?T.push.apply(T,A.getTweens()):A instanceof gn&&!(A.parent&&A.parent.data==="nested")&&T.push(A)}),T},m.clear=function(){this._r.length=this.data.length=0},m.kill=function(T,A){var n=this;if(T?function(){for(var V=n.getTweens(),H=n.data.length,J;H--;)J=n.data[H],J.data==="isFlip"&&(J.revert(),J.getChildren(!0,!0,!1).forEach(function(ae){return V.splice(V.indexOf(ae),1)}));for(V.map(function(ae){return{g:ae._dur||ae._delay||ae._sat&&!ae._sat.vars.immediateRender?ae.globalTime(0):-1/0,t:ae}}).sort(function(ae,we){return we.g-ae.g||-1/0}).forEach(function(ae){return ae.t.revert(T)}),H=n.data.length;H--;)J=n.data[H],J instanceof Zn?J.data!=="nested"&&(J.scrollTrigger&&J.scrollTrigger.revert(),J.kill()):!(J instanceof gn)&&J.revert&&J.revert(T);n._r.forEach(function(ae){return ae(T,n)}),n.isReverted=!0}():this.data.forEach(function(V){return V.kill&&V.kill()}),this.clear(),A)for(var O=hh.length;O--;)hh[O].id===this.id&&hh.splice(O,1)},m.revert=function(T){this.kill(T||{})},S}(),nP=function(){function S(v){this.contexts=[],this.scope=v,nn&&nn.data.push(this)}var m=S.prototype;return m.add=function(T,A,n){ma(T)||(T={matches:T});var O=new fT(0,n||this.scope),V=O.conditions={},H,J,ae;nn&&!O.selector&&(O.selector=nn.selector),this.contexts.push(O),A=O.add("onMatch",A),O.queries=T;for(J in T)J==="all"?ae=1:(H=pa.matchMedia(T[J]),H&&(hh.indexOf(O)<0&&hh.push(O),(V[J]=H.matches)&&(ae=1),H.addListener?H.addListener(S0):H.addEventListener("change",S0)));return ae&&A(O,function(we){return O.add(null,we)}),this},m.revert=function(T){this.kill(T||{})},m.kill=function(T){this.contexts.forEach(function(A){return A.kill(T,!0)})},S}(),B_={registerPlugin:function(){for(var m=arguments.length,v=new Array(m),T=0;T<m;T++)v[T]=arguments[T];v.forEach(function(A){return nT(A)})},timeline:function(m){return new Zn(m)},getTweensOf:function(m,v){return sn.getTweensOf(m,v)},getProperty:function(m,v,T,A){Rn(m)&&(m=_s(m)[0]);var n=Wl(m||{}).get,O=T?Hw:qw;return T==="native"&&(T=""),m&&(v?O((Uo[v]&&Uo[v].get||n)(m,v,T,A)):function(V,H,J){return O((Uo[V]&&Uo[V].get||n)(m,V,H,J))})},quickSetter:function(m,v,T){if(m=_s(m),m.length>1){var A=m.map(function(ae){return no.quickSetter(ae,v,T)}),n=A.length;return function(ae){for(var we=n;we--;)A[we](ae)}}m=m[0]||{};var O=Uo[v],V=Wl(m),H=V.harness&&(V.harness.aliases||{})[v]||v,J=O?function(ae){var we=new O;Gu._pt=0,we.init(m,T?ae+T:ae,Gu,0,[m]),we.render(1,we),Gu._pt&&j0(1,Gu)}:V.set(m,H);return O?J:function(ae){return J(m,H,T?ae+T:ae,V,1)}},quickTo:function(m,v,T){var A,n=no.to(m,is((A={},A[v]="+=0.1",A.paused=!0,A.stagger=0,A),T||{})),O=function(H,J,ae){return n.resetTo(v,H,J,ae)};return O.tween=n,O},isTweening:function(m){return sn.getTweensOf(m,!0).length>0},defaults:function(m){return m&&m.ease&&(m.ease=ch(m.ease,qu.ease)),Cw(qu,m||{})},config:function(m){return Cw(qo,m||{})},registerEffect:function(m){var v=m.name,T=m.effect,A=m.plugins,n=m.defaults,O=m.extendTimeline;(A||"").split(",").forEach(function(V){return V&&!Uo[V]&&!ts[V]&&pf(v+" effect requires "+V+" plugin.")}),l0[v]=function(V,H,J){return T(_s(V),is(H||{},n),J)},O&&(Zn.prototype[v]=function(V,H,J){return this.add(l0[v](V,ma(H)?H:(J=H)&&{},this),J)})},registerEase:function(m,v){br[m]=ch(v)},parseEase:function(m,v){return arguments.length?ch(m,v):br},getById:function(m){return sn.getById(m)},exportRoot:function(m,v){m===void 0&&(m={});var T=new Zn(m),A,n;for(T.smoothChildTiming=Go(m.smoothChildTiming),sn.remove(T),T._dp=0,T._time=T._tTime=sn._time,A=sn._first;A;)n=A._next,(v||!(!A._dur&&A instanceof gn&&A.vars.onComplete===A._targets[0]))&&fa(T,A,A._start-A._delay),A=n;return fa(sn,T,0),T},context:function(m,v){return m?new fT(m,v):nn},matchMedia:function(m){return new nP(m)},matchMediaRefresh:function(){return hh.forEach(function(m){var v=m.conditions,T,A;for(A in v)v[A]&&(v[A]=!1,T=1);T&&m.revert()})||S0()},addEventListener:function(m,v){var T=z_[m]||(z_[m]=[]);~T.indexOf(v)||T.push(v)},removeEventListener:function(m,v){var T=z_[m],A=T&&T.indexOf(v);A>=0&&T.splice(A,1)},utils:{wrap:kC,wrapYoyo:FC,distribute:Jw,random:eT,snap:Qw,normalize:OC,getUnit:Xn,clamp:RC,splitColor:oT,toArray:_s,selector:b0,mapRange:iT,pipe:zC,unitize:DC,interpolate:BC,shuffle:Kw},install:Vw,effects:l0,ticker:jo,updateRoot:Zn.updateRoot,plugins:Uo,globalTimeline:sn,core:{PropTween:Mo,globals:Uw,Tween:gn,Timeline:Zn,Animation:_f,getCache:Wl,_removeLinkedListItem:U_,reverting:function(){return Wn},context:function(m){return m&&nn&&(nn.data.push(m),m._ctx=nn),nn},suppressOverwrites:function(m){return E0=m}}};Ao("to,from,fromTo,delayedCall,set,killTweensOf",function(S){return B_[S]=gn[S]});jo.add(Zn.updateRoot);Gu=B_.to({},{duration:0});var oP=function(m,v){for(var T=m._pt;T&&T.p!==v&&T.op!==v&&T.fp!==v;)T=T._next;return T},sP=function(m,v){var T=m._targets,A,n,O;for(A in v)for(n=T.length;n--;)O=m._ptLookup[n][A],O&&(O=O.d)&&(O._pt&&(O=oP(O,A)),O&&O.modifier&&O.modifier(v[A],m,T[n],A))},p0=function(m,v){return{name:m,headless:1,rawVars:1,init:function(A,n,O){O._onInit=function(V){var H,J;if(Rn(n)&&(H={},Ao(n,function(ae){return H[ae]=1}),n=H),v){H={};for(J in n)H[J]=v(n[J]);n=H}sP(V,n)}}}},no=B_.registerPlugin({name:"attr",init:function(m,v,T,A,n){var O,V,H;this.tween=T;for(O in v)H=m.getAttribute(O)||"",V=this.add(m,"setAttribute",(H||0)+"",v[O],A,n,0,0,O),V.op=O,V.b=H,this._props.push(O)},render:function(m,v){for(var T=v._pt;T;)Wn?T.set(T.t,T.p,T.b,T):T.r(m,T.d),T=T._next}},{name:"endArray",headless:1,init:function(m,v){for(var T=v.length;T--;)this.add(m,T,m[T]||0,v[T],0,0,0,0,0,1)}},p0("roundProps",w0),p0("modifiers"),p0("snap",Qw))||B_;gn.version=Zn.version=no.version="3.13.0";Nw=1;I0()&&Wu();var aP=br.Power0,lP=br.Power1,cP=br.Power2,hP=br.Power3,uP=br.Power4,dP=br.Linear,pP=br.Quad,fP=br.Cubic,mP=br.Quart,_P=br.Quint,gP=br.Strong,yP=br.Elastic,xP=br.Back,vP=br.SteppedEase,bP=br.Bounce,wP=br.Sine,TP=br.Expo,SP=br.Circ;var mT,Kl,Ku,X0,gh,EP,_T,Y0,IP=function(){return typeof window<"u"},Za={},_h=180/Math.PI,Ju=Math.PI/180,Yu=Math.atan2,gT=1e8,K0=/([A-Z])/g,AP=/(left|right|width|margin|padding|x)/i,MP=/[\s,\(]\S/,_a={autoAlpha:"opacity,visibility",scale:"scaleX,scaleY",alpha:"opacity"},H0=function(m,v){return v.set(v.t,v.p,Math.round((v.s+v.c*m)*1e4)/1e4+v.u,v)},CP=function(m,v){return v.set(v.t,v.p,m===1?v.e:Math.round((v.s+v.c*m)*1e4)/1e4+v.u,v)},PP=function(m,v){return v.set(v.t,v.p,m?Math.round((v.s+v.c*m)*1e4)/1e4+v.u:v.b,v)},RP=function(m,v){var T=v.s+v.c*m;v.set(v.t,v.p,~~(T+(T<0?-.5:.5))+v.u,v)},ET=function(m,v){return v.set(v.t,v.p,m?v.e:v.b,v)},IT=function(m,v){return v.set(v.t,v.p,m!==1?v.b:v.e,v)},LP=function(m,v,T){return m.style[v]=T},zP=function(m,v,T){return m.style.setProperty(v,T)},DP=function(m,v,T){return m._gsap[v]=T},OP=function(m,v,T){return m._gsap.scaleX=m._gsap.scaleY=T},kP=function(m,v,T,A,n){var O=m._gsap;O.scaleX=O.scaleY=T,O.renderTransform(n,O)},FP=function(m,v,T,A,n){var O=m._gsap;O[v]=T,O.renderTransform(n,O)},an="transform",Ho=an+"Origin",BP=function S(m,v){var T=this,A=this.target,n=A.style,O=A._gsap;if(m in Za&&n){if(this.tfm=this.tfm||{},m!=="transform")m=_a[m]||m,~m.indexOf(",")?m.split(",").forEach(function(V){return T.tfm[V]=$a(A,V)}):this.tfm[m]=O.x?O[m]:$a(A,m),m===Ho&&(this.tfm.zOrigin=O.zOrigin);else return _a.transform.split(",").forEach(function(V){return S.call(T,V,v)});if(this.props.indexOf(an)>=0)return;O.svg&&(this.svgo=A.getAttribute("data-svg-origin"),this.props.push(Ho,v,"")),m=an}(n||v)&&this.props.push(m,v,n[m])},AT=function(m){m.translate&&(m.removeProperty("translate"),m.removeProperty("scale"),m.removeProperty("rotate"))},NP=function(){var m=this.props,v=this.target,T=v.style,A=v._gsap,n,O;for(n=0;n<m.length;n+=3)m[n+1]?m[n+1]===2?v[m[n]](m[n+2]):v[m[n]]=m[n+2]:m[n+2]?T[m[n]]=m[n+2]:T.removeProperty(m[n].substr(0,2)==="--"?m[n]:m[n].replace(K0,"-$1").toLowerCase());if(this.tfm){for(O in this.tfm)A[O]=this.tfm[O];A.svg&&(A.renderTransform(),v.setAttribute("data-svg-origin",this.svgo||"")),n=Y0(),(!n||!n.isStart)&&!T[an]&&(AT(T),A.zOrigin&&T[Ho]&&(T[Ho]+=" "+A.zOrigin+"px",A.zOrigin=0,A.renderTransform()),A.uncache=1)}},MT=function(m,v){var T={target:m,props:[],revert:NP,save:BP};return m._gsap||no.core.getCache(m),v&&m.style&&m.nodeType&&v.split(",").forEach(function(A){return T.save(A)}),T},CT,$0=function(m,v){var T=Kl.createElementNS?Kl.createElementNS((v||"http://www.w3.org/1999/xhtml").replace(/^https/,"http"),m):Kl.createElement(m);return T&&T.style?T:Kl.createElement(m)},gs=function S(m,v,T){var A=getComputedStyle(m);return A[v]||A.getPropertyValue(v.replace(K0,"-$1").toLowerCase())||A.getPropertyValue(v)||!T&&S(m,Qu(v)||v,1)||""},yT="O,Moz,ms,Ms,Webkit".split(","),Qu=function(m,v,T){var A=v||gh,n=A.style,O=5;if(m in n&&!T)return m;for(m=m.charAt(0).toUpperCase()+m.substr(1);O--&&!(yT[O]+m in n););return O<0?null:(O===3?"ms":O>=0?yT[O]:"")+m},Z0=function(){IP()&&window.document&&(mT=window,Kl=mT.document,Ku=Kl.documentElement,gh=$0("div")||{style:{}},EP=$0("div"),an=Qu(an),Ho=an+"Origin",gh.style.cssText="border-width:0;line-height:0;position:absolute;padding:0",CT=!!Qu("perspective"),Y0=no.core.reverting,X0=1)},xT=function(m){var v=m.ownerSVGElement,T=$0("svg",v&&v.getAttribute("xmlns")||"http://www.w3.org/2000/svg"),A=m.cloneNode(!0),n;A.style.display="block",T.appendChild(A),Ku.appendChild(T);try{n=A.getBBox()}catch{}return T.removeChild(A),Ku.removeChild(T),n},vT=function(m,v){for(var T=v.length;T--;)if(m.hasAttribute(v[T]))return m.getAttribute(v[T])},PT=function(m){var v,T;try{v=m.getBBox()}catch{v=xT(m),T=1}return v&&(v.width||v.height)||T||(v=xT(m)),v&&!v.width&&!v.x&&!v.y?{x:+vT(m,["x","cx","x1"])||0,y:+vT(m,["y","cy","y1"])||0,width:0,height:0}:v},RT=function(m){return!!(m.getCTM&&(!m.parentNode||m.ownerSVGElement)&&PT(m))},yh=function(m,v){if(v){var T=m.style,A;v in Za&&v!==Ho&&(v=an),T.removeProperty?(A=v.substr(0,2),(A==="ms"||v.substr(0,6)==="webkit")&&(v="-"+v),T.removeProperty(A==="--"?v:v.replace(K0,"-$1").toLowerCase())):T.removeAttribute(v)}},Jl=function(m,v,T,A,n,O){var V=new Mo(m._pt,v,T,0,1,O?IT:ET);return m._pt=V,V.b=A,V.e=n,m._props.push(T),V},bT={deg:1,rad:1,turn:1},VP={grid:1,flex:1},Ql=function S(m,v,T,A){var n=parseFloat(T)||0,O=(T+"").trim().substr((n+"").length)||"px",V=gh.style,H=AP.test(v),J=m.tagName.toLowerCase()==="svg",ae=(J?"client":"offset")+(H?"Width":"Height"),we=100,Ae=A==="px",xe=A==="%",Ge,Te,We,ft;if(A===O||!n||bT[A]||bT[O])return n;if(O!=="px"&&!Ae&&(n=S(m,v,T,"px")),ft=m.getCTM&&RT(m),(xe||O==="%")&&(Za[v]||~v.indexOf("adius")))return Ge=ft?m.getBBox()[H?"width":"height"]:m[ae],fn(xe?n/Ge*we:n/100*Ge);if(V[H?"width":"height"]=we+(Ae?O:A),Te=A!=="rem"&&~v.indexOf("adius")||A==="em"&&m.appendChild&&!J?m:m.parentNode,ft&&(Te=(m.ownerSVGElement||{}).parentNode),(!Te||Te===Kl||!Te.appendChild)&&(Te=Kl.body),We=Te._gsap,We&&xe&&We.width&&H&&We.time===jo.time&&!We.uncache)return fn(n/We.width*we);if(xe&&(v==="height"||v==="width")){var _t=m.style[v];m.style[v]=we+A,Ge=m[ae],_t?m.style[v]=_t:yh(m,v)}else(xe||O==="%")&&!VP[gs(Te,"display")]&&(V.position=gs(m,"position")),Te===m&&(V.position="static"),Te.appendChild(gh),Ge=gh[ae],Te.removeChild(gh),V.position="absolute";return H&&xe&&(We=Wl(Te),We.time=jo.time,We.width=Te[ae]),fn(Ae?Ge*n/we:Ge&&n?we/Ge*n:0)},$a=function(m,v,T,A){var n;return X0||Z0(),v in _a&&v!=="transform"&&(v=_a[v],~v.indexOf(",")&&(v=v.split(",")[0])),Za[v]&&v!=="transform"?(n=vf(m,A),n=v!=="transformOrigin"?n[v]:n.svg?n.origin:$_(gs(m,Ho))+" "+n.zOrigin+"px"):(n=m.style[v],(!n||n==="auto"||A||~(n+"").indexOf("calc("))&&(n=H_[v]&&H_[v](m,v,T)||gs(m,v)||z0(m,v)||(v==="opacity"?1:0))),T&&!~(n+"").trim().indexOf(" ")?Ql(m,v,n,T)+T:n},UP=function(m,v,T,A){if(!T||T==="none"){var n=Qu(v,m,1),O=n&&gs(m,n,1);O&&O!==T?(v=n,T=O):v==="borderColor"&&(T=gs(m,"borderTopColor"))}var V=new Mo(this._pt,m.style,v,0,1,U0),H=0,J=0,ae,we,Ae,xe,Ge,Te,We,ft,_t,Pt,At,wt;if(V.b=T,V.e=A,T+="",A+="",A.substring(0,6)==="var(--"&&(A=gs(m,A.substring(4,A.indexOf(")")))),A==="auto"&&(Te=m.style[v],m.style[v]=A,A=gs(m,v)||A,Te?m.style[v]=Te:yh(m,v)),ae=[T,A],O0(ae),T=ae[0],A=ae[1],Ae=T.match(uh)||[],wt=A.match(uh)||[],wt.length){for(;we=uh.exec(A);)We=we[0],_t=A.substring(H,we.index),Ge?Ge=(Ge+1)%5:(_t.substr(-5)==="rgba("||_t.substr(-5)==="hsla(")&&(Ge=1),We!==(Te=Ae[J++]||"")&&(xe=parseFloat(Te)||0,At=Te.substr((xe+"").length),We.charAt(1)==="="&&(We=dh(xe,We)+At),ft=parseFloat(We),Pt=We.substr((ft+"").length),H=uh.lastIndex-Pt.length,Pt||(Pt=Pt||qo.units[v]||At,H===A.length&&(A+=Pt,V.e+=Pt)),At!==Pt&&(xe=Ql(m,v,Te,Pt)||0),V._pt={_next:V._pt,p:_t||J===1?_t:",",s:xe,c:ft-xe,m:Ge&&Ge<4||v==="zIndex"?Math.round:0});V.c=H<A.length?A.substring(H,A.length):""}else V.r=v==="display"&&A==="none"?IT:ET;return M0.test(A)&&(V.e=0),this._pt=V,V},wT={top:"0%",bottom:"100%",left:"0%",right:"100%",center:"50%"},jP=function(m){var v=m.split(" "),T=v[0],A=v[1]||"50%";return(T==="top"||T==="bottom"||A==="left"||A==="right")&&(m=T,T=A,A=m),v[0]=wT[T]||T,v[1]=wT[A]||A,v.join(" ")},GP=function(m,v){if(v.tween&&v.tween._time===v.tween._dur){var T=v.t,A=T.style,n=v.u,O=T._gsap,V,H,J;if(n==="all"||n===!0)A.cssText="",H=1;else for(n=n.split(","),J=n.length;--J>-1;)V=n[J],Za[V]&&(H=1,V=V==="transformOrigin"?Ho:an),yh(T,V);H&&(yh(T,an),O&&(O.svg&&T.removeAttribute("transform"),A.scale=A.rotate=A.translate="none",vf(T,1),O.uncache=1,AT(A)))}},H_={clearProps:function(m,v,T,A,n){if(n.data!=="isFromStart"){var O=m._pt=new Mo(m._pt,v,T,0,0,GP);return O.u=A,O.pr=-10,O.tween=n,m._props.push(T),1}}},xf=[1,0,0,1,0,0],LT={},zT=function(m){return m==="matrix(1, 0, 0, 1, 0, 0)"||m==="none"||!m},TT=function(m){var v=gs(m,an);return zT(v)?xf:v.substr(7).match(A0).map(fn)},J0=function(m,v){var T=m._gsap||Wl(m),A=m.style,n=TT(m),O,V,H,J;return T.svg&&m.getAttribute("transform")?(H=m.transform.baseVal.consolidate().matrix,n=[H.a,H.b,H.c,H.d,H.e,H.f],n.join(",")==="1,0,0,1,0,0"?xf:n):(n===xf&&!m.offsetParent&&m!==Ku&&!T.svg&&(H=A.display,A.display="block",O=m.parentNode,(!O||!m.offsetParent&&!m.getBoundingClientRect().width)&&(J=1,V=m.nextElementSibling,Ku.appendChild(m)),n=TT(m),H?A.display=H:yh(m,"display"),J&&(V?O.insertBefore(m,V):O?O.appendChild(m):Ku.removeChild(m))),v&&n.length>6?[n[0],n[1],n[4],n[5],n[12],n[13]]:n)},W0=function(m,v,T,A,n,O){var V=m._gsap,H=n||J0(m,!0),J=V.xOrigin||0,ae=V.yOrigin||0,we=V.xOffset||0,Ae=V.yOffset||0,xe=H[0],Ge=H[1],Te=H[2],We=H[3],ft=H[4],_t=H[5],Pt=v.split(" "),At=parseFloat(Pt[0])||0,wt=parseFloat(Pt[1])||0,Ct,Ft,Wt,mt;T?H!==xf&&(Ft=xe*We-Ge*Te)&&(Wt=At*(We/Ft)+wt*(-Te/Ft)+(Te*_t-We*ft)/Ft,mt=At*(-Ge/Ft)+wt*(xe/Ft)-(xe*_t-Ge*ft)/Ft,At=Wt,wt=mt):(Ct=PT(m),At=Ct.x+(~Pt[0].indexOf("%")?At/100*Ct.width:At),wt=Ct.y+(~(Pt[1]||Pt[0]).indexOf("%")?wt/100*Ct.height:wt)),A||A!==!1&&V.smooth?(ft=At-J,_t=wt-ae,V.xOffset=we+(ft*xe+_t*Te)-ft,V.yOffset=Ae+(ft*Ge+_t*We)-_t):V.xOffset=V.yOffset=0,V.xOrigin=At,V.yOrigin=wt,V.smooth=!!A,V.origin=v,V.originIsAbsolute=!!T,m.style[Ho]="0px 0px",O&&(Jl(O,V,"xOrigin",J,At),Jl(O,V,"yOrigin",ae,wt),Jl(O,V,"xOffset",we,V.xOffset),Jl(O,V,"yOffset",Ae,V.yOffset)),m.setAttribute("data-svg-origin",At+" "+wt)},vf=function(m,v){var T=m._gsap||new k0(m);if("x"in T&&!v&&!T.uncache)return T;var A=m.style,n=T.scaleX<0,O="px",V="deg",H=getComputedStyle(m),J=gs(m,Ho)||"0",ae,we,Ae,xe,Ge,Te,We,ft,_t,Pt,At,wt,Ct,Ft,Wt,mt,er,Ni,yi,mi,vi,mr,Fr,Rr,Hr,Xi,tn,Po,Ro,Zo,Oi,or;return ae=we=Ae=Te=We=ft=_t=Pt=At=0,xe=Ge=1,T.svg=!!(m.getCTM&&RT(m)),H.translate&&((H.translate!=="none"||H.scale!=="none"||H.rotate!=="none")&&(A[an]=(H.translate!=="none"?"translate3d("+(H.translate+" 0 0").split(" ").slice(0,3).join(", ")+") ":"")+(H.rotate!=="none"?"rotate("+H.rotate+") ":"")+(H.scale!=="none"?"scale("+H.scale.split(" ").join(",")+") ":"")+(H[an]!=="none"?H[an]:"")),A.scale=A.rotate=A.translate="none"),Ft=J0(m,T.svg),T.svg&&(T.uncache?(Hr=m.getBBox(),J=T.xOrigin-Hr.x+"px "+(T.yOrigin-Hr.y)+"px",Rr=""):Rr=!v&&m.getAttribute("data-svg-origin"),W0(m,Rr||J,!!Rr||T.originIsAbsolute,T.smooth!==!1,Ft)),wt=T.xOrigin||0,Ct=T.yOrigin||0,Ft!==xf&&(Ni=Ft[0],yi=Ft[1],mi=Ft[2],vi=Ft[3],ae=mr=Ft[4],we=Fr=Ft[5],Ft.length===6?(xe=Math.sqrt(Ni*Ni+yi*yi),Ge=Math.sqrt(vi*vi+mi*mi),Te=Ni||yi?Yu(yi,Ni)*_h:0,_t=mi||vi?Yu(mi,vi)*_h+Te:0,_t&&(Ge*=Math.abs(Math.cos(_t*Ju))),T.svg&&(ae-=wt-(wt*Ni+Ct*mi),we-=Ct-(wt*yi+Ct*vi))):(or=Ft[6],Zo=Ft[7],tn=Ft[8],Po=Ft[9],Ro=Ft[10],Oi=Ft[11],ae=Ft[12],we=Ft[13],Ae=Ft[14],Wt=Yu(or,Ro),We=Wt*_h,Wt&&(mt=Math.cos(-Wt),er=Math.sin(-Wt),Rr=mr*mt+tn*er,Hr=Fr*mt+Po*er,Xi=or*mt+Ro*er,tn=mr*-er+tn*mt,Po=Fr*-er+Po*mt,Ro=or*-er+Ro*mt,Oi=Zo*-er+Oi*mt,mr=Rr,Fr=Hr,or=Xi),Wt=Yu(-mi,Ro),ft=Wt*_h,Wt&&(mt=Math.cos(-Wt),er=Math.sin(-Wt),Rr=Ni*mt-tn*er,Hr=yi*mt-Po*er,Xi=mi*mt-Ro*er,Oi=vi*er+Oi*mt,Ni=Rr,yi=Hr,mi=Xi),Wt=Yu(yi,Ni),Te=Wt*_h,Wt&&(mt=Math.cos(Wt),er=Math.sin(Wt),Rr=Ni*mt+yi*er,Hr=mr*mt+Fr*er,yi=yi*mt-Ni*er,Fr=Fr*mt-mr*er,Ni=Rr,mr=Hr),We&&Math.abs(We)+Math.abs(Te)>359.9&&(We=Te=0,ft=180-ft),xe=fn(Math.sqrt(Ni*Ni+yi*yi+mi*mi)),Ge=fn(Math.sqrt(Fr*Fr+or*or)),Wt=Yu(mr,Fr),_t=Math.abs(Wt)>2e-4?Wt*_h:0,At=Oi?1/(Oi<0?-Oi:Oi):0),T.svg&&(Rr=m.getAttribute("transform"),T.forceCSS=m.setAttribute("transform","")||!zT(gs(m,an)),Rr&&m.setAttribute("transform",Rr))),Math.abs(_t)>90&&Math.abs(_t)<270&&(n?(xe*=-1,_t+=Te<=0?180:-180,Te+=Te<=0?180:-180):(Ge*=-1,_t+=_t<=0?180:-180)),v=v||T.uncache,T.x=ae-((T.xPercent=ae&&(!v&&T.xPercent||(Math.round(m.offsetWidth/2)===Math.round(-ae)?-50:0)))?m.offsetWidth*T.xPercent/100:0)+O,T.y=we-((T.yPercent=we&&(!v&&T.yPercent||(Math.round(m.offsetHeight/2)===Math.round(-we)?-50:0)))?m.offsetHeight*T.yPercent/100:0)+O,T.z=Ae+O,T.scaleX=fn(xe),T.scaleY=fn(Ge),T.rotation=fn(Te)+V,T.rotationX=fn(We)+V,T.rotationY=fn(ft)+V,T.skewX=_t+V,T.skewY=Pt+V,T.transformPerspective=At+O,(T.zOrigin=parseFloat(J.split(" ")[2])||!v&&T.zOrigin||0)&&(A[Ho]=$_(J)),T.xOffset=T.yOffset=0,T.force3D=qo.force3D,T.renderTransform=T.svg?HP:CT?DT:qP,T.uncache=0,T},$_=function(m){return(m=m.split(" "))[0]+" "+m[1]},q0=function(m,v,T){var A=Xn(v);return fn(parseFloat(v)+parseFloat(Ql(m,"x",T+"px",A)))+A},qP=function(m,v){v.z="0px",v.rotationY=v.rotationX="0deg",v.force3D=0,DT(m,v)},fh="0deg",yf="0px",mh=") ",DT=function(m,v){var T=v||this,A=T.xPercent,n=T.yPercent,O=T.x,V=T.y,H=T.z,J=T.rotation,ae=T.rotationY,we=T.rotationX,Ae=T.skewX,xe=T.skewY,Ge=T.scaleX,Te=T.scaleY,We=T.transformPerspective,ft=T.force3D,_t=T.target,Pt=T.zOrigin,At="",wt=ft==="auto"&&m&&m!==1||ft===!0;if(Pt&&(we!==fh||ae!==fh)){var Ct=parseFloat(ae)*Ju,Ft=Math.sin(Ct),Wt=Math.cos(Ct),mt;Ct=parseFloat(we)*Ju,mt=Math.cos(Ct),O=q0(_t,O,Ft*mt*-Pt),V=q0(_t,V,-Math.sin(Ct)*-Pt),H=q0(_t,H,Wt*mt*-Pt+Pt)}We!==yf&&(At+="perspective("+We+mh),(A||n)&&(At+="translate("+A+"%, "+n+"%) "),(wt||O!==yf||V!==yf||H!==yf)&&(At+=H!==yf||wt?"translate3d("+O+", "+V+", "+H+") ":"translate("+O+", "+V+mh),J!==fh&&(At+="rotate("+J+mh),ae!==fh&&(At+="rotateY("+ae+mh),we!==fh&&(At+="rotateX("+we+mh),(Ae!==fh||xe!==fh)&&(At+="skew("+Ae+", "+xe+mh),(Ge!==1||Te!==1)&&(At+="scale("+Ge+", "+Te+mh),_t.style[an]=At||"translate(0, 0)"},HP=function(m,v){var T=v||this,A=T.xPercent,n=T.yPercent,O=T.x,V=T.y,H=T.rotation,J=T.skewX,ae=T.skewY,we=T.scaleX,Ae=T.scaleY,xe=T.target,Ge=T.xOrigin,Te=T.yOrigin,We=T.xOffset,ft=T.yOffset,_t=T.forceCSS,Pt=parseFloat(O),At=parseFloat(V),wt,Ct,Ft,Wt,mt;H=parseFloat(H),J=parseFloat(J),ae=parseFloat(ae),ae&&(ae=parseFloat(ae),J+=ae,H+=ae),H||J?(H*=Ju,J*=Ju,wt=Math.cos(H)*we,Ct=Math.sin(H)*we,Ft=Math.sin(H-J)*-Ae,Wt=Math.cos(H-J)*Ae,J&&(ae*=Ju,mt=Math.tan(J-ae),mt=Math.sqrt(1+mt*mt),Ft*=mt,Wt*=mt,ae&&(mt=Math.tan(ae),mt=Math.sqrt(1+mt*mt),wt*=mt,Ct*=mt)),wt=fn(wt),Ct=fn(Ct),Ft=fn(Ft),Wt=fn(Wt)):(wt=we,Wt=Ae,Ct=Ft=0),(Pt&&!~(O+"").indexOf("px")||At&&!~(V+"").indexOf("px"))&&(Pt=Ql(xe,"x",O,"px"),At=Ql(xe,"y",V,"px")),(Ge||Te||We||ft)&&(Pt=fn(Pt+Ge-(Ge*wt+Te*Ft)+We),At=fn(At+Te-(Ge*Ct+Te*Wt)+ft)),(A||n)&&(mt=xe.getBBox(),Pt=fn(Pt+A/100*mt.width),At=fn(At+n/100*mt.height)),mt="matrix("+wt+","+Ct+","+Ft+","+Wt+","+Pt+","+At+")",xe.setAttribute("transform",mt),_t&&(xe.style[an]=mt)},$P=function(m,v,T,A,n){var O=360,V=Rn(n),H=parseFloat(n)*(V&&~n.indexOf("rad")?_h:1),J=H-A,ae=A+J+"deg",we,Ae;return V&&(we=n.split("_")[1],we==="short"&&(J%=O,J!==J%(O/2)&&(J+=J<0?O:-O)),we==="cw"&&J<0?J=(J+O*gT)%O-~~(J/O)*O:we==="ccw"&&J>0&&(J=(J-O*gT)%O-~~(J/O)*O)),m._pt=Ae=new Mo(m._pt,v,T,A,J,CP),Ae.e=ae,Ae.u="deg",m._props.push(T),Ae},ST=function(m,v){for(var T in v)m[T]=v[T];return m},ZP=function(m,v,T){var A=ST({},T._gsap),n="perspective,force3D,transformOrigin,svgOrigin",O=T.style,V,H,J,ae,we,Ae,xe,Ge;A.svg?(J=T.getAttribute("transform"),T.setAttribute("transform",""),O[an]=v,V=vf(T,1),yh(T,an),T.setAttribute("transform",J)):(J=getComputedStyle(T)[an],O[an]=v,V=vf(T,1),O[an]=J);for(H in Za)J=A[H],ae=V[H],J!==ae&&n.indexOf(H)<0&&(xe=Xn(J),Ge=Xn(ae),we=xe!==Ge?Ql(T,H,J,Ge):parseFloat(J),Ae=parseFloat(ae),m._pt=new Mo(m._pt,V,H,we,Ae-we,H0),m._pt.u=Ge||0,m._props.push(H));ST(V,A)};Ao("padding,margin,Width,Radius",function(S,m){var v="Top",T="Right",A="Bottom",n="Left",O=(m<3?[v,T,A,n]:[v+n,v+T,A+T,A+n]).map(function(V){return m<2?S+V:"border"+V+S});H_[m>1?"border"+S:S]=function(V,H,J,ae,we){var Ae,xe;if(arguments.length<4)return Ae=O.map(function(Ge){return $a(V,Ge,J)}),xe=Ae.join(" "),xe.split(Ae[0]).length===5?Ae[0]:xe;Ae=(ae+"").split(" "),xe={},O.forEach(function(Ge,Te){return xe[Ge]=Ae[Te]=Ae[Te]||Ae[(Te-1)/2|0]}),V.init(H,xe,we)}});var Q0={name:"css",register:Z0,targetTest:function(m){return m.style&&m.nodeType},init:function(m,v,T,A,n){var O=this._props,V=m.style,H=T.vars.startAt,J,ae,we,Ae,xe,Ge,Te,We,ft,_t,Pt,At,wt,Ct,Ft,Wt;X0||Z0(),this.styles=this.styles||MT(m),Wt=this.styles.props,this.tween=T;for(Te in v)if(Te!=="autoRound"&&(ae=v[Te],!(Uo[Te]&&B0(Te,v,T,A,m,n)))){if(xe=typeof ae,Ge=H_[Te],xe==="function"&&(ae=ae.call(T,A,m,n),xe=typeof ae),xe==="string"&&~ae.indexOf("random(")&&(ae=Xu(ae)),Ge)Ge(this,m,Te,ae,T)&&(Ft=1);else if(Te.substr(0,2)==="--")J=(getComputedStyle(m).getPropertyValue(Te)+"").trim(),ae+="",qa.lastIndex=0,qa.test(J)||(We=Xn(J),ft=Xn(ae)),ft?We!==ft&&(J=Ql(m,Te,J,ft)+ft):We&&(ae+=We),this.add(V,"setProperty",J,ae,A,n,0,0,Te),O.push(Te),Wt.push(Te,0,V[Te]);else if(xe!=="undefined"){if(H&&Te in H?(J=typeof H[Te]=="function"?H[Te].call(T,A,m,n):H[Te],Rn(J)&&~J.indexOf("random(")&&(J=Xu(J)),Xn(J+"")||J==="auto"||(J+=qo.units[Te]||Xn($a(m,Te))||""),(J+"").charAt(1)==="="&&(J=$a(m,Te))):J=$a(m,Te),Ae=parseFloat(J),_t=xe==="string"&&ae.charAt(1)==="="&&ae.substr(0,2),_t&&(ae=ae.substr(2)),we=parseFloat(ae),Te in _a&&(Te==="autoAlpha"&&(Ae===1&&$a(m,"visibility")==="hidden"&&we&&(Ae=0),Wt.push("visibility",0,V.visibility),Jl(this,V,"visibility",Ae?"inherit":"hidden",we?"inherit":"hidden",!we)),Te!=="scale"&&Te!=="transform"&&(Te=_a[Te],~Te.indexOf(",")&&(Te=Te.split(",")[0]))),Pt=Te in Za,Pt){if(this.styles.save(Te),xe==="string"&&ae.substring(0,6)==="var(--"&&(ae=gs(m,ae.substring(4,ae.indexOf(")"))),we=parseFloat(ae)),At||(wt=m._gsap,wt.renderTransform&&!v.parseTransform||vf(m,v.parseTransform),Ct=v.smoothOrigin!==!1&&wt.smooth,At=this._pt=new Mo(this._pt,V,an,0,1,wt.renderTransform,wt,0,-1),At.dep=1),Te==="scale")this._pt=new Mo(this._pt,wt,"scaleY",wt.scaleY,(_t?dh(wt.scaleY,_t+we):we)-wt.scaleY||0,H0),this._pt.u=0,O.push("scaleY",Te),Te+="X";else if(Te==="transformOrigin"){Wt.push(Ho,0,V[Ho]),ae=jP(ae),wt.svg?W0(m,ae,0,Ct,0,this):(ft=parseFloat(ae.split(" ")[2])||0,ft!==wt.zOrigin&&Jl(this,wt,"zOrigin",wt.zOrigin,ft),Jl(this,V,Te,$_(J),$_(ae)));continue}else if(Te==="svgOrigin"){W0(m,ae,1,Ct,0,this);continue}else if(Te in LT){$P(this,wt,Te,Ae,_t?dh(Ae,_t+ae):ae);continue}else if(Te==="smoothOrigin"){Jl(this,wt,"smooth",wt.smooth,ae);continue}else if(Te==="force3D"){wt[Te]=ae;continue}else if(Te==="transform"){ZP(this,ae,m);continue}}else Te in V||(Te=Qu(Te)||Te);if(Pt||(we||we===0)&&(Ae||Ae===0)&&!MP.test(ae)&&Te in V)We=(J+"").substr((Ae+"").length),we||(we=0),ft=Xn(ae)||(Te in qo.units?qo.units[Te]:We),We!==ft&&(Ae=Ql(m,Te,J,ft)),this._pt=new Mo(this._pt,Pt?wt:V,Te,Ae,(_t?dh(Ae,_t+we):we)-Ae,!Pt&&(ft==="px"||Te==="zIndex")&&v.autoRound!==!1?RP:H0),this._pt.u=ft||0,We!==ft&&ft!=="%"&&(this._pt.b=J,this._pt.r=PP);else if(Te in V)UP.call(this,m,Te,J,_t?_t+ae:ae);else if(Te in m)this.add(m,Te,J||m[Te],_t?_t+ae:ae,A,n);else if(Te!=="parseTransform"){V_(Te,ae);continue}Pt||(Te in V?Wt.push(Te,0,V[Te]):typeof m[Te]=="function"?Wt.push(Te,2,m[Te]()):Wt.push(Te,1,J||m[Te])),O.push(Te)}}Ft&&G0(this)},render:function(m,v){if(v.tween._time||!Y0())for(var T=v._pt;T;)T.r(m,T.d),T=T._next;else v.styles.revert()},get:$a,aliases:_a,getSetter:function(m,v,T){var A=_a[v];return A&&A.indexOf(",")<0&&(v=A),v in Za&&v!==Ho&&(m._gsap.x||$a(m,"x"))?T&&_T===T?v==="scale"?OP:DP:(_T=T||{})&&(v==="scale"?kP:FP):m.style&&!N_(m.style[v])?LP:~v.indexOf("-")?zP:q_(m,v)},core:{_removeProperty:yh,_getMatrix:J0}};no.utils.checkPrefix=Qu;no.core.getStyleSaver=MT;(function(S,m,v,T){var A=Ao(S+","+m+","+v,function(n){Za[n]=1});Ao(m,function(n){qo.units[n]="deg",LT[n]=1}),_a[A[13]]=S+","+m,Ao(T,function(n){var O=n.split(":");_a[O[1]]=A[O[0]]})})("x,y,z,scale,scaleX,scaleY,xPercent,yPercent","rotation,rotationX,rotationY,skewX,skewY","transform,transformOrigin,svgOrigin,force3D,smoothOrigin,transformPerspective","0:translateX,1:translateY,2:translateZ,8:rotate,8:rotationZ,8:rotateZ,9:rotateX,10:rotateY");Ao("x,y,z,top,right,bottom,left,width,height,fontSize,padding,margin,perspective",function(S){qo.units[S]="px"});no.registerPlugin(Q0);var Z_=no.registerPlugin(Q0)||no,Lz=Z_.core.Tween;var oo,FT,Wa,ga,ec,BT,ed,W_,NT=function(){return typeof window<"u"},VT=function(){return oo||NT()&&(oo=window.gsap)&&oo.registerPlugin&&oo},UT=function(m){return typeof m=="string"},OT=function(m){return typeof m=="function"},bf=function(m,v){var T=v==="x"?"Width":"Height",A="scroll"+T,n="client"+T;return m===Wa||m===ga||m===ec?Math.max(ga[A],ec[A])-(Wa["inner"+T]||ga[n]||ec[n]):m[A]-m["offset"+T]},wf=function(m,v){var T="scroll"+(v==="x"?"Left":"Top");return m===Wa&&(m.pageXOffset!=null?T="page"+v.toUpperCase()+"Offset":m=ga[T]!=null?ga:ec),function(){return m[T]}},WP=function(m,v,T,A){if(OT(m)&&(m=m(v,T,A)),typeof m!="object")return UT(m)&&m!=="max"&&m.charAt(1)!=="="?{x:m,y:m}:{y:m};if(m.nodeType)return{y:m,x:m};var n={},O;for(O in m)n[O]=O!=="onAutoKill"&&OT(m[O])?m[O](v,T,A):m[O];return n},jT=function(m,v){if(m=BT(m)[0],!m||!m.getBoundingClientRect)return console.warn("scrollTo target doesn't exist. Using 0")||{x:0,y:0};var T=m.getBoundingClientRect(),A=!v||v===Wa||v===ec,n=A?{top:ga.clientTop-(Wa.pageYOffset||ga.scrollTop||ec.scrollTop||0),left:ga.clientLeft-(Wa.pageXOffset||ga.scrollLeft||ec.scrollLeft||0)}:v.getBoundingClientRect(),O={x:T.left-n.left,y:T.top-n.top};return!A&&v&&(O.x+=wf(v,"x")(),O.y+=wf(v,"y")()),O},kT=function(m,v,T,A,n){return!isNaN(m)&&typeof m!="object"?parseFloat(m)-n:UT(m)&&m.charAt(1)==="="?parseFloat(m.substr(2))*(m.charAt(0)==="-"?-1:1)+A-n:m==="max"?bf(v,T)-n:Math.min(bf(v,T),jT(m,v)[T]-n)},ex=function(){oo=VT(),NT()&&oo&&typeof document<"u"&&document.body&&(Wa=window,ec=document.body,ga=document.documentElement,BT=oo.utils.toArray,oo.config({autoKillThreshold:7}),ed=oo.config(),FT=1)},xh={version:"3.13.0",name:"scrollTo",rawVars:1,register:function(m){oo=m,ex()},init:function(m,v,T,A,n){FT||ex();var O=this,V=oo.getProperty(m,"scrollSnapType");O.isWin=m===Wa,O.target=m,O.tween=T,v=WP(v,A,m,n),O.vars=v,O.autoKill=!!("autoKill"in v?v:ed).autoKill,O.getX=wf(m,"x"),O.getY=wf(m,"y"),O.x=O.xPrev=O.getX(),O.y=O.yPrev=O.getY(),W_||(W_=oo.core.globals().ScrollTrigger),oo.getProperty(m,"scrollBehavior")==="smooth"&&oo.set(m,{scrollBehavior:"auto"}),V&&V!=="none"&&(O.snap=1,O.snapInline=m.style.scrollSnapType,m.style.scrollSnapType="none"),v.x!=null?(O.add(O,"x",O.x,kT(v.x,m,"x",O.x,v.offsetX||0),A,n),O._props.push("scrollTo_x")):O.skipX=1,v.y!=null?(O.add(O,"y",O.y,kT(v.y,m,"y",O.y,v.offsetY||0),A,n),O._props.push("scrollTo_y")):O.skipY=1},render:function(m,v){for(var T=v._pt,A=v.target,n=v.tween,O=v.autoKill,V=v.xPrev,H=v.yPrev,J=v.isWin,ae=v.snap,we=v.snapInline,Ae,xe,Ge,Te,We;T;)T.r(m,T.d),T=T._next;Ae=J||!v.skipX?v.getX():V,xe=J||!v.skipY?v.getY():H,Ge=xe-H,Te=Ae-V,We=ed.autoKillThreshold,v.x<0&&(v.x=0),v.y<0&&(v.y=0),O&&(!v.skipX&&(Te>We||Te<-We)&&Ae<bf(A,"x")&&(v.skipX=1),!v.skipY&&(Ge>We||Ge<-We)&&xe<bf(A,"y")&&(v.skipY=1),v.skipX&&v.skipY&&(n.kill(),v.vars.onAutoKill&&v.vars.onAutoKill.apply(n,v.vars.onAutoKillParams||[]))),J?Wa.scrollTo(v.skipX?Ae:v.x,v.skipY?xe:v.y):(v.skipY||(A.scrollTop=v.y),v.skipX||(A.scrollLeft=v.x)),ae&&(m===1||m===0)&&(xe=A.scrollTop,Ae=A.scrollLeft,we?A.style.scrollSnapType=we:A.style.removeProperty("scroll-snap-type"),A.scrollTop=xe+1,A.scrollLeft=Ae+1,A.scrollTop=xe,A.scrollLeft=Ae),v.xPrev=v.x,v.yPrev=v.y,W_&&W_.update()},kill:function(m){var v=m==="scrollTo",T=this._props.indexOf(m);return(v||m==="scrollTo_x")&&(this.skipX=1),(v||m==="scrollTo_y")&&(this.skipY=1),T>-1&&this._props.splice(T,1),!this._props.length}};xh.max=bf;xh.getOffset=jT;xh.buildGetter=wf;xh.config=function(S){ed||ex()||(ed=oo.config());for(var m in S)ed[m]=S[m]};VT()&&oo.registerPlugin(xh);Z_.registerPlugin(xh);window.__GLOBAL_GSAP=Z_;var tx=window.__GLOBAL_GSAP;var Nz=document.querySelector("#viewport"),Vz=document.querySelector(".map_filters-content"),Uz=document.querySelector(".map_image-bar"),jz=document.querySelector(".map_loader"),Gz=document.querySelector(".map_loader-drop");window.stop=!1;function GT(){window.stop=!0}var X_=class extends Error{constructor(m){super(m),this.name="ValidationError"}},Tf=class extends Error{constructor(m,v){super(m),this.name="NetworkError",this.status=v}},td=class extends Error{constructor(m,v){super(m),this.name="ApiError",this.code=v}},Y_=class extends Error{constructor(m,v){super(m),this.name="NotFoundError",this.code=v}};var XP="pk.eyJ1Ijoicm9kb25uZWxsLWN0cml2ZXIiLCJhIjoiY21kaGoxb3dwMDI5NDJscHp6djk0aHIzZiJ9.SAf5EWG05FFg3-5Vkd1c6A";async function ix(S){if(!YP(S))throw new X_("Zip code is not valid");let m=`https://api.mapbox.com/search/geocode/v6/forward?q=${S}&access_token=${XP}&country=US`,v,T;try{T=await fetch(m)}catch(A){throw new Tf(A.message)}if(!T.ok)throw new Tf("Mapbox service error",T.status);if(v=await T.json(),!Array.isArray(v?.features))throw new td("Result structure is unknown","WRONG_RESULTS");if(!v.features.length>0)throw new td("No results found for provided ZIP","NO_RESULTS");if(!v.features[0]?.geometry?.coordinates)throw new td("Result structure is unknown","WRONG_RESULTS");return v.features[0].geometry.coordinates}function YP(S){return/^\d{5}(-\d{4})?$/.test(S)}var qT=S=>{let m,v=new Set,T=(J,ae)=>{let we=typeof J=="function"?J(m):J;if(!Object.is(we,m)){let Ae=m;m=ae??(typeof we!="object"||we===null)?we:Object.assign({},m,we),v.forEach(xe=>xe(m,Ae))}},A=()=>m,V={setState:T,getState:A,getInitialState:()=>H,subscribe:J=>(v.add(J),()=>v.delete(J))},H=m=S(T,A,V);return V},K_=S=>S?qT(S):qT;window.__GLOBAL_DATA_STORE__||(window.__GLOBAL_DATA_STORE__=K_((S,m)=>({sites:[],kdIndex:[],points:[],sitesFiltered:[],organizations:[],lang:"en",initialized:!1,accessibility:!1,userLocMarker:void 0,mapStyle:"mapbox://styles/rodonnell-ctriver/cme050tqw018g01qpa23h8jj3",setKdIndex:v=>S(()=>({kdIndex:v})),setPoints:v=>S(()=>({points:v})),setUserLocMarker:v=>S(()=>({userLocMarker:v})),setSites:v=>S(()=>({sites:v})),setSitesFiltered:v=>S(()=>({sitesFiltered:v})),setOrganizations:v=>S(()=>({organizations:v})),setLang:v=>S(()=>({lang:v})),setInitialized:v=>S(()=>({initialized:v})),setAccessibility:v=>S(()=>({accessibility:v})),toggleAccessibility:()=>S(v=>({accessibility:!v.accessibility})),setMapStyle:v=>S(()=>({mapStyle:v})),getSites:()=>m().sites,getSitesFiltered:()=>m().sitesFiltered,getOrganizations:()=>m().organizations,getLang:()=>m().lang,getInitialized:()=>m().initialized,getAccessibility:()=>m().accessibility,getKdIndex:()=>m().kdIndex,getPoints:()=>m().points,getUserLocMarker:()=>m().userLocMarker,getMapStyle:()=>m().mapStyle})));var so=window.__GLOBAL_DATA_STORE__;var WT=s0(HT(),1),KP=6371,ya=Math.PI/180;function XT(S,m,v,T=1/0,A=1/0,n){let O=1,V=[];T===void 0&&(T=1/0),A!==void 0&&(O=vh(A/KP));let H=new WT.default([],JP),J={left:0,right:S.ids.length-1,axis:0,dist:0,minLng:-180,minLat:-90,maxLng:180,maxLat:90},ae=Math.cos(v*ya);for(;J;){let we=J.right,Ae=J.left;if(we-Ae<=S.nodeSize)for(let xe=Ae;xe<=we;xe++){let Ge=S.ids[xe];if(!n||n(Ge)){let Te=ZT(m,v,S.coords[2*xe],S.coords[2*xe+1],ae);H.push({id:Ge,dist:Te})}}else{let xe=Ae+we>>1,Ge=S.coords[2*xe],Te=S.coords[2*xe+1],We=S.ids[xe];if(!n||n(We)){let At=ZT(m,v,Ge,Te,ae);H.push({id:We,dist:At})}let ft=(J.axis+1)%2,_t={left:Ae,right:xe-1,axis:ft,minLng:J.minLng,minLat:J.minLat,maxLng:J.axis===0?Ge:J.maxLng,maxLat:J.axis===1?Te:J.maxLat,dist:0},Pt={left:xe+1,right:we,axis:ft,minLng:J.axis===0?Ge:J.minLng,minLat:J.axis===1?Te:J.minLat,maxLng:J.maxLng,maxLat:J.maxLat,dist:0};_t.dist=$T(m,v,ae,_t),Pt.dist=$T(m,v,ae,Pt),H.push(_t),H.push(Pt)}for(;H.length&&H.peek().id!=null;){let xe=H.pop();if(xe.dist>O||(V.push(xe.id),V.length===T))return V}J=H.pop()}return V}function $T(S,m,v,T){let A=T.minLng,n=T.maxLng,O=T.minLat,V=T.maxLat;if(S>=A&&S<=n)return m<O?vh((m-O)*ya):m>V?vh((m-V)*ya):0;let H=Math.min(vh((S-A)*ya),vh((S-n)*ya)),J=QP(m,H);return J>O&&J<V?J_(H,v,m,J):Math.min(J_(H,v,m,O),J_(H,v,m,V))}function JP(S,m){return S.dist-m.dist}function vh(S){let m=Math.sin(S/2);return m*m}function J_(S,m,v,T){return m*Math.cos(T*ya)*S+vh((v-T)*ya)}function ZT(S,m,v,T,A){let n=vh((S-v)*ya);return J_(n,A,m,T)}function QP(S,m){let v=1-2*m;return v<=0?S>0?90:-90:Math.atan(Math.tan(S*ya)/v)/ya}var rs=63710088e-1,tR={centimeters:rs*100,centimetres:rs*100,degrees:360/(2*Math.PI),feet:rs*3.28084,inches:rs*39.37,kilometers:rs/1e3,kilometres:rs/1e3,meters:rs,metres:rs,miles:rs/1609.344,millimeters:rs*1e3,millimetres:rs*1e3,nauticalmiles:rs/1852,radians:1,yards:rs*1.0936};function iR(S,m,v={}){let T={type:"Feature"};return(v.id===0||v.id)&&(T.id=v.id),v.bbox&&(T.bbox=v.bbox),T.properties=m||{},T.geometry=S,T}function ox(S,m,v={}){if(!S)throw new Error("coordinates is required");if(!Array.isArray(S))throw new Error("coordinates must be an Array");if(S.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!YT(S[0])||!YT(S[1]))throw new Error("coordinates must contain numbers");return iR({type:"Point",coordinates:S},m,v)}function KT(S,m="kilometers"){let v=tR[m];if(!v)throw new Error(m+" units is invalid");return S*v}function Sf(S){return S%360*Math.PI/180}function YT(S){return!isNaN(S)&&S!==null&&!Array.isArray(S)}function sx(S){if(!S)throw new Error("coord is required");if(!Array.isArray(S)){if(S.type==="Feature"&&S.geometry!==null&&S.geometry.type==="Point")return[...S.geometry.coordinates];if(S.type==="Point")return[...S.coordinates]}if(Array.isArray(S)&&S.length>=2&&!Array.isArray(S[0])&&!Array.isArray(S[1]))return[...S];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function ax(S,m,v={}){var T=sx(S),A=sx(m),n=Sf(A[1]-T[1]),O=Sf(A[0]-T[0]),V=Sf(T[1]),H=Sf(A[1]),J=Math.pow(Math.sin(n/2),2)+Math.pow(Math.sin(O/2),2)*Math.cos(V)*Math.cos(H);return KT(2*Math.atan2(Math.sqrt(J),Math.sqrt(1-J)),v.units)}var{getKdIndex:nR,getPoints:oR}=so.getState();function JT(S,m,{limit:v=10,maxDistanceMiles:T=50}={}){let A=nR(),n=oR();return XT(A,S,m,v).map(H=>{let J=n[H],ae=ax(ox([S,m]),ox([J.lon,J.lat]),{units:"miles"});return{...J,distanceMl:ae}}).filter(H=>H.distanceMl<=T).sort((H,J)=>H.distanceMl-J.distanceMl)}function lx(S){let m=10,v=[];do v=JT(S[0],S[1],{limit:100,maxDistanceMiles:m}),m+=10;while(m<=50&&!v.length>0);return v}var ys=s0(e2(),1);var{getMapStyle:sR,setMapStyle:aR,getSitesFiltered:lR}=so.getState(),Ef=class{onAdd(m){this.map=m,this.container=document.createElement("div"),this.container.className="mapboxgl-ctrl mapboxgl-ctrl-group";let v="mapboxgl-ctrl-map-style",T="mapboxgl-ctrl-map-style--active",A=document.createElement("button");A.type="button";let n=document.createElement("span");n.classList.add("mapboxgl-ctrl-icon"),A.classList.add(v),A.setAttribute("aria-label","Toggle Accessibility Mode"),A.append(n);let O="mapbox://styles/rodonnell-ctriver/cme050tqw018g01qpa23h8jj3",V="mapbox://styles/mapbox/satellite-v9";return A.addEventListener("click",()=>{let H=sR(),J;H===O?J=V:J=O;let ae=lR();m.setStyle(J),aR(J);let we=async()=>{await Q_(ae,!1),A.classList.toggle(T),m.off("style.load",we)};m.on("style.load",we)}),this.container.appendChild(A),this.container}onRemove(){this.container.parentNode.removeChild(this.container),this.map=void 0}};var iE=s0(tE(),1);var{getUserLocMarker:ZL}=so.getState(),Cf=class{onAdd(m){this.map=m,this.container=document.createElement("div"),this.container.className="mapboxgl-ctrl mapboxgl-ctrl-group";let v="mapboxgl-ctrl-location",T=document.createElement("button");T.type="button";let A=document.createElement("span");return A.classList.add("mapboxgl-ctrl-icon"),T.classList.add(v),T.setAttribute("aria-label","Toggle Accessibility Mode"),T.append(A),T.addEventListener("click",()=>{let n=ZL();if(n){let O=n.getLngLat();lg([{longitude:O.lng,latitude:O.lat}])}else document.querySelector("#zip").focus()}),this.container.appendChild(T),this.container}onRemove(){this.container.parentNode.removeChild(this.container),this.map=void 0}};var{getMapStyle:WL}=so.getState();Aw();function XL(){let S=WL();return ys.default.accessToken="pk.eyJ1Ijoicm9kb25uZWxsLWN0cml2ZXIiLCJhIjoiY21kaGoxb3dwMDI5NDJscHp6djk0aHIzZiJ9.SAf5EWG05FFg3-5Vkd1c6A",new ys.default.Map({container:"viewport",projection:"mercator",style:S,center:[-72.61177,42.58554],zoom:6.3,attributionControl:!1,pixelRatio:window.devicePixelRatio||1,cooperativeGestures:!0})}var fr=XL(),YL=document.querySelectorAll(".mapboxgl-ctrl-bottom-left");YL.forEach(S=>{S.classList.replace("mapboxgl-ctrl-bottom-left","mapboxgl-ctrl-top-left")});var KL=fr.getCanvas();KL.style.position="relative";fr.addControl(new ys.default.AttributionControl,"top-right");fr.addControl(new iE.default({accessToken:ys.default.accessToken,mapboxgl:ys.default,marker:!1,limit:3,placeholder:" ",collapsed:!0}));fr.addControl(new ys.default.NavigationControl,"top-right");fr.addControl(new Ef,"top-right");fr.addControl(new Cf,"top-right");JL();QL();function JL(){document.querySelectorAll(".mapboxgl-ctrl-bottom-left").forEach(Ge=>{Ge.classList.replace("mapboxgl-ctrl-bottom-left","mapboxgl-ctrl-top-left")});let m=".mapboxgl-ctrl button.$base .mapboxgl-ctrl-icon",v=".mapboxgl-ctrl button.$base:not(.$base--active) .mapboxgl-ctrl-icon:$pseudo",T=".mapboxgl-ctrl button.$base.$base--active .mapboxgl-ctrl-icon",A=".mapboxgl-ctrl button.$base.$base--access.$base--active .mapboxgl-ctrl-icon",n="{ background-image: url($icon) }",O=".mapboxgl-ctrl button.$base.$base--access .mapboxgl-ctrl-icon",V=`@media (hover: hover) and (pointer: fine) {
$selectors}
`,H=`@media (hover: none) and (pointer: coarse) {
$selectors}
`,J={hover:[{class:"mapboxgl-ctrl-zoom-in",icon:"controll-zoomIn-hover"},{class:"mapboxgl-ctrl-zoom-out",icon:"controll-zoomOut-hover"},{class:"mapboxgl-ctrl-compass",icon:"controll-compass-hover"},{class:"mapboxgl-ctrl-fullscreen",icon:"controll-fullScreen-hover"},{class:"mapboxgl-ctrl-access",icon:"controll-access-hover"},{class:"mapboxgl-ctrl-map-style",icon:"controll-mapStyle-hover"},{class:"mapboxgl-ctrl-location",icon:"controll-location-hover"}],active:[{class:"mapboxgl-ctrl-access",icon:"controll-access-active"},{class:"mapboxgl-ctrl-map-style",icon:"controll-mapStyle-active"}],activeAccess:[{class:"mapboxgl-ctrl-access",icon:"controll-access-activeAccess"},{class:"mapboxgl-ctrl-map-style",icon:"controll-mapStyle-activeAccess"}],initial:[{class:"mapboxgl-ctrl-zoom-in",icon:"controll-zoomIn-initial"},{class:"mapboxgl-ctrl-zoom-out",icon:"controll-zoomOut-initial"},{class:"mapboxgl-ctrl-compass",icon:"controll-compass-initial"},{class:"mapboxgl-ctrl-fullscreen",icon:"controll-fullScreen-initial"},{class:"mapboxgl-ctrl-shrink",icon:"controll-fullScreen-active"},{class:"mapboxgl-ctrl-access",icon:"controll-access-initial"},{class:"mapboxgl-ctrl-map-style",icon:"controll-mapStyle-initial"},{class:"mapboxgl-ctrl-location",icon:"controll-location-initial"}],access:[{class:"mapboxgl-ctrl-shrink",icon:"controll-fullScreen-activeAccess"}]},ae="",we="",Ae="";for(let[Ge,Te]of Object.entries(J))for(let{class:We,icon:ft}of Te){let _t;Ge==="hover"&&(_t=v),Ge==="active"&&(_t=T),Ge==="activeAccess"&&(_t=A),Ge==="access"&&(_t=O),_t||(_t=m);let Pt=ps.get(ft),wt=`${_t.replaceAll("$base",We).replaceAll("$pseudo","hover")}${n.replace("$icon",Pt)}
>>>>>>> a526947f4e024d155ff980808ddb8c37daf4d8a2
`;Ge==="hover"&&(we+=wt,Ae+=`${_t.replaceAll("$base",We).replaceAll("$pseudo","active")}${n.replace("$icon",Pt)}`),(Ge==="initial"||Ge==="active"||Ge==="activeAccess"||Ge==="access")&&(ae+=wt)}let xe=document.createElement("style");xe.innerHTML=`
    ${ae}

    ${V.replace("$selectors",we)}

<<<<<<< HEAD
    ${H.replace("$selectors",Ae)}`,document.body.append(xe)}function iz(){let S=document.querySelector(".mapboxgl-ctrl-geocoder--icon-search"),m=document.querySelector(".mapboxgl-ctrl-geocoder--icon-close"),v=S.classList,w=document.createElement("span");w.classList.add(...v),S.replaceWith(w);let I=m.classList,n=document.createElement("span");n.classList.add(...I),m.replaceWith(n);let O=document.createElement("style");O.innerHTML=`.mapboxgl-ctrl-geocoder--icon-search {background: no-repeat center center url(${ps.get("controll-search-hover")})} .mapboxgl-ctrl-geocoder.mapboxgl-ctrl-geocoder--collapsed 
  .mapboxgl-ctrl-geocoder--icon-search {background: no-repeat center center url(${ps.get("controll-search-initial")})} .mapboxgl-ctrl-geocoder--icon-close {background: no-repeat center center url(${ps.get("controll-reset-search")})}
  `,document.body.append(O)}var rz=R_((S,m)=>({sites:new Map,featuresProps:{},featuresDrawed:0,setSitesFeatures:v=>S(()=>({sites:v})),setFeaturesProps:v=>S(()=>({featuresProps:v})),setFeaturesDrawed:v=>S(()=>({featuresDrawed:v})),getFeaturesDrawed:()=>m().featuresDrawed,getSiteFeatures:()=>m().sites,getFeaturesProps:()=>m().featuresProps})),nE=rz;var oE='<div class="site-popup"><div class="site-popup_text-wrapper"><a href="SITE_LINK" class="site-popup_heading">SITE_NAME</a> ORGANIZATIONS</div></div>';function nz(S){return new DOMParser().parseFromString(S.trim(),"text/html").body.firstElementChild}var sE=nz;function Mx(S,m=18){return S.length>m?`${S.substring(0,m).trim()}...`:S}var{getLang:oz,getOrganizations:sz,setUserLocMarker:az,getUserLocMarker:cE}=Bn.getState(),{setSitesFeatures:zx,getSiteFeatures:lz,setFeaturesProps:hE,getFeaturesProps:uE}=nE.getState(),aE="site-popup",ug=null,ns=null,ad=null,Px=null,Cx=[],sd={},Rx=document.querySelector(".map-view");Rx.setAttribute("tabindex","1");var dE=HTMLElement.prototype.focus;async function cz(S){let m=ps.get(S),v=Math.max(1,Math.min(window.devicePixelRatio||1,3)),w=await new Promise((we,Ae)=>{let xe=new Image;xe.decoding="async",xe.onload=()=>we(xe),xe.onerror=Ae,xe.src=m}),I=w.naturalWidth,n=w.naturalHeight;if(!I||!n)try{let[,we]=m.split(","),xe=decodeURIComponent(atob(we)).match(/viewBox\s*=\s*["']\s*([\d.]+)\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)\s*["']/i);xe&&(I=parseFloat(xe[3]),n=parseFloat(xe[4]))}catch{}(!I||!n)&&(I=64,n=64);let O=Math.round(I*v),V=Math.round(n*v),H=document.createElement("canvas");H.width=O,H.height=V,H.getContext("2d").drawImage(w,0,0,O,V);let ae=await createImageBitmap(H);fr.hasImage(S)&&fr.removeImage(S),fr.addImage(S,ae,{pixelRatio:v})}async function hz(){for(let[S,m]of ps)S.startsWith("marker")&&await cz(S)}function uz(S,m,v){let w=`<div class="user-marker">${v}</div>`,I=sE(w),n=new xs.default.Marker({element:I,anchor:"bottom",offset:[0,-9]}).setLngLat([S,m]).addTo(fr);az(n)}function pE(S,m,v){let w=cE();if(!w)uz(S,m,v);else{let I=w.getElement();I.textContent=v,w.setLngLat([S,m])}}async function eg(S,m=!0){let v={},w=S.map(O=>(v[O.id]={id:O.id,name:O.name,latitude:O.latitude,longitude:O.longitude,organizations:O.organizations,slug:O.slug},{type:"Feature",geometry:{type:"Point",coordinates:[O.longitude,O.latitude]},id:O.id,properties:{id:O.id,icon:"marker",originalIcon:"marker",iconScale:1}})),I=new Map;w.forEach(O=>{I.set(O.id,O)}),zx(I),hE(v);async function n(){await hz(),fr.getSource("site-points")||fr.addSource("site-points",{type:"geojson",data:{type:"FeatureCollection",features:w},promoteId:"id"}),fr.getLayer("site-points-layer")||(fr.addLayer({id:"site-points-layer",type:"symbol",source:"site-points",layout:{"icon-image":["get","icon"],"icon-size":["get","iconScale"],"icon-anchor":"bottom","icon-allow-overlap":!0,"icon-ignore-placement":!0}}),m&&cg(S),fr.on("click","site-points-layer",O=>{let V=window.innerWidth<=767,H=window.matchMedia&&window.matchMedia("(pointer: coarse)").matches,J=uE(),ae=O.features[0].properties.id,we=J[ae],Ae=fr.getCanvas(),xe=pz(we),Ge=fr.project([we.longitude,we.latitude]),{anchor:Te,offset:We}=mE(Ge,we.relevance);new xs.default.Popup({anchor:V?"bottom":Te}).setLngLat([we.longitude,we.latitude]).setOffset(We).setHTML(xe).addTo(fr),Px={...we};let ft=document.querySelector(`.${aE}`),_t=document.querySelector(".site-popup_text-wrapper"),Pt=document.querySelector(".mapboxgl-popup-content:has(.site-popup)");if(_t&&Pt){let Ct=_t.scrollHeight+(we.image?V?120:80:0);Te.startsWith("top")&&!V?Pt.style.clipPath="inset(0 0 100% 0)":Pt.style.clipPath="inset(100% 0 0 0)",Pt.style.height=`${Ct}px`,ix.to(Pt,{clipPath:"inset(0% 0% 0% 0%)",duration:.3,ease:"power1.out"}),ft.classList.add(`${aE}--active`)}if(H){let Ct=O.features?.[0],Ft=Ct?.id;Ft!==ns&&(ns!==null&&hg(ns),Ft!=null&&lE(Ft,Ct),ns=Ft)}let At=document.querySelector(".mapboxgl-popup-close-button"),wt=Ct=>{let Ft=document.querySelector(".mapboxgl-popup-content");Ft&&Ft.contains(Ct.target)||(H&&(hg(ns),ns=null),Px=null,Ae.removeEventListener("click",wt),At.removeEventListener("click",wt))};Ae.addEventListener("click",wt),At.addEventListener("click",wt)}),fr.on("mousemove","site-points-layer",O=>{if(!(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches)){fr.getCanvas().style.cursor="pointer";let H=O.features?.[0],J=H?.id;J!==ns&&(ns!==null&&hg(ns),J!=null&&lE(J,H),ns=J)}}),fr.on("mouseleave","site-points-layer",O=>{window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||(fr.getCanvas().style.cursor="",ns!==null&&(hg(ns),ns=null))}))}await n()}function fE(S,m){let v={},w=S.map(O=>(v[O.id]={name:O.name,latitude:O.latitude,longitude:O.longitude,organizations:O.organizations,slug:O.slug},{type:"Feature",geometry:{type:"Point",coordinates:[O.longitude,O.latitude]},id:O.id,properties:{id:O.id,icon:"marker",originalIcon:"marker",iconScale:1}})),I=new Map;w.forEach(O=>{I.set(O.id,O)}),zx(I),hE(v),dz("site-points",n);function n(){if(fr.getSource("site-points").setData({type:"FeatureCollection",features:w}),m){let O=cE();if(O?.getLngLat()){let V=O.getLngLat(),H={longitude:V.lng,latitude:V.lat};S.push(H)}cg(S)}}}function dz(S,m){if(!sd[S]&&sd[S]!==!1&&(sd[S]=!1),v()){sd[S]=!0,m();return}Cx.push(m);function v(){return sd[S]||fr.getSource(S)}function w(){sd[S]=!0,fr.off("sourcedata",I);let n=[...Cx];Cx.length=0;for(let O of n)O()}function I(n){n.sourceId===S&&v()&&w()}fr.on("sourcedata",I)}function pz(S){let m=oz(),v=sz(),w=window.innerWidth<=767,I=oE;w&&(HTMLElement.prototype.focus=function(){},requestAnimationFrame(()=>{HTMLElement.prototype.focus=dE}));let n=S.organizations.map(O=>{let V=v.find(H=>H.id===O);return`<a href="/${m==="es"?"es/":""}monitoring-organizations/${V.id}" class='site-popup_link'>${Mx(V.name,30)} \u2192</a>`}).join("");return I.replace("SITE_NAME",S.name).replaceAll("SITE_LINK",`${window.location.origin}${m!=="en"?`/${m}`:""}/sites/${S.slug}`).replace("ORGANIZATIONS",n)}function cg(S){if(!S.length)return;let m=S.map(w=>[w.longitude,w.latitude]),v=new xs.default.LngLatBounds;m.forEach(w=>v.extend(w)),fr.fitBounds(v,{padding:{top:50,left:50,right:50,bottom:50},duration:800,maxZoom:14})}function Lx(S,m){let v=lz(),w=v.get(S);if(!w&&m===1)return;if(!w){console.warn(`Not found feature with id ${S} in animateMarkerScale`);return}let I=w.properties.originalIcon,n=m===1?I:`${I}-hightlighted`,O=new Map(v);O.set(S,{...w,properties:{...w.properties,icon:n}}),fr.getSource("site-points").setData({type:"FeatureCollection",features:Array.from(O.values())}),zx(O)}function lE(S,m){window.innerWidth<=767&&Rx&&(HTMLElement.prototype.focus=dE,Rx.focus()),ug&&ug!==S&&(Lx(S,1),_E()),Px||fz(m),Lx(S,1.5),ug=S}function mE(S,m){let{clientWidth:v,clientHeight:w}=fr.getCanvas(),I={top:3,bottom:-40};m==="old"&&(I.bottom=-20);let n=S.y<w*.33?"top":S.y>w*.66?"bottom":"",O=S.x<v*.33?"left":S.x>v*.66?"right":"",V=n&&O?`${n}-${O}`:n||O||"bottom",H=n==="top"?I.top:I.bottom;return{anchor:V,offset:[O==="left"?20:O==="right"?-20:0,H]}}function fz(S){let m=S?.geometry?.coordinates||[S.longitude,S.latitude];if(S){let v=uE()[S.id];if(!v)return;let w=fr.project(m),{anchor:I,offset:n}=mE(w,v.relevance);ad||(ad=new xs.default.Popup({closeButton:!1,closeOnClick:!1,className:"hover-popup",anchor:I})),ad.setLngLat(m).setHTML(`<span class="hover-popup">${v.name}</span>`).setOffset(n).addTo(fr)}else console.error("Cannot create hover popup without feature")}function _E(){ad&&(ad.remove(),ad=null)}function hg(S=ug){S?(_E(),Lx(S,1)):console.warn("Unexpected null in unhighlightMapSite")}var{getLang:mz,getSites:_z,setSitesFiltered:gz}=Bn.getState();function Dx(){document.querySelector("#zip-search-form").addEventListener("submit",async m=>{m.preventDefault(),await yz()})}async function yz(){let S={en:{searching:"Searching...",validationErr:"The zip code format is incorrect.",unavailableErr:"The service is temporarily unavailable, please try again later.",notFoundErr:"Zip code is not found",notFoundStations:"No stations found near your location.",error:"An error occurred while searching for the zip code."},es:{searching:"Buscando...",validationErr:"El formato del c\xF3digo postal es incorrecto.",unavailableErr:"El servicio no est\xE1 disponible temporalmente, int\xE9ntelo de nuevo m\xE1s tarde.",notFoundErr:"No se ha encontrado el c\xF3digo postal",notFoundStations:"No se han encontrado estaciones cerca de tu ubicaci\xF3n.",error:"Se ha producido un error al buscar el c\xF3digo postal."}},m=_z(),v=mz(),w=document.querySelector("#zip");try{Ya(S[v].searching);let n=document.querySelector("#zip").value,O=await rx(n),V=cx(O);if(!V.length>0)throw new J_(`No sites found for provided ZIP ${n}`);let H=[];V.forEach(J=>{H.push(m[J.idx])}),pE(O[0],O[1],n),gz(H),fE(H,!0),Ya("")}catch(I){switch(console.error(I),I.name){case"ValidationError":{Ya(S[v].validationErr);break}case"NetworkError":{Ya(S[v].unavailableErr);break}case"ApiError":{I.code==="NO_RESULTS"?Ya(S[v].notFoundErr):Ya(S[v].error);break}case"NotFoundError":{Ya(S[v].notFoundStations);break}default:Ya(S[v].error)}let n=()=>{Ya(""),w.removeEventListener("input",n)};w.addEventListener("input",n)}}function Ya(S){let m=document.querySelector("#label-status");m.textContent=S}var gE='.mapboxgl-map{font-family:var(--font-family--font-family-1)!important}.map .map_view-wrapper{font:12px/20px var(--font-family--font-family-1)!important}.mapboxgl-ctrl-attrib-inner{padding:0 15px 0 0}.mapboxgl-ctrl-attrib-inner a{color:#000;font-size:10px}.input-border,.map_filter-option{font-family:Switzer,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif}';var yE=".mapboxgl-popup-content:has(.hover-popup){border-radius:10px;padding:0;overflow:hidden;-webkit-box-shadow:0 0 17px -9px #42445a;-moz-box-shadow:0 0 17px -9px #42445a;box-shadow:0 0 17px -9px #42445a}.hover-popup{max-width:300px;display:block;color:var(--color--cloud-dark);padding:6px 16px;font-style:16px;font-weight:600}";var xE=".mapboxgl-popup-content:has(.site-popup){border-radius:12px;padding:0;overflow:hidden;-webkit-box-shadow:0 0 17px -9px #42445a;-moz-box-shadow:0 0 17px -9px #42445a;box-shadow:0 0 17px -9px #42445a}.mapboxgl-popup-content:has(.site-popup),.mapboxgl-popup:has(.site-popup){width:250px!important;max-width:260px!important}.mapboxgl-popup-tip{display:none!important}.mapboxgl-popup-close-button{transition:background .5s;font-weight:100;right:5px;top:5px;font-size:19px;background:rgb(119 119 119/23%);backdrop-filter:blur(50px);color:#fff;border-radius:100%;width:30px;height:30px;align-items:center;justify-content:center;display:none;padding:0}.site-popup{height:0;width:250px;max-width:260px;font-size:12px;color:var(--color--cloud-dark)}.site-popup_image-wrapper{display:block;width:100%;max-height:80px;overflow:hidden}.popup-image{width:100%;height:100%;object-fit:cover;object-position:center}.mapboxgl-popup-content:has(.popup-image) .site-popup_text-wrapper{padding:16px 14px}.site-popup_text-wrapper{background-color:#fff;display:flex;flex-direction:column;padding:16px 14px}.site-popup_heading{font-size:12px;font-weight:600;text-decoration:none}.site-popup_heading,.site-popup_heading:link,.site-popup_heading:visited{color:var(--color--cloud-dark)}.site-popup_descr{font-size:12px;display:block;margin:6px 0 0;user-select:auto}.site-popup_measurements{width:0%;display:flex;margin:4px 0 0;gap:2px}.site-popup_measure{border-radius:4px;height:12px}.site-popup_link{display:block;margin:6px 0 0;font-size:12px;color:var(--color--cloud-dark)}.site-popup_link:link,.site-popup_link:visited{text-decoration:none;color:var(--color--cloud-dark)}.site-popup_link:hover{color:var(--color--water-main)}@media (max-width:767px){.mapboxgl-popup:has(.site-popup){min-width:100%!important;max-width:100%!important;position:absolute;padding:0 15px;bottom:20px;z-index:4;transform:translate(0,0)!important}.mapboxgl-popup-content:has(.site-popup){max-width:100%!important;width:100%!important}.mapboxgl-popup-close-button{height:40px;width:40px;top:5px;right:5px;font-size:32px;display:flex}.mapboxgl-popup-content:has(.popup-image) .site-popup_text-wrapper{padding:16px 14px}.site-popup_text-wrapper{padding:45px 14px 16px}.site-popup{width:100%}.site-popup_image-wrapper{max-height:120px}.site-popup_descr,.site-popup_heading,.site-popup_link{font-size:12px}.site-popup_measurements{margin:4px 0 0}.site-popup_descr,.site-popup_link{margin:12px 0 0}.site-popup_measure{height:16px}}";var vE=".mapboxgl-scroll-zoom-blocker,.mapboxgl-touch-pan-blocker{z-index:3}";var bE='.user-marker{background-color:#fff;color:#000;border-radius:6px;font-size:12;padding:4px 6px;box-shadow:0 2px 6px rgba(0,0,0,.15);user-select:none}.custom-popup::before,.user-marker::after{content:"";position:absolute;left:50%;transform:translateX(-50%);border-style:solid}.user-marker::after{bottom:-9px;border-width:10px 10px 0;border-color:#fff transparent transparent}.custom-popup::before{bottom:-12px;border-width:12px 12px 0;border-color:rgba(0,0,0,.1) transparent transparent}';var wE='.mapboxgl-ctrl-group:not(:empty){box-shadow:none}.mapboxgl-ctrl.mapboxgl-ctrl-group{display:flex;flex-direction:column;gap:4px;background:0 0}.mapboxgl-ctrl-compass,.mapboxgl-ctrl-fullscreen,.mapboxgl-ctrl-group button,.mapboxgl-ctrl-group button:first-child,.mapboxgl-ctrl-group button:last-child,.mapboxgl-ctrl-zoom-in,.mapboxgl-ctrl-zoom-out{height:32px;width:32px;background-color:#fff;border-radius:4px}.mapboxgl-ctrl-geocoder{width:330px;font-family:Switzer,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif}.mapboxgl-ctrl button:not(:disabled):hover{background-color:#fff}.mapboxgl-ctrl-geocoder.mapboxgl-ctrl-geocoder{transition:width .25s,min-width .25s,box-shadow .25s}.mapboxgl-ctrl-geocoder.mapboxgl-ctrl-geocoder--collapsed{width:32px;min-width:32px;box-shadow:none}.mapboxgl-ctrl-geocoder--icon{top:6px}.mapboxgl-ctrl-geocoder--icon-close{margin-top:0}.mapboxgl-ctrl-group button+button{border-top:0}.mapboxgl-ctrl-geocoder,.mapboxgl-ctrl-geocoder .suggestions{box-shadow:0 10px 10px 1px rgba(0,0,0,.1)}.mapboxgl-ctrl-geocoder--input{height:32px;padding:6px 35px}.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input:focus,.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input:focus-visible{outline:0;box-shadow:none}.mapboxgl-ctrl-geocoder .suggestions>li>a{color:var(--color--cloud-dark);text-decoration:none}.mapboxgl-ctrl-geocoder .suggestions>.active>a,.mapboxgl-ctrl-geocoder .suggestions>li>a:hover{color:var(--color--cloud-dark)}.mapboxgl-ctrl-geocoder .suggestions li a:link{text-decoration:none}@media (hover:none) and (pointer:coarse){.mapboxgl-ctrl button:not(:disabled):active{background-color:#fff}}@media (max-width:640px){.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--pin-right>*,.mapboxgl-ctrl-geocoder--icon{top:5px}.mapboxgl-ctrl-geocoder--icon-search{left:6px}}@media (max-width:400px){.mapboxgl-ctrl-geocoder{width:280px}}';function xz(){let S=[gE,vE,yE,xE,bE,wE],m=document.createElement("style");m.innerHTML=`${S.join("")}`,document.body.append(m)}var TE=xz;var{toggleAccessibility:vz,getAccessibility:bz}=Bn.getState(),wz=["mapboxgl-ctrl-access","mapboxgl-ctrl-fullscreen","mapboxgl-ctrl-shrink","mapboxgl-ctrl-map-style"];function SE(){let S=document.querySelector("#accessibility");S&&S.addEventListener("click",Tz),bz()&&EE()}function Tz(){vz(),EE()}function EE(){wz.forEach(S=>{let m=document.querySelector(`.${S}`);m&&(S==="mapboxgl-ctrl-fullscreen"?m.classList.toggle("mapboxgl-ctrl-shrink--access"):m.classList.toggle(`${S}--access`))})}var{getSites:KO}=Bn.getState();window.dataInitialized?(IE(),console.log(fr)):window.buildZipSearch=IE;function Sz(){return new Promise(S=>{fr.loaded()?S():fr.once("load",()=>S())})}async function IE(){SE(),TE(),Mw(),await Sz(),await eg([]),Dx(),HT()}})();
=======
    ${H.replace("$selectors",Ae)}`,document.body.append(xe)}function QL(){let S=document.querySelector(".mapboxgl-ctrl-geocoder--icon-search"),m=document.querySelector(".mapboxgl-ctrl-geocoder--icon-close"),v=S.classList,T=document.createElement("span");T.classList.add(...v),S.replaceWith(T);let A=m.classList,n=document.createElement("span");n.classList.add(...A),m.replaceWith(n);let O=document.createElement("style");O.innerHTML=`.mapboxgl-ctrl-geocoder--icon-search {background: no-repeat center center url(${ps.get("controll-search-hover")})} .mapboxgl-ctrl-geocoder.mapboxgl-ctrl-geocoder--collapsed 
  .mapboxgl-ctrl-geocoder--icon-search {background: no-repeat center center url(${ps.get("controll-search-initial")})} .mapboxgl-ctrl-geocoder--icon-close {background: no-repeat center center url(${ps.get("controll-reset-search")})}
  `,document.body.append(O)}var ez=K_((S,m)=>({sites:new Map,featuresProps:{},featuresDrawed:0,setSitesFeatures:v=>S(()=>({sites:v})),setFeaturesProps:v=>S(()=>({featuresProps:v})),setFeaturesDrawed:v=>S(()=>({featuresDrawed:v})),getFeaturesDrawed:()=>m().featuresDrawed,getSiteFeatures:()=>m().sites,getFeaturesProps:()=>m().featuresProps})),rE=ez;var nE='<div class="site-popup"><div class="site-popup_text-wrapper"><a href="SITE_LINK" class="site-popup_heading">SITE_NAME</a> ORGANIZATIONS</div></div>';function tz(S){return new DOMParser().parseFromString(S.trim(),"text/html").body.firstElementChild}var oE=tz;function Ax(S,m=18){return S.length>m?`${S.substring(0,m).trim()}...`:S}var{getLang:iz,getOrganizations:rz,setUserLocMarker:nz,getUserLocMarker:lE}=so.getState(),{setSitesFeatures:Lx,getSiteFeatures:oz,setFeaturesProps:cE,getFeaturesProps:hE}=rE.getState(),sE="site-popup",hg=null,ns=null,sd=null,Cx=null,Mx=[],od={},Px=document.querySelector(".map-view");Px.setAttribute("tabindex","1");var uE=HTMLElement.prototype.focus;async function sz(S){let m=ps.get(S),v=Math.max(1,Math.min(window.devicePixelRatio||1,3)),T=await new Promise((we,Ae)=>{let xe=new Image;xe.decoding="async",xe.onload=()=>we(xe),xe.onerror=Ae,xe.src=m}),A=T.naturalWidth,n=T.naturalHeight;if(!A||!n)try{let[,we]=m.split(","),xe=decodeURIComponent(atob(we)).match(/viewBox\s*=\s*["']\s*([\d.]+)\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)\s*["']/i);xe&&(A=parseFloat(xe[3]),n=parseFloat(xe[4]))}catch{}(!A||!n)&&(A=64,n=64);let O=Math.round(A*v),V=Math.round(n*v),H=document.createElement("canvas");H.width=O,H.height=V,H.getContext("2d").drawImage(T,0,0,O,V);let ae=await createImageBitmap(H);fr.hasImage(S)&&fr.removeImage(S),fr.addImage(S,ae,{pixelRatio:v})}async function az(){let S=new Date().getTime();console.log("Icons init started");for(let[m,v]of ps)m.startsWith("marker")&&await sz(m);console.log(`Icons initialized by ${new Date().getTime()-S} ms`)}function lz(S,m,v){let T=`<div class="user-marker">${v}</div>`,A=oE(T),n=new ys.default.Marker({element:A,anchor:"bottom",offset:[0,-9]}).setLngLat([S,m]).addTo(fr);nz(n)}function dE(S,m,v){let T=lE();if(!T)lz(S,m,v);else{let A=T.getElement();A.textContent=v,T.setLngLat([S,m])}}async function Q_(S,m=!0){let v={},T=S.map(O=>(v[O.id]={id:O.id,name:O.name,latitude:O.latitude,longitude:O.longitude,organizations:O.organizations,slug:O.slug},{type:"Feature",geometry:{type:"Point",coordinates:[O.longitude,O.latitude]},id:O.id,properties:{id:O.id,icon:"marker",originalIcon:"marker",iconScale:1}})),A=new Map;T.forEach(O=>{A.set(O.id,O)}),Lx(A),cE(v);async function n(){await az(),fr.getSource("site-points")||fr.addSource("site-points",{type:"geojson",data:{type:"FeatureCollection",features:T},promoteId:"id"}),fr.getLayer("site-points-layer")||(fr.addLayer({id:"site-points-layer",type:"symbol",source:"site-points",layout:{"icon-image":["get","icon"],"icon-size":["get","iconScale"],"icon-anchor":"bottom","icon-allow-overlap":!0,"icon-ignore-placement":!0}}),m&&lg(S),fr.on("click","site-points-layer",O=>{let V=window.innerWidth<=767,H=window.matchMedia&&window.matchMedia("(pointer: coarse)").matches,J=hE(),ae=O.features[0].properties.id,we=J[ae],Ae=fr.getCanvas(),xe=hz(we),Ge=fr.project([we.longitude,we.latitude]),{anchor:Te,offset:We}=fE(Ge,we.relevance);new ys.default.Popup({anchor:V?"bottom":Te}).setLngLat([we.longitude,we.latitude]).setOffset(We).setHTML(xe).addTo(fr),Cx={...we};let ft=document.querySelector(`.${sE}`),_t=document.querySelector(".site-popup_text-wrapper"),Pt=document.querySelector(".mapboxgl-popup-content:has(.site-popup)");if(_t&&Pt){let Ct=_t.scrollHeight+(we.image?V?120:80:0);Te.startsWith("top")&&!V?Pt.style.clipPath="inset(0 0 100% 0)":Pt.style.clipPath="inset(100% 0 0 0)",Pt.style.height=`${Ct}px`,tx.to(Pt,{clipPath:"inset(0% 0% 0% 0%)",duration:.3,ease:"power1.out"}),ft.classList.add(`${sE}--active`)}if(H){let Ct=O.features?.[0],Ft=Ct?.id;Ft!==ns&&(ns!==null&&cg(ns),Ft!=null&&aE(Ft,Ct),ns=Ft)}let At=document.querySelector(".mapboxgl-popup-close-button"),wt=Ct=>{let Ft=document.querySelector(".mapboxgl-popup-content");Ft&&Ft.contains(Ct.target)||(H&&(cg(ns),ns=null),Cx=null,Ae.removeEventListener("click",wt),At.removeEventListener("click",wt))};Ae.addEventListener("click",wt),At.addEventListener("click",wt)}),fr.on("mousemove","site-points-layer",O=>{if(!(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches)){fr.getCanvas().style.cursor="pointer";let H=O.features?.[0],J=H?.id;J!==ns&&(ns!==null&&cg(ns),J!=null&&aE(J,H),ns=J)}}),fr.on("mouseleave","site-points-layer",O=>{window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||(fr.getCanvas().style.cursor="",ns!==null&&(cg(ns),ns=null))}))}await n()}function pE(S,m){let v={},T=S.map(O=>(v[O.id]={name:O.name,latitude:O.latitude,longitude:O.longitude,organizations:O.organizations,slug:O.slug},{type:"Feature",geometry:{type:"Point",coordinates:[O.longitude,O.latitude]},id:O.id,properties:{id:O.id,icon:"marker",originalIcon:"marker",iconScale:1}})),A=new Map;T.forEach(O=>{A.set(O.id,O)}),Lx(A),cE(v),cz("site-points",n);function n(){if(fr.getSource("site-points").setData({type:"FeatureCollection",features:T}),m){let O=lE();if(O?.getLngLat()){let V=O.getLngLat(),H={longitude:V.lng,latitude:V.lat};S.push(H)}lg(S)}}}function cz(S,m){if(!od[S]&&od[S]!==!1&&(od[S]=!1),v()){od[S]=!0,m();return}Mx.push(m);function v(){return od[S]||fr.getSource(S)}function T(){od[S]=!0,fr.off("sourcedata",A);let n=[...Mx];Mx.length=0;for(let O of n)O()}function A(n){n.sourceId===S&&v()&&T()}fr.on("sourcedata",A)}function hz(S){let m=iz(),v=rz(),T=window.innerWidth<=767,A=nE;T&&(HTMLElement.prototype.focus=function(){},requestAnimationFrame(()=>{HTMLElement.prototype.focus=uE}));let n=S.organizations.map(O=>{let V=v.find(H=>H.id===O);return`<a href="/${m==="es"?"es/":""}monitoring-organizations/${V.id}" class='site-popup_link'>${Ax(V.name,30)} \u2192</a>`}).join("");return A.replace("SITE_NAME",S.name).replaceAll("SITE_LINK",`${window.location.origin}${m!=="en"?`/${m}`:""}/sites/${S.slug}`).replace("ORGANIZATIONS",n)}function lg(S){if(!S.length)return;let m=S.map(T=>[T.longitude,T.latitude]),v=new ys.default.LngLatBounds;m.forEach(T=>v.extend(T)),fr.fitBounds(v,{padding:{top:50,left:50,right:50,bottom:50},duration:800,maxZoom:14})}function Rx(S,m){let v=oz(),T=v.get(S);if(!T&&m===1)return;if(!T){console.warn(`Not found feature with id ${S} in animateMarkerScale`);return}let A=T.properties.originalIcon,n=m===1?A:`${A}-hightlighted`,O=new Map(v);O.set(S,{...T,properties:{...T.properties,icon:n}}),fr.getSource("site-points").setData({type:"FeatureCollection",features:Array.from(O.values())}),Lx(O)}function aE(S,m){window.innerWidth<=767&&Px&&(HTMLElement.prototype.focus=uE,Px.focus()),hg&&hg!==S&&(Rx(S,1),mE()),Cx||uz(m),Rx(S,1.5),hg=S}function fE(S,m){let{clientWidth:v,clientHeight:T}=fr.getCanvas(),A={top:3,bottom:-40};m==="old"&&(A.bottom=-20);let n=S.y<T*.33?"top":S.y>T*.66?"bottom":"",O=S.x<v*.33?"left":S.x>v*.66?"right":"",V=n&&O?`${n}-${O}`:n||O||"bottom",H=n==="top"?A.top:A.bottom;return{anchor:V,offset:[O==="left"?20:O==="right"?-20:0,H]}}function uz(S){let m=S?.geometry?.coordinates||[S.longitude,S.latitude];if(S){let v=hE()[S.id];if(!v)return;let T=fr.project(m),{anchor:A,offset:n}=fE(T,v.relevance);sd||(sd=new ys.default.Popup({closeButton:!1,closeOnClick:!1,className:"hover-popup",anchor:A})),sd.setLngLat(m).setHTML(`<span class="hover-popup">${v.name}</span>`).setOffset(n).addTo(fr)}else console.error("Cannot create hover popup without feature")}function mE(){sd&&(sd.remove(),sd=null)}function cg(S=hg){S?(mE(),Rx(S,1)):console.warn("Unexpected null in unhighlightMapSite")}var{getLang:dz,getSites:pz,setSitesFiltered:fz}=so.getState();function zx(){document.querySelector("#zip-search-form").addEventListener("submit",async m=>{m.preventDefault(),await mz()})}async function mz(){let S={en:{searching:"Searching...",validationErr:"The zip code format is incorrect.",unavailableErr:"The service is temporarily unavailable, please try again later.",notFoundErr:"Zip code is not found",notFoundStations:"No stations found near your location.",error:"An error occurred while searching for the zip code."},es:{searching:"Buscando...",validationErr:"El formato del c\xF3digo postal es incorrecto.",unavailableErr:"El servicio no est\xE1 disponible temporalmente, int\xE9ntelo de nuevo m\xE1s tarde.",notFoundErr:"No se ha encontrado el c\xF3digo postal",notFoundStations:"No se han encontrado estaciones cerca de tu ubicaci\xF3n.",error:"Se ha producido un error al buscar el c\xF3digo postal."}},m=pz(),v=dz(),T=document.querySelector("#zip");try{Xa(S[v].searching);let n=document.querySelector("#zip").value,O=await ix(n),V=lx(O);if(!V.length>0)throw new Y_(`No sites found for provided ZIP ${n}`);let H=[];V.forEach(J=>{H.push(m[J.idx])}),dE(O[0],O[1],n),fz(H),pE(H,!0),Xa("")}catch(A){switch(console.error(A),A.name){case"ValidationError":{Xa(S[v].validationErr);break}case"NetworkError":{Xa(S[v].unavailableErr);break}case"ApiError":{A.code==="NO_RESULTS"?Xa(S[v].notFoundErr):Xa(S[v].error);break}case"NotFoundError":{Xa(S[v].notFoundStations);break}default:Xa(S[v].error)}let n=()=>{Xa(""),T.removeEventListener("input",n)};T.addEventListener("input",n)}}function Xa(S){let m=document.querySelector("#label-status");m.textContent=S}var _E=':root{--general-text-color:#063d57;--light-text-color:hsla(199, 87%, 18%, 0.7)}.mapboxgl-map{font-family:var(--font-family--font-family-1)!important}.map .map_view-wrapper{font:12px/20px var(--font-family--font-family-1)!important}.mapboxgl-ctrl-attrib-inner{padding:0 15px 0 0}.mapboxgl-ctrl-attrib-inner a{color:#000;font-size:10px}.input-border,.map_filter-option{font-family:Switzer,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif}';var gE=".mapboxgl-popup-content:has(.hover-popup){border-radius:10px;padding:0;overflow:hidden;-webkit-box-shadow:0 0 17px -9px #42445a;-moz-box-shadow:0 0 17px -9px #42445a;box-shadow:0 0 17px -9px #42445a}.hover-popup{max-width:300px;display:block;color:var(--general-text-color);padding:6px 16px;font-style:16px;font-weight:600}";var yE=".mapboxgl-popup-content:has(.site-popup){border-radius:12px;padding:0;overflow:hidden;-webkit-box-shadow:0 0 17px -9px #42445a;-moz-box-shadow:0 0 17px -9px #42445a;box-shadow:0 0 17px -9px #42445a}.mapboxgl-popup-content:has(.site-popup),.mapboxgl-popup:has(.site-popup){width:250px!important;max-width:260px!important}.mapboxgl-popup-tip{display:none!important}.mapboxgl-popup-close-button{transition:background .5s;font-weight:100;right:5px;top:5px;font-size:19px;background:rgb(119 119 119/23%);backdrop-filter:blur(50px);color:#fff;border-radius:100%;width:30px;height:30px;align-items:center;justify-content:center;display:none;padding:0}.site-popup{height:0;width:250px;max-width:260px;font-size:12px;color:var(--general-text-color)}.site-popup_image-wrapper{display:block;width:100%;max-height:80px;overflow:hidden}.popup-image{width:100%;height:100%;object-fit:cover;object-position:center}.mapboxgl-popup-content:has(.popup-image) .site-popup_text-wrapper{padding:16px 14px}.site-popup_text-wrapper{background-color:#fff;display:flex;flex-direction:column;padding:16px 14px}.site-popup_heading{font-size:12px;font-weight:600;text-decoration:none}.site-popup_heading,.site-popup_heading:link,.site-popup_heading:visited{color:var(--general-text-color)}.site-popup_descr{font-size:12px;display:block;margin:6px 0 0;user-select:auto}.site-popup_measurements{width:0%;display:flex;margin:4px 0 0;gap:2px}.site-popup_measure{border-radius:4px;height:12px}.site-popup_link{display:block;margin:6px 0 0;font-size:12px;color:var(--general-text-color)}.site-popup_link:link,.site-popup_link:visited{text-decoration:none;color:var(--general-text-color)}.site-popup_link:hover{color:var(--color--water-main)}@media (max-width:767px){.mapboxgl-popup:has(.site-popup){min-width:100%!important;max-width:100%!important;position:absolute;padding:0 15px;bottom:20px;z-index:4;transform:translate(0,0)!important}.mapboxgl-popup-content:has(.site-popup){max-width:100%!important;width:100%!important}.mapboxgl-popup-close-button{height:40px;width:40px;top:5px;right:5px;font-size:32px;display:flex}.mapboxgl-popup-content:has(.popup-image) .site-popup_text-wrapper{padding:16px 14px}.site-popup_text-wrapper{padding:45px 14px 16px}.site-popup{width:100%}.site-popup_image-wrapper{max-height:120px}.site-popup_descr,.site-popup_heading,.site-popup_link{font-size:12px}.site-popup_measurements{margin:4px 0 0}.site-popup_descr,.site-popup_link{margin:12px 0 0}.site-popup_measure{height:16px}}";var xE=".mapboxgl-scroll-zoom-blocker,.mapboxgl-touch-pan-blocker{z-index:3}";var vE='.user-marker{background-color:#fff;color:#000;border-radius:6px;font-size:12;padding:4px 6px;box-shadow:0 2px 6px rgba(0,0,0,.15);user-select:none}.custom-popup::before,.user-marker::after{content:"";position:absolute;left:50%;transform:translateX(-50%);border-style:solid}.user-marker::after{bottom:-9px;border-width:10px 10px 0;border-color:#fff transparent transparent}.custom-popup::before{bottom:-12px;border-width:12px 12px 0;border-color:rgba(0,0,0,.1) transparent transparent}';var bE='.mapboxgl-ctrl-group:not(:empty){box-shadow:none}.mapboxgl-ctrl.mapboxgl-ctrl-group{display:flex;flex-direction:column;gap:4px;background:0 0}.mapboxgl-ctrl-compass,.mapboxgl-ctrl-fullscreen,.mapboxgl-ctrl-group button,.mapboxgl-ctrl-group button:first-child,.mapboxgl-ctrl-group button:last-child,.mapboxgl-ctrl-zoom-in,.mapboxgl-ctrl-zoom-out{height:32px;width:32px;background-color:#fff;border-radius:4px}.mapboxgl-ctrl-geocoder{width:330px;font-family:Switzer,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif}.mapboxgl-ctrl button:not(:disabled):hover{background-color:#fff}.mapboxgl-ctrl-geocoder.mapboxgl-ctrl-geocoder{transition:width .25s,min-width .25s,box-shadow .25s}.mapboxgl-ctrl-geocoder.mapboxgl-ctrl-geocoder--collapsed{width:32px;min-width:32px;box-shadow:none}.mapboxgl-ctrl-geocoder--icon{top:6px}.mapboxgl-ctrl-geocoder--icon-close{margin-top:0}.mapboxgl-ctrl-group button+button{border-top:0}.mapboxgl-ctrl-geocoder,.mapboxgl-ctrl-geocoder .suggestions{box-shadow:0 10px 10px 1px rgba(0,0,0,.1)}.mapboxgl-ctrl-geocoder--input{height:32px;padding:6px 35px}.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input:focus,.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--input:focus-visible{outline:0;box-shadow:none}.mapboxgl-ctrl-geocoder .suggestions>li>a{color:var(--color--cloud-dark);text-decoration:none}.mapboxgl-ctrl-geocoder .suggestions>.active>a,.mapboxgl-ctrl-geocoder .suggestions>li>a:hover{color:var(--color--cloud-dark)}.mapboxgl-ctrl-geocoder .suggestions li a:link{text-decoration:none}@media (hover:none) and (pointer:coarse){.mapboxgl-ctrl button:not(:disabled):active{background-color:#fff}}@media (max-width:640px){.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--pin-right>*,.mapboxgl-ctrl-geocoder--icon{top:5px}.mapboxgl-ctrl-geocoder--icon-search{left:6px}}@media (max-width:400px){.mapboxgl-ctrl-geocoder{width:280px}}';function _z(){let S=[_E,xE,gE,yE,vE,bE],m=document.createElement("style");m.innerHTML=`${S.join("")}`,document.body.append(m)}var wE=_z;var{toggleAccessibility:gz,getAccessibility:yz}=so.getState(),xz=["mapboxgl-ctrl-access","mapboxgl-ctrl-fullscreen","mapboxgl-ctrl-shrink","mapboxgl-ctrl-map-style"];function TE(){let S=document.querySelector("#accessibility");S&&S.addEventListener("click",vz),yz()&&SE()}function vz(){gz(),SE()}function SE(){xz.forEach(S=>{let m=document.querySelector(`.${S}`);m&&(S==="mapboxgl-ctrl-fullscreen"?m.classList.toggle("mapboxgl-ctrl-shrink--access"):m.classList.toggle(`${S}--access`))})}var{getSites:ZO}=so.getState();window.dataInitialized?(EE(),console.log(fr)):window.buildZipSearch=EE;function bz(){return new Promise(S=>{fr.loaded()?S():fr.once("load",()=>S())})}async function EE(){TE(),wE(),Iw(),await bz(),await Q_([]),zx(),GT()}})();
>>>>>>> a526947f4e024d155ff980808ddb8c37daf4d8a2
/*! Bundled license information:

mapbox-gl/dist/mapbox-gl.js:
  (**
   * martinez v0.7.4
   * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
   *
   * @author Alex Milevski <info@w8r.name>
   * @license MIT
   * @preserve
   *)

base-64/base64.js:
  (*! http://mths.be/base64 v0.1.0 by @mathias | MIT license *)

gsap/gsap-core.js:
  (*!
   * GSAP 3.13.0
   * https://gsap.com
   *
   * @license Copyright 2008-2025, GreenSock. All rights reserved.
   * Subject to the terms at https://gsap.com/standard-license
   * @author: Jack Doyle, jack@greensock.com
  *)

gsap/CSSPlugin.js:
  (*!
   * CSSPlugin 3.13.0
   * https://gsap.com
   *
   * Copyright 2008-2025, GreenSock. All rights reserved.
   * Subject to the terms at https://gsap.com/standard-license
   * @author: Jack Doyle, jack@greensock.com
  *)

gsap/ScrollToPlugin.js:
  (*!
   * ScrollToPlugin 3.13.0
   * https://gsap.com
   *
   * @license Copyright 2008-2025, GreenSock. All rights reserved.
   * Subject to the terms at https://gsap.com/standard-license
   * @author: Jack Doyle, jack@greensock.com
  *)
*/
